{"meta":{"version":1,"warehouse":"2.2.0"},"models":{"Asset":[{"_id":"source/404.html","path":"404.html","modified":0,"renderable":0},{"_id":"source/README.md","path":"README.md","modified":0,"renderable":0},{"_id":"source/googlec93373d7ad2555cc.html","path":"googlec93373d7ad2555cc.html","modified":0,"renderable":0},{"_id":"source/file/成亮_技术经理_简历.doc","path":"file/成亮_技术经理_简历.doc","modified":0,"renderable":0},{"_id":"source/img/NodeJS安装完成.png","path":"img/NodeJS安装完成.png","modified":0,"renderable":0},{"_id":"source/img/building-blocks.jpg","path":"img/building-blocks.jpg","modified":0,"renderable":0},{"_id":"source/img/github目录.png","path":"img/github目录.png","modified":0,"renderable":0},{"_id":"source/img/hexo安装目录.png","path":"img/hexo安装目录.png","modified":0,"renderable":0},{"_id":"source/img/jacman主题安装目录.png","path":"img/jacman主题安装目录.png","modified":0,"renderable":0},{"_id":"source/img/npm配置信息.png","path":"img/npm配置信息.png","modified":0,"renderable":0},{"_id":"source/img/jooq-flyway.png","path":"img/jooq-flyway.png","modified":0,"renderable":0},{"_id":"source/img/photos在redis的数据结构示例.png","path":"img/photos在redis的数据结构示例.png","modified":0,"renderable":0},{"_id":"source/img/代码段.png","path":"img/代码段.png","modified":0,"renderable":0},{"_id":"source/img/计算机软硬件配置.png","path":"img/计算机软硬件配置.png","modified":0,"renderable":0},{"_id":"themes/next/source/404.html","path":"404.html","modified":0,"renderable":1},{"_id":"source/file/成亮_技术经理_简历.pdf","path":"file/成亮_技术经理_简历.pdf","modified":0,"renderable":0},{"_id":"source/img/MircoService.png","path":"img/MircoService.png","modified":0,"renderable":0},{"_id":"source/img/thinking.jpg","path":"img/thinking.jpg","modified":0,"renderable":0},{"_id":"themes/next/source/css/main.styl","path":"css/main.styl","modified":0,"renderable":1},{"_id":"themes/next/source/images/avatar.gif","path":"images/avatar.gif","modified":0,"renderable":1},{"_id":"themes/next/source/images/avatar.png","path":"images/avatar.png","modified":0,"renderable":1},{"_id":"themes/next/source/images/background-backup.jpg","path":"images/background-backup.jpg","modified":0,"renderable":1},{"_id":"themes/next/source/images/cc-by-nc-nd.svg","path":"images/cc-by-nc-nd.svg","modified":0,"renderable":1},{"_id":"themes/next/source/images/cc-by-nc-sa.svg","path":"images/cc-by-nc-sa.svg","modified":0,"renderable":1},{"_id":"themes/next/source/images/cc-by-nc.svg","path":"images/cc-by-nc.svg","modified":0,"renderable":1},{"_id":"themes/next/source/images/cc-by-nd.svg","path":"images/cc-by-nd.svg","modified":0,"renderable":1},{"_id":"themes/next/source/images/cc-by-sa.svg","path":"images/cc-by-sa.svg","modified":0,"renderable":1},{"_id":"themes/next/source/images/cc-by.svg","path":"images/cc-by.svg","modified":0,"renderable":1},{"_id":"themes/next/source/images/cc-zero.svg","path":"images/cc-zero.svg","modified":0,"renderable":1},{"_id":"themes/next/source/images/favicon.ico","path":"images/favicon.ico","modified":0,"renderable":1},{"_id":"themes/next/source/images/loading.gif","path":"images/loading.gif","modified":0,"renderable":1},{"_id":"themes/next/source/images/placeholder.gif","path":"images/placeholder.gif","modified":0,"renderable":1},{"_id":"themes/next/source/images/quote-l.svg","path":"images/quote-l.svg","modified":0,"renderable":1},{"_id":"themes/next/source/images/quote-r.svg","path":"images/quote-r.svg","modified":0,"renderable":1},{"_id":"themes/next/source/images/searchicon.png","path":"images/searchicon.png","modified":0,"renderable":1},{"_id":"themes/next/source/rewards/wechat-reward-image.png","path":"rewards/wechat-reward-image.png","modified":0,"renderable":1},{"_id":"themes/next/source/js/src/hook-duoshuo.js","path":"js/src/hook-duoshuo.js","modified":0,"renderable":1},{"_id":"themes/next/source/js/src/motion.js","path":"js/src/motion.js","modified":0,"renderable":1},{"_id":"themes/next/source/js/src/post-details.js","path":"js/src/post-details.js","modified":0,"renderable":1},{"_id":"themes/next/source/js/src/scrollspy.js","path":"js/src/scrollspy.js","modified":0,"renderable":1},{"_id":"themes/next/source/js/src/utils.js","path":"js/src/utils.js","modified":0,"renderable":1},{"_id":"themes/next/source/js/src/bootstrap.js","path":"js/src/bootstrap.js","modified":0,"renderable":1},{"_id":"themes/next/source/js/src/affix.js","path":"js/src/affix.js","modified":0,"renderable":1},{"_id":"themes/next/source/vendors/fastclick/LICENSE","path":"vendors/fastclick/LICENSE","modified":0,"renderable":1},{"_id":"themes/next/source/vendors/fastclick/README.md","path":"vendors/fastclick/README.md","modified":0,"renderable":1},{"_id":"themes/next/source/vendors/fastclick/bower.json","path":"vendors/fastclick/bower.json","modified":0,"renderable":1},{"_id":"themes/next/source/vendors/font-awesome/HELP-US-OUT.txt","path":"vendors/font-awesome/HELP-US-OUT.txt","modified":0,"renderable":1},{"_id":"themes/next/source/vendors/font-awesome/bower.json","path":"vendors/font-awesome/bower.json","modified":0,"renderable":1},{"_id":"themes/next/source/vendors/jquery_lazyload/CONTRIBUTING.md","path":"vendors/jquery_lazyload/CONTRIBUTING.md","modified":0,"renderable":1},{"_id":"themes/next/source/vendors/jquery_lazyload/README.md","path":"vendors/jquery_lazyload/README.md","modified":0,"renderable":1},{"_id":"themes/next/source/vendors/jquery_lazyload/bower.json","path":"vendors/jquery_lazyload/bower.json","modified":0,"renderable":1},{"_id":"themes/next/source/vendors/jquery_lazyload/jquery.lazyload.js","path":"vendors/jquery_lazyload/jquery.lazyload.js","modified":0,"renderable":1},{"_id":"themes/next/source/vendors/jquery_lazyload/jquery.scrollstop.js","path":"vendors/jquery_lazyload/jquery.scrollstop.js","modified":0,"renderable":1},{"_id":"themes/next/source/vendors/velocity/bower.json","path":"vendors/velocity/bower.json","modified":0,"renderable":1},{"_id":"themes/next/source/vendors/velocity/velocity.min.js","path":"vendors/velocity/velocity.min.js","modified":0,"renderable":1},{"_id":"themes/next/source/vendors/velocity/velocity.ui.js","path":"vendors/velocity/velocity.ui.js","modified":0,"renderable":1},{"_id":"themes/next/source/vendors/velocity/velocity.ui.min.js","path":"vendors/velocity/velocity.ui.min.js","modified":0,"renderable":1},{"_id":"source/img/chaos.jpg","path":"img/chaos.jpg","modified":0,"renderable":0},{"_id":"themes/next/source/vendors/jquery/index.js","path":"vendors/jquery/index.js","modified":0,"renderable":1},{"_id":"themes/next/source/images/background.jpg","path":"images/background.jpg","modified":0,"renderable":1},{"_id":"themes/next/source/js/src/schemes/pisces.js","path":"js/src/schemes/pisces.js","modified":0,"renderable":1},{"_id":"themes/next/source/vendors/fancybox/source/blank.gif","path":"vendors/fancybox/source/blank.gif","modified":0,"renderable":1},{"_id":"themes/next/source/vendors/fancybox/source/fancybox_loading.gif","path":"vendors/fancybox/source/fancybox_loading.gif","modified":0,"renderable":1},{"_id":"themes/next/source/vendors/fancybox/source/fancybox_loading@2x.gif","path":"vendors/fancybox/source/fancybox_loading@2x.gif","modified":0,"renderable":1},{"_id":"themes/next/source/vendors/fancybox/source/fancybox_sprite.png","path":"vendors/fancybox/source/fancybox_sprite.png","modified":0,"renderable":1},{"_id":"themes/next/source/vendors/fancybox/source/fancybox_overlay.png","path":"vendors/fancybox/source/fancybox_overlay.png","modified":0,"renderable":1},{"_id":"themes/next/source/vendors/fancybox/source/fancybox_sprite@2x.png","path":"vendors/fancybox/source/fancybox_sprite@2x.png","modified":0,"renderable":1},{"_id":"themes/next/source/vendors/fancybox/source/jquery.fancybox.css","path":"vendors/fancybox/source/jquery.fancybox.css","modified":0,"renderable":1},{"_id":"themes/next/source/vendors/fancybox/source/jquery.fancybox.js","path":"vendors/fancybox/source/jquery.fancybox.js","modified":0,"renderable":1},{"_id":"themes/next/source/vendors/fancybox/source/jquery.fancybox.pack.js","path":"vendors/fancybox/source/jquery.fancybox.pack.js","modified":0,"renderable":1},{"_id":"themes/next/source/vendors/fastclick/lib/fastclick.js","path":"vendors/fastclick/lib/fastclick.js","modified":0,"renderable":1},{"_id":"themes/next/source/vendors/fastclick/lib/fastclick.min.js","path":"vendors/fastclick/lib/fastclick.min.js","modified":0,"renderable":1},{"_id":"themes/next/source/vendors/font-awesome/css/font-awesome.css","path":"vendors/font-awesome/css/font-awesome.css","modified":0,"renderable":1},{"_id":"themes/next/source/vendors/font-awesome/css/font-awesome.css.map","path":"vendors/font-awesome/css/font-awesome.css.map","modified":0,"renderable":1},{"_id":"themes/next/source/vendors/font-awesome/css/font-awesome.min.css","path":"vendors/font-awesome/css/font-awesome.min.css","modified":0,"renderable":1},{"_id":"themes/next/source/vendors/font-awesome/fonts/fontawesome-webfont.woff2","path":"vendors/font-awesome/fonts/fontawesome-webfont.woff2","modified":0,"renderable":1},{"_id":"themes/next/source/vendors/ua-parser-js/dist/ua-parser.pack.js","path":"vendors/ua-parser-js/dist/ua-parser.pack.js","modified":0,"renderable":1},{"_id":"themes/next/source/vendors/ua-parser-js/dist/ua-parser.min.js","path":"vendors/ua-parser-js/dist/ua-parser.min.js","modified":0,"renderable":1},{"_id":"themes/next/source/vendors/font-awesome/fonts/FontAwesome.otf","path":"vendors/font-awesome/fonts/FontAwesome.otf","modified":0,"renderable":1},{"_id":"themes/next/source/vendors/font-awesome/fonts/fontawesome-webfont.eot","path":"vendors/font-awesome/fonts/fontawesome-webfont.eot","modified":0,"renderable":1},{"_id":"themes/next/source/vendors/font-awesome/fonts/fontawesome-webfont.woff","path":"vendors/font-awesome/fonts/fontawesome-webfont.woff","modified":0,"renderable":1},{"_id":"themes/next/source/vendors/velocity/velocity.js","path":"vendors/velocity/velocity.js","modified":0,"renderable":1},{"_id":"themes/next/source/vendors/fancybox/source/helpers/fancybox_buttons.png","path":"vendors/fancybox/source/helpers/fancybox_buttons.png","modified":0,"renderable":1},{"_id":"themes/next/source/vendors/fancybox/source/helpers/jquery.fancybox-buttons.css","path":"vendors/fancybox/source/helpers/jquery.fancybox-buttons.css","modified":0,"renderable":1},{"_id":"themes/next/source/vendors/fancybox/source/helpers/jquery.fancybox-buttons.js","path":"vendors/fancybox/source/helpers/jquery.fancybox-buttons.js","modified":0,"renderable":1},{"_id":"themes/next/source/vendors/fancybox/source/helpers/jquery.fancybox-thumbs.css","path":"vendors/fancybox/source/helpers/jquery.fancybox-thumbs.css","modified":0,"renderable":1},{"_id":"themes/next/source/vendors/fancybox/source/helpers/jquery.fancybox-media.js","path":"vendors/fancybox/source/helpers/jquery.fancybox-media.js","modified":0,"renderable":1},{"_id":"themes/next/source/vendors/fancybox/source/helpers/jquery.fancybox-thumbs.js","path":"vendors/fancybox/source/helpers/jquery.fancybox-thumbs.js","modified":0,"renderable":1},{"_id":"themes/next/source/vendors/font-awesome/fonts/fontawesome-webfont.ttf","path":"vendors/font-awesome/fonts/fontawesome-webfont.ttf","modified":0,"renderable":1},{"_id":"themes/next/source/vendors/font-awesome/fonts/fontawesome-webfont.svg","path":"vendors/font-awesome/fonts/fontawesome-webfont.svg","modified":0,"renderable":1}],"Cache":[{"_id":"source/404.html","hash":"179044808f272d4486453e93a9cb08a05b0c88c7","modified":1458482174000},{"_id":"source/README.md","hash":"92e2452cef1013621156f38bfeb8b708d8ea3789","modified":1458530933318},{"_id":"source/googlec93373d7ad2555cc.html","hash":"b3bab842fde1d080655eccf559915b23944e68d2","modified":1459401255849},{"_id":"themes/next/.bowerrc","hash":"20038353db532b4c40625419d396da7359f89cbe","modified":1463364896684},{"_id":"themes/next/.editorconfig","hash":"211d2c92bfdddb3e81ea946f4ca7a539f150f4da","modified":1463364896684},{"_id":"themes/next/.gitignore","hash":"63d003fa46cf9665b4dab1786f9dc694812a5a79","modified":1463364896710},{"_id":"themes/next/.hound.yml","hash":"289dcf5bfe92dbd680d54d6e0668f41c9c9c0c78","modified":1463364896710},{"_id":"themes/next/.javascript_ignore","hash":"beb0b95736650284ceb712a162cc033847a83cd3","modified":1463364896710},{"_id":"themes/next/.jshintrc","hash":"b7d23f2ce8d99fa073f22f9960605f318acd7710","modified":1463364896711},{"_id":"themes/next/README.en.md","hash":"fa31bbc6dd8778b8dee469740c92b3b5b59702af","modified":1463364896711},{"_id":"themes/next/README.md","hash":"06aaf1241e9e1619956c86d8b1397a643840a9d1","modified":1463364896712},{"_id":"themes/next/_config.yml","hash":"c2d2a5bfc1ed98818e1bb8c2dc83ae79781d305f","modified":1464759123342},{"_id":"themes/next/bower.json","hash":"da39b00fcdf2e7a42af412de0a4d3617cc6d7084","modified":1463364896713},{"_id":"themes/next/gulpfile.coffee","hash":"4e8c1082fa82e383494ff5b5963b7936d9c7bb2e","modified":1463364896713},{"_id":"themes/next/package.json","hash":"95eaba1607544965e432d56406bae391dd11bcbb","modified":1463364896743},{"_id":"source/_posts/A-new-start.md","hash":"ccd7ba7e5c312376f0c2208447a4dd16858bfe02","modified":1463473781100},{"_id":"source/_posts/A-successful-redis-tuning-record.md","hash":"ef012fbcd7cc7e4ae0c65f8c226484bb4725d5ea","modified":1461148077287},{"_id":"source/_posts/JOOQ-from-entry-to-improve.md","hash":"e72ce3f3088318d11329629df87d2850e746c33f","modified":1464766772688},{"_id":"source/_posts/Nginx-with-docker-part-one.md","hash":"74920a02cfb9a9bc2c0e30e6a868000f81351d6d","modified":1462241190043},{"_id":"source/_posts/Nginx-with-docker-part-two.md","hash":"bfc6771a8db788a5b08320c657a21856f6f55724","modified":1463474805118},{"_id":"source/_posts/Remember-a-reverse-proxy-configuration-process-for-nginx-and-Tomcat-in-the-docker-environment.md","hash":"a0bb33ac746603465abb5530798db8e264015e22","modified":1463473669745},{"_id":"source/_posts/Message-system-architecture-evolution.md","hash":"eae32d949203ecd358c256b8df0eeba674c7b7ca","modified":1464758598873},{"_id":"source/_posts/Software-refactoring-experience-summary.md","hash":"7ebeec2c77a878e0ff5e5ebcf4ac6ca4bfdae326","modified":1464772718301},{"_id":"source/_posts/SQL-improve-elegant-use-join-query.md","hash":"dadb68a521b745f08b88eefde509d3e74e384c04","modified":1463474373401},{"_id":"source/_posts/Summary-of-distributed-theory.md","hash":"492cf43e46af15c848dd877593cde1ed7208cdf7","modified":1464774595968},{"_id":"source/_posts/Technical-architecture-specification-summary.md","hash":"5896cf3287b93a18c8062573fa3d60d7996d7724","modified":1464329264928},{"_id":"source/_posts/What-is-a-transaction.md","hash":"2e1c1348788f949de7289467f2a8784e3b35091f","modified":1464758604593},{"_id":"source/about/index.md","hash":"b4292e064440e152af26ac7e3fce61d13680d76f","modified":1464155701592},{"_id":"source/categories/index.md","hash":"782886da7e44225c0a9455b0f49ac8a7ade05310","modified":1463365392793},{"_id":"source/file/成亮_技术经理_简历.doc","hash":"373fcf751602e0b9884743687096d558f5e6f386","modified":1462859553182},{"_id":"source/img/NodeJS安装完成.png","hash":"1f630613e2f0b5223717df4e2985cc565a743649","modified":1458621733295},{"_id":"source/img/building-blocks.jpg","hash":"e0d7a68f5ee4c46b323f78c91f24b4f1b506176c","modified":1464669902825},{"_id":"source/img/github目录.png","hash":"4561e6ea5be731ad908566b7d12f41c6390ced8d","modified":1459136989655},{"_id":"source/img/hexo安装目录.png","hash":"886a417f75050c6c55185d569b18086dc443b5cf","modified":1459137291484},{"_id":"source/img/jacman主题安装目录.png","hash":"2b4e79309f308e0425a42cb14c0e1dd37df3e3c2","modified":1459137376492},{"_id":"source/img/npm配置信息.png","hash":"23415dacd781f9352099a4d12bb81523131cb4d7","modified":1458621806392},{"_id":"source/img/jooq-flyway.png","hash":"4961ef4e24db50b592e41dd5313dbc60dc51c701","modified":1459420682147},{"_id":"source/img/photos在redis的数据结构示例.png","hash":"08c30f9331a911384fea743397877fed7d69a8c8","modified":1459227128550},{"_id":"source/img/代码段.png","hash":"d2ddd6f72646d061518e4920dcba9290cc116f2c","modified":1459139733386},{"_id":"source/img/计算机软硬件配置.png","hash":"ebeb7c730c73eee2939170e49ba2413cb7cadcaf","modified":1458621706113},{"_id":"source/tags/index.md","hash":"73409ca3fc997ea445f5f8852bf65ef4172e9914","modified":1463470921384},{"_id":"source/index/index.md","hash":"7e5a547eb42be63e2288acf17bcde515ef0e29e6","modified":1463470914280},{"_id":"themes/next/.git/HEAD","hash":"acbaef275e46a7f14c1ef456fff2c8bbe8c84724","modified":1463364896668},{"_id":"themes/next/.git/config","hash":"340cff4364d9733a32042fdb93097c334a781c93","modified":1463364896673},{"_id":"themes/next/.git/description","hash":"9635f1b7e12c045212819dd934d809ef07efa2f4","modified":1463364877810},{"_id":"themes/next/.git/index","hash":"ae2cd84db72a68716db06121515635c2e81c71f8","modified":1463364896841},{"_id":"themes/next/.git/packed-refs","hash":"f4ef8bb8e97e724c9c4649a799b3d8177d806d2a","modified":1463364896664},{"_id":"themes/next/.github/CONTRIBUTING.md","hash":"4312fb37fa2b8663006be3c4fe01125ec01171c1","modified":1463364896709},{"_id":"themes/next/.github/ISSUE_TEMPLATE.md","hash":"2692e36cc35b1594530981e7727771f601720a43","modified":1463364896709},{"_id":"themes/next/languages/de.yml","hash":"4c3ffeb0d214c807a226dd98214958cb5483df1c","modified":1463364896714},{"_id":"themes/next/languages/default.yml","hash":"d2f6784b9c6567b64e58736e36025dbf96d863d4","modified":1463364896714},{"_id":"themes/next/languages/en.yml","hash":"df81ab6b1cf3c88ed053d3766381cd12eb659fe3","modified":1463364896714},{"_id":"themes/next/languages/fr-FR.yml","hash":"d8a40fe025fad6f42df0cf16d4be2d513769b062","modified":1463364896715},{"_id":"themes/next/languages/ja.yml","hash":"e594aa42a33c489e4a65065659a01bb76c3c0cb5","modified":1463364896716},{"_id":"themes/next/languages/id.yml","hash":"19537c8bae42c4c2e7d06a64537e8dfd503b7e19","modified":1463364896715},{"_id":"themes/next/languages/pt.yml","hash":"4c64594f477905d5d2d9ca2422f03175b7b0c617","modified":1463364896716},{"_id":"themes/next/languages/ru.yml","hash":"c3aedb94decf05a301662afc3398ab563dd9995a","modified":1463364896716},{"_id":"themes/next/languages/zh-Hans.yml","hash":"708fcc785904fb560c2eff507d237a7b67fc0f23","modified":1463372872235},{"_id":"themes/next/languages/zh-hk.yml","hash":"88e603eb0f3fd25c35bb37bd30372fd77bba7c46","modified":1463364896717},{"_id":"themes/next/languages/zh-tw.yml","hash":"04479b419c72b71fd34046f3fc33ebda4fe8de84","modified":1463364896718},{"_id":"themes/next/layout/_layout.swig","hash":"5885e0f417de8a75216f91b78a1a6f142f6bd79c","modified":1464156016893},{"_id":"themes/next/layout/archive.swig","hash":"b867a08f6b43de8b5d700c84b943df55917407ae","modified":1463364896741},{"_id":"themes/next/layout/category.swig","hash":"58cf08388901f7549b1fca95548b2c79173aa840","modified":1463364896741},{"_id":"themes/next/layout/index.swig","hash":"76f49c972f39e97177c7f6eab60116e80eb0cd68","modified":1463374314482},{"_id":"themes/next/layout/post.swig","hash":"c99a81dd7ed1d83a4924a55476cd14493ec6724f","modified":1463365778526},{"_id":"themes/next/layout/page.swig","hash":"a91e3fd7aef26e8a02e339e3372801c517f400cf","modified":1463364896742},{"_id":"themes/next/layout/tag.swig","hash":"6f764ea3ab11eeb7c530df45528d449b14f5dc62","modified":1463364896743},{"_id":"themes/next/scripts/merge-configs.js","hash":"f8cde6953939802f92da5b7a2458c6c539e9be69","modified":1463364896744},{"_id":"themes/next/source/404.html","hash":"179044808f272d4486453e93a9cb08a05b0c88c7","modified":1458482174000},{"_id":"themes/next/test/.jshintrc","hash":"1dae9d1cf7df1ae6d5c5efd6cffb949e9b8dcebb","modified":1463364896840},{"_id":"themes/next/test/helpers.js","hash":"f25e7f3265eb5a6e1ccbb5e5012fa9bebf134105","modified":1463364896841},{"_id":"themes/next/test/intern.js","hash":"db90b1063356727d72be0d77054fdc32fa882a66","modified":1463364896841},{"_id":"source/file/成亮_技术经理_简历.pdf","hash":"bec1b5a608be57553b85d53519098069bf78b2d0","modified":1463472843175},{"_id":"source/img/MircoService.png","hash":"15fa4f15a02970b3f2954d0fabeefcaf91fa5dbb","modified":1464774270198},{"_id":"source/img/thinking.jpg","hash":"fb0a14ff1c330bbdf6caaae6167730d046b9c681","modified":1464672474033},{"_id":"themes/next/source/fonts/.gitkeep","hash":"da39a3ee5e6b4b0d3255bfef95601890afd80709","modified":1463364896790},{"_id":"themes/next/.git/hooks/applypatch-msg.sample","hash":"86b9655a9ebbde13ac8dd5795eb4d5b539edab0f","modified":1463364877811},{"_id":"themes/next/.git/hooks/commit-msg.sample","hash":"ee1ed5aad98a435f2020b6de35c173b75d9affac","modified":1463364877811},{"_id":"themes/next/.git/hooks/post-update.sample","hash":"b614c2f63da7dca9f1db2e7ade61ef30448fc96c","modified":1463364877836},{"_id":"themes/next/.git/hooks/pre-applypatch.sample","hash":"42fa41564917b44183a50c4d94bb03e1768ddad8","modified":1463364877836},{"_id":"themes/next/.git/hooks/pre-commit.sample","hash":"36aed8976dcc08b5076844f0ec645b18bc37758f","modified":1463364877837},{"_id":"themes/next/.git/hooks/pre-push.sample","hash":"b4ad74c989616b7395dc6c9fce9871bb1e86dfb5","modified":1463364877837},{"_id":"themes/next/.git/hooks/prepare-commit-msg.sample","hash":"2b6275eda365cad50d167fe3a387c9bc9fedd54f","modified":1463364877838},{"_id":"themes/next/.git/hooks/update.sample","hash":"39355a075977d05708ef74e1b66d09a36e486df1","modified":1463364877838},{"_id":"themes/next/.git/hooks/pre-rebase.sample","hash":"5885a56ab4fca8075a05a562d005e922cde9853b","modified":1463364877837},{"_id":"themes/next/.git/info/exclude","hash":"c879df015d97615050afa7b9641e3352a1e701ac","modified":1463364877861},{"_id":"themes/next/.git/logs/HEAD","hash":"4d7a11056673b661c8a19f895536a8321a0f5132","modified":1463364896671},{"_id":"themes/next/layout/_macro/post.swig","hash":"f5755d509a4dab9dc661a307eed6bb07ef2ee2fb","modified":1463368177772},{"_id":"themes/next/layout/_macro/post-collapse.swig","hash":"b87a5122dbff1d5fccf8f3d09d1640bd4b01c4a0","modified":1463364896719},{"_id":"themes/next/layout/_macro/sidebar.swig","hash":"9fc9f89c169439d7584197930359b758eb198a1c","modified":1463364896721},{"_id":"themes/next/layout/_macro/reward.swig","hash":"b6cb171f0ed227b82b8f7601814af2df93f3a09a","modified":1463364896720},{"_id":"themes/next/layout/_macro/wechat-subscriber.swig","hash":"d569af20d20a960d534a5b60f90c20fef519d351","modified":1463364896721},{"_id":"themes/next/layout/_partials/comments.swig","hash":"325dd5923d845a539fc0524ca72ce40edd1e516a","modified":1463364896722},{"_id":"themes/next/layout/_partials/duoshuo-hot-articles.swig","hash":"ba75672183d94f1de7c8bd0eeee497a58c70e889","modified":1463364896722},{"_id":"themes/next/layout/_partials/footer.swig","hash":"102ef5cffbdafdf96fd1ad4e897d496b01b404e7","modified":1464689777766},{"_id":"themes/next/layout/_partials/head.swig","hash":"0065ae49406ade2848b86bd4cd520af9d2148ece","modified":1463364896724},{"_id":"themes/next/layout/_partials/header.swig","hash":"963a765dc00e6ac43cfc53ffaf5725eb854cf95e","modified":1463375244244},{"_id":"themes/next/layout/_partials/pagination.swig","hash":"1634fb887842698e01ff6e632597fe03c75d2d01","modified":1463364896725},{"_id":"themes/next/layout/_partials/search.swig","hash":"95b55fe35f2d2c22f2cc055d4379b5435314c7ec","modified":1463364896726},{"_id":"themes/next/layout/_scripts/baidu-push.swig","hash":"c5db707b46eac6a5df1d2a77f8556945a66fd181","modified":1463364896730},{"_id":"themes/next/layout/_scripts/boostrap.swig","hash":"c0f5a0955f69ca4ed9ee64a2d5f8aa75064935ad","modified":1463364896730},{"_id":"themes/next/layout/_scripts/commons.swig","hash":"931808ad9b8d8390c0dcf9bdeb0954eeb9185d68","modified":1463364896731},{"_id":"themes/next/layout/_scripts/vendors.swig","hash":"c9d45628330ce8bf5fbe71c9f131c7d75334c1c4","modified":1463364896740},{"_id":"themes/next/scripts/tags/center-quote.js","hash":"99b66949f18398689b904907af23c013be1b978f","modified":1463364896744},{"_id":"themes/next/scripts/tags/full-image.js","hash":"86194a05a8c6499de0b2aaa525d6de135778c0ae","modified":1463364896745},{"_id":"themes/next/scripts/tags/group-pictures.js","hash":"ac681b0d0d8d39ba3817336c0270c6787c2b6b70","modified":1463364896745},{"_id":"themes/next/source/css/main.styl","hash":"a91dbb7ef799f0a171b5e726c801139efe545176","modified":1463364896790},{"_id":"themes/next/source/images/avatar.gif","hash":"264082bb3a1af70d5499c7d22b0902cb454b6d12","modified":1463364896791},{"_id":"themes/next/source/images/avatar.png","hash":"2f5ca45b01b705cfde874a644ea9b4a635ccd6c0","modified":1458382170998},{"_id":"themes/next/source/images/background-backup.jpg","hash":"5b961c607cc66ce1bf8b0c82399c7505e82f995e","modified":1458547201438},{"_id":"themes/next/source/images/cc-by-nc-nd.svg","hash":"bc3588c9b2d7c68830524783120ff6cf957cf668","modified":1463364896791},{"_id":"themes/next/source/images/cc-by-nc-sa.svg","hash":"6f55543d1fb9cbc436c101d24f802dec7b41efc3","modified":1463364896792},{"_id":"themes/next/source/images/cc-by-nc.svg","hash":"6f076713fb9bf934aa2c1046bdf2cf2e37bc1eab","modified":1463364896792},{"_id":"themes/next/source/images/cc-by-nd.svg","hash":"42cd73da328077ccc92f859bb8f3cf621b3484f8","modified":1463364896793},{"_id":"themes/next/source/images/cc-by-sa.svg","hash":"70c1535f43e54e5ff35ca81419e77e4c0c301398","modified":1463364896793},{"_id":"themes/next/source/images/cc-by.svg","hash":"e92a33c32d1dac8ed94849b2b4e6456e887efe70","modified":1463364896794},{"_id":"themes/next/source/images/cc-zero.svg","hash":"9bfb52b2f63527a7049247bf00d44e6dc1170e7d","modified":1463364896794},{"_id":"themes/next/source/images/favicon.ico","hash":"48d909a3f0cda656828bbf390962dc8259bcd037","modified":1458528691318},{"_id":"themes/next/source/images/loading.gif","hash":"5fbd472222feb8a22cf5b8aa5dc5b8e13af88e2b","modified":1463364896795},{"_id":"themes/next/source/images/placeholder.gif","hash":"5fbd472222feb8a22cf5b8aa5dc5b8e13af88e2b","modified":1463364896795},{"_id":"themes/next/source/images/quote-l.svg","hash":"cd108d6f44351cadf8e6742565217f88818a0458","modified":1463364896795},{"_id":"themes/next/source/images/quote-r.svg","hash":"2a2a250b32a87c69dcc1b1976c74b747bedbfb41","modified":1463364896796},{"_id":"themes/next/source/images/searchicon.png","hash":"67727a6a969be0b2659b908518fa6706eed307b8","modified":1463364896796},{"_id":"themes/next/layout/_scripts/schemes/mist.swig","hash":"da39a3ee5e6b4b0d3255bfef95601890afd80709","modified":1463364896732},{"_id":"themes/next/layout/_scripts/schemes/muse.swig","hash":"da39a3ee5e6b4b0d3255bfef95601890afd80709","modified":1463364896732},{"_id":"themes/next/source/css/_mixins/Muse.styl","hash":"da39a3ee5e6b4b0d3255bfef95601890afd80709","modified":1463364896774},{"_id":"themes/next/source/css/_mixins/Mist.styl","hash":"da39a3ee5e6b4b0d3255bfef95601890afd80709","modified":1463364896774},{"_id":"themes/next/source/css/_mixins/custom.styl","hash":"da39a3ee5e6b4b0d3255bfef95601890afd80709","modified":1463364896775},{"_id":"themes/next/source/css/_variables/Muse.styl","hash":"da39a3ee5e6b4b0d3255bfef95601890afd80709","modified":1463364896787},{"_id":"themes/next/source/css/_variables/custom.styl","hash":"da39a3ee5e6b4b0d3255bfef95601890afd80709","modified":1463364896789},{"_id":"themes/next/source/rewards/wechat-reward-image.png","hash":"63bccd259ad1a2cc0c90a9e66a9f386aedadd8e8","modified":1463369112969},{"_id":"themes/next/.git/refs/heads/master","hash":"4ef9f91c1cc6d025b6873e0ccf647436959bf219","modified":1463364896670},{"_id":"themes/next/layout/_partials/head/external-fonts.swig","hash":"d8d021fb96fd195824758666aa535dc90fa08b67","modified":1463366689223},{"_id":"themes/next/layout/_partials/search/localsearch.swig","hash":"efa7efcbb575381b508f9aa0e0c53140eef72a7b","modified":1463364896726},{"_id":"themes/next/layout/_partials/search/swiftype.swig","hash":"a8c7f9ca7c605d039a1f3bf4e4d3183700a3dd62","modified":1463364896727},{"_id":"themes/next/layout/_partials/share/duoshuo_share.swig","hash":"d4fbffd7fa8f2090eb32a871872665d90a885fac","modified":1463364896729},{"_id":"themes/next/layout/_partials/search/tinysou.swig","hash":"b25002a83cbd2ca0c4a5df87ad5bff26477c0457","modified":1463364896727},{"_id":"themes/next/layout/_partials/share/add-this.swig","hash":"bf8e9223a40748b2e3ef77d753a8e1dbbce8095e","modified":1463364896728},{"_id":"themes/next/layout/_partials/share/jiathis.swig","hash":"12684840de632eb16e53ffa863166306a756fd4f","modified":1463364896729},{"_id":"themes/next/layout/_partials/share/baidushare.swig","hash":"3fdde03f45a80f7a85097a40b40358adde618fc7","modified":1463364896728},{"_id":"themes/next/layout/_scripts/pages/post-details.swig","hash":"9b84ab576982b2c3bb0291da49143bc77fba3cc6","modified":1463364896731},{"_id":"themes/next/layout/_scripts/schemes/pisces.swig","hash":"a9a3995b9615adfb8d6b127c78c6771627bee19a","modified":1463364896733},{"_id":"themes/next/layout/_scripts/third-party/analytics.swig","hash":"91c5353fcb94cc3b3f265b06ad2341734bc4c826","modified":1463364896733},{"_id":"themes/next/layout/_scripts/third-party/comments.swig","hash":"8ba01f1ac07fbca62a4b00f5a0a3a506122c1530","modified":1463364896737},{"_id":"themes/next/layout/_scripts/third-party/lean-analytics.swig","hash":"3bb70d8d68142ee27f3cc98c2a4339757e7af3d3","modified":1463364896738},{"_id":"themes/next/layout/_scripts/third-party/mathjax.swig","hash":"4a5c6df1579a4ca72ed17f7dbd6d16a509aa7dc8","modified":1463364896739},{"_id":"themes/next/layout/_scripts/third-party/localsearch.swig","hash":"5bd98c26cc188a2a30504d1330a0eaae34034db0","modified":1463364896739},{"_id":"themes/next/layout/_scripts/third-party/tinysou.swig","hash":"fe95dd3d166634c466e19aa756e65ad6e8254d3e","modified":1463364896739},{"_id":"themes/next/source/css/_custom/custom.styl","hash":"47c4a0f177dcd7453e7cb2ca758826465f77a068","modified":1463375686576},{"_id":"themes/next/source/css/_mixins/Pisces.styl","hash":"a0f23e75a137d8c996c70e2059e0074f1e97a127","modified":1463364896775},{"_id":"themes/next/source/css/_mixins/base.styl","hash":"531934ea21ef4dc9f0978512050f54834f0a6cff","modified":1463364896775},{"_id":"themes/next/source/css/_variables/Pisces.styl","hash":"b8e3663996b39590509d843f674360872b0242ac","modified":1463364896788},{"_id":"themes/next/source/css/_variables/base.styl","hash":"a7ae72e846393493385275d934eaa78534d9834c","modified":1463364896789},{"_id":"themes/next/source/css/_variables/Mist.styl","hash":"e55265c8a8a6ae0c3c08e3509de92ee62c3cb5f6","modified":1463364896787},{"_id":"themes/next/source/js/src/hook-duoshuo.js","hash":"51e311dbdaae7487003662edf4aae35b641df804","modified":1464674901646},{"_id":"themes/next/source/js/src/motion.js","hash":"ff9ea37d05c269e3a140c4ab448af03efc4bcc76","modified":1463364896798},{"_id":"themes/next/source/js/src/post-details.js","hash":"458af3b1bd7783c1950808e66cedfa9fb68bf21f","modified":1463364896799},{"_id":"themes/next/source/js/src/scrollspy.js","hash":"b7657be25fc52ec67c75ab5481bdcb483573338b","modified":1463364896800},{"_id":"themes/next/source/js/src/utils.js","hash":"418d09eb4df5dcc5e8d13d7f6245b1888200b51c","modified":1463364896801},{"_id":"themes/next/source/js/src/bootstrap.js","hash":"4a0da1bed19e65bd7db42421b447061bc1618710","modified":1463364896797},{"_id":"themes/next/source/js/src/affix.js","hash":"1b509c3b5b290a6f4607f0f06461a0c33acb69b1","modified":1463364896797},{"_id":"themes/next/source/vendors/fancybox/.bower.json","hash":"9be892a4e14e0da18ff9cb962c9ef71f163b1b22","modified":1463364896801},{"_id":"themes/next/source/vendors/fancybox/.gitattributes","hash":"672d3b5767e0eacd83bb41b188c913f2cf754793","modified":1463364896802},{"_id":"themes/next/source/vendors/fastclick/.bower.json","hash":"bf3eef9d647cd7c9b62feda3bc708c6cdd7c0877","modified":1463364896810},{"_id":"themes/next/source/vendors/fastclick/LICENSE","hash":"6f474ea75c42442da7bbcf2e9143ce98258efd8d","modified":1463364896811},{"_id":"themes/next/source/vendors/fastclick/README.md","hash":"68a9b9d53126405b0fa5f3324f1fb96dbcc547aa","modified":1463364896811},{"_id":"themes/next/source/vendors/fastclick/bower.json","hash":"a9b3ee1e4db71a0e4ea6d5bed292d176dd68b261","modified":1463364896812},{"_id":"themes/next/source/vendors/font-awesome/.bower.json","hash":"bb093f2ac1f1305069d873a7941324c8e0de3135","modified":1463364896814},{"_id":"themes/next/source/vendors/font-awesome/.gitignore","hash":"03ddbf76c1dd1afb93eed0b670d2eee747472ef1","modified":1463364896814},{"_id":"themes/next/source/vendors/font-awesome/.npmignore","hash":"c31ff06a740955e44edd4403902e653ccabfd4db","modified":1463364896815},{"_id":"themes/next/source/vendors/font-awesome/HELP-US-OUT.txt","hash":"ed80b43dbc7e3009b2f436741b9796df8eb3be02","modified":1463364896816},{"_id":"themes/next/source/vendors/font-awesome/bower.json","hash":"71e7183634dc1b9449f590f15ebd7201add22ca7","modified":1463364896816},{"_id":"themes/next/source/vendors/jquery/.bower.json","hash":"865d6c1328ab209a4376b9d2b7a7824369565f28","modified":1463364896829},{"_id":"themes/next/source/vendors/jquery_lazyload/.bower.json","hash":"90fa628f156d8045357ff11eaf32e61abacf10e8","modified":1463364896831},{"_id":"themes/next/source/vendors/jquery_lazyload/CONTRIBUTING.md","hash":"4ded6fee668544778e97e38c2b211fc56c848e77","modified":1463364896831},{"_id":"themes/next/source/vendors/jquery_lazyload/README.md","hash":"b930297cb98b8e1dbd5abe9bc1ed9d5935d18ce8","modified":1463364896832},{"_id":"themes/next/source/vendors/jquery_lazyload/bower.json","hash":"e0acf1db27b0cc16128a59c46db1db406b5c4c58","modified":1463364896832},{"_id":"themes/next/source/vendors/jquery_lazyload/jquery.lazyload.js","hash":"f4a570908f6c89c6edfb1c74959e733eaadea4f2","modified":1463364896833},{"_id":"themes/next/source/vendors/jquery_lazyload/jquery.scrollstop.js","hash":"bf773ad48a0b9aa77681a89d7569eefc0f7b7b18","modified":1463364896833},{"_id":"themes/next/source/vendors/velocity/bower.json","hash":"92d92860418c4216aa59eb4cb4a556290a7ad9c3","modified":1463364896836},{"_id":"themes/next/source/vendors/velocity/.bower.json","hash":"63da5e80ebb61bb66a2794d5936315ca44231f0c","modified":1463364896835},{"_id":"themes/next/source/vendors/velocity/velocity.min.js","hash":"bf172816a9c57f9040e3d19c24e181a142daf92b","modified":1463364896838},{"_id":"themes/next/source/vendors/velocity/velocity.ui.js","hash":"dbbfb50f6502f6b81dcc9fee7b31f1e812da3464","modified":1463364896839},{"_id":"themes/next/source/vendors/velocity/velocity.ui.min.js","hash":"dde584994ac13dc601836e86f4cf490e418d9723","modified":1463364896840},{"_id":"source/img/chaos.jpg","hash":"50ad9e9101113f3516556cd62311d047be2bf537","modified":1464773744015},{"_id":"themes/next/source/vendors/jquery/index.js","hash":"17a740d68a1c330876c198b6a4d9319f379f3af2","modified":1463364896830},{"_id":"themes/next/.git/logs/refs/heads/master","hash":"4d7a11056673b661c8a19f895536a8321a0f5132","modified":1463364896670},{"_id":"themes/next/.git/objects/pack/pack-0263de85f194fda65b086beb146c037866e71ced.idx","hash":"89c527d4ae3dcc2ceeec20e47c6ffb2b7fa96b7a","modified":1463364896439},{"_id":"themes/next/.git/refs/remotes/origin/HEAD","hash":"d9427cda09aba1cdde5c69c2b13c905bddb0bc51","modified":1463364896665},{"_id":"themes/next/layout/_scripts/third-party/comments/disqus.swig","hash":"c1186e609d4810ebfb3e675e9045b023a557d1db","modified":1463364896737},{"_id":"themes/next/layout/_scripts/third-party/comments/duoshuo.swig","hash":"2338be12ffee58bc08197cb9da8aaf31737aaf5c","modified":1463364896738},{"_id":"themes/next/layout/_scripts/third-party/analytics/busuanzi-counter.swig","hash":"24105e62d7f26946907fa14cd02589f899bf8122","modified":1463364896734},{"_id":"themes/next/layout/_scripts/third-party/analytics/baidu-analytics.swig","hash":"ae5b8597603d4e42ee66ed121544e7b1c644767e","modified":1463364896734},{"_id":"themes/next/layout/_scripts/third-party/analytics/cnzz-analytics.swig","hash":"096e7a6958b3bcacaa94361266832871ccb989c0","modified":1463364896735},{"_id":"themes/next/layout/_scripts/third-party/analytics/facebook-sdk.swig","hash":"61347b9cf5c42a02f28cda4b6d920d6d17099d44","modified":1463364896735},{"_id":"themes/next/layout/_scripts/third-party/analytics/google-analytics.swig","hash":"1b6af02fd0ba3f729675cd95429a0cea4aebf358","modified":1463364896736},{"_id":"themes/next/layout/_scripts/third-party/analytics/tencent-analytics.swig","hash":"8a399df90dadba5ad4e781445b58f4765aeb701e","modified":1463364896736},{"_id":"themes/next/source/css/_common/components/back-to-top.styl","hash":"ad69cbf94eedacc27e756cdb9c7073416db697d0","modified":1463364896747},{"_id":"themes/next/source/css/_common/components/buttons.styl","hash":"22828f5141c0cecb9ef25a110e194cdfa3a36423","modified":1463364896747},{"_id":"themes/next/source/css/_common/components/comments.styl","hash":"ff4489cd582f518bba6909a301ac1292a38b4e96","modified":1463364896748},{"_id":"themes/next/source/css/_common/components/components.styl","hash":"b7d5cc29586ac796a50d90974ad99d24a5982137","modified":1463364896748},{"_id":"themes/next/source/css/_common/components/pagination.styl","hash":"88559b13ce94311405b170a0506ded91273beceb","modified":1463364896755},{"_id":"themes/next/source/css/_common/components/tag-cloud.styl","hash":"6eb4bcc3056bd279d000607e8b4dad50d368ca69","modified":1463364896764},{"_id":"themes/next/source/css/_common/outline/outline.styl","hash":"12662536c7a07fff548abe94171f34b768dd610f","modified":1463364896770},{"_id":"themes/next/source/css/_common/scaffolding/base.styl","hash":"5a35aa0381b0e1d465b952a997194441020446ea","modified":1463364896771},{"_id":"themes/next/source/css/_common/scaffolding/helpers.styl","hash":"b6ee5fefa6046086a76ddbcfafc82482816fa3e0","modified":1463364896771},{"_id":"themes/next/source/css/_common/scaffolding/normalize.styl","hash":"3f40e8a9fe8e7bd5cfc4cf4cbbbcb9539462e973","modified":1463364896772},{"_id":"themes/next/source/css/_common/scaffolding/scaffolding.styl","hash":"c9218b48c56e52c06af9ce3cc8fbdae737cf16fe","modified":1463364896772},{"_id":"themes/next/source/css/_common/scaffolding/tables.styl","hash":"ea9069645696f86c5df64208490876fe150c8cae","modified":1463364896773},{"_id":"themes/next/source/css/_schemes/Mist/_menu.styl","hash":"26666c1f472bf5f3fb9bc62081cca22b4de15ccb","modified":1463364896778},{"_id":"themes/next/source/css/_schemes/Mist/_header.styl","hash":"d0bfd1bef988c76f7d7dd72d88af6f0908a8b0db","modified":1463364896777},{"_id":"themes/next/source/css/_schemes/Mist/_logo.styl","hash":"b1025c421406d2c24cc92a02ae28c1915b01e240","modified":1463364896777},{"_id":"themes/next/source/css/_schemes/Mist/_posts-expanded.styl","hash":"55b44e03054cd20ed8129bf986b15fba5fd85aad","modified":1463364896778},{"_id":"themes/next/source/css/_schemes/Mist/index.styl","hash":"9b913b73d31d21f057f97115ffab93cfa578b884","modified":1463364896779},{"_id":"themes/next/source/css/_schemes/Mist/_search.styl","hash":"09c965022c13b84ed8a661fee8ac2a6d550495ae","modified":1463364896779},{"_id":"themes/next/source/css/_schemes/Mist/_base.styl","hash":"25d5e45a355ee2093f3b8b8eeac125ebf3905026","modified":1463364896776},{"_id":"themes/next/source/css/_schemes/Muse/_layout.styl","hash":"124b540f059fd1ed13514362007cfc70355278c6","modified":1463364896781},{"_id":"themes/next/source/css/_schemes/Muse/_logo.styl","hash":"748dbfbf9c08e719ddc775958003c64b00d39dab","modified":1463364896781},{"_id":"themes/next/source/css/_schemes/Muse/_menu.styl","hash":"13af2fb21fabfc4df4b577ce5363e13d03daff71","modified":1463364896782},{"_id":"themes/next/source/css/_schemes/Muse/_search.styl","hash":"09c965022c13b84ed8a661fee8ac2a6d550495ae","modified":1463364896782},{"_id":"themes/next/source/css/_schemes/Muse/index.styl","hash":"5dbc0d0c897e46760e5dbee416530d485c747bba","modified":1463364896783},{"_id":"themes/next/source/css/_schemes/Pisces/_brand.styl","hash":"c9875c010bebd77b4f59d459a10455fceb0a66a1","modified":1463364896784},{"_id":"themes/next/source/css/_schemes/Pisces/_full-image.styl","hash":"de31e923bf5102498f06b1ae6bdf2ea22409f3e0","modified":1463364896784},{"_id":"themes/next/source/css/_schemes/Pisces/_layout.styl","hash":"2182a6da3434a6fd4d03ab1592c645d3d3c88500","modified":1463364896785},{"_id":"themes/next/source/css/_schemes/Pisces/_menu.styl","hash":"9887bd3894db5394c1e64e800afaae55f47e8dd0","modified":1463364896785},{"_id":"themes/next/source/css/_schemes/Pisces/_posts.styl","hash":"1f6e2ce674735269599acc6d77b3ea18d31967fc","modified":1463364896786},{"_id":"themes/next/source/css/_schemes/Pisces/_sidebar.styl","hash":"983c0723e8cfd84b67c2e66da0c26425a8db06e0","modified":1463364896786},{"_id":"themes/next/source/css/_schemes/Pisces/index.styl","hash":"88a5e0e95f93e4adb196bff1aac17d6cfb03768a","modified":1463364896787},{"_id":"themes/next/source/images/background.jpg","hash":"825cb04466d213ea3604eac51f95a42731998476","modified":1463471593398},{"_id":"themes/next/source/js/src/schemes/pisces.js","hash":"a9d064d600ee35acd66508167e1ac8c6cfdbdcd8","modified":1463364896800},{"_id":"themes/next/source/vendors/fancybox/source/blank.gif","hash":"2daeaa8b5f19f0bc209d976c02bd6acb51b00b0a","modified":1463364896803},{"_id":"themes/next/source/vendors/fancybox/source/fancybox_loading.gif","hash":"1a755fb2599f3a313cc6cfdb14df043f8c14a99c","modified":1463364896803},{"_id":"themes/next/source/vendors/fancybox/source/fancybox_loading@2x.gif","hash":"273b123496a42ba45c3416adb027cd99745058b0","modified":1463364896803},{"_id":"themes/next/source/vendors/fancybox/source/fancybox_sprite.png","hash":"17df19f97628e77be09c352bf27425faea248251","modified":1463364896804},{"_id":"themes/next/source/vendors/fancybox/source/fancybox_overlay.png","hash":"b3a4ee645ba494f52840ef8412015ba0f465dbe0","modified":1463364896804},{"_id":"themes/next/source/vendors/fancybox/source/fancybox_sprite@2x.png","hash":"30c58913f327e28f466a00f4c1ac8001b560aed8","modified":1463364896805},{"_id":"themes/next/source/vendors/fancybox/source/jquery.fancybox.css","hash":"82f33ad0842aa9c154d029e0dada2497d4eb1d57","modified":1463364896808},{"_id":"themes/next/source/vendors/fancybox/source/jquery.fancybox.js","hash":"d71602cbca33b9ecdb7ab291b7f86a49530f3601","modified":1463364896809},{"_id":"themes/next/source/vendors/fancybox/source/jquery.fancybox.pack.js","hash":"ae6318aeb62ad4ce7a7e9a4cdacd93ffb004f0fb","modified":1463364896810},{"_id":"themes/next/source/vendors/fastclick/lib/fastclick.js","hash":"1d6aeda0480d0e4cb6198edf7719d601d4ae2ccc","modified":1463364896813},{"_id":"themes/next/source/vendors/fastclick/lib/fastclick.min.js","hash":"2cae0f5a6c5d6f3cb993015e6863f9483fc4de18","modified":1463364896813},{"_id":"themes/next/source/vendors/font-awesome/css/font-awesome.css","hash":"811432ad1e2d6c1f6da9a63fd919bf2a02b71dd9","modified":1463364896817},{"_id":"themes/next/source/vendors/font-awesome/css/font-awesome.css.map","hash":"1573904b82807abbb32c97a3632c6c6808eaac50","modified":1463364896817},{"_id":"themes/next/source/vendors/font-awesome/css/font-awesome.min.css","hash":"4c2c5f5f6cc86d775a44b944661e038b7be98149","modified":1463364896819},{"_id":"themes/next/source/vendors/font-awesome/fonts/fontawesome-webfont.woff2","hash":"574ea2698c03ae9477db2ea3baf460ee32f1a7ea","modified":1463364896828},{"_id":"themes/next/source/vendors/ua-parser-js/dist/ua-parser.pack.js","hash":"a817b6c158cbc5bab3582713de9fe18a18a80552","modified":1463364896835},{"_id":"themes/next/source/vendors/ua-parser-js/dist/ua-parser.min.js","hash":"41ea797c68dbcff2f6fb3aba1d1043a22e7cc0f6","modified":1463364896834},{"_id":"themes/next/source/vendors/font-awesome/fonts/FontAwesome.otf","hash":"0112e96f327d413938d37c1693806f468ffdbace","modified":1463364896821},{"_id":"themes/next/source/vendors/font-awesome/fonts/fontawesome-webfont.eot","hash":"b3c2f08e73320135b69c23a3908b87a12053a2f6","modified":1463364896821},{"_id":"themes/next/source/vendors/font-awesome/fonts/fontawesome-webfont.woff","hash":"507970402e328b2baeb05bde73bf9ded4e2c3a2d","modified":1463364896828},{"_id":"themes/next/source/vendors/velocity/velocity.js","hash":"e63dc7cea055ca60a95d286f32349d88b10c5a4d","modified":1463364896838},{"_id":"themes/next/.git/logs/refs/remotes/origin/HEAD","hash":"4d7a11056673b661c8a19f895536a8321a0f5132","modified":1463364896668},{"_id":"themes/next/source/css/_common/components/header/header.styl","hash":"53cde051e0337f4bf42fb8d6d7a79fa3fa6d4ef2","modified":1463364896749},{"_id":"themes/next/source/css/_common/components/footer/footer.styl","hash":"4c4ef6e997d0c6e21de39c2daa0c768e12c8c6fa","modified":1463364896749},{"_id":"themes/next/source/css/_common/components/header/headerband.styl","hash":"d63e0cacc53dd375fcc113465a4328c59ff5f2c1","modified":1463364896750},{"_id":"themes/next/source/css/_common/components/header/menu.styl","hash":"852fd77500bda2c1a6651a14aa48d7d6222adc9d","modified":1463364896750},{"_id":"themes/next/source/css/_common/components/header/site-meta.styl","hash":"0656e753f182c9f47fef7304c847b7587a85ef0d","modified":1463364896751},{"_id":"themes/next/source/css/_common/components/header/site-nav.styl","hash":"1727702eac5d326b5c81a667944a245016668231","modified":1463364896751},{"_id":"themes/next/source/css/_common/components/highlight/highlight.styl","hash":"70ec8d38d2b3ee1906793d1dcb68032adfa65f03","modified":1463364896752},{"_id":"themes/next/source/css/_common/components/highlight/theme.styl","hash":"12e366f04497e3f44388fd40111a03e02f7c26af","modified":1463364896752},{"_id":"themes/next/source/css/_common/components/pages/archive.styl","hash":"104b5c79cd891506e0beaf938b083685f1da8637","modified":1463364896753},{"_id":"themes/next/source/css/_common/components/pages/categories.styl","hash":"7fb593f90d74a99c21840679933b9ef6fdc16a61","modified":1463364896753},{"_id":"themes/next/source/css/_common/components/pages/post-detail.styl","hash":"4e3838d7ac81d9ad133960f0f7ed58a44a015285","modified":1463364896754},{"_id":"themes/next/source/css/_common/components/pages/pages.styl","hash":"b8f9c95702e87fd0b170ab586c82c9718a245f8a","modified":1463364896753},{"_id":"themes/next/source/css/_common/components/sidebar/sidebar-author.styl","hash":"761eba9811b050b25d548cc0854de4824b41eb08","modified":1463364896761},{"_id":"themes/next/source/css/_common/components/sidebar/sidebar-blogroll.styl","hash":"821991c0890966a512b43e8b1cf9537e738a09a0","modified":1463364896762},{"_id":"themes/next/source/css/_common/components/sidebar/sidebar-feed-link.styl","hash":"61f8cea3c01acd600e90e1bc2a07def405503748","modified":1463364896762},{"_id":"themes/next/source/css/_common/components/sidebar/sidebar-nav.styl","hash":"1153bb71edf253765145559674390e16dd67c633","modified":1463364896763},{"_id":"themes/next/source/css/_common/components/sidebar/sidebar-toc.styl","hash":"394888efec32749b353292a59ec7f1b609d6325e","modified":1463364896763},{"_id":"themes/next/source/css/_common/components/sidebar/sidebar-toggle.styl","hash":"06b9a99d63b4d57fdbf70b88ab7036fbc47e3f52","modified":1463364896763},{"_id":"themes/next/source/css/_common/components/sidebar/sidebar.styl","hash":"702be9e57dd6ff5fa99642a1f6e3df26215b8805","modified":1463364896764},{"_id":"themes/next/source/css/_common/components/sidebar/site-state.styl","hash":"e71652d3216e289c8548b1ea2357822c1476a425","modified":1463364896764},{"_id":"themes/next/source/css/_common/components/post/post-collapse.styl","hash":"a45f5fce643eec4e1b927165229d560364bcace1","modified":1463364896755},{"_id":"themes/next/source/css/_common/components/post/post-eof.styl","hash":"a200c0a1c5a895ac9dc41e0641a5dfcd766be99b","modified":1463364896756},{"_id":"themes/next/source/css/_common/components/post/post-expand.styl","hash":"4866fb9453d7d4c83a1c4e55d74e4afed336eb8b","modified":1463364896757},{"_id":"themes/next/source/css/_common/components/post/post-gallery.styl","hash":"cd9e214e502697f2f2db84eb721bac57a49b0fce","modified":1463364896757},{"_id":"themes/next/source/css/_common/components/post/post-meta.styl","hash":"ca20affaeaf33c0904cb6356864fc6b78e95f447","modified":1463364896758},{"_id":"themes/next/source/css/_common/components/post/post-more-link.styl","hash":"2bc3e33fdfbcf348c96ca60598f629dcd7ba3617","modified":1463364896758},{"_id":"themes/next/source/css/_common/components/post/post-nav.styl","hash":"929fac3a505bacbce6ba63009fd15851e2a8669d","modified":1463364896758},{"_id":"themes/next/source/css/_common/components/post/post-reward.styl","hash":"8355b0e9375b3245508efda0e18acd069c2aa767","modified":1463364896759},{"_id":"themes/next/source/css/_common/components/post/post-tags.styl","hash":"5a982d8ef3b3623ea5f59e63728990f5623c1b57","modified":1463364896759},{"_id":"themes/next/source/css/_common/components/post/post-title.styl","hash":"350469437b20ecfd6f3ca45e400478f8e3f71cfb","modified":1463364896759},{"_id":"themes/next/source/css/_common/components/post/post-type.styl","hash":"01567edaea6978628aa5521a122a85434c418bfd","modified":1463364896760},{"_id":"themes/next/source/css/_common/components/post/post.styl","hash":"681b7c8ce4dc47130a0ca67c1ec62be7c96e4c4f","modified":1463364896760},{"_id":"themes/next/source/css/_common/components/tags/blockquote-center.styl","hash":"2fe76476432b31993338cb45cdb3b29a518b6379","modified":1463364896765},{"_id":"themes/next/source/css/_common/components/tags/full-image.styl","hash":"dd941824210733588841897457e0cc9697ca5608","modified":1463364896766},{"_id":"themes/next/source/css/_common/components/tags/group-pictures.styl","hash":"2ad1a2a9bbf6742d1b0762c4c623b68113d1e0fe","modified":1463364896766},{"_id":"themes/next/source/css/_common/components/tags/tags.styl","hash":"a83f493e494f5c73fab8f6f5b686ef1670490095","modified":1463364896766},{"_id":"themes/next/source/css/_common/components/third-party/baidushare.styl","hash":"5dbeed535d63a50265d96b396a5440f9bb31e4ba","modified":1463364896767},{"_id":"themes/next/source/css/_common/components/third-party/busuanzi-counter.styl","hash":"7f7e9df15148608a9c29326dd880d8e8e8efc0ec","modified":1463364896767},{"_id":"themes/next/source/css/_common/components/third-party/duoshuo.styl","hash":"717cc7f82be9cc151e23a7678601ff2fd3a7fa1d","modified":1463364896768},{"_id":"themes/next/source/css/_common/components/third-party/jiathis.styl","hash":"15975ba7456b96916b1dbac448a1a0d2c38b8f3d","modified":1463364896769},{"_id":"themes/next/source/css/_common/components/third-party/localsearch.styl","hash":"dcb4548d07cbb38b645b1753cf3ee7157e16921a","modified":1463364896769},{"_id":"themes/next/source/css/_common/components/third-party/third-party.styl","hash":"7bd182d918f3117335a5ee87a1b544e6d2b54d7d","modified":1463364896769},{"_id":"themes/next/source/css/_common/components/sidebar/sidebar-author-links.styl","hash":"7f2bdd6109614d35408ee5ac3335aad4464c69c7","modified":1463364896761},{"_id":"themes/next/source/css/_schemes/Mist/outline/outline.styl","hash":"a07aa12cc36ac5c819670c2a3c17d07ed7a08986","modified":1463364896780},{"_id":"themes/next/source/css/_schemes/Mist/sidebar/sidebar-blogroll.styl","hash":"cf900c5026ab36f31118317d0ae32a213e3ec2a9","modified":1463364896780},{"_id":"themes/next/source/css/_schemes/Muse/sidebar/sidebar-blogroll.styl","hash":"cf900c5026ab36f31118317d0ae32a213e3ec2a9","modified":1463364896783},{"_id":"themes/next/source/vendors/fancybox/source/helpers/fancybox_buttons.png","hash":"e385b139516c6813dcd64b8fc431c364ceafe5f3","modified":1463364896806},{"_id":"themes/next/source/vendors/fancybox/source/helpers/jquery.fancybox-buttons.css","hash":"6394c48092085788a8c0ef72670b0652006231a1","modified":1463364896806},{"_id":"themes/next/source/vendors/fancybox/source/helpers/jquery.fancybox-buttons.js","hash":"ee948b4489aedeb548a77c9e45d8c7c5732fd62d","modified":1463364896807},{"_id":"themes/next/source/vendors/fancybox/source/helpers/jquery.fancybox-thumbs.css","hash":"b88b589f5f1aa1b3d87cc7eef34c281ff749b1ae","modified":1463364896808},{"_id":"themes/next/source/vendors/fancybox/source/helpers/jquery.fancybox-media.js","hash":"51139a4c79573d372a347ef01a493222a1eaf10a","modified":1463364896807},{"_id":"themes/next/source/vendors/fancybox/source/helpers/jquery.fancybox-thumbs.js","hash":"d22b1629cb23a6181bebb70d0cf653ffe4b835c8","modified":1463364896808},{"_id":"themes/next/source/vendors/font-awesome/fonts/fontawesome-webfont.ttf","hash":"27cf1f2ec59aece6938c7bb2feb0e287ea778ff9","modified":1463364896827},{"_id":"themes/next/source/vendors/font-awesome/fonts/fontawesome-webfont.svg","hash":"f346b8b3df147e4059e1a7d66c52c9a6e1cec3e8","modified":1463364896825},{"_id":"themes/next/.git/objects/pack/pack-0263de85f194fda65b086beb146c037866e71ced.pack","hash":"147a00a12e494cdab64fa959912d2f0d3fea8270","modified":1463364896501},{"_id":"public/baidusitemap.xml","hash":"5d4c6e74d4717d8fbc953809d032c3f36b05b153","modified":1464776505755},{"_id":"public/atom.xml","hash":"3646a8437b87ef52b1db3c21253910c983c60b46","modified":1464776505755},{"_id":"public/search.xml","hash":"1b805b8e930d1990d14f985a8d12bc5c60edcb13","modified":1464776505755},{"_id":"public/sitemap.xml","hash":"09993555af13656490d47bc9594f654f2794bb6c","modified":1464776505756},{"_id":"public/about/index.html","hash":"a92227cb9490238c37a22f5b439c31212dc00765","modified":1464776505767},{"_id":"public/categories/index.html","hash":"c2f0f315cb0fadcc5515bc3afb634406110b0465","modified":1464776505767},{"_id":"public/tags/index.html","hash":"c508c9c18e12f81bc8a8d6be16857858f391f362","modified":1464776505767},{"_id":"public/index/index.html","hash":"6e41a345f7e1c7a58bed1230c34bd9ffdae12a3d","modified":1464776505767},{"_id":"public/post/2016/06/Message-system-architecture-evolution/index.html","hash":"f320f989478685d66e1a6717553d1a7d24b9b3e0","modified":1464776505767},{"_id":"public/post/2016/06/What-is-a-transaction/index.html","hash":"ae9c3873a1ffacaa33722f85138a31898aee4a7f","modified":1464776505767},{"_id":"public/post/2016/05/Summary-of-distributed-theory/index.html","hash":"7679be4f964c2e526ec67f0cfa4ce24b9b726a2e","modified":1464776505767},{"_id":"public/post/2016/05/Software-refactoring-experience-summary/index.html","hash":"9614e2345b0c642d01198ccf1d658afbce316acb","modified":1464776505767},{"_id":"public/post/2016/05/Technical-architecture-specification-summary/index.html","hash":"16b63387204aab447ee97b2ede521eaa3f025dc0","modified":1464776505767},{"_id":"public/post/2016/04/Nginx-with-docker-part-two/index.html","hash":"55206f30dc44be99b1ebcc265ae72396787a1540","modified":1464776505767},{"_id":"public/post/2016/04/Nginx-with-docker-part-one/index.html","hash":"6da7eecdbbfa24675f617be905cb10967fe2e858","modified":1464776505767},{"_id":"public/post/2016/04/Remember-a-reverse-proxy-configuration-process-for-nginx-and-Tomcat-in-the-docker-environment/index.html","hash":"0fd43f50396cd0b3630c7e9e5dc7e642b10cb180","modified":1464776505767},{"_id":"public/post/2016/04/JOOQ-from-entry-to-improve/index.html","hash":"a403941b3733805c8396d7da8ce925985e14f6ee","modified":1464776505767},{"_id":"public/post/2016/04/A-new-start/index.html","hash":"fa6d2dd9cde43da5221aac08f373067b732f1c34","modified":1464776505767},{"_id":"public/post/2016/03/A-successful-redis-tuning-record/index.html","hash":"169fa84068c9663d8a670b314334464189a44d7e","modified":1464776505767},{"_id":"public/post/2016/03/SQL-improve-elegant-use-join-query/index.html","hash":"d64f1a0a33662a73e82da3331fc96e04c9d62e69","modified":1464776505767},{"_id":"public/archives/index.html","hash":"180a62107c9217dc107f13f8c48dc0474a7837d4","modified":1464776505768},{"_id":"public/archives/page/2/index.html","hash":"55a4f744718b0c4e4bd4b80176f600ab513cb8d2","modified":1464776505768},{"_id":"public/archives/2016/index.html","hash":"4d5f1c03fd4143b5456c1e75f665e91a958cd3ce","modified":1464776505768},{"_id":"public/archives/2016/page/2/index.html","hash":"bc07e40089774cee91df22c203b04339909ca0a0","modified":1464776505768},{"_id":"public/archives/2016/03/index.html","hash":"5f3f5922865437a603a04982c2b3bcf97ccc4050","modified":1464776505768},{"_id":"public/archives/2016/04/index.html","hash":"63fc9203f114e7e19ec41c00a3d2ff6792a3330a","modified":1464776505768},{"_id":"public/archives/2016/05/index.html","hash":"6b976af76fb2a2e0be4619b9a803b12c2807cf54","modified":1464776505768},{"_id":"public/archives/2016/06/index.html","hash":"0c19f75732c7ec4cb37113d4512213fca41312cc","modified":1464776505768},{"_id":"public/categories/Tutorial/index.html","hash":"eb3fef2396aa936a83ab49cc23d87b68e117c0d9","modified":1464776505768},{"_id":"public/categories/Record/index.html","hash":"6ca22dca63d80b3609d4f447902d23f964f9c795","modified":1464776505768},{"_id":"public/categories/Learning/index.html","hash":"559030d01e44ac3c49b6727ae3b9734bf5c490c2","modified":1464776505768},{"_id":"public/categories/Summary/index.html","hash":"7478e0755cd5c2ebdcb4fc51f17c06e269a52dba","modified":1464776505768},{"_id":"public/index.html","hash":"bd96f77bd5c8e955754f956d5f1182cc046d71b2","modified":1464776505769},{"_id":"public/tags/GitHub/index.html","hash":"fbc8cdd13e72ea96fa3cedc7b2fb493cef26beae","modified":1464776505769},{"_id":"public/tags/Hexo/index.html","hash":"5bdefa34460b4bc5e908518db54701aa0095b805","modified":1464776505769},{"_id":"public/tags/Jacman/index.html","hash":"ed1fa7508a3118e8b365e803daae8e9af85a0b6a","modified":1464776505769},{"_id":"public/tags/Markdown/index.html","hash":"3d479d4e44a36a154cf0967a9a3979ad25202c46","modified":1464776505769},{"_id":"public/tags/Redis/index.html","hash":"8f40bfcfe84658d6ec62ccd413184dd851f82bf9","modified":1464776505770},{"_id":"public/tags/Hash/index.html","hash":"32ffa9d458a044b04b08210b43fbfda55d4fb1d8","modified":1464776505770},{"_id":"public/tags/Sharding/index.html","hash":"8e8c397e8356d6da7d8caab81afedb43e4565cc9","modified":1464776505770},{"_id":"public/tags/Twemproxy/index.html","hash":"b9cbfb03c8ff92836303ae132d4400ce073b9b73","modified":1464776505770},{"_id":"public/tags/JOOQ/index.html","hash":"fdb4d5a11f38cb266876676d9ea4c4b43ee04311","modified":1464776505770},{"_id":"public/tags/SQL/index.html","hash":"163183858d3bd75f16d6e120a3426d04ec544cb7","modified":1464776505770},{"_id":"public/tags/ARM/index.html","hash":"273a6620309af31e6332f229c2b74198117d866e","modified":1464776505770},{"_id":"public/tags/ORM/index.html","hash":"a059c686f3ac23f4fd7ccee311b577360e28b429","modified":1464776505770},{"_id":"public/tags/Transaction/index.html","hash":"00a1f4e802395511edb7bbdb3f1eac69524088c4","modified":1464776505770},{"_id":"public/tags/Nginx/index.html","hash":"8368aa6c483e95363d1bcc6e9a22c246ffb2913d","modified":1464776505770},{"_id":"public/tags/Alpine/index.html","hash":"4c01d9ebbed858e7d8ccb043b8d566c6ff21b790","modified":1464776505770},{"_id":"public/tags/Docker/index.html","hash":"cdcd67d3c5c5dcbbb3180509e911f54f5c558cb7","modified":1464776505770},{"_id":"public/tags/Centos/index.html","hash":"179a730d5c5cb50307c5804773aa48ef04d4d5bc","modified":1464776505770},{"_id":"public/tags/Patch/index.html","hash":"1506e8b8a51413a375ecb9b23cf7d5227e01560e","modified":1464776505770},{"_id":"public/tags/Keepalived/index.html","hash":"d05ad33ae91987bedf1ee6f6c44cdde22644aee8","modified":1464776505770},{"_id":"public/tags/MicroKernel/index.html","hash":"8cbf0d3e57fff14ec9ea287309f47ce4d87081cb","modified":1464776505770},{"_id":"public/tags/Failover/index.html","hash":"6332b8444737a732ebdb487e1a96772948a453e4","modified":1464776505770},{"_id":"public/tags/Tomcat/index.html","hash":"2bb5c93832164c6edd12d8fa70c26da6a8758505","modified":1464776505771},{"_id":"public/tags/SSL/index.html","hash":"da0b5ab3f46f2ada2a57edef1646b1f43ec5762c","modified":1464776505771},{"_id":"public/tags/Load-balance/index.html","hash":"8d16a0ae4f37f06f61cf4e4773a073c2fd5ed0b9","modified":1464776505771},{"_id":"public/tags/MessageSystem/index.html","hash":"635d0a71d7819b8c9c37558d1b75b2018bf5333a","modified":1464776505771},{"_id":"public/tags/architecture/index.html","hash":"b6768ae6fda6324af356efaa040aca672970b1b3","modified":1464776505771},{"_id":"public/tags/Experience/index.html","hash":"5f3938a7ca853a3a0c142ff8bdb6396a67cf7393","modified":1464776505771},{"_id":"public/tags/Refactor/index.html","hash":"4b9c91dfbde16abc4e5d1d5d90bb8fe6979541cb","modified":1464776505771},{"_id":"public/tags/Tech/index.html","hash":"afe480f07532f56b8ca182316c2b6a4437af5e72","modified":1464776505772},{"_id":"public/tags/Elegant/index.html","hash":"01d7328f275871e4ba92ddbd3641a4547b4ee638","modified":1464776505772},{"_id":"public/tags/Distributed/index.html","hash":"0340dd4c838c8832b451703d23626ade0534170a","modified":1464776505772},{"_id":"public/tags/Architecture/index.html","hash":"2a8a1ba610fdada2b34f0b5a3375f58c88c81247","modified":1464776505772},{"_id":"public/tags/Specification/index.html","hash":"a13c33b6878d139f5badb49e33b9d9f4777da046","modified":1464776505772},{"_id":"public/tags/Spring/index.html","hash":"27da3e976059ff45774d28c56bcaeb527dd52687","modified":1464776505772},{"_id":"public/tags/MVCC/index.html","hash":"421841a69ec7b049cba44025257d9c8aa1862588","modified":1464776505772},{"_id":"public/tags/WAL/index.html","hash":"7682e75cc43f5a41d3ae2e8eeafafbb646972ea0","modified":1464776505772},{"_id":"public/tags/RedoLog/index.html","hash":"770bade2ace73dbeba9bb914ea4a07eb8752edaf","modified":1464776505772},{"_id":"public/tags/RelayLog/index.html","hash":"e91f49880b34de9835a0928412a8623c4b420b41","modified":1464776505772},{"_id":"public/README.md","hash":"92e2452cef1013621156f38bfeb8b708d8ea3789","modified":1464776505829},{"_id":"public/googlec93373d7ad2555cc.html","hash":"b3bab842fde1d080655eccf559915b23944e68d2","modified":1464776505829},{"_id":"public/file/成亮_技术经理_简历.doc","hash":"373fcf751602e0b9884743687096d558f5e6f386","modified":1464776505829},{"_id":"public/img/NodeJS安装完成.png","hash":"1f630613e2f0b5223717df4e2985cc565a743649","modified":1464776505829},{"_id":"public/img/building-blocks.jpg","hash":"e0d7a68f5ee4c46b323f78c91f24b4f1b506176c","modified":1464776505829},{"_id":"public/img/github目录.png","hash":"4561e6ea5be731ad908566b7d12f41c6390ced8d","modified":1464776505829},{"_id":"public/img/hexo安装目录.png","hash":"886a417f75050c6c55185d569b18086dc443b5cf","modified":1464776505830},{"_id":"public/img/jacman主题安装目录.png","hash":"2b4e79309f308e0425a42cb14c0e1dd37df3e3c2","modified":1464776505830},{"_id":"public/img/npm配置信息.png","hash":"23415dacd781f9352099a4d12bb81523131cb4d7","modified":1464776505830},{"_id":"public/img/jooq-flyway.png","hash":"4961ef4e24db50b592e41dd5313dbc60dc51c701","modified":1464776505830},{"_id":"public/img/photos在redis的数据结构示例.png","hash":"08c30f9331a911384fea743397877fed7d69a8c8","modified":1464776505830},{"_id":"public/img/代码段.png","hash":"d2ddd6f72646d061518e4920dcba9290cc116f2c","modified":1464776505830},{"_id":"public/img/计算机软硬件配置.png","hash":"ebeb7c730c73eee2939170e49ba2413cb7cadcaf","modified":1464776505830},{"_id":"public/images/avatar.gif","hash":"264082bb3a1af70d5499c7d22b0902cb454b6d12","modified":1464776505830},{"_id":"public/images/avatar.png","hash":"2f5ca45b01b705cfde874a644ea9b4a635ccd6c0","modified":1464776505830},{"_id":"public/images/background-backup.jpg","hash":"5b961c607cc66ce1bf8b0c82399c7505e82f995e","modified":1464776505830},{"_id":"public/images/cc-by-nc-nd.svg","hash":"bc3588c9b2d7c68830524783120ff6cf957cf668","modified":1464776505830},{"_id":"public/images/cc-by-nc-sa.svg","hash":"6f55543d1fb9cbc436c101d24f802dec7b41efc3","modified":1464776505830},{"_id":"public/images/cc-by-nc.svg","hash":"6f076713fb9bf934aa2c1046bdf2cf2e37bc1eab","modified":1464776505830},{"_id":"public/images/cc-by-nd.svg","hash":"42cd73da328077ccc92f859bb8f3cf621b3484f8","modified":1464776505830},{"_id":"public/images/cc-by-sa.svg","hash":"70c1535f43e54e5ff35ca81419e77e4c0c301398","modified":1464776505830},{"_id":"public/images/cc-by.svg","hash":"e92a33c32d1dac8ed94849b2b4e6456e887efe70","modified":1464776505830},{"_id":"public/images/cc-zero.svg","hash":"9bfb52b2f63527a7049247bf00d44e6dc1170e7d","modified":1464776505830},{"_id":"public/images/favicon.ico","hash":"48d909a3f0cda656828bbf390962dc8259bcd037","modified":1464776505830},{"_id":"public/images/loading.gif","hash":"5fbd472222feb8a22cf5b8aa5dc5b8e13af88e2b","modified":1464776505831},{"_id":"public/images/placeholder.gif","hash":"5fbd472222feb8a22cf5b8aa5dc5b8e13af88e2b","modified":1464776505831},{"_id":"public/images/quote-l.svg","hash":"cd108d6f44351cadf8e6742565217f88818a0458","modified":1464776505831},{"_id":"public/images/quote-r.svg","hash":"2a2a250b32a87c69dcc1b1976c74b747bedbfb41","modified":1464776505831},{"_id":"public/images/searchicon.png","hash":"67727a6a969be0b2659b908518fa6706eed307b8","modified":1464776505831},{"_id":"public/vendors/fastclick/LICENSE","hash":"6f474ea75c42442da7bbcf2e9143ce98258efd8d","modified":1464776505831},{"_id":"public/vendors/font-awesome/HELP-US-OUT.txt","hash":"ed80b43dbc7e3009b2f436741b9796df8eb3be02","modified":1464776505831},{"_id":"public/vendors/fancybox/source/blank.gif","hash":"2daeaa8b5f19f0bc209d976c02bd6acb51b00b0a","modified":1464776505831},{"_id":"public/vendors/fancybox/source/fancybox_loading.gif","hash":"1a755fb2599f3a313cc6cfdb14df043f8c14a99c","modified":1464776505831},{"_id":"public/vendors/fancybox/source/fancybox_loading@2x.gif","hash":"273b123496a42ba45c3416adb027cd99745058b0","modified":1464776505831},{"_id":"public/vendors/fancybox/source/fancybox_sprite.png","hash":"17df19f97628e77be09c352bf27425faea248251","modified":1464776505831},{"_id":"public/vendors/fancybox/source/fancybox_overlay.png","hash":"b3a4ee645ba494f52840ef8412015ba0f465dbe0","modified":1464776505831},{"_id":"public/vendors/fancybox/source/fancybox_sprite@2x.png","hash":"30c58913f327e28f466a00f4c1ac8001b560aed8","modified":1464776505831},{"_id":"public/vendors/font-awesome/css/font-awesome.css.map","hash":"1573904b82807abbb32c97a3632c6c6808eaac50","modified":1464776505831},{"_id":"public/vendors/font-awesome/fonts/fontawesome-webfont.woff2","hash":"574ea2698c03ae9477db2ea3baf460ee32f1a7ea","modified":1464776505831},{"_id":"public/vendors/fancybox/source/helpers/fancybox_buttons.png","hash":"e385b139516c6813dcd64b8fc431c364ceafe5f3","modified":1464776505831},{"_id":"public/file/成亮_技术经理_简历.pdf","hash":"bec1b5a608be57553b85d53519098069bf78b2d0","modified":1464776506329},{"_id":"public/img/thinking.jpg","hash":"fb0a14ff1c330bbdf6caaae6167730d046b9c681","modified":1464776506330},{"_id":"public/img/MircoService.png","hash":"15fa4f15a02970b3f2954d0fabeefcaf91fa5dbb","modified":1464776506335},{"_id":"public/rewards/wechat-reward-image.png","hash":"63bccd259ad1a2cc0c90a9e66a9f386aedadd8e8","modified":1464776506335},{"_id":"public/vendors/font-awesome/fonts/FontAwesome.otf","hash":"0112e96f327d413938d37c1693806f468ffdbace","modified":1464776506335},{"_id":"public/vendors/font-awesome/fonts/fontawesome-webfont.eot","hash":"b3c2f08e73320135b69c23a3908b87a12053a2f6","modified":1464776506335},{"_id":"public/vendors/font-awesome/fonts/fontawesome-webfont.woff","hash":"507970402e328b2baeb05bde73bf9ded4e2c3a2d","modified":1464776506335},{"_id":"public/404.html","hash":"179044808f272d4486453e93a9cb08a05b0c88c7","modified":1464776506346},{"_id":"public/js/src/hook-duoshuo.js","hash":"d5897638b09e0201d45266e158ae32ad8f0776f8","modified":1464776506346},{"_id":"public/js/src/motion.js","hash":"269414e84df544a4ccb88519f6abae4943db3c67","modified":1464776506346},{"_id":"public/js/src/post-details.js","hash":"2038f54e289b6da5def09689e69f623187147be5","modified":1464776506347},{"_id":"public/js/src/scrollspy.js","hash":"fe4da1b9fe73518226446f5f27d2831e4426fc35","modified":1464776506347},{"_id":"public/js/src/utils.js","hash":"e5cb720894c4bc28ca8f10b33df127fb394018d9","modified":1464776506347},{"_id":"public/js/src/bootstrap.js","hash":"39bf93769d9080fa01a9a875183b43198f79bc19","modified":1464776506347},{"_id":"public/js/src/affix.js","hash":"978e0422b5bf1b560236d8d10ebc1adcf66392e3","modified":1464776506347},{"_id":"public/vendors/fastclick/README.html","hash":"da3c74d484c73cc7df565e8abbfa4d6a5a18d4da","modified":1464776506347},{"_id":"public/vendors/fastclick/bower.json","hash":"4dcecf83afddba148464d5339c93f6d0aa9f42e9","modified":1464776506347},{"_id":"public/vendors/font-awesome/bower.json","hash":"64394a2a9aa00f8e321d8daa5e51a420f0e96dad","modified":1464776506347},{"_id":"public/vendors/jquery_lazyload/README.html","hash":"bde24335f6bc09d8801c0dcd7274f71b466552bd","modified":1464776506348},{"_id":"public/vendors/jquery_lazyload/CONTRIBUTING.html","hash":"a6358170d346af13b1452ac157b60505bec7015c","modified":1464776506348},{"_id":"public/vendors/jquery_lazyload/bower.json","hash":"ae3c3b61e6e7f9e1d7e3585ad854380ecc04cf53","modified":1464776506348},{"_id":"public/vendors/jquery_lazyload/jquery.scrollstop.js","hash":"0e9a81785a011c98be5ea821a8ed7d411818cfd1","modified":1464776506348},{"_id":"public/vendors/jquery_lazyload/jquery.lazyload.js","hash":"481fd478650e12b67c201a0ea41e92743f8b45a3","modified":1464776506350},{"_id":"public/vendors/velocity/bower.json","hash":"0ef14e7ccdfba5db6eb3f8fc6aa3b47282c36409","modified":1464776506350},{"_id":"public/vendors/velocity/velocity.ui.min.js","hash":"ed5e534cd680a25d8d14429af824f38a2c7d9908","modified":1464776506350},{"_id":"public/js/src/schemes/pisces.js","hash":"7506e7490c69a200831393c38d25e91c156bd471","modified":1464776506350},{"_id":"public/vendors/fancybox/source/jquery.fancybox.css","hash":"5f163444617b6cf267342f06ac166a237bb62df9","modified":1464776506350},{"_id":"public/vendors/fastclick/lib/fastclick.min.js","hash":"2cae0f5a6c5d6f3cb993015e6863f9483fc4de18","modified":1464776506350},{"_id":"public/vendors/ua-parser-js/dist/ua-parser.pack.js","hash":"214dad442a92d36af77ed0ca1d9092b16687f02f","modified":1464776506350},{"_id":"public/vendors/ua-parser-js/dist/ua-parser.min.js","hash":"38628e75e4412cc6f11074e03e1c6d257aae495b","modified":1464776506350},{"_id":"public/vendors/fancybox/source/helpers/jquery.fancybox-buttons.css","hash":"1a9d8e5c22b371fcc69d4dbbb823d9c39f04c0c8","modified":1464776506350},{"_id":"public/vendors/fancybox/source/helpers/jquery.fancybox-buttons.js","hash":"91e41741c2e93f732c82aaacec4cfc6e3f3ec876","modified":1464776506350},{"_id":"public/vendors/fancybox/source/helpers/jquery.fancybox-thumbs.css","hash":"4ac329c16a5277592fc12a37cca3d72ca4ec292f","modified":1464776506350},{"_id":"public/vendors/fancybox/source/helpers/jquery.fancybox-thumbs.js","hash":"53e194f4a72e649c04fb586dd57762b8c022800b","modified":1464776506350},{"_id":"public/vendors/fancybox/source/helpers/jquery.fancybox-media.js","hash":"3bdf69ed2469e4fb57f5a95f17300eef891ff90d","modified":1464776506350},{"_id":"public/css/main.css","hash":"e3b5732015077c70c1f3ec041b39bff6cfdddde5","modified":1464776506350},{"_id":"public/vendors/velocity/velocity.ui.js","hash":"6a1d101eab3de87527bb54fcc8c7b36b79d8f0df","modified":1464776506350},{"_id":"public/vendors/velocity/velocity.min.js","hash":"2f1afadc12e4cf59ef3b405308d21baa97e739c6","modified":1464776506350},{"_id":"public/vendors/jquery/index.js","hash":"41b4bfbaa96be6d1440db6e78004ade1c134e276","modified":1464776506351},{"_id":"public/vendors/fancybox/source/jquery.fancybox.pack.js","hash":"53360764b429c212f424399384417ccc233bb3be","modified":1464776506351},{"_id":"public/vendors/fancybox/source/jquery.fancybox.js","hash":"1cf3d47b5ccb7cb6e9019c64f2a88d03a64853e4","modified":1464776506351},{"_id":"public/vendors/fastclick/lib/fastclick.js","hash":"06cef196733a710e77ad7e386ced6963f092dc55","modified":1464776506351},{"_id":"public/vendors/font-awesome/css/font-awesome.css","hash":"3b87c2560832748cd06f9bfd2fd6ea8edbdae8c7","modified":1464776506351},{"_id":"public/vendors/font-awesome/css/font-awesome.min.css","hash":"05ea25bc9b3ac48993e1fee322d3bc94b49a6e22","modified":1464776506351},{"_id":"public/vendors/velocity/velocity.js","hash":"9f08181baea0cc0e906703b7e5df9111b9ef3373","modified":1464776506351},{"_id":"public/vendors/font-awesome/fonts/fontawesome-webfont.ttf","hash":"27cf1f2ec59aece6938c7bb2feb0e287ea778ff9","modified":1464776506351},{"_id":"public/images/background.jpg","hash":"825cb04466d213ea3604eac51f95a42731998476","modified":1464776506368},{"_id":"public/img/chaos.jpg","hash":"50ad9e9101113f3516556cd62311d047be2bf537","modified":1464776506372},{"_id":"public/vendors/font-awesome/fonts/fontawesome-webfont.svg","hash":"f346b8b3df147e4059e1a7d66c52c9a6e1cec3e8","modified":1464776506372}],"Category":[{"name":"Tutorial","_id":"ciowq3yu700054cnnallqp4go"},{"name":"Record","_id":"ciowq3yue000a4cnn1h63o2y7"},{"name":"Learning","_id":"ciowq3yun000f4cnnozm8cr4m"},{"name":"Summary","_id":"ciowq3yv3000w4cnnmezx3cqh"}],"Data":[],"Page":[{"date":"2016-05-25T05:55:01.592Z","comments":0,"_content":"\n# 联系方式\n\n- Email：<stevenchengmask@gmail.com>\n\n---\n\n# 个人信息\n\n - 成亮\n\n - 1991 / 5年经验\n\n - 热爱移动互联网，推崇开源技术，提倡在团队分享中提高。\n\n---\n\n更多信息请阅读我的简历：[http://amao12580.deercv.com](http://amao12580.deercv.com)，期待与您的共事！\n","source":"about/index.md","raw":"---\n#title: '关于博主.'\ndate: 2016年3月21日16:59:51\ncomments: false   #去除多说评论框\n\n---\n\n# 联系方式\n\n- Email：<stevenchengmask@gmail.com>\n\n---\n\n# 个人信息\n\n - 成亮\n\n - 1991 / 5年经验\n\n - 热爱移动互联网，推崇开源技术，提倡在团队分享中提高。\n\n---\n\n更多信息请阅读我的简历：[http://amao12580.deercv.com](http://amao12580.deercv.com)，期待与您的共事！\n","updated":"2016-05-25T05:55:01.592Z","path":"about/index.html","title":"","layout":"page","_id":"ciowq3yty00014cnnoe3vc59d","content":"<h1 id=\"联系方式\"><a href=\"#联系方式\" class=\"headerlink\" title=\"联系方式\"></a>联系方式</h1><ul>\n<li>Email：<a href=\"&#x6d;&#x61;&#105;&#108;&#x74;&#x6f;&#58;&#115;&#116;&#101;&#x76;&#x65;&#110;&#x63;&#x68;&#101;&#110;&#103;&#x6d;&#x61;&#115;&#107;&#64;&#x67;&#109;&#97;&#105;&#x6c;&#x2e;&#x63;&#x6f;&#109;\">&#115;&#116;&#101;&#x76;&#x65;&#110;&#x63;&#x68;&#101;&#110;&#103;&#x6d;&#x61;&#115;&#107;&#64;&#x67;&#109;&#97;&#105;&#x6c;&#x2e;&#x63;&#x6f;&#109;</a></li>\n</ul>\n<hr>\n<h1 id=\"个人信息\"><a href=\"#个人信息\" class=\"headerlink\" title=\"个人信息\"></a>个人信息</h1><ul>\n<li><p>成亮</p>\n</li>\n<li><p>1991 / 5年经验</p>\n</li>\n<li><p>热爱移动互联网，推崇开源技术，提倡在团队分享中提高。</p>\n</li>\n</ul>\n<hr>\n<p>更多信息请阅读我的简历：<a href=\"http://amao12580.deercv.com\" target=\"_blank\" rel=\"external\">http://amao12580.deercv.com</a>，期待与您的共事！</p>\n","excerpt":"","more":"<h1 id=\"联系方式\"><a href=\"#联系方式\" class=\"headerlink\" title=\"联系方式\"></a>联系方式</h1><ul>\n<li>Email：<a href=\"&#x6d;&#x61;&#105;&#108;&#x74;&#x6f;&#58;&#115;&#116;&#101;&#x76;&#x65;&#110;&#x63;&#x68;&#101;&#110;&#103;&#x6d;&#x61;&#115;&#107;&#64;&#x67;&#109;&#97;&#105;&#x6c;&#x2e;&#x63;&#x6f;&#109;\">&#115;&#116;&#101;&#x76;&#x65;&#110;&#x63;&#x68;&#101;&#110;&#103;&#x6d;&#x61;&#115;&#107;&#64;&#x67;&#109;&#97;&#105;&#x6c;&#x2e;&#x63;&#x6f;&#109;</a></li>\n</ul>\n<hr>\n<h1 id=\"个人信息\"><a href=\"#个人信息\" class=\"headerlink\" title=\"个人信息\"></a>个人信息</h1><ul>\n<li><p>成亮</p>\n</li>\n<li><p>1991 / 5年经验</p>\n</li>\n<li><p>热爱移动互联网，推崇开源技术，提倡在团队分享中提高。</p>\n</li>\n</ul>\n<hr>\n<p>更多信息请阅读我的简历：<a href=\"http://amao12580.deercv.com\">http://amao12580.deercv.com</a>，期待与您的共事！</p>\n"},{"title":"categories","date":"2016-05-16T02:19:40.000Z","type":"categories","comments":0,"_content":"","source":"categories/index.md","raw":"---\ntitle: categories\ndate: 2016-05-16 10:19:40\ntype: \"categories\"\ncomments: false   #去除多说评论框\n\n---\n","updated":"2016-05-16T02:23:12.793Z","path":"categories/index.html","layout":"page","_id":"ciowq3yu300034cnn8p4k8269","content":"","excerpt":"","more":""},{"title":"tags","date":"2016-05-16T02:17:58.000Z","type":"tags","comments":0,"_content":"","source":"tags/index.md","raw":"---\ntitle: tags\ndate: 2016-05-16 10:17:58\ntype: \"tags\"\ncomments: false   #ȥ����˵���ۿ�\n\n---","updated":"2016-05-17T07:42:01.384Z","path":"tags/index.html","layout":"page","_id":"ciowq3yzq003i4cnneoyv15j9","content":"","excerpt":"","more":""},{"title":"个人常用资源汇总","date":"2016-05-17T07:41:54.280Z","comments":0,"_content":"## 软件\n\n### Docker\n\n#### 安装\n1.Follow：[https://segmentfault.com/a/1190000002485231](https://segmentfault.com/a/1190000002485231)\n\n```\nubuntu下，用以下这种脚本方式安装最方便，来源于sameersbn/docker-gitlab官方说明：\n\nsudo apt-get purge docker.io\ncurl -s https://get.docker.io/ubuntu/ | sudo sh\nsudo apt-get update\nsudo apt-get install lxc-docker --fix-missing\n\n### Docker Compose\n\nCompose 项目目前在[ Github ](https://github.com/docker/compose)上进行维护，目前最新版本是 1.2.0。\n\nCompose 定位是“defining and running complex applications with Docker”，前身是[ Fig](http://www.infoq.com/cn/articles/docker-build-development-environment-based-on-fig)，兼容 Fig 的模板文件。\nDockerfile 可以让用户管理一个单独的应用容器；而 Compose 则允许用户在一个模板（YAML 格式）中定义一组相关联的应用容器（被称为一个 project，即项目），例如一个 Web 服务容器再加上后端的数据库服务容器等。\n\n该项目由 Python 编写，实际上调用了 Docker 提供的 API 来实现。\n\n```\n\n## 学习资源\n\n### SQL查询优化总结\n\n1、应尽量避免在 where 子句中使用!=或<>操作符，否则将引擎放弃使用索引而进行全表扫描。\n\n2、对查询进行优化，应尽量避免全表扫描，首先应考虑在 where 及 order by 涉及的列上建立索引。\n\n3、应尽量避免在 where 子句中对字段进行 null 值判断，否则将导致引擎放弃使用索引而进行全表扫描，如：\n\nselect id from t where num is null\n可以在num上设置默认值0，确保表中num列没有null值，然后这样查询：\n\nselect id from t where num=0\n4、尽量避免在 where 子句中使用 or 来连接条件，否则将导致引擎放弃使用索引而进行全表扫描，如：\n\nselect id from t where num=10 or num=20\n可以这样查询：\n\nselect id from t where num=10\nunion all\nselect id from t where num=20\n5、下面的查询也将导致全表扫描：(不能前置百分号)\n\nselect id from t where name like ‘%abc%’\n若要提高效率，可以考虑全文检索。\n\n6、in 和 not in 也要慎用，否则会导致全表扫描，如：\n\nselect id from t where num in(1,2,3)\n对于连续的数值，能用 between 就不要用 in 了：\n\nselect id from t where num between 1 and 3\n7、如果在 where 子句中使用参数，也会导致全表扫描。因为SQL只有在运行时才会解析局部变量，但优化程序不能将访问计划的选择推迟到运行时；它必须在编译时进行选择。然 而，如果在编译时建立访问计划，变量的值还是未知的，因而无法作为索引选择的输入项。如下面语句将进行全表扫描：\n\nselect id from t where num=@num\n可以改为强制查询使用索引：\n\nselect id from t with(index(索引名)) where num=@num\n8、应尽量避免在 where 子句中对字段进行表达式操作，这将导致引擎放弃使用索引而进行全表扫描。如：\n\nselect id from t where num/2=100\n应改为:\n\nselect id from t where num=100*2\n9、应尽量避免在where子句中对字段进行函数操作，这将导致引擎放弃使用索引而进行全表扫描。如：\n\nselect id from t where substring(name,1,3)=’abc’–name以abc开头的id\nselect id from t where datediff(day,createdate,’2005-11-30′)=0–’2005-11-30′生成的id\n应改为:\n\nselect id from t where name like ‘abc%’\nselect id from t where createdate>=’2005-11-30′ and createdate<’2005-12-1′\n10、不要在 where 子句中的“=”左边进行函数、算术运算或其他表达式运算，否则系统将可能无法正确使用索引。\n\n11、在使用索引字段作为条件时，如果该索引是复合索引，那么必须使用到该索引中的第一个字段作为条件时才能保证系统使用该索引，否则该索引将不会被使 用，并且应尽可能的让字段顺序与索引顺序相一致。\n\n12、不要写一些没有意义的查询，如需要生成一个空表结构：\n\nselect col1,col2 into #t from t where 1=0\n这类代码不会返回任何结果集，但是会消耗系统资源的，应改成这样：\n\ncreate table #t(…)\n13、很多时候用 exists 代替 in 是一个好的选择：\n\nselect num from a where num in(select num from b)\n用下面的语句替换：\n\nselect num from a where exists(select 1 from b where num=a.num)\n14、并不是所有索引对查询都有效，SQL是根据表中数据来进行查询优化的，当索引列有大量数据重复时，SQL查询可能不会去利用索引，如一表中有字段 sex，male、female几乎各一半，那么即使在sex上建了索引也对查询效率起不了作用。\n\n15、索引并不是越多越好，索引固然可以提高相应的 select 的效率，但同时也降低了 insert 及 update 的效率，因为 insert 或 update 时有可能会重建索引，所以怎样建索引需要慎重考虑，视具体情况而定。一个表的索引数最好不要超过6个，若太多则应考虑一些不常使用到的列上建的索引是否有 必要。\n\n16.应尽可能的避免更新 clustered 索引数据列，因为 clustered 索引数据列的顺序就是表记录的物理存储顺序，一旦该列值改变将导致整个表记录的顺序的调整，会耗费相当大的资源。若应用系统需要频繁更新 clustered 索引数据列，那么需要考虑是否应将该索引建为 clustered 索引。\n\n17、尽量使用数字型字段，若只含数值信息的字段尽量不要设计为字符型，这会降低查询和连接的性能，并会增加存储开销。这是因为引擎在处理查询和连接时会 逐个比较字符串中每一个字符，而对于数字型而言只需要比较一次就够了。\n\n18、尽可能的使用 varchar/nvarchar 代替 char/nchar ，因为首先变长字段存储空间小，可以节省存储空间，其次对于查询来说，在一个相对较小的字段内搜索效率显然要高些。\n\n19、任何地方都不要使用 select * from t ，用具体的字段列表代替“*”，不要返回用不到的任何字段。\n\n20、尽量使用表变量来代替临时表。如果表变量包含大量数据，请注意索引非常有限（只有主键索引）。\n\n21、避免频繁创建和删除临时表，以减少系统表资源的消耗。\n\n22、临时表并不是不可使用，适当地使用它们可以使某些例程更有效，例如，当需要重复引用大型表或常用表中的某个数据集时。但是，对于一次性事件，最好使 用导出表。\n\n23、在新建临时表时，如果一次性插入数据量很大，那么可以使用 select into 代替 create table，避免造成大量 log ，以提高速度；如果数据量不大，为了缓和系统表的资源，应先create table，然后insert。\n\n24、如果使用到了临时表，在存储过程的最后务必将所有的临时表显式删除，先 truncate table ，然后 drop table ，这样可以避免系统表的较长时间锁定。\n\n25、尽量避免使用游标，因为游标的效率较差，如果游标操作的数据超过1万行，那么就应该考虑改写。\n\n26、使用基于游标的方法或临时表方法之前，应先寻找基于集的解决方案来解决问题，基于集的方法通常更有效。\n\n27、与临时表一样，游标并不是不可使用。对小型数据集使用 FAST_FORWARD 游标通常要优于其他逐行处理方法，尤其是在必须引用几个表才能获得所需的数据时。在结果集中包括“合计”的例程通常要比使用游标执行的速度快。如果开发时 间允许，基于游标的方法和基于集的方法都可以尝试一下，看哪一种方法的效果更好。\n\n28、在所有的存储过程和触发器的开始处设置 SET NOCOUNT ON ，在结束时设置 SET NOCOUNT OFF 。无需在执行存储过程和触发器的每个语句后向客户端发送 DONE_IN_PROC 消息。\n\n29、尽量避免向客户端返回大数据量，若数据量过大，应该考虑相应需求是否合理。\n\n30、尽量避免大事务操作，提高系统并发能力。\n\n```\n实战：验证以上总结。以下SQL段，可以直接放到Navicat中批量执行\n\n//已知在order表，int类型字段uid上，已存在normal类型的索引\n\nCREATE TABLE `order` (\n  `order_id` int(11) NOT NULL AUTO_INCREMENT COMMENT '订单编号',\n  `uid` int(11) DEFAULT NULL COMMENT '用户Id',\n  `amout` bigint(20) NOT NULL COMMENT '订单金额(单位为分)',\n  `remark` varchar(50) DEFAULT '' COMMENT '订单备注',\n  `status` tinyint(2) DEFAULT NULL COMMENT '订单状态',\n  `order_time` datetime DEFAULT NULL COMMENT '订单时间',\n  PRIMARY KEY (`order_id`),\n  KEY `order_uid_normal_index` (`uid`)\n) ENGINE=InnoDB AUTO_INCREMENT=240 DEFAULT CHARSET=utf8;\n\nEXPLAIN select order_id,uid,order_time from `order` where uid=185147;\n\nEXPLAIN select order_id,uid,order_time from `order` where uid !=185147;//不能使用索引\n\nEXPLAIN select order_id,uid,order_time from `order` where uid >185147;\n\nEXPLAIN select order_id,uid,order_time from `order` where uid <185147;\n\nEXPLAIN select order_id,uid,order_time from `order` where uid >175147 and uid <185147;\n\nEXPLAIN select order_id,uid,order_time from `order` where uid <>175147;//不等于符号导致，不能使用索引\n\nEXPLAIN select order_id,uid,order_time from `order` where uid in(185147,185148,185149);//in操作符，不能使用索引\n\nEXPLAIN select order_id,uid,order_time from `order` where uid not in(185147,185148,185149);//not in操作符，不能使用索引\n\nEXPLAIN select order_id,uid,order_time from `order` where uid between 185147 and 185149;\n\nEXPLAIN select order_id,uid,order_time from `order` where uid=185147 or uid=5147;//or操作符导致，不能使用索引\n\nEXPLAIN select order_id,uid,order_time from `order` where uid=185147 UNION all select * from `order` where uid=185148;\n\nEXPLAIN select order_id,uid,order_time from `order` where uid like \"%185%\";//左%通配符，不能使用索引\n\nEXPLAIN select order_id,uid,order_time from `order` where uid like \"185%\";//类型转换，不能使用索引。如果int是varchar类型则可以使用索引。\n\nEXPLAIN select order_id,uid,order_time from `order` where uid like \"%185\";//左%通配符，不能使用索引\n\nEXPLAIN select order_id,uid,order_time from `order` where uid like \"185\";//类型转换，不能使用索引\n\nEXPLAIN select order_id,uid,order_time from `order` where uid/2=100 ;//谓词字段进行算术操作，不能使用索引\n\nEXPLAIN select order_id,uid,order_time from `order` where substring(uid,1,3)=\"abc\";//谓词字段进行函数操作，不能使用索引\n\nEXPLAIN select DISTINCT uid from `order`;\n\nEXPLAIN select max(uid) from `order`;//返回字段进行函数操作，不能使用索引\n\n```\n\n## Referrence\n\n* [美团点评技术团队：MySQL索引原理及慢查询优化](http://tech.meituan.com/mysql-index.html)\n\n* [Docker —— 从入门到实践](https://yeasy.gitbooks.io/docker_practice/content/compose/intro.html)","source":"index/index.md","raw":"---\ntitle: '个人常用资源汇总'\ndate: 2016年3月31日13:01:55\ncomments: false   #去除多说评论框\n\n---\n## 软件\n\n### Docker\n\n#### 安装\n1.Follow：[https://segmentfault.com/a/1190000002485231](https://segmentfault.com/a/1190000002485231)\n\n```\nubuntu下，用以下这种脚本方式安装最方便，来源于sameersbn/docker-gitlab官方说明：\n\nsudo apt-get purge docker.io\ncurl -s https://get.docker.io/ubuntu/ | sudo sh\nsudo apt-get update\nsudo apt-get install lxc-docker --fix-missing\n\n### Docker Compose\n\nCompose 项目目前在[ Github ](https://github.com/docker/compose)上进行维护，目前最新版本是 1.2.0。\n\nCompose 定位是“defining and running complex applications with Docker”，前身是[ Fig](http://www.infoq.com/cn/articles/docker-build-development-environment-based-on-fig)，兼容 Fig 的模板文件。\nDockerfile 可以让用户管理一个单独的应用容器；而 Compose 则允许用户在一个模板（YAML 格式）中定义一组相关联的应用容器（被称为一个 project，即项目），例如一个 Web 服务容器再加上后端的数据库服务容器等。\n\n该项目由 Python 编写，实际上调用了 Docker 提供的 API 来实现。\n\n```\n\n## 学习资源\n\n### SQL查询优化总结\n\n1、应尽量避免在 where 子句中使用!=或<>操作符，否则将引擎放弃使用索引而进行全表扫描。\n\n2、对查询进行优化，应尽量避免全表扫描，首先应考虑在 where 及 order by 涉及的列上建立索引。\n\n3、应尽量避免在 where 子句中对字段进行 null 值判断，否则将导致引擎放弃使用索引而进行全表扫描，如：\n\nselect id from t where num is null\n可以在num上设置默认值0，确保表中num列没有null值，然后这样查询：\n\nselect id from t where num=0\n4、尽量避免在 where 子句中使用 or 来连接条件，否则将导致引擎放弃使用索引而进行全表扫描，如：\n\nselect id from t where num=10 or num=20\n可以这样查询：\n\nselect id from t where num=10\nunion all\nselect id from t where num=20\n5、下面的查询也将导致全表扫描：(不能前置百分号)\n\nselect id from t where name like ‘%abc%’\n若要提高效率，可以考虑全文检索。\n\n6、in 和 not in 也要慎用，否则会导致全表扫描，如：\n\nselect id from t where num in(1,2,3)\n对于连续的数值，能用 between 就不要用 in 了：\n\nselect id from t where num between 1 and 3\n7、如果在 where 子句中使用参数，也会导致全表扫描。因为SQL只有在运行时才会解析局部变量，但优化程序不能将访问计划的选择推迟到运行时；它必须在编译时进行选择。然 而，如果在编译时建立访问计划，变量的值还是未知的，因而无法作为索引选择的输入项。如下面语句将进行全表扫描：\n\nselect id from t where num=@num\n可以改为强制查询使用索引：\n\nselect id from t with(index(索引名)) where num=@num\n8、应尽量避免在 where 子句中对字段进行表达式操作，这将导致引擎放弃使用索引而进行全表扫描。如：\n\nselect id from t where num/2=100\n应改为:\n\nselect id from t where num=100*2\n9、应尽量避免在where子句中对字段进行函数操作，这将导致引擎放弃使用索引而进行全表扫描。如：\n\nselect id from t where substring(name,1,3)=’abc’–name以abc开头的id\nselect id from t where datediff(day,createdate,’2005-11-30′)=0–’2005-11-30′生成的id\n应改为:\n\nselect id from t where name like ‘abc%’\nselect id from t where createdate>=’2005-11-30′ and createdate<’2005-12-1′\n10、不要在 where 子句中的“=”左边进行函数、算术运算或其他表达式运算，否则系统将可能无法正确使用索引。\n\n11、在使用索引字段作为条件时，如果该索引是复合索引，那么必须使用到该索引中的第一个字段作为条件时才能保证系统使用该索引，否则该索引将不会被使 用，并且应尽可能的让字段顺序与索引顺序相一致。\n\n12、不要写一些没有意义的查询，如需要生成一个空表结构：\n\nselect col1,col2 into #t from t where 1=0\n这类代码不会返回任何结果集，但是会消耗系统资源的，应改成这样：\n\ncreate table #t(…)\n13、很多时候用 exists 代替 in 是一个好的选择：\n\nselect num from a where num in(select num from b)\n用下面的语句替换：\n\nselect num from a where exists(select 1 from b where num=a.num)\n14、并不是所有索引对查询都有效，SQL是根据表中数据来进行查询优化的，当索引列有大量数据重复时，SQL查询可能不会去利用索引，如一表中有字段 sex，male、female几乎各一半，那么即使在sex上建了索引也对查询效率起不了作用。\n\n15、索引并不是越多越好，索引固然可以提高相应的 select 的效率，但同时也降低了 insert 及 update 的效率，因为 insert 或 update 时有可能会重建索引，所以怎样建索引需要慎重考虑，视具体情况而定。一个表的索引数最好不要超过6个，若太多则应考虑一些不常使用到的列上建的索引是否有 必要。\n\n16.应尽可能的避免更新 clustered 索引数据列，因为 clustered 索引数据列的顺序就是表记录的物理存储顺序，一旦该列值改变将导致整个表记录的顺序的调整，会耗费相当大的资源。若应用系统需要频繁更新 clustered 索引数据列，那么需要考虑是否应将该索引建为 clustered 索引。\n\n17、尽量使用数字型字段，若只含数值信息的字段尽量不要设计为字符型，这会降低查询和连接的性能，并会增加存储开销。这是因为引擎在处理查询和连接时会 逐个比较字符串中每一个字符，而对于数字型而言只需要比较一次就够了。\n\n18、尽可能的使用 varchar/nvarchar 代替 char/nchar ，因为首先变长字段存储空间小，可以节省存储空间，其次对于查询来说，在一个相对较小的字段内搜索效率显然要高些。\n\n19、任何地方都不要使用 select * from t ，用具体的字段列表代替“*”，不要返回用不到的任何字段。\n\n20、尽量使用表变量来代替临时表。如果表变量包含大量数据，请注意索引非常有限（只有主键索引）。\n\n21、避免频繁创建和删除临时表，以减少系统表资源的消耗。\n\n22、临时表并不是不可使用，适当地使用它们可以使某些例程更有效，例如，当需要重复引用大型表或常用表中的某个数据集时。但是，对于一次性事件，最好使 用导出表。\n\n23、在新建临时表时，如果一次性插入数据量很大，那么可以使用 select into 代替 create table，避免造成大量 log ，以提高速度；如果数据量不大，为了缓和系统表的资源，应先create table，然后insert。\n\n24、如果使用到了临时表，在存储过程的最后务必将所有的临时表显式删除，先 truncate table ，然后 drop table ，这样可以避免系统表的较长时间锁定。\n\n25、尽量避免使用游标，因为游标的效率较差，如果游标操作的数据超过1万行，那么就应该考虑改写。\n\n26、使用基于游标的方法或临时表方法之前，应先寻找基于集的解决方案来解决问题，基于集的方法通常更有效。\n\n27、与临时表一样，游标并不是不可使用。对小型数据集使用 FAST_FORWARD 游标通常要优于其他逐行处理方法，尤其是在必须引用几个表才能获得所需的数据时。在结果集中包括“合计”的例程通常要比使用游标执行的速度快。如果开发时 间允许，基于游标的方法和基于集的方法都可以尝试一下，看哪一种方法的效果更好。\n\n28、在所有的存储过程和触发器的开始处设置 SET NOCOUNT ON ，在结束时设置 SET NOCOUNT OFF 。无需在执行存储过程和触发器的每个语句后向客户端发送 DONE_IN_PROC 消息。\n\n29、尽量避免向客户端返回大数据量，若数据量过大，应该考虑相应需求是否合理。\n\n30、尽量避免大事务操作，提高系统并发能力。\n\n```\n实战：验证以上总结。以下SQL段，可以直接放到Navicat中批量执行\n\n//已知在order表，int类型字段uid上，已存在normal类型的索引\n\nCREATE TABLE `order` (\n  `order_id` int(11) NOT NULL AUTO_INCREMENT COMMENT '订单编号',\n  `uid` int(11) DEFAULT NULL COMMENT '用户Id',\n  `amout` bigint(20) NOT NULL COMMENT '订单金额(单位为分)',\n  `remark` varchar(50) DEFAULT '' COMMENT '订单备注',\n  `status` tinyint(2) DEFAULT NULL COMMENT '订单状态',\n  `order_time` datetime DEFAULT NULL COMMENT '订单时间',\n  PRIMARY KEY (`order_id`),\n  KEY `order_uid_normal_index` (`uid`)\n) ENGINE=InnoDB AUTO_INCREMENT=240 DEFAULT CHARSET=utf8;\n\nEXPLAIN select order_id,uid,order_time from `order` where uid=185147;\n\nEXPLAIN select order_id,uid,order_time from `order` where uid !=185147;//不能使用索引\n\nEXPLAIN select order_id,uid,order_time from `order` where uid >185147;\n\nEXPLAIN select order_id,uid,order_time from `order` where uid <185147;\n\nEXPLAIN select order_id,uid,order_time from `order` where uid >175147 and uid <185147;\n\nEXPLAIN select order_id,uid,order_time from `order` where uid <>175147;//不等于符号导致，不能使用索引\n\nEXPLAIN select order_id,uid,order_time from `order` where uid in(185147,185148,185149);//in操作符，不能使用索引\n\nEXPLAIN select order_id,uid,order_time from `order` where uid not in(185147,185148,185149);//not in操作符，不能使用索引\n\nEXPLAIN select order_id,uid,order_time from `order` where uid between 185147 and 185149;\n\nEXPLAIN select order_id,uid,order_time from `order` where uid=185147 or uid=5147;//or操作符导致，不能使用索引\n\nEXPLAIN select order_id,uid,order_time from `order` where uid=185147 UNION all select * from `order` where uid=185148;\n\nEXPLAIN select order_id,uid,order_time from `order` where uid like \"%185%\";//左%通配符，不能使用索引\n\nEXPLAIN select order_id,uid,order_time from `order` where uid like \"185%\";//类型转换，不能使用索引。如果int是varchar类型则可以使用索引。\n\nEXPLAIN select order_id,uid,order_time from `order` where uid like \"%185\";//左%通配符，不能使用索引\n\nEXPLAIN select order_id,uid,order_time from `order` where uid like \"185\";//类型转换，不能使用索引\n\nEXPLAIN select order_id,uid,order_time from `order` where uid/2=100 ;//谓词字段进行算术操作，不能使用索引\n\nEXPLAIN select order_id,uid,order_time from `order` where substring(uid,1,3)=\"abc\";//谓词字段进行函数操作，不能使用索引\n\nEXPLAIN select DISTINCT uid from `order`;\n\nEXPLAIN select max(uid) from `order`;//返回字段进行函数操作，不能使用索引\n\n```\n\n## Referrence\n\n* [美团点评技术团队：MySQL索引原理及慢查询优化](http://tech.meituan.com/mysql-index.html)\n\n* [Docker —— 从入门到实践](https://yeasy.gitbooks.io/docker_practice/content/compose/intro.html)","updated":"2016-05-17T07:41:54.280Z","path":"index/index.html","layout":"page","_id":"ciowq3yzs003j4cnnut57frpa","content":"<h2 id=\"软件\"><a href=\"#软件\" class=\"headerlink\" title=\"软件\"></a>软件</h2><h3 id=\"Docker\"><a href=\"#Docker\" class=\"headerlink\" title=\"Docker\"></a>Docker</h3><h4 id=\"安装\"><a href=\"#安装\" class=\"headerlink\" title=\"安装\"></a>安装</h4><p>1.Follow：<a href=\"https://segmentfault.com/a/1190000002485231\" target=\"_blank\" rel=\"external\">https://segmentfault.com/a/1190000002485231</a></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ubuntu下，用以下这种脚本方式安装最方便，来源于sameersbn/docker-gitlab官方说明：</span><br><span class=\"line\"></span><br><span class=\"line\">sudo apt-get purge docker.io</span><br><span class=\"line\">curl -s https://get.docker.io/ubuntu/ | sudo sh</span><br><span class=\"line\">sudo apt-get update</span><br><span class=\"line\">sudo apt-get install lxc-docker --fix-missing</span><br><span class=\"line\"></span><br><span class=\"line\">### Docker Compose</span><br><span class=\"line\"></span><br><span class=\"line\">Compose 项目目前在[ Github ](https://github.com/docker/compose)上进行维护，目前最新版本是 1.2.0。</span><br><span class=\"line\"></span><br><span class=\"line\">Compose 定位是“defining and running complex applications with Docker”，前身是[ Fig](http://www.infoq.com/cn/articles/docker-build-development-environment-based-on-fig)，兼容 Fig 的模板文件。</span><br><span class=\"line\">Dockerfile 可以让用户管理一个单独的应用容器；而 Compose 则允许用户在一个模板（YAML 格式）中定义一组相关联的应用容器（被称为一个 project，即项目），例如一个 Web 服务容器再加上后端的数据库服务容器等。</span><br><span class=\"line\"></span><br><span class=\"line\">该项目由 Python 编写，实际上调用了 Docker 提供的 API 来实现。</span><br></pre></td></tr></table></figure>\n<h2 id=\"学习资源\"><a href=\"#学习资源\" class=\"headerlink\" title=\"学习资源\"></a>学习资源</h2><h3 id=\"SQL查询优化总结\"><a href=\"#SQL查询优化总结\" class=\"headerlink\" title=\"SQL查询优化总结\"></a>SQL查询优化总结</h3><p>1、应尽量避免在 where 子句中使用!=或&lt;&gt;操作符，否则将引擎放弃使用索引而进行全表扫描。</p>\n<p>2、对查询进行优化，应尽量避免全表扫描，首先应考虑在 where 及 order by 涉及的列上建立索引。</p>\n<p>3、应尽量避免在 where 子句中对字段进行 null 值判断，否则将导致引擎放弃使用索引而进行全表扫描，如：</p>\n<p>select id from t where num is null<br>可以在num上设置默认值0，确保表中num列没有null值，然后这样查询：</p>\n<p>select id from t where num=0<br>4、尽量避免在 where 子句中使用 or 来连接条件，否则将导致引擎放弃使用索引而进行全表扫描，如：</p>\n<p>select id from t where num=10 or num=20<br>可以这样查询：</p>\n<p>select id from t where num=10<br>union all<br>select id from t where num=20<br>5、下面的查询也将导致全表扫描：(不能前置百分号)</p>\n<p>select id from t where name like ‘%abc%’<br>若要提高效率，可以考虑全文检索。</p>\n<p>6、in 和 not in 也要慎用，否则会导致全表扫描，如：</p>\n<p>select id from t where num in(1,2,3)<br>对于连续的数值，能用 between 就不要用 in 了：</p>\n<p>select id from t where num between 1 and 3<br>7、如果在 where 子句中使用参数，也会导致全表扫描。因为SQL只有在运行时才会解析局部变量，但优化程序不能将访问计划的选择推迟到运行时；它必须在编译时进行选择。然 而，如果在编译时建立访问计划，变量的值还是未知的，因而无法作为索引选择的输入项。如下面语句将进行全表扫描：</p>\n<p>select id from t where num=@num<br>可以改为强制查询使用索引：</p>\n<p>select id from t with(index(索引名)) where num=@num<br>8、应尽量避免在 where 子句中对字段进行表达式操作，这将导致引擎放弃使用索引而进行全表扫描。如：</p>\n<p>select id from t where num/2=100<br>应改为:</p>\n<p>select id from t where num=100*2<br>9、应尽量避免在where子句中对字段进行函数操作，这将导致引擎放弃使用索引而进行全表扫描。如：</p>\n<p>select id from t where substring(name,1,3)=’abc’–name以abc开头的id<br>select id from t where datediff(day,createdate,’2005-11-30′)=0–’2005-11-30′生成的id<br>应改为:</p>\n<p>select id from t where name like ‘abc%’<br>select id from t where createdate&gt;=’2005-11-30′ and createdate&lt;’2005-12-1′<br>10、不要在 where 子句中的“=”左边进行函数、算术运算或其他表达式运算，否则系统将可能无法正确使用索引。</p>\n<p>11、在使用索引字段作为条件时，如果该索引是复合索引，那么必须使用到该索引中的第一个字段作为条件时才能保证系统使用该索引，否则该索引将不会被使 用，并且应尽可能的让字段顺序与索引顺序相一致。</p>\n<p>12、不要写一些没有意义的查询，如需要生成一个空表结构：</p>\n<p>select col1,col2 into #t from t where 1=0<br>这类代码不会返回任何结果集，但是会消耗系统资源的，应改成这样：</p>\n<p>create table #t(…)<br>13、很多时候用 exists 代替 in 是一个好的选择：</p>\n<p>select num from a where num in(select num from b)<br>用下面的语句替换：</p>\n<p>select num from a where exists(select 1 from b where num=a.num)<br>14、并不是所有索引对查询都有效，SQL是根据表中数据来进行查询优化的，当索引列有大量数据重复时，SQL查询可能不会去利用索引，如一表中有字段 sex，male、female几乎各一半，那么即使在sex上建了索引也对查询效率起不了作用。</p>\n<p>15、索引并不是越多越好，索引固然可以提高相应的 select 的效率，但同时也降低了 insert 及 update 的效率，因为 insert 或 update 时有可能会重建索引，所以怎样建索引需要慎重考虑，视具体情况而定。一个表的索引数最好不要超过6个，若太多则应考虑一些不常使用到的列上建的索引是否有 必要。</p>\n<p>16.应尽可能的避免更新 clustered 索引数据列，因为 clustered 索引数据列的顺序就是表记录的物理存储顺序，一旦该列值改变将导致整个表记录的顺序的调整，会耗费相当大的资源。若应用系统需要频繁更新 clustered 索引数据列，那么需要考虑是否应将该索引建为 clustered 索引。</p>\n<p>17、尽量使用数字型字段，若只含数值信息的字段尽量不要设计为字符型，这会降低查询和连接的性能，并会增加存储开销。这是因为引擎在处理查询和连接时会 逐个比较字符串中每一个字符，而对于数字型而言只需要比较一次就够了。</p>\n<p>18、尽可能的使用 varchar/nvarchar 代替 char/nchar ，因为首先变长字段存储空间小，可以节省存储空间，其次对于查询来说，在一个相对较小的字段内搜索效率显然要高些。</p>\n<p>19、任何地方都不要使用 select <em> from t ，用具体的字段列表代替“</em>”，不要返回用不到的任何字段。</p>\n<p>20、尽量使用表变量来代替临时表。如果表变量包含大量数据，请注意索引非常有限（只有主键索引）。</p>\n<p>21、避免频繁创建和删除临时表，以减少系统表资源的消耗。</p>\n<p>22、临时表并不是不可使用，适当地使用它们可以使某些例程更有效，例如，当需要重复引用大型表或常用表中的某个数据集时。但是，对于一次性事件，最好使 用导出表。</p>\n<p>23、在新建临时表时，如果一次性插入数据量很大，那么可以使用 select into 代替 create table，避免造成大量 log ，以提高速度；如果数据量不大，为了缓和系统表的资源，应先create table，然后insert。</p>\n<p>24、如果使用到了临时表，在存储过程的最后务必将所有的临时表显式删除，先 truncate table ，然后 drop table ，这样可以避免系统表的较长时间锁定。</p>\n<p>25、尽量避免使用游标，因为游标的效率较差，如果游标操作的数据超过1万行，那么就应该考虑改写。</p>\n<p>26、使用基于游标的方法或临时表方法之前，应先寻找基于集的解决方案来解决问题，基于集的方法通常更有效。</p>\n<p>27、与临时表一样，游标并不是不可使用。对小型数据集使用 FAST_FORWARD 游标通常要优于其他逐行处理方法，尤其是在必须引用几个表才能获得所需的数据时。在结果集中包括“合计”的例程通常要比使用游标执行的速度快。如果开发时 间允许，基于游标的方法和基于集的方法都可以尝试一下，看哪一种方法的效果更好。</p>\n<p>28、在所有的存储过程和触发器的开始处设置 SET NOCOUNT ON ，在结束时设置 SET NOCOUNT OFF 。无需在执行存储过程和触发器的每个语句后向客户端发送 DONE_IN_PROC 消息。</p>\n<p>29、尽量避免向客户端返回大数据量，若数据量过大，应该考虑相应需求是否合理。</p>\n<p>30、尽量避免大事务操作，提高系统并发能力。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">实战：验证以上总结。以下SQL段，可以直接放到Navicat中批量执行</span><br><span class=\"line\"></span><br><span class=\"line\">//已知在order表，int类型字段uid上，已存在normal类型的索引</span><br><span class=\"line\"></span><br><span class=\"line\">CREATE TABLE `order` (</span><br><span class=\"line\">  `order_id` int(11) NOT NULL AUTO_INCREMENT COMMENT &apos;订单编号&apos;,</span><br><span class=\"line\">  `uid` int(11) DEFAULT NULL COMMENT &apos;用户Id&apos;,</span><br><span class=\"line\">  `amout` bigint(20) NOT NULL COMMENT &apos;订单金额(单位为分)&apos;,</span><br><span class=\"line\">  `remark` varchar(50) DEFAULT &apos;&apos; COMMENT &apos;订单备注&apos;,</span><br><span class=\"line\">  `status` tinyint(2) DEFAULT NULL COMMENT &apos;订单状态&apos;,</span><br><span class=\"line\">  `order_time` datetime DEFAULT NULL COMMENT &apos;订单时间&apos;,</span><br><span class=\"line\">  PRIMARY KEY (`order_id`),</span><br><span class=\"line\">  KEY `order_uid_normal_index` (`uid`)</span><br><span class=\"line\">) ENGINE=InnoDB AUTO_INCREMENT=240 DEFAULT CHARSET=utf8;</span><br><span class=\"line\"></span><br><span class=\"line\">EXPLAIN select order_id,uid,order_time from `order` where uid=185147;</span><br><span class=\"line\"></span><br><span class=\"line\">EXPLAIN select order_id,uid,order_time from `order` where uid !=185147;//不能使用索引</span><br><span class=\"line\"></span><br><span class=\"line\">EXPLAIN select order_id,uid,order_time from `order` where uid &gt;185147;</span><br><span class=\"line\"></span><br><span class=\"line\">EXPLAIN select order_id,uid,order_time from `order` where uid &lt;185147;</span><br><span class=\"line\"></span><br><span class=\"line\">EXPLAIN select order_id,uid,order_time from `order` where uid &gt;175147 and uid &lt;185147;</span><br><span class=\"line\"></span><br><span class=\"line\">EXPLAIN select order_id,uid,order_time from `order` where uid &lt;&gt;175147;//不等于符号导致，不能使用索引</span><br><span class=\"line\"></span><br><span class=\"line\">EXPLAIN select order_id,uid,order_time from `order` where uid in(185147,185148,185149);//in操作符，不能使用索引</span><br><span class=\"line\"></span><br><span class=\"line\">EXPLAIN select order_id,uid,order_time from `order` where uid not in(185147,185148,185149);//not in操作符，不能使用索引</span><br><span class=\"line\"></span><br><span class=\"line\">EXPLAIN select order_id,uid,order_time from `order` where uid between 185147 and 185149;</span><br><span class=\"line\"></span><br><span class=\"line\">EXPLAIN select order_id,uid,order_time from `order` where uid=185147 or uid=5147;//or操作符导致，不能使用索引</span><br><span class=\"line\"></span><br><span class=\"line\">EXPLAIN select order_id,uid,order_time from `order` where uid=185147 UNION all select * from `order` where uid=185148;</span><br><span class=\"line\"></span><br><span class=\"line\">EXPLAIN select order_id,uid,order_time from `order` where uid like &quot;%185%&quot;;//左%通配符，不能使用索引</span><br><span class=\"line\"></span><br><span class=\"line\">EXPLAIN select order_id,uid,order_time from `order` where uid like &quot;185%&quot;;//类型转换，不能使用索引。如果int是varchar类型则可以使用索引。</span><br><span class=\"line\"></span><br><span class=\"line\">EXPLAIN select order_id,uid,order_time from `order` where uid like &quot;%185&quot;;//左%通配符，不能使用索引</span><br><span class=\"line\"></span><br><span class=\"line\">EXPLAIN select order_id,uid,order_time from `order` where uid like &quot;185&quot;;//类型转换，不能使用索引</span><br><span class=\"line\"></span><br><span class=\"line\">EXPLAIN select order_id,uid,order_time from `order` where uid/2=100 ;//谓词字段进行算术操作，不能使用索引</span><br><span class=\"line\"></span><br><span class=\"line\">EXPLAIN select order_id,uid,order_time from `order` where substring(uid,1,3)=&quot;abc&quot;;//谓词字段进行函数操作，不能使用索引</span><br><span class=\"line\"></span><br><span class=\"line\">EXPLAIN select DISTINCT uid from `order`;</span><br><span class=\"line\"></span><br><span class=\"line\">EXPLAIN select max(uid) from `order`;//返回字段进行函数操作，不能使用索引</span><br></pre></td></tr></table></figure>\n<h2 id=\"Referrence\"><a href=\"#Referrence\" class=\"headerlink\" title=\"Referrence\"></a>Referrence</h2><ul>\n<li><p><a href=\"http://tech.meituan.com/mysql-index.html\" target=\"_blank\" rel=\"external\">美团点评技术团队：MySQL索引原理及慢查询优化</a></p>\n</li>\n<li><p><a href=\"https://yeasy.gitbooks.io/docker_practice/content/compose/intro.html\" target=\"_blank\" rel=\"external\">Docker —— 从入门到实践</a></p>\n</li>\n</ul>\n","excerpt":"","more":"<h2 id=\"软件\"><a href=\"#软件\" class=\"headerlink\" title=\"软件\"></a>软件</h2><h3 id=\"Docker\"><a href=\"#Docker\" class=\"headerlink\" title=\"Docker\"></a>Docker</h3><h4 id=\"安装\"><a href=\"#安装\" class=\"headerlink\" title=\"安装\"></a>安装</h4><p>1.Follow：<a href=\"https://segmentfault.com/a/1190000002485231\">https://segmentfault.com/a/1190000002485231</a></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ubuntu下，用以下这种脚本方式安装最方便，来源于sameersbn/docker-gitlab官方说明：</span><br><span class=\"line\"></span><br><span class=\"line\">sudo apt-get purge docker.io</span><br><span class=\"line\">curl -s https://get.docker.io/ubuntu/ | sudo sh</span><br><span class=\"line\">sudo apt-get update</span><br><span class=\"line\">sudo apt-get install lxc-docker --fix-missing</span><br><span class=\"line\"></span><br><span class=\"line\">### Docker Compose</span><br><span class=\"line\"></span><br><span class=\"line\">Compose 项目目前在[ Github ](https://github.com/docker/compose)上进行维护，目前最新版本是 1.2.0。</span><br><span class=\"line\"></span><br><span class=\"line\">Compose 定位是“defining and running complex applications with Docker”，前身是[ Fig](http://www.infoq.com/cn/articles/docker-build-development-environment-based-on-fig)，兼容 Fig 的模板文件。</span><br><span class=\"line\">Dockerfile 可以让用户管理一个单独的应用容器；而 Compose 则允许用户在一个模板（YAML 格式）中定义一组相关联的应用容器（被称为一个 project，即项目），例如一个 Web 服务容器再加上后端的数据库服务容器等。</span><br><span class=\"line\"></span><br><span class=\"line\">该项目由 Python 编写，实际上调用了 Docker 提供的 API 来实现。</span><br></pre></td></tr></table></figure>\n<h2 id=\"学习资源\"><a href=\"#学习资源\" class=\"headerlink\" title=\"学习资源\"></a>学习资源</h2><h3 id=\"SQL查询优化总结\"><a href=\"#SQL查询优化总结\" class=\"headerlink\" title=\"SQL查询优化总结\"></a>SQL查询优化总结</h3><p>1、应尽量避免在 where 子句中使用!=或&lt;&gt;操作符，否则将引擎放弃使用索引而进行全表扫描。</p>\n<p>2、对查询进行优化，应尽量避免全表扫描，首先应考虑在 where 及 order by 涉及的列上建立索引。</p>\n<p>3、应尽量避免在 where 子句中对字段进行 null 值判断，否则将导致引擎放弃使用索引而进行全表扫描，如：</p>\n<p>select id from t where num is null<br>可以在num上设置默认值0，确保表中num列没有null值，然后这样查询：</p>\n<p>select id from t where num=0<br>4、尽量避免在 where 子句中使用 or 来连接条件，否则将导致引擎放弃使用索引而进行全表扫描，如：</p>\n<p>select id from t where num=10 or num=20<br>可以这样查询：</p>\n<p>select id from t where num=10<br>union all<br>select id from t where num=20<br>5、下面的查询也将导致全表扫描：(不能前置百分号)</p>\n<p>select id from t where name like ‘%abc%’<br>若要提高效率，可以考虑全文检索。</p>\n<p>6、in 和 not in 也要慎用，否则会导致全表扫描，如：</p>\n<p>select id from t where num in(1,2,3)<br>对于连续的数值，能用 between 就不要用 in 了：</p>\n<p>select id from t where num between 1 and 3<br>7、如果在 where 子句中使用参数，也会导致全表扫描。因为SQL只有在运行时才会解析局部变量，但优化程序不能将访问计划的选择推迟到运行时；它必须在编译时进行选择。然 而，如果在编译时建立访问计划，变量的值还是未知的，因而无法作为索引选择的输入项。如下面语句将进行全表扫描：</p>\n<p>select id from t where num=@num<br>可以改为强制查询使用索引：</p>\n<p>select id from t with(index(索引名)) where num=@num<br>8、应尽量避免在 where 子句中对字段进行表达式操作，这将导致引擎放弃使用索引而进行全表扫描。如：</p>\n<p>select id from t where num/2=100<br>应改为:</p>\n<p>select id from t where num=100*2<br>9、应尽量避免在where子句中对字段进行函数操作，这将导致引擎放弃使用索引而进行全表扫描。如：</p>\n<p>select id from t where substring(name,1,3)=’abc’–name以abc开头的id<br>select id from t where datediff(day,createdate,’2005-11-30′)=0–’2005-11-30′生成的id<br>应改为:</p>\n<p>select id from t where name like ‘abc%’<br>select id from t where createdate&gt;=’2005-11-30′ and createdate&lt;’2005-12-1′<br>10、不要在 where 子句中的“=”左边进行函数、算术运算或其他表达式运算，否则系统将可能无法正确使用索引。</p>\n<p>11、在使用索引字段作为条件时，如果该索引是复合索引，那么必须使用到该索引中的第一个字段作为条件时才能保证系统使用该索引，否则该索引将不会被使 用，并且应尽可能的让字段顺序与索引顺序相一致。</p>\n<p>12、不要写一些没有意义的查询，如需要生成一个空表结构：</p>\n<p>select col1,col2 into #t from t where 1=0<br>这类代码不会返回任何结果集，但是会消耗系统资源的，应改成这样：</p>\n<p>create table #t(…)<br>13、很多时候用 exists 代替 in 是一个好的选择：</p>\n<p>select num from a where num in(select num from b)<br>用下面的语句替换：</p>\n<p>select num from a where exists(select 1 from b where num=a.num)<br>14、并不是所有索引对查询都有效，SQL是根据表中数据来进行查询优化的，当索引列有大量数据重复时，SQL查询可能不会去利用索引，如一表中有字段 sex，male、female几乎各一半，那么即使在sex上建了索引也对查询效率起不了作用。</p>\n<p>15、索引并不是越多越好，索引固然可以提高相应的 select 的效率，但同时也降低了 insert 及 update 的效率，因为 insert 或 update 时有可能会重建索引，所以怎样建索引需要慎重考虑，视具体情况而定。一个表的索引数最好不要超过6个，若太多则应考虑一些不常使用到的列上建的索引是否有 必要。</p>\n<p>16.应尽可能的避免更新 clustered 索引数据列，因为 clustered 索引数据列的顺序就是表记录的物理存储顺序，一旦该列值改变将导致整个表记录的顺序的调整，会耗费相当大的资源。若应用系统需要频繁更新 clustered 索引数据列，那么需要考虑是否应将该索引建为 clustered 索引。</p>\n<p>17、尽量使用数字型字段，若只含数值信息的字段尽量不要设计为字符型，这会降低查询和连接的性能，并会增加存储开销。这是因为引擎在处理查询和连接时会 逐个比较字符串中每一个字符，而对于数字型而言只需要比较一次就够了。</p>\n<p>18、尽可能的使用 varchar/nvarchar 代替 char/nchar ，因为首先变长字段存储空间小，可以节省存储空间，其次对于查询来说，在一个相对较小的字段内搜索效率显然要高些。</p>\n<p>19、任何地方都不要使用 select <em> from t ，用具体的字段列表代替“</em>”，不要返回用不到的任何字段。</p>\n<p>20、尽量使用表变量来代替临时表。如果表变量包含大量数据，请注意索引非常有限（只有主键索引）。</p>\n<p>21、避免频繁创建和删除临时表，以减少系统表资源的消耗。</p>\n<p>22、临时表并不是不可使用，适当地使用它们可以使某些例程更有效，例如，当需要重复引用大型表或常用表中的某个数据集时。但是，对于一次性事件，最好使 用导出表。</p>\n<p>23、在新建临时表时，如果一次性插入数据量很大，那么可以使用 select into 代替 create table，避免造成大量 log ，以提高速度；如果数据量不大，为了缓和系统表的资源，应先create table，然后insert。</p>\n<p>24、如果使用到了临时表，在存储过程的最后务必将所有的临时表显式删除，先 truncate table ，然后 drop table ，这样可以避免系统表的较长时间锁定。</p>\n<p>25、尽量避免使用游标，因为游标的效率较差，如果游标操作的数据超过1万行，那么就应该考虑改写。</p>\n<p>26、使用基于游标的方法或临时表方法之前，应先寻找基于集的解决方案来解决问题，基于集的方法通常更有效。</p>\n<p>27、与临时表一样，游标并不是不可使用。对小型数据集使用 FAST_FORWARD 游标通常要优于其他逐行处理方法，尤其是在必须引用几个表才能获得所需的数据时。在结果集中包括“合计”的例程通常要比使用游标执行的速度快。如果开发时 间允许，基于游标的方法和基于集的方法都可以尝试一下，看哪一种方法的效果更好。</p>\n<p>28、在所有的存储过程和触发器的开始处设置 SET NOCOUNT ON ，在结束时设置 SET NOCOUNT OFF 。无需在执行存储过程和触发器的每个语句后向客户端发送 DONE_IN_PROC 消息。</p>\n<p>29、尽量避免向客户端返回大数据量，若数据量过大，应该考虑相应需求是否合理。</p>\n<p>30、尽量避免大事务操作，提高系统并发能力。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">实战：验证以上总结。以下SQL段，可以直接放到Navicat中批量执行</span><br><span class=\"line\"></span><br><span class=\"line\">//已知在order表，int类型字段uid上，已存在normal类型的索引</span><br><span class=\"line\"></span><br><span class=\"line\">CREATE TABLE `order` (</span><br><span class=\"line\">  `order_id` int(11) NOT NULL AUTO_INCREMENT COMMENT &apos;订单编号&apos;,</span><br><span class=\"line\">  `uid` int(11) DEFAULT NULL COMMENT &apos;用户Id&apos;,</span><br><span class=\"line\">  `amout` bigint(20) NOT NULL COMMENT &apos;订单金额(单位为分)&apos;,</span><br><span class=\"line\">  `remark` varchar(50) DEFAULT &apos;&apos; COMMENT &apos;订单备注&apos;,</span><br><span class=\"line\">  `status` tinyint(2) DEFAULT NULL COMMENT &apos;订单状态&apos;,</span><br><span class=\"line\">  `order_time` datetime DEFAULT NULL COMMENT &apos;订单时间&apos;,</span><br><span class=\"line\">  PRIMARY KEY (`order_id`),</span><br><span class=\"line\">  KEY `order_uid_normal_index` (`uid`)</span><br><span class=\"line\">) ENGINE=InnoDB AUTO_INCREMENT=240 DEFAULT CHARSET=utf8;</span><br><span class=\"line\"></span><br><span class=\"line\">EXPLAIN select order_id,uid,order_time from `order` where uid=185147;</span><br><span class=\"line\"></span><br><span class=\"line\">EXPLAIN select order_id,uid,order_time from `order` where uid !=185147;//不能使用索引</span><br><span class=\"line\"></span><br><span class=\"line\">EXPLAIN select order_id,uid,order_time from `order` where uid &gt;185147;</span><br><span class=\"line\"></span><br><span class=\"line\">EXPLAIN select order_id,uid,order_time from `order` where uid &lt;185147;</span><br><span class=\"line\"></span><br><span class=\"line\">EXPLAIN select order_id,uid,order_time from `order` where uid &gt;175147 and uid &lt;185147;</span><br><span class=\"line\"></span><br><span class=\"line\">EXPLAIN select order_id,uid,order_time from `order` where uid &lt;&gt;175147;//不等于符号导致，不能使用索引</span><br><span class=\"line\"></span><br><span class=\"line\">EXPLAIN select order_id,uid,order_time from `order` where uid in(185147,185148,185149);//in操作符，不能使用索引</span><br><span class=\"line\"></span><br><span class=\"line\">EXPLAIN select order_id,uid,order_time from `order` where uid not in(185147,185148,185149);//not in操作符，不能使用索引</span><br><span class=\"line\"></span><br><span class=\"line\">EXPLAIN select order_id,uid,order_time from `order` where uid between 185147 and 185149;</span><br><span class=\"line\"></span><br><span class=\"line\">EXPLAIN select order_id,uid,order_time from `order` where uid=185147 or uid=5147;//or操作符导致，不能使用索引</span><br><span class=\"line\"></span><br><span class=\"line\">EXPLAIN select order_id,uid,order_time from `order` where uid=185147 UNION all select * from `order` where uid=185148;</span><br><span class=\"line\"></span><br><span class=\"line\">EXPLAIN select order_id,uid,order_time from `order` where uid like &quot;%185%&quot;;//左%通配符，不能使用索引</span><br><span class=\"line\"></span><br><span class=\"line\">EXPLAIN select order_id,uid,order_time from `order` where uid like &quot;185%&quot;;//类型转换，不能使用索引。如果int是varchar类型则可以使用索引。</span><br><span class=\"line\"></span><br><span class=\"line\">EXPLAIN select order_id,uid,order_time from `order` where uid like &quot;%185&quot;;//左%通配符，不能使用索引</span><br><span class=\"line\"></span><br><span class=\"line\">EXPLAIN select order_id,uid,order_time from `order` where uid like &quot;185&quot;;//类型转换，不能使用索引</span><br><span class=\"line\"></span><br><span class=\"line\">EXPLAIN select order_id,uid,order_time from `order` where uid/2=100 ;//谓词字段进行算术操作，不能使用索引</span><br><span class=\"line\"></span><br><span class=\"line\">EXPLAIN select order_id,uid,order_time from `order` where substring(uid,1,3)=&quot;abc&quot;;//谓词字段进行函数操作，不能使用索引</span><br><span class=\"line\"></span><br><span class=\"line\">EXPLAIN select DISTINCT uid from `order`;</span><br><span class=\"line\"></span><br><span class=\"line\">EXPLAIN select max(uid) from `order`;//返回字段进行函数操作，不能使用索引</span><br></pre></td></tr></table></figure>\n<h2 id=\"Referrence\"><a href=\"#Referrence\" class=\"headerlink\" title=\"Referrence\"></a>Referrence</h2><ul>\n<li><p><a href=\"http://tech.meituan.com/mysql-index.html\">美团点评技术团队：MySQL索引原理及慢查询优化</a></p>\n</li>\n<li><p><a href=\"https://yeasy.gitbooks.io/docker_practice/content/compose/intro.html\">Docker —— 从入门到实践</a></p>\n</li>\n</ul>\n"}],"Post":[{"title":"从零开始Blogging with Hexo教程","date":"2016-04-01T09:38:14.461Z","description":"刚开始折腾时，经常出现改了很多配置，一运行就报错了，但是无法定位是哪些配置的改动导致的？幸好我用Sublime Text 3修改的，有历史记录，这点真是太赞了！Hexo配置好后，最好做一次网盘私密备份，以免主机故障丢失。而且有了备份，在家或在公司，都可以愉快的写blog啦！","_content":"\n# 写在前面 #\n\n　　转眼间3月份也即将过去了，在接受了众多的理论输入以及实践之后，决定要将一些值得分享的事情记录下来，一方面是避免自己重复的掉坑，另一方面也希望通过blog的方式锻炼自己的文字能力。输入+沉淀+输出，形成自我知识攫取过程的闭环。\n\n　　下面记录从零开始的Blogging with Hexo的搭建过程，有一些简单的问题，在文末也会给出答案。\n\n## 1.你将要做什么？\n　　跟我一起在GiHub上搭建免费无限流量博客，不限速，有版本追溯管理。sadly，免费的背后是低层次的服务。搭建的博客服务器在国外，国内访问的速度没法保障，后文会给出一定的解决方案。内容的维护只能以静态Html的方式发布，意味着没有数据库，因此带来了幂等性，没有各种Web攻击，算作是一件好事？\n\n　　搭建过程中需要的技术：GitHub的使用、安装NodeJS、安装Hexo及系列插件、安装及配置Jacman主题、新文章的发布、Markdown的持续提高。\n### 1.1国内blog平台的现状\n国内的技术blog平台主要有：cnblogs、51cto、iteye、oschina、infoq等；排名没分先后，纯属个人想法。相信以上blogs，作为技术人，大家一定不陌生。平台型的blog，对个人的有利有弊，优势在于：免去软硬件维护管理的麻烦、不用担心流量和各种安全问题、；劣势也比较明显：内容版权、变现很困难、内容受限、内容面临下线风险\n\n引用[阮一峰先生的总结](http://www.ruanyifeng.com/blog/2012/08/blogging_with_jekyll.html)：\n\n1. 第一阶段，刚接触Blog，觉得很新鲜，试着选择一个免费空间来写。\n2. 第二阶段，发现免费空间限制太多，就自己购买域名和空间，搭建独立博客。\n3. 第三阶段，觉得独立博客的管理太麻烦，最好在保留控制权的前提下，让别人来管，自己只负责写文章。\n\n即技术人对于blog的核心需求是：发布文章、维护文章、随时控制、免去其他管理，也就是输出可控的文章。\n\n### 1.2如何选择适合自己的blog平台\n国内的blog平台少有让人长期安心逗留的，各种内容审查政策的强压，大环境的逐利性等因素，促使少有blog平台保持良心的同时持续改进其平台，在此不多言。\n我们希望发出的文章，可以进入一个技术人大都汇聚的环境中，以提高影响力。这样的环境可以是个人blog、blogs平台、微信平台等等。如果你有足够的影响力，也希望在作者与读者之间建立交流通道，常见的就是文章的评论回复功能了，其他的也有读者QQ群等社区型交流方式。引申的说，对于不怀好意的评论者，还需要一个评论审核的功能，甚至禁止评论，这都能在下文中得到解决。\n\n### 1.3为什么是Hexo？\n我们怎么评价Hexo？\n\n知乎：[jekyll vs Hexo](https://www.zhihu.com/question/19996679)\n## 2.如何做？\n### 2.1安装和配置NodeJS\n1. 确认你的配置是windows 7，虽然没有限制一定要windows，但是本教程基于windows。![我的系统环境](/img/计算机软硬件配置.png)。\n\n2. [安装NodeJS](http://www.runoob.com/nodejs/nodejs-install-setup.html)\n我的安装完成目录：\n\n![](/img/NodeJS安装完成.png)\n\n3. [解决npm安装模块慢或失败的问题](http://www.cnblogs.com/enix/p/3635343.html)\n```\nnpm config set registry=\"http://registry.npmjs.org\"//设置npm源地址\n```\n确认你的npm配置：\n\n![](/img/npm配置信息.png)\n\n### 2.2获取GitHub账号\nGitHub账号和GitHub Pages 一般都应该有吧，已有的请自动无视这一部分。\n### 2.2yourname.github.io\n* 首先注册一个『GitHub』帐号，已有的默认默认请忽略\n* 建立与你用户名对应的仓库，仓库名必须为『your_user_name.github.com』\n\n### 2.3安装和配置windows GitHub客户端\n不建议在[GitHub官网](https://desktop.github.com/)下载最新客户端，官网下载的客户端大小不到1MB，在本地运行还需要链接Amazon下载具体的安装包，因为国内网络环境，经常下载到一半就断掉.\n\n我个人试了各种方法不得解，最后找到了离线安装版：已存入百度云：链接：http://pan.baidu.com/s/1eRmoG6Y 密码：3vus\n\n因为版本控制工具比较耗系统资源，请尽量安装在非系统所在盘，尽量选择剩余容量大的盘。\n安装完成后，得到2个桌面图标：GitHub、Git Shell。前者是可视化版，后者是命令行版。\n\n我选择使用GitHub,打开后进行GitHub账号登录，第一次登录成功后，绑定邮箱会收到新邮件：[GitHub] A new public key was added to your account\n\n点击左上角“+”号，选择clone，选择自己的yourname.github.io。\n在下一步中选择存放文件夹，我的选择是：\n![](/img/github目录.png)\n\n简单的使用windows GitHub客户端\n\n```\n在对话框顶部有“No uncommitted changes”和“History”，点击后可以进行切换。\n在版本库所在的文件夹有了文件变化后，这里会有变化“28 uncommitted changes”和“History”，28是指的未提交的更改数量。\n填写Summary和Description后，可以进行本地提交：Commit to master。\n此时若还想提交到远程GitHub服务器，点击右上角“Sync”按钮进行同步。\n```\n\n### 2.4安装和配置Hexo\n\n安装和初始化Hexo\n```\n$ cd /d/\n$ mkdir hexo\n$ cd hexo\n$ npm install -g hexo\n$ hexo init\n$ hexo g # 或者hexo generate\n$ hexo s # 或者hexo server，可以在http://localhost:4000/查看\n```\n![](/img/hexo安装目录.png)\n\n安装\n```\n$ hexo clean\n$ git clone https://github.com/wuchong/jacman.git themes/jacman\n```\n![](/img/jacman主题安装目录.png)\n\n\n常用命令\n```\nhexo n \"我的博客\" == hexo new \"我的博客\" #新建文章\nhexo p == hexo publish\nhexo g == hexo generate#生成\nhexo s == hexo server #启动服务预览\nhexo d == hexo deploy#部署\n```\n\n部署文章到github.io\n```\nhexo clean\nhexo g\n拷贝Hexo文件夹下的public文件夹里的所有文件\n粘贴到yourname.github.io所在磁盘目录中，我的目录是：D:\\GitHub\\amao12580.github.io\n使用GitHub客户端进行提交到远程服务器\n打开yourname.github.io网址即可看到效果啦！\n```\n\n### 2.5为什么是Jacman?\n\n参见评价[Jacman基于Pacman修改的Hexo主题](http://wsgzao.github.io/post/hexo-jacman/)\n\n### 2.6私人定制\n在这里贴出我修改过的一些文件，很多修改都给出了备注。\n\nHexo主配置文件：D:\\GitHub\\Hexo\\\\_config.yml\n```\n# Hexo Configuration\n## Docs: https://hexo.io/docs/configuration.html\n## Source: https://github.com/hexojs/hexo/\n\n# Site\ntitle: Cat's Blog\nsubtitle: 一饮一啄，莫非前定.\n#为了更便于搜索引擎爬到，添加了网站的keywords\nkeywords: cat's,chengliang,amao12580,blog,developers\ndescription: Follw the https://xuanwo.org/2015/03/26/hexo-intor/\nauthor: Steven Cheng\nlanguage: zh-CN\ntimezone:\n\n# URL\n## If your site is put in a subdirectory, set url as 'http://yoursite.com/child' and root as '/child/'\nurl: http://amao12580.github.io\nroot: /\npermalink: post/:year/:month/:title/\npermalink_defaults:\n\n# Directory\nsource_dir: source\npublic_dir: public\ntag_dir: tags\nabout_dir: about\narchive_dir: archives\ncategory_dir: categories\ncode_dir: downloads/code\ni18n_dir: :lang\nskip_render:\n  - README.md\n  - 404.html\n\n# Writing\nnew_post_name: :title.md # File name of new posts\ndefault_layout: post\ntitlecase: false # Transform title into titlecase\nexternal_link: true # Open external links in new tab\nfilename_case: 0\nrender_drafts: false\npost_asset_folder: false\nrelative_link: false\nfuture: true\nhighlight:\n  enable: true\n  line_number: true\n  auto_detect: false\n  tab_replace:\n\n# Category & Tag\ndefault_category: uncategorized\ncategory_map:\ntag_map:\n\n# Date / Time format\n## Hexo uses Moment.js to parse and display date\n## You can customize the date format as defined in\n## http://momentjs.com/docs/#/displaying/format/\ndate_format: YYYY-MM-DD\ntime_format: HH:mm:ss\ndatetime_format: YYYY-MM-DD HH:mm:ss.SSS\n\n# Pagination\n## Set per_page to 0 to disable pagination\nper_page: 10\npagination_dir: page\n\n# Extensions\n## Plugins: https://hexo.io/plugins/\n## Themes: https://hexo.io/themes/\ntheme: jacman\nstylus:\n  compress: true\n\n# Deployment\n## Docs: https://hexo.io/docs/deployment.html\ndeploy:\n  type:\n\n\n# Others\nindex_generator:\n  per_page: 5 ##首页默认10篇文章标题 如果值为0不分页\n\narchive_generator:\n    per_page: 0 ##归档页面默认10篇文章标题\n    yearly: true  ##生成年视图\n    monthly: true ##生成月视图\n\ntag_generator:\n    per_page: 0 ##标签分类页面默认10篇文章\n\ncategory_generator:\n    per_page: 0 ###分类页面默认10篇文章\n\nfeed:\n    type: atom ##feed类型 atom或者rss2\n    path: atom.xml ##feed路径\n    limit: 20  ##feed文章最小数量\n\n#访问zipperary/sitemap.xml即可看到站点地图。不过，sitemap的初衷是给搜索引擎看的，为了提高搜索引擎对自己站点的收录效果，我们最好手动到google和百度等搜索引擎提交sitemap.xml。\n#sitemap\nsitemap:\n  - path: sitemap.xml\n\nbaidusitemap:\n - path: baidusitemap.xml\n```\n\nJacman主题的主配置文件：D:\\GitHub\\Hexo\\themes\\jacman\\ _config.yml\n```\n##### Menu\nmenu:\n  主页 | Home: /\n  索引 | Index: /index\n  归档 | Archives: /archives\n  简介 | About: /about\n## you can create `tags` and `categories` folders in `../source`.\n## And create a `index.md` file in each of them.\n## set `front-matter`as\n## layout: tags (or categories)\n## title: tags (or categories)\n## ---\n\n#### Widgets\nwidgets:\n- github-card\n- category\n- tag\n- links\n- douban\n- rss\n- weibo\n  ## provide eight widgets:github-card,category,tag,rss,archive,tagcloud,links,weibo\n\n\n\n#### RSS\nrss: /atom.xml ## RSS address.\n\n#### Image\nimglogo:\n  enable: true             ## display image logo true/false.\n  src: img/logo.png        ## `.svg` and `.png` are recommended,please put image into the theme folder `/jacman/source/img`.\nfavicon: img/favicon.ico   ## size:32px*32px,`.ico` is recommended,please put image into the theme folder `/jacman/source/img`.\napple_icon: img/jacman.jpg ## size:114px*114px,please put image into the theme folder `/jacman/source/img`.\nauthor_img: img/author.jpg ## size:220px*220px.display author avatar picture.if don't want to display,please don't set this.\nbanner_img: #img/banner.jpg ## size:1920px*200px+. Banner Picture\n### Theme Color\ntheme_color:\n    theme: '#2ca6cb'    ##the defaut theme color is blue\n\n# 代码高亮主题\n# available: default | night\nhighlight_theme: night\n\n#### index post is expanding or not\nindex:\n  expand: false           ## default is unexpanding,so you can only see the short description of each post.\n  excerpt_link: Read More\n\nclose_aside: true  #close sidebar in post page if true\nmathjax: true      #enable mathjax if true\n\n### Creative Commons License Support, see http://creativecommons.org/\n### you can choose: by , by-nc , by-nc-nd , by-nc-sa , by-nd , by-sa , zero\ncreative_commons: none\n\n#### Author information\nauthor:\n  intro_line1:  \"Hello ,I'm steven. This is my blog on GitHub.\"    ## your introduction on the bottom of the page\n  intro_line2:  \"Whenever you feel like criticizing any one, just remember that all the people in this world haven’t had the advantages that you’ve had.\"  ## the 2nd line\n  intro_line3: \"每当你觉得想要批评什么人的时候，你切要记着，这个世界上的人并非都具备你禀有的条件。《了不起的盖茨比》\"\n  weibo: 3201133445     ## e.g. wuchong1014 or 2176287895 for http://weibo.com/2176287895\n  weibo_verifier: b3593ceb    ## e.g. b3593ceb Your weibo-show widget verifier ,if you use weibo-show it is needed.\n  tsina:      ## e.g. 2176287895  Your weibo ID,It will be used in share button.\n  douban:     ## e.g. wuchong1014 or your id for https://www.douban.com/people/wuchong1014\n  zhihu:      ## e.g. jark  for http://www.zhihu.com/people/jark\n  email : chengliangchengliang888@gmail.com     ## e.g. imjark@gmail.com\n  twitter:    ## e.g. jarkwu for https://twitter.com/jarkwu\n  github: amao12580     ## e.g. wuchong for https://github.com/wuchong\n  facebook:   ## e.g. imjark for https://facebook.com/imjark\n  linkedin:   ## e.g. wuchong1014 for https://www.linkedin.com/in/wuchong1014\n  google_plus:    ## e.g. \"111190881341800841449\" for https://plus.google.com/u/0/111190881341800841449, the \"\" is needed!\n  stackoverflow:  ## e.g. 3222790 for http://stackoverflow.com/users/3222790/jark\n## if you set them, the corresponding  share button will show on the footer\n\n#### Toc\ntoc:\n  article: true   ## show contents in article.\n  aside: true     ## show contents in aside.\n## you can set both of the value to true of neither of them.\n## if you don't want display contents in a specified post,you can modify `front-matter` and add `toc: false`.\n\n#### Links\nlinks:\n  码农圈: https://coderq.com,一个面向程序员交流分享的新一代社区\n  Jark's Blog: http://wuchong.me\n  GitHub: https://github.com/amao12580\n\n\n\n#### Comment\nduoshuo_shortname: amao12580   ## e.g. wuchong   your duoshuo short name.\ndisqus_shortname:     ## e.g. wuchong   your disqus short name.\n\n#### Share button\njiathis:\n  enable: false ## if you use jiathis as your share tool,the built-in share tool won't be display.\n  id:    ## e.g. 1889330 your jiathis ID.\n  tsina: ## e.g. 2176287895 Your weibo id,It will be used in share button.\n\n#### Analytics\ngoogle_analytics:\n  enable: true\n  id: UA-75497011-1        ## e.g. UA-46321946-2 your google analytics ID.\n  site: http://amao12580.github.io      ## e.g. wuchong.me your google analytics site or set the value as auto.\n## You MUST upgrade to Universal Analytics first!\n## https://developers.google.com/analytics/devguides/collection/upgrade/?hl=zh_CN\nbaidu_tongji:\n  enable: true\n  sitecode: e6d1f421bbc9962127a50488f9ed37d1 ## e.g. e6d1f421bbc9962127a50488f9ed37d1 your baidu tongji site code\ncnzz_tongji:\n  enable: false\n  siteid:    ## e.g. 1253575964 your cnzz tongji site id\nibruce_tongji: # 不蒜子计数\n  enable: true\n\n#### Miscellaneous\nShowCustomFont: true  ## you can change custom font in `variable.styl` and `font.styl` which in the theme folder `/jacman/source/css`.\nfancybox: true        ## if you use gallery post or want use fancybox please set the value to true.\ntotop: true           ## if you want to scroll to top in every post set the value to true\n\n\n#### Custom Search\ngoogle_cse:\n  enable: false\n  cx:   ## e.g. 018294693190868310296:abnhpuysycw your Custom Search ID.\n## https://www.google.com/cse/\n## To enable the custom search You must create a \"search\" folder in '/source' and a \"index.md\" file\n## set the 'front-matter' as\n## layout: search\n## title: search\n## ---\nbaidu_search:     ## http://zn.baidu.com/\n  enable: false\n  id:   ## e.g. \"783281470518440642\"  for your baidu search id\n  site: http://zhannei.baidu.com/cse/search  ## your can change to your site instead of the default site\n\ntinysou_search:     ## http://tinysou.com/\n  enable: false\n  id:  ## e.g. \"4ac092ad8d749fdc6293\" for your tiny search id\n```\n\nJacman主题布局配置文件：D:\\GitHub\\Hexo\\themes\\jacman\\layout\\layout.ejs\n\n```\n<% if (page.layout=='post' || page.layout=='photo'){ %>\n <%- partial('_partial/head') %>\n  <body>\n    <header>\n      <%- partial('_partial/header') %>\n    </header>\n    <div id=\"container\">\n      <%- body %>\n      <%- partial('_partial/sidebar',{item: page,table: true}) %>\n    </div>\n    <footer><%- partial('_partial/footer') %></footer>\n    <%- partial('_partial/after_footer') %>\n  </body>\n</html>\n<% } else if(page.layout=='page'){ %>\n  <% if(page.source.match(/\\.md$/)){ %>\n    <%- partial('_partial/head') %>\n      <body>\n        <header>\n          <%- partial('_partial/header') %>\n        </header>\n        <div id=\"container\">\n          <%- body %>\n        </div>\n        <footer><%- partial('_partial/footer') %></footer>\n        <%- partial('_partial/after_footer') %>\n      </body>\n     </html>\n     <% }else{ %>\n    <%- page.content %>\n  <% } %>\n<% } else if(page.layout=='search'){ %>\n<%- partial('_partial/head') %>\n    <body>\n      <header>\n        <%- partial('_partial/header') %>\n      </header>\n      <div id=\"container\">\n        <%- partial('_partial/search')%>\n      </div>\n      <footer><%- partial('_partial/footer') %></footer>\n      <%- partial('_partial/after_footer') %>\n    </body>\n   </html>\n<% } else if(page.layout=='tags'){ %>\n <%- partial('_partial/head') %>\n    <body>\n      <header>\n        <%- partial('_partial/header') %>\n      </header>\n      <div id=\"container\">\n          <%- partial('_partial/tags')%>\n      </div>\n      <footer><%- partial('_partial/footer') %></footer>\n      <%- partial('_partial/after_footer') %>\n    </body>\n   </html>\n<% } else if(page.layout=='categories'){ %>\n <%- partial('_partial/head') %>\n    <body>\n      <header>\n        <%- partial('_partial/header') %>\n      </header>\n      <div id=\"container\">\n          <%- partial('_partial/categories')%>\n      </div>\n      <footer><%- partial('_partial/footer') %></footer>\n      <%- partial('_partial/after_footer') %>\n    </body>\n   </html>\n<% } else if(page.category!=null||page.tag!=null||page.archive!=null) { %>\n  <%- partial('_partial/head') %>\n    <body>\n      <header>\n        <%- partial('_partial/header') %>\n      </header>\n      <div id=\"container\">\n        <%- body %>\n      </div>\n      <footer><%- partial('_partial/footer') %></footer>\n      <%- partial('_partial/after_footer') %>\n    </body>\n   </html>\n<% } else { %>\n <%- partial('_partial/head') %>\n  <body>\n    <header>\n      <%- partial('_partial/header') %>\n    </header>\n    <div id=\"container\">\n      <%- body %>\n      <%- partial('_partial/sidebar',{item: page,table: false}) %>\n    </div>\n    <footer><%- partial('_partial/footer') %></footer>\n    <%- partial('_partial/after_footer') %>\n    <a href=\"https://github.com/amao12580\"><img style=\"position: absolute; top: 0; right: 0; border: 0;\" src=\"https://camo.githubusercontent.com/38ef81f8aca64bb9a64448d0d70f1308ef5341ab/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f72696768745f6461726b626c75655f3132313632312e706e67\" alt=\"Fork me on GitHub\" data-canonical-src=\"https://s3.amazonaws.com/github/ribbons/forkme_right_darkblue_121621.png\"></a>\n  </body>\n </html>\n<% } %>\n```\nJacman主题页面尾部配置文件：D:\\GitHub\\Hexo\\themes\\jacman\\layout\\\\_partial\\footer.ejs\n```\n<div id=\"footer\" >\n    <% if(theme.author_img){ %>\n    <div class=\"line\">\n        <span></span>\n        <div class=\"author\"></div>\n    </div>\n    <%; } %>\n    <% if(theme.author.intro_line1 || theme.author.intro_line2){ %>\n    <section class=\"info\">\n        <p> <%= theme.author.intro_line1 %> <br/>\n            <%= theme.author.intro_line2 %></p>\n    </section>\n     <%; } %>\n    <div class=\"social-font\" class=\"clearfix\">\n        <% if(theme.author.weibo){ %>\n        <a href=\"http://weibo.com/<%= theme.author.weibo %>\" target=\"_blank\" class=\"icon-weibo\" title=\"微博\"></a>\n        <%; } %>\n        <% if(theme.author.github){ %>\n        <a href=\"https://github.com/<%=theme.author.github %>\" target=\"_blank\" class=\"icon-github\" title=\"github\"></a>\n        <%; } %>\n        <% if(theme.author.stackoverflow){ %>\n        <a href=\"http://stackoverflow.com/users/<%=theme.author.stackoverflow %>\" target=\"_blank\" class=\"icon-stack-overflow\" title=\"stackoverflow\"></a>\n        <%; } %>\n        <% if(theme.author.twitter){ %>\n        <a href=\"https://twitter.com/<%=theme.author.twitter %>\" target=\"_blank\" class=\"icon-twitter\" title=\"twitter\"></a>\n        <%; } %>\n        <% if(theme.author.facebook){ %>\n        <a href=\"https://www.facebook.com/<%=theme.author.facebook %>\" target=\"_blank\" class=\"icon-facebook\" title=\"facebook\"></a>\n        <%; } %>\n        <% if(theme.author.linkedin){ %>\n        <a href=\"https://www.linkedin.com/in/<%=theme.author.linkedin %>\" target=\"_blank\" class=\"icon-linkedin\" title=\"linkedin\"></a>\n        <%; } %>\n        <% if(theme.author.douban){ %>\n        <a href=\"https://www.douban.com/people/<%=theme.author.douban %>\" target=\"_blank\" class=\"icon-douban\" title=\"豆瓣\"></a>\n        <%; } %>\n        <% if(theme.author.zhihu){ %>\n        <a href=\"http://www.zhihu.com/people/<%=theme.author.zhihu %>\" target=\"_blank\" class=\"icon-zhihu\" title=\"知乎\"></a>\n        <%; } %>\n        <% if(theme.author.google_plus){ %>\n        <a href=\"https://plus.google.com/<%=theme.author.google_plus %>?rel=author\" target=\"_blank\" class=\"icon-google_plus\" title=\"Google+\"></a>\n        <%; } %>\n        <% if(theme.author.email){ %>\n        <a href=\"mailto:<%=theme.author.email %>\" target=\"_blank\" class=\"icon-email\" title=\"Email Me\"></a>\n        <%; } %>\n    </div>\n            <%  Array.prototype.S=String.fromCharCode(2);\n              Array.prototype.in_array=function(e){ var r=new RegExp(this.S+e+this.S); return (r.test(this.S+this.join(this.S)+this.S)); };\n                var cc = new Array('by','by-nc','by-nc-nd','by-nc-sa','by-nd','by-sa','zero'); %>\n        <% if (cc.in_array(theme.creative_commons) ) { %>\n                <div class=\"cc-license\">\n          <a href=\"http://creativecommons.org/licenses/<%= theme.creative_commons %>/4.0\" class=\"cc-opacity\" target=\"_blank\">\n            <img src=\"<%- config.root %>img/cc-<%= theme.creative_commons %>.svg\" alt=\"Creative Commons\" />\n          </a>\n        </div>\n    <%; } %>\n\n        <p class=\"copyright\">\n        © <%= new Date().getFullYear() %>\n        <% if (config.author) { %>\n        <a href=\"<%= config.root %>about\" target=\"_blank\" title=\"<%= config.author %>\"><%= config.author %></a>\n        <%; } else { %>\n        <a href=\"<%= config.url %>\" title=\"<%= config.title %>\"><%= config.title %></a>\n        <%; } %>\n\n        <!-- 不蒜子统计 -->\n<% if (theme.ibruce_tongji.enable){ %>\n<script async src=\"https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js\"></script>\n<span id=\"busuanzi_container_site_pv\" style='display:none'>\n本站总访问量<span id=\"busuanzi_value_site_pv\"></span>,本站访客数<span id=\"busuanzi_value_site_uv\"></span>，本文总阅读量<span id=\"busuanzi_value_page_pv\"></span>\n</span>\n<%; } %>\n        </p>\n</div>\n\n```\n\n### 2.7备份的重要性\n刚开始折腾时，经常出现改了很多配置，一运行就报错了，但是无法定位是哪些配置的改动导致的？\n幸好我用Sublime Text 3修改的，有历史记录，这点真是太赞了！给你要的[链接](http://pan.baidu.com/s/1pLnDKW7)，密码：3ook\n\nHexo配置好后，最好做一次网盘私密备份，以免主机故障丢失。而且有了备份，在家或在公司，都可以愉快的写blog啦！\n\n## 3.可能遇到的问题及答案\n1.hexo系列命令无法执行：\n```\nD:\\GitHub> hexo c\nUsage: hexo <command>\n\nCommands:\n  help     Get help on a command.\n  init     Create a new Hexo folder.\n  version  Display version information.\n\nGlobal Options:\n  --config  Specify config file instead of using _config.yml\n  --cwd     Specify the CWD\n  --debug   Display all verbose messages in the terminal\n  --draft   Display draft posts\n  --safe    Disable all plugins and scripts\n  --silent  Hide output on console\n\nFor more help, you can use 'hexo help [command]' for the detailed information\nor you can check the docs: http://hexo.io/docs/\n```\n\n解决：请切换目录到Hexo安装目录后再执行。这是因为Hexo没有全局环境配置的问题。\n```\n cd .\\Hexo\n```\n2.关于404页面的处理\n搜索很多关于404页面的资料，都是把配置好的404.html，每次在hexo g命令后手工放在hexo的public目录下。这样子有个缺点，每次都需要手工操作一次，这对于程序员来说是极其不人道的，我想到一个点子：\n```\n将404.html文件放在hexo的source目录下\n在hexod的全局配置文件:_config.yml，配置skip_render\nskip_render:\n  - README.md\n  - 404.htm\n```\n\n3.如何在文章中插入图片？\n```\n在Hexo的source文件夹下，建一个文件夹“img”\n将想要插入到文章的图片，放到img文件夹下，图片最好是png格式，文件小而且不变形\n使用示例：![图片的名字](/img/图片001.png)\n```\n\n4.如何在文章中插入代码段？\n将需要显示为代码段的内容，用\\`\\`\\`前后包裹住\n![](/img/代码段.png)\n\n显示的效果是：\n```\n代码段1\n代码段2\n```","source":"_posts/A-new-start.md","raw":"---\ntitle: '从零开始Blogging with Hexo教程'\ndate: 2016年3月21日11:16:03\ntags:\n    - GitHub\n    - Hexo\n    - Jacman\n    - Markdown\ncategories:\n    - Tutorial\ndescription: 刚开始折腾时，经常出现改了很多配置，一运行就报错了，但是无法定位是哪些配置的改动导致的？幸好我用Sublime Text 3修改的，有历史记录，这点真是太赞了！Hexo配置好后，最好做一次网盘私密备份，以免主机故障丢失。而且有了备份，在家或在公司，都可以愉快的写blog啦！\n---\n\n# 写在前面 #\n\n　　转眼间3月份也即将过去了，在接受了众多的理论输入以及实践之后，决定要将一些值得分享的事情记录下来，一方面是避免自己重复的掉坑，另一方面也希望通过blog的方式锻炼自己的文字能力。输入+沉淀+输出，形成自我知识攫取过程的闭环。\n\n　　下面记录从零开始的Blogging with Hexo的搭建过程，有一些简单的问题，在文末也会给出答案。\n\n## 1.你将要做什么？\n　　跟我一起在GiHub上搭建免费无限流量博客，不限速，有版本追溯管理。sadly，免费的背后是低层次的服务。搭建的博客服务器在国外，国内访问的速度没法保障，后文会给出一定的解决方案。内容的维护只能以静态Html的方式发布，意味着没有数据库，因此带来了幂等性，没有各种Web攻击，算作是一件好事？\n\n　　搭建过程中需要的技术：GitHub的使用、安装NodeJS、安装Hexo及系列插件、安装及配置Jacman主题、新文章的发布、Markdown的持续提高。\n### 1.1国内blog平台的现状\n国内的技术blog平台主要有：cnblogs、51cto、iteye、oschina、infoq等；排名没分先后，纯属个人想法。相信以上blogs，作为技术人，大家一定不陌生。平台型的blog，对个人的有利有弊，优势在于：免去软硬件维护管理的麻烦、不用担心流量和各种安全问题、；劣势也比较明显：内容版权、变现很困难、内容受限、内容面临下线风险\n\n引用[阮一峰先生的总结](http://www.ruanyifeng.com/blog/2012/08/blogging_with_jekyll.html)：\n\n1. 第一阶段，刚接触Blog，觉得很新鲜，试着选择一个免费空间来写。\n2. 第二阶段，发现免费空间限制太多，就自己购买域名和空间，搭建独立博客。\n3. 第三阶段，觉得独立博客的管理太麻烦，最好在保留控制权的前提下，让别人来管，自己只负责写文章。\n\n即技术人对于blog的核心需求是：发布文章、维护文章、随时控制、免去其他管理，也就是输出可控的文章。\n\n### 1.2如何选择适合自己的blog平台\n国内的blog平台少有让人长期安心逗留的，各种内容审查政策的强压，大环境的逐利性等因素，促使少有blog平台保持良心的同时持续改进其平台，在此不多言。\n我们希望发出的文章，可以进入一个技术人大都汇聚的环境中，以提高影响力。这样的环境可以是个人blog、blogs平台、微信平台等等。如果你有足够的影响力，也希望在作者与读者之间建立交流通道，常见的就是文章的评论回复功能了，其他的也有读者QQ群等社区型交流方式。引申的说，对于不怀好意的评论者，还需要一个评论审核的功能，甚至禁止评论，这都能在下文中得到解决。\n\n### 1.3为什么是Hexo？\n我们怎么评价Hexo？\n\n知乎：[jekyll vs Hexo](https://www.zhihu.com/question/19996679)\n## 2.如何做？\n### 2.1安装和配置NodeJS\n1. 确认你的配置是windows 7，虽然没有限制一定要windows，但是本教程基于windows。![我的系统环境](/img/计算机软硬件配置.png)。\n\n2. [安装NodeJS](http://www.runoob.com/nodejs/nodejs-install-setup.html)\n我的安装完成目录：\n\n![](/img/NodeJS安装完成.png)\n\n3. [解决npm安装模块慢或失败的问题](http://www.cnblogs.com/enix/p/3635343.html)\n```\nnpm config set registry=\"http://registry.npmjs.org\"//设置npm源地址\n```\n确认你的npm配置：\n\n![](/img/npm配置信息.png)\n\n### 2.2获取GitHub账号\nGitHub账号和GitHub Pages 一般都应该有吧，已有的请自动无视这一部分。\n### 2.2yourname.github.io\n* 首先注册一个『GitHub』帐号，已有的默认默认请忽略\n* 建立与你用户名对应的仓库，仓库名必须为『your_user_name.github.com』\n\n### 2.3安装和配置windows GitHub客户端\n不建议在[GitHub官网](https://desktop.github.com/)下载最新客户端，官网下载的客户端大小不到1MB，在本地运行还需要链接Amazon下载具体的安装包，因为国内网络环境，经常下载到一半就断掉.\n\n我个人试了各种方法不得解，最后找到了离线安装版：已存入百度云：链接：http://pan.baidu.com/s/1eRmoG6Y 密码：3vus\n\n因为版本控制工具比较耗系统资源，请尽量安装在非系统所在盘，尽量选择剩余容量大的盘。\n安装完成后，得到2个桌面图标：GitHub、Git Shell。前者是可视化版，后者是命令行版。\n\n我选择使用GitHub,打开后进行GitHub账号登录，第一次登录成功后，绑定邮箱会收到新邮件：[GitHub] A new public key was added to your account\n\n点击左上角“+”号，选择clone，选择自己的yourname.github.io。\n在下一步中选择存放文件夹，我的选择是：\n![](/img/github目录.png)\n\n简单的使用windows GitHub客户端\n\n```\n在对话框顶部有“No uncommitted changes”和“History”，点击后可以进行切换。\n在版本库所在的文件夹有了文件变化后，这里会有变化“28 uncommitted changes”和“History”，28是指的未提交的更改数量。\n填写Summary和Description后，可以进行本地提交：Commit to master。\n此时若还想提交到远程GitHub服务器，点击右上角“Sync”按钮进行同步。\n```\n\n### 2.4安装和配置Hexo\n\n安装和初始化Hexo\n```\n$ cd /d/\n$ mkdir hexo\n$ cd hexo\n$ npm install -g hexo\n$ hexo init\n$ hexo g # 或者hexo generate\n$ hexo s # 或者hexo server，可以在http://localhost:4000/查看\n```\n![](/img/hexo安装目录.png)\n\n安装\n```\n$ hexo clean\n$ git clone https://github.com/wuchong/jacman.git themes/jacman\n```\n![](/img/jacman主题安装目录.png)\n\n\n常用命令\n```\nhexo n \"我的博客\" == hexo new \"我的博客\" #新建文章\nhexo p == hexo publish\nhexo g == hexo generate#生成\nhexo s == hexo server #启动服务预览\nhexo d == hexo deploy#部署\n```\n\n部署文章到github.io\n```\nhexo clean\nhexo g\n拷贝Hexo文件夹下的public文件夹里的所有文件\n粘贴到yourname.github.io所在磁盘目录中，我的目录是：D:\\GitHub\\amao12580.github.io\n使用GitHub客户端进行提交到远程服务器\n打开yourname.github.io网址即可看到效果啦！\n```\n\n### 2.5为什么是Jacman?\n\n参见评价[Jacman基于Pacman修改的Hexo主题](http://wsgzao.github.io/post/hexo-jacman/)\n\n### 2.6私人定制\n在这里贴出我修改过的一些文件，很多修改都给出了备注。\n\nHexo主配置文件：D:\\GitHub\\Hexo\\\\_config.yml\n```\n# Hexo Configuration\n## Docs: https://hexo.io/docs/configuration.html\n## Source: https://github.com/hexojs/hexo/\n\n# Site\ntitle: Cat's Blog\nsubtitle: 一饮一啄，莫非前定.\n#为了更便于搜索引擎爬到，添加了网站的keywords\nkeywords: cat's,chengliang,amao12580,blog,developers\ndescription: Follw the https://xuanwo.org/2015/03/26/hexo-intor/\nauthor: Steven Cheng\nlanguage: zh-CN\ntimezone:\n\n# URL\n## If your site is put in a subdirectory, set url as 'http://yoursite.com/child' and root as '/child/'\nurl: http://amao12580.github.io\nroot: /\npermalink: post/:year/:month/:title/\npermalink_defaults:\n\n# Directory\nsource_dir: source\npublic_dir: public\ntag_dir: tags\nabout_dir: about\narchive_dir: archives\ncategory_dir: categories\ncode_dir: downloads/code\ni18n_dir: :lang\nskip_render:\n  - README.md\n  - 404.html\n\n# Writing\nnew_post_name: :title.md # File name of new posts\ndefault_layout: post\ntitlecase: false # Transform title into titlecase\nexternal_link: true # Open external links in new tab\nfilename_case: 0\nrender_drafts: false\npost_asset_folder: false\nrelative_link: false\nfuture: true\nhighlight:\n  enable: true\n  line_number: true\n  auto_detect: false\n  tab_replace:\n\n# Category & Tag\ndefault_category: uncategorized\ncategory_map:\ntag_map:\n\n# Date / Time format\n## Hexo uses Moment.js to parse and display date\n## You can customize the date format as defined in\n## http://momentjs.com/docs/#/displaying/format/\ndate_format: YYYY-MM-DD\ntime_format: HH:mm:ss\ndatetime_format: YYYY-MM-DD HH:mm:ss.SSS\n\n# Pagination\n## Set per_page to 0 to disable pagination\nper_page: 10\npagination_dir: page\n\n# Extensions\n## Plugins: https://hexo.io/plugins/\n## Themes: https://hexo.io/themes/\ntheme: jacman\nstylus:\n  compress: true\n\n# Deployment\n## Docs: https://hexo.io/docs/deployment.html\ndeploy:\n  type:\n\n\n# Others\nindex_generator:\n  per_page: 5 ##首页默认10篇文章标题 如果值为0不分页\n\narchive_generator:\n    per_page: 0 ##归档页面默认10篇文章标题\n    yearly: true  ##生成年视图\n    monthly: true ##生成月视图\n\ntag_generator:\n    per_page: 0 ##标签分类页面默认10篇文章\n\ncategory_generator:\n    per_page: 0 ###分类页面默认10篇文章\n\nfeed:\n    type: atom ##feed类型 atom或者rss2\n    path: atom.xml ##feed路径\n    limit: 20  ##feed文章最小数量\n\n#访问zipperary/sitemap.xml即可看到站点地图。不过，sitemap的初衷是给搜索引擎看的，为了提高搜索引擎对自己站点的收录效果，我们最好手动到google和百度等搜索引擎提交sitemap.xml。\n#sitemap\nsitemap:\n  - path: sitemap.xml\n\nbaidusitemap:\n - path: baidusitemap.xml\n```\n\nJacman主题的主配置文件：D:\\GitHub\\Hexo\\themes\\jacman\\ _config.yml\n```\n##### Menu\nmenu:\n  主页 | Home: /\n  索引 | Index: /index\n  归档 | Archives: /archives\n  简介 | About: /about\n## you can create `tags` and `categories` folders in `../source`.\n## And create a `index.md` file in each of them.\n## set `front-matter`as\n## layout: tags (or categories)\n## title: tags (or categories)\n## ---\n\n#### Widgets\nwidgets:\n- github-card\n- category\n- tag\n- links\n- douban\n- rss\n- weibo\n  ## provide eight widgets:github-card,category,tag,rss,archive,tagcloud,links,weibo\n\n\n\n#### RSS\nrss: /atom.xml ## RSS address.\n\n#### Image\nimglogo:\n  enable: true             ## display image logo true/false.\n  src: img/logo.png        ## `.svg` and `.png` are recommended,please put image into the theme folder `/jacman/source/img`.\nfavicon: img/favicon.ico   ## size:32px*32px,`.ico` is recommended,please put image into the theme folder `/jacman/source/img`.\napple_icon: img/jacman.jpg ## size:114px*114px,please put image into the theme folder `/jacman/source/img`.\nauthor_img: img/author.jpg ## size:220px*220px.display author avatar picture.if don't want to display,please don't set this.\nbanner_img: #img/banner.jpg ## size:1920px*200px+. Banner Picture\n### Theme Color\ntheme_color:\n    theme: '#2ca6cb'    ##the defaut theme color is blue\n\n# 代码高亮主题\n# available: default | night\nhighlight_theme: night\n\n#### index post is expanding or not\nindex:\n  expand: false           ## default is unexpanding,so you can only see the short description of each post.\n  excerpt_link: Read More\n\nclose_aside: true  #close sidebar in post page if true\nmathjax: true      #enable mathjax if true\n\n### Creative Commons License Support, see http://creativecommons.org/\n### you can choose: by , by-nc , by-nc-nd , by-nc-sa , by-nd , by-sa , zero\ncreative_commons: none\n\n#### Author information\nauthor:\n  intro_line1:  \"Hello ,I'm steven. This is my blog on GitHub.\"    ## your introduction on the bottom of the page\n  intro_line2:  \"Whenever you feel like criticizing any one, just remember that all the people in this world haven’t had the advantages that you’ve had.\"  ## the 2nd line\n  intro_line3: \"每当你觉得想要批评什么人的时候，你切要记着，这个世界上的人并非都具备你禀有的条件。《了不起的盖茨比》\"\n  weibo: 3201133445     ## e.g. wuchong1014 or 2176287895 for http://weibo.com/2176287895\n  weibo_verifier: b3593ceb    ## e.g. b3593ceb Your weibo-show widget verifier ,if you use weibo-show it is needed.\n  tsina:      ## e.g. 2176287895  Your weibo ID,It will be used in share button.\n  douban:     ## e.g. wuchong1014 or your id for https://www.douban.com/people/wuchong1014\n  zhihu:      ## e.g. jark  for http://www.zhihu.com/people/jark\n  email : chengliangchengliang888@gmail.com     ## e.g. imjark@gmail.com\n  twitter:    ## e.g. jarkwu for https://twitter.com/jarkwu\n  github: amao12580     ## e.g. wuchong for https://github.com/wuchong\n  facebook:   ## e.g. imjark for https://facebook.com/imjark\n  linkedin:   ## e.g. wuchong1014 for https://www.linkedin.com/in/wuchong1014\n  google_plus:    ## e.g. \"111190881341800841449\" for https://plus.google.com/u/0/111190881341800841449, the \"\" is needed!\n  stackoverflow:  ## e.g. 3222790 for http://stackoverflow.com/users/3222790/jark\n## if you set them, the corresponding  share button will show on the footer\n\n#### Toc\ntoc:\n  article: true   ## show contents in article.\n  aside: true     ## show contents in aside.\n## you can set both of the value to true of neither of them.\n## if you don't want display contents in a specified post,you can modify `front-matter` and add `toc: false`.\n\n#### Links\nlinks:\n  码农圈: https://coderq.com,一个面向程序员交流分享的新一代社区\n  Jark's Blog: http://wuchong.me\n  GitHub: https://github.com/amao12580\n\n\n\n#### Comment\nduoshuo_shortname: amao12580   ## e.g. wuchong   your duoshuo short name.\ndisqus_shortname:     ## e.g. wuchong   your disqus short name.\n\n#### Share button\njiathis:\n  enable: false ## if you use jiathis as your share tool,the built-in share tool won't be display.\n  id:    ## e.g. 1889330 your jiathis ID.\n  tsina: ## e.g. 2176287895 Your weibo id,It will be used in share button.\n\n#### Analytics\ngoogle_analytics:\n  enable: true\n  id: UA-75497011-1        ## e.g. UA-46321946-2 your google analytics ID.\n  site: http://amao12580.github.io      ## e.g. wuchong.me your google analytics site or set the value as auto.\n## You MUST upgrade to Universal Analytics first!\n## https://developers.google.com/analytics/devguides/collection/upgrade/?hl=zh_CN\nbaidu_tongji:\n  enable: true\n  sitecode: e6d1f421bbc9962127a50488f9ed37d1 ## e.g. e6d1f421bbc9962127a50488f9ed37d1 your baidu tongji site code\ncnzz_tongji:\n  enable: false\n  siteid:    ## e.g. 1253575964 your cnzz tongji site id\nibruce_tongji: # 不蒜子计数\n  enable: true\n\n#### Miscellaneous\nShowCustomFont: true  ## you can change custom font in `variable.styl` and `font.styl` which in the theme folder `/jacman/source/css`.\nfancybox: true        ## if you use gallery post or want use fancybox please set the value to true.\ntotop: true           ## if you want to scroll to top in every post set the value to true\n\n\n#### Custom Search\ngoogle_cse:\n  enable: false\n  cx:   ## e.g. 018294693190868310296:abnhpuysycw your Custom Search ID.\n## https://www.google.com/cse/\n## To enable the custom search You must create a \"search\" folder in '/source' and a \"index.md\" file\n## set the 'front-matter' as\n## layout: search\n## title: search\n## ---\nbaidu_search:     ## http://zn.baidu.com/\n  enable: false\n  id:   ## e.g. \"783281470518440642\"  for your baidu search id\n  site: http://zhannei.baidu.com/cse/search  ## your can change to your site instead of the default site\n\ntinysou_search:     ## http://tinysou.com/\n  enable: false\n  id:  ## e.g. \"4ac092ad8d749fdc6293\" for your tiny search id\n```\n\nJacman主题布局配置文件：D:\\GitHub\\Hexo\\themes\\jacman\\layout\\layout.ejs\n\n```\n<% if (page.layout=='post' || page.layout=='photo'){ %>\n <%- partial('_partial/head') %>\n  <body>\n    <header>\n      <%- partial('_partial/header') %>\n    </header>\n    <div id=\"container\">\n      <%- body %>\n      <%- partial('_partial/sidebar',{item: page,table: true}) %>\n    </div>\n    <footer><%- partial('_partial/footer') %></footer>\n    <%- partial('_partial/after_footer') %>\n  </body>\n</html>\n<% } else if(page.layout=='page'){ %>\n  <% if(page.source.match(/\\.md$/)){ %>\n    <%- partial('_partial/head') %>\n      <body>\n        <header>\n          <%- partial('_partial/header') %>\n        </header>\n        <div id=\"container\">\n          <%- body %>\n        </div>\n        <footer><%- partial('_partial/footer') %></footer>\n        <%- partial('_partial/after_footer') %>\n      </body>\n     </html>\n     <% }else{ %>\n    <%- page.content %>\n  <% } %>\n<% } else if(page.layout=='search'){ %>\n<%- partial('_partial/head') %>\n    <body>\n      <header>\n        <%- partial('_partial/header') %>\n      </header>\n      <div id=\"container\">\n        <%- partial('_partial/search')%>\n      </div>\n      <footer><%- partial('_partial/footer') %></footer>\n      <%- partial('_partial/after_footer') %>\n    </body>\n   </html>\n<% } else if(page.layout=='tags'){ %>\n <%- partial('_partial/head') %>\n    <body>\n      <header>\n        <%- partial('_partial/header') %>\n      </header>\n      <div id=\"container\">\n          <%- partial('_partial/tags')%>\n      </div>\n      <footer><%- partial('_partial/footer') %></footer>\n      <%- partial('_partial/after_footer') %>\n    </body>\n   </html>\n<% } else if(page.layout=='categories'){ %>\n <%- partial('_partial/head') %>\n    <body>\n      <header>\n        <%- partial('_partial/header') %>\n      </header>\n      <div id=\"container\">\n          <%- partial('_partial/categories')%>\n      </div>\n      <footer><%- partial('_partial/footer') %></footer>\n      <%- partial('_partial/after_footer') %>\n    </body>\n   </html>\n<% } else if(page.category!=null||page.tag!=null||page.archive!=null) { %>\n  <%- partial('_partial/head') %>\n    <body>\n      <header>\n        <%- partial('_partial/header') %>\n      </header>\n      <div id=\"container\">\n        <%- body %>\n      </div>\n      <footer><%- partial('_partial/footer') %></footer>\n      <%- partial('_partial/after_footer') %>\n    </body>\n   </html>\n<% } else { %>\n <%- partial('_partial/head') %>\n  <body>\n    <header>\n      <%- partial('_partial/header') %>\n    </header>\n    <div id=\"container\">\n      <%- body %>\n      <%- partial('_partial/sidebar',{item: page,table: false}) %>\n    </div>\n    <footer><%- partial('_partial/footer') %></footer>\n    <%- partial('_partial/after_footer') %>\n    <a href=\"https://github.com/amao12580\"><img style=\"position: absolute; top: 0; right: 0; border: 0;\" src=\"https://camo.githubusercontent.com/38ef81f8aca64bb9a64448d0d70f1308ef5341ab/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f72696768745f6461726b626c75655f3132313632312e706e67\" alt=\"Fork me on GitHub\" data-canonical-src=\"https://s3.amazonaws.com/github/ribbons/forkme_right_darkblue_121621.png\"></a>\n  </body>\n </html>\n<% } %>\n```\nJacman主题页面尾部配置文件：D:\\GitHub\\Hexo\\themes\\jacman\\layout\\\\_partial\\footer.ejs\n```\n<div id=\"footer\" >\n    <% if(theme.author_img){ %>\n    <div class=\"line\">\n        <span></span>\n        <div class=\"author\"></div>\n    </div>\n    <%; } %>\n    <% if(theme.author.intro_line1 || theme.author.intro_line2){ %>\n    <section class=\"info\">\n        <p> <%= theme.author.intro_line1 %> <br/>\n            <%= theme.author.intro_line2 %></p>\n    </section>\n     <%; } %>\n    <div class=\"social-font\" class=\"clearfix\">\n        <% if(theme.author.weibo){ %>\n        <a href=\"http://weibo.com/<%= theme.author.weibo %>\" target=\"_blank\" class=\"icon-weibo\" title=\"微博\"></a>\n        <%; } %>\n        <% if(theme.author.github){ %>\n        <a href=\"https://github.com/<%=theme.author.github %>\" target=\"_blank\" class=\"icon-github\" title=\"github\"></a>\n        <%; } %>\n        <% if(theme.author.stackoverflow){ %>\n        <a href=\"http://stackoverflow.com/users/<%=theme.author.stackoverflow %>\" target=\"_blank\" class=\"icon-stack-overflow\" title=\"stackoverflow\"></a>\n        <%; } %>\n        <% if(theme.author.twitter){ %>\n        <a href=\"https://twitter.com/<%=theme.author.twitter %>\" target=\"_blank\" class=\"icon-twitter\" title=\"twitter\"></a>\n        <%; } %>\n        <% if(theme.author.facebook){ %>\n        <a href=\"https://www.facebook.com/<%=theme.author.facebook %>\" target=\"_blank\" class=\"icon-facebook\" title=\"facebook\"></a>\n        <%; } %>\n        <% if(theme.author.linkedin){ %>\n        <a href=\"https://www.linkedin.com/in/<%=theme.author.linkedin %>\" target=\"_blank\" class=\"icon-linkedin\" title=\"linkedin\"></a>\n        <%; } %>\n        <% if(theme.author.douban){ %>\n        <a href=\"https://www.douban.com/people/<%=theme.author.douban %>\" target=\"_blank\" class=\"icon-douban\" title=\"豆瓣\"></a>\n        <%; } %>\n        <% if(theme.author.zhihu){ %>\n        <a href=\"http://www.zhihu.com/people/<%=theme.author.zhihu %>\" target=\"_blank\" class=\"icon-zhihu\" title=\"知乎\"></a>\n        <%; } %>\n        <% if(theme.author.google_plus){ %>\n        <a href=\"https://plus.google.com/<%=theme.author.google_plus %>?rel=author\" target=\"_blank\" class=\"icon-google_plus\" title=\"Google+\"></a>\n        <%; } %>\n        <% if(theme.author.email){ %>\n        <a href=\"mailto:<%=theme.author.email %>\" target=\"_blank\" class=\"icon-email\" title=\"Email Me\"></a>\n        <%; } %>\n    </div>\n            <%  Array.prototype.S=String.fromCharCode(2);\n              Array.prototype.in_array=function(e){ var r=new RegExp(this.S+e+this.S); return (r.test(this.S+this.join(this.S)+this.S)); };\n                var cc = new Array('by','by-nc','by-nc-nd','by-nc-sa','by-nd','by-sa','zero'); %>\n        <% if (cc.in_array(theme.creative_commons) ) { %>\n                <div class=\"cc-license\">\n          <a href=\"http://creativecommons.org/licenses/<%= theme.creative_commons %>/4.0\" class=\"cc-opacity\" target=\"_blank\">\n            <img src=\"<%- config.root %>img/cc-<%= theme.creative_commons %>.svg\" alt=\"Creative Commons\" />\n          </a>\n        </div>\n    <%; } %>\n\n        <p class=\"copyright\">\n        © <%= new Date().getFullYear() %>\n        <% if (config.author) { %>\n        <a href=\"<%= config.root %>about\" target=\"_blank\" title=\"<%= config.author %>\"><%= config.author %></a>\n        <%; } else { %>\n        <a href=\"<%= config.url %>\" title=\"<%= config.title %>\"><%= config.title %></a>\n        <%; } %>\n\n        <!-- 不蒜子统计 -->\n<% if (theme.ibruce_tongji.enable){ %>\n<script async src=\"https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js\"></script>\n<span id=\"busuanzi_container_site_pv\" style='display:none'>\n本站总访问量<span id=\"busuanzi_value_site_pv\"></span>,本站访客数<span id=\"busuanzi_value_site_uv\"></span>，本文总阅读量<span id=\"busuanzi_value_page_pv\"></span>\n</span>\n<%; } %>\n        </p>\n</div>\n\n```\n\n### 2.7备份的重要性\n刚开始折腾时，经常出现改了很多配置，一运行就报错了，但是无法定位是哪些配置的改动导致的？\n幸好我用Sublime Text 3修改的，有历史记录，这点真是太赞了！给你要的[链接](http://pan.baidu.com/s/1pLnDKW7)，密码：3ook\n\nHexo配置好后，最好做一次网盘私密备份，以免主机故障丢失。而且有了备份，在家或在公司，都可以愉快的写blog啦！\n\n## 3.可能遇到的问题及答案\n1.hexo系列命令无法执行：\n```\nD:\\GitHub> hexo c\nUsage: hexo <command>\n\nCommands:\n  help     Get help on a command.\n  init     Create a new Hexo folder.\n  version  Display version information.\n\nGlobal Options:\n  --config  Specify config file instead of using _config.yml\n  --cwd     Specify the CWD\n  --debug   Display all verbose messages in the terminal\n  --draft   Display draft posts\n  --safe    Disable all plugins and scripts\n  --silent  Hide output on console\n\nFor more help, you can use 'hexo help [command]' for the detailed information\nor you can check the docs: http://hexo.io/docs/\n```\n\n解决：请切换目录到Hexo安装目录后再执行。这是因为Hexo没有全局环境配置的问题。\n```\n cd .\\Hexo\n```\n2.关于404页面的处理\n搜索很多关于404页面的资料，都是把配置好的404.html，每次在hexo g命令后手工放在hexo的public目录下。这样子有个缺点，每次都需要手工操作一次，这对于程序员来说是极其不人道的，我想到一个点子：\n```\n将404.html文件放在hexo的source目录下\n在hexod的全局配置文件:_config.yml，配置skip_render\nskip_render:\n  - README.md\n  - 404.htm\n```\n\n3.如何在文章中插入图片？\n```\n在Hexo的source文件夹下，建一个文件夹“img”\n将想要插入到文章的图片，放到img文件夹下，图片最好是png格式，文件小而且不变形\n使用示例：![图片的名字](/img/图片001.png)\n```\n\n4.如何在文章中插入代码段？\n将需要显示为代码段的内容，用\\`\\`\\`前后包裹住\n![](/img/代码段.png)\n\n显示的效果是：\n```\n代码段1\n代码段2\n```","slug":"A-new-start","published":1,"updated":"2016-05-17T08:29:41.100Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ciowq3yts00004cnnj5rqbiku","content":"<h1 id=\"写在前面\"><a href=\"#写在前面\" class=\"headerlink\" title=\"写在前面\"></a>写在前面</h1><p>　　转眼间3月份也即将过去了，在接受了众多的理论输入以及实践之后，决定要将一些值得分享的事情记录下来，一方面是避免自己重复的掉坑，另一方面也希望通过blog的方式锻炼自己的文字能力。输入+沉淀+输出，形成自我知识攫取过程的闭环。</p>\n<p>　　下面记录从零开始的Blogging with Hexo的搭建过程，有一些简单的问题，在文末也会给出答案。</p>\n<h2 id=\"1-你将要做什么？\"><a href=\"#1-你将要做什么？\" class=\"headerlink\" title=\"1.你将要做什么？\"></a>1.你将要做什么？</h2><p>　　跟我一起在GiHub上搭建免费无限流量博客，不限速，有版本追溯管理。sadly，免费的背后是低层次的服务。搭建的博客服务器在国外，国内访问的速度没法保障，后文会给出一定的解决方案。内容的维护只能以静态Html的方式发布，意味着没有数据库，因此带来了幂等性，没有各种Web攻击，算作是一件好事？</p>\n<p>　　搭建过程中需要的技术：GitHub的使用、安装NodeJS、安装Hexo及系列插件、安装及配置Jacman主题、新文章的发布、Markdown的持续提高。</p>\n<h3 id=\"1-1国内blog平台的现状\"><a href=\"#1-1国内blog平台的现状\" class=\"headerlink\" title=\"1.1国内blog平台的现状\"></a>1.1国内blog平台的现状</h3><p>国内的技术blog平台主要有：cnblogs、51cto、iteye、oschina、infoq等；排名没分先后，纯属个人想法。相信以上blogs，作为技术人，大家一定不陌生。平台型的blog，对个人的有利有弊，优势在于：免去软硬件维护管理的麻烦、不用担心流量和各种安全问题、；劣势也比较明显：内容版权、变现很困难、内容受限、内容面临下线风险</p>\n<p>引用<a href=\"http://www.ruanyifeng.com/blog/2012/08/blogging_with_jekyll.html\" target=\"_blank\" rel=\"external\">阮一峰先生的总结</a>：</p>\n<ol>\n<li>第一阶段，刚接触Blog，觉得很新鲜，试着选择一个免费空间来写。</li>\n<li>第二阶段，发现免费空间限制太多，就自己购买域名和空间，搭建独立博客。</li>\n<li>第三阶段，觉得独立博客的管理太麻烦，最好在保留控制权的前提下，让别人来管，自己只负责写文章。</li>\n</ol>\n<p>即技术人对于blog的核心需求是：发布文章、维护文章、随时控制、免去其他管理，也就是输出可控的文章。</p>\n<h3 id=\"1-2如何选择适合自己的blog平台\"><a href=\"#1-2如何选择适合自己的blog平台\" class=\"headerlink\" title=\"1.2如何选择适合自己的blog平台\"></a>1.2如何选择适合自己的blog平台</h3><p>国内的blog平台少有让人长期安心逗留的，各种内容审查政策的强压，大环境的逐利性等因素，促使少有blog平台保持良心的同时持续改进其平台，在此不多言。<br>我们希望发出的文章，可以进入一个技术人大都汇聚的环境中，以提高影响力。这样的环境可以是个人blog、blogs平台、微信平台等等。如果你有足够的影响力，也希望在作者与读者之间建立交流通道，常见的就是文章的评论回复功能了，其他的也有读者QQ群等社区型交流方式。引申的说，对于不怀好意的评论者，还需要一个评论审核的功能，甚至禁止评论，这都能在下文中得到解决。</p>\n<h3 id=\"1-3为什么是Hexo？\"><a href=\"#1-3为什么是Hexo？\" class=\"headerlink\" title=\"1.3为什么是Hexo？\"></a>1.3为什么是Hexo？</h3><p>我们怎么评价Hexo？</p>\n<p>知乎：<a href=\"https://www.zhihu.com/question/19996679\" target=\"_blank\" rel=\"external\">jekyll vs Hexo</a></p>\n<h2 id=\"2-如何做？\"><a href=\"#2-如何做？\" class=\"headerlink\" title=\"2.如何做？\"></a>2.如何做？</h2><h3 id=\"2-1安装和配置NodeJS\"><a href=\"#2-1安装和配置NodeJS\" class=\"headerlink\" title=\"2.1安装和配置NodeJS\"></a>2.1安装和配置NodeJS</h3><ol>\n<li><p>确认你的配置是windows 7，虽然没有限制一定要windows，但是本教程基于windows。<img src=\"/img/计算机软硬件配置.png\" alt=\"我的系统环境\">。</p>\n</li>\n<li><p><a href=\"http://www.runoob.com/nodejs/nodejs-install-setup.html\" target=\"_blank\" rel=\"external\">安装NodeJS</a><br>我的安装完成目录：</p>\n</li>\n</ol>\n<p><img src=\"/img/NodeJS安装完成.png\" alt=\"\"></p>\n<ol>\n<li><a href=\"http://www.cnblogs.com/enix/p/3635343.html\" target=\"_blank\" rel=\"external\">解决npm安装模块慢或失败的问题</a><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">npm config set registry=&quot;http://registry.npmjs.org&quot;//设置npm源地址</span><br></pre></td></tr></table></figure>\n</li>\n</ol>\n<p>确认你的npm配置：</p>\n<p><img src=\"/img/npm配置信息.png\" alt=\"\"></p>\n<h3 id=\"2-2获取GitHub账号\"><a href=\"#2-2获取GitHub账号\" class=\"headerlink\" title=\"2.2获取GitHub账号\"></a>2.2获取GitHub账号</h3><p>GitHub账号和GitHub Pages 一般都应该有吧，已有的请自动无视这一部分。</p>\n<h3 id=\"2-2yourname-github-io\"><a href=\"#2-2yourname-github-io\" class=\"headerlink\" title=\"2.2yourname.github.io\"></a>2.2yourname.github.io</h3><ul>\n<li>首先注册一个『GitHub』帐号，已有的默认默认请忽略</li>\n<li>建立与你用户名对应的仓库，仓库名必须为『your_user_name.github.com』</li>\n</ul>\n<h3 id=\"2-3安装和配置windows-GitHub客户端\"><a href=\"#2-3安装和配置windows-GitHub客户端\" class=\"headerlink\" title=\"2.3安装和配置windows GitHub客户端\"></a>2.3安装和配置windows GitHub客户端</h3><p>不建议在<a href=\"https://desktop.github.com/\" target=\"_blank\" rel=\"external\">GitHub官网</a>下载最新客户端，官网下载的客户端大小不到1MB，在本地运行还需要链接Amazon下载具体的安装包，因为国内网络环境，经常下载到一半就断掉.</p>\n<p>我个人试了各种方法不得解，最后找到了离线安装版：已存入百度云：链接：<a href=\"http://pan.baidu.com/s/1eRmoG6Y\" target=\"_blank\" rel=\"external\">http://pan.baidu.com/s/1eRmoG6Y</a> 密码：3vus</p>\n<p>因为版本控制工具比较耗系统资源，请尽量安装在非系统所在盘，尽量选择剩余容量大的盘。<br>安装完成后，得到2个桌面图标：GitHub、Git Shell。前者是可视化版，后者是命令行版。</p>\n<p>我选择使用GitHub,打开后进行GitHub账号登录，第一次登录成功后，绑定邮箱会收到新邮件：[GitHub] A new public key was added to your account</p>\n<p>点击左上角“+”号，选择clone，选择自己的yourname.github.io。<br>在下一步中选择存放文件夹，我的选择是：<br><img src=\"/img/github目录.png\" alt=\"\"></p>\n<p>简单的使用windows GitHub客户端</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">在对话框顶部有“No uncommitted changes”和“History”，点击后可以进行切换。</span><br><span class=\"line\">在版本库所在的文件夹有了文件变化后，这里会有变化“28 uncommitted changes”和“History”，28是指的未提交的更改数量。</span><br><span class=\"line\">填写Summary和Description后，可以进行本地提交：Commit to master。</span><br><span class=\"line\">此时若还想提交到远程GitHub服务器，点击右上角“Sync”按钮进行同步。</span><br></pre></td></tr></table></figure>\n<h3 id=\"2-4安装和配置Hexo\"><a href=\"#2-4安装和配置Hexo\" class=\"headerlink\" title=\"2.4安装和配置Hexo\"></a>2.4安装和配置Hexo</h3><p>安装和初始化Hexo<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ cd /d/</span><br><span class=\"line\">$ mkdir hexo</span><br><span class=\"line\">$ cd hexo</span><br><span class=\"line\">$ npm install -g hexo</span><br><span class=\"line\">$ hexo init</span><br><span class=\"line\">$ hexo g # 或者hexo generate</span><br><span class=\"line\">$ hexo s # 或者hexo server，可以在http://localhost:4000/查看</span><br></pre></td></tr></table></figure></p>\n<p><img src=\"/img/hexo安装目录.png\" alt=\"\"></p>\n<p>安装<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ hexo clean</span><br><span class=\"line\">$ git clone https://github.com/wuchong/jacman.git themes/jacman</span><br></pre></td></tr></table></figure></p>\n<p><img src=\"/img/jacman主题安装目录.png\" alt=\"\"></p>\n<p>常用命令<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">hexo n &quot;我的博客&quot; == hexo new &quot;我的博客&quot; #新建文章</span><br><span class=\"line\">hexo p == hexo publish</span><br><span class=\"line\">hexo g == hexo generate#生成</span><br><span class=\"line\">hexo s == hexo server #启动服务预览</span><br><span class=\"line\">hexo d == hexo deploy#部署</span><br></pre></td></tr></table></figure></p>\n<p>部署文章到github.io<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">hexo clean</span><br><span class=\"line\">hexo g</span><br><span class=\"line\">拷贝Hexo文件夹下的public文件夹里的所有文件</span><br><span class=\"line\">粘贴到yourname.github.io所在磁盘目录中，我的目录是：D:\\GitHub\\amao12580.github.io</span><br><span class=\"line\">使用GitHub客户端进行提交到远程服务器</span><br><span class=\"line\">打开yourname.github.io网址即可看到效果啦！</span><br></pre></td></tr></table></figure></p>\n<h3 id=\"2-5为什么是Jacman\"><a href=\"#2-5为什么是Jacman\" class=\"headerlink\" title=\"2.5为什么是Jacman?\"></a>2.5为什么是Jacman?</h3><p>参见评价<a href=\"http://wsgzao.github.io/post/hexo-jacman/\" target=\"_blank\" rel=\"external\">Jacman基于Pacman修改的Hexo主题</a></p>\n<h3 id=\"2-6私人定制\"><a href=\"#2-6私人定制\" class=\"headerlink\" title=\"2.6私人定制\"></a>2.6私人定制</h3><p>在这里贴出我修改过的一些文件，很多修改都给出了备注。</p>\n<p>Hexo主配置文件：D:\\GitHub\\Hexo\\_config.yml<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># Hexo Configuration</span><br><span class=\"line\">## Docs: https://hexo.io/docs/configuration.html</span><br><span class=\"line\">## Source: https://github.com/hexojs/hexo/</span><br><span class=\"line\"></span><br><span class=\"line\"># Site</span><br><span class=\"line\">title: Cat&apos;s Blog</span><br><span class=\"line\">subtitle: 一饮一啄，莫非前定.</span><br><span class=\"line\">#为了更便于搜索引擎爬到，添加了网站的keywords</span><br><span class=\"line\">keywords: cat&apos;s,chengliang,amao12580,blog,developers</span><br><span class=\"line\">description: Follw the https://xuanwo.org/2015/03/26/hexo-intor/</span><br><span class=\"line\">author: Steven Cheng</span><br><span class=\"line\">language: zh-CN</span><br><span class=\"line\">timezone:</span><br><span class=\"line\"></span><br><span class=\"line\"># URL</span><br><span class=\"line\">## If your site is put in a subdirectory, set url as &apos;http://yoursite.com/child&apos; and root as &apos;/child/&apos;</span><br><span class=\"line\">url: http://amao12580.github.io</span><br><span class=\"line\">root: /</span><br><span class=\"line\">permalink: post/:year/:month/:title/</span><br><span class=\"line\">permalink_defaults:</span><br><span class=\"line\"></span><br><span class=\"line\"># Directory</span><br><span class=\"line\">source_dir: source</span><br><span class=\"line\">public_dir: public</span><br><span class=\"line\">tag_dir: tags</span><br><span class=\"line\">about_dir: about</span><br><span class=\"line\">archive_dir: archives</span><br><span class=\"line\">category_dir: categories</span><br><span class=\"line\">code_dir: downloads/code</span><br><span class=\"line\">i18n_dir: :lang</span><br><span class=\"line\">skip_render:</span><br><span class=\"line\">  - README.md</span><br><span class=\"line\">  - 404.html</span><br><span class=\"line\"></span><br><span class=\"line\"># Writing</span><br><span class=\"line\">new_post_name: :title.md # File name of new posts</span><br><span class=\"line\">default_layout: post</span><br><span class=\"line\">titlecase: false # Transform title into titlecase</span><br><span class=\"line\">external_link: true # Open external links in new tab</span><br><span class=\"line\">filename_case: 0</span><br><span class=\"line\">render_drafts: false</span><br><span class=\"line\">post_asset_folder: false</span><br><span class=\"line\">relative_link: false</span><br><span class=\"line\">future: true</span><br><span class=\"line\">highlight:</span><br><span class=\"line\">  enable: true</span><br><span class=\"line\">  line_number: true</span><br><span class=\"line\">  auto_detect: false</span><br><span class=\"line\">  tab_replace:</span><br><span class=\"line\"></span><br><span class=\"line\"># Category &amp; Tag</span><br><span class=\"line\">default_category: uncategorized</span><br><span class=\"line\">category_map:</span><br><span class=\"line\">tag_map:</span><br><span class=\"line\"></span><br><span class=\"line\"># Date / Time format</span><br><span class=\"line\">## Hexo uses Moment.js to parse and display date</span><br><span class=\"line\">## You can customize the date format as defined in</span><br><span class=\"line\">## http://momentjs.com/docs/#/displaying/format/</span><br><span class=\"line\">date_format: YYYY-MM-DD</span><br><span class=\"line\">time_format: HH:mm:ss</span><br><span class=\"line\">datetime_format: YYYY-MM-DD HH:mm:ss.SSS</span><br><span class=\"line\"></span><br><span class=\"line\"># Pagination</span><br><span class=\"line\">## Set per_page to 0 to disable pagination</span><br><span class=\"line\">per_page: 10</span><br><span class=\"line\">pagination_dir: page</span><br><span class=\"line\"></span><br><span class=\"line\"># Extensions</span><br><span class=\"line\">## Plugins: https://hexo.io/plugins/</span><br><span class=\"line\">## Themes: https://hexo.io/themes/</span><br><span class=\"line\">theme: jacman</span><br><span class=\"line\">stylus:</span><br><span class=\"line\">  compress: true</span><br><span class=\"line\"></span><br><span class=\"line\"># Deployment</span><br><span class=\"line\">## Docs: https://hexo.io/docs/deployment.html</span><br><span class=\"line\">deploy:</span><br><span class=\"line\">  type:</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># Others</span><br><span class=\"line\">index_generator:</span><br><span class=\"line\">  per_page: 5 ##首页默认10篇文章标题 如果值为0不分页</span><br><span class=\"line\"></span><br><span class=\"line\">archive_generator:</span><br><span class=\"line\">    per_page: 0 ##归档页面默认10篇文章标题</span><br><span class=\"line\">    yearly: true  ##生成年视图</span><br><span class=\"line\">    monthly: true ##生成月视图</span><br><span class=\"line\"></span><br><span class=\"line\">tag_generator:</span><br><span class=\"line\">    per_page: 0 ##标签分类页面默认10篇文章</span><br><span class=\"line\"></span><br><span class=\"line\">category_generator:</span><br><span class=\"line\">    per_page: 0 ###分类页面默认10篇文章</span><br><span class=\"line\"></span><br><span class=\"line\">feed:</span><br><span class=\"line\">    type: atom ##feed类型 atom或者rss2</span><br><span class=\"line\">    path: atom.xml ##feed路径</span><br><span class=\"line\">    limit: 20  ##feed文章最小数量</span><br><span class=\"line\"></span><br><span class=\"line\">#访问zipperary/sitemap.xml即可看到站点地图。不过，sitemap的初衷是给搜索引擎看的，为了提高搜索引擎对自己站点的收录效果，我们最好手动到google和百度等搜索引擎提交sitemap.xml。</span><br><span class=\"line\">#sitemap</span><br><span class=\"line\">sitemap:</span><br><span class=\"line\">  - path: sitemap.xml</span><br><span class=\"line\"></span><br><span class=\"line\">baidusitemap:</span><br><span class=\"line\"> - path: baidusitemap.xml</span><br></pre></td></tr></table></figure></p>\n<p>Jacman主题的主配置文件：D:\\GitHub\\Hexo\\themes\\jacman\\ _config.yml<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">##### Menu</span><br><span class=\"line\">menu:</span><br><span class=\"line\">  主页 | Home: /</span><br><span class=\"line\">  索引 | Index: /index</span><br><span class=\"line\">  归档 | Archives: /archives</span><br><span class=\"line\">  简介 | About: /about</span><br><span class=\"line\">## you can create `tags` and `categories` folders in `../source`.</span><br><span class=\"line\">## And create a `index.md` file in each of them.</span><br><span class=\"line\">## set `front-matter`as</span><br><span class=\"line\">## layout: tags (or categories)</span><br><span class=\"line\">## title: tags (or categories)</span><br><span class=\"line\">## ---</span><br><span class=\"line\"></span><br><span class=\"line\">#### Widgets</span><br><span class=\"line\">widgets:</span><br><span class=\"line\">- github-card</span><br><span class=\"line\">- category</span><br><span class=\"line\">- tag</span><br><span class=\"line\">- links</span><br><span class=\"line\">- douban</span><br><span class=\"line\">- rss</span><br><span class=\"line\">- weibo</span><br><span class=\"line\">  ## provide eight widgets:github-card,category,tag,rss,archive,tagcloud,links,weibo</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">#### RSS</span><br><span class=\"line\">rss: /atom.xml ## RSS address.</span><br><span class=\"line\"></span><br><span class=\"line\">#### Image</span><br><span class=\"line\">imglogo:</span><br><span class=\"line\">  enable: true             ## display image logo true/false.</span><br><span class=\"line\">  src: img/logo.png        ## `.svg` and `.png` are recommended,please put image into the theme folder `/jacman/source/img`.</span><br><span class=\"line\">favicon: img/favicon.ico   ## size:32px*32px,`.ico` is recommended,please put image into the theme folder `/jacman/source/img`.</span><br><span class=\"line\">apple_icon: img/jacman.jpg ## size:114px*114px,please put image into the theme folder `/jacman/source/img`.</span><br><span class=\"line\">author_img: img/author.jpg ## size:220px*220px.display author avatar picture.if don&apos;t want to display,please don&apos;t set this.</span><br><span class=\"line\">banner_img: #img/banner.jpg ## size:1920px*200px+. Banner Picture</span><br><span class=\"line\">### Theme Color</span><br><span class=\"line\">theme_color:</span><br><span class=\"line\">    theme: &apos;#2ca6cb&apos;    ##the defaut theme color is blue</span><br><span class=\"line\"></span><br><span class=\"line\"># 代码高亮主题</span><br><span class=\"line\"># available: default | night</span><br><span class=\"line\">highlight_theme: night</span><br><span class=\"line\"></span><br><span class=\"line\">#### index post is expanding or not</span><br><span class=\"line\">index:</span><br><span class=\"line\">  expand: false           ## default is unexpanding,so you can only see the short description of each post.</span><br><span class=\"line\">  excerpt_link: Read More</span><br><span class=\"line\"></span><br><span class=\"line\">close_aside: true  #close sidebar in post page if true</span><br><span class=\"line\">mathjax: true      #enable mathjax if true</span><br><span class=\"line\"></span><br><span class=\"line\">### Creative Commons License Support, see http://creativecommons.org/</span><br><span class=\"line\">### you can choose: by , by-nc , by-nc-nd , by-nc-sa , by-nd , by-sa , zero</span><br><span class=\"line\">creative_commons: none</span><br><span class=\"line\"></span><br><span class=\"line\">#### Author information</span><br><span class=\"line\">author:</span><br><span class=\"line\">  intro_line1:  &quot;Hello ,I&apos;m steven. This is my blog on GitHub.&quot;    ## your introduction on the bottom of the page</span><br><span class=\"line\">  intro_line2:  &quot;Whenever you feel like criticizing any one, just remember that all the people in this world haven’t had the advantages that you’ve had.&quot;  ## the 2nd line</span><br><span class=\"line\">  intro_line3: &quot;每当你觉得想要批评什么人的时候，你切要记着，这个世界上的人并非都具备你禀有的条件。《了不起的盖茨比》&quot;</span><br><span class=\"line\">  weibo: 3201133445     ## e.g. wuchong1014 or 2176287895 for http://weibo.com/2176287895</span><br><span class=\"line\">  weibo_verifier: b3593ceb    ## e.g. b3593ceb Your weibo-show widget verifier ,if you use weibo-show it is needed.</span><br><span class=\"line\">  tsina:      ## e.g. 2176287895  Your weibo ID,It will be used in share button.</span><br><span class=\"line\">  douban:     ## e.g. wuchong1014 or your id for https://www.douban.com/people/wuchong1014</span><br><span class=\"line\">  zhihu:      ## e.g. jark  for http://www.zhihu.com/people/jark</span><br><span class=\"line\">  email : chengliangchengliang888@gmail.com     ## e.g. imjark@gmail.com</span><br><span class=\"line\">  twitter:    ## e.g. jarkwu for https://twitter.com/jarkwu</span><br><span class=\"line\">  github: amao12580     ## e.g. wuchong for https://github.com/wuchong</span><br><span class=\"line\">  facebook:   ## e.g. imjark for https://facebook.com/imjark</span><br><span class=\"line\">  linkedin:   ## e.g. wuchong1014 for https://www.linkedin.com/in/wuchong1014</span><br><span class=\"line\">  google_plus:    ## e.g. &quot;111190881341800841449&quot; for https://plus.google.com/u/0/111190881341800841449, the &quot;&quot; is needed!</span><br><span class=\"line\">  stackoverflow:  ## e.g. 3222790 for http://stackoverflow.com/users/3222790/jark</span><br><span class=\"line\">## if you set them, the corresponding  share button will show on the footer</span><br><span class=\"line\"></span><br><span class=\"line\">#### Toc</span><br><span class=\"line\">toc:</span><br><span class=\"line\">  article: true   ## show contents in article.</span><br><span class=\"line\">  aside: true     ## show contents in aside.</span><br><span class=\"line\">## you can set both of the value to true of neither of them.</span><br><span class=\"line\">## if you don&apos;t want display contents in a specified post,you can modify `front-matter` and add `toc: false`.</span><br><span class=\"line\"></span><br><span class=\"line\">#### Links</span><br><span class=\"line\">links:</span><br><span class=\"line\">  码农圈: https://coderq.com,一个面向程序员交流分享的新一代社区</span><br><span class=\"line\">  Jark&apos;s Blog: http://wuchong.me</span><br><span class=\"line\">  GitHub: https://github.com/amao12580</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">#### Comment</span><br><span class=\"line\">duoshuo_shortname: amao12580   ## e.g. wuchong   your duoshuo short name.</span><br><span class=\"line\">disqus_shortname:     ## e.g. wuchong   your disqus short name.</span><br><span class=\"line\"></span><br><span class=\"line\">#### Share button</span><br><span class=\"line\">jiathis:</span><br><span class=\"line\">  enable: false ## if you use jiathis as your share tool,the built-in share tool won&apos;t be display.</span><br><span class=\"line\">  id:    ## e.g. 1889330 your jiathis ID.</span><br><span class=\"line\">  tsina: ## e.g. 2176287895 Your weibo id,It will be used in share button.</span><br><span class=\"line\"></span><br><span class=\"line\">#### Analytics</span><br><span class=\"line\">google_analytics:</span><br><span class=\"line\">  enable: true</span><br><span class=\"line\">  id: UA-75497011-1        ## e.g. UA-46321946-2 your google analytics ID.</span><br><span class=\"line\">  site: http://amao12580.github.io      ## e.g. wuchong.me your google analytics site or set the value as auto.</span><br><span class=\"line\">## You MUST upgrade to Universal Analytics first!</span><br><span class=\"line\">## https://developers.google.com/analytics/devguides/collection/upgrade/?hl=zh_CN</span><br><span class=\"line\">baidu_tongji:</span><br><span class=\"line\">  enable: true</span><br><span class=\"line\">  sitecode: e6d1f421bbc9962127a50488f9ed37d1 ## e.g. e6d1f421bbc9962127a50488f9ed37d1 your baidu tongji site code</span><br><span class=\"line\">cnzz_tongji:</span><br><span class=\"line\">  enable: false</span><br><span class=\"line\">  siteid:    ## e.g. 1253575964 your cnzz tongji site id</span><br><span class=\"line\">ibruce_tongji: # 不蒜子计数</span><br><span class=\"line\">  enable: true</span><br><span class=\"line\"></span><br><span class=\"line\">#### Miscellaneous</span><br><span class=\"line\">ShowCustomFont: true  ## you can change custom font in `variable.styl` and `font.styl` which in the theme folder `/jacman/source/css`.</span><br><span class=\"line\">fancybox: true        ## if you use gallery post or want use fancybox please set the value to true.</span><br><span class=\"line\">totop: true           ## if you want to scroll to top in every post set the value to true</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">#### Custom Search</span><br><span class=\"line\">google_cse:</span><br><span class=\"line\">  enable: false</span><br><span class=\"line\">  cx:   ## e.g. 018294693190868310296:abnhpuysycw your Custom Search ID.</span><br><span class=\"line\">## https://www.google.com/cse/</span><br><span class=\"line\">## To enable the custom search You must create a &quot;search&quot; folder in &apos;/source&apos; and a &quot;index.md&quot; file</span><br><span class=\"line\">## set the &apos;front-matter&apos; as</span><br><span class=\"line\">## layout: search</span><br><span class=\"line\">## title: search</span><br><span class=\"line\">## ---</span><br><span class=\"line\">baidu_search:     ## http://zn.baidu.com/</span><br><span class=\"line\">  enable: false</span><br><span class=\"line\">  id:   ## e.g. &quot;783281470518440642&quot;  for your baidu search id</span><br><span class=\"line\">  site: http://zhannei.baidu.com/cse/search  ## your can change to your site instead of the default site</span><br><span class=\"line\"></span><br><span class=\"line\">tinysou_search:     ## http://tinysou.com/</span><br><span class=\"line\">  enable: false</span><br><span class=\"line\">  id:  ## e.g. &quot;4ac092ad8d749fdc6293&quot; for your tiny search id</span><br></pre></td></tr></table></figure></p>\n<p>Jacman主题布局配置文件：D:\\GitHub\\Hexo\\themes\\jacman\\layout\\layout.ejs</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;% if (page.layout==&apos;post&apos; || page.layout==&apos;photo&apos;)&#123; %&gt;</span><br><span class=\"line\"> &lt;%- partial(&apos;_partial/head&apos;) %&gt;</span><br><span class=\"line\">  &lt;body&gt;</span><br><span class=\"line\">    &lt;header&gt;</span><br><span class=\"line\">      &lt;%- partial(&apos;_partial/header&apos;) %&gt;</span><br><span class=\"line\">    &lt;/header&gt;</span><br><span class=\"line\">    &lt;div id=&quot;container&quot;&gt;</span><br><span class=\"line\">      &lt;%- body %&gt;</span><br><span class=\"line\">      &lt;%- partial(&apos;_partial/sidebar&apos;,&#123;item: page,table: true&#125;) %&gt;</span><br><span class=\"line\">    &lt;/div&gt;</span><br><span class=\"line\">    &lt;footer&gt;&lt;%- partial(&apos;_partial/footer&apos;) %&gt;&lt;/footer&gt;</span><br><span class=\"line\">    &lt;%- partial(&apos;_partial/after_footer&apos;) %&gt;</span><br><span class=\"line\">  &lt;/body&gt;</span><br><span class=\"line\">&lt;/html&gt;</span><br><span class=\"line\">&lt;% &#125; else if(page.layout==&apos;page&apos;)&#123; %&gt;</span><br><span class=\"line\">  &lt;% if(page.source.match(/\\.md$/))&#123; %&gt;</span><br><span class=\"line\">    &lt;%- partial(&apos;_partial/head&apos;) %&gt;</span><br><span class=\"line\">      &lt;body&gt;</span><br><span class=\"line\">        &lt;header&gt;</span><br><span class=\"line\">          &lt;%- partial(&apos;_partial/header&apos;) %&gt;</span><br><span class=\"line\">        &lt;/header&gt;</span><br><span class=\"line\">        &lt;div id=&quot;container&quot;&gt;</span><br><span class=\"line\">          &lt;%- body %&gt;</span><br><span class=\"line\">        &lt;/div&gt;</span><br><span class=\"line\">        &lt;footer&gt;&lt;%- partial(&apos;_partial/footer&apos;) %&gt;&lt;/footer&gt;</span><br><span class=\"line\">        &lt;%- partial(&apos;_partial/after_footer&apos;) %&gt;</span><br><span class=\"line\">      &lt;/body&gt;</span><br><span class=\"line\">     &lt;/html&gt;</span><br><span class=\"line\">     &lt;% &#125;else&#123; %&gt;</span><br><span class=\"line\">    &lt;%- page.content %&gt;</span><br><span class=\"line\">  &lt;% &#125; %&gt;</span><br><span class=\"line\">&lt;% &#125; else if(page.layout==&apos;search&apos;)&#123; %&gt;</span><br><span class=\"line\">&lt;%- partial(&apos;_partial/head&apos;) %&gt;</span><br><span class=\"line\">    &lt;body&gt;</span><br><span class=\"line\">      &lt;header&gt;</span><br><span class=\"line\">        &lt;%- partial(&apos;_partial/header&apos;) %&gt;</span><br><span class=\"line\">      &lt;/header&gt;</span><br><span class=\"line\">      &lt;div id=&quot;container&quot;&gt;</span><br><span class=\"line\">        &lt;%- partial(&apos;_partial/search&apos;)%&gt;</span><br><span class=\"line\">      &lt;/div&gt;</span><br><span class=\"line\">      &lt;footer&gt;&lt;%- partial(&apos;_partial/footer&apos;) %&gt;&lt;/footer&gt;</span><br><span class=\"line\">      &lt;%- partial(&apos;_partial/after_footer&apos;) %&gt;</span><br><span class=\"line\">    &lt;/body&gt;</span><br><span class=\"line\">   &lt;/html&gt;</span><br><span class=\"line\">&lt;% &#125; else if(page.layout==&apos;tags&apos;)&#123; %&gt;</span><br><span class=\"line\"> &lt;%- partial(&apos;_partial/head&apos;) %&gt;</span><br><span class=\"line\">    &lt;body&gt;</span><br><span class=\"line\">      &lt;header&gt;</span><br><span class=\"line\">        &lt;%- partial(&apos;_partial/header&apos;) %&gt;</span><br><span class=\"line\">      &lt;/header&gt;</span><br><span class=\"line\">      &lt;div id=&quot;container&quot;&gt;</span><br><span class=\"line\">          &lt;%- partial(&apos;_partial/tags&apos;)%&gt;</span><br><span class=\"line\">      &lt;/div&gt;</span><br><span class=\"line\">      &lt;footer&gt;&lt;%- partial(&apos;_partial/footer&apos;) %&gt;&lt;/footer&gt;</span><br><span class=\"line\">      &lt;%- partial(&apos;_partial/after_footer&apos;) %&gt;</span><br><span class=\"line\">    &lt;/body&gt;</span><br><span class=\"line\">   &lt;/html&gt;</span><br><span class=\"line\">&lt;% &#125; else if(page.layout==&apos;categories&apos;)&#123; %&gt;</span><br><span class=\"line\"> &lt;%- partial(&apos;_partial/head&apos;) %&gt;</span><br><span class=\"line\">    &lt;body&gt;</span><br><span class=\"line\">      &lt;header&gt;</span><br><span class=\"line\">        &lt;%- partial(&apos;_partial/header&apos;) %&gt;</span><br><span class=\"line\">      &lt;/header&gt;</span><br><span class=\"line\">      &lt;div id=&quot;container&quot;&gt;</span><br><span class=\"line\">          &lt;%- partial(&apos;_partial/categories&apos;)%&gt;</span><br><span class=\"line\">      &lt;/div&gt;</span><br><span class=\"line\">      &lt;footer&gt;&lt;%- partial(&apos;_partial/footer&apos;) %&gt;&lt;/footer&gt;</span><br><span class=\"line\">      &lt;%- partial(&apos;_partial/after_footer&apos;) %&gt;</span><br><span class=\"line\">    &lt;/body&gt;</span><br><span class=\"line\">   &lt;/html&gt;</span><br><span class=\"line\">&lt;% &#125; else if(page.category!=null||page.tag!=null||page.archive!=null) &#123; %&gt;</span><br><span class=\"line\">  &lt;%- partial(&apos;_partial/head&apos;) %&gt;</span><br><span class=\"line\">    &lt;body&gt;</span><br><span class=\"line\">      &lt;header&gt;</span><br><span class=\"line\">        &lt;%- partial(&apos;_partial/header&apos;) %&gt;</span><br><span class=\"line\">      &lt;/header&gt;</span><br><span class=\"line\">      &lt;div id=&quot;container&quot;&gt;</span><br><span class=\"line\">        &lt;%- body %&gt;</span><br><span class=\"line\">      &lt;/div&gt;</span><br><span class=\"line\">      &lt;footer&gt;&lt;%- partial(&apos;_partial/footer&apos;) %&gt;&lt;/footer&gt;</span><br><span class=\"line\">      &lt;%- partial(&apos;_partial/after_footer&apos;) %&gt;</span><br><span class=\"line\">    &lt;/body&gt;</span><br><span class=\"line\">   &lt;/html&gt;</span><br><span class=\"line\">&lt;% &#125; else &#123; %&gt;</span><br><span class=\"line\"> &lt;%- partial(&apos;_partial/head&apos;) %&gt;</span><br><span class=\"line\">  &lt;body&gt;</span><br><span class=\"line\">    &lt;header&gt;</span><br><span class=\"line\">      &lt;%- partial(&apos;_partial/header&apos;) %&gt;</span><br><span class=\"line\">    &lt;/header&gt;</span><br><span class=\"line\">    &lt;div id=&quot;container&quot;&gt;</span><br><span class=\"line\">      &lt;%- body %&gt;</span><br><span class=\"line\">      &lt;%- partial(&apos;_partial/sidebar&apos;,&#123;item: page,table: false&#125;) %&gt;</span><br><span class=\"line\">    &lt;/div&gt;</span><br><span class=\"line\">    &lt;footer&gt;&lt;%- partial(&apos;_partial/footer&apos;) %&gt;&lt;/footer&gt;</span><br><span class=\"line\">    &lt;%- partial(&apos;_partial/after_footer&apos;) %&gt;</span><br><span class=\"line\">    &lt;a href=&quot;https://github.com/amao12580&quot;&gt;&lt;img style=&quot;position: absolute; top: 0; right: 0; border: 0;&quot; src=&quot;https://camo.githubusercontent.com/38ef81f8aca64bb9a64448d0d70f1308ef5341ab/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f72696768745f6461726b626c75655f3132313632312e706e67&quot; alt=&quot;Fork me on GitHub&quot; data-canonical-src=&quot;https://s3.amazonaws.com/github/ribbons/forkme_right_darkblue_121621.png&quot;&gt;&lt;/a&gt;</span><br><span class=\"line\">  &lt;/body&gt;</span><br><span class=\"line\"> &lt;/html&gt;</span><br><span class=\"line\">&lt;% &#125; %&gt;</span><br></pre></td></tr></table></figure>\n<p>Jacman主题页面尾部配置文件：D:\\GitHub\\Hexo\\themes\\jacman\\layout\\_partial\\footer.ejs<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;div id=&quot;footer&quot; &gt;</span><br><span class=\"line\">    &lt;% if(theme.author_img)&#123; %&gt;</span><br><span class=\"line\">    &lt;div class=&quot;line&quot;&gt;</span><br><span class=\"line\">        &lt;span&gt;&lt;/span&gt;</span><br><span class=\"line\">        &lt;div class=&quot;author&quot;&gt;&lt;/div&gt;</span><br><span class=\"line\">    &lt;/div&gt;</span><br><span class=\"line\">    &lt;%; &#125; %&gt;</span><br><span class=\"line\">    &lt;% if(theme.author.intro_line1 || theme.author.intro_line2)&#123; %&gt;</span><br><span class=\"line\">    &lt;section class=&quot;info&quot;&gt;</span><br><span class=\"line\">        &lt;p&gt; &lt;%= theme.author.intro_line1 %&gt; &lt;br/&gt;</span><br><span class=\"line\">            &lt;%= theme.author.intro_line2 %&gt;&lt;/p&gt;</span><br><span class=\"line\">    &lt;/section&gt;</span><br><span class=\"line\">     &lt;%; &#125; %&gt;</span><br><span class=\"line\">    &lt;div class=&quot;social-font&quot; class=&quot;clearfix&quot;&gt;</span><br><span class=\"line\">        &lt;% if(theme.author.weibo)&#123; %&gt;</span><br><span class=\"line\">        &lt;a href=&quot;http://weibo.com/&lt;%= theme.author.weibo %&gt;&quot; target=&quot;_blank&quot; class=&quot;icon-weibo&quot; title=&quot;微博&quot;&gt;&lt;/a&gt;</span><br><span class=\"line\">        &lt;%; &#125; %&gt;</span><br><span class=\"line\">        &lt;% if(theme.author.github)&#123; %&gt;</span><br><span class=\"line\">        &lt;a href=&quot;https://github.com/&lt;%=theme.author.github %&gt;&quot; target=&quot;_blank&quot; class=&quot;icon-github&quot; title=&quot;github&quot;&gt;&lt;/a&gt;</span><br><span class=\"line\">        &lt;%; &#125; %&gt;</span><br><span class=\"line\">        &lt;% if(theme.author.stackoverflow)&#123; %&gt;</span><br><span class=\"line\">        &lt;a href=&quot;http://stackoverflow.com/users/&lt;%=theme.author.stackoverflow %&gt;&quot; target=&quot;_blank&quot; class=&quot;icon-stack-overflow&quot; title=&quot;stackoverflow&quot;&gt;&lt;/a&gt;</span><br><span class=\"line\">        &lt;%; &#125; %&gt;</span><br><span class=\"line\">        &lt;% if(theme.author.twitter)&#123; %&gt;</span><br><span class=\"line\">        &lt;a href=&quot;https://twitter.com/&lt;%=theme.author.twitter %&gt;&quot; target=&quot;_blank&quot; class=&quot;icon-twitter&quot; title=&quot;twitter&quot;&gt;&lt;/a&gt;</span><br><span class=\"line\">        &lt;%; &#125; %&gt;</span><br><span class=\"line\">        &lt;% if(theme.author.facebook)&#123; %&gt;</span><br><span class=\"line\">        &lt;a href=&quot;https://www.facebook.com/&lt;%=theme.author.facebook %&gt;&quot; target=&quot;_blank&quot; class=&quot;icon-facebook&quot; title=&quot;facebook&quot;&gt;&lt;/a&gt;</span><br><span class=\"line\">        &lt;%; &#125; %&gt;</span><br><span class=\"line\">        &lt;% if(theme.author.linkedin)&#123; %&gt;</span><br><span class=\"line\">        &lt;a href=&quot;https://www.linkedin.com/in/&lt;%=theme.author.linkedin %&gt;&quot; target=&quot;_blank&quot; class=&quot;icon-linkedin&quot; title=&quot;linkedin&quot;&gt;&lt;/a&gt;</span><br><span class=\"line\">        &lt;%; &#125; %&gt;</span><br><span class=\"line\">        &lt;% if(theme.author.douban)&#123; %&gt;</span><br><span class=\"line\">        &lt;a href=&quot;https://www.douban.com/people/&lt;%=theme.author.douban %&gt;&quot; target=&quot;_blank&quot; class=&quot;icon-douban&quot; title=&quot;豆瓣&quot;&gt;&lt;/a&gt;</span><br><span class=\"line\">        &lt;%; &#125; %&gt;</span><br><span class=\"line\">        &lt;% if(theme.author.zhihu)&#123; %&gt;</span><br><span class=\"line\">        &lt;a href=&quot;http://www.zhihu.com/people/&lt;%=theme.author.zhihu %&gt;&quot; target=&quot;_blank&quot; class=&quot;icon-zhihu&quot; title=&quot;知乎&quot;&gt;&lt;/a&gt;</span><br><span class=\"line\">        &lt;%; &#125; %&gt;</span><br><span class=\"line\">        &lt;% if(theme.author.google_plus)&#123; %&gt;</span><br><span class=\"line\">        &lt;a href=&quot;https://plus.google.com/&lt;%=theme.author.google_plus %&gt;?rel=author&quot; target=&quot;_blank&quot; class=&quot;icon-google_plus&quot; title=&quot;Google+&quot;&gt;&lt;/a&gt;</span><br><span class=\"line\">        &lt;%; &#125; %&gt;</span><br><span class=\"line\">        &lt;% if(theme.author.email)&#123; %&gt;</span><br><span class=\"line\">        &lt;a href=&quot;mailto:&lt;%=theme.author.email %&gt;&quot; target=&quot;_blank&quot; class=&quot;icon-email&quot; title=&quot;Email Me&quot;&gt;&lt;/a&gt;</span><br><span class=\"line\">        &lt;%; &#125; %&gt;</span><br><span class=\"line\">    &lt;/div&gt;</span><br><span class=\"line\">            &lt;%  Array.prototype.S=String.fromCharCode(2);</span><br><span class=\"line\">              Array.prototype.in_array=function(e)&#123; var r=new RegExp(this.S+e+this.S); return (r.test(this.S+this.join(this.S)+this.S)); &#125;;</span><br><span class=\"line\">                var cc = new Array(&apos;by&apos;,&apos;by-nc&apos;,&apos;by-nc-nd&apos;,&apos;by-nc-sa&apos;,&apos;by-nd&apos;,&apos;by-sa&apos;,&apos;zero&apos;); %&gt;</span><br><span class=\"line\">        &lt;% if (cc.in_array(theme.creative_commons) ) &#123; %&gt;</span><br><span class=\"line\">                &lt;div class=&quot;cc-license&quot;&gt;</span><br><span class=\"line\">          &lt;a href=&quot;http://creativecommons.org/licenses/&lt;%= theme.creative_commons %&gt;/4.0&quot; class=&quot;cc-opacity&quot; target=&quot;_blank&quot;&gt;</span><br><span class=\"line\">            &lt;img src=&quot;&lt;%- config.root %&gt;img/cc-&lt;%= theme.creative_commons %&gt;.svg&quot; alt=&quot;Creative Commons&quot; /&gt;</span><br><span class=\"line\">          &lt;/a&gt;</span><br><span class=\"line\">        &lt;/div&gt;</span><br><span class=\"line\">    &lt;%; &#125; %&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">        &lt;p class=&quot;copyright&quot;&gt;</span><br><span class=\"line\">        © &lt;%= new Date().getFullYear() %&gt;</span><br><span class=\"line\">        &lt;% if (config.author) &#123; %&gt;</span><br><span class=\"line\">        &lt;a href=&quot;&lt;%= config.root %&gt;about&quot; target=&quot;_blank&quot; title=&quot;&lt;%= config.author %&gt;&quot;&gt;&lt;%= config.author %&gt;&lt;/a&gt;</span><br><span class=\"line\">        &lt;%; &#125; else &#123; %&gt;</span><br><span class=\"line\">        &lt;a href=&quot;&lt;%= config.url %&gt;&quot; title=&quot;&lt;%= config.title %&gt;&quot;&gt;&lt;%= config.title %&gt;&lt;/a&gt;</span><br><span class=\"line\">        &lt;%; &#125; %&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">        &lt;!-- 不蒜子统计 --&gt;</span><br><span class=\"line\">&lt;% if (theme.ibruce_tongji.enable)&#123; %&gt;</span><br><span class=\"line\">&lt;script async src=&quot;https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js&quot;&gt;&lt;/script&gt;</span><br><span class=\"line\">&lt;span id=&quot;busuanzi_container_site_pv&quot; style=&apos;display:none&apos;&gt;</span><br><span class=\"line\">本站总访问量&lt;span id=&quot;busuanzi_value_site_pv&quot;&gt;&lt;/span&gt;,本站访客数&lt;span id=&quot;busuanzi_value_site_uv&quot;&gt;&lt;/span&gt;，本文总阅读量&lt;span id=&quot;busuanzi_value_page_pv&quot;&gt;&lt;/span&gt;</span><br><span class=\"line\">&lt;/span&gt;</span><br><span class=\"line\">&lt;%; &#125; %&gt;</span><br><span class=\"line\">        &lt;/p&gt;</span><br><span class=\"line\">&lt;/div&gt;</span><br></pre></td></tr></table></figure></p>\n<h3 id=\"2-7备份的重要性\"><a href=\"#2-7备份的重要性\" class=\"headerlink\" title=\"2.7备份的重要性\"></a>2.7备份的重要性</h3><p>刚开始折腾时，经常出现改了很多配置，一运行就报错了，但是无法定位是哪些配置的改动导致的？<br>幸好我用Sublime Text 3修改的，有历史记录，这点真是太赞了！给你要的<a href=\"http://pan.baidu.com/s/1pLnDKW7\" target=\"_blank\" rel=\"external\">链接</a>，密码：3ook</p>\n<p>Hexo配置好后，最好做一次网盘私密备份，以免主机故障丢失。而且有了备份，在家或在公司，都可以愉快的写blog啦！</p>\n<h2 id=\"3-可能遇到的问题及答案\"><a href=\"#3-可能遇到的问题及答案\" class=\"headerlink\" title=\"3.可能遇到的问题及答案\"></a>3.可能遇到的问题及答案</h2><p>1.hexo系列命令无法执行：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">D:\\GitHub&gt; hexo c</span><br><span class=\"line\">Usage: hexo &lt;command&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">Commands:</span><br><span class=\"line\">  help     Get help on a command.</span><br><span class=\"line\">  init     Create a new Hexo folder.</span><br><span class=\"line\">  version  Display version information.</span><br><span class=\"line\"></span><br><span class=\"line\">Global Options:</span><br><span class=\"line\">  --config  Specify config file instead of using _config.yml</span><br><span class=\"line\">  --cwd     Specify the CWD</span><br><span class=\"line\">  --debug   Display all verbose messages in the terminal</span><br><span class=\"line\">  --draft   Display draft posts</span><br><span class=\"line\">  --safe    Disable all plugins and scripts</span><br><span class=\"line\">  --silent  Hide output on console</span><br><span class=\"line\"></span><br><span class=\"line\">For more help, you can use &apos;hexo help [command]&apos; for the detailed information</span><br><span class=\"line\">or you can check the docs: http://hexo.io/docs/</span><br></pre></td></tr></table></figure></p>\n<p>解决：请切换目录到Hexo安装目录后再执行。这是因为Hexo没有全局环境配置的问题。<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cd .\\Hexo</span><br></pre></td></tr></table></figure></p>\n<p>2.关于404页面的处理<br>搜索很多关于404页面的资料，都是把配置好的404.html，每次在hexo g命令后手工放在hexo的public目录下。这样子有个缺点，每次都需要手工操作一次，这对于程序员来说是极其不人道的，我想到一个点子：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">将404.html文件放在hexo的source目录下</span><br><span class=\"line\">在hexod的全局配置文件:_config.yml，配置skip_render</span><br><span class=\"line\">skip_render:</span><br><span class=\"line\">  - README.md</span><br><span class=\"line\">  - 404.htm</span><br></pre></td></tr></table></figure></p>\n<p>3.如何在文章中插入图片？<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">在Hexo的source文件夹下，建一个文件夹“img”</span><br><span class=\"line\">将想要插入到文章的图片，放到img文件夹下，图片最好是png格式，文件小而且不变形</span><br><span class=\"line\">使用示例：![图片的名字](/img/图片001.png)</span><br></pre></td></tr></table></figure></p>\n<p>4.如何在文章中插入代码段？<br>将需要显示为代码段的内容，用```前后包裹住<br><img src=\"/img/代码段.png\" alt=\"\"></p>\n<p>显示的效果是：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">代码段1</span><br><span class=\"line\">代码段2</span><br></pre></td></tr></table></figure></p>\n","excerpt":"","more":"<h1 id=\"写在前面\"><a href=\"#写在前面\" class=\"headerlink\" title=\"写在前面\"></a>写在前面</h1><p>　　转眼间3月份也即将过去了，在接受了众多的理论输入以及实践之后，决定要将一些值得分享的事情记录下来，一方面是避免自己重复的掉坑，另一方面也希望通过blog的方式锻炼自己的文字能力。输入+沉淀+输出，形成自我知识攫取过程的闭环。</p>\n<p>　　下面记录从零开始的Blogging with Hexo的搭建过程，有一些简单的问题，在文末也会给出答案。</p>\n<h2 id=\"1-你将要做什么？\"><a href=\"#1-你将要做什么？\" class=\"headerlink\" title=\"1.你将要做什么？\"></a>1.你将要做什么？</h2><p>　　跟我一起在GiHub上搭建免费无限流量博客，不限速，有版本追溯管理。sadly，免费的背后是低层次的服务。搭建的博客服务器在国外，国内访问的速度没法保障，后文会给出一定的解决方案。内容的维护只能以静态Html的方式发布，意味着没有数据库，因此带来了幂等性，没有各种Web攻击，算作是一件好事？</p>\n<p>　　搭建过程中需要的技术：GitHub的使用、安装NodeJS、安装Hexo及系列插件、安装及配置Jacman主题、新文章的发布、Markdown的持续提高。</p>\n<h3 id=\"1-1国内blog平台的现状\"><a href=\"#1-1国内blog平台的现状\" class=\"headerlink\" title=\"1.1国内blog平台的现状\"></a>1.1国内blog平台的现状</h3><p>国内的技术blog平台主要有：cnblogs、51cto、iteye、oschina、infoq等；排名没分先后，纯属个人想法。相信以上blogs，作为技术人，大家一定不陌生。平台型的blog，对个人的有利有弊，优势在于：免去软硬件维护管理的麻烦、不用担心流量和各种安全问题、；劣势也比较明显：内容版权、变现很困难、内容受限、内容面临下线风险</p>\n<p>引用<a href=\"http://www.ruanyifeng.com/blog/2012/08/blogging_with_jekyll.html\">阮一峰先生的总结</a>：</p>\n<ol>\n<li>第一阶段，刚接触Blog，觉得很新鲜，试着选择一个免费空间来写。</li>\n<li>第二阶段，发现免费空间限制太多，就自己购买域名和空间，搭建独立博客。</li>\n<li>第三阶段，觉得独立博客的管理太麻烦，最好在保留控制权的前提下，让别人来管，自己只负责写文章。</li>\n</ol>\n<p>即技术人对于blog的核心需求是：发布文章、维护文章、随时控制、免去其他管理，也就是输出可控的文章。</p>\n<h3 id=\"1-2如何选择适合自己的blog平台\"><a href=\"#1-2如何选择适合自己的blog平台\" class=\"headerlink\" title=\"1.2如何选择适合自己的blog平台\"></a>1.2如何选择适合自己的blog平台</h3><p>国内的blog平台少有让人长期安心逗留的，各种内容审查政策的强压，大环境的逐利性等因素，促使少有blog平台保持良心的同时持续改进其平台，在此不多言。<br>我们希望发出的文章，可以进入一个技术人大都汇聚的环境中，以提高影响力。这样的环境可以是个人blog、blogs平台、微信平台等等。如果你有足够的影响力，也希望在作者与读者之间建立交流通道，常见的就是文章的评论回复功能了，其他的也有读者QQ群等社区型交流方式。引申的说，对于不怀好意的评论者，还需要一个评论审核的功能，甚至禁止评论，这都能在下文中得到解决。</p>\n<h3 id=\"1-3为什么是Hexo？\"><a href=\"#1-3为什么是Hexo？\" class=\"headerlink\" title=\"1.3为什么是Hexo？\"></a>1.3为什么是Hexo？</h3><p>我们怎么评价Hexo？</p>\n<p>知乎：<a href=\"https://www.zhihu.com/question/19996679\">jekyll vs Hexo</a></p>\n<h2 id=\"2-如何做？\"><a href=\"#2-如何做？\" class=\"headerlink\" title=\"2.如何做？\"></a>2.如何做？</h2><h3 id=\"2-1安装和配置NodeJS\"><a href=\"#2-1安装和配置NodeJS\" class=\"headerlink\" title=\"2.1安装和配置NodeJS\"></a>2.1安装和配置NodeJS</h3><ol>\n<li><p>确认你的配置是windows 7，虽然没有限制一定要windows，但是本教程基于windows。<img src=\"/img/计算机软硬件配置.png\" alt=\"我的系统环境\">。</p>\n</li>\n<li><p><a href=\"http://www.runoob.com/nodejs/nodejs-install-setup.html\">安装NodeJS</a><br>我的安装完成目录：</p>\n</li>\n</ol>\n<p><img src=\"/img/NodeJS安装完成.png\" alt=\"\"></p>\n<ol>\n<li><a href=\"http://www.cnblogs.com/enix/p/3635343.html\">解决npm安装模块慢或失败的问题</a><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">npm config set registry=&quot;http://registry.npmjs.org&quot;//设置npm源地址</span><br></pre></td></tr></table></figure>\n</li>\n</ol>\n<p>确认你的npm配置：</p>\n<p><img src=\"/img/npm配置信息.png\" alt=\"\"></p>\n<h3 id=\"2-2获取GitHub账号\"><a href=\"#2-2获取GitHub账号\" class=\"headerlink\" title=\"2.2获取GitHub账号\"></a>2.2获取GitHub账号</h3><p>GitHub账号和GitHub Pages 一般都应该有吧，已有的请自动无视这一部分。</p>\n<h3 id=\"2-2yourname-github-io\"><a href=\"#2-2yourname-github-io\" class=\"headerlink\" title=\"2.2yourname.github.io\"></a>2.2yourname.github.io</h3><ul>\n<li>首先注册一个『GitHub』帐号，已有的默认默认请忽略</li>\n<li>建立与你用户名对应的仓库，仓库名必须为『your_user_name.github.com』</li>\n</ul>\n<h3 id=\"2-3安装和配置windows-GitHub客户端\"><a href=\"#2-3安装和配置windows-GitHub客户端\" class=\"headerlink\" title=\"2.3安装和配置windows GitHub客户端\"></a>2.3安装和配置windows GitHub客户端</h3><p>不建议在<a href=\"https://desktop.github.com/\">GitHub官网</a>下载最新客户端，官网下载的客户端大小不到1MB，在本地运行还需要链接Amazon下载具体的安装包，因为国内网络环境，经常下载到一半就断掉.</p>\n<p>我个人试了各种方法不得解，最后找到了离线安装版：已存入百度云：链接：<a href=\"http://pan.baidu.com/s/1eRmoG6Y\">http://pan.baidu.com/s/1eRmoG6Y</a> 密码：3vus</p>\n<p>因为版本控制工具比较耗系统资源，请尽量安装在非系统所在盘，尽量选择剩余容量大的盘。<br>安装完成后，得到2个桌面图标：GitHub、Git Shell。前者是可视化版，后者是命令行版。</p>\n<p>我选择使用GitHub,打开后进行GitHub账号登录，第一次登录成功后，绑定邮箱会收到新邮件：[GitHub] A new public key was added to your account</p>\n<p>点击左上角“+”号，选择clone，选择自己的yourname.github.io。<br>在下一步中选择存放文件夹，我的选择是：<br><img src=\"/img/github目录.png\" alt=\"\"></p>\n<p>简单的使用windows GitHub客户端</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">在对话框顶部有“No uncommitted changes”和“History”，点击后可以进行切换。</span><br><span class=\"line\">在版本库所在的文件夹有了文件变化后，这里会有变化“28 uncommitted changes”和“History”，28是指的未提交的更改数量。</span><br><span class=\"line\">填写Summary和Description后，可以进行本地提交：Commit to master。</span><br><span class=\"line\">此时若还想提交到远程GitHub服务器，点击右上角“Sync”按钮进行同步。</span><br></pre></td></tr></table></figure>\n<h3 id=\"2-4安装和配置Hexo\"><a href=\"#2-4安装和配置Hexo\" class=\"headerlink\" title=\"2.4安装和配置Hexo\"></a>2.4安装和配置Hexo</h3><p>安装和初始化Hexo<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ cd /d/</span><br><span class=\"line\">$ mkdir hexo</span><br><span class=\"line\">$ cd hexo</span><br><span class=\"line\">$ npm install -g hexo</span><br><span class=\"line\">$ hexo init</span><br><span class=\"line\">$ hexo g # 或者hexo generate</span><br><span class=\"line\">$ hexo s # 或者hexo server，可以在http://localhost:4000/查看</span><br></pre></td></tr></table></figure></p>\n<p><img src=\"/img/hexo安装目录.png\" alt=\"\"></p>\n<p>安装<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ hexo clean</span><br><span class=\"line\">$ git clone https://github.com/wuchong/jacman.git themes/jacman</span><br></pre></td></tr></table></figure></p>\n<p><img src=\"/img/jacman主题安装目录.png\" alt=\"\"></p>\n<p>常用命令<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">hexo n &quot;我的博客&quot; == hexo new &quot;我的博客&quot; #新建文章</span><br><span class=\"line\">hexo p == hexo publish</span><br><span class=\"line\">hexo g == hexo generate#生成</span><br><span class=\"line\">hexo s == hexo server #启动服务预览</span><br><span class=\"line\">hexo d == hexo deploy#部署</span><br></pre></td></tr></table></figure></p>\n<p>部署文章到github.io<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">hexo clean</span><br><span class=\"line\">hexo g</span><br><span class=\"line\">拷贝Hexo文件夹下的public文件夹里的所有文件</span><br><span class=\"line\">粘贴到yourname.github.io所在磁盘目录中，我的目录是：D:\\GitHub\\amao12580.github.io</span><br><span class=\"line\">使用GitHub客户端进行提交到远程服务器</span><br><span class=\"line\">打开yourname.github.io网址即可看到效果啦！</span><br></pre></td></tr></table></figure></p>\n<h3 id=\"2-5为什么是Jacman\"><a href=\"#2-5为什么是Jacman\" class=\"headerlink\" title=\"2.5为什么是Jacman?\"></a>2.5为什么是Jacman?</h3><p>参见评价<a href=\"http://wsgzao.github.io/post/hexo-jacman/\">Jacman基于Pacman修改的Hexo主题</a></p>\n<h3 id=\"2-6私人定制\"><a href=\"#2-6私人定制\" class=\"headerlink\" title=\"2.6私人定制\"></a>2.6私人定制</h3><p>在这里贴出我修改过的一些文件，很多修改都给出了备注。</p>\n<p>Hexo主配置文件：D:\\GitHub\\Hexo\\_config.yml<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># Hexo Configuration</span><br><span class=\"line\">## Docs: https://hexo.io/docs/configuration.html</span><br><span class=\"line\">## Source: https://github.com/hexojs/hexo/</span><br><span class=\"line\"></span><br><span class=\"line\"># Site</span><br><span class=\"line\">title: Cat&apos;s Blog</span><br><span class=\"line\">subtitle: 一饮一啄，莫非前定.</span><br><span class=\"line\">#为了更便于搜索引擎爬到，添加了网站的keywords</span><br><span class=\"line\">keywords: cat&apos;s,chengliang,amao12580,blog,developers</span><br><span class=\"line\">description: Follw the https://xuanwo.org/2015/03/26/hexo-intor/</span><br><span class=\"line\">author: Steven Cheng</span><br><span class=\"line\">language: zh-CN</span><br><span class=\"line\">timezone:</span><br><span class=\"line\"></span><br><span class=\"line\"># URL</span><br><span class=\"line\">## If your site is put in a subdirectory, set url as &apos;http://yoursite.com/child&apos; and root as &apos;/child/&apos;</span><br><span class=\"line\">url: http://amao12580.github.io</span><br><span class=\"line\">root: /</span><br><span class=\"line\">permalink: post/:year/:month/:title/</span><br><span class=\"line\">permalink_defaults:</span><br><span class=\"line\"></span><br><span class=\"line\"># Directory</span><br><span class=\"line\">source_dir: source</span><br><span class=\"line\">public_dir: public</span><br><span class=\"line\">tag_dir: tags</span><br><span class=\"line\">about_dir: about</span><br><span class=\"line\">archive_dir: archives</span><br><span class=\"line\">category_dir: categories</span><br><span class=\"line\">code_dir: downloads/code</span><br><span class=\"line\">i18n_dir: :lang</span><br><span class=\"line\">skip_render:</span><br><span class=\"line\">  - README.md</span><br><span class=\"line\">  - 404.html</span><br><span class=\"line\"></span><br><span class=\"line\"># Writing</span><br><span class=\"line\">new_post_name: :title.md # File name of new posts</span><br><span class=\"line\">default_layout: post</span><br><span class=\"line\">titlecase: false # Transform title into titlecase</span><br><span class=\"line\">external_link: true # Open external links in new tab</span><br><span class=\"line\">filename_case: 0</span><br><span class=\"line\">render_drafts: false</span><br><span class=\"line\">post_asset_folder: false</span><br><span class=\"line\">relative_link: false</span><br><span class=\"line\">future: true</span><br><span class=\"line\">highlight:</span><br><span class=\"line\">  enable: true</span><br><span class=\"line\">  line_number: true</span><br><span class=\"line\">  auto_detect: false</span><br><span class=\"line\">  tab_replace:</span><br><span class=\"line\"></span><br><span class=\"line\"># Category &amp; Tag</span><br><span class=\"line\">default_category: uncategorized</span><br><span class=\"line\">category_map:</span><br><span class=\"line\">tag_map:</span><br><span class=\"line\"></span><br><span class=\"line\"># Date / Time format</span><br><span class=\"line\">## Hexo uses Moment.js to parse and display date</span><br><span class=\"line\">## You can customize the date format as defined in</span><br><span class=\"line\">## http://momentjs.com/docs/#/displaying/format/</span><br><span class=\"line\">date_format: YYYY-MM-DD</span><br><span class=\"line\">time_format: HH:mm:ss</span><br><span class=\"line\">datetime_format: YYYY-MM-DD HH:mm:ss.SSS</span><br><span class=\"line\"></span><br><span class=\"line\"># Pagination</span><br><span class=\"line\">## Set per_page to 0 to disable pagination</span><br><span class=\"line\">per_page: 10</span><br><span class=\"line\">pagination_dir: page</span><br><span class=\"line\"></span><br><span class=\"line\"># Extensions</span><br><span class=\"line\">## Plugins: https://hexo.io/plugins/</span><br><span class=\"line\">## Themes: https://hexo.io/themes/</span><br><span class=\"line\">theme: jacman</span><br><span class=\"line\">stylus:</span><br><span class=\"line\">  compress: true</span><br><span class=\"line\"></span><br><span class=\"line\"># Deployment</span><br><span class=\"line\">## Docs: https://hexo.io/docs/deployment.html</span><br><span class=\"line\">deploy:</span><br><span class=\"line\">  type:</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># Others</span><br><span class=\"line\">index_generator:</span><br><span class=\"line\">  per_page: 5 ##首页默认10篇文章标题 如果值为0不分页</span><br><span class=\"line\"></span><br><span class=\"line\">archive_generator:</span><br><span class=\"line\">    per_page: 0 ##归档页面默认10篇文章标题</span><br><span class=\"line\">    yearly: true  ##生成年视图</span><br><span class=\"line\">    monthly: true ##生成月视图</span><br><span class=\"line\"></span><br><span class=\"line\">tag_generator:</span><br><span class=\"line\">    per_page: 0 ##标签分类页面默认10篇文章</span><br><span class=\"line\"></span><br><span class=\"line\">category_generator:</span><br><span class=\"line\">    per_page: 0 ###分类页面默认10篇文章</span><br><span class=\"line\"></span><br><span class=\"line\">feed:</span><br><span class=\"line\">    type: atom ##feed类型 atom或者rss2</span><br><span class=\"line\">    path: atom.xml ##feed路径</span><br><span class=\"line\">    limit: 20  ##feed文章最小数量</span><br><span class=\"line\"></span><br><span class=\"line\">#访问zipperary/sitemap.xml即可看到站点地图。不过，sitemap的初衷是给搜索引擎看的，为了提高搜索引擎对自己站点的收录效果，我们最好手动到google和百度等搜索引擎提交sitemap.xml。</span><br><span class=\"line\">#sitemap</span><br><span class=\"line\">sitemap:</span><br><span class=\"line\">  - path: sitemap.xml</span><br><span class=\"line\"></span><br><span class=\"line\">baidusitemap:</span><br><span class=\"line\"> - path: baidusitemap.xml</span><br></pre></td></tr></table></figure></p>\n<p>Jacman主题的主配置文件：D:\\GitHub\\Hexo\\themes\\jacman\\ _config.yml<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">##### Menu</span><br><span class=\"line\">menu:</span><br><span class=\"line\">  主页 | Home: /</span><br><span class=\"line\">  索引 | Index: /index</span><br><span class=\"line\">  归档 | Archives: /archives</span><br><span class=\"line\">  简介 | About: /about</span><br><span class=\"line\">## you can create `tags` and `categories` folders in `../source`.</span><br><span class=\"line\">## And create a `index.md` file in each of them.</span><br><span class=\"line\">## set `front-matter`as</span><br><span class=\"line\">## layout: tags (or categories)</span><br><span class=\"line\">## title: tags (or categories)</span><br><span class=\"line\">## ---</span><br><span class=\"line\"></span><br><span class=\"line\">#### Widgets</span><br><span class=\"line\">widgets:</span><br><span class=\"line\">- github-card</span><br><span class=\"line\">- category</span><br><span class=\"line\">- tag</span><br><span class=\"line\">- links</span><br><span class=\"line\">- douban</span><br><span class=\"line\">- rss</span><br><span class=\"line\">- weibo</span><br><span class=\"line\">  ## provide eight widgets:github-card,category,tag,rss,archive,tagcloud,links,weibo</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">#### RSS</span><br><span class=\"line\">rss: /atom.xml ## RSS address.</span><br><span class=\"line\"></span><br><span class=\"line\">#### Image</span><br><span class=\"line\">imglogo:</span><br><span class=\"line\">  enable: true             ## display image logo true/false.</span><br><span class=\"line\">  src: img/logo.png        ## `.svg` and `.png` are recommended,please put image into the theme folder `/jacman/source/img`.</span><br><span class=\"line\">favicon: img/favicon.ico   ## size:32px*32px,`.ico` is recommended,please put image into the theme folder `/jacman/source/img`.</span><br><span class=\"line\">apple_icon: img/jacman.jpg ## size:114px*114px,please put image into the theme folder `/jacman/source/img`.</span><br><span class=\"line\">author_img: img/author.jpg ## size:220px*220px.display author avatar picture.if don&apos;t want to display,please don&apos;t set this.</span><br><span class=\"line\">banner_img: #img/banner.jpg ## size:1920px*200px+. Banner Picture</span><br><span class=\"line\">### Theme Color</span><br><span class=\"line\">theme_color:</span><br><span class=\"line\">    theme: &apos;#2ca6cb&apos;    ##the defaut theme color is blue</span><br><span class=\"line\"></span><br><span class=\"line\"># 代码高亮主题</span><br><span class=\"line\"># available: default | night</span><br><span class=\"line\">highlight_theme: night</span><br><span class=\"line\"></span><br><span class=\"line\">#### index post is expanding or not</span><br><span class=\"line\">index:</span><br><span class=\"line\">  expand: false           ## default is unexpanding,so you can only see the short description of each post.</span><br><span class=\"line\">  excerpt_link: Read More</span><br><span class=\"line\"></span><br><span class=\"line\">close_aside: true  #close sidebar in post page if true</span><br><span class=\"line\">mathjax: true      #enable mathjax if true</span><br><span class=\"line\"></span><br><span class=\"line\">### Creative Commons License Support, see http://creativecommons.org/</span><br><span class=\"line\">### you can choose: by , by-nc , by-nc-nd , by-nc-sa , by-nd , by-sa , zero</span><br><span class=\"line\">creative_commons: none</span><br><span class=\"line\"></span><br><span class=\"line\">#### Author information</span><br><span class=\"line\">author:</span><br><span class=\"line\">  intro_line1:  &quot;Hello ,I&apos;m steven. This is my blog on GitHub.&quot;    ## your introduction on the bottom of the page</span><br><span class=\"line\">  intro_line2:  &quot;Whenever you feel like criticizing any one, just remember that all the people in this world haven’t had the advantages that you’ve had.&quot;  ## the 2nd line</span><br><span class=\"line\">  intro_line3: &quot;每当你觉得想要批评什么人的时候，你切要记着，这个世界上的人并非都具备你禀有的条件。《了不起的盖茨比》&quot;</span><br><span class=\"line\">  weibo: 3201133445     ## e.g. wuchong1014 or 2176287895 for http://weibo.com/2176287895</span><br><span class=\"line\">  weibo_verifier: b3593ceb    ## e.g. b3593ceb Your weibo-show widget verifier ,if you use weibo-show it is needed.</span><br><span class=\"line\">  tsina:      ## e.g. 2176287895  Your weibo ID,It will be used in share button.</span><br><span class=\"line\">  douban:     ## e.g. wuchong1014 or your id for https://www.douban.com/people/wuchong1014</span><br><span class=\"line\">  zhihu:      ## e.g. jark  for http://www.zhihu.com/people/jark</span><br><span class=\"line\">  email : chengliangchengliang888@gmail.com     ## e.g. imjark@gmail.com</span><br><span class=\"line\">  twitter:    ## e.g. jarkwu for https://twitter.com/jarkwu</span><br><span class=\"line\">  github: amao12580     ## e.g. wuchong for https://github.com/wuchong</span><br><span class=\"line\">  facebook:   ## e.g. imjark for https://facebook.com/imjark</span><br><span class=\"line\">  linkedin:   ## e.g. wuchong1014 for https://www.linkedin.com/in/wuchong1014</span><br><span class=\"line\">  google_plus:    ## e.g. &quot;111190881341800841449&quot; for https://plus.google.com/u/0/111190881341800841449, the &quot;&quot; is needed!</span><br><span class=\"line\">  stackoverflow:  ## e.g. 3222790 for http://stackoverflow.com/users/3222790/jark</span><br><span class=\"line\">## if you set them, the corresponding  share button will show on the footer</span><br><span class=\"line\"></span><br><span class=\"line\">#### Toc</span><br><span class=\"line\">toc:</span><br><span class=\"line\">  article: true   ## show contents in article.</span><br><span class=\"line\">  aside: true     ## show contents in aside.</span><br><span class=\"line\">## you can set both of the value to true of neither of them.</span><br><span class=\"line\">## if you don&apos;t want display contents in a specified post,you can modify `front-matter` and add `toc: false`.</span><br><span class=\"line\"></span><br><span class=\"line\">#### Links</span><br><span class=\"line\">links:</span><br><span class=\"line\">  码农圈: https://coderq.com,一个面向程序员交流分享的新一代社区</span><br><span class=\"line\">  Jark&apos;s Blog: http://wuchong.me</span><br><span class=\"line\">  GitHub: https://github.com/amao12580</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">#### Comment</span><br><span class=\"line\">duoshuo_shortname: amao12580   ## e.g. wuchong   your duoshuo short name.</span><br><span class=\"line\">disqus_shortname:     ## e.g. wuchong   your disqus short name.</span><br><span class=\"line\"></span><br><span class=\"line\">#### Share button</span><br><span class=\"line\">jiathis:</span><br><span class=\"line\">  enable: false ## if you use jiathis as your share tool,the built-in share tool won&apos;t be display.</span><br><span class=\"line\">  id:    ## e.g. 1889330 your jiathis ID.</span><br><span class=\"line\">  tsina: ## e.g. 2176287895 Your weibo id,It will be used in share button.</span><br><span class=\"line\"></span><br><span class=\"line\">#### Analytics</span><br><span class=\"line\">google_analytics:</span><br><span class=\"line\">  enable: true</span><br><span class=\"line\">  id: UA-75497011-1        ## e.g. UA-46321946-2 your google analytics ID.</span><br><span class=\"line\">  site: http://amao12580.github.io      ## e.g. wuchong.me your google analytics site or set the value as auto.</span><br><span class=\"line\">## You MUST upgrade to Universal Analytics first!</span><br><span class=\"line\">## https://developers.google.com/analytics/devguides/collection/upgrade/?hl=zh_CN</span><br><span class=\"line\">baidu_tongji:</span><br><span class=\"line\">  enable: true</span><br><span class=\"line\">  sitecode: e6d1f421bbc9962127a50488f9ed37d1 ## e.g. e6d1f421bbc9962127a50488f9ed37d1 your baidu tongji site code</span><br><span class=\"line\">cnzz_tongji:</span><br><span class=\"line\">  enable: false</span><br><span class=\"line\">  siteid:    ## e.g. 1253575964 your cnzz tongji site id</span><br><span class=\"line\">ibruce_tongji: # 不蒜子计数</span><br><span class=\"line\">  enable: true</span><br><span class=\"line\"></span><br><span class=\"line\">#### Miscellaneous</span><br><span class=\"line\">ShowCustomFont: true  ## you can change custom font in `variable.styl` and `font.styl` which in the theme folder `/jacman/source/css`.</span><br><span class=\"line\">fancybox: true        ## if you use gallery post or want use fancybox please set the value to true.</span><br><span class=\"line\">totop: true           ## if you want to scroll to top in every post set the value to true</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">#### Custom Search</span><br><span class=\"line\">google_cse:</span><br><span class=\"line\">  enable: false</span><br><span class=\"line\">  cx:   ## e.g. 018294693190868310296:abnhpuysycw your Custom Search ID.</span><br><span class=\"line\">## https://www.google.com/cse/</span><br><span class=\"line\">## To enable the custom search You must create a &quot;search&quot; folder in &apos;/source&apos; and a &quot;index.md&quot; file</span><br><span class=\"line\">## set the &apos;front-matter&apos; as</span><br><span class=\"line\">## layout: search</span><br><span class=\"line\">## title: search</span><br><span class=\"line\">## ---</span><br><span class=\"line\">baidu_search:     ## http://zn.baidu.com/</span><br><span class=\"line\">  enable: false</span><br><span class=\"line\">  id:   ## e.g. &quot;783281470518440642&quot;  for your baidu search id</span><br><span class=\"line\">  site: http://zhannei.baidu.com/cse/search  ## your can change to your site instead of the default site</span><br><span class=\"line\"></span><br><span class=\"line\">tinysou_search:     ## http://tinysou.com/</span><br><span class=\"line\">  enable: false</span><br><span class=\"line\">  id:  ## e.g. &quot;4ac092ad8d749fdc6293&quot; for your tiny search id</span><br></pre></td></tr></table></figure></p>\n<p>Jacman主题布局配置文件：D:\\GitHub\\Hexo\\themes\\jacman\\layout\\layout.ejs</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;% if (page.layout==&apos;post&apos; || page.layout==&apos;photo&apos;)&#123; %&gt;</span><br><span class=\"line\"> &lt;%- partial(&apos;_partial/head&apos;) %&gt;</span><br><span class=\"line\">  &lt;body&gt;</span><br><span class=\"line\">    &lt;header&gt;</span><br><span class=\"line\">      &lt;%- partial(&apos;_partial/header&apos;) %&gt;</span><br><span class=\"line\">    &lt;/header&gt;</span><br><span class=\"line\">    &lt;div id=&quot;container&quot;&gt;</span><br><span class=\"line\">      &lt;%- body %&gt;</span><br><span class=\"line\">      &lt;%- partial(&apos;_partial/sidebar&apos;,&#123;item: page,table: true&#125;) %&gt;</span><br><span class=\"line\">    &lt;/div&gt;</span><br><span class=\"line\">    &lt;footer&gt;&lt;%- partial(&apos;_partial/footer&apos;) %&gt;&lt;/footer&gt;</span><br><span class=\"line\">    &lt;%- partial(&apos;_partial/after_footer&apos;) %&gt;</span><br><span class=\"line\">  &lt;/body&gt;</span><br><span class=\"line\">&lt;/html&gt;</span><br><span class=\"line\">&lt;% &#125; else if(page.layout==&apos;page&apos;)&#123; %&gt;</span><br><span class=\"line\">  &lt;% if(page.source.match(/\\.md$/))&#123; %&gt;</span><br><span class=\"line\">    &lt;%- partial(&apos;_partial/head&apos;) %&gt;</span><br><span class=\"line\">      &lt;body&gt;</span><br><span class=\"line\">        &lt;header&gt;</span><br><span class=\"line\">          &lt;%- partial(&apos;_partial/header&apos;) %&gt;</span><br><span class=\"line\">        &lt;/header&gt;</span><br><span class=\"line\">        &lt;div id=&quot;container&quot;&gt;</span><br><span class=\"line\">          &lt;%- body %&gt;</span><br><span class=\"line\">        &lt;/div&gt;</span><br><span class=\"line\">        &lt;footer&gt;&lt;%- partial(&apos;_partial/footer&apos;) %&gt;&lt;/footer&gt;</span><br><span class=\"line\">        &lt;%- partial(&apos;_partial/after_footer&apos;) %&gt;</span><br><span class=\"line\">      &lt;/body&gt;</span><br><span class=\"line\">     &lt;/html&gt;</span><br><span class=\"line\">     &lt;% &#125;else&#123; %&gt;</span><br><span class=\"line\">    &lt;%- page.content %&gt;</span><br><span class=\"line\">  &lt;% &#125; %&gt;</span><br><span class=\"line\">&lt;% &#125; else if(page.layout==&apos;search&apos;)&#123; %&gt;</span><br><span class=\"line\">&lt;%- partial(&apos;_partial/head&apos;) %&gt;</span><br><span class=\"line\">    &lt;body&gt;</span><br><span class=\"line\">      &lt;header&gt;</span><br><span class=\"line\">        &lt;%- partial(&apos;_partial/header&apos;) %&gt;</span><br><span class=\"line\">      &lt;/header&gt;</span><br><span class=\"line\">      &lt;div id=&quot;container&quot;&gt;</span><br><span class=\"line\">        &lt;%- partial(&apos;_partial/search&apos;)%&gt;</span><br><span class=\"line\">      &lt;/div&gt;</span><br><span class=\"line\">      &lt;footer&gt;&lt;%- partial(&apos;_partial/footer&apos;) %&gt;&lt;/footer&gt;</span><br><span class=\"line\">      &lt;%- partial(&apos;_partial/after_footer&apos;) %&gt;</span><br><span class=\"line\">    &lt;/body&gt;</span><br><span class=\"line\">   &lt;/html&gt;</span><br><span class=\"line\">&lt;% &#125; else if(page.layout==&apos;tags&apos;)&#123; %&gt;</span><br><span class=\"line\"> &lt;%- partial(&apos;_partial/head&apos;) %&gt;</span><br><span class=\"line\">    &lt;body&gt;</span><br><span class=\"line\">      &lt;header&gt;</span><br><span class=\"line\">        &lt;%- partial(&apos;_partial/header&apos;) %&gt;</span><br><span class=\"line\">      &lt;/header&gt;</span><br><span class=\"line\">      &lt;div id=&quot;container&quot;&gt;</span><br><span class=\"line\">          &lt;%- partial(&apos;_partial/tags&apos;)%&gt;</span><br><span class=\"line\">      &lt;/div&gt;</span><br><span class=\"line\">      &lt;footer&gt;&lt;%- partial(&apos;_partial/footer&apos;) %&gt;&lt;/footer&gt;</span><br><span class=\"line\">      &lt;%- partial(&apos;_partial/after_footer&apos;) %&gt;</span><br><span class=\"line\">    &lt;/body&gt;</span><br><span class=\"line\">   &lt;/html&gt;</span><br><span class=\"line\">&lt;% &#125; else if(page.layout==&apos;categories&apos;)&#123; %&gt;</span><br><span class=\"line\"> &lt;%- partial(&apos;_partial/head&apos;) %&gt;</span><br><span class=\"line\">    &lt;body&gt;</span><br><span class=\"line\">      &lt;header&gt;</span><br><span class=\"line\">        &lt;%- partial(&apos;_partial/header&apos;) %&gt;</span><br><span class=\"line\">      &lt;/header&gt;</span><br><span class=\"line\">      &lt;div id=&quot;container&quot;&gt;</span><br><span class=\"line\">          &lt;%- partial(&apos;_partial/categories&apos;)%&gt;</span><br><span class=\"line\">      &lt;/div&gt;</span><br><span class=\"line\">      &lt;footer&gt;&lt;%- partial(&apos;_partial/footer&apos;) %&gt;&lt;/footer&gt;</span><br><span class=\"line\">      &lt;%- partial(&apos;_partial/after_footer&apos;) %&gt;</span><br><span class=\"line\">    &lt;/body&gt;</span><br><span class=\"line\">   &lt;/html&gt;</span><br><span class=\"line\">&lt;% &#125; else if(page.category!=null||page.tag!=null||page.archive!=null) &#123; %&gt;</span><br><span class=\"line\">  &lt;%- partial(&apos;_partial/head&apos;) %&gt;</span><br><span class=\"line\">    &lt;body&gt;</span><br><span class=\"line\">      &lt;header&gt;</span><br><span class=\"line\">        &lt;%- partial(&apos;_partial/header&apos;) %&gt;</span><br><span class=\"line\">      &lt;/header&gt;</span><br><span class=\"line\">      &lt;div id=&quot;container&quot;&gt;</span><br><span class=\"line\">        &lt;%- body %&gt;</span><br><span class=\"line\">      &lt;/div&gt;</span><br><span class=\"line\">      &lt;footer&gt;&lt;%- partial(&apos;_partial/footer&apos;) %&gt;&lt;/footer&gt;</span><br><span class=\"line\">      &lt;%- partial(&apos;_partial/after_footer&apos;) %&gt;</span><br><span class=\"line\">    &lt;/body&gt;</span><br><span class=\"line\">   &lt;/html&gt;</span><br><span class=\"line\">&lt;% &#125; else &#123; %&gt;</span><br><span class=\"line\"> &lt;%- partial(&apos;_partial/head&apos;) %&gt;</span><br><span class=\"line\">  &lt;body&gt;</span><br><span class=\"line\">    &lt;header&gt;</span><br><span class=\"line\">      &lt;%- partial(&apos;_partial/header&apos;) %&gt;</span><br><span class=\"line\">    &lt;/header&gt;</span><br><span class=\"line\">    &lt;div id=&quot;container&quot;&gt;</span><br><span class=\"line\">      &lt;%- body %&gt;</span><br><span class=\"line\">      &lt;%- partial(&apos;_partial/sidebar&apos;,&#123;item: page,table: false&#125;) %&gt;</span><br><span class=\"line\">    &lt;/div&gt;</span><br><span class=\"line\">    &lt;footer&gt;&lt;%- partial(&apos;_partial/footer&apos;) %&gt;&lt;/footer&gt;</span><br><span class=\"line\">    &lt;%- partial(&apos;_partial/after_footer&apos;) %&gt;</span><br><span class=\"line\">    &lt;a href=&quot;https://github.com/amao12580&quot;&gt;&lt;img style=&quot;position: absolute; top: 0; right: 0; border: 0;&quot; src=&quot;https://camo.githubusercontent.com/38ef81f8aca64bb9a64448d0d70f1308ef5341ab/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f72696768745f6461726b626c75655f3132313632312e706e67&quot; alt=&quot;Fork me on GitHub&quot; data-canonical-src=&quot;https://s3.amazonaws.com/github/ribbons/forkme_right_darkblue_121621.png&quot;&gt;&lt;/a&gt;</span><br><span class=\"line\">  &lt;/body&gt;</span><br><span class=\"line\"> &lt;/html&gt;</span><br><span class=\"line\">&lt;% &#125; %&gt;</span><br></pre></td></tr></table></figure>\n<p>Jacman主题页面尾部配置文件：D:\\GitHub\\Hexo\\themes\\jacman\\layout\\_partial\\footer.ejs<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;div id=&quot;footer&quot; &gt;</span><br><span class=\"line\">    &lt;% if(theme.author_img)&#123; %&gt;</span><br><span class=\"line\">    &lt;div class=&quot;line&quot;&gt;</span><br><span class=\"line\">        &lt;span&gt;&lt;/span&gt;</span><br><span class=\"line\">        &lt;div class=&quot;author&quot;&gt;&lt;/div&gt;</span><br><span class=\"line\">    &lt;/div&gt;</span><br><span class=\"line\">    &lt;%; &#125; %&gt;</span><br><span class=\"line\">    &lt;% if(theme.author.intro_line1 || theme.author.intro_line2)&#123; %&gt;</span><br><span class=\"line\">    &lt;section class=&quot;info&quot;&gt;</span><br><span class=\"line\">        &lt;p&gt; &lt;%= theme.author.intro_line1 %&gt; &lt;br/&gt;</span><br><span class=\"line\">            &lt;%= theme.author.intro_line2 %&gt;&lt;/p&gt;</span><br><span class=\"line\">    &lt;/section&gt;</span><br><span class=\"line\">     &lt;%; &#125; %&gt;</span><br><span class=\"line\">    &lt;div class=&quot;social-font&quot; class=&quot;clearfix&quot;&gt;</span><br><span class=\"line\">        &lt;% if(theme.author.weibo)&#123; %&gt;</span><br><span class=\"line\">        &lt;a href=&quot;http://weibo.com/&lt;%= theme.author.weibo %&gt;&quot; target=&quot;_blank&quot; class=&quot;icon-weibo&quot; title=&quot;微博&quot;&gt;&lt;/a&gt;</span><br><span class=\"line\">        &lt;%; &#125; %&gt;</span><br><span class=\"line\">        &lt;% if(theme.author.github)&#123; %&gt;</span><br><span class=\"line\">        &lt;a href=&quot;https://github.com/&lt;%=theme.author.github %&gt;&quot; target=&quot;_blank&quot; class=&quot;icon-github&quot; title=&quot;github&quot;&gt;&lt;/a&gt;</span><br><span class=\"line\">        &lt;%; &#125; %&gt;</span><br><span class=\"line\">        &lt;% if(theme.author.stackoverflow)&#123; %&gt;</span><br><span class=\"line\">        &lt;a href=&quot;http://stackoverflow.com/users/&lt;%=theme.author.stackoverflow %&gt;&quot; target=&quot;_blank&quot; class=&quot;icon-stack-overflow&quot; title=&quot;stackoverflow&quot;&gt;&lt;/a&gt;</span><br><span class=\"line\">        &lt;%; &#125; %&gt;</span><br><span class=\"line\">        &lt;% if(theme.author.twitter)&#123; %&gt;</span><br><span class=\"line\">        &lt;a href=&quot;https://twitter.com/&lt;%=theme.author.twitter %&gt;&quot; target=&quot;_blank&quot; class=&quot;icon-twitter&quot; title=&quot;twitter&quot;&gt;&lt;/a&gt;</span><br><span class=\"line\">        &lt;%; &#125; %&gt;</span><br><span class=\"line\">        &lt;% if(theme.author.facebook)&#123; %&gt;</span><br><span class=\"line\">        &lt;a href=&quot;https://www.facebook.com/&lt;%=theme.author.facebook %&gt;&quot; target=&quot;_blank&quot; class=&quot;icon-facebook&quot; title=&quot;facebook&quot;&gt;&lt;/a&gt;</span><br><span class=\"line\">        &lt;%; &#125; %&gt;</span><br><span class=\"line\">        &lt;% if(theme.author.linkedin)&#123; %&gt;</span><br><span class=\"line\">        &lt;a href=&quot;https://www.linkedin.com/in/&lt;%=theme.author.linkedin %&gt;&quot; target=&quot;_blank&quot; class=&quot;icon-linkedin&quot; title=&quot;linkedin&quot;&gt;&lt;/a&gt;</span><br><span class=\"line\">        &lt;%; &#125; %&gt;</span><br><span class=\"line\">        &lt;% if(theme.author.douban)&#123; %&gt;</span><br><span class=\"line\">        &lt;a href=&quot;https://www.douban.com/people/&lt;%=theme.author.douban %&gt;&quot; target=&quot;_blank&quot; class=&quot;icon-douban&quot; title=&quot;豆瓣&quot;&gt;&lt;/a&gt;</span><br><span class=\"line\">        &lt;%; &#125; %&gt;</span><br><span class=\"line\">        &lt;% if(theme.author.zhihu)&#123; %&gt;</span><br><span class=\"line\">        &lt;a href=&quot;http://www.zhihu.com/people/&lt;%=theme.author.zhihu %&gt;&quot; target=&quot;_blank&quot; class=&quot;icon-zhihu&quot; title=&quot;知乎&quot;&gt;&lt;/a&gt;</span><br><span class=\"line\">        &lt;%; &#125; %&gt;</span><br><span class=\"line\">        &lt;% if(theme.author.google_plus)&#123; %&gt;</span><br><span class=\"line\">        &lt;a href=&quot;https://plus.google.com/&lt;%=theme.author.google_plus %&gt;?rel=author&quot; target=&quot;_blank&quot; class=&quot;icon-google_plus&quot; title=&quot;Google+&quot;&gt;&lt;/a&gt;</span><br><span class=\"line\">        &lt;%; &#125; %&gt;</span><br><span class=\"line\">        &lt;% if(theme.author.email)&#123; %&gt;</span><br><span class=\"line\">        &lt;a href=&quot;mailto:&lt;%=theme.author.email %&gt;&quot; target=&quot;_blank&quot; class=&quot;icon-email&quot; title=&quot;Email Me&quot;&gt;&lt;/a&gt;</span><br><span class=\"line\">        &lt;%; &#125; %&gt;</span><br><span class=\"line\">    &lt;/div&gt;</span><br><span class=\"line\">            &lt;%  Array.prototype.S=String.fromCharCode(2);</span><br><span class=\"line\">              Array.prototype.in_array=function(e)&#123; var r=new RegExp(this.S+e+this.S); return (r.test(this.S+this.join(this.S)+this.S)); &#125;;</span><br><span class=\"line\">                var cc = new Array(&apos;by&apos;,&apos;by-nc&apos;,&apos;by-nc-nd&apos;,&apos;by-nc-sa&apos;,&apos;by-nd&apos;,&apos;by-sa&apos;,&apos;zero&apos;); %&gt;</span><br><span class=\"line\">        &lt;% if (cc.in_array(theme.creative_commons) ) &#123; %&gt;</span><br><span class=\"line\">                &lt;div class=&quot;cc-license&quot;&gt;</span><br><span class=\"line\">          &lt;a href=&quot;http://creativecommons.org/licenses/&lt;%= theme.creative_commons %&gt;/4.0&quot; class=&quot;cc-opacity&quot; target=&quot;_blank&quot;&gt;</span><br><span class=\"line\">            &lt;img src=&quot;&lt;%- config.root %&gt;img/cc-&lt;%= theme.creative_commons %&gt;.svg&quot; alt=&quot;Creative Commons&quot; /&gt;</span><br><span class=\"line\">          &lt;/a&gt;</span><br><span class=\"line\">        &lt;/div&gt;</span><br><span class=\"line\">    &lt;%; &#125; %&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">        &lt;p class=&quot;copyright&quot;&gt;</span><br><span class=\"line\">        © &lt;%= new Date().getFullYear() %&gt;</span><br><span class=\"line\">        &lt;% if (config.author) &#123; %&gt;</span><br><span class=\"line\">        &lt;a href=&quot;&lt;%= config.root %&gt;about&quot; target=&quot;_blank&quot; title=&quot;&lt;%= config.author %&gt;&quot;&gt;&lt;%= config.author %&gt;&lt;/a&gt;</span><br><span class=\"line\">        &lt;%; &#125; else &#123; %&gt;</span><br><span class=\"line\">        &lt;a href=&quot;&lt;%= config.url %&gt;&quot; title=&quot;&lt;%= config.title %&gt;&quot;&gt;&lt;%= config.title %&gt;&lt;/a&gt;</span><br><span class=\"line\">        &lt;%; &#125; %&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">        &lt;!-- 不蒜子统计 --&gt;</span><br><span class=\"line\">&lt;% if (theme.ibruce_tongji.enable)&#123; %&gt;</span><br><span class=\"line\">&lt;script async src=&quot;https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js&quot;&gt;&lt;/script&gt;</span><br><span class=\"line\">&lt;span id=&quot;busuanzi_container_site_pv&quot; style=&apos;display:none&apos;&gt;</span><br><span class=\"line\">本站总访问量&lt;span id=&quot;busuanzi_value_site_pv&quot;&gt;&lt;/span&gt;,本站访客数&lt;span id=&quot;busuanzi_value_site_uv&quot;&gt;&lt;/span&gt;，本文总阅读量&lt;span id=&quot;busuanzi_value_page_pv&quot;&gt;&lt;/span&gt;</span><br><span class=\"line\">&lt;/span&gt;</span><br><span class=\"line\">&lt;%; &#125; %&gt;</span><br><span class=\"line\">        &lt;/p&gt;</span><br><span class=\"line\">&lt;/div&gt;</span><br></pre></td></tr></table></figure></p>\n<h3 id=\"2-7备份的重要性\"><a href=\"#2-7备份的重要性\" class=\"headerlink\" title=\"2.7备份的重要性\"></a>2.7备份的重要性</h3><p>刚开始折腾时，经常出现改了很多配置，一运行就报错了，但是无法定位是哪些配置的改动导致的？<br>幸好我用Sublime Text 3修改的，有历史记录，这点真是太赞了！给你要的<a href=\"http://pan.baidu.com/s/1pLnDKW7\">链接</a>，密码：3ook</p>\n<p>Hexo配置好后，最好做一次网盘私密备份，以免主机故障丢失。而且有了备份，在家或在公司，都可以愉快的写blog啦！</p>\n<h2 id=\"3-可能遇到的问题及答案\"><a href=\"#3-可能遇到的问题及答案\" class=\"headerlink\" title=\"3.可能遇到的问题及答案\"></a>3.可能遇到的问题及答案</h2><p>1.hexo系列命令无法执行：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">D:\\GitHub&gt; hexo c</span><br><span class=\"line\">Usage: hexo &lt;command&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">Commands:</span><br><span class=\"line\">  help     Get help on a command.</span><br><span class=\"line\">  init     Create a new Hexo folder.</span><br><span class=\"line\">  version  Display version information.</span><br><span class=\"line\"></span><br><span class=\"line\">Global Options:</span><br><span class=\"line\">  --config  Specify config file instead of using _config.yml</span><br><span class=\"line\">  --cwd     Specify the CWD</span><br><span class=\"line\">  --debug   Display all verbose messages in the terminal</span><br><span class=\"line\">  --draft   Display draft posts</span><br><span class=\"line\">  --safe    Disable all plugins and scripts</span><br><span class=\"line\">  --silent  Hide output on console</span><br><span class=\"line\"></span><br><span class=\"line\">For more help, you can use &apos;hexo help [command]&apos; for the detailed information</span><br><span class=\"line\">or you can check the docs: http://hexo.io/docs/</span><br></pre></td></tr></table></figure></p>\n<p>解决：请切换目录到Hexo安装目录后再执行。这是因为Hexo没有全局环境配置的问题。<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cd .\\Hexo</span><br></pre></td></tr></table></figure></p>\n<p>2.关于404页面的处理<br>搜索很多关于404页面的资料，都是把配置好的404.html，每次在hexo g命令后手工放在hexo的public目录下。这样子有个缺点，每次都需要手工操作一次，这对于程序员来说是极其不人道的，我想到一个点子：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">将404.html文件放在hexo的source目录下</span><br><span class=\"line\">在hexod的全局配置文件:_config.yml，配置skip_render</span><br><span class=\"line\">skip_render:</span><br><span class=\"line\">  - README.md</span><br><span class=\"line\">  - 404.htm</span><br></pre></td></tr></table></figure></p>\n<p>3.如何在文章中插入图片？<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">在Hexo的source文件夹下，建一个文件夹“img”</span><br><span class=\"line\">将想要插入到文章的图片，放到img文件夹下，图片最好是png格式，文件小而且不变形</span><br><span class=\"line\">使用示例：![图片的名字](/img/图片001.png)</span><br></pre></td></tr></table></figure></p>\n<p>4.如何在文章中插入代码段？<br>将需要显示为代码段的内容，用```前后包裹住<br><img src=\"/img/代码段.png\" alt=\"\"></p>\n<p>显示的效果是：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">代码段1</span><br><span class=\"line\">代码段2</span><br></pre></td></tr></table></figure></p>\n"},{"title":"记一次redis成功调优的过程","date":"2016-03-23T08:09:12.000Z","description":"在最后一步提到RDB定期存盘，解决方案存在问题，强行关闭，会导致redis中的数据存在丢失风险，在这里建议有条件的，配置redis为1主1从，Master不进行任何形式的存盘，而Slave配置RDB和AOF方式的存盘，双保险。应用只连接Master即可。","_content":"\n## 我们怎么使用Redis？\n公司目前主力开发的产品，是一个典型的平台电商型产品，包含了平台运营方、商家、消费者等角色。\n\n公司提供电商平台，同时负责系统维护和系统保障；商家与公司进行签约后，入驻平台，将商品投放到平台进行展示；平台依据商家签约信息，进行商品与消费者之间的兴趣推荐，消费者通过商品与商家达成消费订单后，平台按单依据签约与商家抽取利润。商家发现日订单分析有了提升后，可能会与平台达成更多的合作。从而演变出了良好的商业发展模式。\n\n平台电商型产品中，非常满足80/20法则(又称为:[帕雷托法则](https://zh.wikipedia.org/wiki/%E5%B8%95%E9%9B%B7%E6%89%98%E6%B3%95%E5%88%99)),查询的业务量远远多于写入的业务量，为了提高[TPS](http://www.ha97.com/5095.html)，降低对数据库的访问。我们也采取常规的做法，选用redis进行缓存常用业务数据。其中典型的就有：1.图片的信息、2.登录后的用户信息、3.全局超时锁、4.验证码。\n\n关于redis的技术选型，其实在我参与产品开发之前就已经完成了，在这个产品里也作为缓存层在使用。产品目前还在雏形孵化阶段，没有考虑太多关于分布式以及高可用的方案，对redis的使用很粗糙，在团队内可能熟悉redis的Developer不多，或者说有空又有耐心还熟悉redis的Developer没有吧？后来与PM的沟通后得知确实如此！\n\n### 缓存图片信息\n目前有很多业务在使用该缓存：商品的图片编辑，商家店面形象的图文自我介绍，用户针对订单的图文评价.\n\n这一部分的数据，在产品启动时(没有黑科技，就是在web.xml，自定义listener。)，读取Mysql中的File表，load进redis，数据量约120W条，没有做任何的分库分表处理。\n\nFile表的结构如下：\n```\nCREATE TABLE `file` (\n  `id` int(11) NOT NULL AUTO_INCREMENT COMMENT '图片ID',\n  `uid` int(11) DEFAULT NULL COMMENT '上传用户Id',\n  `crc32` char(8) COLLATE utf8mb4_unicode_ci DEFAULT NULL COMMENT 'crc32校验和',\n  `url` varchar(256) COLLATE utf8mb4_unicode_ci DEFAULT '' COMMENT '对外访问的URL',\n  `path` varchar(256) COLLATE utf8mb4_unicode_ci DEFAULT '' COMMENT '存储的相对路径',\n  `filename` varchar(128) COLLATE utf8mb4_unicode_ci NOT NULL DEFAULT '' COMMENT '文件名字',\n  `size` int(11) DEFAULT NULL COMMENT '图片大小(单位byte)',\n  `ext` char(5) COLLATE utf8mb4_unicode_ci NOT NULL DEFAULT '' COMMENT '图片后缀',\n  `is_image` tinyint(4) NOT NULL DEFAULT '0' COMMENT '是否是图片，0为不是，1为是',\n  `create_time` timestamp NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',\n  `storage_type` tinyint(4) NOT NULL DEFAULT '0' COMMENT '图片存储介质，0为fileSystem，1阿里云,2表示ppw老数据',\n  PRIMARY KEY (`id`),\n  UNIQUE KEY `filename` (`filename`) USING BTREE\n) ENGINE=InnoDB AUTO_INCREMENT=1146617 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='文件信息表';\n```\n\n\n有意思的是，每次产品启动时，读取到的所有File表记录，进行for循环，每一次循环中，访问一次redis。而在产品关闭时，删除redis的key，从而清除缓存？如果数据量愈来愈多，不就像做过山车一样，启动时加载全量数据，使用量飚的很高，关闭时删除全量缓存，使用量逐渐落回低谷(redis有[内存释放机制](http://wangneng-168.iteye.com/blog/2100379))。对于内存型中间件产品，这样的使用会带来很多的不可靠性。\n\n启动时加载数据到redis时的处理过程,部分为伪码：\n```\nFile表对应的实体类：\npublic class File{//与数据库字段名完全的一致\n    private int id;\n    private int uid;\n    private String crc32;\n    private String url;\n    private String path;\n    private String filename;\n    private int size;\n    private String ext;\n    private int is_image;\n    private Timestamp create_time;\n    private int storage_type;\n\n    //忽略 getter\\setter\n}\n\n\n//调用Dao层访问Mysql数据库，取回File表的所有记录，每条记录包含所有字段。\nList<File> files=this.fileDao.getAll();\n\n\n//读取File表的SQL：SELECT * FROM FILE;\n\nfor(int i=0;i<files.size();i++){\n    this.cacheDao.setOneFileToRedis(files.get(i).getId(),files.get(i).getUrl());//调用Dao层访问Redis，将数据存入redis\n    //WTF?只需要2个字段，然而取回了所有字段？而且不能批量存入redis?\n}\n\n\ncacheDao的实现\nprivate final static String PHOTO_CACHE_KEY=\"photos\";\npublic void setOneFileToRedis(int id,String url){\n    this.jedis.hset(PHOTO_CACHE_KEY, id.toString(), url);//1.使用[Hash数据结构](https://redis.readthedocs.org/en/2.4/hash.html)。2.没有设置key有效期，即永久有效。\n}\n\npublic String getOneFileInRedis(int id){\n    return this.jedis.hget(PHOTO_CACHE_KEY, id.toString());\n}\n```\n\n这样图片信息缓存的结构看起来是这样:\n![photos在redis的数据结构示例](/img/photos在redis的数据结构示例.png)\n实际的情况下，size远大于1000，上文说了约在120w左右，我的这个redis可视化工具(redisclient-win32.x86.2.0)无法获取size这样大的key，报SocketTimeOutException。猜测是向redis获取大key时，无法在一个socket包中写入，造成通讯失败。\n\n以上cacheDao的实现中，没有提供一次批量获取所需的多个图片信息，例如“public Map<Integer,String> getBatchFileInRedis(int[] ids)”，甚至在cache interface中都没有提供这样的接口定义。\n\n这样导致在上层逻辑中，出现大量一次性代码。因为调用不集中，给重构带来很大麻烦。\n```\n这是分页获取商品列表的伪代码实现\n\n与数据库product表对应的实体类\npublic class Product{\n    private int id;\n    private String name;\n    private long price;\n    private int photoId;\n\n    //忽略 getter\\setter\n}\n\n真实的返回到app端的对象\npublic class ProductFull{\n    private int id;\n    private String name;\n    private long price;\n    private int photoId;\n    private String photoUrl;\n\n    //忽略 getter\\setter\n}\npublic List<ProductFull> findProductByPage(int pageSize,int pageNo){\n    List<Product> products=this.productDao.findByPage(int pageSize,int pageNo);//调用Dao层访问Mysql\n    List<ProductFull> results=new ArrayList<>(products.size());\n    for(Product product:products){\n        ProductFull pf=new ProductFull();\n        pf.setId(product.getId());//其他的属性值都是类似的拷贝，或借助Apache-Common beanUtils组件进行拷贝。\n\n\n        String url=this.cacheDao.getOneFileInRedis(product.getPhotoId());//每一个循环项都访问了redis\n        pf.setPhotoUrl(url);\n        results.add(pf);\n    }\n    return results;\n}\n\n如果每个商品分页是10条，最坏情况下，需要访问1次Mysql+访问10次redis。非常严重的是，每个分页条数的大小由app端决定，服务端不限制，WTF?\n```\n\n### 缓存登录后的用户信息\n在这个产品面向消费者以及商家，都推出了不同的APP。互联网APP为了提高用户体验，以及降低用户登录登出频次(用户的登录/登出操作，对服务器是比较大的开销)，都会对一次登陆成功的用户，默认在一段时间不需要再次登录。即服务器分配Token给APP本地保存，同时服务器保存Token，设置该Token在一段时间不活动后自动失效，APP后续与服务器的通信中，都需要提交该Token鉴权。这是很常规的做法，短时间有效，而且是非关键性小数据，一次写入多次读取，对于服务器来说，没有比memcached或redis更合适的选择了，那为什么没有选择memcached？我个人的猜测是memcached更适合做Object Store Server，而且很重要的redis具有丰富数据结构与[扩容与容灾机制](http://www.cnblogs.com/EE-NovRain/p/3268476.html)。\n\n用户的第一次登录，服务端进行参数解析，鉴权后，就需要写入2次redis。\n用户的登出接口中，直接是删除当前会话的redis记录。\n\n第一次：写入本次登入的Token与用户信息的关联\n```\n登录成功后，从DB或Cache层获取用户数据，构造用户数据JSON\nString userLoginSuccessInfo=\"{\"uid\":12321,\"name\":\"张三\",\"sex\":0,\"avatar_id\":345643}\";\n\ncacheDao的实现\nprivate final static String SESSION_CACHE_KEY=\"session:\";\n//登录成功\npublic void setOneLoginSuccessToRedis(String token,String userLoginSuccessInfo){\n    this.jedis.setex(SESSION_CACHE_KEY+token, 30*24*60*60, userLoginSuccessInfo);//1.使用String数据结构。2.设置key有效期30天。\n}\n\n//鉴权\npublic String getOneLoginSuccessInRedis(String token){\n    return this.jedis.get(SESSION_CACHE_KEY+token);\n}\n\n//登出\npublic void logoutSuccessInRedis(String token){\n    this.jedis.del(SESSION_CACHE_KEY+token);\n}\n\n\n这个以\"session:\"开头的key里，并没有实现从uid如何获取token值？\n这会引发的问题：一个用户的多次登录，会生成多个以\"session:\"开头的key，没有覆盖之前登录的token。造成内存空间的浪费，以及不安全。正确的做法在下文会提到。\n```\n\n第二次：写入本次登入的用户id与24小时内的积分获取信息。\n\n有一个需求定义用户在登录后可以获取积分，但在24小时内的登录只算一次。\n\n那在服务器端的是实现是，用户第一次登录成功后，在redis写入一个与该用户相关的key，并设置24小时后失效，然后再增加积分。用户在24小时内进行第二次登录，先读取redis是否有相关的key，使用exist命令，如果已经有了，就不增加积分了。\n\n```\n登录成功后，从DB或Cache层获取用户数据，构造用户与积分业务数据JSON\nint uid=158263;\n\ncacheDao的实现\nprivate final static String USER_ACTIVITY_CACHE_KEY=\"daily_activity_\";\npublic void setOneUserWithActivityToRedis(int uid){\n    this.jedis.setex(USER_ACTIVITY_CACHE_KEY+uid, 24*60*60, \"\");//1.使用String数据结构。2.设置key有效期24h。3.value部分为空字符串？\n}\n\npublic boolean checkOneUserWithActivityToRedis(int uid){\n    this.jedis.exists(USER_ACTIVITY_CACHE_KEY+uid);\n}\n\n```\n这部分的业务属于典型案例，浪费内存空间。\n第一个问题，不应该使用长前缀，每个key都需要set进内存，长前缀意味着空间占用，以及效率低下。\n第二个问题，这不是明显可以使用[Sorted Set数据结构](https://redis.readthedocs.org/en/2.4/sorted_set.html)?，还可以省掉一次exists检查。\n\n虽然redis的TPS很高，但是我们依旧要避免滥用。\n\n## 这次的问题的描述？\n测试MM提出在性能测试环境中，有一些API在并发数到250~300时，出现很多报错。\n```\nredis的相关错误\nCould not get a resource from the pool\n```\n典型报错的接口有\n* 分页获取商品列表\n* 用户登录\n\n应用中配置redis连接池上限值是1000，而在redis server端配置maxClients=10000;区区这点并发，就耗尽redis连接池资源了？绝不可能，问题还在更远的地方等着我.\n\n性能测试环境配置\n```\n硬件配置\n操作系统    Linux Ubuntu 14.04.4 LTS\nCPU个数   4\nCPU时钟频率 2.6G\n内存  4G\n有无外部存储  云端存储\n\n软件配置\ndocker  1.9.1\nmysql   5.6\njdk 1.8.0_72\nsolr    5.3.0\nredis   3.0.5\n```\n## 如何一步步的解决问题？\n在描述问题产生背景时，其实也提到了很多不合理的地方，但*存在即合理*，处在现在的困境，一定有当时的无奈。现在我们一起来总结一下问题所在。\n### 对缓存图片的处理存在的问题\n* 产品初始化时全量塞入redis/产品停止运行是全量卸掉\n* 产品初始化时塞入redis时，没有做批量操作\n* 对批量获取图片信息不支持，在接口层面就已经没有定义，对于可预见的需求没有进行考虑，这是架构设计的缺陷。\n* 引申：大量的数据，放在一个key里，会出现问题，需要进行水平切分(Sharding)。\n\n#### 方案\n1.图片的Id数据在File表采用了*自增长*的方式生成，不会出现重复，并且有顺序。我们可以利用这一点，在产品初始化时，在Mysql数据库File表只查找2个字段：id/url。程序处理时，先写入reids一个key，使用Hash数据结构，isInitIng:photos-true，标明到正在初始化，其他产品节点不需要重复初始化。使用hmset的方式，一次性将多个键值对存入到redis。完成后，修改isInitIng:photos-false。当有了新图片时，先在Mysql数据库File表进行保存，得到这个图片的Id以及url，使用hset加入该图片到redis。如果需要修改某一张图片的url，也可以用hset。这样在产品停止运行时，是不需要删除redis关于图片的数据的。\n\n2.cache层加入新接口，支持批量获取图片信息\n```\nprivate final static String PHOTO_CACHE_KEY=\"photos\";\npublic void setFileToRedis(Map<Integer,String> photos){\n    this.jedis.hmset(PHOTO_CACHE_KEY, photos);\n}\n\npublic Map<Integer,String> getBatchFileInRedis(int[] ids){\n    return this.jedis.hmget(PHOTO_CACHE_KEY, coverArrayToString(ids));\n}\n\nprivate static String[] coverArrayToString(int[] ids){\n    String[] results=new String[ids.length];\n    for (int i = 0; i < ids.length; i++) {\n        results[i]=ids[i]+\"\";\n    }\n    return results;\n}\n```\n对之前循环调用的上层代码进行修改，改为调用批量获取接口。\n\n3.对于单个key承载大量的数据的情况，方案是对key下的values hash key进行分割，使用一定的算法将块状的数据均匀分布在多个key里。给一个[参考链接](http://blog.nosqlfan.com/html/3379.html)。\n\n### 对缓存用户登录的处理存在的问题\n* session的存储不合理，每次登陆都会生成一个新的key值\n* 对USER_ACTIVITY_CACHE_KEY在value部分的数据结构不合理，应采用Sorted Set\n* 对USER_ACTIVITY_CACHE_KEY的命名不合适，过长导致空间浪费和效率低下\n* 因采用错误数据结构，USER_ACTIVITY_CACHE_KEY需要进行多一次的exists判断。\n\n#### 方案\nsession的存储不合理的解决，通过新的key(uid:token)来反向标记uid与token的关系，2个key的超时时间保持一致，例如\n```\nuid:158742-token001\n```\n在写入SESSION_CACHE_KEY时，同时写入到redis，为保证2次写入的原子性，需要使用[redis的事务](https://redis.readthedocs.org/en/2.4/transaction.html)。如果支持用户的多设备在线，只需要将key(uid:token)更改为Sorted Set结构。因为不存在资源的争夺，这个事务几乎不会失败。在用户登出时，删除掉当前会话信息以及用户关联的会话信息(同样是使用redis事务)。\n\n注意，单机redis环境下，事务命令被完整的支持。扩展到多机redis协同工作时，如果使用了twemproxy，则事务命令不受支持，无法应用该方案。[查看twemproxy对redis命令的支持情况](https://github.com/twitter/twemproxy/blob/master/notes/redis.md)。\n```\ncacheDao的实现\nprivate final static String SESSION_CACHE_KEY=\"se:\";//全称：\"session:\"，改善key命名，按业务进行简略，提升网络传输和存储效率。\nprivate final static String USER_TOKEN_CACHE_KEY=\"u:t:\";//uid:token:\n//登录成功，保存用户登录Token。接收建议的token参数值，返回实际保存的token值。\npublic String setOneLoginSuccessToRedis(int uid,String token,String userLoginSuccessInfo){//重构\n    if(checkOneUserTokenExists(uid)){\n        token=getOneUserToken(uid);\n    }\n    long expireTime=30*24*60*60;//设置key有效期30天。\n    String ret=this.jedis.watch(SESSION_CACHE_KEY+token,USER_TOKEN_CACHE_KEY+uid);//乐观锁，重试，在这里几乎不存在\n    if(ret==null||!ret.equals(\"OK\")){\n        log.error(\"redis watch 操作失败.ret:{}\",ret);\n        this.jedis.unwatch();\n    }\n    Transaction tx = this.jedis.multi();\n    tx.setex(SESSION_CACHE_KEY+token, expireTime, userLoginSuccessInfo);\n    tx.setex(USER_TOKEN_CACHE_KEY+uid, expireTime, token);\n    List<Object> results = tx.exec();\n    return token;\n}\n\n//检查用户登录Token是否已经存在\npublic boolean checkOneUserTokenExists(int uid){//新方法\n    return this.jedis.exists(USER_TOKEN_CACHE_KEY+uid);\n}\n\n//获取用户登录Token信息\npublic String getOneUserToken(int uid){//新方法\n    return this.jedis.get(USER_TOKEN_CACHE_KEY+uid);\n}\n\n//鉴权\npublic String getOneLoginSuccessInRedis(String token){//不改动\n    return this.jedis.get(SESSION_CACHE_KEY+token);\n}\n\n//登出\npublic void logoutSuccessInRedis(String token){\n    String ret=this.jedis.watch(SESSION_CACHE_KEY+token,USER_TOKEN_CACHE_KEY+uid);//乐观锁，重试，在这里几乎不存在\n    if(ret==null||!ret.equals(\"OK\")){\n        log.error(\"redis watch 操作失败.ret:{}\",ret);\n        this.jedis.unwatch();\n    }\n    Transaction tx = this.jedis.multi();\n    tx.del(SESSION_CACHE_KEY+token);\n    tx.del(USER_TOKEN_CACHE_KEY+uid);\n    List<Object> results = tx.exec();\n}\n```\n#### 隐患和思考\n\nredis事务带来的问题，redis的事务设计比较暴力，这给应用层带来了麻烦。\n\n* Redis的基本事务（basic transaction）需要用到MULTI命令和EXEC命令，这种事务可以让一个客户端在不被其他客户端打断的情况下执行多个命令。和关系数据库那种可以在执行的过程中进行回滚（rollback）的事务不同，在Redis里面，被MULTI命令和EXEC命令包围的所有命令会一个接一个地执行，直到所有命令都执行完毕为止。当一个事务执行完毕之后，Redis才会处理其他客户端的命令。\n* [Redis 在事务失败时不进行回滚，而是继续执行余下的命令](http://redisdoc.com/topic/transaction.html)\n\n基于此，redis事务会在客户端高并发时，其他客户端命令产生阻塞，而且事务回滚需要应用层自己解决。关于事务无法自动回滚，这在NoSQL领域是常见问题了。\n\n#### redis时间线设计\n接下来对用户在24小时内的积分信息的处理进行改进，以及redis不支持对Set内的单个Element进行有效期设置，我们采用Sorted Set结构，结合Score特性和Quartz来达到元素过期被删除的目的。\n```\ncacheDao的实现\nprivate final static String USER_ACTIVITY_CACHE_KEY=\"a:d\";//全称：\"activity:daily:\"，改善key命名，按业务进行简略，提升网络传输和存储效率。\npublic void setOneUserWithActivityToRedis(int uid){\n    this.jedis.zadd(USER_ACTIVITY_CACHE_KEY,System.currentTimeMillis(),uid+\"\");\n}\n\npublic boolean checkOneUserWithActivityToRedis(int uid){\n    this.jedis.sismember(USER_ACTIVITY_CACHE_KEY,uid+\"\");\n    long score=this.jedis.zscore(USER_ACTIVITY_CACHE_KEY,uid+\"\");\n    if(score>0){\n        return true;\n    }\n    return false;\n}\n\n另外加入一个计划任务，借助Quartz即可。\nString corn=*/1 * * * * ?  //每1秒钟执行1次\npublic void cleanExpireUserWithActivity(){\n    long now=System.currentTimeMillis();\n    long 1MAgo=now-60*1000;//1分钟前的时间\n    long remCount=this.jedis.zremrangeByScore(USER_ACTIVITY_CACHE_KEY,1MAgo,now);\n    log.info(\"成功删除的元素数量是：{}，执行时间是：{}\",remCount,now);\n}\n```\n#### 隐患和思考\n在上文给出的代码中，我们做了一定的容错性，每次删除过去1分钟的所有Element，这样Quartz出现故障时，如果在1分钟内得到fixed，影响的数据只限于1分钟内的Element。每1秒钟触发一次Quartz与删除过去1分钟的所有Element，这2个维度的频率需要权衡。\n\n* 过高频率的访问redis是否会有稳定性问题？\n* 删除Element的时间区间过大，是否会影响redis执行效率(时间复杂度:[O(log(N)+M)](http://redisdoc.com/sorted_set/zrevrangebyscore.html))，导致阻塞？\n* 高频率删除Element，是否会影响redis的RDB与AOF备份，因此造成额外的问题？\n\n借助Quartz还有misfire的隐患，如何保障Quartz在每一秒钟都顺畅执行一次(Once and only once)，这涉及到操作系统、内存的可靠性，这是一个大的命题，我们不过多讨论。\n\n记录一下对这类问题的思考\n\n* 可以对这个计划任务进行多机并行运行。例如：A计划与B计划都处于运行状态，A在奇数秒触发，B在偶数秒触发。进一步降低2秒内misfire的概率。\n* 在Quartz启动Job时，检测到是业务高峰期，另开启一个异步线程，调用cleanExpireUserWithActivity方法，而cleanExpireUserWithActivity需要承受并发，即redis需要对zremrangeByScore命令支持并发，但redis是[单进程单线程模型](http://www.blogjava.net/caojianhua/archive/2013/01/28/394847.html)。\n* 异步线程受制于redis，还可以进行改进，使用队列，如ActiveMQ。调用cleanExpireUserWithActivity逻辑进行调整，将命令序列化后写入到点对点队列，另外使用程序监听队列(即消费者端)，有新命令时取出，这里实际调用cleanExpireUserWithActivity，仅在调用成功后释放命令。\n* 现在问题在于如何保障ActiveMQ的稳定运行了，应该还有改进方案。\n\n按照以上的方案进行重构后，性能得到显著提升，按理论来说稳定性会有提高，因为不具备稳定性测试的条件，没法比较。\n## 遇到了一些问题\n1.redis一次批量hmset过多时报错\nhmset操作时，对于一次传入参数数量上限有要求。这取决于你的网络环境下，socket一次写入的字节数上限。\n```\npublic String hmset(final String key, final Map<String, String> hash);\n```\n在我本机的环境下(应用与redis都在本机，不同端口，redis以默认配置运行)，Map<String, String> hash的size大于5w左右就会报错。\n```\nredis.clients.jedis.exceptions.JedisConnectionException: java.net.SocketException: Software caused connection abort: socket write error\n    at redis.clients.jedis.Protocol.sendCommand(Protocol.java:98)\n    at redis.clients.jedis.Protocol.sendCommand(Protocol.java:78)\n    at redis.clients.jedis.Connection.sendCommand(Connection.java:101)\n    at redis.clients.jedis.BinaryClient.hmset(BinaryClient.java:246)\n    at redis.clients.jedis.Client.hmset(Client.java:171)\n    at redis.clients.jedis.Jedis.hmset(Jedis.java:652)\n```\n在这种情况下，必需要将大Map切分成一块块的Map，循环调用hmset\n```\nfinal static int maxEveryTurn=5000;//定义每次最多批量塞入redis的key数量\n    /**\n     * 批量存储到redis的key数量太多，必需切分成小块存储\n     */\n    private static void setTooManyToJedis(Jedis jedis, Map<String, String> map) {\n        int size=map.size();\n        int pieceNum=size/maxEveryTurn;\n        if(size>(pieceNum*maxEveryTurn)){\n            pieceNum+=1;\n        }\n        Iterator<Map.Entry<String, String>> iterator = map.entrySet().iterator();\n        List<Map<String, String>> list=new ArrayList<>(pieceNum);\n        for (int i=0;i<pieceNum;i++){\n            list.add(new HashMap<>(maxEveryTurn));\n        }\n        while (iterator.hasNext()) {\n            Map.Entry<String, String> entry = iterator.next();\n            String key = entry.getKey();\n            int hashCode = Math.abs(String.valueOf(key).hashCode());\n            int index=hashCode % pieceNum;\n            list.get(index).put(key, map.get(key));\n        }\n        map.clear();\n        for (Map<String, String> pieceMap:list){\n            setToJedis(jedis, pieceMap);\n        }\n        list.clear();\n    }\n```\n2.持续写redis时遇到rdb问题\n在完成以上方案的改进后，测试人员的用户登录这个接口在进行性能回归测试时，使用gatling配置250个工作线程进行并发，一共完成50w的用户登录后就算是结束，再根据生成的测试报告分析。\n刚开始每次压到20多w的用户登录时，就会报错，redis连接池无连接了。分析代码是配置了testOnBorrow:true，这个配置会在获取到连接后检查该连接的有效性，如果无效就丢弃，即在连接池删掉一个连接。而此时redis因为问题无法执行用户端的任何命令，所以所有连接都被当做无效连接被丢弃？直到连接池空了。\n```\n在redis命令行执行\nset test 12321\n返回错误：\n(error) MISCONF Redis is configured to save RDB snapshots, but is currently not able to persist on disk. Commands that may modify the data set are disabled. Please check Redis logs for details about the error.\n```\n\n这是因为默认的redis配置是以[RDB的方式](http://shanks.leanote.com/post/Untitled-55ca439338f41148cd000759-22)进行定期存盘，而存盘时，会拒绝所有外部命令的写入(存盘失败后也会拒绝写入)。因为目前在redis的数据都处于可丢，解决方式也相当的粗暴。\n```\n1.保证redis处于运行状态，查询系统6379端口的监听情况\n2.顺序执行以下命令行，遇到错误请终止\ndocker exec -it test_redis_1 /bin/bash\ncd usr/local/bin\n./redis-cli.sh\nconfig set stop-writes-on-bgsave-error no\nconfig set save \"\"\nquit\nexit\n```\n执行完以后，重启应用，再压测，呵呵，bug关闭。\n## 总结\n1.在最后一步提到RDB定期存盘，解决方案存在问题，强行关闭，会导致redis中的数据存在丢失风险，在这里建议有条件的，配置redis为1主1从，Master不进行任何形式的存盘，而Slave配置RDB和AOF方式的存盘，双保险。应用只连接Master即可。。注意Slave与Master第一次进行同步时会使用全量复制，对资源会有比较大的消耗，尽量选择在业务平峰期进行。\n引申阅读，Master在这里成为了单点，为了Master的高可用，还有进一步的方案，1个Master下挂2个Slave，其中1个Slave(称为A)负责2种方式的存盘，另一个Slave(称为B)作为Master的热备，在Master故障后，参与到投票，成为新的Master，而B节点切换到A，接受A的增量同步。注意自动failover时，外部需要关闭写入命令。完成failover后，使用ip映射切换，使应用层重新恢复使用，相应的，应用层需要做到一定的容错性。实际生产中，不会要求应用层去做容错性措施，会有各种中间件(twemproxy)自动处理。\n\n2.以上业务中对[redis的16个数据库](https://www.ttlsa.com/redis/redis-database/)没有使用好，可以按业务将数据存储到不同数据库，隔离影响。\n\n### 常用命令合集\n调试过程中，由于可视化工具对redis支持的不够好，使用了很多redis的命令行，现在我们总结一下吧！\n由于docker的风行，好处多多，我们在测试环境、线上环境也使用了docker/docker-compose\n#### docker\n```\ndocker-compose ps          //查看yml文件中所有容器的运行情况\ndocker-compose up -d xw    //将yml文件中容器名称定义为xw的容器，以后台运行的方式运行起来，如果是tomcat镜像，会调用tomcat的startup.sh.\ndocker-compose stop xw     //将yml文件中容器名称定义为xw的容器停止，如果是tomcat镜像，会调用tomcat的shutdown.sh\ndocker-compose stop        //查看yml文件中所有容器进行停止\ndocker-compose rm xw       //移除xw镜像\ndocker-compose build xw    //对xw进行镜像构建\n```\n#### ./redis-cli.sh/info\n```\nF:\\Redis> ./redis-cli\n127.0.0.1:6379> info\n# Server\nredis_version:3.0.501\nredis_git_sha1:00000000\nredis_git_dirty:0\nredis_build_id:ba05b51e58eb9205\nredis_mode:standalone\nos:Windows\narch_bits:64\nmultiplexing_api:WinSock_IOCP\nprocess_id:1552\nrun_id:d3f2efa1c6cf26c7cf9246c2fcaca89b8e109439\ntcp_port:6379\nuptime_in_seconds:462095\nuptime_in_days:5\nhz:10\nlru_clock:16404129\nconfig_file:F:\\Redis\\redis.windows.conf\n\n# Clients\nconnected_clients:1\nclient_longest_output_list:0\nclient_biggest_input_buf:0\nblocked_clients:0\n\n# Memory\nused_memory:842704\nused_memory_human:822.95K\nused_memory_rss:804920\nused_memory_peak:374731600\nused_memory_peak_human:357.37M\nused_memory_lua:36864\nmem_fragmentation_ratio:0.96\nmem_allocator:jemalloc-3.6.0\n\n# Persistence\nloading:0\nrdb_changes_since_last_save:0\nrdb_bgsave_in_progress:0\nrdb_last_save_time:1459242952\nrdb_last_bgsave_status:ok\nrdb_last_bgsave_time_sec:1\nrdb_current_bgsave_time_sec:-1\naof_enabled:0\naof_rewrite_in_progress:0\naof_rewrite_scheduled:0\naof_last_rewrite_time_sec:-1\naof_current_rewrite_time_sec:-1\naof_last_bgrewrite_status:ok\naof_last_write_status:ok\n\n# Stats\ntotal_connections_received:1010\ntotal_commands_processed:49859\ninstantaneous_ops_per_sec:0\ntotal_net_input_bytes:1822381802\ntotal_net_output_bytes:3650427\ninstantaneous_input_kbps:0.00\ninstantaneous_output_kbps:0.00\nrejected_connections:0\nsync_full:0\nsync_partial_ok:0\nsync_partial_err:0\nexpired_keys:1073\nevicted_keys:0\nkeyspace_hits:20782\nkeyspace_misses:738\npubsub_channels:0\npubsub_patterns:0\nlatest_fork_usec:388023\nmigrate_cached_sockets:0\n\n# Replication\nrole:master\nconnected_slaves:0\nmaster_repl_offset:0\nrepl_backlog_active:0\nrepl_backlog_size:1048576\nrepl_backlog_first_byte_offset:0\nrepl_backlog_histlen:0\n\n# CPU\nused_cpu_sys:9.45\nused_cpu_user:38.25\nused_cpu_sys_children:0.00\nused_cpu_user_children:0.00\n\n# Cluster\ncluster_enabled:0\n\n# Keyspace\ndb0:keys=1,expires=0,avg_ttl=0\n```\n#### set/get\n```\n127.0.0.1:6379> set test 123456\nOK\n127.0.0.1:6379> get test\n\"123456\"\n```\n#### hset/hmset/hget/hmget\n```\n127.0.0.1:6379> hset testHash key1 value11\n(integer) 1\n127.0.0.1:6379> hget testHash\n(error) ERR wrong number of arguments for 'hget' command\n127.0.0.1:6379> hget testHash key1\n\"value11\"\n127.0.0.1:6379>\n\n127.0.0.1:6379> hset testHash key1 value11 key2 value22\n(error) ERR wrong number of arguments for 'hset' command\n127.0.0.1:6379> hmset testHash key1 value11 key2 value22\nOK\n127.0.0.1:6379> hmget testHash key1 key2\n1) \"value11\"\n2) \"value22\"\n```\n#### hlen/keys\n```\n127.0.0.1:6379> len test\n(error) ERR unknown command 'len'\n127.0.0.1:6379> hlen testHash\n(integer) 2\n127.0.0.1:6379> keys test\n1) \"test\"\n127.0.0.1:6379> keys testHash\n1) \"testHash\"\n127.0.0.1:6379> keys *\n1) \"testHash\"\n2) \"test\"\n3) \"message-queue-sms\"\n```\n#### config set/get\n```\n127.0.0.1:6379> config get *\n  1) \"dbfilename\"\n  2) \"dump.rdb\"\n  3) \"requirepass\"\n  4) \"\"\n  5) \"masterauth\"\n  6) \"\"\n  7) \"unixsocket\"\n  8) \"\"\n  9) \"logfile\"\n 10) \"\"\n 11) \"pidfile\"\n 12) \"/var/run/redis.pid\"\n 13) \"maxmemory\"\n 14) \"512000000\"\n 15) \"maxmemory-samples\"\n 16) \"5\"\n 17) \"timeout\"\n 18) \"0\"\n 19) \"tcp-keepalive\"\n 20) \"0\"\n 21) \"auto-aof-rewrite-percentage\"\n 22) \"100\"\n 23) \"auto-aof-rewrite-min-size\"\n 24) \"67108864\"\n 25) \"hash-max-ziplist-entries\"\n 26) \"512\"\n 27) \"hash-max-ziplist-value\"\n 28) \"64\"\n 29) \"list-max-ziplist-entries\"\n 30) \"512\"\n 31) \"list-max-ziplist-value\"\n 32) \"64\"\n 33) \"set-max-intset-entries\"\n 34) \"512\"\n 35) \"zset-max-ziplist-entries\"\n 36) \"128\"\n 37) \"zset-max-ziplist-value\"\n 38) \"64\"\n 39) \"hll-sparse-max-bytes\"\n 40) \"3000\"\n 41) \"lua-time-limit\"\n 42) \"5000\"\n 43) \"slowlog-log-slower-than\"\n 44) \"10000\"\n 45) \"latency-monitor-threshold\"\n 46) \"0\"\n 47) \"slowlog-max-len\"\n 48) \"128\"\n 49) \"port\"\n 50) \"6379\"\n 51) \"tcp-backlog\"\n 52) \"511\"\n 53) \"databases\"\n 54) \"16\"\n 55) \"repl-ping-slave-period\"\n 56) \"10\"\n 57) \"repl-timeout\"\n 58) \"60\"\n 59) \"repl-backlog-size\"\n 60) \"1048576\"\n 61) \"repl-backlog-ttl\"\n 62) \"3600\"\n 63) \"maxclients\"\n 64) \"10000\"\n 65) \"watchdog-period\"\n 66) \"0\"\n 67) \"slave-priority\"\n 68) \"100\"\n 69) \"min-slaves-to-write\"\n 70) \"0\"\n 71) \"min-slaves-max-lag\"\n 72) \"10\"\n 73) \"hz\"\n 74) \"10\"\n 75) \"cluster-node-timeout\"\n 76) \"15000\"\n 77) \"cluster-migration-barrier\"\n 78) \"1\"\n 79) \"cluster-slave-validity-factor\"\n 80) \"10\"\n 81) \"repl-diskless-sync-delay\"\n 82) \"5\"\n 83) \"cluster-require-full-coverage\"\n 84) \"yes\"\n 85) \"no-appendfsync-on-rewrite\"\n 86) \"no\"\n 87) \"slave-serve-stale-data\"\n 88) \"yes\"\n 89) \"slave-read-only\"\n 90) \"yes\"\n 91) \"stop-writes-on-bgsave-error\"\n 92) \"yes\"\n 93) \"daemonize\"\n 94) \"no\"\n 95) \"rdbcompression\"\n 96) \"yes\"\n 97) \"rdbchecksum\"\n 98) \"yes\"\n 99) \"activerehashing\"\n100) \"yes\"\n101) \"repl-disable-tcp-nodelay\"\n102) \"no\"\n103) \"repl-diskless-sync\"\n104) \"no\"\n105) \"aof-rewrite-incremental-fsync\"\n106) \"yes\"\n107) \"aof-load-truncated\"\n108) \"yes\"\n109) \"appendonly\"\n110) \"no\"\n111) \"dir\"\n112) \"F:\\\\Redis\"\n113) \"maxmemory-policy\"\n114) \"noeviction\"\n115) \"appendfsync\"\n116) \"everysec\"\n117) \"save\"\n118) \"jd 900 jd 300 jd 60\"\n119) \"loglevel\"\n120) \"verbose\"\n121) \"client-output-buffer-limit\"\n122) \"normal 0 0 0 slave 268435456 67108864 60 pubsub 33554432 8388608 60\"\n123) \"unixsocketperm\"\n124) \"0\"\n125) \"slaveof\"\n126) \"\"\n127) \"notify-keyspace-events\"\n128) \"\"\n129) \"bind\"\n130) \"\"\n127.0.0.1:6379> config set save \"\"\nOK\n```\n#### flushdb/flushall\n```\n127.0.0.1:6379> flushdb\nOK\n127.0.0.1:6379> flushall\nOK\n```\n\n## 扩展阅读\n* redis删除有序集合部分过期元素：[http://caozm.blog.51cto.com/1118764/1389168](http://caozm.blog.51cto.com/1118764/1389168)\n* 节约内存：Instagram的Redis实践：[http://blog.nosqlfan.com/html/3379.html](http://blog.nosqlfan.com/html/3379.html)\n* redis持久化机制：[http://shanks.leanote.com/post/Untitled-55ca439338f41148cd000759-22](http://shanks.leanote.com/post/Untitled-55ca439338f41148cd000759-22)\n* Redis事务的分析及改进：[https://segmentfault.com/a/1190000002594059](https://segmentfault.com/a/1190000002594059)\n* redis 多数据库：[https://www.ttlsa.com/redis/redis-database/](https://www.ttlsa.com/redis/redis-database/)\n* 利用Sorted Set数据结构，为元素设置有效期：[http://stackoverflow.com/questions/7577923/redis-possible-to-expire-an-element-in-an-array-or-sorted-set](http://stackoverflow.com/questions/7577923/redis-possible-to-expire-an-element-in-an-array-or-sorted-set)\n* redis的Slave选举与优先级：[https://segmentfault.com/a/1190000002685515](https://segmentfault.com/a/1190000002685515)\n* 利用代理中间件实现大规模Redis集群：[http://www.imooc.com/article/4343](http://www.imooc.com/article/4343)","source":"_posts/A-successful-redis-tuning-record.md","raw":"---\ntitle: 记一次redis成功调优的过程\ndate: 2016-03-23 16:09:12\ntags:\n    - Redis\n    - Hash\n    - Sharding\n    - Twemproxy\ncategories:\n    - Record\ndescription: \"在最后一步提到RDB定期存盘，解决方案存在问题，强行关闭，会导致redis中的数据存在丢失风险，在这里建议有条件的，配置redis为1主1从，Master不进行任何形式的存盘，而Slave配置RDB和AOF方式的存盘，双保险。应用只连接Master即可。\"\n---\n\n## 我们怎么使用Redis？\n公司目前主力开发的产品，是一个典型的平台电商型产品，包含了平台运营方、商家、消费者等角色。\n\n公司提供电商平台，同时负责系统维护和系统保障；商家与公司进行签约后，入驻平台，将商品投放到平台进行展示；平台依据商家签约信息，进行商品与消费者之间的兴趣推荐，消费者通过商品与商家达成消费订单后，平台按单依据签约与商家抽取利润。商家发现日订单分析有了提升后，可能会与平台达成更多的合作。从而演变出了良好的商业发展模式。\n\n平台电商型产品中，非常满足80/20法则(又称为:[帕雷托法则](https://zh.wikipedia.org/wiki/%E5%B8%95%E9%9B%B7%E6%89%98%E6%B3%95%E5%88%99)),查询的业务量远远多于写入的业务量，为了提高[TPS](http://www.ha97.com/5095.html)，降低对数据库的访问。我们也采取常规的做法，选用redis进行缓存常用业务数据。其中典型的就有：1.图片的信息、2.登录后的用户信息、3.全局超时锁、4.验证码。\n\n关于redis的技术选型，其实在我参与产品开发之前就已经完成了，在这个产品里也作为缓存层在使用。产品目前还在雏形孵化阶段，没有考虑太多关于分布式以及高可用的方案，对redis的使用很粗糙，在团队内可能熟悉redis的Developer不多，或者说有空又有耐心还熟悉redis的Developer没有吧？后来与PM的沟通后得知确实如此！\n\n### 缓存图片信息\n目前有很多业务在使用该缓存：商品的图片编辑，商家店面形象的图文自我介绍，用户针对订单的图文评价.\n\n这一部分的数据，在产品启动时(没有黑科技，就是在web.xml，自定义listener。)，读取Mysql中的File表，load进redis，数据量约120W条，没有做任何的分库分表处理。\n\nFile表的结构如下：\n```\nCREATE TABLE `file` (\n  `id` int(11) NOT NULL AUTO_INCREMENT COMMENT '图片ID',\n  `uid` int(11) DEFAULT NULL COMMENT '上传用户Id',\n  `crc32` char(8) COLLATE utf8mb4_unicode_ci DEFAULT NULL COMMENT 'crc32校验和',\n  `url` varchar(256) COLLATE utf8mb4_unicode_ci DEFAULT '' COMMENT '对外访问的URL',\n  `path` varchar(256) COLLATE utf8mb4_unicode_ci DEFAULT '' COMMENT '存储的相对路径',\n  `filename` varchar(128) COLLATE utf8mb4_unicode_ci NOT NULL DEFAULT '' COMMENT '文件名字',\n  `size` int(11) DEFAULT NULL COMMENT '图片大小(单位byte)',\n  `ext` char(5) COLLATE utf8mb4_unicode_ci NOT NULL DEFAULT '' COMMENT '图片后缀',\n  `is_image` tinyint(4) NOT NULL DEFAULT '0' COMMENT '是否是图片，0为不是，1为是',\n  `create_time` timestamp NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',\n  `storage_type` tinyint(4) NOT NULL DEFAULT '0' COMMENT '图片存储介质，0为fileSystem，1阿里云,2表示ppw老数据',\n  PRIMARY KEY (`id`),\n  UNIQUE KEY `filename` (`filename`) USING BTREE\n) ENGINE=InnoDB AUTO_INCREMENT=1146617 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='文件信息表';\n```\n\n\n有意思的是，每次产品启动时，读取到的所有File表记录，进行for循环，每一次循环中，访问一次redis。而在产品关闭时，删除redis的key，从而清除缓存？如果数据量愈来愈多，不就像做过山车一样，启动时加载全量数据，使用量飚的很高，关闭时删除全量缓存，使用量逐渐落回低谷(redis有[内存释放机制](http://wangneng-168.iteye.com/blog/2100379))。对于内存型中间件产品，这样的使用会带来很多的不可靠性。\n\n启动时加载数据到redis时的处理过程,部分为伪码：\n```\nFile表对应的实体类：\npublic class File{//与数据库字段名完全的一致\n    private int id;\n    private int uid;\n    private String crc32;\n    private String url;\n    private String path;\n    private String filename;\n    private int size;\n    private String ext;\n    private int is_image;\n    private Timestamp create_time;\n    private int storage_type;\n\n    //忽略 getter\\setter\n}\n\n\n//调用Dao层访问Mysql数据库，取回File表的所有记录，每条记录包含所有字段。\nList<File> files=this.fileDao.getAll();\n\n\n//读取File表的SQL：SELECT * FROM FILE;\n\nfor(int i=0;i<files.size();i++){\n    this.cacheDao.setOneFileToRedis(files.get(i).getId(),files.get(i).getUrl());//调用Dao层访问Redis，将数据存入redis\n    //WTF?只需要2个字段，然而取回了所有字段？而且不能批量存入redis?\n}\n\n\ncacheDao的实现\nprivate final static String PHOTO_CACHE_KEY=\"photos\";\npublic void setOneFileToRedis(int id,String url){\n    this.jedis.hset(PHOTO_CACHE_KEY, id.toString(), url);//1.使用[Hash数据结构](https://redis.readthedocs.org/en/2.4/hash.html)。2.没有设置key有效期，即永久有效。\n}\n\npublic String getOneFileInRedis(int id){\n    return this.jedis.hget(PHOTO_CACHE_KEY, id.toString());\n}\n```\n\n这样图片信息缓存的结构看起来是这样:\n![photos在redis的数据结构示例](/img/photos在redis的数据结构示例.png)\n实际的情况下，size远大于1000，上文说了约在120w左右，我的这个redis可视化工具(redisclient-win32.x86.2.0)无法获取size这样大的key，报SocketTimeOutException。猜测是向redis获取大key时，无法在一个socket包中写入，造成通讯失败。\n\n以上cacheDao的实现中，没有提供一次批量获取所需的多个图片信息，例如“public Map<Integer,String> getBatchFileInRedis(int[] ids)”，甚至在cache interface中都没有提供这样的接口定义。\n\n这样导致在上层逻辑中，出现大量一次性代码。因为调用不集中，给重构带来很大麻烦。\n```\n这是分页获取商品列表的伪代码实现\n\n与数据库product表对应的实体类\npublic class Product{\n    private int id;\n    private String name;\n    private long price;\n    private int photoId;\n\n    //忽略 getter\\setter\n}\n\n真实的返回到app端的对象\npublic class ProductFull{\n    private int id;\n    private String name;\n    private long price;\n    private int photoId;\n    private String photoUrl;\n\n    //忽略 getter\\setter\n}\npublic List<ProductFull> findProductByPage(int pageSize,int pageNo){\n    List<Product> products=this.productDao.findByPage(int pageSize,int pageNo);//调用Dao层访问Mysql\n    List<ProductFull> results=new ArrayList<>(products.size());\n    for(Product product:products){\n        ProductFull pf=new ProductFull();\n        pf.setId(product.getId());//其他的属性值都是类似的拷贝，或借助Apache-Common beanUtils组件进行拷贝。\n\n\n        String url=this.cacheDao.getOneFileInRedis(product.getPhotoId());//每一个循环项都访问了redis\n        pf.setPhotoUrl(url);\n        results.add(pf);\n    }\n    return results;\n}\n\n如果每个商品分页是10条，最坏情况下，需要访问1次Mysql+访问10次redis。非常严重的是，每个分页条数的大小由app端决定，服务端不限制，WTF?\n```\n\n### 缓存登录后的用户信息\n在这个产品面向消费者以及商家，都推出了不同的APP。互联网APP为了提高用户体验，以及降低用户登录登出频次(用户的登录/登出操作，对服务器是比较大的开销)，都会对一次登陆成功的用户，默认在一段时间不需要再次登录。即服务器分配Token给APP本地保存，同时服务器保存Token，设置该Token在一段时间不活动后自动失效，APP后续与服务器的通信中，都需要提交该Token鉴权。这是很常规的做法，短时间有效，而且是非关键性小数据，一次写入多次读取，对于服务器来说，没有比memcached或redis更合适的选择了，那为什么没有选择memcached？我个人的猜测是memcached更适合做Object Store Server，而且很重要的redis具有丰富数据结构与[扩容与容灾机制](http://www.cnblogs.com/EE-NovRain/p/3268476.html)。\n\n用户的第一次登录，服务端进行参数解析，鉴权后，就需要写入2次redis。\n用户的登出接口中，直接是删除当前会话的redis记录。\n\n第一次：写入本次登入的Token与用户信息的关联\n```\n登录成功后，从DB或Cache层获取用户数据，构造用户数据JSON\nString userLoginSuccessInfo=\"{\"uid\":12321,\"name\":\"张三\",\"sex\":0,\"avatar_id\":345643}\";\n\ncacheDao的实现\nprivate final static String SESSION_CACHE_KEY=\"session:\";\n//登录成功\npublic void setOneLoginSuccessToRedis(String token,String userLoginSuccessInfo){\n    this.jedis.setex(SESSION_CACHE_KEY+token, 30*24*60*60, userLoginSuccessInfo);//1.使用String数据结构。2.设置key有效期30天。\n}\n\n//鉴权\npublic String getOneLoginSuccessInRedis(String token){\n    return this.jedis.get(SESSION_CACHE_KEY+token);\n}\n\n//登出\npublic void logoutSuccessInRedis(String token){\n    this.jedis.del(SESSION_CACHE_KEY+token);\n}\n\n\n这个以\"session:\"开头的key里，并没有实现从uid如何获取token值？\n这会引发的问题：一个用户的多次登录，会生成多个以\"session:\"开头的key，没有覆盖之前登录的token。造成内存空间的浪费，以及不安全。正确的做法在下文会提到。\n```\n\n第二次：写入本次登入的用户id与24小时内的积分获取信息。\n\n有一个需求定义用户在登录后可以获取积分，但在24小时内的登录只算一次。\n\n那在服务器端的是实现是，用户第一次登录成功后，在redis写入一个与该用户相关的key，并设置24小时后失效，然后再增加积分。用户在24小时内进行第二次登录，先读取redis是否有相关的key，使用exist命令，如果已经有了，就不增加积分了。\n\n```\n登录成功后，从DB或Cache层获取用户数据，构造用户与积分业务数据JSON\nint uid=158263;\n\ncacheDao的实现\nprivate final static String USER_ACTIVITY_CACHE_KEY=\"daily_activity_\";\npublic void setOneUserWithActivityToRedis(int uid){\n    this.jedis.setex(USER_ACTIVITY_CACHE_KEY+uid, 24*60*60, \"\");//1.使用String数据结构。2.设置key有效期24h。3.value部分为空字符串？\n}\n\npublic boolean checkOneUserWithActivityToRedis(int uid){\n    this.jedis.exists(USER_ACTIVITY_CACHE_KEY+uid);\n}\n\n```\n这部分的业务属于典型案例，浪费内存空间。\n第一个问题，不应该使用长前缀，每个key都需要set进内存，长前缀意味着空间占用，以及效率低下。\n第二个问题，这不是明显可以使用[Sorted Set数据结构](https://redis.readthedocs.org/en/2.4/sorted_set.html)?，还可以省掉一次exists检查。\n\n虽然redis的TPS很高，但是我们依旧要避免滥用。\n\n## 这次的问题的描述？\n测试MM提出在性能测试环境中，有一些API在并发数到250~300时，出现很多报错。\n```\nredis的相关错误\nCould not get a resource from the pool\n```\n典型报错的接口有\n* 分页获取商品列表\n* 用户登录\n\n应用中配置redis连接池上限值是1000，而在redis server端配置maxClients=10000;区区这点并发，就耗尽redis连接池资源了？绝不可能，问题还在更远的地方等着我.\n\n性能测试环境配置\n```\n硬件配置\n操作系统    Linux Ubuntu 14.04.4 LTS\nCPU个数   4\nCPU时钟频率 2.6G\n内存  4G\n有无外部存储  云端存储\n\n软件配置\ndocker  1.9.1\nmysql   5.6\njdk 1.8.0_72\nsolr    5.3.0\nredis   3.0.5\n```\n## 如何一步步的解决问题？\n在描述问题产生背景时，其实也提到了很多不合理的地方，但*存在即合理*，处在现在的困境，一定有当时的无奈。现在我们一起来总结一下问题所在。\n### 对缓存图片的处理存在的问题\n* 产品初始化时全量塞入redis/产品停止运行是全量卸掉\n* 产品初始化时塞入redis时，没有做批量操作\n* 对批量获取图片信息不支持，在接口层面就已经没有定义，对于可预见的需求没有进行考虑，这是架构设计的缺陷。\n* 引申：大量的数据，放在一个key里，会出现问题，需要进行水平切分(Sharding)。\n\n#### 方案\n1.图片的Id数据在File表采用了*自增长*的方式生成，不会出现重复，并且有顺序。我们可以利用这一点，在产品初始化时，在Mysql数据库File表只查找2个字段：id/url。程序处理时，先写入reids一个key，使用Hash数据结构，isInitIng:photos-true，标明到正在初始化，其他产品节点不需要重复初始化。使用hmset的方式，一次性将多个键值对存入到redis。完成后，修改isInitIng:photos-false。当有了新图片时，先在Mysql数据库File表进行保存，得到这个图片的Id以及url，使用hset加入该图片到redis。如果需要修改某一张图片的url，也可以用hset。这样在产品停止运行时，是不需要删除redis关于图片的数据的。\n\n2.cache层加入新接口，支持批量获取图片信息\n```\nprivate final static String PHOTO_CACHE_KEY=\"photos\";\npublic void setFileToRedis(Map<Integer,String> photos){\n    this.jedis.hmset(PHOTO_CACHE_KEY, photos);\n}\n\npublic Map<Integer,String> getBatchFileInRedis(int[] ids){\n    return this.jedis.hmget(PHOTO_CACHE_KEY, coverArrayToString(ids));\n}\n\nprivate static String[] coverArrayToString(int[] ids){\n    String[] results=new String[ids.length];\n    for (int i = 0; i < ids.length; i++) {\n        results[i]=ids[i]+\"\";\n    }\n    return results;\n}\n```\n对之前循环调用的上层代码进行修改，改为调用批量获取接口。\n\n3.对于单个key承载大量的数据的情况，方案是对key下的values hash key进行分割，使用一定的算法将块状的数据均匀分布在多个key里。给一个[参考链接](http://blog.nosqlfan.com/html/3379.html)。\n\n### 对缓存用户登录的处理存在的问题\n* session的存储不合理，每次登陆都会生成一个新的key值\n* 对USER_ACTIVITY_CACHE_KEY在value部分的数据结构不合理，应采用Sorted Set\n* 对USER_ACTIVITY_CACHE_KEY的命名不合适，过长导致空间浪费和效率低下\n* 因采用错误数据结构，USER_ACTIVITY_CACHE_KEY需要进行多一次的exists判断。\n\n#### 方案\nsession的存储不合理的解决，通过新的key(uid:token)来反向标记uid与token的关系，2个key的超时时间保持一致，例如\n```\nuid:158742-token001\n```\n在写入SESSION_CACHE_KEY时，同时写入到redis，为保证2次写入的原子性，需要使用[redis的事务](https://redis.readthedocs.org/en/2.4/transaction.html)。如果支持用户的多设备在线，只需要将key(uid:token)更改为Sorted Set结构。因为不存在资源的争夺，这个事务几乎不会失败。在用户登出时，删除掉当前会话信息以及用户关联的会话信息(同样是使用redis事务)。\n\n注意，单机redis环境下，事务命令被完整的支持。扩展到多机redis协同工作时，如果使用了twemproxy，则事务命令不受支持，无法应用该方案。[查看twemproxy对redis命令的支持情况](https://github.com/twitter/twemproxy/blob/master/notes/redis.md)。\n```\ncacheDao的实现\nprivate final static String SESSION_CACHE_KEY=\"se:\";//全称：\"session:\"，改善key命名，按业务进行简略，提升网络传输和存储效率。\nprivate final static String USER_TOKEN_CACHE_KEY=\"u:t:\";//uid:token:\n//登录成功，保存用户登录Token。接收建议的token参数值，返回实际保存的token值。\npublic String setOneLoginSuccessToRedis(int uid,String token,String userLoginSuccessInfo){//重构\n    if(checkOneUserTokenExists(uid)){\n        token=getOneUserToken(uid);\n    }\n    long expireTime=30*24*60*60;//设置key有效期30天。\n    String ret=this.jedis.watch(SESSION_CACHE_KEY+token,USER_TOKEN_CACHE_KEY+uid);//乐观锁，重试，在这里几乎不存在\n    if(ret==null||!ret.equals(\"OK\")){\n        log.error(\"redis watch 操作失败.ret:{}\",ret);\n        this.jedis.unwatch();\n    }\n    Transaction tx = this.jedis.multi();\n    tx.setex(SESSION_CACHE_KEY+token, expireTime, userLoginSuccessInfo);\n    tx.setex(USER_TOKEN_CACHE_KEY+uid, expireTime, token);\n    List<Object> results = tx.exec();\n    return token;\n}\n\n//检查用户登录Token是否已经存在\npublic boolean checkOneUserTokenExists(int uid){//新方法\n    return this.jedis.exists(USER_TOKEN_CACHE_KEY+uid);\n}\n\n//获取用户登录Token信息\npublic String getOneUserToken(int uid){//新方法\n    return this.jedis.get(USER_TOKEN_CACHE_KEY+uid);\n}\n\n//鉴权\npublic String getOneLoginSuccessInRedis(String token){//不改动\n    return this.jedis.get(SESSION_CACHE_KEY+token);\n}\n\n//登出\npublic void logoutSuccessInRedis(String token){\n    String ret=this.jedis.watch(SESSION_CACHE_KEY+token,USER_TOKEN_CACHE_KEY+uid);//乐观锁，重试，在这里几乎不存在\n    if(ret==null||!ret.equals(\"OK\")){\n        log.error(\"redis watch 操作失败.ret:{}\",ret);\n        this.jedis.unwatch();\n    }\n    Transaction tx = this.jedis.multi();\n    tx.del(SESSION_CACHE_KEY+token);\n    tx.del(USER_TOKEN_CACHE_KEY+uid);\n    List<Object> results = tx.exec();\n}\n```\n#### 隐患和思考\n\nredis事务带来的问题，redis的事务设计比较暴力，这给应用层带来了麻烦。\n\n* Redis的基本事务（basic transaction）需要用到MULTI命令和EXEC命令，这种事务可以让一个客户端在不被其他客户端打断的情况下执行多个命令。和关系数据库那种可以在执行的过程中进行回滚（rollback）的事务不同，在Redis里面，被MULTI命令和EXEC命令包围的所有命令会一个接一个地执行，直到所有命令都执行完毕为止。当一个事务执行完毕之后，Redis才会处理其他客户端的命令。\n* [Redis 在事务失败时不进行回滚，而是继续执行余下的命令](http://redisdoc.com/topic/transaction.html)\n\n基于此，redis事务会在客户端高并发时，其他客户端命令产生阻塞，而且事务回滚需要应用层自己解决。关于事务无法自动回滚，这在NoSQL领域是常见问题了。\n\n#### redis时间线设计\n接下来对用户在24小时内的积分信息的处理进行改进，以及redis不支持对Set内的单个Element进行有效期设置，我们采用Sorted Set结构，结合Score特性和Quartz来达到元素过期被删除的目的。\n```\ncacheDao的实现\nprivate final static String USER_ACTIVITY_CACHE_KEY=\"a:d\";//全称：\"activity:daily:\"，改善key命名，按业务进行简略，提升网络传输和存储效率。\npublic void setOneUserWithActivityToRedis(int uid){\n    this.jedis.zadd(USER_ACTIVITY_CACHE_KEY,System.currentTimeMillis(),uid+\"\");\n}\n\npublic boolean checkOneUserWithActivityToRedis(int uid){\n    this.jedis.sismember(USER_ACTIVITY_CACHE_KEY,uid+\"\");\n    long score=this.jedis.zscore(USER_ACTIVITY_CACHE_KEY,uid+\"\");\n    if(score>0){\n        return true;\n    }\n    return false;\n}\n\n另外加入一个计划任务，借助Quartz即可。\nString corn=*/1 * * * * ?  //每1秒钟执行1次\npublic void cleanExpireUserWithActivity(){\n    long now=System.currentTimeMillis();\n    long 1MAgo=now-60*1000;//1分钟前的时间\n    long remCount=this.jedis.zremrangeByScore(USER_ACTIVITY_CACHE_KEY,1MAgo,now);\n    log.info(\"成功删除的元素数量是：{}，执行时间是：{}\",remCount,now);\n}\n```\n#### 隐患和思考\n在上文给出的代码中，我们做了一定的容错性，每次删除过去1分钟的所有Element，这样Quartz出现故障时，如果在1分钟内得到fixed，影响的数据只限于1分钟内的Element。每1秒钟触发一次Quartz与删除过去1分钟的所有Element，这2个维度的频率需要权衡。\n\n* 过高频率的访问redis是否会有稳定性问题？\n* 删除Element的时间区间过大，是否会影响redis执行效率(时间复杂度:[O(log(N)+M)](http://redisdoc.com/sorted_set/zrevrangebyscore.html))，导致阻塞？\n* 高频率删除Element，是否会影响redis的RDB与AOF备份，因此造成额外的问题？\n\n借助Quartz还有misfire的隐患，如何保障Quartz在每一秒钟都顺畅执行一次(Once and only once)，这涉及到操作系统、内存的可靠性，这是一个大的命题，我们不过多讨论。\n\n记录一下对这类问题的思考\n\n* 可以对这个计划任务进行多机并行运行。例如：A计划与B计划都处于运行状态，A在奇数秒触发，B在偶数秒触发。进一步降低2秒内misfire的概率。\n* 在Quartz启动Job时，检测到是业务高峰期，另开启一个异步线程，调用cleanExpireUserWithActivity方法，而cleanExpireUserWithActivity需要承受并发，即redis需要对zremrangeByScore命令支持并发，但redis是[单进程单线程模型](http://www.blogjava.net/caojianhua/archive/2013/01/28/394847.html)。\n* 异步线程受制于redis，还可以进行改进，使用队列，如ActiveMQ。调用cleanExpireUserWithActivity逻辑进行调整，将命令序列化后写入到点对点队列，另外使用程序监听队列(即消费者端)，有新命令时取出，这里实际调用cleanExpireUserWithActivity，仅在调用成功后释放命令。\n* 现在问题在于如何保障ActiveMQ的稳定运行了，应该还有改进方案。\n\n按照以上的方案进行重构后，性能得到显著提升，按理论来说稳定性会有提高，因为不具备稳定性测试的条件，没法比较。\n## 遇到了一些问题\n1.redis一次批量hmset过多时报错\nhmset操作时，对于一次传入参数数量上限有要求。这取决于你的网络环境下，socket一次写入的字节数上限。\n```\npublic String hmset(final String key, final Map<String, String> hash);\n```\n在我本机的环境下(应用与redis都在本机，不同端口，redis以默认配置运行)，Map<String, String> hash的size大于5w左右就会报错。\n```\nredis.clients.jedis.exceptions.JedisConnectionException: java.net.SocketException: Software caused connection abort: socket write error\n    at redis.clients.jedis.Protocol.sendCommand(Protocol.java:98)\n    at redis.clients.jedis.Protocol.sendCommand(Protocol.java:78)\n    at redis.clients.jedis.Connection.sendCommand(Connection.java:101)\n    at redis.clients.jedis.BinaryClient.hmset(BinaryClient.java:246)\n    at redis.clients.jedis.Client.hmset(Client.java:171)\n    at redis.clients.jedis.Jedis.hmset(Jedis.java:652)\n```\n在这种情况下，必需要将大Map切分成一块块的Map，循环调用hmset\n```\nfinal static int maxEveryTurn=5000;//定义每次最多批量塞入redis的key数量\n    /**\n     * 批量存储到redis的key数量太多，必需切分成小块存储\n     */\n    private static void setTooManyToJedis(Jedis jedis, Map<String, String> map) {\n        int size=map.size();\n        int pieceNum=size/maxEveryTurn;\n        if(size>(pieceNum*maxEveryTurn)){\n            pieceNum+=1;\n        }\n        Iterator<Map.Entry<String, String>> iterator = map.entrySet().iterator();\n        List<Map<String, String>> list=new ArrayList<>(pieceNum);\n        for (int i=0;i<pieceNum;i++){\n            list.add(new HashMap<>(maxEveryTurn));\n        }\n        while (iterator.hasNext()) {\n            Map.Entry<String, String> entry = iterator.next();\n            String key = entry.getKey();\n            int hashCode = Math.abs(String.valueOf(key).hashCode());\n            int index=hashCode % pieceNum;\n            list.get(index).put(key, map.get(key));\n        }\n        map.clear();\n        for (Map<String, String> pieceMap:list){\n            setToJedis(jedis, pieceMap);\n        }\n        list.clear();\n    }\n```\n2.持续写redis时遇到rdb问题\n在完成以上方案的改进后，测试人员的用户登录这个接口在进行性能回归测试时，使用gatling配置250个工作线程进行并发，一共完成50w的用户登录后就算是结束，再根据生成的测试报告分析。\n刚开始每次压到20多w的用户登录时，就会报错，redis连接池无连接了。分析代码是配置了testOnBorrow:true，这个配置会在获取到连接后检查该连接的有效性，如果无效就丢弃，即在连接池删掉一个连接。而此时redis因为问题无法执行用户端的任何命令，所以所有连接都被当做无效连接被丢弃？直到连接池空了。\n```\n在redis命令行执行\nset test 12321\n返回错误：\n(error) MISCONF Redis is configured to save RDB snapshots, but is currently not able to persist on disk. Commands that may modify the data set are disabled. Please check Redis logs for details about the error.\n```\n\n这是因为默认的redis配置是以[RDB的方式](http://shanks.leanote.com/post/Untitled-55ca439338f41148cd000759-22)进行定期存盘，而存盘时，会拒绝所有外部命令的写入(存盘失败后也会拒绝写入)。因为目前在redis的数据都处于可丢，解决方式也相当的粗暴。\n```\n1.保证redis处于运行状态，查询系统6379端口的监听情况\n2.顺序执行以下命令行，遇到错误请终止\ndocker exec -it test_redis_1 /bin/bash\ncd usr/local/bin\n./redis-cli.sh\nconfig set stop-writes-on-bgsave-error no\nconfig set save \"\"\nquit\nexit\n```\n执行完以后，重启应用，再压测，呵呵，bug关闭。\n## 总结\n1.在最后一步提到RDB定期存盘，解决方案存在问题，强行关闭，会导致redis中的数据存在丢失风险，在这里建议有条件的，配置redis为1主1从，Master不进行任何形式的存盘，而Slave配置RDB和AOF方式的存盘，双保险。应用只连接Master即可。。注意Slave与Master第一次进行同步时会使用全量复制，对资源会有比较大的消耗，尽量选择在业务平峰期进行。\n引申阅读，Master在这里成为了单点，为了Master的高可用，还有进一步的方案，1个Master下挂2个Slave，其中1个Slave(称为A)负责2种方式的存盘，另一个Slave(称为B)作为Master的热备，在Master故障后，参与到投票，成为新的Master，而B节点切换到A，接受A的增量同步。注意自动failover时，外部需要关闭写入命令。完成failover后，使用ip映射切换，使应用层重新恢复使用，相应的，应用层需要做到一定的容错性。实际生产中，不会要求应用层去做容错性措施，会有各种中间件(twemproxy)自动处理。\n\n2.以上业务中对[redis的16个数据库](https://www.ttlsa.com/redis/redis-database/)没有使用好，可以按业务将数据存储到不同数据库，隔离影响。\n\n### 常用命令合集\n调试过程中，由于可视化工具对redis支持的不够好，使用了很多redis的命令行，现在我们总结一下吧！\n由于docker的风行，好处多多，我们在测试环境、线上环境也使用了docker/docker-compose\n#### docker\n```\ndocker-compose ps          //查看yml文件中所有容器的运行情况\ndocker-compose up -d xw    //将yml文件中容器名称定义为xw的容器，以后台运行的方式运行起来，如果是tomcat镜像，会调用tomcat的startup.sh.\ndocker-compose stop xw     //将yml文件中容器名称定义为xw的容器停止，如果是tomcat镜像，会调用tomcat的shutdown.sh\ndocker-compose stop        //查看yml文件中所有容器进行停止\ndocker-compose rm xw       //移除xw镜像\ndocker-compose build xw    //对xw进行镜像构建\n```\n#### ./redis-cli.sh/info\n```\nF:\\Redis> ./redis-cli\n127.0.0.1:6379> info\n# Server\nredis_version:3.0.501\nredis_git_sha1:00000000\nredis_git_dirty:0\nredis_build_id:ba05b51e58eb9205\nredis_mode:standalone\nos:Windows\narch_bits:64\nmultiplexing_api:WinSock_IOCP\nprocess_id:1552\nrun_id:d3f2efa1c6cf26c7cf9246c2fcaca89b8e109439\ntcp_port:6379\nuptime_in_seconds:462095\nuptime_in_days:5\nhz:10\nlru_clock:16404129\nconfig_file:F:\\Redis\\redis.windows.conf\n\n# Clients\nconnected_clients:1\nclient_longest_output_list:0\nclient_biggest_input_buf:0\nblocked_clients:0\n\n# Memory\nused_memory:842704\nused_memory_human:822.95K\nused_memory_rss:804920\nused_memory_peak:374731600\nused_memory_peak_human:357.37M\nused_memory_lua:36864\nmem_fragmentation_ratio:0.96\nmem_allocator:jemalloc-3.6.0\n\n# Persistence\nloading:0\nrdb_changes_since_last_save:0\nrdb_bgsave_in_progress:0\nrdb_last_save_time:1459242952\nrdb_last_bgsave_status:ok\nrdb_last_bgsave_time_sec:1\nrdb_current_bgsave_time_sec:-1\naof_enabled:0\naof_rewrite_in_progress:0\naof_rewrite_scheduled:0\naof_last_rewrite_time_sec:-1\naof_current_rewrite_time_sec:-1\naof_last_bgrewrite_status:ok\naof_last_write_status:ok\n\n# Stats\ntotal_connections_received:1010\ntotal_commands_processed:49859\ninstantaneous_ops_per_sec:0\ntotal_net_input_bytes:1822381802\ntotal_net_output_bytes:3650427\ninstantaneous_input_kbps:0.00\ninstantaneous_output_kbps:0.00\nrejected_connections:0\nsync_full:0\nsync_partial_ok:0\nsync_partial_err:0\nexpired_keys:1073\nevicted_keys:0\nkeyspace_hits:20782\nkeyspace_misses:738\npubsub_channels:0\npubsub_patterns:0\nlatest_fork_usec:388023\nmigrate_cached_sockets:0\n\n# Replication\nrole:master\nconnected_slaves:0\nmaster_repl_offset:0\nrepl_backlog_active:0\nrepl_backlog_size:1048576\nrepl_backlog_first_byte_offset:0\nrepl_backlog_histlen:0\n\n# CPU\nused_cpu_sys:9.45\nused_cpu_user:38.25\nused_cpu_sys_children:0.00\nused_cpu_user_children:0.00\n\n# Cluster\ncluster_enabled:0\n\n# Keyspace\ndb0:keys=1,expires=0,avg_ttl=0\n```\n#### set/get\n```\n127.0.0.1:6379> set test 123456\nOK\n127.0.0.1:6379> get test\n\"123456\"\n```\n#### hset/hmset/hget/hmget\n```\n127.0.0.1:6379> hset testHash key1 value11\n(integer) 1\n127.0.0.1:6379> hget testHash\n(error) ERR wrong number of arguments for 'hget' command\n127.0.0.1:6379> hget testHash key1\n\"value11\"\n127.0.0.1:6379>\n\n127.0.0.1:6379> hset testHash key1 value11 key2 value22\n(error) ERR wrong number of arguments for 'hset' command\n127.0.0.1:6379> hmset testHash key1 value11 key2 value22\nOK\n127.0.0.1:6379> hmget testHash key1 key2\n1) \"value11\"\n2) \"value22\"\n```\n#### hlen/keys\n```\n127.0.0.1:6379> len test\n(error) ERR unknown command 'len'\n127.0.0.1:6379> hlen testHash\n(integer) 2\n127.0.0.1:6379> keys test\n1) \"test\"\n127.0.0.1:6379> keys testHash\n1) \"testHash\"\n127.0.0.1:6379> keys *\n1) \"testHash\"\n2) \"test\"\n3) \"message-queue-sms\"\n```\n#### config set/get\n```\n127.0.0.1:6379> config get *\n  1) \"dbfilename\"\n  2) \"dump.rdb\"\n  3) \"requirepass\"\n  4) \"\"\n  5) \"masterauth\"\n  6) \"\"\n  7) \"unixsocket\"\n  8) \"\"\n  9) \"logfile\"\n 10) \"\"\n 11) \"pidfile\"\n 12) \"/var/run/redis.pid\"\n 13) \"maxmemory\"\n 14) \"512000000\"\n 15) \"maxmemory-samples\"\n 16) \"5\"\n 17) \"timeout\"\n 18) \"0\"\n 19) \"tcp-keepalive\"\n 20) \"0\"\n 21) \"auto-aof-rewrite-percentage\"\n 22) \"100\"\n 23) \"auto-aof-rewrite-min-size\"\n 24) \"67108864\"\n 25) \"hash-max-ziplist-entries\"\n 26) \"512\"\n 27) \"hash-max-ziplist-value\"\n 28) \"64\"\n 29) \"list-max-ziplist-entries\"\n 30) \"512\"\n 31) \"list-max-ziplist-value\"\n 32) \"64\"\n 33) \"set-max-intset-entries\"\n 34) \"512\"\n 35) \"zset-max-ziplist-entries\"\n 36) \"128\"\n 37) \"zset-max-ziplist-value\"\n 38) \"64\"\n 39) \"hll-sparse-max-bytes\"\n 40) \"3000\"\n 41) \"lua-time-limit\"\n 42) \"5000\"\n 43) \"slowlog-log-slower-than\"\n 44) \"10000\"\n 45) \"latency-monitor-threshold\"\n 46) \"0\"\n 47) \"slowlog-max-len\"\n 48) \"128\"\n 49) \"port\"\n 50) \"6379\"\n 51) \"tcp-backlog\"\n 52) \"511\"\n 53) \"databases\"\n 54) \"16\"\n 55) \"repl-ping-slave-period\"\n 56) \"10\"\n 57) \"repl-timeout\"\n 58) \"60\"\n 59) \"repl-backlog-size\"\n 60) \"1048576\"\n 61) \"repl-backlog-ttl\"\n 62) \"3600\"\n 63) \"maxclients\"\n 64) \"10000\"\n 65) \"watchdog-period\"\n 66) \"0\"\n 67) \"slave-priority\"\n 68) \"100\"\n 69) \"min-slaves-to-write\"\n 70) \"0\"\n 71) \"min-slaves-max-lag\"\n 72) \"10\"\n 73) \"hz\"\n 74) \"10\"\n 75) \"cluster-node-timeout\"\n 76) \"15000\"\n 77) \"cluster-migration-barrier\"\n 78) \"1\"\n 79) \"cluster-slave-validity-factor\"\n 80) \"10\"\n 81) \"repl-diskless-sync-delay\"\n 82) \"5\"\n 83) \"cluster-require-full-coverage\"\n 84) \"yes\"\n 85) \"no-appendfsync-on-rewrite\"\n 86) \"no\"\n 87) \"slave-serve-stale-data\"\n 88) \"yes\"\n 89) \"slave-read-only\"\n 90) \"yes\"\n 91) \"stop-writes-on-bgsave-error\"\n 92) \"yes\"\n 93) \"daemonize\"\n 94) \"no\"\n 95) \"rdbcompression\"\n 96) \"yes\"\n 97) \"rdbchecksum\"\n 98) \"yes\"\n 99) \"activerehashing\"\n100) \"yes\"\n101) \"repl-disable-tcp-nodelay\"\n102) \"no\"\n103) \"repl-diskless-sync\"\n104) \"no\"\n105) \"aof-rewrite-incremental-fsync\"\n106) \"yes\"\n107) \"aof-load-truncated\"\n108) \"yes\"\n109) \"appendonly\"\n110) \"no\"\n111) \"dir\"\n112) \"F:\\\\Redis\"\n113) \"maxmemory-policy\"\n114) \"noeviction\"\n115) \"appendfsync\"\n116) \"everysec\"\n117) \"save\"\n118) \"jd 900 jd 300 jd 60\"\n119) \"loglevel\"\n120) \"verbose\"\n121) \"client-output-buffer-limit\"\n122) \"normal 0 0 0 slave 268435456 67108864 60 pubsub 33554432 8388608 60\"\n123) \"unixsocketperm\"\n124) \"0\"\n125) \"slaveof\"\n126) \"\"\n127) \"notify-keyspace-events\"\n128) \"\"\n129) \"bind\"\n130) \"\"\n127.0.0.1:6379> config set save \"\"\nOK\n```\n#### flushdb/flushall\n```\n127.0.0.1:6379> flushdb\nOK\n127.0.0.1:6379> flushall\nOK\n```\n\n## 扩展阅读\n* redis删除有序集合部分过期元素：[http://caozm.blog.51cto.com/1118764/1389168](http://caozm.blog.51cto.com/1118764/1389168)\n* 节约内存：Instagram的Redis实践：[http://blog.nosqlfan.com/html/3379.html](http://blog.nosqlfan.com/html/3379.html)\n* redis持久化机制：[http://shanks.leanote.com/post/Untitled-55ca439338f41148cd000759-22](http://shanks.leanote.com/post/Untitled-55ca439338f41148cd000759-22)\n* Redis事务的分析及改进：[https://segmentfault.com/a/1190000002594059](https://segmentfault.com/a/1190000002594059)\n* redis 多数据库：[https://www.ttlsa.com/redis/redis-database/](https://www.ttlsa.com/redis/redis-database/)\n* 利用Sorted Set数据结构，为元素设置有效期：[http://stackoverflow.com/questions/7577923/redis-possible-to-expire-an-element-in-an-array-or-sorted-set](http://stackoverflow.com/questions/7577923/redis-possible-to-expire-an-element-in-an-array-or-sorted-set)\n* redis的Slave选举与优先级：[https://segmentfault.com/a/1190000002685515](https://segmentfault.com/a/1190000002685515)\n* 利用代理中间件实现大规模Redis集群：[http://www.imooc.com/article/4343](http://www.imooc.com/article/4343)","slug":"A-successful-redis-tuning-record","published":1,"updated":"2016-04-20T10:27:57.287Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ciowq3yu000024cnn9x4a4xhp","content":"<h2 id=\"我们怎么使用Redis？\"><a href=\"#我们怎么使用Redis？\" class=\"headerlink\" title=\"我们怎么使用Redis？\"></a>我们怎么使用Redis？</h2><p>公司目前主力开发的产品，是一个典型的平台电商型产品，包含了平台运营方、商家、消费者等角色。</p>\n<p>公司提供电商平台，同时负责系统维护和系统保障；商家与公司进行签约后，入驻平台，将商品投放到平台进行展示；平台依据商家签约信息，进行商品与消费者之间的兴趣推荐，消费者通过商品与商家达成消费订单后，平台按单依据签约与商家抽取利润。商家发现日订单分析有了提升后，可能会与平台达成更多的合作。从而演变出了良好的商业发展模式。</p>\n<p>平台电商型产品中，非常满足80/20法则(又称为:<a href=\"https://zh.wikipedia.org/wiki/%E5%B8%95%E9%9B%B7%E6%89%98%E6%B3%95%E5%88%99\" target=\"_blank\" rel=\"external\">帕雷托法则</a>),查询的业务量远远多于写入的业务量，为了提高<a href=\"http://www.ha97.com/5095.html\" target=\"_blank\" rel=\"external\">TPS</a>，降低对数据库的访问。我们也采取常规的做法，选用redis进行缓存常用业务数据。其中典型的就有：1.图片的信息、2.登录后的用户信息、3.全局超时锁、4.验证码。</p>\n<p>关于redis的技术选型，其实在我参与产品开发之前就已经完成了，在这个产品里也作为缓存层在使用。产品目前还在雏形孵化阶段，没有考虑太多关于分布式以及高可用的方案，对redis的使用很粗糙，在团队内可能熟悉redis的Developer不多，或者说有空又有耐心还熟悉redis的Developer没有吧？后来与PM的沟通后得知确实如此！</p>\n<h3 id=\"缓存图片信息\"><a href=\"#缓存图片信息\" class=\"headerlink\" title=\"缓存图片信息\"></a>缓存图片信息</h3><p>目前有很多业务在使用该缓存：商品的图片编辑，商家店面形象的图文自我介绍，用户针对订单的图文评价.</p>\n<p>这一部分的数据，在产品启动时(没有黑科技，就是在web.xml，自定义listener。)，读取Mysql中的File表，load进redis，数据量约120W条，没有做任何的分库分表处理。</p>\n<p>File表的结构如下：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">CREATE TABLE `file` (</span><br><span class=\"line\">  `id` int(11) NOT NULL AUTO_INCREMENT COMMENT &apos;图片ID&apos;,</span><br><span class=\"line\">  `uid` int(11) DEFAULT NULL COMMENT &apos;上传用户Id&apos;,</span><br><span class=\"line\">  `crc32` char(8) COLLATE utf8mb4_unicode_ci DEFAULT NULL COMMENT &apos;crc32校验和&apos;,</span><br><span class=\"line\">  `url` varchar(256) COLLATE utf8mb4_unicode_ci DEFAULT &apos;&apos; COMMENT &apos;对外访问的URL&apos;,</span><br><span class=\"line\">  `path` varchar(256) COLLATE utf8mb4_unicode_ci DEFAULT &apos;&apos; COMMENT &apos;存储的相对路径&apos;,</span><br><span class=\"line\">  `filename` varchar(128) COLLATE utf8mb4_unicode_ci NOT NULL DEFAULT &apos;&apos; COMMENT &apos;文件名字&apos;,</span><br><span class=\"line\">  `size` int(11) DEFAULT NULL COMMENT &apos;图片大小(单位byte)&apos;,</span><br><span class=\"line\">  `ext` char(5) COLLATE utf8mb4_unicode_ci NOT NULL DEFAULT &apos;&apos; COMMENT &apos;图片后缀&apos;,</span><br><span class=\"line\">  `is_image` tinyint(4) NOT NULL DEFAULT &apos;0&apos; COMMENT &apos;是否是图片，0为不是，1为是&apos;,</span><br><span class=\"line\">  `create_time` timestamp NULL DEFAULT CURRENT_TIMESTAMP COMMENT &apos;创建时间&apos;,</span><br><span class=\"line\">  `storage_type` tinyint(4) NOT NULL DEFAULT &apos;0&apos; COMMENT &apos;图片存储介质，0为fileSystem，1阿里云,2表示ppw老数据&apos;,</span><br><span class=\"line\">  PRIMARY KEY (`id`),</span><br><span class=\"line\">  UNIQUE KEY `filename` (`filename`) USING BTREE</span><br><span class=\"line\">) ENGINE=InnoDB AUTO_INCREMENT=1146617 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT=&apos;文件信息表&apos;;</span><br></pre></td></tr></table></figure></p>\n<p>有意思的是，每次产品启动时，读取到的所有File表记录，进行for循环，每一次循环中，访问一次redis。而在产品关闭时，删除redis的key，从而清除缓存？如果数据量愈来愈多，不就像做过山车一样，启动时加载全量数据，使用量飚的很高，关闭时删除全量缓存，使用量逐渐落回低谷(redis有<a href=\"http://wangneng-168.iteye.com/blog/2100379\" target=\"_blank\" rel=\"external\">内存释放机制</a>)。对于内存型中间件产品，这样的使用会带来很多的不可靠性。</p>\n<p>启动时加载数据到redis时的处理过程,部分为伪码：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">File表对应的实体类：</span><br><span class=\"line\">public class File&#123;//与数据库字段名完全的一致</span><br><span class=\"line\">    private int id;</span><br><span class=\"line\">    private int uid;</span><br><span class=\"line\">    private String crc32;</span><br><span class=\"line\">    private String url;</span><br><span class=\"line\">    private String path;</span><br><span class=\"line\">    private String filename;</span><br><span class=\"line\">    private int size;</span><br><span class=\"line\">    private String ext;</span><br><span class=\"line\">    private int is_image;</span><br><span class=\"line\">    private Timestamp create_time;</span><br><span class=\"line\">    private int storage_type;</span><br><span class=\"line\"></span><br><span class=\"line\">    //忽略 getter\\setter</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">//调用Dao层访问Mysql数据库，取回File表的所有记录，每条记录包含所有字段。</span><br><span class=\"line\">List&lt;File&gt; files=this.fileDao.getAll();</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">//读取File表的SQL：SELECT * FROM FILE;</span><br><span class=\"line\"></span><br><span class=\"line\">for(int i=0;i&lt;files.size();i++)&#123;</span><br><span class=\"line\">    this.cacheDao.setOneFileToRedis(files.get(i).getId(),files.get(i).getUrl());//调用Dao层访问Redis，将数据存入redis</span><br><span class=\"line\">    //WTF?只需要2个字段，然而取回了所有字段？而且不能批量存入redis?</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">cacheDao的实现</span><br><span class=\"line\">private final static String PHOTO_CACHE_KEY=&quot;photos&quot;;</span><br><span class=\"line\">public void setOneFileToRedis(int id,String url)&#123;</span><br><span class=\"line\">    this.jedis.hset(PHOTO_CACHE_KEY, id.toString(), url);//1.使用[Hash数据结构](https://redis.readthedocs.org/en/2.4/hash.html)。2.没有设置key有效期，即永久有效。</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">public String getOneFileInRedis(int id)&#123;</span><br><span class=\"line\">    return this.jedis.hget(PHOTO_CACHE_KEY, id.toString());</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n<p>这样图片信息缓存的结构看起来是这样:<br><img src=\"/img/photos在redis的数据结构示例.png\" alt=\"photos在redis的数据结构示例\"><br>实际的情况下，size远大于1000，上文说了约在120w左右，我的这个redis可视化工具(redisclient-win32.x86.2.0)无法获取size这样大的key，报SocketTimeOutException。猜测是向redis获取大key时，无法在一个socket包中写入，造成通讯失败。</p>\n<p>以上cacheDao的实现中，没有提供一次批量获取所需的多个图片信息，例如“public Map<integer,string> getBatchFileInRedis(int[] ids)”，甚至在cache interface中都没有提供这样的接口定义。</integer,string></p>\n<p>这样导致在上层逻辑中，出现大量一次性代码。因为调用不集中，给重构带来很大麻烦。<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">这是分页获取商品列表的伪代码实现</span><br><span class=\"line\"></span><br><span class=\"line\">与数据库product表对应的实体类</span><br><span class=\"line\">public class Product&#123;</span><br><span class=\"line\">    private int id;</span><br><span class=\"line\">    private String name;</span><br><span class=\"line\">    private long price;</span><br><span class=\"line\">    private int photoId;</span><br><span class=\"line\"></span><br><span class=\"line\">    //忽略 getter\\setter</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">真实的返回到app端的对象</span><br><span class=\"line\">public class ProductFull&#123;</span><br><span class=\"line\">    private int id;</span><br><span class=\"line\">    private String name;</span><br><span class=\"line\">    private long price;</span><br><span class=\"line\">    private int photoId;</span><br><span class=\"line\">    private String photoUrl;</span><br><span class=\"line\"></span><br><span class=\"line\">    //忽略 getter\\setter</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">public List&lt;ProductFull&gt; findProductByPage(int pageSize,int pageNo)&#123;</span><br><span class=\"line\">    List&lt;Product&gt; products=this.productDao.findByPage(int pageSize,int pageNo);//调用Dao层访问Mysql</span><br><span class=\"line\">    List&lt;ProductFull&gt; results=new ArrayList&lt;&gt;(products.size());</span><br><span class=\"line\">    for(Product product:products)&#123;</span><br><span class=\"line\">        ProductFull pf=new ProductFull();</span><br><span class=\"line\">        pf.setId(product.getId());//其他的属性值都是类似的拷贝，或借助Apache-Common beanUtils组件进行拷贝。</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">        String url=this.cacheDao.getOneFileInRedis(product.getPhotoId());//每一个循环项都访问了redis</span><br><span class=\"line\">        pf.setPhotoUrl(url);</span><br><span class=\"line\">        results.add(pf);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    return results;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">如果每个商品分页是10条，最坏情况下，需要访问1次Mysql+访问10次redis。非常严重的是，每个分页条数的大小由app端决定，服务端不限制，WTF?</span><br></pre></td></tr></table></figure></p>\n<h3 id=\"缓存登录后的用户信息\"><a href=\"#缓存登录后的用户信息\" class=\"headerlink\" title=\"缓存登录后的用户信息\"></a>缓存登录后的用户信息</h3><p>在这个产品面向消费者以及商家，都推出了不同的APP。互联网APP为了提高用户体验，以及降低用户登录登出频次(用户的登录/登出操作，对服务器是比较大的开销)，都会对一次登陆成功的用户，默认在一段时间不需要再次登录。即服务器分配Token给APP本地保存，同时服务器保存Token，设置该Token在一段时间不活动后自动失效，APP后续与服务器的通信中，都需要提交该Token鉴权。这是很常规的做法，短时间有效，而且是非关键性小数据，一次写入多次读取，对于服务器来说，没有比memcached或redis更合适的选择了，那为什么没有选择memcached？我个人的猜测是memcached更适合做Object Store Server，而且很重要的redis具有丰富数据结构与<a href=\"http://www.cnblogs.com/EE-NovRain/p/3268476.html\" target=\"_blank\" rel=\"external\">扩容与容灾机制</a>。</p>\n<p>用户的第一次登录，服务端进行参数解析，鉴权后，就需要写入2次redis。<br>用户的登出接口中，直接是删除当前会话的redis记录。</p>\n<p>第一次：写入本次登入的Token与用户信息的关联<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">登录成功后，从DB或Cache层获取用户数据，构造用户数据JSON</span><br><span class=\"line\">String userLoginSuccessInfo=&quot;&#123;&quot;uid&quot;:12321,&quot;name&quot;:&quot;张三&quot;,&quot;sex&quot;:0,&quot;avatar_id&quot;:345643&#125;&quot;;</span><br><span class=\"line\"></span><br><span class=\"line\">cacheDao的实现</span><br><span class=\"line\">private final static String SESSION_CACHE_KEY=&quot;session:&quot;;</span><br><span class=\"line\">//登录成功</span><br><span class=\"line\">public void setOneLoginSuccessToRedis(String token,String userLoginSuccessInfo)&#123;</span><br><span class=\"line\">    this.jedis.setex(SESSION_CACHE_KEY+token, 30*24*60*60, userLoginSuccessInfo);//1.使用String数据结构。2.设置key有效期30天。</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">//鉴权</span><br><span class=\"line\">public String getOneLoginSuccessInRedis(String token)&#123;</span><br><span class=\"line\">    return this.jedis.get(SESSION_CACHE_KEY+token);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">//登出</span><br><span class=\"line\">public void logoutSuccessInRedis(String token)&#123;</span><br><span class=\"line\">    this.jedis.del(SESSION_CACHE_KEY+token);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">这个以&quot;session:&quot;开头的key里，并没有实现从uid如何获取token值？</span><br><span class=\"line\">这会引发的问题：一个用户的多次登录，会生成多个以&quot;session:&quot;开头的key，没有覆盖之前登录的token。造成内存空间的浪费，以及不安全。正确的做法在下文会提到。</span><br></pre></td></tr></table></figure></p>\n<p>第二次：写入本次登入的用户id与24小时内的积分获取信息。</p>\n<p>有一个需求定义用户在登录后可以获取积分，但在24小时内的登录只算一次。</p>\n<p>那在服务器端的是实现是，用户第一次登录成功后，在redis写入一个与该用户相关的key，并设置24小时后失效，然后再增加积分。用户在24小时内进行第二次登录，先读取redis是否有相关的key，使用exist命令，如果已经有了，就不增加积分了。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">登录成功后，从DB或Cache层获取用户数据，构造用户与积分业务数据JSON</span><br><span class=\"line\">int uid=158263;</span><br><span class=\"line\"></span><br><span class=\"line\">cacheDao的实现</span><br><span class=\"line\">private final static String USER_ACTIVITY_CACHE_KEY=&quot;daily_activity_&quot;;</span><br><span class=\"line\">public void setOneUserWithActivityToRedis(int uid)&#123;</span><br><span class=\"line\">    this.jedis.setex(USER_ACTIVITY_CACHE_KEY+uid, 24*60*60, &quot;&quot;);//1.使用String数据结构。2.设置key有效期24h。3.value部分为空字符串？</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">public boolean checkOneUserWithActivityToRedis(int uid)&#123;</span><br><span class=\"line\">    this.jedis.exists(USER_ACTIVITY_CACHE_KEY+uid);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>这部分的业务属于典型案例，浪费内存空间。<br>第一个问题，不应该使用长前缀，每个key都需要set进内存，长前缀意味着空间占用，以及效率低下。<br>第二个问题，这不是明显可以使用<a href=\"https://redis.readthedocs.org/en/2.4/sorted_set.html\" target=\"_blank\" rel=\"external\">Sorted Set数据结构</a>?，还可以省掉一次exists检查。</p>\n<p>虽然redis的TPS很高，但是我们依旧要避免滥用。</p>\n<h2 id=\"这次的问题的描述？\"><a href=\"#这次的问题的描述？\" class=\"headerlink\" title=\"这次的问题的描述？\"></a>这次的问题的描述？</h2><p>测试MM提出在性能测试环境中，有一些API在并发数到250~300时，出现很多报错。<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">redis的相关错误</span><br><span class=\"line\">Could not get a resource from the pool</span><br></pre></td></tr></table></figure></p>\n<p>典型报错的接口有</p>\n<ul>\n<li>分页获取商品列表</li>\n<li>用户登录</li>\n</ul>\n<p>应用中配置redis连接池上限值是1000，而在redis server端配置maxClients=10000;区区这点并发，就耗尽redis连接池资源了？绝不可能，问题还在更远的地方等着我.</p>\n<p>性能测试环境配置<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">硬件配置</span><br><span class=\"line\">操作系统    Linux Ubuntu 14.04.4 LTS</span><br><span class=\"line\">CPU个数   4</span><br><span class=\"line\">CPU时钟频率 2.6G</span><br><span class=\"line\">内存  4G</span><br><span class=\"line\">有无外部存储  云端存储</span><br><span class=\"line\"></span><br><span class=\"line\">软件配置</span><br><span class=\"line\">docker  1.9.1</span><br><span class=\"line\">mysql   5.6</span><br><span class=\"line\">jdk 1.8.0_72</span><br><span class=\"line\">solr    5.3.0</span><br><span class=\"line\">redis   3.0.5</span><br></pre></td></tr></table></figure></p>\n<h2 id=\"如何一步步的解决问题？\"><a href=\"#如何一步步的解决问题？\" class=\"headerlink\" title=\"如何一步步的解决问题？\"></a>如何一步步的解决问题？</h2><p>在描述问题产生背景时，其实也提到了很多不合理的地方，但<em>存在即合理</em>，处在现在的困境，一定有当时的无奈。现在我们一起来总结一下问题所在。</p>\n<h3 id=\"对缓存图片的处理存在的问题\"><a href=\"#对缓存图片的处理存在的问题\" class=\"headerlink\" title=\"对缓存图片的处理存在的问题\"></a>对缓存图片的处理存在的问题</h3><ul>\n<li>产品初始化时全量塞入redis/产品停止运行是全量卸掉</li>\n<li>产品初始化时塞入redis时，没有做批量操作</li>\n<li>对批量获取图片信息不支持，在接口层面就已经没有定义，对于可预见的需求没有进行考虑，这是架构设计的缺陷。</li>\n<li>引申：大量的数据，放在一个key里，会出现问题，需要进行水平切分(Sharding)。</li>\n</ul>\n<h4 id=\"方案\"><a href=\"#方案\" class=\"headerlink\" title=\"方案\"></a>方案</h4><p>1.图片的Id数据在File表采用了<em>自增长</em>的方式生成，不会出现重复，并且有顺序。我们可以利用这一点，在产品初始化时，在Mysql数据库File表只查找2个字段：id/url。程序处理时，先写入reids一个key，使用Hash数据结构，isInitIng:photos-true，标明到正在初始化，其他产品节点不需要重复初始化。使用hmset的方式，一次性将多个键值对存入到redis。完成后，修改isInitIng:photos-false。当有了新图片时，先在Mysql数据库File表进行保存，得到这个图片的Id以及url，使用hset加入该图片到redis。如果需要修改某一张图片的url，也可以用hset。这样在产品停止运行时，是不需要删除redis关于图片的数据的。</p>\n<p>2.cache层加入新接口，支持批量获取图片信息<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">private final static String PHOTO_CACHE_KEY=&quot;photos&quot;;</span><br><span class=\"line\">public void setFileToRedis(Map&lt;Integer,String&gt; photos)&#123;</span><br><span class=\"line\">    this.jedis.hmset(PHOTO_CACHE_KEY, photos);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">public Map&lt;Integer,String&gt; getBatchFileInRedis(int[] ids)&#123;</span><br><span class=\"line\">    return this.jedis.hmget(PHOTO_CACHE_KEY, coverArrayToString(ids));</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">private static String[] coverArrayToString(int[] ids)&#123;</span><br><span class=\"line\">    String[] results=new String[ids.length];</span><br><span class=\"line\">    for (int i = 0; i &lt; ids.length; i++) &#123;</span><br><span class=\"line\">        results[i]=ids[i]+&quot;&quot;;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    return results;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n<p>对之前循环调用的上层代码进行修改，改为调用批量获取接口。</p>\n<p>3.对于单个key承载大量的数据的情况，方案是对key下的values hash key进行分割，使用一定的算法将块状的数据均匀分布在多个key里。给一个<a href=\"http://blog.nosqlfan.com/html/3379.html\" target=\"_blank\" rel=\"external\">参考链接</a>。</p>\n<h3 id=\"对缓存用户登录的处理存在的问题\"><a href=\"#对缓存用户登录的处理存在的问题\" class=\"headerlink\" title=\"对缓存用户登录的处理存在的问题\"></a>对缓存用户登录的处理存在的问题</h3><ul>\n<li>session的存储不合理，每次登陆都会生成一个新的key值</li>\n<li>对USER_ACTIVITY_CACHE_KEY在value部分的数据结构不合理，应采用Sorted Set</li>\n<li>对USER_ACTIVITY_CACHE_KEY的命名不合适，过长导致空间浪费和效率低下</li>\n<li>因采用错误数据结构，USER_ACTIVITY_CACHE_KEY需要进行多一次的exists判断。</li>\n</ul>\n<h4 id=\"方案-1\"><a href=\"#方案-1\" class=\"headerlink\" title=\"方案\"></a>方案</h4><p>session的存储不合理的解决，通过新的key(uid:token)来反向标记uid与token的关系，2个key的超时时间保持一致，例如<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">uid:158742-token001</span><br></pre></td></tr></table></figure></p>\n<p>在写入SESSION_CACHE_KEY时，同时写入到redis，为保证2次写入的原子性，需要使用<a href=\"https://redis.readthedocs.org/en/2.4/transaction.html\" target=\"_blank\" rel=\"external\">redis的事务</a>。如果支持用户的多设备在线，只需要将key(uid:token)更改为Sorted Set结构。因为不存在资源的争夺，这个事务几乎不会失败。在用户登出时，删除掉当前会话信息以及用户关联的会话信息(同样是使用redis事务)。</p>\n<p>注意，单机redis环境下，事务命令被完整的支持。扩展到多机redis协同工作时，如果使用了twemproxy，则事务命令不受支持，无法应用该方案。<a href=\"https://github.com/twitter/twemproxy/blob/master/notes/redis.md\" target=\"_blank\" rel=\"external\">查看twemproxy对redis命令的支持情况</a>。<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cacheDao的实现</span><br><span class=\"line\">private final static String SESSION_CACHE_KEY=&quot;se:&quot;;//全称：&quot;session:&quot;，改善key命名，按业务进行简略，提升网络传输和存储效率。</span><br><span class=\"line\">private final static String USER_TOKEN_CACHE_KEY=&quot;u:t:&quot;;//uid:token:</span><br><span class=\"line\">//登录成功，保存用户登录Token。接收建议的token参数值，返回实际保存的token值。</span><br><span class=\"line\">public String setOneLoginSuccessToRedis(int uid,String token,String userLoginSuccessInfo)&#123;//重构</span><br><span class=\"line\">    if(checkOneUserTokenExists(uid))&#123;</span><br><span class=\"line\">        token=getOneUserToken(uid);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    long expireTime=30*24*60*60;//设置key有效期30天。</span><br><span class=\"line\">    String ret=this.jedis.watch(SESSION_CACHE_KEY+token,USER_TOKEN_CACHE_KEY+uid);//乐观锁，重试，在这里几乎不存在</span><br><span class=\"line\">    if(ret==null||!ret.equals(&quot;OK&quot;))&#123;</span><br><span class=\"line\">        log.error(&quot;redis watch 操作失败.ret:&#123;&#125;&quot;,ret);</span><br><span class=\"line\">        this.jedis.unwatch();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    Transaction tx = this.jedis.multi();</span><br><span class=\"line\">    tx.setex(SESSION_CACHE_KEY+token, expireTime, userLoginSuccessInfo);</span><br><span class=\"line\">    tx.setex(USER_TOKEN_CACHE_KEY+uid, expireTime, token);</span><br><span class=\"line\">    List&lt;Object&gt; results = tx.exec();</span><br><span class=\"line\">    return token;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">//检查用户登录Token是否已经存在</span><br><span class=\"line\">public boolean checkOneUserTokenExists(int uid)&#123;//新方法</span><br><span class=\"line\">    return this.jedis.exists(USER_TOKEN_CACHE_KEY+uid);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">//获取用户登录Token信息</span><br><span class=\"line\">public String getOneUserToken(int uid)&#123;//新方法</span><br><span class=\"line\">    return this.jedis.get(USER_TOKEN_CACHE_KEY+uid);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">//鉴权</span><br><span class=\"line\">public String getOneLoginSuccessInRedis(String token)&#123;//不改动</span><br><span class=\"line\">    return this.jedis.get(SESSION_CACHE_KEY+token);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">//登出</span><br><span class=\"line\">public void logoutSuccessInRedis(String token)&#123;</span><br><span class=\"line\">    String ret=this.jedis.watch(SESSION_CACHE_KEY+token,USER_TOKEN_CACHE_KEY+uid);//乐观锁，重试，在这里几乎不存在</span><br><span class=\"line\">    if(ret==null||!ret.equals(&quot;OK&quot;))&#123;</span><br><span class=\"line\">        log.error(&quot;redis watch 操作失败.ret:&#123;&#125;&quot;,ret);</span><br><span class=\"line\">        this.jedis.unwatch();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    Transaction tx = this.jedis.multi();</span><br><span class=\"line\">    tx.del(SESSION_CACHE_KEY+token);</span><br><span class=\"line\">    tx.del(USER_TOKEN_CACHE_KEY+uid);</span><br><span class=\"line\">    List&lt;Object&gt; results = tx.exec();</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n<h4 id=\"隐患和思考\"><a href=\"#隐患和思考\" class=\"headerlink\" title=\"隐患和思考\"></a>隐患和思考</h4><p>redis事务带来的问题，redis的事务设计比较暴力，这给应用层带来了麻烦。</p>\n<ul>\n<li>Redis的基本事务（basic transaction）需要用到MULTI命令和EXEC命令，这种事务可以让一个客户端在不被其他客户端打断的情况下执行多个命令。和关系数据库那种可以在执行的过程中进行回滚（rollback）的事务不同，在Redis里面，被MULTI命令和EXEC命令包围的所有命令会一个接一个地执行，直到所有命令都执行完毕为止。当一个事务执行完毕之后，Redis才会处理其他客户端的命令。</li>\n<li><a href=\"http://redisdoc.com/topic/transaction.html\" target=\"_blank\" rel=\"external\">Redis 在事务失败时不进行回滚，而是继续执行余下的命令</a></li>\n</ul>\n<p>基于此，redis事务会在客户端高并发时，其他客户端命令产生阻塞，而且事务回滚需要应用层自己解决。关于事务无法自动回滚，这在NoSQL领域是常见问题了。</p>\n<h4 id=\"redis时间线设计\"><a href=\"#redis时间线设计\" class=\"headerlink\" title=\"redis时间线设计\"></a>redis时间线设计</h4><p>接下来对用户在24小时内的积分信息的处理进行改进，以及redis不支持对Set内的单个Element进行有效期设置，我们采用Sorted Set结构，结合Score特性和Quartz来达到元素过期被删除的目的。<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cacheDao的实现</span><br><span class=\"line\">private final static String USER_ACTIVITY_CACHE_KEY=&quot;a:d&quot;;//全称：&quot;activity:daily:&quot;，改善key命名，按业务进行简略，提升网络传输和存储效率。</span><br><span class=\"line\">public void setOneUserWithActivityToRedis(int uid)&#123;</span><br><span class=\"line\">    this.jedis.zadd(USER_ACTIVITY_CACHE_KEY,System.currentTimeMillis(),uid+&quot;&quot;);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">public boolean checkOneUserWithActivityToRedis(int uid)&#123;</span><br><span class=\"line\">    this.jedis.sismember(USER_ACTIVITY_CACHE_KEY,uid+&quot;&quot;);</span><br><span class=\"line\">    long score=this.jedis.zscore(USER_ACTIVITY_CACHE_KEY,uid+&quot;&quot;);</span><br><span class=\"line\">    if(score&gt;0)&#123;</span><br><span class=\"line\">        return true;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    return false;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">另外加入一个计划任务，借助Quartz即可。</span><br><span class=\"line\">String corn=*/1 * * * * ?  //每1秒钟执行1次</span><br><span class=\"line\">public void cleanExpireUserWithActivity()&#123;</span><br><span class=\"line\">    long now=System.currentTimeMillis();</span><br><span class=\"line\">    long 1MAgo=now-60*1000;//1分钟前的时间</span><br><span class=\"line\">    long remCount=this.jedis.zremrangeByScore(USER_ACTIVITY_CACHE_KEY,1MAgo,now);</span><br><span class=\"line\">    log.info(&quot;成功删除的元素数量是：&#123;&#125;，执行时间是：&#123;&#125;&quot;,remCount,now);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n<h4 id=\"隐患和思考-1\"><a href=\"#隐患和思考-1\" class=\"headerlink\" title=\"隐患和思考\"></a>隐患和思考</h4><p>在上文给出的代码中，我们做了一定的容错性，每次删除过去1分钟的所有Element，这样Quartz出现故障时，如果在1分钟内得到fixed，影响的数据只限于1分钟内的Element。每1秒钟触发一次Quartz与删除过去1分钟的所有Element，这2个维度的频率需要权衡。</p>\n<ul>\n<li>过高频率的访问redis是否会有稳定性问题？</li>\n<li>删除Element的时间区间过大，是否会影响redis执行效率(时间复杂度:<a href=\"http://redisdoc.com/sorted_set/zrevrangebyscore.html\" target=\"_blank\" rel=\"external\">O(log(N)+M)</a>)，导致阻塞？</li>\n<li>高频率删除Element，是否会影响redis的RDB与AOF备份，因此造成额外的问题？</li>\n</ul>\n<p>借助Quartz还有misfire的隐患，如何保障Quartz在每一秒钟都顺畅执行一次(Once and only once)，这涉及到操作系统、内存的可靠性，这是一个大的命题，我们不过多讨论。</p>\n<p>记录一下对这类问题的思考</p>\n<ul>\n<li>可以对这个计划任务进行多机并行运行。例如：A计划与B计划都处于运行状态，A在奇数秒触发，B在偶数秒触发。进一步降低2秒内misfire的概率。</li>\n<li>在Quartz启动Job时，检测到是业务高峰期，另开启一个异步线程，调用cleanExpireUserWithActivity方法，而cleanExpireUserWithActivity需要承受并发，即redis需要对zremrangeByScore命令支持并发，但redis是<a href=\"http://www.blogjava.net/caojianhua/archive/2013/01/28/394847.html\" target=\"_blank\" rel=\"external\">单进程单线程模型</a>。</li>\n<li>异步线程受制于redis，还可以进行改进，使用队列，如ActiveMQ。调用cleanExpireUserWithActivity逻辑进行调整，将命令序列化后写入到点对点队列，另外使用程序监听队列(即消费者端)，有新命令时取出，这里实际调用cleanExpireUserWithActivity，仅在调用成功后释放命令。</li>\n<li>现在问题在于如何保障ActiveMQ的稳定运行了，应该还有改进方案。</li>\n</ul>\n<p>按照以上的方案进行重构后，性能得到显著提升，按理论来说稳定性会有提高，因为不具备稳定性测试的条件，没法比较。</p>\n<h2 id=\"遇到了一些问题\"><a href=\"#遇到了一些问题\" class=\"headerlink\" title=\"遇到了一些问题\"></a>遇到了一些问题</h2><p>1.redis一次批量hmset过多时报错<br>hmset操作时，对于一次传入参数数量上限有要求。这取决于你的网络环境下，socket一次写入的字节数上限。<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">public String hmset(final String key, final Map&lt;String, String&gt; hash);</span><br></pre></td></tr></table></figure></p>\n<p>在我本机的环境下(应用与redis都在本机，不同端口，redis以默认配置运行)，Map<string, string=\"\"> hash的size大于5w左右就会报错。<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">redis.clients.jedis.exceptions.JedisConnectionException: java.net.SocketException: Software caused connection abort: socket write error</span><br><span class=\"line\">    at redis.clients.jedis.Protocol.sendCommand(Protocol.java:98)</span><br><span class=\"line\">    at redis.clients.jedis.Protocol.sendCommand(Protocol.java:78)</span><br><span class=\"line\">    at redis.clients.jedis.Connection.sendCommand(Connection.java:101)</span><br><span class=\"line\">    at redis.clients.jedis.BinaryClient.hmset(BinaryClient.java:246)</span><br><span class=\"line\">    at redis.clients.jedis.Client.hmset(Client.java:171)</span><br><span class=\"line\">    at redis.clients.jedis.Jedis.hmset(Jedis.java:652)</span><br></pre></td></tr></table></figure></string,></p>\n<p>在这种情况下，必需要将大Map切分成一块块的Map，循环调用hmset<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">final static int maxEveryTurn=5000;//定义每次最多批量塞入redis的key数量</span><br><span class=\"line\">    /**</span><br><span class=\"line\">     * 批量存储到redis的key数量太多，必需切分成小块存储</span><br><span class=\"line\">     */</span><br><span class=\"line\">    private static void setTooManyToJedis(Jedis jedis, Map&lt;String, String&gt; map) &#123;</span><br><span class=\"line\">        int size=map.size();</span><br><span class=\"line\">        int pieceNum=size/maxEveryTurn;</span><br><span class=\"line\">        if(size&gt;(pieceNum*maxEveryTurn))&#123;</span><br><span class=\"line\">            pieceNum+=1;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        Iterator&lt;Map.Entry&lt;String, String&gt;&gt; iterator = map.entrySet().iterator();</span><br><span class=\"line\">        List&lt;Map&lt;String, String&gt;&gt; list=new ArrayList&lt;&gt;(pieceNum);</span><br><span class=\"line\">        for (int i=0;i&lt;pieceNum;i++)&#123;</span><br><span class=\"line\">            list.add(new HashMap&lt;&gt;(maxEveryTurn));</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        while (iterator.hasNext()) &#123;</span><br><span class=\"line\">            Map.Entry&lt;String, String&gt; entry = iterator.next();</span><br><span class=\"line\">            String key = entry.getKey();</span><br><span class=\"line\">            int hashCode = Math.abs(String.valueOf(key).hashCode());</span><br><span class=\"line\">            int index=hashCode % pieceNum;</span><br><span class=\"line\">            list.get(index).put(key, map.get(key));</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        map.clear();</span><br><span class=\"line\">        for (Map&lt;String, String&gt; pieceMap:list)&#123;</span><br><span class=\"line\">            setToJedis(jedis, pieceMap);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        list.clear();</span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure></p>\n<p>2.持续写redis时遇到rdb问题<br>在完成以上方案的改进后，测试人员的用户登录这个接口在进行性能回归测试时，使用gatling配置250个工作线程进行并发，一共完成50w的用户登录后就算是结束，再根据生成的测试报告分析。<br>刚开始每次压到20多w的用户登录时，就会报错，redis连接池无连接了。分析代码是配置了testOnBorrow:true，这个配置会在获取到连接后检查该连接的有效性，如果无效就丢弃，即在连接池删掉一个连接。而此时redis因为问题无法执行用户端的任何命令，所以所有连接都被当做无效连接被丢弃？直到连接池空了。<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">在redis命令行执行</span><br><span class=\"line\">set test 12321</span><br><span class=\"line\">返回错误：</span><br><span class=\"line\">(error) MISCONF Redis is configured to save RDB snapshots, but is currently not able to persist on disk. Commands that may modify the data set are disabled. Please check Redis logs for details about the error.</span><br></pre></td></tr></table></figure></p>\n<p>这是因为默认的redis配置是以<a href=\"http://shanks.leanote.com/post/Untitled-55ca439338f41148cd000759-22\" target=\"_blank\" rel=\"external\">RDB的方式</a>进行定期存盘，而存盘时，会拒绝所有外部命令的写入(存盘失败后也会拒绝写入)。因为目前在redis的数据都处于可丢，解决方式也相当的粗暴。<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1.保证redis处于运行状态，查询系统6379端口的监听情况</span><br><span class=\"line\">2.顺序执行以下命令行，遇到错误请终止</span><br><span class=\"line\">docker exec -it test_redis_1 /bin/bash</span><br><span class=\"line\">cd usr/local/bin</span><br><span class=\"line\">./redis-cli.sh</span><br><span class=\"line\">config set stop-writes-on-bgsave-error no</span><br><span class=\"line\">config set save &quot;&quot;</span><br><span class=\"line\">quit</span><br><span class=\"line\">exit</span><br></pre></td></tr></table></figure></p>\n<p>执行完以后，重启应用，再压测，呵呵，bug关闭。</p>\n<h2 id=\"总结\"><a href=\"#总结\" class=\"headerlink\" title=\"总结\"></a>总结</h2><p>1.在最后一步提到RDB定期存盘，解决方案存在问题，强行关闭，会导致redis中的数据存在丢失风险，在这里建议有条件的，配置redis为1主1从，Master不进行任何形式的存盘，而Slave配置RDB和AOF方式的存盘，双保险。应用只连接Master即可。。注意Slave与Master第一次进行同步时会使用全量复制，对资源会有比较大的消耗，尽量选择在业务平峰期进行。<br>引申阅读，Master在这里成为了单点，为了Master的高可用，还有进一步的方案，1个Master下挂2个Slave，其中1个Slave(称为A)负责2种方式的存盘，另一个Slave(称为B)作为Master的热备，在Master故障后，参与到投票，成为新的Master，而B节点切换到A，接受A的增量同步。注意自动failover时，外部需要关闭写入命令。完成failover后，使用ip映射切换，使应用层重新恢复使用，相应的，应用层需要做到一定的容错性。实际生产中，不会要求应用层去做容错性措施，会有各种中间件(twemproxy)自动处理。</p>\n<p>2.以上业务中对<a href=\"https://www.ttlsa.com/redis/redis-database/\" target=\"_blank\" rel=\"external\">redis的16个数据库</a>没有使用好，可以按业务将数据存储到不同数据库，隔离影响。</p>\n<h3 id=\"常用命令合集\"><a href=\"#常用命令合集\" class=\"headerlink\" title=\"常用命令合集\"></a>常用命令合集</h3><p>调试过程中，由于可视化工具对redis支持的不够好，使用了很多redis的命令行，现在我们总结一下吧！<br>由于docker的风行，好处多多，我们在测试环境、线上环境也使用了docker/docker-compose</p>\n<h4 id=\"docker\"><a href=\"#docker\" class=\"headerlink\" title=\"docker\"></a>docker</h4><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker-compose ps          //查看yml文件中所有容器的运行情况</span><br><span class=\"line\">docker-compose up -d xw    //将yml文件中容器名称定义为xw的容器，以后台运行的方式运行起来，如果是tomcat镜像，会调用tomcat的startup.sh.</span><br><span class=\"line\">docker-compose stop xw     //将yml文件中容器名称定义为xw的容器停止，如果是tomcat镜像，会调用tomcat的shutdown.sh</span><br><span class=\"line\">docker-compose stop        //查看yml文件中所有容器进行停止</span><br><span class=\"line\">docker-compose rm xw       //移除xw镜像</span><br><span class=\"line\">docker-compose build xw    //对xw进行镜像构建</span><br></pre></td></tr></table></figure>\n<h4 id=\"redis-cli-sh-info\"><a href=\"#redis-cli-sh-info\" class=\"headerlink\" title=\"./redis-cli.sh/info\"></a>./redis-cli.sh/info</h4><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">F:\\Redis&gt; ./redis-cli</span><br><span class=\"line\">127.0.0.1:6379&gt; info</span><br><span class=\"line\"># Server</span><br><span class=\"line\">redis_version:3.0.501</span><br><span class=\"line\">redis_git_sha1:00000000</span><br><span class=\"line\">redis_git_dirty:0</span><br><span class=\"line\">redis_build_id:ba05b51e58eb9205</span><br><span class=\"line\">redis_mode:standalone</span><br><span class=\"line\">os:Windows</span><br><span class=\"line\">arch_bits:64</span><br><span class=\"line\">multiplexing_api:WinSock_IOCP</span><br><span class=\"line\">process_id:1552</span><br><span class=\"line\">run_id:d3f2efa1c6cf26c7cf9246c2fcaca89b8e109439</span><br><span class=\"line\">tcp_port:6379</span><br><span class=\"line\">uptime_in_seconds:462095</span><br><span class=\"line\">uptime_in_days:5</span><br><span class=\"line\">hz:10</span><br><span class=\"line\">lru_clock:16404129</span><br><span class=\"line\">config_file:F:\\Redis\\redis.windows.conf</span><br><span class=\"line\"></span><br><span class=\"line\"># Clients</span><br><span class=\"line\">connected_clients:1</span><br><span class=\"line\">client_longest_output_list:0</span><br><span class=\"line\">client_biggest_input_buf:0</span><br><span class=\"line\">blocked_clients:0</span><br><span class=\"line\"></span><br><span class=\"line\"># Memory</span><br><span class=\"line\">used_memory:842704</span><br><span class=\"line\">used_memory_human:822.95K</span><br><span class=\"line\">used_memory_rss:804920</span><br><span class=\"line\">used_memory_peak:374731600</span><br><span class=\"line\">used_memory_peak_human:357.37M</span><br><span class=\"line\">used_memory_lua:36864</span><br><span class=\"line\">mem_fragmentation_ratio:0.96</span><br><span class=\"line\">mem_allocator:jemalloc-3.6.0</span><br><span class=\"line\"></span><br><span class=\"line\"># Persistence</span><br><span class=\"line\">loading:0</span><br><span class=\"line\">rdb_changes_since_last_save:0</span><br><span class=\"line\">rdb_bgsave_in_progress:0</span><br><span class=\"line\">rdb_last_save_time:1459242952</span><br><span class=\"line\">rdb_last_bgsave_status:ok</span><br><span class=\"line\">rdb_last_bgsave_time_sec:1</span><br><span class=\"line\">rdb_current_bgsave_time_sec:-1</span><br><span class=\"line\">aof_enabled:0</span><br><span class=\"line\">aof_rewrite_in_progress:0</span><br><span class=\"line\">aof_rewrite_scheduled:0</span><br><span class=\"line\">aof_last_rewrite_time_sec:-1</span><br><span class=\"line\">aof_current_rewrite_time_sec:-1</span><br><span class=\"line\">aof_last_bgrewrite_status:ok</span><br><span class=\"line\">aof_last_write_status:ok</span><br><span class=\"line\"></span><br><span class=\"line\"># Stats</span><br><span class=\"line\">total_connections_received:1010</span><br><span class=\"line\">total_commands_processed:49859</span><br><span class=\"line\">instantaneous_ops_per_sec:0</span><br><span class=\"line\">total_net_input_bytes:1822381802</span><br><span class=\"line\">total_net_output_bytes:3650427</span><br><span class=\"line\">instantaneous_input_kbps:0.00</span><br><span class=\"line\">instantaneous_output_kbps:0.00</span><br><span class=\"line\">rejected_connections:0</span><br><span class=\"line\">sync_full:0</span><br><span class=\"line\">sync_partial_ok:0</span><br><span class=\"line\">sync_partial_err:0</span><br><span class=\"line\">expired_keys:1073</span><br><span class=\"line\">evicted_keys:0</span><br><span class=\"line\">keyspace_hits:20782</span><br><span class=\"line\">keyspace_misses:738</span><br><span class=\"line\">pubsub_channels:0</span><br><span class=\"line\">pubsub_patterns:0</span><br><span class=\"line\">latest_fork_usec:388023</span><br><span class=\"line\">migrate_cached_sockets:0</span><br><span class=\"line\"></span><br><span class=\"line\"># Replication</span><br><span class=\"line\">role:master</span><br><span class=\"line\">connected_slaves:0</span><br><span class=\"line\">master_repl_offset:0</span><br><span class=\"line\">repl_backlog_active:0</span><br><span class=\"line\">repl_backlog_size:1048576</span><br><span class=\"line\">repl_backlog_first_byte_offset:0</span><br><span class=\"line\">repl_backlog_histlen:0</span><br><span class=\"line\"></span><br><span class=\"line\"># CPU</span><br><span class=\"line\">used_cpu_sys:9.45</span><br><span class=\"line\">used_cpu_user:38.25</span><br><span class=\"line\">used_cpu_sys_children:0.00</span><br><span class=\"line\">used_cpu_user_children:0.00</span><br><span class=\"line\"></span><br><span class=\"line\"># Cluster</span><br><span class=\"line\">cluster_enabled:0</span><br><span class=\"line\"></span><br><span class=\"line\"># Keyspace</span><br><span class=\"line\">db0:keys=1,expires=0,avg_ttl=0</span><br></pre></td></tr></table></figure>\n<h4 id=\"set-get\"><a href=\"#set-get\" class=\"headerlink\" title=\"set/get\"></a>set/get</h4><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">127.0.0.1:6379&gt; set test 123456</span><br><span class=\"line\">OK</span><br><span class=\"line\">127.0.0.1:6379&gt; get test</span><br><span class=\"line\">&quot;123456&quot;</span><br></pre></td></tr></table></figure>\n<h4 id=\"hset-hmset-hget-hmget\"><a href=\"#hset-hmset-hget-hmget\" class=\"headerlink\" title=\"hset/hmset/hget/hmget\"></a>hset/hmset/hget/hmget</h4><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">127.0.0.1:6379&gt; hset testHash key1 value11</span><br><span class=\"line\">(integer) 1</span><br><span class=\"line\">127.0.0.1:6379&gt; hget testHash</span><br><span class=\"line\">(error) ERR wrong number of arguments for &apos;hget&apos; command</span><br><span class=\"line\">127.0.0.1:6379&gt; hget testHash key1</span><br><span class=\"line\">&quot;value11&quot;</span><br><span class=\"line\">127.0.0.1:6379&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">127.0.0.1:6379&gt; hset testHash key1 value11 key2 value22</span><br><span class=\"line\">(error) ERR wrong number of arguments for &apos;hset&apos; command</span><br><span class=\"line\">127.0.0.1:6379&gt; hmset testHash key1 value11 key2 value22</span><br><span class=\"line\">OK</span><br><span class=\"line\">127.0.0.1:6379&gt; hmget testHash key1 key2</span><br><span class=\"line\">1) &quot;value11&quot;</span><br><span class=\"line\">2) &quot;value22&quot;</span><br></pre></td></tr></table></figure>\n<h4 id=\"hlen-keys\"><a href=\"#hlen-keys\" class=\"headerlink\" title=\"hlen/keys\"></a>hlen/keys</h4><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">127.0.0.1:6379&gt; len test</span><br><span class=\"line\">(error) ERR unknown command &apos;len&apos;</span><br><span class=\"line\">127.0.0.1:6379&gt; hlen testHash</span><br><span class=\"line\">(integer) 2</span><br><span class=\"line\">127.0.0.1:6379&gt; keys test</span><br><span class=\"line\">1) &quot;test&quot;</span><br><span class=\"line\">127.0.0.1:6379&gt; keys testHash</span><br><span class=\"line\">1) &quot;testHash&quot;</span><br><span class=\"line\">127.0.0.1:6379&gt; keys *</span><br><span class=\"line\">1) &quot;testHash&quot;</span><br><span class=\"line\">2) &quot;test&quot;</span><br><span class=\"line\">3) &quot;message-queue-sms&quot;</span><br></pre></td></tr></table></figure>\n<h4 id=\"config-set-get\"><a href=\"#config-set-get\" class=\"headerlink\" title=\"config set/get\"></a>config set/get</h4><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">127.0.0.1:6379&gt; config get *</span><br><span class=\"line\">  1) &quot;dbfilename&quot;</span><br><span class=\"line\">  2) &quot;dump.rdb&quot;</span><br><span class=\"line\">  3) &quot;requirepass&quot;</span><br><span class=\"line\">  4) &quot;&quot;</span><br><span class=\"line\">  5) &quot;masterauth&quot;</span><br><span class=\"line\">  6) &quot;&quot;</span><br><span class=\"line\">  7) &quot;unixsocket&quot;</span><br><span class=\"line\">  8) &quot;&quot;</span><br><span class=\"line\">  9) &quot;logfile&quot;</span><br><span class=\"line\"> 10) &quot;&quot;</span><br><span class=\"line\"> 11) &quot;pidfile&quot;</span><br><span class=\"line\"> 12) &quot;/var/run/redis.pid&quot;</span><br><span class=\"line\"> 13) &quot;maxmemory&quot;</span><br><span class=\"line\"> 14) &quot;512000000&quot;</span><br><span class=\"line\"> 15) &quot;maxmemory-samples&quot;</span><br><span class=\"line\"> 16) &quot;5&quot;</span><br><span class=\"line\"> 17) &quot;timeout&quot;</span><br><span class=\"line\"> 18) &quot;0&quot;</span><br><span class=\"line\"> 19) &quot;tcp-keepalive&quot;</span><br><span class=\"line\"> 20) &quot;0&quot;</span><br><span class=\"line\"> 21) &quot;auto-aof-rewrite-percentage&quot;</span><br><span class=\"line\"> 22) &quot;100&quot;</span><br><span class=\"line\"> 23) &quot;auto-aof-rewrite-min-size&quot;</span><br><span class=\"line\"> 24) &quot;67108864&quot;</span><br><span class=\"line\"> 25) &quot;hash-max-ziplist-entries&quot;</span><br><span class=\"line\"> 26) &quot;512&quot;</span><br><span class=\"line\"> 27) &quot;hash-max-ziplist-value&quot;</span><br><span class=\"line\"> 28) &quot;64&quot;</span><br><span class=\"line\"> 29) &quot;list-max-ziplist-entries&quot;</span><br><span class=\"line\"> 30) &quot;512&quot;</span><br><span class=\"line\"> 31) &quot;list-max-ziplist-value&quot;</span><br><span class=\"line\"> 32) &quot;64&quot;</span><br><span class=\"line\"> 33) &quot;set-max-intset-entries&quot;</span><br><span class=\"line\"> 34) &quot;512&quot;</span><br><span class=\"line\"> 35) &quot;zset-max-ziplist-entries&quot;</span><br><span class=\"line\"> 36) &quot;128&quot;</span><br><span class=\"line\"> 37) &quot;zset-max-ziplist-value&quot;</span><br><span class=\"line\"> 38) &quot;64&quot;</span><br><span class=\"line\"> 39) &quot;hll-sparse-max-bytes&quot;</span><br><span class=\"line\"> 40) &quot;3000&quot;</span><br><span class=\"line\"> 41) &quot;lua-time-limit&quot;</span><br><span class=\"line\"> 42) &quot;5000&quot;</span><br><span class=\"line\"> 43) &quot;slowlog-log-slower-than&quot;</span><br><span class=\"line\"> 44) &quot;10000&quot;</span><br><span class=\"line\"> 45) &quot;latency-monitor-threshold&quot;</span><br><span class=\"line\"> 46) &quot;0&quot;</span><br><span class=\"line\"> 47) &quot;slowlog-max-len&quot;</span><br><span class=\"line\"> 48) &quot;128&quot;</span><br><span class=\"line\"> 49) &quot;port&quot;</span><br><span class=\"line\"> 50) &quot;6379&quot;</span><br><span class=\"line\"> 51) &quot;tcp-backlog&quot;</span><br><span class=\"line\"> 52) &quot;511&quot;</span><br><span class=\"line\"> 53) &quot;databases&quot;</span><br><span class=\"line\"> 54) &quot;16&quot;</span><br><span class=\"line\"> 55) &quot;repl-ping-slave-period&quot;</span><br><span class=\"line\"> 56) &quot;10&quot;</span><br><span class=\"line\"> 57) &quot;repl-timeout&quot;</span><br><span class=\"line\"> 58) &quot;60&quot;</span><br><span class=\"line\"> 59) &quot;repl-backlog-size&quot;</span><br><span class=\"line\"> 60) &quot;1048576&quot;</span><br><span class=\"line\"> 61) &quot;repl-backlog-ttl&quot;</span><br><span class=\"line\"> 62) &quot;3600&quot;</span><br><span class=\"line\"> 63) &quot;maxclients&quot;</span><br><span class=\"line\"> 64) &quot;10000&quot;</span><br><span class=\"line\"> 65) &quot;watchdog-period&quot;</span><br><span class=\"line\"> 66) &quot;0&quot;</span><br><span class=\"line\"> 67) &quot;slave-priority&quot;</span><br><span class=\"line\"> 68) &quot;100&quot;</span><br><span class=\"line\"> 69) &quot;min-slaves-to-write&quot;</span><br><span class=\"line\"> 70) &quot;0&quot;</span><br><span class=\"line\"> 71) &quot;min-slaves-max-lag&quot;</span><br><span class=\"line\"> 72) &quot;10&quot;</span><br><span class=\"line\"> 73) &quot;hz&quot;</span><br><span class=\"line\"> 74) &quot;10&quot;</span><br><span class=\"line\"> 75) &quot;cluster-node-timeout&quot;</span><br><span class=\"line\"> 76) &quot;15000&quot;</span><br><span class=\"line\"> 77) &quot;cluster-migration-barrier&quot;</span><br><span class=\"line\"> 78) &quot;1&quot;</span><br><span class=\"line\"> 79) &quot;cluster-slave-validity-factor&quot;</span><br><span class=\"line\"> 80) &quot;10&quot;</span><br><span class=\"line\"> 81) &quot;repl-diskless-sync-delay&quot;</span><br><span class=\"line\"> 82) &quot;5&quot;</span><br><span class=\"line\"> 83) &quot;cluster-require-full-coverage&quot;</span><br><span class=\"line\"> 84) &quot;yes&quot;</span><br><span class=\"line\"> 85) &quot;no-appendfsync-on-rewrite&quot;</span><br><span class=\"line\"> 86) &quot;no&quot;</span><br><span class=\"line\"> 87) &quot;slave-serve-stale-data&quot;</span><br><span class=\"line\"> 88) &quot;yes&quot;</span><br><span class=\"line\"> 89) &quot;slave-read-only&quot;</span><br><span class=\"line\"> 90) &quot;yes&quot;</span><br><span class=\"line\"> 91) &quot;stop-writes-on-bgsave-error&quot;</span><br><span class=\"line\"> 92) &quot;yes&quot;</span><br><span class=\"line\"> 93) &quot;daemonize&quot;</span><br><span class=\"line\"> 94) &quot;no&quot;</span><br><span class=\"line\"> 95) &quot;rdbcompression&quot;</span><br><span class=\"line\"> 96) &quot;yes&quot;</span><br><span class=\"line\"> 97) &quot;rdbchecksum&quot;</span><br><span class=\"line\"> 98) &quot;yes&quot;</span><br><span class=\"line\"> 99) &quot;activerehashing&quot;</span><br><span class=\"line\">100) &quot;yes&quot;</span><br><span class=\"line\">101) &quot;repl-disable-tcp-nodelay&quot;</span><br><span class=\"line\">102) &quot;no&quot;</span><br><span class=\"line\">103) &quot;repl-diskless-sync&quot;</span><br><span class=\"line\">104) &quot;no&quot;</span><br><span class=\"line\">105) &quot;aof-rewrite-incremental-fsync&quot;</span><br><span class=\"line\">106) &quot;yes&quot;</span><br><span class=\"line\">107) &quot;aof-load-truncated&quot;</span><br><span class=\"line\">108) &quot;yes&quot;</span><br><span class=\"line\">109) &quot;appendonly&quot;</span><br><span class=\"line\">110) &quot;no&quot;</span><br><span class=\"line\">111) &quot;dir&quot;</span><br><span class=\"line\">112) &quot;F:\\\\Redis&quot;</span><br><span class=\"line\">113) &quot;maxmemory-policy&quot;</span><br><span class=\"line\">114) &quot;noeviction&quot;</span><br><span class=\"line\">115) &quot;appendfsync&quot;</span><br><span class=\"line\">116) &quot;everysec&quot;</span><br><span class=\"line\">117) &quot;save&quot;</span><br><span class=\"line\">118) &quot;jd 900 jd 300 jd 60&quot;</span><br><span class=\"line\">119) &quot;loglevel&quot;</span><br><span class=\"line\">120) &quot;verbose&quot;</span><br><span class=\"line\">121) &quot;client-output-buffer-limit&quot;</span><br><span class=\"line\">122) &quot;normal 0 0 0 slave 268435456 67108864 60 pubsub 33554432 8388608 60&quot;</span><br><span class=\"line\">123) &quot;unixsocketperm&quot;</span><br><span class=\"line\">124) &quot;0&quot;</span><br><span class=\"line\">125) &quot;slaveof&quot;</span><br><span class=\"line\">126) &quot;&quot;</span><br><span class=\"line\">127) &quot;notify-keyspace-events&quot;</span><br><span class=\"line\">128) &quot;&quot;</span><br><span class=\"line\">129) &quot;bind&quot;</span><br><span class=\"line\">130) &quot;&quot;</span><br><span class=\"line\">127.0.0.1:6379&gt; config set save &quot;&quot;</span><br><span class=\"line\">OK</span><br></pre></td></tr></table></figure>\n<h4 id=\"flushdb-flushall\"><a href=\"#flushdb-flushall\" class=\"headerlink\" title=\"flushdb/flushall\"></a>flushdb/flushall</h4><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">127.0.0.1:6379&gt; flushdb</span><br><span class=\"line\">OK</span><br><span class=\"line\">127.0.0.1:6379&gt; flushall</span><br><span class=\"line\">OK</span><br></pre></td></tr></table></figure>\n<h2 id=\"扩展阅读\"><a href=\"#扩展阅读\" class=\"headerlink\" title=\"扩展阅读\"></a>扩展阅读</h2><ul>\n<li>redis删除有序集合部分过期元素：<a href=\"http://caozm.blog.51cto.com/1118764/1389168\" target=\"_blank\" rel=\"external\">http://caozm.blog.51cto.com/1118764/1389168</a></li>\n<li>节约内存：Instagram的Redis实践：<a href=\"http://blog.nosqlfan.com/html/3379.html\" target=\"_blank\" rel=\"external\">http://blog.nosqlfan.com/html/3379.html</a></li>\n<li>redis持久化机制：<a href=\"http://shanks.leanote.com/post/Untitled-55ca439338f41148cd000759-22\" target=\"_blank\" rel=\"external\">http://shanks.leanote.com/post/Untitled-55ca439338f41148cd000759-22</a></li>\n<li>Redis事务的分析及改进：<a href=\"https://segmentfault.com/a/1190000002594059\" target=\"_blank\" rel=\"external\">https://segmentfault.com/a/1190000002594059</a></li>\n<li>redis 多数据库：<a href=\"https://www.ttlsa.com/redis/redis-database/\" target=\"_blank\" rel=\"external\">https://www.ttlsa.com/redis/redis-database/</a></li>\n<li>利用Sorted Set数据结构，为元素设置有效期：<a href=\"http://stackoverflow.com/questions/7577923/redis-possible-to-expire-an-element-in-an-array-or-sorted-set\" target=\"_blank\" rel=\"external\">http://stackoverflow.com/questions/7577923/redis-possible-to-expire-an-element-in-an-array-or-sorted-set</a></li>\n<li>redis的Slave选举与优先级：<a href=\"https://segmentfault.com/a/1190000002685515\" target=\"_blank\" rel=\"external\">https://segmentfault.com/a/1190000002685515</a></li>\n<li>利用代理中间件实现大规模Redis集群：<a href=\"http://www.imooc.com/article/4343\" target=\"_blank\" rel=\"external\">http://www.imooc.com/article/4343</a></li>\n</ul>\n","excerpt":"","more":"<h2 id=\"我们怎么使用Redis？\"><a href=\"#我们怎么使用Redis？\" class=\"headerlink\" title=\"我们怎么使用Redis？\"></a>我们怎么使用Redis？</h2><p>公司目前主力开发的产品，是一个典型的平台电商型产品，包含了平台运营方、商家、消费者等角色。</p>\n<p>公司提供电商平台，同时负责系统维护和系统保障；商家与公司进行签约后，入驻平台，将商品投放到平台进行展示；平台依据商家签约信息，进行商品与消费者之间的兴趣推荐，消费者通过商品与商家达成消费订单后，平台按单依据签约与商家抽取利润。商家发现日订单分析有了提升后，可能会与平台达成更多的合作。从而演变出了良好的商业发展模式。</p>\n<p>平台电商型产品中，非常满足80/20法则(又称为:<a href=\"https://zh.wikipedia.org/wiki/%E5%B8%95%E9%9B%B7%E6%89%98%E6%B3%95%E5%88%99\">帕雷托法则</a>),查询的业务量远远多于写入的业务量，为了提高<a href=\"http://www.ha97.com/5095.html\">TPS</a>，降低对数据库的访问。我们也采取常规的做法，选用redis进行缓存常用业务数据。其中典型的就有：1.图片的信息、2.登录后的用户信息、3.全局超时锁、4.验证码。</p>\n<p>关于redis的技术选型，其实在我参与产品开发之前就已经完成了，在这个产品里也作为缓存层在使用。产品目前还在雏形孵化阶段，没有考虑太多关于分布式以及高可用的方案，对redis的使用很粗糙，在团队内可能熟悉redis的Developer不多，或者说有空又有耐心还熟悉redis的Developer没有吧？后来与PM的沟通后得知确实如此！</p>\n<h3 id=\"缓存图片信息\"><a href=\"#缓存图片信息\" class=\"headerlink\" title=\"缓存图片信息\"></a>缓存图片信息</h3><p>目前有很多业务在使用该缓存：商品的图片编辑，商家店面形象的图文自我介绍，用户针对订单的图文评价.</p>\n<p>这一部分的数据，在产品启动时(没有黑科技，就是在web.xml，自定义listener。)，读取Mysql中的File表，load进redis，数据量约120W条，没有做任何的分库分表处理。</p>\n<p>File表的结构如下：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">CREATE TABLE `file` (</span><br><span class=\"line\">  `id` int(11) NOT NULL AUTO_INCREMENT COMMENT &apos;图片ID&apos;,</span><br><span class=\"line\">  `uid` int(11) DEFAULT NULL COMMENT &apos;上传用户Id&apos;,</span><br><span class=\"line\">  `crc32` char(8) COLLATE utf8mb4_unicode_ci DEFAULT NULL COMMENT &apos;crc32校验和&apos;,</span><br><span class=\"line\">  `url` varchar(256) COLLATE utf8mb4_unicode_ci DEFAULT &apos;&apos; COMMENT &apos;对外访问的URL&apos;,</span><br><span class=\"line\">  `path` varchar(256) COLLATE utf8mb4_unicode_ci DEFAULT &apos;&apos; COMMENT &apos;存储的相对路径&apos;,</span><br><span class=\"line\">  `filename` varchar(128) COLLATE utf8mb4_unicode_ci NOT NULL DEFAULT &apos;&apos; COMMENT &apos;文件名字&apos;,</span><br><span class=\"line\">  `size` int(11) DEFAULT NULL COMMENT &apos;图片大小(单位byte)&apos;,</span><br><span class=\"line\">  `ext` char(5) COLLATE utf8mb4_unicode_ci NOT NULL DEFAULT &apos;&apos; COMMENT &apos;图片后缀&apos;,</span><br><span class=\"line\">  `is_image` tinyint(4) NOT NULL DEFAULT &apos;0&apos; COMMENT &apos;是否是图片，0为不是，1为是&apos;,</span><br><span class=\"line\">  `create_time` timestamp NULL DEFAULT CURRENT_TIMESTAMP COMMENT &apos;创建时间&apos;,</span><br><span class=\"line\">  `storage_type` tinyint(4) NOT NULL DEFAULT &apos;0&apos; COMMENT &apos;图片存储介质，0为fileSystem，1阿里云,2表示ppw老数据&apos;,</span><br><span class=\"line\">  PRIMARY KEY (`id`),</span><br><span class=\"line\">  UNIQUE KEY `filename` (`filename`) USING BTREE</span><br><span class=\"line\">) ENGINE=InnoDB AUTO_INCREMENT=1146617 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT=&apos;文件信息表&apos;;</span><br></pre></td></tr></table></figure></p>\n<p>有意思的是，每次产品启动时，读取到的所有File表记录，进行for循环，每一次循环中，访问一次redis。而在产品关闭时，删除redis的key，从而清除缓存？如果数据量愈来愈多，不就像做过山车一样，启动时加载全量数据，使用量飚的很高，关闭时删除全量缓存，使用量逐渐落回低谷(redis有<a href=\"http://wangneng-168.iteye.com/blog/2100379\">内存释放机制</a>)。对于内存型中间件产品，这样的使用会带来很多的不可靠性。</p>\n<p>启动时加载数据到redis时的处理过程,部分为伪码：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">File表对应的实体类：</span><br><span class=\"line\">public class File&#123;//与数据库字段名完全的一致</span><br><span class=\"line\">    private int id;</span><br><span class=\"line\">    private int uid;</span><br><span class=\"line\">    private String crc32;</span><br><span class=\"line\">    private String url;</span><br><span class=\"line\">    private String path;</span><br><span class=\"line\">    private String filename;</span><br><span class=\"line\">    private int size;</span><br><span class=\"line\">    private String ext;</span><br><span class=\"line\">    private int is_image;</span><br><span class=\"line\">    private Timestamp create_time;</span><br><span class=\"line\">    private int storage_type;</span><br><span class=\"line\"></span><br><span class=\"line\">    //忽略 getter\\setter</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">//调用Dao层访问Mysql数据库，取回File表的所有记录，每条记录包含所有字段。</span><br><span class=\"line\">List&lt;File&gt; files=this.fileDao.getAll();</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">//读取File表的SQL：SELECT * FROM FILE;</span><br><span class=\"line\"></span><br><span class=\"line\">for(int i=0;i&lt;files.size();i++)&#123;</span><br><span class=\"line\">    this.cacheDao.setOneFileToRedis(files.get(i).getId(),files.get(i).getUrl());//调用Dao层访问Redis，将数据存入redis</span><br><span class=\"line\">    //WTF?只需要2个字段，然而取回了所有字段？而且不能批量存入redis?</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">cacheDao的实现</span><br><span class=\"line\">private final static String PHOTO_CACHE_KEY=&quot;photos&quot;;</span><br><span class=\"line\">public void setOneFileToRedis(int id,String url)&#123;</span><br><span class=\"line\">    this.jedis.hset(PHOTO_CACHE_KEY, id.toString(), url);//1.使用[Hash数据结构](https://redis.readthedocs.org/en/2.4/hash.html)。2.没有设置key有效期，即永久有效。</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">public String getOneFileInRedis(int id)&#123;</span><br><span class=\"line\">    return this.jedis.hget(PHOTO_CACHE_KEY, id.toString());</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n<p>这样图片信息缓存的结构看起来是这样:<br><img src=\"/img/photos在redis的数据结构示例.png\" alt=\"photos在redis的数据结构示例\"><br>实际的情况下，size远大于1000，上文说了约在120w左右，我的这个redis可视化工具(redisclient-win32.x86.2.0)无法获取size这样大的key，报SocketTimeOutException。猜测是向redis获取大key时，无法在一个socket包中写入，造成通讯失败。</p>\n<p>以上cacheDao的实现中，没有提供一次批量获取所需的多个图片信息，例如“public Map<Integer,String> getBatchFileInRedis(int[] ids)”，甚至在cache interface中都没有提供这样的接口定义。</p>\n<p>这样导致在上层逻辑中，出现大量一次性代码。因为调用不集中，给重构带来很大麻烦。<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">这是分页获取商品列表的伪代码实现</span><br><span class=\"line\"></span><br><span class=\"line\">与数据库product表对应的实体类</span><br><span class=\"line\">public class Product&#123;</span><br><span class=\"line\">    private int id;</span><br><span class=\"line\">    private String name;</span><br><span class=\"line\">    private long price;</span><br><span class=\"line\">    private int photoId;</span><br><span class=\"line\"></span><br><span class=\"line\">    //忽略 getter\\setter</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">真实的返回到app端的对象</span><br><span class=\"line\">public class ProductFull&#123;</span><br><span class=\"line\">    private int id;</span><br><span class=\"line\">    private String name;</span><br><span class=\"line\">    private long price;</span><br><span class=\"line\">    private int photoId;</span><br><span class=\"line\">    private String photoUrl;</span><br><span class=\"line\"></span><br><span class=\"line\">    //忽略 getter\\setter</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">public List&lt;ProductFull&gt; findProductByPage(int pageSize,int pageNo)&#123;</span><br><span class=\"line\">    List&lt;Product&gt; products=this.productDao.findByPage(int pageSize,int pageNo);//调用Dao层访问Mysql</span><br><span class=\"line\">    List&lt;ProductFull&gt; results=new ArrayList&lt;&gt;(products.size());</span><br><span class=\"line\">    for(Product product:products)&#123;</span><br><span class=\"line\">        ProductFull pf=new ProductFull();</span><br><span class=\"line\">        pf.setId(product.getId());//其他的属性值都是类似的拷贝，或借助Apache-Common beanUtils组件进行拷贝。</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">        String url=this.cacheDao.getOneFileInRedis(product.getPhotoId());//每一个循环项都访问了redis</span><br><span class=\"line\">        pf.setPhotoUrl(url);</span><br><span class=\"line\">        results.add(pf);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    return results;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">如果每个商品分页是10条，最坏情况下，需要访问1次Mysql+访问10次redis。非常严重的是，每个分页条数的大小由app端决定，服务端不限制，WTF?</span><br></pre></td></tr></table></figure></p>\n<h3 id=\"缓存登录后的用户信息\"><a href=\"#缓存登录后的用户信息\" class=\"headerlink\" title=\"缓存登录后的用户信息\"></a>缓存登录后的用户信息</h3><p>在这个产品面向消费者以及商家，都推出了不同的APP。互联网APP为了提高用户体验，以及降低用户登录登出频次(用户的登录/登出操作，对服务器是比较大的开销)，都会对一次登陆成功的用户，默认在一段时间不需要再次登录。即服务器分配Token给APP本地保存，同时服务器保存Token，设置该Token在一段时间不活动后自动失效，APP后续与服务器的通信中，都需要提交该Token鉴权。这是很常规的做法，短时间有效，而且是非关键性小数据，一次写入多次读取，对于服务器来说，没有比memcached或redis更合适的选择了，那为什么没有选择memcached？我个人的猜测是memcached更适合做Object Store Server，而且很重要的redis具有丰富数据结构与<a href=\"http://www.cnblogs.com/EE-NovRain/p/3268476.html\">扩容与容灾机制</a>。</p>\n<p>用户的第一次登录，服务端进行参数解析，鉴权后，就需要写入2次redis。<br>用户的登出接口中，直接是删除当前会话的redis记录。</p>\n<p>第一次：写入本次登入的Token与用户信息的关联<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">登录成功后，从DB或Cache层获取用户数据，构造用户数据JSON</span><br><span class=\"line\">String userLoginSuccessInfo=&quot;&#123;&quot;uid&quot;:12321,&quot;name&quot;:&quot;张三&quot;,&quot;sex&quot;:0,&quot;avatar_id&quot;:345643&#125;&quot;;</span><br><span class=\"line\"></span><br><span class=\"line\">cacheDao的实现</span><br><span class=\"line\">private final static String SESSION_CACHE_KEY=&quot;session:&quot;;</span><br><span class=\"line\">//登录成功</span><br><span class=\"line\">public void setOneLoginSuccessToRedis(String token,String userLoginSuccessInfo)&#123;</span><br><span class=\"line\">    this.jedis.setex(SESSION_CACHE_KEY+token, 30*24*60*60, userLoginSuccessInfo);//1.使用String数据结构。2.设置key有效期30天。</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">//鉴权</span><br><span class=\"line\">public String getOneLoginSuccessInRedis(String token)&#123;</span><br><span class=\"line\">    return this.jedis.get(SESSION_CACHE_KEY+token);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">//登出</span><br><span class=\"line\">public void logoutSuccessInRedis(String token)&#123;</span><br><span class=\"line\">    this.jedis.del(SESSION_CACHE_KEY+token);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">这个以&quot;session:&quot;开头的key里，并没有实现从uid如何获取token值？</span><br><span class=\"line\">这会引发的问题：一个用户的多次登录，会生成多个以&quot;session:&quot;开头的key，没有覆盖之前登录的token。造成内存空间的浪费，以及不安全。正确的做法在下文会提到。</span><br></pre></td></tr></table></figure></p>\n<p>第二次：写入本次登入的用户id与24小时内的积分获取信息。</p>\n<p>有一个需求定义用户在登录后可以获取积分，但在24小时内的登录只算一次。</p>\n<p>那在服务器端的是实现是，用户第一次登录成功后，在redis写入一个与该用户相关的key，并设置24小时后失效，然后再增加积分。用户在24小时内进行第二次登录，先读取redis是否有相关的key，使用exist命令，如果已经有了，就不增加积分了。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">登录成功后，从DB或Cache层获取用户数据，构造用户与积分业务数据JSON</span><br><span class=\"line\">int uid=158263;</span><br><span class=\"line\"></span><br><span class=\"line\">cacheDao的实现</span><br><span class=\"line\">private final static String USER_ACTIVITY_CACHE_KEY=&quot;daily_activity_&quot;;</span><br><span class=\"line\">public void setOneUserWithActivityToRedis(int uid)&#123;</span><br><span class=\"line\">    this.jedis.setex(USER_ACTIVITY_CACHE_KEY+uid, 24*60*60, &quot;&quot;);//1.使用String数据结构。2.设置key有效期24h。3.value部分为空字符串？</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">public boolean checkOneUserWithActivityToRedis(int uid)&#123;</span><br><span class=\"line\">    this.jedis.exists(USER_ACTIVITY_CACHE_KEY+uid);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>这部分的业务属于典型案例，浪费内存空间。<br>第一个问题，不应该使用长前缀，每个key都需要set进内存，长前缀意味着空间占用，以及效率低下。<br>第二个问题，这不是明显可以使用<a href=\"https://redis.readthedocs.org/en/2.4/sorted_set.html\">Sorted Set数据结构</a>?，还可以省掉一次exists检查。</p>\n<p>虽然redis的TPS很高，但是我们依旧要避免滥用。</p>\n<h2 id=\"这次的问题的描述？\"><a href=\"#这次的问题的描述？\" class=\"headerlink\" title=\"这次的问题的描述？\"></a>这次的问题的描述？</h2><p>测试MM提出在性能测试环境中，有一些API在并发数到250~300时，出现很多报错。<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">redis的相关错误</span><br><span class=\"line\">Could not get a resource from the pool</span><br></pre></td></tr></table></figure></p>\n<p>典型报错的接口有</p>\n<ul>\n<li>分页获取商品列表</li>\n<li>用户登录</li>\n</ul>\n<p>应用中配置redis连接池上限值是1000，而在redis server端配置maxClients=10000;区区这点并发，就耗尽redis连接池资源了？绝不可能，问题还在更远的地方等着我.</p>\n<p>性能测试环境配置<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">硬件配置</span><br><span class=\"line\">操作系统    Linux Ubuntu 14.04.4 LTS</span><br><span class=\"line\">CPU个数   4</span><br><span class=\"line\">CPU时钟频率 2.6G</span><br><span class=\"line\">内存  4G</span><br><span class=\"line\">有无外部存储  云端存储</span><br><span class=\"line\"></span><br><span class=\"line\">软件配置</span><br><span class=\"line\">docker  1.9.1</span><br><span class=\"line\">mysql   5.6</span><br><span class=\"line\">jdk 1.8.0_72</span><br><span class=\"line\">solr    5.3.0</span><br><span class=\"line\">redis   3.0.5</span><br></pre></td></tr></table></figure></p>\n<h2 id=\"如何一步步的解决问题？\"><a href=\"#如何一步步的解决问题？\" class=\"headerlink\" title=\"如何一步步的解决问题？\"></a>如何一步步的解决问题？</h2><p>在描述问题产生背景时，其实也提到了很多不合理的地方，但<em>存在即合理</em>，处在现在的困境，一定有当时的无奈。现在我们一起来总结一下问题所在。</p>\n<h3 id=\"对缓存图片的处理存在的问题\"><a href=\"#对缓存图片的处理存在的问题\" class=\"headerlink\" title=\"对缓存图片的处理存在的问题\"></a>对缓存图片的处理存在的问题</h3><ul>\n<li>产品初始化时全量塞入redis/产品停止运行是全量卸掉</li>\n<li>产品初始化时塞入redis时，没有做批量操作</li>\n<li>对批量获取图片信息不支持，在接口层面就已经没有定义，对于可预见的需求没有进行考虑，这是架构设计的缺陷。</li>\n<li>引申：大量的数据，放在一个key里，会出现问题，需要进行水平切分(Sharding)。</li>\n</ul>\n<h4 id=\"方案\"><a href=\"#方案\" class=\"headerlink\" title=\"方案\"></a>方案</h4><p>1.图片的Id数据在File表采用了<em>自增长</em>的方式生成，不会出现重复，并且有顺序。我们可以利用这一点，在产品初始化时，在Mysql数据库File表只查找2个字段：id/url。程序处理时，先写入reids一个key，使用Hash数据结构，isInitIng:photos-true，标明到正在初始化，其他产品节点不需要重复初始化。使用hmset的方式，一次性将多个键值对存入到redis。完成后，修改isInitIng:photos-false。当有了新图片时，先在Mysql数据库File表进行保存，得到这个图片的Id以及url，使用hset加入该图片到redis。如果需要修改某一张图片的url，也可以用hset。这样在产品停止运行时，是不需要删除redis关于图片的数据的。</p>\n<p>2.cache层加入新接口，支持批量获取图片信息<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">private final static String PHOTO_CACHE_KEY=&quot;photos&quot;;</span><br><span class=\"line\">public void setFileToRedis(Map&lt;Integer,String&gt; photos)&#123;</span><br><span class=\"line\">    this.jedis.hmset(PHOTO_CACHE_KEY, photos);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">public Map&lt;Integer,String&gt; getBatchFileInRedis(int[] ids)&#123;</span><br><span class=\"line\">    return this.jedis.hmget(PHOTO_CACHE_KEY, coverArrayToString(ids));</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">private static String[] coverArrayToString(int[] ids)&#123;</span><br><span class=\"line\">    String[] results=new String[ids.length];</span><br><span class=\"line\">    for (int i = 0; i &lt; ids.length; i++) &#123;</span><br><span class=\"line\">        results[i]=ids[i]+&quot;&quot;;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    return results;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n<p>对之前循环调用的上层代码进行修改，改为调用批量获取接口。</p>\n<p>3.对于单个key承载大量的数据的情况，方案是对key下的values hash key进行分割，使用一定的算法将块状的数据均匀分布在多个key里。给一个<a href=\"http://blog.nosqlfan.com/html/3379.html\">参考链接</a>。</p>\n<h3 id=\"对缓存用户登录的处理存在的问题\"><a href=\"#对缓存用户登录的处理存在的问题\" class=\"headerlink\" title=\"对缓存用户登录的处理存在的问题\"></a>对缓存用户登录的处理存在的问题</h3><ul>\n<li>session的存储不合理，每次登陆都会生成一个新的key值</li>\n<li>对USER_ACTIVITY_CACHE_KEY在value部分的数据结构不合理，应采用Sorted Set</li>\n<li>对USER_ACTIVITY_CACHE_KEY的命名不合适，过长导致空间浪费和效率低下</li>\n<li>因采用错误数据结构，USER_ACTIVITY_CACHE_KEY需要进行多一次的exists判断。</li>\n</ul>\n<h4 id=\"方案-1\"><a href=\"#方案-1\" class=\"headerlink\" title=\"方案\"></a>方案</h4><p>session的存储不合理的解决，通过新的key(uid:token)来反向标记uid与token的关系，2个key的超时时间保持一致，例如<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">uid:158742-token001</span><br></pre></td></tr></table></figure></p>\n<p>在写入SESSION_CACHE_KEY时，同时写入到redis，为保证2次写入的原子性，需要使用<a href=\"https://redis.readthedocs.org/en/2.4/transaction.html\">redis的事务</a>。如果支持用户的多设备在线，只需要将key(uid:token)更改为Sorted Set结构。因为不存在资源的争夺，这个事务几乎不会失败。在用户登出时，删除掉当前会话信息以及用户关联的会话信息(同样是使用redis事务)。</p>\n<p>注意，单机redis环境下，事务命令被完整的支持。扩展到多机redis协同工作时，如果使用了twemproxy，则事务命令不受支持，无法应用该方案。<a href=\"https://github.com/twitter/twemproxy/blob/master/notes/redis.md\">查看twemproxy对redis命令的支持情况</a>。<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cacheDao的实现</span><br><span class=\"line\">private final static String SESSION_CACHE_KEY=&quot;se:&quot;;//全称：&quot;session:&quot;，改善key命名，按业务进行简略，提升网络传输和存储效率。</span><br><span class=\"line\">private final static String USER_TOKEN_CACHE_KEY=&quot;u:t:&quot;;//uid:token:</span><br><span class=\"line\">//登录成功，保存用户登录Token。接收建议的token参数值，返回实际保存的token值。</span><br><span class=\"line\">public String setOneLoginSuccessToRedis(int uid,String token,String userLoginSuccessInfo)&#123;//重构</span><br><span class=\"line\">    if(checkOneUserTokenExists(uid))&#123;</span><br><span class=\"line\">        token=getOneUserToken(uid);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    long expireTime=30*24*60*60;//设置key有效期30天。</span><br><span class=\"line\">    String ret=this.jedis.watch(SESSION_CACHE_KEY+token,USER_TOKEN_CACHE_KEY+uid);//乐观锁，重试，在这里几乎不存在</span><br><span class=\"line\">    if(ret==null||!ret.equals(&quot;OK&quot;))&#123;</span><br><span class=\"line\">        log.error(&quot;redis watch 操作失败.ret:&#123;&#125;&quot;,ret);</span><br><span class=\"line\">        this.jedis.unwatch();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    Transaction tx = this.jedis.multi();</span><br><span class=\"line\">    tx.setex(SESSION_CACHE_KEY+token, expireTime, userLoginSuccessInfo);</span><br><span class=\"line\">    tx.setex(USER_TOKEN_CACHE_KEY+uid, expireTime, token);</span><br><span class=\"line\">    List&lt;Object&gt; results = tx.exec();</span><br><span class=\"line\">    return token;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">//检查用户登录Token是否已经存在</span><br><span class=\"line\">public boolean checkOneUserTokenExists(int uid)&#123;//新方法</span><br><span class=\"line\">    return this.jedis.exists(USER_TOKEN_CACHE_KEY+uid);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">//获取用户登录Token信息</span><br><span class=\"line\">public String getOneUserToken(int uid)&#123;//新方法</span><br><span class=\"line\">    return this.jedis.get(USER_TOKEN_CACHE_KEY+uid);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">//鉴权</span><br><span class=\"line\">public String getOneLoginSuccessInRedis(String token)&#123;//不改动</span><br><span class=\"line\">    return this.jedis.get(SESSION_CACHE_KEY+token);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">//登出</span><br><span class=\"line\">public void logoutSuccessInRedis(String token)&#123;</span><br><span class=\"line\">    String ret=this.jedis.watch(SESSION_CACHE_KEY+token,USER_TOKEN_CACHE_KEY+uid);//乐观锁，重试，在这里几乎不存在</span><br><span class=\"line\">    if(ret==null||!ret.equals(&quot;OK&quot;))&#123;</span><br><span class=\"line\">        log.error(&quot;redis watch 操作失败.ret:&#123;&#125;&quot;,ret);</span><br><span class=\"line\">        this.jedis.unwatch();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    Transaction tx = this.jedis.multi();</span><br><span class=\"line\">    tx.del(SESSION_CACHE_KEY+token);</span><br><span class=\"line\">    tx.del(USER_TOKEN_CACHE_KEY+uid);</span><br><span class=\"line\">    List&lt;Object&gt; results = tx.exec();</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n<h4 id=\"隐患和思考\"><a href=\"#隐患和思考\" class=\"headerlink\" title=\"隐患和思考\"></a>隐患和思考</h4><p>redis事务带来的问题，redis的事务设计比较暴力，这给应用层带来了麻烦。</p>\n<ul>\n<li>Redis的基本事务（basic transaction）需要用到MULTI命令和EXEC命令，这种事务可以让一个客户端在不被其他客户端打断的情况下执行多个命令。和关系数据库那种可以在执行的过程中进行回滚（rollback）的事务不同，在Redis里面，被MULTI命令和EXEC命令包围的所有命令会一个接一个地执行，直到所有命令都执行完毕为止。当一个事务执行完毕之后，Redis才会处理其他客户端的命令。</li>\n<li><a href=\"http://redisdoc.com/topic/transaction.html\">Redis 在事务失败时不进行回滚，而是继续执行余下的命令</a></li>\n</ul>\n<p>基于此，redis事务会在客户端高并发时，其他客户端命令产生阻塞，而且事务回滚需要应用层自己解决。关于事务无法自动回滚，这在NoSQL领域是常见问题了。</p>\n<h4 id=\"redis时间线设计\"><a href=\"#redis时间线设计\" class=\"headerlink\" title=\"redis时间线设计\"></a>redis时间线设计</h4><p>接下来对用户在24小时内的积分信息的处理进行改进，以及redis不支持对Set内的单个Element进行有效期设置，我们采用Sorted Set结构，结合Score特性和Quartz来达到元素过期被删除的目的。<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cacheDao的实现</span><br><span class=\"line\">private final static String USER_ACTIVITY_CACHE_KEY=&quot;a:d&quot;;//全称：&quot;activity:daily:&quot;，改善key命名，按业务进行简略，提升网络传输和存储效率。</span><br><span class=\"line\">public void setOneUserWithActivityToRedis(int uid)&#123;</span><br><span class=\"line\">    this.jedis.zadd(USER_ACTIVITY_CACHE_KEY,System.currentTimeMillis(),uid+&quot;&quot;);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">public boolean checkOneUserWithActivityToRedis(int uid)&#123;</span><br><span class=\"line\">    this.jedis.sismember(USER_ACTIVITY_CACHE_KEY,uid+&quot;&quot;);</span><br><span class=\"line\">    long score=this.jedis.zscore(USER_ACTIVITY_CACHE_KEY,uid+&quot;&quot;);</span><br><span class=\"line\">    if(score&gt;0)&#123;</span><br><span class=\"line\">        return true;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    return false;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">另外加入一个计划任务，借助Quartz即可。</span><br><span class=\"line\">String corn=*/1 * * * * ?  //每1秒钟执行1次</span><br><span class=\"line\">public void cleanExpireUserWithActivity()&#123;</span><br><span class=\"line\">    long now=System.currentTimeMillis();</span><br><span class=\"line\">    long 1MAgo=now-60*1000;//1分钟前的时间</span><br><span class=\"line\">    long remCount=this.jedis.zremrangeByScore(USER_ACTIVITY_CACHE_KEY,1MAgo,now);</span><br><span class=\"line\">    log.info(&quot;成功删除的元素数量是：&#123;&#125;，执行时间是：&#123;&#125;&quot;,remCount,now);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n<h4 id=\"隐患和思考-1\"><a href=\"#隐患和思考-1\" class=\"headerlink\" title=\"隐患和思考\"></a>隐患和思考</h4><p>在上文给出的代码中，我们做了一定的容错性，每次删除过去1分钟的所有Element，这样Quartz出现故障时，如果在1分钟内得到fixed，影响的数据只限于1分钟内的Element。每1秒钟触发一次Quartz与删除过去1分钟的所有Element，这2个维度的频率需要权衡。</p>\n<ul>\n<li>过高频率的访问redis是否会有稳定性问题？</li>\n<li>删除Element的时间区间过大，是否会影响redis执行效率(时间复杂度:<a href=\"http://redisdoc.com/sorted_set/zrevrangebyscore.html\">O(log(N)+M)</a>)，导致阻塞？</li>\n<li>高频率删除Element，是否会影响redis的RDB与AOF备份，因此造成额外的问题？</li>\n</ul>\n<p>借助Quartz还有misfire的隐患，如何保障Quartz在每一秒钟都顺畅执行一次(Once and only once)，这涉及到操作系统、内存的可靠性，这是一个大的命题，我们不过多讨论。</p>\n<p>记录一下对这类问题的思考</p>\n<ul>\n<li>可以对这个计划任务进行多机并行运行。例如：A计划与B计划都处于运行状态，A在奇数秒触发，B在偶数秒触发。进一步降低2秒内misfire的概率。</li>\n<li>在Quartz启动Job时，检测到是业务高峰期，另开启一个异步线程，调用cleanExpireUserWithActivity方法，而cleanExpireUserWithActivity需要承受并发，即redis需要对zremrangeByScore命令支持并发，但redis是<a href=\"http://www.blogjava.net/caojianhua/archive/2013/01/28/394847.html\">单进程单线程模型</a>。</li>\n<li>异步线程受制于redis，还可以进行改进，使用队列，如ActiveMQ。调用cleanExpireUserWithActivity逻辑进行调整，将命令序列化后写入到点对点队列，另外使用程序监听队列(即消费者端)，有新命令时取出，这里实际调用cleanExpireUserWithActivity，仅在调用成功后释放命令。</li>\n<li>现在问题在于如何保障ActiveMQ的稳定运行了，应该还有改进方案。</li>\n</ul>\n<p>按照以上的方案进行重构后，性能得到显著提升，按理论来说稳定性会有提高，因为不具备稳定性测试的条件，没法比较。</p>\n<h2 id=\"遇到了一些问题\"><a href=\"#遇到了一些问题\" class=\"headerlink\" title=\"遇到了一些问题\"></a>遇到了一些问题</h2><p>1.redis一次批量hmset过多时报错<br>hmset操作时，对于一次传入参数数量上限有要求。这取决于你的网络环境下，socket一次写入的字节数上限。<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">public String hmset(final String key, final Map&lt;String, String&gt; hash);</span><br></pre></td></tr></table></figure></p>\n<p>在我本机的环境下(应用与redis都在本机，不同端口，redis以默认配置运行)，Map<String, String> hash的size大于5w左右就会报错。<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">redis.clients.jedis.exceptions.JedisConnectionException: java.net.SocketException: Software caused connection abort: socket write error</span><br><span class=\"line\">    at redis.clients.jedis.Protocol.sendCommand(Protocol.java:98)</span><br><span class=\"line\">    at redis.clients.jedis.Protocol.sendCommand(Protocol.java:78)</span><br><span class=\"line\">    at redis.clients.jedis.Connection.sendCommand(Connection.java:101)</span><br><span class=\"line\">    at redis.clients.jedis.BinaryClient.hmset(BinaryClient.java:246)</span><br><span class=\"line\">    at redis.clients.jedis.Client.hmset(Client.java:171)</span><br><span class=\"line\">    at redis.clients.jedis.Jedis.hmset(Jedis.java:652)</span><br></pre></td></tr></table></figure></p>\n<p>在这种情况下，必需要将大Map切分成一块块的Map，循环调用hmset<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">final static int maxEveryTurn=5000;//定义每次最多批量塞入redis的key数量</span><br><span class=\"line\">    /**</span><br><span class=\"line\">     * 批量存储到redis的key数量太多，必需切分成小块存储</span><br><span class=\"line\">     */</span><br><span class=\"line\">    private static void setTooManyToJedis(Jedis jedis, Map&lt;String, String&gt; map) &#123;</span><br><span class=\"line\">        int size=map.size();</span><br><span class=\"line\">        int pieceNum=size/maxEveryTurn;</span><br><span class=\"line\">        if(size&gt;(pieceNum*maxEveryTurn))&#123;</span><br><span class=\"line\">            pieceNum+=1;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        Iterator&lt;Map.Entry&lt;String, String&gt;&gt; iterator = map.entrySet().iterator();</span><br><span class=\"line\">        List&lt;Map&lt;String, String&gt;&gt; list=new ArrayList&lt;&gt;(pieceNum);</span><br><span class=\"line\">        for (int i=0;i&lt;pieceNum;i++)&#123;</span><br><span class=\"line\">            list.add(new HashMap&lt;&gt;(maxEveryTurn));</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        while (iterator.hasNext()) &#123;</span><br><span class=\"line\">            Map.Entry&lt;String, String&gt; entry = iterator.next();</span><br><span class=\"line\">            String key = entry.getKey();</span><br><span class=\"line\">            int hashCode = Math.abs(String.valueOf(key).hashCode());</span><br><span class=\"line\">            int index=hashCode % pieceNum;</span><br><span class=\"line\">            list.get(index).put(key, map.get(key));</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        map.clear();</span><br><span class=\"line\">        for (Map&lt;String, String&gt; pieceMap:list)&#123;</span><br><span class=\"line\">            setToJedis(jedis, pieceMap);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        list.clear();</span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure></p>\n<p>2.持续写redis时遇到rdb问题<br>在完成以上方案的改进后，测试人员的用户登录这个接口在进行性能回归测试时，使用gatling配置250个工作线程进行并发，一共完成50w的用户登录后就算是结束，再根据生成的测试报告分析。<br>刚开始每次压到20多w的用户登录时，就会报错，redis连接池无连接了。分析代码是配置了testOnBorrow:true，这个配置会在获取到连接后检查该连接的有效性，如果无效就丢弃，即在连接池删掉一个连接。而此时redis因为问题无法执行用户端的任何命令，所以所有连接都被当做无效连接被丢弃？直到连接池空了。<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">在redis命令行执行</span><br><span class=\"line\">set test 12321</span><br><span class=\"line\">返回错误：</span><br><span class=\"line\">(error) MISCONF Redis is configured to save RDB snapshots, but is currently not able to persist on disk. Commands that may modify the data set are disabled. Please check Redis logs for details about the error.</span><br></pre></td></tr></table></figure></p>\n<p>这是因为默认的redis配置是以<a href=\"http://shanks.leanote.com/post/Untitled-55ca439338f41148cd000759-22\">RDB的方式</a>进行定期存盘，而存盘时，会拒绝所有外部命令的写入(存盘失败后也会拒绝写入)。因为目前在redis的数据都处于可丢，解决方式也相当的粗暴。<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1.保证redis处于运行状态，查询系统6379端口的监听情况</span><br><span class=\"line\">2.顺序执行以下命令行，遇到错误请终止</span><br><span class=\"line\">docker exec -it test_redis_1 /bin/bash</span><br><span class=\"line\">cd usr/local/bin</span><br><span class=\"line\">./redis-cli.sh</span><br><span class=\"line\">config set stop-writes-on-bgsave-error no</span><br><span class=\"line\">config set save &quot;&quot;</span><br><span class=\"line\">quit</span><br><span class=\"line\">exit</span><br></pre></td></tr></table></figure></p>\n<p>执行完以后，重启应用，再压测，呵呵，bug关闭。</p>\n<h2 id=\"总结\"><a href=\"#总结\" class=\"headerlink\" title=\"总结\"></a>总结</h2><p>1.在最后一步提到RDB定期存盘，解决方案存在问题，强行关闭，会导致redis中的数据存在丢失风险，在这里建议有条件的，配置redis为1主1从，Master不进行任何形式的存盘，而Slave配置RDB和AOF方式的存盘，双保险。应用只连接Master即可。。注意Slave与Master第一次进行同步时会使用全量复制，对资源会有比较大的消耗，尽量选择在业务平峰期进行。<br>引申阅读，Master在这里成为了单点，为了Master的高可用，还有进一步的方案，1个Master下挂2个Slave，其中1个Slave(称为A)负责2种方式的存盘，另一个Slave(称为B)作为Master的热备，在Master故障后，参与到投票，成为新的Master，而B节点切换到A，接受A的增量同步。注意自动failover时，外部需要关闭写入命令。完成failover后，使用ip映射切换，使应用层重新恢复使用，相应的，应用层需要做到一定的容错性。实际生产中，不会要求应用层去做容错性措施，会有各种中间件(twemproxy)自动处理。</p>\n<p>2.以上业务中对<a href=\"https://www.ttlsa.com/redis/redis-database/\">redis的16个数据库</a>没有使用好，可以按业务将数据存储到不同数据库，隔离影响。</p>\n<h3 id=\"常用命令合集\"><a href=\"#常用命令合集\" class=\"headerlink\" title=\"常用命令合集\"></a>常用命令合集</h3><p>调试过程中，由于可视化工具对redis支持的不够好，使用了很多redis的命令行，现在我们总结一下吧！<br>由于docker的风行，好处多多，我们在测试环境、线上环境也使用了docker/docker-compose</p>\n<h4 id=\"docker\"><a href=\"#docker\" class=\"headerlink\" title=\"docker\"></a>docker</h4><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker-compose ps          //查看yml文件中所有容器的运行情况</span><br><span class=\"line\">docker-compose up -d xw    //将yml文件中容器名称定义为xw的容器，以后台运行的方式运行起来，如果是tomcat镜像，会调用tomcat的startup.sh.</span><br><span class=\"line\">docker-compose stop xw     //将yml文件中容器名称定义为xw的容器停止，如果是tomcat镜像，会调用tomcat的shutdown.sh</span><br><span class=\"line\">docker-compose stop        //查看yml文件中所有容器进行停止</span><br><span class=\"line\">docker-compose rm xw       //移除xw镜像</span><br><span class=\"line\">docker-compose build xw    //对xw进行镜像构建</span><br></pre></td></tr></table></figure>\n<h4 id=\"redis-cli-sh-info\"><a href=\"#redis-cli-sh-info\" class=\"headerlink\" title=\"./redis-cli.sh/info\"></a>./redis-cli.sh/info</h4><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">F:\\Redis&gt; ./redis-cli</span><br><span class=\"line\">127.0.0.1:6379&gt; info</span><br><span class=\"line\"># Server</span><br><span class=\"line\">redis_version:3.0.501</span><br><span class=\"line\">redis_git_sha1:00000000</span><br><span class=\"line\">redis_git_dirty:0</span><br><span class=\"line\">redis_build_id:ba05b51e58eb9205</span><br><span class=\"line\">redis_mode:standalone</span><br><span class=\"line\">os:Windows</span><br><span class=\"line\">arch_bits:64</span><br><span class=\"line\">multiplexing_api:WinSock_IOCP</span><br><span class=\"line\">process_id:1552</span><br><span class=\"line\">run_id:d3f2efa1c6cf26c7cf9246c2fcaca89b8e109439</span><br><span class=\"line\">tcp_port:6379</span><br><span class=\"line\">uptime_in_seconds:462095</span><br><span class=\"line\">uptime_in_days:5</span><br><span class=\"line\">hz:10</span><br><span class=\"line\">lru_clock:16404129</span><br><span class=\"line\">config_file:F:\\Redis\\redis.windows.conf</span><br><span class=\"line\"></span><br><span class=\"line\"># Clients</span><br><span class=\"line\">connected_clients:1</span><br><span class=\"line\">client_longest_output_list:0</span><br><span class=\"line\">client_biggest_input_buf:0</span><br><span class=\"line\">blocked_clients:0</span><br><span class=\"line\"></span><br><span class=\"line\"># Memory</span><br><span class=\"line\">used_memory:842704</span><br><span class=\"line\">used_memory_human:822.95K</span><br><span class=\"line\">used_memory_rss:804920</span><br><span class=\"line\">used_memory_peak:374731600</span><br><span class=\"line\">used_memory_peak_human:357.37M</span><br><span class=\"line\">used_memory_lua:36864</span><br><span class=\"line\">mem_fragmentation_ratio:0.96</span><br><span class=\"line\">mem_allocator:jemalloc-3.6.0</span><br><span class=\"line\"></span><br><span class=\"line\"># Persistence</span><br><span class=\"line\">loading:0</span><br><span class=\"line\">rdb_changes_since_last_save:0</span><br><span class=\"line\">rdb_bgsave_in_progress:0</span><br><span class=\"line\">rdb_last_save_time:1459242952</span><br><span class=\"line\">rdb_last_bgsave_status:ok</span><br><span class=\"line\">rdb_last_bgsave_time_sec:1</span><br><span class=\"line\">rdb_current_bgsave_time_sec:-1</span><br><span class=\"line\">aof_enabled:0</span><br><span class=\"line\">aof_rewrite_in_progress:0</span><br><span class=\"line\">aof_rewrite_scheduled:0</span><br><span class=\"line\">aof_last_rewrite_time_sec:-1</span><br><span class=\"line\">aof_current_rewrite_time_sec:-1</span><br><span class=\"line\">aof_last_bgrewrite_status:ok</span><br><span class=\"line\">aof_last_write_status:ok</span><br><span class=\"line\"></span><br><span class=\"line\"># Stats</span><br><span class=\"line\">total_connections_received:1010</span><br><span class=\"line\">total_commands_processed:49859</span><br><span class=\"line\">instantaneous_ops_per_sec:0</span><br><span class=\"line\">total_net_input_bytes:1822381802</span><br><span class=\"line\">total_net_output_bytes:3650427</span><br><span class=\"line\">instantaneous_input_kbps:0.00</span><br><span class=\"line\">instantaneous_output_kbps:0.00</span><br><span class=\"line\">rejected_connections:0</span><br><span class=\"line\">sync_full:0</span><br><span class=\"line\">sync_partial_ok:0</span><br><span class=\"line\">sync_partial_err:0</span><br><span class=\"line\">expired_keys:1073</span><br><span class=\"line\">evicted_keys:0</span><br><span class=\"line\">keyspace_hits:20782</span><br><span class=\"line\">keyspace_misses:738</span><br><span class=\"line\">pubsub_channels:0</span><br><span class=\"line\">pubsub_patterns:0</span><br><span class=\"line\">latest_fork_usec:388023</span><br><span class=\"line\">migrate_cached_sockets:0</span><br><span class=\"line\"></span><br><span class=\"line\"># Replication</span><br><span class=\"line\">role:master</span><br><span class=\"line\">connected_slaves:0</span><br><span class=\"line\">master_repl_offset:0</span><br><span class=\"line\">repl_backlog_active:0</span><br><span class=\"line\">repl_backlog_size:1048576</span><br><span class=\"line\">repl_backlog_first_byte_offset:0</span><br><span class=\"line\">repl_backlog_histlen:0</span><br><span class=\"line\"></span><br><span class=\"line\"># CPU</span><br><span class=\"line\">used_cpu_sys:9.45</span><br><span class=\"line\">used_cpu_user:38.25</span><br><span class=\"line\">used_cpu_sys_children:0.00</span><br><span class=\"line\">used_cpu_user_children:0.00</span><br><span class=\"line\"></span><br><span class=\"line\"># Cluster</span><br><span class=\"line\">cluster_enabled:0</span><br><span class=\"line\"></span><br><span class=\"line\"># Keyspace</span><br><span class=\"line\">db0:keys=1,expires=0,avg_ttl=0</span><br></pre></td></tr></table></figure>\n<h4 id=\"set-get\"><a href=\"#set-get\" class=\"headerlink\" title=\"set/get\"></a>set/get</h4><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">127.0.0.1:6379&gt; set test 123456</span><br><span class=\"line\">OK</span><br><span class=\"line\">127.0.0.1:6379&gt; get test</span><br><span class=\"line\">&quot;123456&quot;</span><br></pre></td></tr></table></figure>\n<h4 id=\"hset-hmset-hget-hmget\"><a href=\"#hset-hmset-hget-hmget\" class=\"headerlink\" title=\"hset/hmset/hget/hmget\"></a>hset/hmset/hget/hmget</h4><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">127.0.0.1:6379&gt; hset testHash key1 value11</span><br><span class=\"line\">(integer) 1</span><br><span class=\"line\">127.0.0.1:6379&gt; hget testHash</span><br><span class=\"line\">(error) ERR wrong number of arguments for &apos;hget&apos; command</span><br><span class=\"line\">127.0.0.1:6379&gt; hget testHash key1</span><br><span class=\"line\">&quot;value11&quot;</span><br><span class=\"line\">127.0.0.1:6379&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">127.0.0.1:6379&gt; hset testHash key1 value11 key2 value22</span><br><span class=\"line\">(error) ERR wrong number of arguments for &apos;hset&apos; command</span><br><span class=\"line\">127.0.0.1:6379&gt; hmset testHash key1 value11 key2 value22</span><br><span class=\"line\">OK</span><br><span class=\"line\">127.0.0.1:6379&gt; hmget testHash key1 key2</span><br><span class=\"line\">1) &quot;value11&quot;</span><br><span class=\"line\">2) &quot;value22&quot;</span><br></pre></td></tr></table></figure>\n<h4 id=\"hlen-keys\"><a href=\"#hlen-keys\" class=\"headerlink\" title=\"hlen/keys\"></a>hlen/keys</h4><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">127.0.0.1:6379&gt; len test</span><br><span class=\"line\">(error) ERR unknown command &apos;len&apos;</span><br><span class=\"line\">127.0.0.1:6379&gt; hlen testHash</span><br><span class=\"line\">(integer) 2</span><br><span class=\"line\">127.0.0.1:6379&gt; keys test</span><br><span class=\"line\">1) &quot;test&quot;</span><br><span class=\"line\">127.0.0.1:6379&gt; keys testHash</span><br><span class=\"line\">1) &quot;testHash&quot;</span><br><span class=\"line\">127.0.0.1:6379&gt; keys *</span><br><span class=\"line\">1) &quot;testHash&quot;</span><br><span class=\"line\">2) &quot;test&quot;</span><br><span class=\"line\">3) &quot;message-queue-sms&quot;</span><br></pre></td></tr></table></figure>\n<h4 id=\"config-set-get\"><a href=\"#config-set-get\" class=\"headerlink\" title=\"config set/get\"></a>config set/get</h4><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">127.0.0.1:6379&gt; config get *</span><br><span class=\"line\">  1) &quot;dbfilename&quot;</span><br><span class=\"line\">  2) &quot;dump.rdb&quot;</span><br><span class=\"line\">  3) &quot;requirepass&quot;</span><br><span class=\"line\">  4) &quot;&quot;</span><br><span class=\"line\">  5) &quot;masterauth&quot;</span><br><span class=\"line\">  6) &quot;&quot;</span><br><span class=\"line\">  7) &quot;unixsocket&quot;</span><br><span class=\"line\">  8) &quot;&quot;</span><br><span class=\"line\">  9) &quot;logfile&quot;</span><br><span class=\"line\"> 10) &quot;&quot;</span><br><span class=\"line\"> 11) &quot;pidfile&quot;</span><br><span class=\"line\"> 12) &quot;/var/run/redis.pid&quot;</span><br><span class=\"line\"> 13) &quot;maxmemory&quot;</span><br><span class=\"line\"> 14) &quot;512000000&quot;</span><br><span class=\"line\"> 15) &quot;maxmemory-samples&quot;</span><br><span class=\"line\"> 16) &quot;5&quot;</span><br><span class=\"line\"> 17) &quot;timeout&quot;</span><br><span class=\"line\"> 18) &quot;0&quot;</span><br><span class=\"line\"> 19) &quot;tcp-keepalive&quot;</span><br><span class=\"line\"> 20) &quot;0&quot;</span><br><span class=\"line\"> 21) &quot;auto-aof-rewrite-percentage&quot;</span><br><span class=\"line\"> 22) &quot;100&quot;</span><br><span class=\"line\"> 23) &quot;auto-aof-rewrite-min-size&quot;</span><br><span class=\"line\"> 24) &quot;67108864&quot;</span><br><span class=\"line\"> 25) &quot;hash-max-ziplist-entries&quot;</span><br><span class=\"line\"> 26) &quot;512&quot;</span><br><span class=\"line\"> 27) &quot;hash-max-ziplist-value&quot;</span><br><span class=\"line\"> 28) &quot;64&quot;</span><br><span class=\"line\"> 29) &quot;list-max-ziplist-entries&quot;</span><br><span class=\"line\"> 30) &quot;512&quot;</span><br><span class=\"line\"> 31) &quot;list-max-ziplist-value&quot;</span><br><span class=\"line\"> 32) &quot;64&quot;</span><br><span class=\"line\"> 33) &quot;set-max-intset-entries&quot;</span><br><span class=\"line\"> 34) &quot;512&quot;</span><br><span class=\"line\"> 35) &quot;zset-max-ziplist-entries&quot;</span><br><span class=\"line\"> 36) &quot;128&quot;</span><br><span class=\"line\"> 37) &quot;zset-max-ziplist-value&quot;</span><br><span class=\"line\"> 38) &quot;64&quot;</span><br><span class=\"line\"> 39) &quot;hll-sparse-max-bytes&quot;</span><br><span class=\"line\"> 40) &quot;3000&quot;</span><br><span class=\"line\"> 41) &quot;lua-time-limit&quot;</span><br><span class=\"line\"> 42) &quot;5000&quot;</span><br><span class=\"line\"> 43) &quot;slowlog-log-slower-than&quot;</span><br><span class=\"line\"> 44) &quot;10000&quot;</span><br><span class=\"line\"> 45) &quot;latency-monitor-threshold&quot;</span><br><span class=\"line\"> 46) &quot;0&quot;</span><br><span class=\"line\"> 47) &quot;slowlog-max-len&quot;</span><br><span class=\"line\"> 48) &quot;128&quot;</span><br><span class=\"line\"> 49) &quot;port&quot;</span><br><span class=\"line\"> 50) &quot;6379&quot;</span><br><span class=\"line\"> 51) &quot;tcp-backlog&quot;</span><br><span class=\"line\"> 52) &quot;511&quot;</span><br><span class=\"line\"> 53) &quot;databases&quot;</span><br><span class=\"line\"> 54) &quot;16&quot;</span><br><span class=\"line\"> 55) &quot;repl-ping-slave-period&quot;</span><br><span class=\"line\"> 56) &quot;10&quot;</span><br><span class=\"line\"> 57) &quot;repl-timeout&quot;</span><br><span class=\"line\"> 58) &quot;60&quot;</span><br><span class=\"line\"> 59) &quot;repl-backlog-size&quot;</span><br><span class=\"line\"> 60) &quot;1048576&quot;</span><br><span class=\"line\"> 61) &quot;repl-backlog-ttl&quot;</span><br><span class=\"line\"> 62) &quot;3600&quot;</span><br><span class=\"line\"> 63) &quot;maxclients&quot;</span><br><span class=\"line\"> 64) &quot;10000&quot;</span><br><span class=\"line\"> 65) &quot;watchdog-period&quot;</span><br><span class=\"line\"> 66) &quot;0&quot;</span><br><span class=\"line\"> 67) &quot;slave-priority&quot;</span><br><span class=\"line\"> 68) &quot;100&quot;</span><br><span class=\"line\"> 69) &quot;min-slaves-to-write&quot;</span><br><span class=\"line\"> 70) &quot;0&quot;</span><br><span class=\"line\"> 71) &quot;min-slaves-max-lag&quot;</span><br><span class=\"line\"> 72) &quot;10&quot;</span><br><span class=\"line\"> 73) &quot;hz&quot;</span><br><span class=\"line\"> 74) &quot;10&quot;</span><br><span class=\"line\"> 75) &quot;cluster-node-timeout&quot;</span><br><span class=\"line\"> 76) &quot;15000&quot;</span><br><span class=\"line\"> 77) &quot;cluster-migration-barrier&quot;</span><br><span class=\"line\"> 78) &quot;1&quot;</span><br><span class=\"line\"> 79) &quot;cluster-slave-validity-factor&quot;</span><br><span class=\"line\"> 80) &quot;10&quot;</span><br><span class=\"line\"> 81) &quot;repl-diskless-sync-delay&quot;</span><br><span class=\"line\"> 82) &quot;5&quot;</span><br><span class=\"line\"> 83) &quot;cluster-require-full-coverage&quot;</span><br><span class=\"line\"> 84) &quot;yes&quot;</span><br><span class=\"line\"> 85) &quot;no-appendfsync-on-rewrite&quot;</span><br><span class=\"line\"> 86) &quot;no&quot;</span><br><span class=\"line\"> 87) &quot;slave-serve-stale-data&quot;</span><br><span class=\"line\"> 88) &quot;yes&quot;</span><br><span class=\"line\"> 89) &quot;slave-read-only&quot;</span><br><span class=\"line\"> 90) &quot;yes&quot;</span><br><span class=\"line\"> 91) &quot;stop-writes-on-bgsave-error&quot;</span><br><span class=\"line\"> 92) &quot;yes&quot;</span><br><span class=\"line\"> 93) &quot;daemonize&quot;</span><br><span class=\"line\"> 94) &quot;no&quot;</span><br><span class=\"line\"> 95) &quot;rdbcompression&quot;</span><br><span class=\"line\"> 96) &quot;yes&quot;</span><br><span class=\"line\"> 97) &quot;rdbchecksum&quot;</span><br><span class=\"line\"> 98) &quot;yes&quot;</span><br><span class=\"line\"> 99) &quot;activerehashing&quot;</span><br><span class=\"line\">100) &quot;yes&quot;</span><br><span class=\"line\">101) &quot;repl-disable-tcp-nodelay&quot;</span><br><span class=\"line\">102) &quot;no&quot;</span><br><span class=\"line\">103) &quot;repl-diskless-sync&quot;</span><br><span class=\"line\">104) &quot;no&quot;</span><br><span class=\"line\">105) &quot;aof-rewrite-incremental-fsync&quot;</span><br><span class=\"line\">106) &quot;yes&quot;</span><br><span class=\"line\">107) &quot;aof-load-truncated&quot;</span><br><span class=\"line\">108) &quot;yes&quot;</span><br><span class=\"line\">109) &quot;appendonly&quot;</span><br><span class=\"line\">110) &quot;no&quot;</span><br><span class=\"line\">111) &quot;dir&quot;</span><br><span class=\"line\">112) &quot;F:\\\\Redis&quot;</span><br><span class=\"line\">113) &quot;maxmemory-policy&quot;</span><br><span class=\"line\">114) &quot;noeviction&quot;</span><br><span class=\"line\">115) &quot;appendfsync&quot;</span><br><span class=\"line\">116) &quot;everysec&quot;</span><br><span class=\"line\">117) &quot;save&quot;</span><br><span class=\"line\">118) &quot;jd 900 jd 300 jd 60&quot;</span><br><span class=\"line\">119) &quot;loglevel&quot;</span><br><span class=\"line\">120) &quot;verbose&quot;</span><br><span class=\"line\">121) &quot;client-output-buffer-limit&quot;</span><br><span class=\"line\">122) &quot;normal 0 0 0 slave 268435456 67108864 60 pubsub 33554432 8388608 60&quot;</span><br><span class=\"line\">123) &quot;unixsocketperm&quot;</span><br><span class=\"line\">124) &quot;0&quot;</span><br><span class=\"line\">125) &quot;slaveof&quot;</span><br><span class=\"line\">126) &quot;&quot;</span><br><span class=\"line\">127) &quot;notify-keyspace-events&quot;</span><br><span class=\"line\">128) &quot;&quot;</span><br><span class=\"line\">129) &quot;bind&quot;</span><br><span class=\"line\">130) &quot;&quot;</span><br><span class=\"line\">127.0.0.1:6379&gt; config set save &quot;&quot;</span><br><span class=\"line\">OK</span><br></pre></td></tr></table></figure>\n<h4 id=\"flushdb-flushall\"><a href=\"#flushdb-flushall\" class=\"headerlink\" title=\"flushdb/flushall\"></a>flushdb/flushall</h4><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">127.0.0.1:6379&gt; flushdb</span><br><span class=\"line\">OK</span><br><span class=\"line\">127.0.0.1:6379&gt; flushall</span><br><span class=\"line\">OK</span><br></pre></td></tr></table></figure>\n<h2 id=\"扩展阅读\"><a href=\"#扩展阅读\" class=\"headerlink\" title=\"扩展阅读\"></a>扩展阅读</h2><ul>\n<li>redis删除有序集合部分过期元素：<a href=\"http://caozm.blog.51cto.com/1118764/1389168\">http://caozm.blog.51cto.com/1118764/1389168</a></li>\n<li>节约内存：Instagram的Redis实践：<a href=\"http://blog.nosqlfan.com/html/3379.html\">http://blog.nosqlfan.com/html/3379.html</a></li>\n<li>redis持久化机制：<a href=\"http://shanks.leanote.com/post/Untitled-55ca439338f41148cd000759-22\">http://shanks.leanote.com/post/Untitled-55ca439338f41148cd000759-22</a></li>\n<li>Redis事务的分析及改进：<a href=\"https://segmentfault.com/a/1190000002594059\">https://segmentfault.com/a/1190000002594059</a></li>\n<li>redis 多数据库：<a href=\"https://www.ttlsa.com/redis/redis-database/\">https://www.ttlsa.com/redis/redis-database/</a></li>\n<li>利用Sorted Set数据结构，为元素设置有效期：<a href=\"http://stackoverflow.com/questions/7577923/redis-possible-to-expire-an-element-in-an-array-or-sorted-set\">http://stackoverflow.com/questions/7577923/redis-possible-to-expire-an-element-in-an-array-or-sorted-set</a></li>\n<li>redis的Slave选举与优先级：<a href=\"https://segmentfault.com/a/1190000002685515\">https://segmentfault.com/a/1190000002685515</a></li>\n<li>利用代理中间件实现大规模Redis集群：<a href=\"http://www.imooc.com/article/4343\">http://www.imooc.com/article/4343</a></li>\n</ul>\n"},{"title":"JOOQ 3.8.2 使用 教程：从入门到提高","date":"2016-04-01T09:38:14.463Z","description":"JOOQ (Java Object Oriented Querying) 作为ORM框架，其原理是：在DAO层使用Java语言编写SQL语句，在Intellij IDEA的辅助下，复杂SQL的维护变得很容易。通过内部SQL Builder转换成数据库可执行的SQL文本，使用数据库驱动，提交SQL到RDBMS执行，接受处理结果，转换为POJO，返回到应用层。","_content":"\n## 写在前面\n\n2016年后换了一家公司干，后台ORM框架用的JOOQ，完全陌生的东西。干这一行越久，越觉得有更多有趣的新事物需要去探索。想起小说[《火星救援》](https://book.douban.com/subject/26586492/)，Mark侥幸在火星风暴中幸存后，一步步将自己救出困境，遇到的难题或大或小，皆有优雅解决之法。一切看似偶然蹊跷，其实与Mark的长期知识储备分不开。所谓艺多不压身，应该在有限的时间里，得到更多成长，以期待机会来时不辜负。\n\n下文中的学习示例代码，已经整理完毕：\n\n* 原味基础学习：[https://github.com/amao12580/JOOQ](https://github.com/amao12580/JOOQ)\n\n* 与Spring深度整合：[https://github.com/amao12580/JOOQ-With-Spring](https://github.com/amao12580/JOOQ-With-Spring)\n\n## 什么是JOOQ？\n[JOOQ](http://www.jooq.org/)，全称Java Object Oriented Querying，即面向Java对象查询。它是[Data Geekery](http://www.datageekery.com/)公司研发的DA方案(Data Access Layer)，主要解决两个问题：\n\n1. Hibernate的抽象使得我们离SQL太远，对SQL的掌控力度弱\n2. JDBC又过于嘈杂，需要干的事情太多\n\nJOOQ希望干的就是在上述两者中寻找一个最佳的平衡。它依据数据库中的表生成DA相关的代码，开发者将生成的代码引入项目中即可使用。\n\n有好几个版本\n\n* OpenSource\n* Express\n* Professional\n* Enterprise\n\nOpenSource版本针对开源数据库，已经够用了。其它的几个版本针对非开源数据库，差异在于不同的后续支持。\n\n想了解各版本的更多区别，跟我一起看吧。\n\n* http://www.jooq.org/legal/licensing\n\n* http://www.jooq.org/download/\n\nJOOQ作为ORM框架，其原理是：在DAO层使用Java语言编写SQL语句，在Intellij IDEA的辅助下，复杂SQL的维护变得很容易。通过内部SQL Builder转换成数据库可执行的SQL文本，使用数据库驱动，提交SQL到RDBMS执行，接受处理结果，转换为POJO，返回到应用层。\n\n它与Hibernate不同，不依赖使用字符串变量在Java代码中拼接SQL语句。在复杂SQL语句中，与变量的组合拼接时，SQL被割裂成多个部分，失去了宝贵的可读性，这简直是噩梦。而且Hibernate饱受诟病的连接查询配置复杂以及HQL语法的问题，在JOOQ中不复存在。\n\n它与Mybatis不同，不依赖繁琐分散的XML进行SQL预定义。代码与SQL语句的分离，初衷是为了解决SQL嵌入代码时带来不直观的复杂性，但是分离的代价是维护工作倍增以及类型转换问题，经常遭遇到应用层代码变更，而XML定义未同步变更，IDE几乎无法解决。又或者开发人员改动一个XML文件，却意外影响多处上层代码，而这个问题很难避免。\n\n更进一步的，JOOQ提供原生的类型安全转换，以及POJO维护，免去大量一次性代码的编写。当然，你也可以使用Eclipse[代码生成插件](http://my.oschina.net/lujianing/blog/200135)解决这个问题，但是如果ORM能自动解决(结合Maven Plugin)，为什么拒绝呢？\n\n使用这种DAO模式，可以通过类的方式来进行数据库访问了。而且对SQL控制粒度加大的同时，维护工作并没有因此倍增，这对于开发人员是更好的解决方案，也是未来的趋势。\n\n```\n使用JOOQ进行2张表内连接查询示例\n\n// Typesafely execute the SQL statement directly with jOOQ\nResult<Record3<String, String, String>> result =\ncreate.select(BOOK.TITLE, AUTHOR.FIRST_NAME, AUTHOR.LAST_NAME)\n    .from(BOOK)\n    .join(AUTHOR)\n    .on(BOOK.AUTHOR_ID.equal(AUTHOR.ID))\n    .where(BOOK.PUBLISHED_IN.equal(1948))\n    .fetch();\n```\n\n### VS 主流ORM框架\n* [JOOQ vs. Hibernate: When to Choose Which](http://blog.jooq.org/2015/03/24/jooq-vs-hibernate-when-to-choose-which/)\n* [SQL Templating with jOOQ or MyBatis](http://blog.jooq.org/2013/07/13/sql-templating-with-jooq-or-mybatis/)\n### 优势和局限性\n\n优势\n\n* JOOQ 高效的合并了复杂SQL、[类型安全](http://blog.jooq.org/2015/05/26/type-safe-queries-for-jpas-native-query-api/)、[源码生成](#Code-Generation)、Active Records、存储过程以及高级数据类型的 Java 类库。支持DB2, Derby, Ingres, H2, HSQLDB, MySQL, Oracle, Postgres, SQLite, SQL Server, Sybase。\n\n局限性\n\n* 开发人员需要转换思维，接受新事物，May be better？\n\n## 入门篇\n### With MySQL\n```\n<!--MySQL JDBC driver, 数据库迁移等情况下需要. -->\n<dependency>\n    <groupId>mysql</groupId>\n    <artifactId>mysql-connector-java</artifactId>\n    <version>5.1.36</version>\n</dependency>\n```\n### Code Generation\n\n```\n<!--数据库schema代码生成器 -->\n<dependency>\n    <groupId>org.jooq</groupId>\n    <artifactId>jooq-codegen</artifactId>\n    <version>3.8.2</version>\n</dependency>\n\n<!--数据库代码生成的插件 -->\n<plugin>\n    <!-- Specify the maven code generator plugin -->\n    <groupId>org.jooq</groupId>\n    <artifactId>jooq-codegen-maven</artifactId>\n    <version>3.8.2</version>\n    <!-- The plugin should hook into the generate goal -->\n    <executions>\n        <execution>\n            <goals>\n                <goal>generate</goal>\n            </goals>\n        </execution>\n    </executions>\n    <configuration>\n        <!-- JDBC connection parameters -->\n        <jdbc>\n            <driver>com.mysql.jdbc.Driver</driver>\n            <url>${db.url}</url>\n            <user>${db.username}</user>\n            <password>${db.password}</password>\n        </jdbc>\n        <!-- Generator parameters -->\n        <generator>\n            <database>\n                <name>org.jooq.util.mysql.MySQLDatabase</name>\n                <includes>.*</includes>\n                <inputSchema>${db.schema}</inputSchema>\n                <forcedTypes>\n                    <forcedType>\n                        <name>BOOLEAN</name>\n                        <expression>.*\\.HANDMADE</expression>\n                        <types>.*</types>\n                    </forcedType>\n                </forcedTypes>\n            </database>\n            <target>\n                <packageName>com.study.jooq.common.generated</packageName>\n                <directory>src/main/java</directory>\n            </target>\n        </generator>\n    </configuration>\n</plugin>\n```\n### With Flyway\n\nFlyway 是独立于数据库的应用、管理并跟踪数据库变更的数据库版本管理工具。\n\n[Flyway， 数据库Schema管理利器](http://www.cnblogs.com/huang0925/p/4409506.html)\n\n在pom.xml的配置\n```\n<properties>\n    <project.build.sourceEncoding>UTF-8</project.build.sourceEncoding>\n\n    <!--防止maven改动IDE的language level -->\n    <maven.compiler.source>1.8</maven.compiler.source>\n    <maven.compiler.target>1.8</maven.compiler.target>\n\n    <!--数据库迁移所用的参数 -->\n    <db.url>jdbc:mysql://localhost:3306</db.url>\n    <db.username>root</db.username>\n    <db.password>********</db.password>\n    <db.schema>study</db.schema>\n</properties>\n\n<!--数据库迁移, 同步的插件 -->\n<plugin>\n    <groupId>org.flywaydb</groupId>\n    <artifactId>flyway-maven-plugin</artifactId>\n    <version>3.0</version>\n    <!-- Note that we're executing the Flyway plugin in the \"generate-sources\" phase -->\n    <executions>\n        <execution>\n            <phase>generate-sources</phase>\n            <goals>\n                <goal>migrate</goal>\n            </goals>\n        </execution>\n    </executions>\n    <!-- Note that we need to prefix the db/migration path with filesystem:\n    to prevent Flyway from looking for our migration scripts only on the classpath -->\n    <configuration>\n        <url>${db.url}</url>\n        <user>${db.username}</user>\n        <password>${db.password}</password>\n        <encoding>${project.build.sourceEncoding}</encoding>\n        <schemas>\n            <schema>${db.schema}</schema>\n        </schemas>\n        <locations>\n            <location>filesystem:src/main/resources/db/migration</location>\n        </locations>\n    </configuration>\n</plugin>\n```\n在工程：src/main/resources/db/migration目录下，没有目录文件夹时需要先创建文件夹。放入数据库初始化SQL脚本：V1__init_database.sql。注意在maven中配置的db.schema=study，表明需要使用的数据库名称是study，study需要事先不存在。\n\n执行maven -clean、maven -install成功后，发现数据库有了新的数据库study，并且该数据库有了order、user、schema_version三张表，user、order是我们在脚本中定义需要生成的表，而schema_version是flyway生成的，维护数据库版本升级时的信息。对应的在代码中，生成了三个POJO。\n\n代码生成示例：\n![IDEA使用JOOQ自动生成代码](/img/jooq-flyway.png)\n\n### With HikariCp\nHikariCP号称是现在性能最好的JDBC连接池组件，具体的性能到底如何，我也没有仔细的测试过，不过从它现在的发展来看，其可能确实如它宣传的那样其性能高过目前所有的连接池组件。之前对连接池的记忆一直都是C3P0、DBCP、BoneCP，这三者中BoneCP的性能是最好的，C3P0的性能在现在来说确实是非常差的了，好像C3P0很久都没有更新了，所以我们应该杜绝在项目中使用C3P0，至于是否要使用HikariCP，我觉得可以尝试。HikariCP毕竟是才出来不久，其性能到底如何，也需要实践的检验，若是担心新东西有坑，我推荐使用BoneCP。Spring现在也集成了HikariCP，所以我觉得很有尝试它的必要。前不久我在项目中使用了HikariCP，也没出现什么问题，运行比较稳定。\n\nHikariCP在github上的地址：[https://github.com/brettwooldridge/HikariCP](https://github.com/brettwooldridge/HikariCP)\n\n[为什么HikariCP被号称为性能最好的Java数据库连接池，如何配置使用?](http://blog.csdn.net/clementad/article/details/46928621)\n\n\n```\n<!--JDBC连接池 -->\n<dependency>\n    <groupId>com.zaxxer</groupId>\n    <artifactId>HikariCP</artifactId>\n    <version>2.4.0</version>\n</dependency>\n```\n### 简单的CRUD\n为保持example的干净与轻便，不使用Spring进行ORM层的管理，我采用[ARM](http://www.oschina.net/question/12_10706)的方式来管理SQL链接，在try with resource块结束后自动释放SQL链接。\n\n有需要与Spring进行整合的，Follow这篇文章吧！[Using JOOQ with Spring and Apache DBCP](http://www.jooq.org/doc/3.7/manual/getting-started/tutorials/jooq-with-spring/)\n\n同时我也将JOOQ与Spring 4、Spring-MVC进行了整合，代码地址：[https://github.com/amao12580/JOOQ-With-Spring](https://github.com/amao12580/JOOQ-With-Spring)，使用Spring Transaction进行事务管理。\n\n```\ntry(ScopedContext scopedContext=new ScopedContext()){//try with resource\n    DSLContext create=scopedContext.getDSLContext();\n    int uid =180;\n\n    //add\n    UserRecord userRecord=create.newRecord(USER);\n    userRecord.setAge((byte) 18);\n    userRecord.setMobile(\"15985236985\");\n    userRecord.setName(\"赵六\");\n    userRecord.setUid(uid);\n    userRecord.setSex((byte) 1);\n    userRecord.setPassword(String.valueOf(System.nanoTime()));\n    userRecord.setRegisterTime(new Timestamp(System.currentTimeMillis()));\n    int insertRet=userRecord.insert();//执行insert sql\n    //userRecord.store();//可能会执行insert，也有可能执行update，文档说明的很清晰\n    //userRecord.refresh();//从数据库重新加载该记录\n    log.info(\"insertRet:{}\", insertRet);\n\n    //index\n    int createIndexRet=create.createIndex(\"user_index_mobile_unique\")\n            .on(USER, USER.MOBILE)\n            .execute();//为手机号码字段创建唯一索引\n    int dropIndexRet=create.dropIndex(\"user_index_mobile_unique\")\n            .on(USER)\n            .execute();//删除索引\n    log.info(\"dropIndexRet:{},createIndexRet:{}\", dropIndexRet, createIndexRet);\n\n    //select\n    Record record=create.select(USER.NAME,USER.UID)\n            .from(USER)\n            .where(USER.MOBILE.eq(\"15985236985\"))\n            .limit(1)\n            .fetchOne();\n    log.info(\"姓名:{}，uid:{}\", record.getValue(USER.NAME), record.getValue(USER.UID));\n\n    Result<UserRecord> userRecords=create.selectFrom(USER)\n            .where(USER.SEX.eq((byte) 1).and(USER.MOBILE.like(\"159%\")))\n            .orderBy(USER.MOBILE.asc()).limit(0, 20).fetch();\n\n    for (UserRecord ur:userRecords){\n        log.info(\"mobile:{},uid:{},registerTime:{}\", ur.getMobile(), ur.getUid(), ur.getRegisterTime().getTime());\n    }\n\n    //delete\n    int deleteRecordRet=create.deleteFrom(USER).where(USER.UID.eq(uid)).execute();\n    log.info(\"deleteRecordRet:{}\", deleteRecordRet);\n}\n\n日志打印信息：\n21:01:20.009 INFO  com.zaxxer.hikari.HikariDataSource 72 <init> - Hikari pool HikariPool-0 is starting.\n21:01:20.561 INFO  org.jooq.tools.JooqLogger 331 info -\n\n@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@\n@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@\n@@@@@@@@@@@@@@@@  @@        @@@@@@@@@@\n@@@@@@@@@@@@@@@@@@@@        @@@@@@@@@@\n@@@@@@@@@@@@@@@@  @@  @@    @@@@@@@@@@\n@@@@@@@@@@  @@@@  @@  @@    @@@@@@@@@@\n@@@@@@@@@@        @@        @@@@@@@@@@\n@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@\n@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@\n@@@@@@@@@@        @@        @@@@@@@@@@\n@@@@@@@@@@    @@  @@  @@@@  @@@@@@@@@@\n@@@@@@@@@@    @@  @@  @@@@  @@@@@@@@@@\n@@@@@@@@@@        @@  @  @  @@@@@@@@@@\n@@@@@@@@@@        @@        @@@@@@@@@@\n@@@@@@@@@@@@@@@@@@@@@@@  @@@@@@@@@@@@@\n@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@\n@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@  Thank you for using jOOQ 3.8.2\n\n21:01:20.593 INFO  com.study.jooq.model.Example 42 base - insertRet:1\n21:01:21.197 INFO  com.study.jooq.model.Example 51 base - dropIndexRet:0,createIndexRet:0\n21:01:21.278 INFO  com.study.jooq.model.Example 59 base - 姓名:赵六，uid:180\n21:01:21.282 INFO  com.study.jooq.model.Example 66 base - mobile:15925874536,uid:102,registerTime:1459331629000\n21:01:21.282 INFO  com.study.jooq.model.Example 66 base - mobile:15985236985,uid:180,registerTime:1459429281000\n21:01:21.285 INFO  com.study.jooq.model.Example 71 base - deleteRecordRet:1\n21:01:21.285 INFO  com.zaxxer.hikari.pool.HikariPool 242 shutdown - Hikari pool HikariPool-0 is shutting down.\n21:01:21.331 INFO  com.zaxxer.hikari.util.ConcurrentBag 197 add - ConcurrentBag has been closed, ignoring add()\n```\n## 进阶篇\n\n### 事务\n\nJOOQ目前并不支持类似Spring的声明式事务管理，暂时只支持由自身API提供的编程式事务管理。有关声明式事务管理与编程式事务管理的区别，请Follow：[编程式事务与声明式事务](http://blog.csdn.net/u012228718/article/details/42750119#t1)。但JOOQ作者Lukas Eder明确表示在未来的3.9版本中，会提供解决方案。\n\n* [http://www.jooq.org/doc/3.8/manual/sql-execution/transaction-management/](http://www.jooq.org/doc/3.8/manual/sql-execution/transaction-management/)\n\n* [https://github.com/jOOQ/jOOQ/issues/4836](https://github.com/jOOQ/jOOQ/issues/4836)\n\n```\ntry(ScopedContext scopedContext=new ScopedContext()){//try with resource\n    DSLContext create=scopedContext.getDSLContext();\n    final int[] uid = new int[1];\n\n    //transaction\n\n    create.transaction(configuration -> {\n        //add\n        UserRecord userRecord=create.newRecord(USER);\n        userRecord.setAge((byte) 18);\n        userRecord.setMobile(\"18525874539\");\n        userRecord.setName(\"赵六\");\n        userRecord.setSex((byte) 1);\n        userRecord.setPassword(String.valueOf(System.nanoTime()));\n        userRecord.setRegisterTime(new Timestamp(System.currentTimeMillis()));\n        int insertUserRet=userRecord.insert();//执行insert sql\n        uid[0] =userRecord.getUid();\n        log.info(\"insertUserRet:{}\", insertUserRet);\n        //add\n        OrderRecord orderRecord=create.newRecord(ORDER);\n        orderRecord.setUid(userRecord.getUid());\n        orderRecord.setAmout(25000l);\n        orderRecord.setOrderId(new BigDecimal(System.nanoTime()).intValue());\n        orderRecord.setOrderTime(new Timestamp(System.currentTimeMillis()));\n        orderRecord.setStatus((byte)0);\n        int insertOrderRet=orderRecord.insert();//执行insert sql\n        log.info(\"insertOrderRet:{}\", insertOrderRet);\n    });\n}\n\n12:51:14.724 INFO  com.study.jooq.model.Example 90 lambda$advance$0 - insertUserRet:1\n12:51:14.743 INFO  com.study.jooq.model.Example 99 lambda$advance$0 - insertOrderRet:1\n```\n### 连接查询\n在处理复杂SQL时，JOOQ的思路是由Java代码以[链式编程](http://www.jianshu.com/p/540711c1a507)的方式来解决可读性的问题。\n\n下文中的查询语句，等价于：\nselect `study`.`user`.`mobile`, `study`.`user`.`name`, `study`.`user`.`age`, `study`.`order`.`order_id`, `study`.`order`.`amout`, `study`.`order`.`order_time`\n    from `study`.`user` left outer join `study`.`order`\n    on `study`.`user`.`uid` = `study`.`order`.`uid`\n    where (`study`.`user`.`uid` = ? and `study`.`order`.`amout` >= ?)\n    limit ?\n可以发现SQL语句与代码保持了很高的相似性，可读性几乎没有损失。\n\n其他的特性：group by与having、union、union all也都是在api级别支持的。\n```\ntry(ScopedContext scopedContext=new ScopedContext()){//try with resource\n    DSLContext create=scopedContext.getDSLContext();\n    int uid=15874523;\n\n    //join select\n\n    Result<Record6<String,String,Byte,Integer,Long,Timestamp>> results=create\n            .select(USER.MOBILE,USER.NAME,USER.AGE,ORDER.ORDER_ID,ORDER.AMOUT,ORDER.ORDER_TIME)\n            .from(USER).leftOuterJoin(ORDER)\n            .on(USER.UID.eq(ORDER.UID))\n            .where(USER.UID.eq(uid[0]).and(ORDER.AMOUT.ge(100l)))\n            .limit(0,10).fetch();\n    for (Record6<String,String,Byte,Integer,Long,Timestamp> record:results){\n        log.info(\"姓名:{}，手机号码:{}，年龄:{}，订单号:{}，订单金额:{}，订单时间:{}\",\n                record.getValue(USER.NAME),record.getValue(USER.MOBILE),record.getValue(USER.AGE),\n                record.getValue(ORDER.ORDER_ID),record.getValue(ORDER.AMOUT),\n                record.getValue(ORDER.ORDER_TIME));\n    }\n}\n\n12:51:14.898 INFO  com.study.jooq.model.Example 110 advance - 姓名:赵六，手机号码:18525874539，年龄:18，订单号:-1725080559，订单金额:25000，订单时间:1459486275000\n```\n### 批处理\n```\n//batchInsert\ntry(ScopedContext scopedContext=new ScopedContext()){//try with resource\n    DSLContext create=scopedContext.getDSLContext();\n    List<UserRecord> list=new ArrayList<>();\n\n     //batchInsert\n    UserRecord userRecord=create.newRecord(USER);\n    userRecord.setAge((byte) 18);\n    userRecord.setMobile(\"17058963215\");\n    userRecord.setName(\"赵六\");\n    userRecord.setSex((byte) 1);\n    userRecord.setPassword(String.valueOf(System.nanoTime()));\n    userRecord.setRegisterTime(new Timestamp(System.currentTimeMillis()));\n    list.add(userRecord);\n\n    UserRecord userRecord2=create.newRecord(USER);\n    userRecord2.setAge((byte) 29);\n    userRecord2.setMobile(\"17058963216\");\n    userRecord2.setName(\"马七\");\n    userRecord2.setSex((byte) 1);\n    userRecord2.setPassword(String.valueOf(System.nanoTime()));\n    userRecord2.setRegisterTime(new Timestamp(System.currentTimeMillis()));\n    list.add(userRecord2);\n    //使用batchInsert时，无法获取SQL语句\n    int insertRetArr[]=create.batchInsert(list).execute();//返回值是一个int数组，长度与输入的集合size有关。\n\n    log.info(\"insertRetArr:{}\", Arrays.toString(insertRetArr));//数组每个元素为1时，执行成功\n    //使用batchInsert时，无法获取数据自增长的主键值\n    log.info(\"userRecord:uid:{}\", userRecord.getUid());\n    log.info(\"userRecord2:uid:{}\", userRecord2.getUid());\n\n    userRecord.refresh();\n    userRecord2.refresh();\n    log.info(\"userRecord:uid:{}\", userRecord.getUid());\n    log.info(\"userRecord2:uid:{}\", userRecord2.getUid());\n\n    //batchUpdate\n    userRecord.setAge((byte) 38);\n    userRecord2.setAge((byte) 78);\n    list.clear();\n    list.add(userRecord);\n    list.add(userRecord2);\n    //使用batchUpdate时，无法获取SQL语句\n    int updateRetArr[]=create.batchUpdate(list).execute();//返回值是一个int数组，长度与输入的集合size有关。\n    log.info(\"updateRetArr:{}\", Arrays.toString(updateRetArr));//数组每个元素为1时，执行成功\n\n    //batchDelete\n    //使用batchDelete时，无法获取SQL语句\n    int deleteRetArr[]=create.batchDelete(list).execute();//返回值是一个int数组，长度与输入的集合size有关。\n    log.info(\"deleteRetArr:{}\", Arrays.toString(deleteRetArr));//数组每个元素为1时，执行成功\n}\n\n15:06:46.281 INFO  com.study.jooq.model.Example 163 batch - insertRetArr:[1, 1]\n15:06:46.281 INFO  com.study.jooq.model.Example 165 batch - userRecord:uid:null\n15:06:46.281 INFO  com.study.jooq.model.Example 166 batch - userRecord2:uid:null\n15:06:46.287 INFO  com.study.jooq.model.Example 176 batch - updateRetArr:[0, 0]\n15:06:46.291 INFO  com.study.jooq.model.Example 182 batch - deleteRetArr:[0, 0]\n```\n### 函数\nJOOQ没有提供API对函数进行显式的支持，这意味着不能通过JOOQ进行函数的create/execute/drop。但是JOOQ支持直接执行拼接好的字符串SQL语句，这为我们进行函数execute提供了可行性。实际使用中，使用ORM层对数据库函数进行create/drop的需求几乎不存在。\n```\n1. 先在Mysql中添加自定义函数，你也可以使用Flyway的方式来做，在migration文件夹下加一个V2 sql文件。重新执行maven -install即可生效，实际上我更推荐使用这种方式来进行数据库历史SQL执行管理。\n\nUSE study;\nDROP FUNCTION IF EXISTS formatDate;\n\nDELIMITER //\nCREATE FUNCTION formatDate(fdate datetime)\nRETURNS VARCHAR(255)\nRETURN date_format(fdate,'%Y年%m月%d日%h时%i分%s秒');\n//\nDELIMITER ;\n\nSELECT formatDate(NOW()) AS '时间';\n\n2. 使用JOOQ进行函数execute\ntry(ScopedContext scopedContext=new ScopedContext()){//try with resource\n    DSLContext create=scopedContext.getDSLContext();\n    //formatDate是我们在mysql里自定义的函数\n    Result<Record> results=create.fetch(\"SELECT formatDate(NOW()) AS '时间';\");\n    for (Record record:results){\n        log.info(\"执行结果:{}\",record.getValue(0));\n    }\n}\n\n15:54:28.815 INFO  com.study.jooq.model.Example 199 function - 执行结果:2016年04月01日03时54分28秒\n```\n### 存储过程\n存储过程同函数一样，没有进行显式的create/drop支持。\n```\n1. 先在Mysql中添加存储过程\nUSE study;\nDROP PROCEDURE IF EXISTS getAllUid;\n\nDELIMITER //\nCREATE PROCEDURE getAllUid()\nBEGIN\n  SELECT uid FROM user;\nEND//\nDELIMITER ;\n\nCALL getAllUid();\n\n2. 使用JOOQ进行存储过程execute\ntry(ScopedContext scopedContext=new ScopedContext()){//try with resource\n    DSLContext create=scopedContext.getDSLContext();\n    //getAllUid是我们在mysql里定义的存储过程\n    Result<Record> results=create.fetch(\"CALL getAllUid()\");\n    for (Record record:results){\n        log.info(\"执行结果:{}\",record.getValue(0));\n    }\n}\n\n16:08:19.333 INFO  com.study.jooq.model.Example 211 procedure - 执行结果:100\n16:08:19.333 INFO  com.study.jooq.model.Example 211 procedure - 执行结果:102\n16:08:19.334 INFO  com.study.jooq.model.Example 211 procedure - 执行结果:101\n```\n### 视图\n通过代码构建视图后，JOOQ不能自动生成视图对应的实体类，需要手工做一次maven -install。以下示例中会生成类文件：Userwithorder.java\n```\ntry(ScopedContext scopedContext=new ScopedContext()){//try with resource\n    DSLContext create=scopedContext.getDSLContext();\n    //创建视图\n\n    //定义视图名称为：userwithorder\n    CreateViewFinalStep step=create.createView(\"userwithorder\",USER.UID.getName(),USER.NAME.getName(),ORDER.ORDER_ID.getName(),ORDER.STATUS.getName(),ORDER.AMOUT.getName())\n            .as(\n                    create.select(USER.UID, USER.NAME, ORDER.ORDER_ID, ORDER.STATUS, ORDER.AMOUT)\n                            .from(USER)\n                            .leftOuterJoin(ORDER)\n                            .on(USER.UID.eq(ORDER.UID))\n            );\n    log.info(\"SQL:{}\",step.getSQL());\n    int ret=step.execute();\n    log.info(\"创建视图,执行结果:{}\",ret);\n\n    //查询视图\n    Result<Record3<Integer,String,Integer>> results=create.select(USERWITHORDER.UID,USERWITHORDER.NAME,USERWITHORDER.ORDER_ID)\n            .from(USERWITHORDER).where(USERWITHORDER.AMOUT.ge(200l)).fetch();\n    for (Record3<Integer,String,Integer> record:results){\n        log.info(\"uid:{}，姓名:{}，订单号:{}\",\n                record.getValue(USERWITHORDER.UID),record.getValue(USERWITHORDER.NAME),record.getValue(USERWITHORDER.ORDER_ID));\n    }\n    //删除视图\n    int dropRet=create.dropView(\"userwithorder\").execute();\n    log.info(\"删除视图,执行结果:{}\",dropRet);\n}\n\n\n16:54:10.597 INFO  com.study.jooq.model.Example 231 view - SQL:create view `userwithorder`(`uid`, `name`, `order_id`, `status`, `amout`) as select `study`.`user`.`uid`, `study`.`user`.`name`, `study`.`order`.`order_id`, `study`.`order`.`status`, `study`.`order`.`amout` from `study`.`user` left outer join `study`.`order` on `study`.`user`.`uid` = `study`.`order`.`uid`\n16:54:10.712 INFO  com.study.jooq.model.Example 233 view - 创建视图,执行结果:0\n16:54:10.760 INFO  com.study.jooq.model.Example 239 view - uid:100，姓名:张三，订单号:200\n16:54:10.761 INFO  com.study.jooq.model.Example 239 view - uid:100，姓名:张三，订单号:201\n16:54:10.761 INFO  com.study.jooq.model.Example 239 view - uid:101，姓名:李四，订单号:202\n16:54:10.765 INFO  com.study.jooq.model.Example 244 view - 删除视图,执行结果:0\n```\n\n### 运算符\n\n有时候可能需要在SQL中，对字段(或字段之间)进行加减乘除等运算操作。\n\n```\n需求示例，在箱子规格表(不重复)中，找出前十条，按照箱子的容积的最大值(int 11)与最小值(int 11)范围，与给定值(528)进行比较排序，找出最接近的十条。\nselect * from box\n    where min_size<=528 and max_size>=528\n    order by ((min_size+max_size)/2)-528 asc\n    limit 0,10;\n\n使用JOOQ完全可以满足这样的要求\ntry(ScopedContext scopedContext=new ScopedContext()){//try with resource\n    DSLContext create=scopedContext.getDSLContext();\n    int conditionSize=528;\n    int pageNo=1;\n    int pageSize=10;\n\n    SortField sortFieldBySize = ((((BOX.MAX_SIZE.add(BOX.MIN_SIZE)).divide(2)).\n    minus(conditionSize)).asc();\n\n    Result result=create.selectFrom(BOX).\n    where(BOX.MIN_SIZE.lessOrEqual(conditionSize)).\n    and(BOX.MAX_SIZE.greaterOrEqual(conditionSize)).\n    orderBy(sortFieldBySize).\n    limit((pageNo-1) * pageSize, pageSize).\n    fetch();\n}\n```\n\n## 高级篇\n这部分面向于对JOOQ保持更多热情的读者，谈到JOOQ的高阶特性，这些特性在企业级开发中往往会用的很多，但对于个人开发者可能就没那么重要了。因此个人开发者可以选择性的阅读。\n\n推荐企业在大面积应用JOOQ之前详细阅读这部分的内容，以更好的在生产环境稳定使用。\n\n### 重复使用Statement\n\n数据库系统对SQL语句的处理一般会经过如下过程。\n\n- 1.查询解析器（Query parser）：用于检查查询是否合法\n- 2.查询重写器（Query rewriter）：用于预优化查询\n- 3.查询优化器（Query optimizer）：用于优化查询\n- 4.查询执行器（Query executor）：用于编译和执行查询\n\nPreparedStatement是java.sql包下面的一个接口，用来执行SQL语句查询，通过调用connection.preparedStatement(sql)方法可以获得PreparedStatment对象。数据库系统会对sql语句进行预编译处理（如果JDBC驱动支持的话），预处理语句将被预先编译好，这条预编译的sql查询语句能在将来的查询中重用，这样一来，它比Statement对象生成的查询速度更快。\n\n对比以上4条处理过程，复用的PreparedStatement对象，将直接跳过3.5步（最后一步的编译部分也跳过啦），直接被数据库执行，对于复杂并且高频率执行的SQL，这将极大的提高TPS！\n\n在JDBC中如何做？\n\n```\n// 获取PreparedStatement对象，此时数据库已经将String类型的SQL预编译过了。\ntry (PreparedStatement stmt = connection.prepareStatement(\"SELECT 1 FROM DUAL\")) {\n\n    // 第一次使用，获取结果集\n    try (ResultSet rs1 = stmt.executeQuery()) { ... }\n\n    // 不关闭，再次使用，获取结果集（此时结果集可能发生了变化）\n    try (ResultSet rs2 = stmt.executeQuery()) { ... }\n}\n```\n\n在JOOQ中如何做？\n\n```\n//重复使用Statement\ntry (ScopedContext scopedContext = new ScopedContext()) {//try with resource\n    DSLContext create = scopedContext.getDSLContext();\n\n    // 创建一个被配置保持打开的Statement\n    try (ResultQuery<Record1<Integer>> query = create.selectOne().keepStatement(true)) {\n        Result<Record1<Integer>> result1 = query.fetch(); // This will lazily create a new PreparedStatement\n        log.info(\"result1:\" + result1.toString());\n        Result<Record1<Integer>> result2 = query.fetch(); // This will reuse the previous PreparedStatement\n        log.info(\"result2:\" + result2.toString());\n    }\n}\n\n```\n\n### [draft] With Ehcache\n\n未完成。\n\n讨论JOOQ与Ehcache等进程级别缓存模块的集成，引申地，会谈到中间件级别的数据库缓存，如：Redis。\n\n### [draft] 钩子函数：DefaultRecordListener 如何使用？\n\n未完成。\n\n讨论JOOQ重要特性：DefaultRecordListener(简称Listener)。\n\nListener的应用场景，数据库操作完成后同步回调。\n\n示例需求：简书网站，完成MySQL插入或更新文章后，需要在搜索接口(Solr)中半实时的查询到最新文章。\n\n分析：强一致性需求，在MySQL和搜索引擎同时操作成功，才算一个事务成功。\n\n使用JOOQ获取MySQL数据库链接时，注册Listener，指向更新Solr的业务逻辑。\n\n### [draft] 更快的分页(seek)\n\n未完成。\n\nSeek方法本来就没有跳过OFFSET之前的记录，它跳过的是所有以前获取到的最后一条记录之前的记录。考虑一下谷歌的翻页。从实用角度看的话，你几乎不可能准确地跳过100'000行记录。\n\n## 小技巧\n### 获取SQL语句\nJOOQ允许在执行(fetch*、excute)前的SQL构建阶段，获取任一阶段的文本SQL语句。\n```\n//2张表完成左外连接构建阶段后的Step\nSelectForUpdateStep sfus=create\n        .select(USER.MOBILE, USER.NAME, USER.AGE, ORDER.ORDER_ID, ORDER.AMOUT, ORDER.ORDER_TIME)\n        .from(USER).leftOuterJoin(ORDER)\n        .on(USER.UID.eq(ORDER.UID));\n\n//2张表查询语句构建结束后的Step\nSelectForUpdateStep sfus1=create\n        .select(USER.MOBILE,USER.NAME,USER.AGE,ORDER.ORDER_ID,ORDER.AMOUT,ORDER.ORDER_TIME)\n        .from(USER).leftOuterJoin(ORDER)\n        .on(USER.UID.eq(ORDER.UID))\n        .where(USER.UID.eq(uid[0]).and(ORDER.AMOUT.ge(100l)))\n        .limit(0, 10);\nlog.info(\"s:\" + sfus.getSQL());\nlog.info(\"s1:\" + sfus.getSQL());\n\n14:23:05.305 INFO  com.study.jooq.model.Example 123 advance - s:select `study`.`user`.`mobile`, `study`.`user`.`name`, `study`.`user`.`age`, `study`.`order`.`order_id`, `study`.`order`.`amout`, `study`.`order`.`order_time` from `study`.`user` left outer join `study`.`order` on `study`.`user`.`uid` = `study`.`order`.`uid`\n\n14:23:05.306 INFO  com.study.jooq.model.Example 124 advance - s1:select `study`.`user`.`mobile`, `study`.`user`.`name`, `study`.`user`.`age`, `study`.`order`.`order_id`, `study`.`order`.`amout`, `study`.`order`.`order_time` from `study`.`user` left outer join `study`.`order` on `study`.`user`.`uid` = `study`.`order`.`uid\n```\n## Some else\n### JPA与JDBC有什么区别？\n\n- JDBC：Java Data Base Connectivity，java数据库连接，用于直接调用SQL 命令，也就是用于执行SQL语句的Java API，是面向数据库的。\n- JPA：Java Persistence API，Java持久性API，用来操作实体对象，持久性提供了很多实现，编程人员只需要编写实体类，实体类中的主要信息为实体与数据库中表、字段、主键的对应，可以免除编写繁琐的SQL。\n\n### JOOQ与JDBC的详细区别\n\n- [Comparison between jOOQ and JDBC](http://www.jooq.org/doc/3.8/manual/sql-execution/comparison-with-jdbc/)\n\n## Reference\n\n- [如果有人问你数据库的原理，叫他看这篇文章](http://blog.jobbole.com/100349/)","source":"_posts/JOOQ-from-entry-to-improve.md","raw":"---\ntitle: JOOQ 3.8.2 使用 教程：从入门到提高\ndate: 2016年3月31日14:00:22\ntags:\n    - JOOQ\n    - SQL\n    - ARM\n    - ORM\n    - Transaction\ncategories:\n    - Learning\ndescription: JOOQ (Java Object Oriented Querying) 作为ORM框架，其原理是：在DAO层使用Java语言编写SQL语句，在Intellij IDEA的辅助下，复杂SQL的维护变得很容易。通过内部SQL Builder转换成数据库可执行的SQL文本，使用数据库驱动，提交SQL到RDBMS执行，接受处理结果，转换为POJO，返回到应用层。\n---\n\n## 写在前面\n\n2016年后换了一家公司干，后台ORM框架用的JOOQ，完全陌生的东西。干这一行越久，越觉得有更多有趣的新事物需要去探索。想起小说[《火星救援》](https://book.douban.com/subject/26586492/)，Mark侥幸在火星风暴中幸存后，一步步将自己救出困境，遇到的难题或大或小，皆有优雅解决之法。一切看似偶然蹊跷，其实与Mark的长期知识储备分不开。所谓艺多不压身，应该在有限的时间里，得到更多成长，以期待机会来时不辜负。\n\n下文中的学习示例代码，已经整理完毕：\n\n* 原味基础学习：[https://github.com/amao12580/JOOQ](https://github.com/amao12580/JOOQ)\n\n* 与Spring深度整合：[https://github.com/amao12580/JOOQ-With-Spring](https://github.com/amao12580/JOOQ-With-Spring)\n\n## 什么是JOOQ？\n[JOOQ](http://www.jooq.org/)，全称Java Object Oriented Querying，即面向Java对象查询。它是[Data Geekery](http://www.datageekery.com/)公司研发的DA方案(Data Access Layer)，主要解决两个问题：\n\n1. Hibernate的抽象使得我们离SQL太远，对SQL的掌控力度弱\n2. JDBC又过于嘈杂，需要干的事情太多\n\nJOOQ希望干的就是在上述两者中寻找一个最佳的平衡。它依据数据库中的表生成DA相关的代码，开发者将生成的代码引入项目中即可使用。\n\n有好几个版本\n\n* OpenSource\n* Express\n* Professional\n* Enterprise\n\nOpenSource版本针对开源数据库，已经够用了。其它的几个版本针对非开源数据库，差异在于不同的后续支持。\n\n想了解各版本的更多区别，跟我一起看吧。\n\n* http://www.jooq.org/legal/licensing\n\n* http://www.jooq.org/download/\n\nJOOQ作为ORM框架，其原理是：在DAO层使用Java语言编写SQL语句，在Intellij IDEA的辅助下，复杂SQL的维护变得很容易。通过内部SQL Builder转换成数据库可执行的SQL文本，使用数据库驱动，提交SQL到RDBMS执行，接受处理结果，转换为POJO，返回到应用层。\n\n它与Hibernate不同，不依赖使用字符串变量在Java代码中拼接SQL语句。在复杂SQL语句中，与变量的组合拼接时，SQL被割裂成多个部分，失去了宝贵的可读性，这简直是噩梦。而且Hibernate饱受诟病的连接查询配置复杂以及HQL语法的问题，在JOOQ中不复存在。\n\n它与Mybatis不同，不依赖繁琐分散的XML进行SQL预定义。代码与SQL语句的分离，初衷是为了解决SQL嵌入代码时带来不直观的复杂性，但是分离的代价是维护工作倍增以及类型转换问题，经常遭遇到应用层代码变更，而XML定义未同步变更，IDE几乎无法解决。又或者开发人员改动一个XML文件，却意外影响多处上层代码，而这个问题很难避免。\n\n更进一步的，JOOQ提供原生的类型安全转换，以及POJO维护，免去大量一次性代码的编写。当然，你也可以使用Eclipse[代码生成插件](http://my.oschina.net/lujianing/blog/200135)解决这个问题，但是如果ORM能自动解决(结合Maven Plugin)，为什么拒绝呢？\n\n使用这种DAO模式，可以通过类的方式来进行数据库访问了。而且对SQL控制粒度加大的同时，维护工作并没有因此倍增，这对于开发人员是更好的解决方案，也是未来的趋势。\n\n```\n使用JOOQ进行2张表内连接查询示例\n\n// Typesafely execute the SQL statement directly with jOOQ\nResult<Record3<String, String, String>> result =\ncreate.select(BOOK.TITLE, AUTHOR.FIRST_NAME, AUTHOR.LAST_NAME)\n    .from(BOOK)\n    .join(AUTHOR)\n    .on(BOOK.AUTHOR_ID.equal(AUTHOR.ID))\n    .where(BOOK.PUBLISHED_IN.equal(1948))\n    .fetch();\n```\n\n### VS 主流ORM框架\n* [JOOQ vs. Hibernate: When to Choose Which](http://blog.jooq.org/2015/03/24/jooq-vs-hibernate-when-to-choose-which/)\n* [SQL Templating with jOOQ or MyBatis](http://blog.jooq.org/2013/07/13/sql-templating-with-jooq-or-mybatis/)\n### 优势和局限性\n\n优势\n\n* JOOQ 高效的合并了复杂SQL、[类型安全](http://blog.jooq.org/2015/05/26/type-safe-queries-for-jpas-native-query-api/)、[源码生成](#Code-Generation)、Active Records、存储过程以及高级数据类型的 Java 类库。支持DB2, Derby, Ingres, H2, HSQLDB, MySQL, Oracle, Postgres, SQLite, SQL Server, Sybase。\n\n局限性\n\n* 开发人员需要转换思维，接受新事物，May be better？\n\n## 入门篇\n### With MySQL\n```\n<!--MySQL JDBC driver, 数据库迁移等情况下需要. -->\n<dependency>\n    <groupId>mysql</groupId>\n    <artifactId>mysql-connector-java</artifactId>\n    <version>5.1.36</version>\n</dependency>\n```\n### Code Generation\n\n```\n<!--数据库schema代码生成器 -->\n<dependency>\n    <groupId>org.jooq</groupId>\n    <artifactId>jooq-codegen</artifactId>\n    <version>3.8.2</version>\n</dependency>\n\n<!--数据库代码生成的插件 -->\n<plugin>\n    <!-- Specify the maven code generator plugin -->\n    <groupId>org.jooq</groupId>\n    <artifactId>jooq-codegen-maven</artifactId>\n    <version>3.8.2</version>\n    <!-- The plugin should hook into the generate goal -->\n    <executions>\n        <execution>\n            <goals>\n                <goal>generate</goal>\n            </goals>\n        </execution>\n    </executions>\n    <configuration>\n        <!-- JDBC connection parameters -->\n        <jdbc>\n            <driver>com.mysql.jdbc.Driver</driver>\n            <url>${db.url}</url>\n            <user>${db.username}</user>\n            <password>${db.password}</password>\n        </jdbc>\n        <!-- Generator parameters -->\n        <generator>\n            <database>\n                <name>org.jooq.util.mysql.MySQLDatabase</name>\n                <includes>.*</includes>\n                <inputSchema>${db.schema}</inputSchema>\n                <forcedTypes>\n                    <forcedType>\n                        <name>BOOLEAN</name>\n                        <expression>.*\\.HANDMADE</expression>\n                        <types>.*</types>\n                    </forcedType>\n                </forcedTypes>\n            </database>\n            <target>\n                <packageName>com.study.jooq.common.generated</packageName>\n                <directory>src/main/java</directory>\n            </target>\n        </generator>\n    </configuration>\n</plugin>\n```\n### With Flyway\n\nFlyway 是独立于数据库的应用、管理并跟踪数据库变更的数据库版本管理工具。\n\n[Flyway， 数据库Schema管理利器](http://www.cnblogs.com/huang0925/p/4409506.html)\n\n在pom.xml的配置\n```\n<properties>\n    <project.build.sourceEncoding>UTF-8</project.build.sourceEncoding>\n\n    <!--防止maven改动IDE的language level -->\n    <maven.compiler.source>1.8</maven.compiler.source>\n    <maven.compiler.target>1.8</maven.compiler.target>\n\n    <!--数据库迁移所用的参数 -->\n    <db.url>jdbc:mysql://localhost:3306</db.url>\n    <db.username>root</db.username>\n    <db.password>********</db.password>\n    <db.schema>study</db.schema>\n</properties>\n\n<!--数据库迁移, 同步的插件 -->\n<plugin>\n    <groupId>org.flywaydb</groupId>\n    <artifactId>flyway-maven-plugin</artifactId>\n    <version>3.0</version>\n    <!-- Note that we're executing the Flyway plugin in the \"generate-sources\" phase -->\n    <executions>\n        <execution>\n            <phase>generate-sources</phase>\n            <goals>\n                <goal>migrate</goal>\n            </goals>\n        </execution>\n    </executions>\n    <!-- Note that we need to prefix the db/migration path with filesystem:\n    to prevent Flyway from looking for our migration scripts only on the classpath -->\n    <configuration>\n        <url>${db.url}</url>\n        <user>${db.username}</user>\n        <password>${db.password}</password>\n        <encoding>${project.build.sourceEncoding}</encoding>\n        <schemas>\n            <schema>${db.schema}</schema>\n        </schemas>\n        <locations>\n            <location>filesystem:src/main/resources/db/migration</location>\n        </locations>\n    </configuration>\n</plugin>\n```\n在工程：src/main/resources/db/migration目录下，没有目录文件夹时需要先创建文件夹。放入数据库初始化SQL脚本：V1__init_database.sql。注意在maven中配置的db.schema=study，表明需要使用的数据库名称是study，study需要事先不存在。\n\n执行maven -clean、maven -install成功后，发现数据库有了新的数据库study，并且该数据库有了order、user、schema_version三张表，user、order是我们在脚本中定义需要生成的表，而schema_version是flyway生成的，维护数据库版本升级时的信息。对应的在代码中，生成了三个POJO。\n\n代码生成示例：\n![IDEA使用JOOQ自动生成代码](/img/jooq-flyway.png)\n\n### With HikariCp\nHikariCP号称是现在性能最好的JDBC连接池组件，具体的性能到底如何，我也没有仔细的测试过，不过从它现在的发展来看，其可能确实如它宣传的那样其性能高过目前所有的连接池组件。之前对连接池的记忆一直都是C3P0、DBCP、BoneCP，这三者中BoneCP的性能是最好的，C3P0的性能在现在来说确实是非常差的了，好像C3P0很久都没有更新了，所以我们应该杜绝在项目中使用C3P0，至于是否要使用HikariCP，我觉得可以尝试。HikariCP毕竟是才出来不久，其性能到底如何，也需要实践的检验，若是担心新东西有坑，我推荐使用BoneCP。Spring现在也集成了HikariCP，所以我觉得很有尝试它的必要。前不久我在项目中使用了HikariCP，也没出现什么问题，运行比较稳定。\n\nHikariCP在github上的地址：[https://github.com/brettwooldridge/HikariCP](https://github.com/brettwooldridge/HikariCP)\n\n[为什么HikariCP被号称为性能最好的Java数据库连接池，如何配置使用?](http://blog.csdn.net/clementad/article/details/46928621)\n\n\n```\n<!--JDBC连接池 -->\n<dependency>\n    <groupId>com.zaxxer</groupId>\n    <artifactId>HikariCP</artifactId>\n    <version>2.4.0</version>\n</dependency>\n```\n### 简单的CRUD\n为保持example的干净与轻便，不使用Spring进行ORM层的管理，我采用[ARM](http://www.oschina.net/question/12_10706)的方式来管理SQL链接，在try with resource块结束后自动释放SQL链接。\n\n有需要与Spring进行整合的，Follow这篇文章吧！[Using JOOQ with Spring and Apache DBCP](http://www.jooq.org/doc/3.7/manual/getting-started/tutorials/jooq-with-spring/)\n\n同时我也将JOOQ与Spring 4、Spring-MVC进行了整合，代码地址：[https://github.com/amao12580/JOOQ-With-Spring](https://github.com/amao12580/JOOQ-With-Spring)，使用Spring Transaction进行事务管理。\n\n```\ntry(ScopedContext scopedContext=new ScopedContext()){//try with resource\n    DSLContext create=scopedContext.getDSLContext();\n    int uid =180;\n\n    //add\n    UserRecord userRecord=create.newRecord(USER);\n    userRecord.setAge((byte) 18);\n    userRecord.setMobile(\"15985236985\");\n    userRecord.setName(\"赵六\");\n    userRecord.setUid(uid);\n    userRecord.setSex((byte) 1);\n    userRecord.setPassword(String.valueOf(System.nanoTime()));\n    userRecord.setRegisterTime(new Timestamp(System.currentTimeMillis()));\n    int insertRet=userRecord.insert();//执行insert sql\n    //userRecord.store();//可能会执行insert，也有可能执行update，文档说明的很清晰\n    //userRecord.refresh();//从数据库重新加载该记录\n    log.info(\"insertRet:{}\", insertRet);\n\n    //index\n    int createIndexRet=create.createIndex(\"user_index_mobile_unique\")\n            .on(USER, USER.MOBILE)\n            .execute();//为手机号码字段创建唯一索引\n    int dropIndexRet=create.dropIndex(\"user_index_mobile_unique\")\n            .on(USER)\n            .execute();//删除索引\n    log.info(\"dropIndexRet:{},createIndexRet:{}\", dropIndexRet, createIndexRet);\n\n    //select\n    Record record=create.select(USER.NAME,USER.UID)\n            .from(USER)\n            .where(USER.MOBILE.eq(\"15985236985\"))\n            .limit(1)\n            .fetchOne();\n    log.info(\"姓名:{}，uid:{}\", record.getValue(USER.NAME), record.getValue(USER.UID));\n\n    Result<UserRecord> userRecords=create.selectFrom(USER)\n            .where(USER.SEX.eq((byte) 1).and(USER.MOBILE.like(\"159%\")))\n            .orderBy(USER.MOBILE.asc()).limit(0, 20).fetch();\n\n    for (UserRecord ur:userRecords){\n        log.info(\"mobile:{},uid:{},registerTime:{}\", ur.getMobile(), ur.getUid(), ur.getRegisterTime().getTime());\n    }\n\n    //delete\n    int deleteRecordRet=create.deleteFrom(USER).where(USER.UID.eq(uid)).execute();\n    log.info(\"deleteRecordRet:{}\", deleteRecordRet);\n}\n\n日志打印信息：\n21:01:20.009 INFO  com.zaxxer.hikari.HikariDataSource 72 <init> - Hikari pool HikariPool-0 is starting.\n21:01:20.561 INFO  org.jooq.tools.JooqLogger 331 info -\n\n@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@\n@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@\n@@@@@@@@@@@@@@@@  @@        @@@@@@@@@@\n@@@@@@@@@@@@@@@@@@@@        @@@@@@@@@@\n@@@@@@@@@@@@@@@@  @@  @@    @@@@@@@@@@\n@@@@@@@@@@  @@@@  @@  @@    @@@@@@@@@@\n@@@@@@@@@@        @@        @@@@@@@@@@\n@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@\n@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@\n@@@@@@@@@@        @@        @@@@@@@@@@\n@@@@@@@@@@    @@  @@  @@@@  @@@@@@@@@@\n@@@@@@@@@@    @@  @@  @@@@  @@@@@@@@@@\n@@@@@@@@@@        @@  @  @  @@@@@@@@@@\n@@@@@@@@@@        @@        @@@@@@@@@@\n@@@@@@@@@@@@@@@@@@@@@@@  @@@@@@@@@@@@@\n@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@\n@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@  Thank you for using jOOQ 3.8.2\n\n21:01:20.593 INFO  com.study.jooq.model.Example 42 base - insertRet:1\n21:01:21.197 INFO  com.study.jooq.model.Example 51 base - dropIndexRet:0,createIndexRet:0\n21:01:21.278 INFO  com.study.jooq.model.Example 59 base - 姓名:赵六，uid:180\n21:01:21.282 INFO  com.study.jooq.model.Example 66 base - mobile:15925874536,uid:102,registerTime:1459331629000\n21:01:21.282 INFO  com.study.jooq.model.Example 66 base - mobile:15985236985,uid:180,registerTime:1459429281000\n21:01:21.285 INFO  com.study.jooq.model.Example 71 base - deleteRecordRet:1\n21:01:21.285 INFO  com.zaxxer.hikari.pool.HikariPool 242 shutdown - Hikari pool HikariPool-0 is shutting down.\n21:01:21.331 INFO  com.zaxxer.hikari.util.ConcurrentBag 197 add - ConcurrentBag has been closed, ignoring add()\n```\n## 进阶篇\n\n### 事务\n\nJOOQ目前并不支持类似Spring的声明式事务管理，暂时只支持由自身API提供的编程式事务管理。有关声明式事务管理与编程式事务管理的区别，请Follow：[编程式事务与声明式事务](http://blog.csdn.net/u012228718/article/details/42750119#t1)。但JOOQ作者Lukas Eder明确表示在未来的3.9版本中，会提供解决方案。\n\n* [http://www.jooq.org/doc/3.8/manual/sql-execution/transaction-management/](http://www.jooq.org/doc/3.8/manual/sql-execution/transaction-management/)\n\n* [https://github.com/jOOQ/jOOQ/issues/4836](https://github.com/jOOQ/jOOQ/issues/4836)\n\n```\ntry(ScopedContext scopedContext=new ScopedContext()){//try with resource\n    DSLContext create=scopedContext.getDSLContext();\n    final int[] uid = new int[1];\n\n    //transaction\n\n    create.transaction(configuration -> {\n        //add\n        UserRecord userRecord=create.newRecord(USER);\n        userRecord.setAge((byte) 18);\n        userRecord.setMobile(\"18525874539\");\n        userRecord.setName(\"赵六\");\n        userRecord.setSex((byte) 1);\n        userRecord.setPassword(String.valueOf(System.nanoTime()));\n        userRecord.setRegisterTime(new Timestamp(System.currentTimeMillis()));\n        int insertUserRet=userRecord.insert();//执行insert sql\n        uid[0] =userRecord.getUid();\n        log.info(\"insertUserRet:{}\", insertUserRet);\n        //add\n        OrderRecord orderRecord=create.newRecord(ORDER);\n        orderRecord.setUid(userRecord.getUid());\n        orderRecord.setAmout(25000l);\n        orderRecord.setOrderId(new BigDecimal(System.nanoTime()).intValue());\n        orderRecord.setOrderTime(new Timestamp(System.currentTimeMillis()));\n        orderRecord.setStatus((byte)0);\n        int insertOrderRet=orderRecord.insert();//执行insert sql\n        log.info(\"insertOrderRet:{}\", insertOrderRet);\n    });\n}\n\n12:51:14.724 INFO  com.study.jooq.model.Example 90 lambda$advance$0 - insertUserRet:1\n12:51:14.743 INFO  com.study.jooq.model.Example 99 lambda$advance$0 - insertOrderRet:1\n```\n### 连接查询\n在处理复杂SQL时，JOOQ的思路是由Java代码以[链式编程](http://www.jianshu.com/p/540711c1a507)的方式来解决可读性的问题。\n\n下文中的查询语句，等价于：\nselect `study`.`user`.`mobile`, `study`.`user`.`name`, `study`.`user`.`age`, `study`.`order`.`order_id`, `study`.`order`.`amout`, `study`.`order`.`order_time`\n    from `study`.`user` left outer join `study`.`order`\n    on `study`.`user`.`uid` = `study`.`order`.`uid`\n    where (`study`.`user`.`uid` = ? and `study`.`order`.`amout` >= ?)\n    limit ?\n可以发现SQL语句与代码保持了很高的相似性，可读性几乎没有损失。\n\n其他的特性：group by与having、union、union all也都是在api级别支持的。\n```\ntry(ScopedContext scopedContext=new ScopedContext()){//try with resource\n    DSLContext create=scopedContext.getDSLContext();\n    int uid=15874523;\n\n    //join select\n\n    Result<Record6<String,String,Byte,Integer,Long,Timestamp>> results=create\n            .select(USER.MOBILE,USER.NAME,USER.AGE,ORDER.ORDER_ID,ORDER.AMOUT,ORDER.ORDER_TIME)\n            .from(USER).leftOuterJoin(ORDER)\n            .on(USER.UID.eq(ORDER.UID))\n            .where(USER.UID.eq(uid[0]).and(ORDER.AMOUT.ge(100l)))\n            .limit(0,10).fetch();\n    for (Record6<String,String,Byte,Integer,Long,Timestamp> record:results){\n        log.info(\"姓名:{}，手机号码:{}，年龄:{}，订单号:{}，订单金额:{}，订单时间:{}\",\n                record.getValue(USER.NAME),record.getValue(USER.MOBILE),record.getValue(USER.AGE),\n                record.getValue(ORDER.ORDER_ID),record.getValue(ORDER.AMOUT),\n                record.getValue(ORDER.ORDER_TIME));\n    }\n}\n\n12:51:14.898 INFO  com.study.jooq.model.Example 110 advance - 姓名:赵六，手机号码:18525874539，年龄:18，订单号:-1725080559，订单金额:25000，订单时间:1459486275000\n```\n### 批处理\n```\n//batchInsert\ntry(ScopedContext scopedContext=new ScopedContext()){//try with resource\n    DSLContext create=scopedContext.getDSLContext();\n    List<UserRecord> list=new ArrayList<>();\n\n     //batchInsert\n    UserRecord userRecord=create.newRecord(USER);\n    userRecord.setAge((byte) 18);\n    userRecord.setMobile(\"17058963215\");\n    userRecord.setName(\"赵六\");\n    userRecord.setSex((byte) 1);\n    userRecord.setPassword(String.valueOf(System.nanoTime()));\n    userRecord.setRegisterTime(new Timestamp(System.currentTimeMillis()));\n    list.add(userRecord);\n\n    UserRecord userRecord2=create.newRecord(USER);\n    userRecord2.setAge((byte) 29);\n    userRecord2.setMobile(\"17058963216\");\n    userRecord2.setName(\"马七\");\n    userRecord2.setSex((byte) 1);\n    userRecord2.setPassword(String.valueOf(System.nanoTime()));\n    userRecord2.setRegisterTime(new Timestamp(System.currentTimeMillis()));\n    list.add(userRecord2);\n    //使用batchInsert时，无法获取SQL语句\n    int insertRetArr[]=create.batchInsert(list).execute();//返回值是一个int数组，长度与输入的集合size有关。\n\n    log.info(\"insertRetArr:{}\", Arrays.toString(insertRetArr));//数组每个元素为1时，执行成功\n    //使用batchInsert时，无法获取数据自增长的主键值\n    log.info(\"userRecord:uid:{}\", userRecord.getUid());\n    log.info(\"userRecord2:uid:{}\", userRecord2.getUid());\n\n    userRecord.refresh();\n    userRecord2.refresh();\n    log.info(\"userRecord:uid:{}\", userRecord.getUid());\n    log.info(\"userRecord2:uid:{}\", userRecord2.getUid());\n\n    //batchUpdate\n    userRecord.setAge((byte) 38);\n    userRecord2.setAge((byte) 78);\n    list.clear();\n    list.add(userRecord);\n    list.add(userRecord2);\n    //使用batchUpdate时，无法获取SQL语句\n    int updateRetArr[]=create.batchUpdate(list).execute();//返回值是一个int数组，长度与输入的集合size有关。\n    log.info(\"updateRetArr:{}\", Arrays.toString(updateRetArr));//数组每个元素为1时，执行成功\n\n    //batchDelete\n    //使用batchDelete时，无法获取SQL语句\n    int deleteRetArr[]=create.batchDelete(list).execute();//返回值是一个int数组，长度与输入的集合size有关。\n    log.info(\"deleteRetArr:{}\", Arrays.toString(deleteRetArr));//数组每个元素为1时，执行成功\n}\n\n15:06:46.281 INFO  com.study.jooq.model.Example 163 batch - insertRetArr:[1, 1]\n15:06:46.281 INFO  com.study.jooq.model.Example 165 batch - userRecord:uid:null\n15:06:46.281 INFO  com.study.jooq.model.Example 166 batch - userRecord2:uid:null\n15:06:46.287 INFO  com.study.jooq.model.Example 176 batch - updateRetArr:[0, 0]\n15:06:46.291 INFO  com.study.jooq.model.Example 182 batch - deleteRetArr:[0, 0]\n```\n### 函数\nJOOQ没有提供API对函数进行显式的支持，这意味着不能通过JOOQ进行函数的create/execute/drop。但是JOOQ支持直接执行拼接好的字符串SQL语句，这为我们进行函数execute提供了可行性。实际使用中，使用ORM层对数据库函数进行create/drop的需求几乎不存在。\n```\n1. 先在Mysql中添加自定义函数，你也可以使用Flyway的方式来做，在migration文件夹下加一个V2 sql文件。重新执行maven -install即可生效，实际上我更推荐使用这种方式来进行数据库历史SQL执行管理。\n\nUSE study;\nDROP FUNCTION IF EXISTS formatDate;\n\nDELIMITER //\nCREATE FUNCTION formatDate(fdate datetime)\nRETURNS VARCHAR(255)\nRETURN date_format(fdate,'%Y年%m月%d日%h时%i分%s秒');\n//\nDELIMITER ;\n\nSELECT formatDate(NOW()) AS '时间';\n\n2. 使用JOOQ进行函数execute\ntry(ScopedContext scopedContext=new ScopedContext()){//try with resource\n    DSLContext create=scopedContext.getDSLContext();\n    //formatDate是我们在mysql里自定义的函数\n    Result<Record> results=create.fetch(\"SELECT formatDate(NOW()) AS '时间';\");\n    for (Record record:results){\n        log.info(\"执行结果:{}\",record.getValue(0));\n    }\n}\n\n15:54:28.815 INFO  com.study.jooq.model.Example 199 function - 执行结果:2016年04月01日03时54分28秒\n```\n### 存储过程\n存储过程同函数一样，没有进行显式的create/drop支持。\n```\n1. 先在Mysql中添加存储过程\nUSE study;\nDROP PROCEDURE IF EXISTS getAllUid;\n\nDELIMITER //\nCREATE PROCEDURE getAllUid()\nBEGIN\n  SELECT uid FROM user;\nEND//\nDELIMITER ;\n\nCALL getAllUid();\n\n2. 使用JOOQ进行存储过程execute\ntry(ScopedContext scopedContext=new ScopedContext()){//try with resource\n    DSLContext create=scopedContext.getDSLContext();\n    //getAllUid是我们在mysql里定义的存储过程\n    Result<Record> results=create.fetch(\"CALL getAllUid()\");\n    for (Record record:results){\n        log.info(\"执行结果:{}\",record.getValue(0));\n    }\n}\n\n16:08:19.333 INFO  com.study.jooq.model.Example 211 procedure - 执行结果:100\n16:08:19.333 INFO  com.study.jooq.model.Example 211 procedure - 执行结果:102\n16:08:19.334 INFO  com.study.jooq.model.Example 211 procedure - 执行结果:101\n```\n### 视图\n通过代码构建视图后，JOOQ不能自动生成视图对应的实体类，需要手工做一次maven -install。以下示例中会生成类文件：Userwithorder.java\n```\ntry(ScopedContext scopedContext=new ScopedContext()){//try with resource\n    DSLContext create=scopedContext.getDSLContext();\n    //创建视图\n\n    //定义视图名称为：userwithorder\n    CreateViewFinalStep step=create.createView(\"userwithorder\",USER.UID.getName(),USER.NAME.getName(),ORDER.ORDER_ID.getName(),ORDER.STATUS.getName(),ORDER.AMOUT.getName())\n            .as(\n                    create.select(USER.UID, USER.NAME, ORDER.ORDER_ID, ORDER.STATUS, ORDER.AMOUT)\n                            .from(USER)\n                            .leftOuterJoin(ORDER)\n                            .on(USER.UID.eq(ORDER.UID))\n            );\n    log.info(\"SQL:{}\",step.getSQL());\n    int ret=step.execute();\n    log.info(\"创建视图,执行结果:{}\",ret);\n\n    //查询视图\n    Result<Record3<Integer,String,Integer>> results=create.select(USERWITHORDER.UID,USERWITHORDER.NAME,USERWITHORDER.ORDER_ID)\n            .from(USERWITHORDER).where(USERWITHORDER.AMOUT.ge(200l)).fetch();\n    for (Record3<Integer,String,Integer> record:results){\n        log.info(\"uid:{}，姓名:{}，订单号:{}\",\n                record.getValue(USERWITHORDER.UID),record.getValue(USERWITHORDER.NAME),record.getValue(USERWITHORDER.ORDER_ID));\n    }\n    //删除视图\n    int dropRet=create.dropView(\"userwithorder\").execute();\n    log.info(\"删除视图,执行结果:{}\",dropRet);\n}\n\n\n16:54:10.597 INFO  com.study.jooq.model.Example 231 view - SQL:create view `userwithorder`(`uid`, `name`, `order_id`, `status`, `amout`) as select `study`.`user`.`uid`, `study`.`user`.`name`, `study`.`order`.`order_id`, `study`.`order`.`status`, `study`.`order`.`amout` from `study`.`user` left outer join `study`.`order` on `study`.`user`.`uid` = `study`.`order`.`uid`\n16:54:10.712 INFO  com.study.jooq.model.Example 233 view - 创建视图,执行结果:0\n16:54:10.760 INFO  com.study.jooq.model.Example 239 view - uid:100，姓名:张三，订单号:200\n16:54:10.761 INFO  com.study.jooq.model.Example 239 view - uid:100，姓名:张三，订单号:201\n16:54:10.761 INFO  com.study.jooq.model.Example 239 view - uid:101，姓名:李四，订单号:202\n16:54:10.765 INFO  com.study.jooq.model.Example 244 view - 删除视图,执行结果:0\n```\n\n### 运算符\n\n有时候可能需要在SQL中，对字段(或字段之间)进行加减乘除等运算操作。\n\n```\n需求示例，在箱子规格表(不重复)中，找出前十条，按照箱子的容积的最大值(int 11)与最小值(int 11)范围，与给定值(528)进行比较排序，找出最接近的十条。\nselect * from box\n    where min_size<=528 and max_size>=528\n    order by ((min_size+max_size)/2)-528 asc\n    limit 0,10;\n\n使用JOOQ完全可以满足这样的要求\ntry(ScopedContext scopedContext=new ScopedContext()){//try with resource\n    DSLContext create=scopedContext.getDSLContext();\n    int conditionSize=528;\n    int pageNo=1;\n    int pageSize=10;\n\n    SortField sortFieldBySize = ((((BOX.MAX_SIZE.add(BOX.MIN_SIZE)).divide(2)).\n    minus(conditionSize)).asc();\n\n    Result result=create.selectFrom(BOX).\n    where(BOX.MIN_SIZE.lessOrEqual(conditionSize)).\n    and(BOX.MAX_SIZE.greaterOrEqual(conditionSize)).\n    orderBy(sortFieldBySize).\n    limit((pageNo-1) * pageSize, pageSize).\n    fetch();\n}\n```\n\n## 高级篇\n这部分面向于对JOOQ保持更多热情的读者，谈到JOOQ的高阶特性，这些特性在企业级开发中往往会用的很多，但对于个人开发者可能就没那么重要了。因此个人开发者可以选择性的阅读。\n\n推荐企业在大面积应用JOOQ之前详细阅读这部分的内容，以更好的在生产环境稳定使用。\n\n### 重复使用Statement\n\n数据库系统对SQL语句的处理一般会经过如下过程。\n\n- 1.查询解析器（Query parser）：用于检查查询是否合法\n- 2.查询重写器（Query rewriter）：用于预优化查询\n- 3.查询优化器（Query optimizer）：用于优化查询\n- 4.查询执行器（Query executor）：用于编译和执行查询\n\nPreparedStatement是java.sql包下面的一个接口，用来执行SQL语句查询，通过调用connection.preparedStatement(sql)方法可以获得PreparedStatment对象。数据库系统会对sql语句进行预编译处理（如果JDBC驱动支持的话），预处理语句将被预先编译好，这条预编译的sql查询语句能在将来的查询中重用，这样一来，它比Statement对象生成的查询速度更快。\n\n对比以上4条处理过程，复用的PreparedStatement对象，将直接跳过3.5步（最后一步的编译部分也跳过啦），直接被数据库执行，对于复杂并且高频率执行的SQL，这将极大的提高TPS！\n\n在JDBC中如何做？\n\n```\n// 获取PreparedStatement对象，此时数据库已经将String类型的SQL预编译过了。\ntry (PreparedStatement stmt = connection.prepareStatement(\"SELECT 1 FROM DUAL\")) {\n\n    // 第一次使用，获取结果集\n    try (ResultSet rs1 = stmt.executeQuery()) { ... }\n\n    // 不关闭，再次使用，获取结果集（此时结果集可能发生了变化）\n    try (ResultSet rs2 = stmt.executeQuery()) { ... }\n}\n```\n\n在JOOQ中如何做？\n\n```\n//重复使用Statement\ntry (ScopedContext scopedContext = new ScopedContext()) {//try with resource\n    DSLContext create = scopedContext.getDSLContext();\n\n    // 创建一个被配置保持打开的Statement\n    try (ResultQuery<Record1<Integer>> query = create.selectOne().keepStatement(true)) {\n        Result<Record1<Integer>> result1 = query.fetch(); // This will lazily create a new PreparedStatement\n        log.info(\"result1:\" + result1.toString());\n        Result<Record1<Integer>> result2 = query.fetch(); // This will reuse the previous PreparedStatement\n        log.info(\"result2:\" + result2.toString());\n    }\n}\n\n```\n\n### [draft] With Ehcache\n\n未完成。\n\n讨论JOOQ与Ehcache等进程级别缓存模块的集成，引申地，会谈到中间件级别的数据库缓存，如：Redis。\n\n### [draft] 钩子函数：DefaultRecordListener 如何使用？\n\n未完成。\n\n讨论JOOQ重要特性：DefaultRecordListener(简称Listener)。\n\nListener的应用场景，数据库操作完成后同步回调。\n\n示例需求：简书网站，完成MySQL插入或更新文章后，需要在搜索接口(Solr)中半实时的查询到最新文章。\n\n分析：强一致性需求，在MySQL和搜索引擎同时操作成功，才算一个事务成功。\n\n使用JOOQ获取MySQL数据库链接时，注册Listener，指向更新Solr的业务逻辑。\n\n### [draft] 更快的分页(seek)\n\n未完成。\n\nSeek方法本来就没有跳过OFFSET之前的记录，它跳过的是所有以前获取到的最后一条记录之前的记录。考虑一下谷歌的翻页。从实用角度看的话，你几乎不可能准确地跳过100'000行记录。\n\n## 小技巧\n### 获取SQL语句\nJOOQ允许在执行(fetch*、excute)前的SQL构建阶段，获取任一阶段的文本SQL语句。\n```\n//2张表完成左外连接构建阶段后的Step\nSelectForUpdateStep sfus=create\n        .select(USER.MOBILE, USER.NAME, USER.AGE, ORDER.ORDER_ID, ORDER.AMOUT, ORDER.ORDER_TIME)\n        .from(USER).leftOuterJoin(ORDER)\n        .on(USER.UID.eq(ORDER.UID));\n\n//2张表查询语句构建结束后的Step\nSelectForUpdateStep sfus1=create\n        .select(USER.MOBILE,USER.NAME,USER.AGE,ORDER.ORDER_ID,ORDER.AMOUT,ORDER.ORDER_TIME)\n        .from(USER).leftOuterJoin(ORDER)\n        .on(USER.UID.eq(ORDER.UID))\n        .where(USER.UID.eq(uid[0]).and(ORDER.AMOUT.ge(100l)))\n        .limit(0, 10);\nlog.info(\"s:\" + sfus.getSQL());\nlog.info(\"s1:\" + sfus.getSQL());\n\n14:23:05.305 INFO  com.study.jooq.model.Example 123 advance - s:select `study`.`user`.`mobile`, `study`.`user`.`name`, `study`.`user`.`age`, `study`.`order`.`order_id`, `study`.`order`.`amout`, `study`.`order`.`order_time` from `study`.`user` left outer join `study`.`order` on `study`.`user`.`uid` = `study`.`order`.`uid`\n\n14:23:05.306 INFO  com.study.jooq.model.Example 124 advance - s1:select `study`.`user`.`mobile`, `study`.`user`.`name`, `study`.`user`.`age`, `study`.`order`.`order_id`, `study`.`order`.`amout`, `study`.`order`.`order_time` from `study`.`user` left outer join `study`.`order` on `study`.`user`.`uid` = `study`.`order`.`uid\n```\n## Some else\n### JPA与JDBC有什么区别？\n\n- JDBC：Java Data Base Connectivity，java数据库连接，用于直接调用SQL 命令，也就是用于执行SQL语句的Java API，是面向数据库的。\n- JPA：Java Persistence API，Java持久性API，用来操作实体对象，持久性提供了很多实现，编程人员只需要编写实体类，实体类中的主要信息为实体与数据库中表、字段、主键的对应，可以免除编写繁琐的SQL。\n\n### JOOQ与JDBC的详细区别\n\n- [Comparison between jOOQ and JDBC](http://www.jooq.org/doc/3.8/manual/sql-execution/comparison-with-jdbc/)\n\n## Reference\n\n- [如果有人问你数据库的原理，叫他看这篇文章](http://blog.jobbole.com/100349/)","slug":"JOOQ-from-entry-to-improve","published":1,"updated":"2016-06-01T07:39:32.688Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ciowq3yu800064cnns96c21p9","content":"<h2 id=\"写在前面\"><a href=\"#写在前面\" class=\"headerlink\" title=\"写在前面\"></a>写在前面</h2><p>2016年后换了一家公司干，后台ORM框架用的JOOQ，完全陌生的东西。干这一行越久，越觉得有更多有趣的新事物需要去探索。想起小说<a href=\"https://book.douban.com/subject/26586492/\" target=\"_blank\" rel=\"external\">《火星救援》</a>，Mark侥幸在火星风暴中幸存后，一步步将自己救出困境，遇到的难题或大或小，皆有优雅解决之法。一切看似偶然蹊跷，其实与Mark的长期知识储备分不开。所谓艺多不压身，应该在有限的时间里，得到更多成长，以期待机会来时不辜负。</p>\n<p>下文中的学习示例代码，已经整理完毕：</p>\n<ul>\n<li><p>原味基础学习：<a href=\"https://github.com/amao12580/JOOQ\" target=\"_blank\" rel=\"external\">https://github.com/amao12580/JOOQ</a></p>\n</li>\n<li><p>与Spring深度整合：<a href=\"https://github.com/amao12580/JOOQ-With-Spring\" target=\"_blank\" rel=\"external\">https://github.com/amao12580/JOOQ-With-Spring</a></p>\n</li>\n</ul>\n<h2 id=\"什么是JOOQ？\"><a href=\"#什么是JOOQ？\" class=\"headerlink\" title=\"什么是JOOQ？\"></a>什么是JOOQ？</h2><p><a href=\"http://www.jooq.org/\" target=\"_blank\" rel=\"external\">JOOQ</a>，全称Java Object Oriented Querying，即面向Java对象查询。它是<a href=\"http://www.datageekery.com/\" target=\"_blank\" rel=\"external\">Data Geekery</a>公司研发的DA方案(Data Access Layer)，主要解决两个问题：</p>\n<ol>\n<li>Hibernate的抽象使得我们离SQL太远，对SQL的掌控力度弱</li>\n<li>JDBC又过于嘈杂，需要干的事情太多</li>\n</ol>\n<p>JOOQ希望干的就是在上述两者中寻找一个最佳的平衡。它依据数据库中的表生成DA相关的代码，开发者将生成的代码引入项目中即可使用。</p>\n<p>有好几个版本</p>\n<ul>\n<li>OpenSource</li>\n<li>Express</li>\n<li>Professional</li>\n<li>Enterprise</li>\n</ul>\n<p>OpenSource版本针对开源数据库，已经够用了。其它的几个版本针对非开源数据库，差异在于不同的后续支持。</p>\n<p>想了解各版本的更多区别，跟我一起看吧。</p>\n<ul>\n<li><p><a href=\"http://www.jooq.org/legal/licensing\" target=\"_blank\" rel=\"external\">http://www.jooq.org/legal/licensing</a></p>\n</li>\n<li><p><a href=\"http://www.jooq.org/download/\" target=\"_blank\" rel=\"external\">http://www.jooq.org/download/</a></p>\n</li>\n</ul>\n<p>JOOQ作为ORM框架，其原理是：在DAO层使用Java语言编写SQL语句，在Intellij IDEA的辅助下，复杂SQL的维护变得很容易。通过内部SQL Builder转换成数据库可执行的SQL文本，使用数据库驱动，提交SQL到RDBMS执行，接受处理结果，转换为POJO，返回到应用层。</p>\n<p>它与Hibernate不同，不依赖使用字符串变量在Java代码中拼接SQL语句。在复杂SQL语句中，与变量的组合拼接时，SQL被割裂成多个部分，失去了宝贵的可读性，这简直是噩梦。而且Hibernate饱受诟病的连接查询配置复杂以及HQL语法的问题，在JOOQ中不复存在。</p>\n<p>它与Mybatis不同，不依赖繁琐分散的XML进行SQL预定义。代码与SQL语句的分离，初衷是为了解决SQL嵌入代码时带来不直观的复杂性，但是分离的代价是维护工作倍增以及类型转换问题，经常遭遇到应用层代码变更，而XML定义未同步变更，IDE几乎无法解决。又或者开发人员改动一个XML文件，却意外影响多处上层代码，而这个问题很难避免。</p>\n<p>更进一步的，JOOQ提供原生的类型安全转换，以及POJO维护，免去大量一次性代码的编写。当然，你也可以使用Eclipse<a href=\"http://my.oschina.net/lujianing/blog/200135\" target=\"_blank\" rel=\"external\">代码生成插件</a>解决这个问题，但是如果ORM能自动解决(结合Maven Plugin)，为什么拒绝呢？</p>\n<p>使用这种DAO模式，可以通过类的方式来进行数据库访问了。而且对SQL控制粒度加大的同时，维护工作并没有因此倍增，这对于开发人员是更好的解决方案，也是未来的趋势。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">使用JOOQ进行2张表内连接查询示例</span><br><span class=\"line\"></span><br><span class=\"line\">// Typesafely execute the SQL statement directly with jOOQ</span><br><span class=\"line\">Result&lt;Record3&lt;String, String, String&gt;&gt; result =</span><br><span class=\"line\">create.select(BOOK.TITLE, AUTHOR.FIRST_NAME, AUTHOR.LAST_NAME)</span><br><span class=\"line\">    .from(BOOK)</span><br><span class=\"line\">    .join(AUTHOR)</span><br><span class=\"line\">    .on(BOOK.AUTHOR_ID.equal(AUTHOR.ID))</span><br><span class=\"line\">    .where(BOOK.PUBLISHED_IN.equal(1948))</span><br><span class=\"line\">    .fetch();</span><br></pre></td></tr></table></figure>\n<h3 id=\"VS-主流ORM框架\"><a href=\"#VS-主流ORM框架\" class=\"headerlink\" title=\"VS 主流ORM框架\"></a>VS 主流ORM框架</h3><ul>\n<li><a href=\"http://blog.jooq.org/2015/03/24/jooq-vs-hibernate-when-to-choose-which/\" target=\"_blank\" rel=\"external\">JOOQ vs. Hibernate: When to Choose Which</a></li>\n<li><a href=\"http://blog.jooq.org/2013/07/13/sql-templating-with-jooq-or-mybatis/\" target=\"_blank\" rel=\"external\">SQL Templating with jOOQ or MyBatis</a><h3 id=\"优势和局限性\"><a href=\"#优势和局限性\" class=\"headerlink\" title=\"优势和局限性\"></a>优势和局限性</h3></li>\n</ul>\n<p>优势</p>\n<ul>\n<li>JOOQ 高效的合并了复杂SQL、<a href=\"http://blog.jooq.org/2015/05/26/type-safe-queries-for-jpas-native-query-api/\" target=\"_blank\" rel=\"external\">类型安全</a>、<a href=\"#Code-Generation\">源码生成</a>、Active Records、存储过程以及高级数据类型的 Java 类库。支持DB2, Derby, Ingres, H2, HSQLDB, MySQL, Oracle, Postgres, SQLite, SQL Server, Sybase。</li>\n</ul>\n<p>局限性</p>\n<ul>\n<li>开发人员需要转换思维，接受新事物，May be better？</li>\n</ul>\n<h2 id=\"入门篇\"><a href=\"#入门篇\" class=\"headerlink\" title=\"入门篇\"></a>入门篇</h2><h3 id=\"With-MySQL\"><a href=\"#With-MySQL\" class=\"headerlink\" title=\"With MySQL\"></a>With MySQL</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;!--MySQL JDBC driver, 数据库迁移等情况下需要. --&gt;</span><br><span class=\"line\">&lt;dependency&gt;</span><br><span class=\"line\">    &lt;groupId&gt;mysql&lt;/groupId&gt;</span><br><span class=\"line\">    &lt;artifactId&gt;mysql-connector-java&lt;/artifactId&gt;</span><br><span class=\"line\">    &lt;version&gt;5.1.36&lt;/version&gt;</span><br><span class=\"line\">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>\n<h3 id=\"Code-Generation\"><a href=\"#Code-Generation\" class=\"headerlink\" title=\"Code Generation\"></a>Code Generation</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;!--数据库schema代码生成器 --&gt;</span><br><span class=\"line\">&lt;dependency&gt;</span><br><span class=\"line\">    &lt;groupId&gt;org.jooq&lt;/groupId&gt;</span><br><span class=\"line\">    &lt;artifactId&gt;jooq-codegen&lt;/artifactId&gt;</span><br><span class=\"line\">    &lt;version&gt;3.8.2&lt;/version&gt;</span><br><span class=\"line\">&lt;/dependency&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">&lt;!--数据库代码生成的插件 --&gt;</span><br><span class=\"line\">&lt;plugin&gt;</span><br><span class=\"line\">    &lt;!-- Specify the maven code generator plugin --&gt;</span><br><span class=\"line\">    &lt;groupId&gt;org.jooq&lt;/groupId&gt;</span><br><span class=\"line\">    &lt;artifactId&gt;jooq-codegen-maven&lt;/artifactId&gt;</span><br><span class=\"line\">    &lt;version&gt;3.8.2&lt;/version&gt;</span><br><span class=\"line\">    &lt;!-- The plugin should hook into the generate goal --&gt;</span><br><span class=\"line\">    &lt;executions&gt;</span><br><span class=\"line\">        &lt;execution&gt;</span><br><span class=\"line\">            &lt;goals&gt;</span><br><span class=\"line\">                &lt;goal&gt;generate&lt;/goal&gt;</span><br><span class=\"line\">            &lt;/goals&gt;</span><br><span class=\"line\">        &lt;/execution&gt;</span><br><span class=\"line\">    &lt;/executions&gt;</span><br><span class=\"line\">    &lt;configuration&gt;</span><br><span class=\"line\">        &lt;!-- JDBC connection parameters --&gt;</span><br><span class=\"line\">        &lt;jdbc&gt;</span><br><span class=\"line\">            &lt;driver&gt;com.mysql.jdbc.Driver&lt;/driver&gt;</span><br><span class=\"line\">            &lt;url&gt;$&#123;db.url&#125;&lt;/url&gt;</span><br><span class=\"line\">            &lt;user&gt;$&#123;db.username&#125;&lt;/user&gt;</span><br><span class=\"line\">            &lt;password&gt;$&#123;db.password&#125;&lt;/password&gt;</span><br><span class=\"line\">        &lt;/jdbc&gt;</span><br><span class=\"line\">        &lt;!-- Generator parameters --&gt;</span><br><span class=\"line\">        &lt;generator&gt;</span><br><span class=\"line\">            &lt;database&gt;</span><br><span class=\"line\">                &lt;name&gt;org.jooq.util.mysql.MySQLDatabase&lt;/name&gt;</span><br><span class=\"line\">                &lt;includes&gt;.*&lt;/includes&gt;</span><br><span class=\"line\">                &lt;inputSchema&gt;$&#123;db.schema&#125;&lt;/inputSchema&gt;</span><br><span class=\"line\">                &lt;forcedTypes&gt;</span><br><span class=\"line\">                    &lt;forcedType&gt;</span><br><span class=\"line\">                        &lt;name&gt;BOOLEAN&lt;/name&gt;</span><br><span class=\"line\">                        &lt;expression&gt;.*\\.HANDMADE&lt;/expression&gt;</span><br><span class=\"line\">                        &lt;types&gt;.*&lt;/types&gt;</span><br><span class=\"line\">                    &lt;/forcedType&gt;</span><br><span class=\"line\">                &lt;/forcedTypes&gt;</span><br><span class=\"line\">            &lt;/database&gt;</span><br><span class=\"line\">            &lt;target&gt;</span><br><span class=\"line\">                &lt;packageName&gt;com.study.jooq.common.generated&lt;/packageName&gt;</span><br><span class=\"line\">                &lt;directory&gt;src/main/java&lt;/directory&gt;</span><br><span class=\"line\">            &lt;/target&gt;</span><br><span class=\"line\">        &lt;/generator&gt;</span><br><span class=\"line\">    &lt;/configuration&gt;</span><br><span class=\"line\">&lt;/plugin&gt;</span><br></pre></td></tr></table></figure>\n<h3 id=\"With-Flyway\"><a href=\"#With-Flyway\" class=\"headerlink\" title=\"With Flyway\"></a>With Flyway</h3><p>Flyway 是独立于数据库的应用、管理并跟踪数据库变更的数据库版本管理工具。</p>\n<p><a href=\"http://www.cnblogs.com/huang0925/p/4409506.html\" target=\"_blank\" rel=\"external\">Flyway， 数据库Schema管理利器</a></p>\n<p>在pom.xml的配置<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;properties&gt;</span><br><span class=\"line\">    &lt;project.build.sourceEncoding&gt;UTF-8&lt;/project.build.sourceEncoding&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">    &lt;!--防止maven改动IDE的language level --&gt;</span><br><span class=\"line\">    &lt;maven.compiler.source&gt;1.8&lt;/maven.compiler.source&gt;</span><br><span class=\"line\">    &lt;maven.compiler.target&gt;1.8&lt;/maven.compiler.target&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">    &lt;!--数据库迁移所用的参数 --&gt;</span><br><span class=\"line\">    &lt;db.url&gt;jdbc:mysql://localhost:3306&lt;/db.url&gt;</span><br><span class=\"line\">    &lt;db.username&gt;root&lt;/db.username&gt;</span><br><span class=\"line\">    &lt;db.password&gt;********&lt;/db.password&gt;</span><br><span class=\"line\">    &lt;db.schema&gt;study&lt;/db.schema&gt;</span><br><span class=\"line\">&lt;/properties&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">&lt;!--数据库迁移, 同步的插件 --&gt;</span><br><span class=\"line\">&lt;plugin&gt;</span><br><span class=\"line\">    &lt;groupId&gt;org.flywaydb&lt;/groupId&gt;</span><br><span class=\"line\">    &lt;artifactId&gt;flyway-maven-plugin&lt;/artifactId&gt;</span><br><span class=\"line\">    &lt;version&gt;3.0&lt;/version&gt;</span><br><span class=\"line\">    &lt;!-- Note that we&apos;re executing the Flyway plugin in the &quot;generate-sources&quot; phase --&gt;</span><br><span class=\"line\">    &lt;executions&gt;</span><br><span class=\"line\">        &lt;execution&gt;</span><br><span class=\"line\">            &lt;phase&gt;generate-sources&lt;/phase&gt;</span><br><span class=\"line\">            &lt;goals&gt;</span><br><span class=\"line\">                &lt;goal&gt;migrate&lt;/goal&gt;</span><br><span class=\"line\">            &lt;/goals&gt;</span><br><span class=\"line\">        &lt;/execution&gt;</span><br><span class=\"line\">    &lt;/executions&gt;</span><br><span class=\"line\">    &lt;!-- Note that we need to prefix the db/migration path with filesystem:</span><br><span class=\"line\">    to prevent Flyway from looking for our migration scripts only on the classpath --&gt;</span><br><span class=\"line\">    &lt;configuration&gt;</span><br><span class=\"line\">        &lt;url&gt;$&#123;db.url&#125;&lt;/url&gt;</span><br><span class=\"line\">        &lt;user&gt;$&#123;db.username&#125;&lt;/user&gt;</span><br><span class=\"line\">        &lt;password&gt;$&#123;db.password&#125;&lt;/password&gt;</span><br><span class=\"line\">        &lt;encoding&gt;$&#123;project.build.sourceEncoding&#125;&lt;/encoding&gt;</span><br><span class=\"line\">        &lt;schemas&gt;</span><br><span class=\"line\">            &lt;schema&gt;$&#123;db.schema&#125;&lt;/schema&gt;</span><br><span class=\"line\">        &lt;/schemas&gt;</span><br><span class=\"line\">        &lt;locations&gt;</span><br><span class=\"line\">            &lt;location&gt;filesystem:src/main/resources/db/migration&lt;/location&gt;</span><br><span class=\"line\">        &lt;/locations&gt;</span><br><span class=\"line\">    &lt;/configuration&gt;</span><br><span class=\"line\">&lt;/plugin&gt;</span><br></pre></td></tr></table></figure></p>\n<p>在工程：src/main/resources/db/migration目录下，没有目录文件夹时需要先创建文件夹。放入数据库初始化SQL脚本：V1__init_database.sql。注意在maven中配置的db.schema=study，表明需要使用的数据库名称是study，study需要事先不存在。</p>\n<p>执行maven -clean、maven -install成功后，发现数据库有了新的数据库study，并且该数据库有了order、user、schema_version三张表，user、order是我们在脚本中定义需要生成的表，而schema_version是flyway生成的，维护数据库版本升级时的信息。对应的在代码中，生成了三个POJO。</p>\n<p>代码生成示例：<br><img src=\"/img/jooq-flyway.png\" alt=\"IDEA使用JOOQ自动生成代码\"></p>\n<h3 id=\"With-HikariCp\"><a href=\"#With-HikariCp\" class=\"headerlink\" title=\"With HikariCp\"></a>With HikariCp</h3><p>HikariCP号称是现在性能最好的JDBC连接池组件，具体的性能到底如何，我也没有仔细的测试过，不过从它现在的发展来看，其可能确实如它宣传的那样其性能高过目前所有的连接池组件。之前对连接池的记忆一直都是C3P0、DBCP、BoneCP，这三者中BoneCP的性能是最好的，C3P0的性能在现在来说确实是非常差的了，好像C3P0很久都没有更新了，所以我们应该杜绝在项目中使用C3P0，至于是否要使用HikariCP，我觉得可以尝试。HikariCP毕竟是才出来不久，其性能到底如何，也需要实践的检验，若是担心新东西有坑，我推荐使用BoneCP。Spring现在也集成了HikariCP，所以我觉得很有尝试它的必要。前不久我在项目中使用了HikariCP，也没出现什么问题，运行比较稳定。</p>\n<p>HikariCP在github上的地址：<a href=\"https://github.com/brettwooldridge/HikariCP\" target=\"_blank\" rel=\"external\">https://github.com/brettwooldridge/HikariCP</a></p>\n<p><a href=\"http://blog.csdn.net/clementad/article/details/46928621\" target=\"_blank\" rel=\"external\">为什么HikariCP被号称为性能最好的Java数据库连接池，如何配置使用?</a></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;!--JDBC连接池 --&gt;</span><br><span class=\"line\">&lt;dependency&gt;</span><br><span class=\"line\">    &lt;groupId&gt;com.zaxxer&lt;/groupId&gt;</span><br><span class=\"line\">    &lt;artifactId&gt;HikariCP&lt;/artifactId&gt;</span><br><span class=\"line\">    &lt;version&gt;2.4.0&lt;/version&gt;</span><br><span class=\"line\">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>\n<h3 id=\"简单的CRUD\"><a href=\"#简单的CRUD\" class=\"headerlink\" title=\"简单的CRUD\"></a>简单的CRUD</h3><p>为保持example的干净与轻便，不使用Spring进行ORM层的管理，我采用<a href=\"http://www.oschina.net/question/12_10706\" target=\"_blank\" rel=\"external\">ARM</a>的方式来管理SQL链接，在try with resource块结束后自动释放SQL链接。</p>\n<p>有需要与Spring进行整合的，Follow这篇文章吧！<a href=\"http://www.jooq.org/doc/3.7/manual/getting-started/tutorials/jooq-with-spring/\" target=\"_blank\" rel=\"external\">Using JOOQ with Spring and Apache DBCP</a></p>\n<p>同时我也将JOOQ与Spring 4、Spring-MVC进行了整合，代码地址：<a href=\"https://github.com/amao12580/JOOQ-With-Spring\" target=\"_blank\" rel=\"external\">https://github.com/amao12580/JOOQ-With-Spring</a>，使用Spring Transaction进行事务管理。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">try(ScopedContext scopedContext=new ScopedContext())&#123;//try with resource</span><br><span class=\"line\">    DSLContext create=scopedContext.getDSLContext();</span><br><span class=\"line\">    int uid =180;</span><br><span class=\"line\"></span><br><span class=\"line\">    //add</span><br><span class=\"line\">    UserRecord userRecord=create.newRecord(USER);</span><br><span class=\"line\">    userRecord.setAge((byte) 18);</span><br><span class=\"line\">    userRecord.setMobile(&quot;15985236985&quot;);</span><br><span class=\"line\">    userRecord.setName(&quot;赵六&quot;);</span><br><span class=\"line\">    userRecord.setUid(uid);</span><br><span class=\"line\">    userRecord.setSex((byte) 1);</span><br><span class=\"line\">    userRecord.setPassword(String.valueOf(System.nanoTime()));</span><br><span class=\"line\">    userRecord.setRegisterTime(new Timestamp(System.currentTimeMillis()));</span><br><span class=\"line\">    int insertRet=userRecord.insert();//执行insert sql</span><br><span class=\"line\">    //userRecord.store();//可能会执行insert，也有可能执行update，文档说明的很清晰</span><br><span class=\"line\">    //userRecord.refresh();//从数据库重新加载该记录</span><br><span class=\"line\">    log.info(&quot;insertRet:&#123;&#125;&quot;, insertRet);</span><br><span class=\"line\"></span><br><span class=\"line\">    //index</span><br><span class=\"line\">    int createIndexRet=create.createIndex(&quot;user_index_mobile_unique&quot;)</span><br><span class=\"line\">            .on(USER, USER.MOBILE)</span><br><span class=\"line\">            .execute();//为手机号码字段创建唯一索引</span><br><span class=\"line\">    int dropIndexRet=create.dropIndex(&quot;user_index_mobile_unique&quot;)</span><br><span class=\"line\">            .on(USER)</span><br><span class=\"line\">            .execute();//删除索引</span><br><span class=\"line\">    log.info(&quot;dropIndexRet:&#123;&#125;,createIndexRet:&#123;&#125;&quot;, dropIndexRet, createIndexRet);</span><br><span class=\"line\"></span><br><span class=\"line\">    //select</span><br><span class=\"line\">    Record record=create.select(USER.NAME,USER.UID)</span><br><span class=\"line\">            .from(USER)</span><br><span class=\"line\">            .where(USER.MOBILE.eq(&quot;15985236985&quot;))</span><br><span class=\"line\">            .limit(1)</span><br><span class=\"line\">            .fetchOne();</span><br><span class=\"line\">    log.info(&quot;姓名:&#123;&#125;，uid:&#123;&#125;&quot;, record.getValue(USER.NAME), record.getValue(USER.UID));</span><br><span class=\"line\"></span><br><span class=\"line\">    Result&lt;UserRecord&gt; userRecords=create.selectFrom(USER)</span><br><span class=\"line\">            .where(USER.SEX.eq((byte) 1).and(USER.MOBILE.like(&quot;159%&quot;)))</span><br><span class=\"line\">            .orderBy(USER.MOBILE.asc()).limit(0, 20).fetch();</span><br><span class=\"line\"></span><br><span class=\"line\">    for (UserRecord ur:userRecords)&#123;</span><br><span class=\"line\">        log.info(&quot;mobile:&#123;&#125;,uid:&#123;&#125;,registerTime:&#123;&#125;&quot;, ur.getMobile(), ur.getUid(), ur.getRegisterTime().getTime());</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    //delete</span><br><span class=\"line\">    int deleteRecordRet=create.deleteFrom(USER).where(USER.UID.eq(uid)).execute();</span><br><span class=\"line\">    log.info(&quot;deleteRecordRet:&#123;&#125;&quot;, deleteRecordRet);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">日志打印信息：</span><br><span class=\"line\">21:01:20.009 INFO  com.zaxxer.hikari.HikariDataSource 72 &lt;init&gt; - Hikari pool HikariPool-0 is starting.</span><br><span class=\"line\">21:01:20.561 INFO  org.jooq.tools.JooqLogger 331 info -</span><br><span class=\"line\"></span><br><span class=\"line\">@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@</span><br><span class=\"line\">@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@</span><br><span class=\"line\">@@@@@@@@@@@@@@@@  @@        @@@@@@@@@@</span><br><span class=\"line\">@@@@@@@@@@@@@@@@@@@@        @@@@@@@@@@</span><br><span class=\"line\">@@@@@@@@@@@@@@@@  @@  @@    @@@@@@@@@@</span><br><span class=\"line\">@@@@@@@@@@  @@@@  @@  @@    @@@@@@@@@@</span><br><span class=\"line\">@@@@@@@@@@        @@        @@@@@@@@@@</span><br><span class=\"line\">@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@</span><br><span class=\"line\">@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@</span><br><span class=\"line\">@@@@@@@@@@        @@        @@@@@@@@@@</span><br><span class=\"line\">@@@@@@@@@@    @@  @@  @@@@  @@@@@@@@@@</span><br><span class=\"line\">@@@@@@@@@@    @@  @@  @@@@  @@@@@@@@@@</span><br><span class=\"line\">@@@@@@@@@@        @@  @  @  @@@@@@@@@@</span><br><span class=\"line\">@@@@@@@@@@        @@        @@@@@@@@@@</span><br><span class=\"line\">@@@@@@@@@@@@@@@@@@@@@@@  @@@@@@@@@@@@@</span><br><span class=\"line\">@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@</span><br><span class=\"line\">@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@  Thank you for using jOOQ 3.8.2</span><br><span class=\"line\"></span><br><span class=\"line\">21:01:20.593 INFO  com.study.jooq.model.Example 42 base - insertRet:1</span><br><span class=\"line\">21:01:21.197 INFO  com.study.jooq.model.Example 51 base - dropIndexRet:0,createIndexRet:0</span><br><span class=\"line\">21:01:21.278 INFO  com.study.jooq.model.Example 59 base - 姓名:赵六，uid:180</span><br><span class=\"line\">21:01:21.282 INFO  com.study.jooq.model.Example 66 base - mobile:15925874536,uid:102,registerTime:1459331629000</span><br><span class=\"line\">21:01:21.282 INFO  com.study.jooq.model.Example 66 base - mobile:15985236985,uid:180,registerTime:1459429281000</span><br><span class=\"line\">21:01:21.285 INFO  com.study.jooq.model.Example 71 base - deleteRecordRet:1</span><br><span class=\"line\">21:01:21.285 INFO  com.zaxxer.hikari.pool.HikariPool 242 shutdown - Hikari pool HikariPool-0 is shutting down.</span><br><span class=\"line\">21:01:21.331 INFO  com.zaxxer.hikari.util.ConcurrentBag 197 add - ConcurrentBag has been closed, ignoring add()</span><br></pre></td></tr></table></figure>\n<h2 id=\"进阶篇\"><a href=\"#进阶篇\" class=\"headerlink\" title=\"进阶篇\"></a>进阶篇</h2><h3 id=\"事务\"><a href=\"#事务\" class=\"headerlink\" title=\"事务\"></a>事务</h3><p>JOOQ目前并不支持类似Spring的声明式事务管理，暂时只支持由自身API提供的编程式事务管理。有关声明式事务管理与编程式事务管理的区别，请Follow：<a href=\"http://blog.csdn.net/u012228718/article/details/42750119#t1\" target=\"_blank\" rel=\"external\">编程式事务与声明式事务</a>。但JOOQ作者Lukas Eder明确表示在未来的3.9版本中，会提供解决方案。</p>\n<ul>\n<li><p><a href=\"http://www.jooq.org/doc/3.8/manual/sql-execution/transaction-management/\" target=\"_blank\" rel=\"external\">http://www.jooq.org/doc/3.8/manual/sql-execution/transaction-management/</a></p>\n</li>\n<li><p><a href=\"https://github.com/jOOQ/jOOQ/issues/4836\" target=\"_blank\" rel=\"external\">https://github.com/jOOQ/jOOQ/issues/4836</a></p>\n</li>\n</ul>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">try(ScopedContext scopedContext=new ScopedContext())&#123;//try with resource</span><br><span class=\"line\">    DSLContext create=scopedContext.getDSLContext();</span><br><span class=\"line\">    final int[] uid = new int[1];</span><br><span class=\"line\"></span><br><span class=\"line\">    //transaction</span><br><span class=\"line\"></span><br><span class=\"line\">    create.transaction(configuration -&gt; &#123;</span><br><span class=\"line\">        //add</span><br><span class=\"line\">        UserRecord userRecord=create.newRecord(USER);</span><br><span class=\"line\">        userRecord.setAge((byte) 18);</span><br><span class=\"line\">        userRecord.setMobile(&quot;18525874539&quot;);</span><br><span class=\"line\">        userRecord.setName(&quot;赵六&quot;);</span><br><span class=\"line\">        userRecord.setSex((byte) 1);</span><br><span class=\"line\">        userRecord.setPassword(String.valueOf(System.nanoTime()));</span><br><span class=\"line\">        userRecord.setRegisterTime(new Timestamp(System.currentTimeMillis()));</span><br><span class=\"line\">        int insertUserRet=userRecord.insert();//执行insert sql</span><br><span class=\"line\">        uid[0] =userRecord.getUid();</span><br><span class=\"line\">        log.info(&quot;insertUserRet:&#123;&#125;&quot;, insertUserRet);</span><br><span class=\"line\">        //add</span><br><span class=\"line\">        OrderRecord orderRecord=create.newRecord(ORDER);</span><br><span class=\"line\">        orderRecord.setUid(userRecord.getUid());</span><br><span class=\"line\">        orderRecord.setAmout(25000l);</span><br><span class=\"line\">        orderRecord.setOrderId(new BigDecimal(System.nanoTime()).intValue());</span><br><span class=\"line\">        orderRecord.setOrderTime(new Timestamp(System.currentTimeMillis()));</span><br><span class=\"line\">        orderRecord.setStatus((byte)0);</span><br><span class=\"line\">        int insertOrderRet=orderRecord.insert();//执行insert sql</span><br><span class=\"line\">        log.info(&quot;insertOrderRet:&#123;&#125;&quot;, insertOrderRet);</span><br><span class=\"line\">    &#125;);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">12:51:14.724 INFO  com.study.jooq.model.Example 90 lambda$advance$0 - insertUserRet:1</span><br><span class=\"line\">12:51:14.743 INFO  com.study.jooq.model.Example 99 lambda$advance$0 - insertOrderRet:1</span><br></pre></td></tr></table></figure>\n<h3 id=\"连接查询\"><a href=\"#连接查询\" class=\"headerlink\" title=\"连接查询\"></a>连接查询</h3><p>在处理复杂SQL时，JOOQ的思路是由Java代码以<a href=\"http://www.jianshu.com/p/540711c1a507\" target=\"_blank\" rel=\"external\">链式编程</a>的方式来解决可读性的问题。</p>\n<p>下文中的查询语句，等价于：<br>select <code>study</code>.<code>user</code>.<code>mobile</code>, <code>study</code>.<code>user</code>.<code>name</code>, <code>study</code>.<code>user</code>.<code>age</code>, <code>study</code>.<code>order</code>.<code>order_id</code>, <code>study</code>.<code>order</code>.<code>amout</code>, <code>study</code>.<code>order</code>.<code>order_time</code><br>    from <code>study</code>.<code>user</code> left outer join <code>study</code>.<code>order</code><br>    on <code>study</code>.<code>user</code>.<code>uid</code> = <code>study</code>.<code>order</code>.<code>uid</code><br>    where (<code>study</code>.<code>user</code>.<code>uid</code> = ? and <code>study</code>.<code>order</code>.<code>amout</code> &gt;= ?)<br>    limit ?<br>可以发现SQL语句与代码保持了很高的相似性，可读性几乎没有损失。</p>\n<p>其他的特性：group by与having、union、union all也都是在api级别支持的。<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">try(ScopedContext scopedContext=new ScopedContext())&#123;//try with resource</span><br><span class=\"line\">    DSLContext create=scopedContext.getDSLContext();</span><br><span class=\"line\">    int uid=15874523;</span><br><span class=\"line\"></span><br><span class=\"line\">    //join select</span><br><span class=\"line\"></span><br><span class=\"line\">    Result&lt;Record6&lt;String,String,Byte,Integer,Long,Timestamp&gt;&gt; results=create</span><br><span class=\"line\">            .select(USER.MOBILE,USER.NAME,USER.AGE,ORDER.ORDER_ID,ORDER.AMOUT,ORDER.ORDER_TIME)</span><br><span class=\"line\">            .from(USER).leftOuterJoin(ORDER)</span><br><span class=\"line\">            .on(USER.UID.eq(ORDER.UID))</span><br><span class=\"line\">            .where(USER.UID.eq(uid[0]).and(ORDER.AMOUT.ge(100l)))</span><br><span class=\"line\">            .limit(0,10).fetch();</span><br><span class=\"line\">    for (Record6&lt;String,String,Byte,Integer,Long,Timestamp&gt; record:results)&#123;</span><br><span class=\"line\">        log.info(&quot;姓名:&#123;&#125;，手机号码:&#123;&#125;，年龄:&#123;&#125;，订单号:&#123;&#125;，订单金额:&#123;&#125;，订单时间:&#123;&#125;&quot;,</span><br><span class=\"line\">                record.getValue(USER.NAME),record.getValue(USER.MOBILE),record.getValue(USER.AGE),</span><br><span class=\"line\">                record.getValue(ORDER.ORDER_ID),record.getValue(ORDER.AMOUT),</span><br><span class=\"line\">                record.getValue(ORDER.ORDER_TIME));</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">12:51:14.898 INFO  com.study.jooq.model.Example 110 advance - 姓名:赵六，手机号码:18525874539，年龄:18，订单号:-1725080559，订单金额:25000，订单时间:1459486275000</span><br></pre></td></tr></table></figure></p>\n<h3 id=\"批处理\"><a href=\"#批处理\" class=\"headerlink\" title=\"批处理\"></a>批处理</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">//batchInsert</span><br><span class=\"line\">try(ScopedContext scopedContext=new ScopedContext())&#123;//try with resource</span><br><span class=\"line\">    DSLContext create=scopedContext.getDSLContext();</span><br><span class=\"line\">    List&lt;UserRecord&gt; list=new ArrayList&lt;&gt;();</span><br><span class=\"line\"></span><br><span class=\"line\">     //batchInsert</span><br><span class=\"line\">    UserRecord userRecord=create.newRecord(USER);</span><br><span class=\"line\">    userRecord.setAge((byte) 18);</span><br><span class=\"line\">    userRecord.setMobile(&quot;17058963215&quot;);</span><br><span class=\"line\">    userRecord.setName(&quot;赵六&quot;);</span><br><span class=\"line\">    userRecord.setSex((byte) 1);</span><br><span class=\"line\">    userRecord.setPassword(String.valueOf(System.nanoTime()));</span><br><span class=\"line\">    userRecord.setRegisterTime(new Timestamp(System.currentTimeMillis()));</span><br><span class=\"line\">    list.add(userRecord);</span><br><span class=\"line\"></span><br><span class=\"line\">    UserRecord userRecord2=create.newRecord(USER);</span><br><span class=\"line\">    userRecord2.setAge((byte) 29);</span><br><span class=\"line\">    userRecord2.setMobile(&quot;17058963216&quot;);</span><br><span class=\"line\">    userRecord2.setName(&quot;马七&quot;);</span><br><span class=\"line\">    userRecord2.setSex((byte) 1);</span><br><span class=\"line\">    userRecord2.setPassword(String.valueOf(System.nanoTime()));</span><br><span class=\"line\">    userRecord2.setRegisterTime(new Timestamp(System.currentTimeMillis()));</span><br><span class=\"line\">    list.add(userRecord2);</span><br><span class=\"line\">    //使用batchInsert时，无法获取SQL语句</span><br><span class=\"line\">    int insertRetArr[]=create.batchInsert(list).execute();//返回值是一个int数组，长度与输入的集合size有关。</span><br><span class=\"line\"></span><br><span class=\"line\">    log.info(&quot;insertRetArr:&#123;&#125;&quot;, Arrays.toString(insertRetArr));//数组每个元素为1时，执行成功</span><br><span class=\"line\">    //使用batchInsert时，无法获取数据自增长的主键值</span><br><span class=\"line\">    log.info(&quot;userRecord:uid:&#123;&#125;&quot;, userRecord.getUid());</span><br><span class=\"line\">    log.info(&quot;userRecord2:uid:&#123;&#125;&quot;, userRecord2.getUid());</span><br><span class=\"line\"></span><br><span class=\"line\">    userRecord.refresh();</span><br><span class=\"line\">    userRecord2.refresh();</span><br><span class=\"line\">    log.info(&quot;userRecord:uid:&#123;&#125;&quot;, userRecord.getUid());</span><br><span class=\"line\">    log.info(&quot;userRecord2:uid:&#123;&#125;&quot;, userRecord2.getUid());</span><br><span class=\"line\"></span><br><span class=\"line\">    //batchUpdate</span><br><span class=\"line\">    userRecord.setAge((byte) 38);</span><br><span class=\"line\">    userRecord2.setAge((byte) 78);</span><br><span class=\"line\">    list.clear();</span><br><span class=\"line\">    list.add(userRecord);</span><br><span class=\"line\">    list.add(userRecord2);</span><br><span class=\"line\">    //使用batchUpdate时，无法获取SQL语句</span><br><span class=\"line\">    int updateRetArr[]=create.batchUpdate(list).execute();//返回值是一个int数组，长度与输入的集合size有关。</span><br><span class=\"line\">    log.info(&quot;updateRetArr:&#123;&#125;&quot;, Arrays.toString(updateRetArr));//数组每个元素为1时，执行成功</span><br><span class=\"line\"></span><br><span class=\"line\">    //batchDelete</span><br><span class=\"line\">    //使用batchDelete时，无法获取SQL语句</span><br><span class=\"line\">    int deleteRetArr[]=create.batchDelete(list).execute();//返回值是一个int数组，长度与输入的集合size有关。</span><br><span class=\"line\">    log.info(&quot;deleteRetArr:&#123;&#125;&quot;, Arrays.toString(deleteRetArr));//数组每个元素为1时，执行成功</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">15:06:46.281 INFO  com.study.jooq.model.Example 163 batch - insertRetArr:[1, 1]</span><br><span class=\"line\">15:06:46.281 INFO  com.study.jooq.model.Example 165 batch - userRecord:uid:null</span><br><span class=\"line\">15:06:46.281 INFO  com.study.jooq.model.Example 166 batch - userRecord2:uid:null</span><br><span class=\"line\">15:06:46.287 INFO  com.study.jooq.model.Example 176 batch - updateRetArr:[0, 0]</span><br><span class=\"line\">15:06:46.291 INFO  com.study.jooq.model.Example 182 batch - deleteRetArr:[0, 0]</span><br></pre></td></tr></table></figure>\n<h3 id=\"函数\"><a href=\"#函数\" class=\"headerlink\" title=\"函数\"></a>函数</h3><p>JOOQ没有提供API对函数进行显式的支持，这意味着不能通过JOOQ进行函数的create/execute/drop。但是JOOQ支持直接执行拼接好的字符串SQL语句，这为我们进行函数execute提供了可行性。实际使用中，使用ORM层对数据库函数进行create/drop的需求几乎不存在。<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1. 先在Mysql中添加自定义函数，你也可以使用Flyway的方式来做，在migration文件夹下加一个V2 sql文件。重新执行maven -install即可生效，实际上我更推荐使用这种方式来进行数据库历史SQL执行管理。</span><br><span class=\"line\"></span><br><span class=\"line\">USE study;</span><br><span class=\"line\">DROP FUNCTION IF EXISTS formatDate;</span><br><span class=\"line\"></span><br><span class=\"line\">DELIMITER //</span><br><span class=\"line\">CREATE FUNCTION formatDate(fdate datetime)</span><br><span class=\"line\">RETURNS VARCHAR(255)</span><br><span class=\"line\">RETURN date_format(fdate,&apos;%Y年%m月%d日%h时%i分%s秒&apos;);</span><br><span class=\"line\">//</span><br><span class=\"line\">DELIMITER ;</span><br><span class=\"line\"></span><br><span class=\"line\">SELECT formatDate(NOW()) AS &apos;时间&apos;;</span><br><span class=\"line\"></span><br><span class=\"line\">2. 使用JOOQ进行函数execute</span><br><span class=\"line\">try(ScopedContext scopedContext=new ScopedContext())&#123;//try with resource</span><br><span class=\"line\">    DSLContext create=scopedContext.getDSLContext();</span><br><span class=\"line\">    //formatDate是我们在mysql里自定义的函数</span><br><span class=\"line\">    Result&lt;Record&gt; results=create.fetch(&quot;SELECT formatDate(NOW()) AS &apos;时间&apos;;&quot;);</span><br><span class=\"line\">    for (Record record:results)&#123;</span><br><span class=\"line\">        log.info(&quot;执行结果:&#123;&#125;&quot;,record.getValue(0));</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">15:54:28.815 INFO  com.study.jooq.model.Example 199 function - 执行结果:2016年04月01日03时54分28秒</span><br></pre></td></tr></table></figure></p>\n<h3 id=\"存储过程\"><a href=\"#存储过程\" class=\"headerlink\" title=\"存储过程\"></a>存储过程</h3><p>存储过程同函数一样，没有进行显式的create/drop支持。<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1. 先在Mysql中添加存储过程</span><br><span class=\"line\">USE study;</span><br><span class=\"line\">DROP PROCEDURE IF EXISTS getAllUid;</span><br><span class=\"line\"></span><br><span class=\"line\">DELIMITER //</span><br><span class=\"line\">CREATE PROCEDURE getAllUid()</span><br><span class=\"line\">BEGIN</span><br><span class=\"line\">  SELECT uid FROM user;</span><br><span class=\"line\">END//</span><br><span class=\"line\">DELIMITER ;</span><br><span class=\"line\"></span><br><span class=\"line\">CALL getAllUid();</span><br><span class=\"line\"></span><br><span class=\"line\">2. 使用JOOQ进行存储过程execute</span><br><span class=\"line\">try(ScopedContext scopedContext=new ScopedContext())&#123;//try with resource</span><br><span class=\"line\">    DSLContext create=scopedContext.getDSLContext();</span><br><span class=\"line\">    //getAllUid是我们在mysql里定义的存储过程</span><br><span class=\"line\">    Result&lt;Record&gt; results=create.fetch(&quot;CALL getAllUid()&quot;);</span><br><span class=\"line\">    for (Record record:results)&#123;</span><br><span class=\"line\">        log.info(&quot;执行结果:&#123;&#125;&quot;,record.getValue(0));</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">16:08:19.333 INFO  com.study.jooq.model.Example 211 procedure - 执行结果:100</span><br><span class=\"line\">16:08:19.333 INFO  com.study.jooq.model.Example 211 procedure - 执行结果:102</span><br><span class=\"line\">16:08:19.334 INFO  com.study.jooq.model.Example 211 procedure - 执行结果:101</span><br></pre></td></tr></table></figure></p>\n<h3 id=\"视图\"><a href=\"#视图\" class=\"headerlink\" title=\"视图\"></a>视图</h3><p>通过代码构建视图后，JOOQ不能自动生成视图对应的实体类，需要手工做一次maven -install。以下示例中会生成类文件：Userwithorder.java<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">try(ScopedContext scopedContext=new ScopedContext())&#123;//try with resource</span><br><span class=\"line\">    DSLContext create=scopedContext.getDSLContext();</span><br><span class=\"line\">    //创建视图</span><br><span class=\"line\"></span><br><span class=\"line\">    //定义视图名称为：userwithorder</span><br><span class=\"line\">    CreateViewFinalStep step=create.createView(&quot;userwithorder&quot;,USER.UID.getName(),USER.NAME.getName(),ORDER.ORDER_ID.getName(),ORDER.STATUS.getName(),ORDER.AMOUT.getName())</span><br><span class=\"line\">            .as(</span><br><span class=\"line\">                    create.select(USER.UID, USER.NAME, ORDER.ORDER_ID, ORDER.STATUS, ORDER.AMOUT)</span><br><span class=\"line\">                            .from(USER)</span><br><span class=\"line\">                            .leftOuterJoin(ORDER)</span><br><span class=\"line\">                            .on(USER.UID.eq(ORDER.UID))</span><br><span class=\"line\">            );</span><br><span class=\"line\">    log.info(&quot;SQL:&#123;&#125;&quot;,step.getSQL());</span><br><span class=\"line\">    int ret=step.execute();</span><br><span class=\"line\">    log.info(&quot;创建视图,执行结果:&#123;&#125;&quot;,ret);</span><br><span class=\"line\"></span><br><span class=\"line\">    //查询视图</span><br><span class=\"line\">    Result&lt;Record3&lt;Integer,String,Integer&gt;&gt; results=create.select(USERWITHORDER.UID,USERWITHORDER.NAME,USERWITHORDER.ORDER_ID)</span><br><span class=\"line\">            .from(USERWITHORDER).where(USERWITHORDER.AMOUT.ge(200l)).fetch();</span><br><span class=\"line\">    for (Record3&lt;Integer,String,Integer&gt; record:results)&#123;</span><br><span class=\"line\">        log.info(&quot;uid:&#123;&#125;，姓名:&#123;&#125;，订单号:&#123;&#125;&quot;,</span><br><span class=\"line\">                record.getValue(USERWITHORDER.UID),record.getValue(USERWITHORDER.NAME),record.getValue(USERWITHORDER.ORDER_ID));</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    //删除视图</span><br><span class=\"line\">    int dropRet=create.dropView(&quot;userwithorder&quot;).execute();</span><br><span class=\"line\">    log.info(&quot;删除视图,执行结果:&#123;&#125;&quot;,dropRet);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">16:54:10.597 INFO  com.study.jooq.model.Example 231 view - SQL:create view `userwithorder`(`uid`, `name`, `order_id`, `status`, `amout`) as select `study`.`user`.`uid`, `study`.`user`.`name`, `study`.`order`.`order_id`, `study`.`order`.`status`, `study`.`order`.`amout` from `study`.`user` left outer join `study`.`order` on `study`.`user`.`uid` = `study`.`order`.`uid`</span><br><span class=\"line\">16:54:10.712 INFO  com.study.jooq.model.Example 233 view - 创建视图,执行结果:0</span><br><span class=\"line\">16:54:10.760 INFO  com.study.jooq.model.Example 239 view - uid:100，姓名:张三，订单号:200</span><br><span class=\"line\">16:54:10.761 INFO  com.study.jooq.model.Example 239 view - uid:100，姓名:张三，订单号:201</span><br><span class=\"line\">16:54:10.761 INFO  com.study.jooq.model.Example 239 view - uid:101，姓名:李四，订单号:202</span><br><span class=\"line\">16:54:10.765 INFO  com.study.jooq.model.Example 244 view - 删除视图,执行结果:0</span><br></pre></td></tr></table></figure></p>\n<h3 id=\"运算符\"><a href=\"#运算符\" class=\"headerlink\" title=\"运算符\"></a>运算符</h3><p>有时候可能需要在SQL中，对字段(或字段之间)进行加减乘除等运算操作。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">需求示例，在箱子规格表(不重复)中，找出前十条，按照箱子的容积的最大值(int 11)与最小值(int 11)范围，与给定值(528)进行比较排序，找出最接近的十条。</span><br><span class=\"line\">select * from box</span><br><span class=\"line\">    where min_size&lt;=528 and max_size&gt;=528</span><br><span class=\"line\">    order by ((min_size+max_size)/2)-528 asc</span><br><span class=\"line\">    limit 0,10;</span><br><span class=\"line\"></span><br><span class=\"line\">使用JOOQ完全可以满足这样的要求</span><br><span class=\"line\">try(ScopedContext scopedContext=new ScopedContext())&#123;//try with resource</span><br><span class=\"line\">    DSLContext create=scopedContext.getDSLContext();</span><br><span class=\"line\">    int conditionSize=528;</span><br><span class=\"line\">    int pageNo=1;</span><br><span class=\"line\">    int pageSize=10;</span><br><span class=\"line\"></span><br><span class=\"line\">    SortField sortFieldBySize = ((((BOX.MAX_SIZE.add(BOX.MIN_SIZE)).divide(2)).</span><br><span class=\"line\">    minus(conditionSize)).asc();</span><br><span class=\"line\"></span><br><span class=\"line\">    Result result=create.selectFrom(BOX).</span><br><span class=\"line\">    where(BOX.MIN_SIZE.lessOrEqual(conditionSize)).</span><br><span class=\"line\">    and(BOX.MAX_SIZE.greaterOrEqual(conditionSize)).</span><br><span class=\"line\">    orderBy(sortFieldBySize).</span><br><span class=\"line\">    limit((pageNo-1) * pageSize, pageSize).</span><br><span class=\"line\">    fetch();</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"高级篇\"><a href=\"#高级篇\" class=\"headerlink\" title=\"高级篇\"></a>高级篇</h2><p>这部分面向于对JOOQ保持更多热情的读者，谈到JOOQ的高阶特性，这些特性在企业级开发中往往会用的很多，但对于个人开发者可能就没那么重要了。因此个人开发者可以选择性的阅读。</p>\n<p>推荐企业在大面积应用JOOQ之前详细阅读这部分的内容，以更好的在生产环境稳定使用。</p>\n<h3 id=\"重复使用Statement\"><a href=\"#重复使用Statement\" class=\"headerlink\" title=\"重复使用Statement\"></a>重复使用Statement</h3><p>数据库系统对SQL语句的处理一般会经过如下过程。</p>\n<ul>\n<li>1.查询解析器（Query parser）：用于检查查询是否合法</li>\n<li>2.查询重写器（Query rewriter）：用于预优化查询</li>\n<li>3.查询优化器（Query optimizer）：用于优化查询</li>\n<li>4.查询执行器（Query executor）：用于编译和执行查询</li>\n</ul>\n<p>PreparedStatement是java.sql包下面的一个接口，用来执行SQL语句查询，通过调用connection.preparedStatement(sql)方法可以获得PreparedStatment对象。数据库系统会对sql语句进行预编译处理（如果JDBC驱动支持的话），预处理语句将被预先编译好，这条预编译的sql查询语句能在将来的查询中重用，这样一来，它比Statement对象生成的查询速度更快。</p>\n<p>对比以上4条处理过程，复用的PreparedStatement对象，将直接跳过3.5步（最后一步的编译部分也跳过啦），直接被数据库执行，对于复杂并且高频率执行的SQL，这将极大的提高TPS！</p>\n<p>在JDBC中如何做？</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// 获取PreparedStatement对象，此时数据库已经将String类型的SQL预编译过了。</span><br><span class=\"line\">try (PreparedStatement stmt = connection.prepareStatement(&quot;SELECT 1 FROM DUAL&quot;)) &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    // 第一次使用，获取结果集</span><br><span class=\"line\">    try (ResultSet rs1 = stmt.executeQuery()) &#123; ... &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    // 不关闭，再次使用，获取结果集（此时结果集可能发生了变化）</span><br><span class=\"line\">    try (ResultSet rs2 = stmt.executeQuery()) &#123; ... &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>在JOOQ中如何做？</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">//重复使用Statement</span><br><span class=\"line\">try (ScopedContext scopedContext = new ScopedContext()) &#123;//try with resource</span><br><span class=\"line\">    DSLContext create = scopedContext.getDSLContext();</span><br><span class=\"line\"></span><br><span class=\"line\">    // 创建一个被配置保持打开的Statement</span><br><span class=\"line\">    try (ResultQuery&lt;Record1&lt;Integer&gt;&gt; query = create.selectOne().keepStatement(true)) &#123;</span><br><span class=\"line\">        Result&lt;Record1&lt;Integer&gt;&gt; result1 = query.fetch(); // This will lazily create a new PreparedStatement</span><br><span class=\"line\">        log.info(&quot;result1:&quot; + result1.toString());</span><br><span class=\"line\">        Result&lt;Record1&lt;Integer&gt;&gt; result2 = query.fetch(); // This will reuse the previous PreparedStatement</span><br><span class=\"line\">        log.info(&quot;result2:&quot; + result2.toString());</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"draft-With-Ehcache\"><a href=\"#draft-With-Ehcache\" class=\"headerlink\" title=\"[draft] With Ehcache\"></a>[draft] With Ehcache</h3><p>未完成。</p>\n<p>讨论JOOQ与Ehcache等进程级别缓存模块的集成，引申地，会谈到中间件级别的数据库缓存，如：Redis。</p>\n<h3 id=\"draft-钩子函数：DefaultRecordListener-如何使用？\"><a href=\"#draft-钩子函数：DefaultRecordListener-如何使用？\" class=\"headerlink\" title=\"[draft] 钩子函数：DefaultRecordListener 如何使用？\"></a>[draft] 钩子函数：DefaultRecordListener 如何使用？</h3><p>未完成。</p>\n<p>讨论JOOQ重要特性：DefaultRecordListener(简称Listener)。</p>\n<p>Listener的应用场景，数据库操作完成后同步回调。</p>\n<p>示例需求：简书网站，完成MySQL插入或更新文章后，需要在搜索接口(Solr)中半实时的查询到最新文章。</p>\n<p>分析：强一致性需求，在MySQL和搜索引擎同时操作成功，才算一个事务成功。</p>\n<p>使用JOOQ获取MySQL数据库链接时，注册Listener，指向更新Solr的业务逻辑。</p>\n<h3 id=\"draft-更快的分页-seek\"><a href=\"#draft-更快的分页-seek\" class=\"headerlink\" title=\"[draft] 更快的分页(seek)\"></a>[draft] 更快的分页(seek)</h3><p>未完成。</p>\n<p>Seek方法本来就没有跳过OFFSET之前的记录，它跳过的是所有以前获取到的最后一条记录之前的记录。考虑一下谷歌的翻页。从实用角度看的话，你几乎不可能准确地跳过100’000行记录。</p>\n<h2 id=\"小技巧\"><a href=\"#小技巧\" class=\"headerlink\" title=\"小技巧\"></a>小技巧</h2><h3 id=\"获取SQL语句\"><a href=\"#获取SQL语句\" class=\"headerlink\" title=\"获取SQL语句\"></a>获取SQL语句</h3><p>JOOQ允许在执行(fetch*、excute)前的SQL构建阶段，获取任一阶段的文本SQL语句。<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">//2张表完成左外连接构建阶段后的Step</span><br><span class=\"line\">SelectForUpdateStep sfus=create</span><br><span class=\"line\">        .select(USER.MOBILE, USER.NAME, USER.AGE, ORDER.ORDER_ID, ORDER.AMOUT, ORDER.ORDER_TIME)</span><br><span class=\"line\">        .from(USER).leftOuterJoin(ORDER)</span><br><span class=\"line\">        .on(USER.UID.eq(ORDER.UID));</span><br><span class=\"line\"></span><br><span class=\"line\">//2张表查询语句构建结束后的Step</span><br><span class=\"line\">SelectForUpdateStep sfus1=create</span><br><span class=\"line\">        .select(USER.MOBILE,USER.NAME,USER.AGE,ORDER.ORDER_ID,ORDER.AMOUT,ORDER.ORDER_TIME)</span><br><span class=\"line\">        .from(USER).leftOuterJoin(ORDER)</span><br><span class=\"line\">        .on(USER.UID.eq(ORDER.UID))</span><br><span class=\"line\">        .where(USER.UID.eq(uid[0]).and(ORDER.AMOUT.ge(100l)))</span><br><span class=\"line\">        .limit(0, 10);</span><br><span class=\"line\">log.info(&quot;s:&quot; + sfus.getSQL());</span><br><span class=\"line\">log.info(&quot;s1:&quot; + sfus.getSQL());</span><br><span class=\"line\"></span><br><span class=\"line\">14:23:05.305 INFO  com.study.jooq.model.Example 123 advance - s:select `study`.`user`.`mobile`, `study`.`user`.`name`, `study`.`user`.`age`, `study`.`order`.`order_id`, `study`.`order`.`amout`, `study`.`order`.`order_time` from `study`.`user` left outer join `study`.`order` on `study`.`user`.`uid` = `study`.`order`.`uid`</span><br><span class=\"line\"></span><br><span class=\"line\">14:23:05.306 INFO  com.study.jooq.model.Example 124 advance - s1:select `study`.`user`.`mobile`, `study`.`user`.`name`, `study`.`user`.`age`, `study`.`order`.`order_id`, `study`.`order`.`amout`, `study`.`order`.`order_time` from `study`.`user` left outer join `study`.`order` on `study`.`user`.`uid` = `study`.`order`.`uid</span><br></pre></td></tr></table></figure></p>\n<h2 id=\"Some-else\"><a href=\"#Some-else\" class=\"headerlink\" title=\"Some else\"></a>Some else</h2><h3 id=\"JPA与JDBC有什么区别？\"><a href=\"#JPA与JDBC有什么区别？\" class=\"headerlink\" title=\"JPA与JDBC有什么区别？\"></a>JPA与JDBC有什么区别？</h3><ul>\n<li>JDBC：Java Data Base Connectivity，java数据库连接，用于直接调用SQL 命令，也就是用于执行SQL语句的Java API，是面向数据库的。</li>\n<li>JPA：Java Persistence API，Java持久性API，用来操作实体对象，持久性提供了很多实现，编程人员只需要编写实体类，实体类中的主要信息为实体与数据库中表、字段、主键的对应，可以免除编写繁琐的SQL。</li>\n</ul>\n<h3 id=\"JOOQ与JDBC的详细区别\"><a href=\"#JOOQ与JDBC的详细区别\" class=\"headerlink\" title=\"JOOQ与JDBC的详细区别\"></a>JOOQ与JDBC的详细区别</h3><ul>\n<li><a href=\"http://www.jooq.org/doc/3.8/manual/sql-execution/comparison-with-jdbc/\" target=\"_blank\" rel=\"external\">Comparison between jOOQ and JDBC</a></li>\n</ul>\n<h2 id=\"Reference\"><a href=\"#Reference\" class=\"headerlink\" title=\"Reference\"></a>Reference</h2><ul>\n<li><a href=\"http://blog.jobbole.com/100349/\" target=\"_blank\" rel=\"external\">如果有人问你数据库的原理，叫他看这篇文章</a></li>\n</ul>\n","excerpt":"","more":"<h2 id=\"写在前面\"><a href=\"#写在前面\" class=\"headerlink\" title=\"写在前面\"></a>写在前面</h2><p>2016年后换了一家公司干，后台ORM框架用的JOOQ，完全陌生的东西。干这一行越久，越觉得有更多有趣的新事物需要去探索。想起小说<a href=\"https://book.douban.com/subject/26586492/\">《火星救援》</a>，Mark侥幸在火星风暴中幸存后，一步步将自己救出困境，遇到的难题或大或小，皆有优雅解决之法。一切看似偶然蹊跷，其实与Mark的长期知识储备分不开。所谓艺多不压身，应该在有限的时间里，得到更多成长，以期待机会来时不辜负。</p>\n<p>下文中的学习示例代码，已经整理完毕：</p>\n<ul>\n<li><p>原味基础学习：<a href=\"https://github.com/amao12580/JOOQ\">https://github.com/amao12580/JOOQ</a></p>\n</li>\n<li><p>与Spring深度整合：<a href=\"https://github.com/amao12580/JOOQ-With-Spring\">https://github.com/amao12580/JOOQ-With-Spring</a></p>\n</li>\n</ul>\n<h2 id=\"什么是JOOQ？\"><a href=\"#什么是JOOQ？\" class=\"headerlink\" title=\"什么是JOOQ？\"></a>什么是JOOQ？</h2><p><a href=\"http://www.jooq.org/\">JOOQ</a>，全称Java Object Oriented Querying，即面向Java对象查询。它是<a href=\"http://www.datageekery.com/\">Data Geekery</a>公司研发的DA方案(Data Access Layer)，主要解决两个问题：</p>\n<ol>\n<li>Hibernate的抽象使得我们离SQL太远，对SQL的掌控力度弱</li>\n<li>JDBC又过于嘈杂，需要干的事情太多</li>\n</ol>\n<p>JOOQ希望干的就是在上述两者中寻找一个最佳的平衡。它依据数据库中的表生成DA相关的代码，开发者将生成的代码引入项目中即可使用。</p>\n<p>有好几个版本</p>\n<ul>\n<li>OpenSource</li>\n<li>Express</li>\n<li>Professional</li>\n<li>Enterprise</li>\n</ul>\n<p>OpenSource版本针对开源数据库，已经够用了。其它的几个版本针对非开源数据库，差异在于不同的后续支持。</p>\n<p>想了解各版本的更多区别，跟我一起看吧。</p>\n<ul>\n<li><p><a href=\"http://www.jooq.org/legal/licensing\">http://www.jooq.org/legal/licensing</a></p>\n</li>\n<li><p><a href=\"http://www.jooq.org/download/\">http://www.jooq.org/download/</a></p>\n</li>\n</ul>\n<p>JOOQ作为ORM框架，其原理是：在DAO层使用Java语言编写SQL语句，在Intellij IDEA的辅助下，复杂SQL的维护变得很容易。通过内部SQL Builder转换成数据库可执行的SQL文本，使用数据库驱动，提交SQL到RDBMS执行，接受处理结果，转换为POJO，返回到应用层。</p>\n<p>它与Hibernate不同，不依赖使用字符串变量在Java代码中拼接SQL语句。在复杂SQL语句中，与变量的组合拼接时，SQL被割裂成多个部分，失去了宝贵的可读性，这简直是噩梦。而且Hibernate饱受诟病的连接查询配置复杂以及HQL语法的问题，在JOOQ中不复存在。</p>\n<p>它与Mybatis不同，不依赖繁琐分散的XML进行SQL预定义。代码与SQL语句的分离，初衷是为了解决SQL嵌入代码时带来不直观的复杂性，但是分离的代价是维护工作倍增以及类型转换问题，经常遭遇到应用层代码变更，而XML定义未同步变更，IDE几乎无法解决。又或者开发人员改动一个XML文件，却意外影响多处上层代码，而这个问题很难避免。</p>\n<p>更进一步的，JOOQ提供原生的类型安全转换，以及POJO维护，免去大量一次性代码的编写。当然，你也可以使用Eclipse<a href=\"http://my.oschina.net/lujianing/blog/200135\">代码生成插件</a>解决这个问题，但是如果ORM能自动解决(结合Maven Plugin)，为什么拒绝呢？</p>\n<p>使用这种DAO模式，可以通过类的方式来进行数据库访问了。而且对SQL控制粒度加大的同时，维护工作并没有因此倍增，这对于开发人员是更好的解决方案，也是未来的趋势。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">使用JOOQ进行2张表内连接查询示例</span><br><span class=\"line\"></span><br><span class=\"line\">// Typesafely execute the SQL statement directly with jOOQ</span><br><span class=\"line\">Result&lt;Record3&lt;String, String, String&gt;&gt; result =</span><br><span class=\"line\">create.select(BOOK.TITLE, AUTHOR.FIRST_NAME, AUTHOR.LAST_NAME)</span><br><span class=\"line\">    .from(BOOK)</span><br><span class=\"line\">    .join(AUTHOR)</span><br><span class=\"line\">    .on(BOOK.AUTHOR_ID.equal(AUTHOR.ID))</span><br><span class=\"line\">    .where(BOOK.PUBLISHED_IN.equal(1948))</span><br><span class=\"line\">    .fetch();</span><br></pre></td></tr></table></figure>\n<h3 id=\"VS-主流ORM框架\"><a href=\"#VS-主流ORM框架\" class=\"headerlink\" title=\"VS 主流ORM框架\"></a>VS 主流ORM框架</h3><ul>\n<li><a href=\"http://blog.jooq.org/2015/03/24/jooq-vs-hibernate-when-to-choose-which/\">JOOQ vs. Hibernate: When to Choose Which</a></li>\n<li><a href=\"http://blog.jooq.org/2013/07/13/sql-templating-with-jooq-or-mybatis/\">SQL Templating with jOOQ or MyBatis</a><h3 id=\"优势和局限性\"><a href=\"#优势和局限性\" class=\"headerlink\" title=\"优势和局限性\"></a>优势和局限性</h3></li>\n</ul>\n<p>优势</p>\n<ul>\n<li>JOOQ 高效的合并了复杂SQL、<a href=\"http://blog.jooq.org/2015/05/26/type-safe-queries-for-jpas-native-query-api/\">类型安全</a>、<a href=\"#Code-Generation\">源码生成</a>、Active Records、存储过程以及高级数据类型的 Java 类库。支持DB2, Derby, Ingres, H2, HSQLDB, MySQL, Oracle, Postgres, SQLite, SQL Server, Sybase。</li>\n</ul>\n<p>局限性</p>\n<ul>\n<li>开发人员需要转换思维，接受新事物，May be better？</li>\n</ul>\n<h2 id=\"入门篇\"><a href=\"#入门篇\" class=\"headerlink\" title=\"入门篇\"></a>入门篇</h2><h3 id=\"With-MySQL\"><a href=\"#With-MySQL\" class=\"headerlink\" title=\"With MySQL\"></a>With MySQL</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;!--MySQL JDBC driver, 数据库迁移等情况下需要. --&gt;</span><br><span class=\"line\">&lt;dependency&gt;</span><br><span class=\"line\">    &lt;groupId&gt;mysql&lt;/groupId&gt;</span><br><span class=\"line\">    &lt;artifactId&gt;mysql-connector-java&lt;/artifactId&gt;</span><br><span class=\"line\">    &lt;version&gt;5.1.36&lt;/version&gt;</span><br><span class=\"line\">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>\n<h3 id=\"Code-Generation\"><a href=\"#Code-Generation\" class=\"headerlink\" title=\"Code Generation\"></a>Code Generation</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;!--数据库schema代码生成器 --&gt;</span><br><span class=\"line\">&lt;dependency&gt;</span><br><span class=\"line\">    &lt;groupId&gt;org.jooq&lt;/groupId&gt;</span><br><span class=\"line\">    &lt;artifactId&gt;jooq-codegen&lt;/artifactId&gt;</span><br><span class=\"line\">    &lt;version&gt;3.8.2&lt;/version&gt;</span><br><span class=\"line\">&lt;/dependency&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">&lt;!--数据库代码生成的插件 --&gt;</span><br><span class=\"line\">&lt;plugin&gt;</span><br><span class=\"line\">    &lt;!-- Specify the maven code generator plugin --&gt;</span><br><span class=\"line\">    &lt;groupId&gt;org.jooq&lt;/groupId&gt;</span><br><span class=\"line\">    &lt;artifactId&gt;jooq-codegen-maven&lt;/artifactId&gt;</span><br><span class=\"line\">    &lt;version&gt;3.8.2&lt;/version&gt;</span><br><span class=\"line\">    &lt;!-- The plugin should hook into the generate goal --&gt;</span><br><span class=\"line\">    &lt;executions&gt;</span><br><span class=\"line\">        &lt;execution&gt;</span><br><span class=\"line\">            &lt;goals&gt;</span><br><span class=\"line\">                &lt;goal&gt;generate&lt;/goal&gt;</span><br><span class=\"line\">            &lt;/goals&gt;</span><br><span class=\"line\">        &lt;/execution&gt;</span><br><span class=\"line\">    &lt;/executions&gt;</span><br><span class=\"line\">    &lt;configuration&gt;</span><br><span class=\"line\">        &lt;!-- JDBC connection parameters --&gt;</span><br><span class=\"line\">        &lt;jdbc&gt;</span><br><span class=\"line\">            &lt;driver&gt;com.mysql.jdbc.Driver&lt;/driver&gt;</span><br><span class=\"line\">            &lt;url&gt;$&#123;db.url&#125;&lt;/url&gt;</span><br><span class=\"line\">            &lt;user&gt;$&#123;db.username&#125;&lt;/user&gt;</span><br><span class=\"line\">            &lt;password&gt;$&#123;db.password&#125;&lt;/password&gt;</span><br><span class=\"line\">        &lt;/jdbc&gt;</span><br><span class=\"line\">        &lt;!-- Generator parameters --&gt;</span><br><span class=\"line\">        &lt;generator&gt;</span><br><span class=\"line\">            &lt;database&gt;</span><br><span class=\"line\">                &lt;name&gt;org.jooq.util.mysql.MySQLDatabase&lt;/name&gt;</span><br><span class=\"line\">                &lt;includes&gt;.*&lt;/includes&gt;</span><br><span class=\"line\">                &lt;inputSchema&gt;$&#123;db.schema&#125;&lt;/inputSchema&gt;</span><br><span class=\"line\">                &lt;forcedTypes&gt;</span><br><span class=\"line\">                    &lt;forcedType&gt;</span><br><span class=\"line\">                        &lt;name&gt;BOOLEAN&lt;/name&gt;</span><br><span class=\"line\">                        &lt;expression&gt;.*\\.HANDMADE&lt;/expression&gt;</span><br><span class=\"line\">                        &lt;types&gt;.*&lt;/types&gt;</span><br><span class=\"line\">                    &lt;/forcedType&gt;</span><br><span class=\"line\">                &lt;/forcedTypes&gt;</span><br><span class=\"line\">            &lt;/database&gt;</span><br><span class=\"line\">            &lt;target&gt;</span><br><span class=\"line\">                &lt;packageName&gt;com.study.jooq.common.generated&lt;/packageName&gt;</span><br><span class=\"line\">                &lt;directory&gt;src/main/java&lt;/directory&gt;</span><br><span class=\"line\">            &lt;/target&gt;</span><br><span class=\"line\">        &lt;/generator&gt;</span><br><span class=\"line\">    &lt;/configuration&gt;</span><br><span class=\"line\">&lt;/plugin&gt;</span><br></pre></td></tr></table></figure>\n<h3 id=\"With-Flyway\"><a href=\"#With-Flyway\" class=\"headerlink\" title=\"With Flyway\"></a>With Flyway</h3><p>Flyway 是独立于数据库的应用、管理并跟踪数据库变更的数据库版本管理工具。</p>\n<p><a href=\"http://www.cnblogs.com/huang0925/p/4409506.html\">Flyway， 数据库Schema管理利器</a></p>\n<p>在pom.xml的配置<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;properties&gt;</span><br><span class=\"line\">    &lt;project.build.sourceEncoding&gt;UTF-8&lt;/project.build.sourceEncoding&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">    &lt;!--防止maven改动IDE的language level --&gt;</span><br><span class=\"line\">    &lt;maven.compiler.source&gt;1.8&lt;/maven.compiler.source&gt;</span><br><span class=\"line\">    &lt;maven.compiler.target&gt;1.8&lt;/maven.compiler.target&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">    &lt;!--数据库迁移所用的参数 --&gt;</span><br><span class=\"line\">    &lt;db.url&gt;jdbc:mysql://localhost:3306&lt;/db.url&gt;</span><br><span class=\"line\">    &lt;db.username&gt;root&lt;/db.username&gt;</span><br><span class=\"line\">    &lt;db.password&gt;********&lt;/db.password&gt;</span><br><span class=\"line\">    &lt;db.schema&gt;study&lt;/db.schema&gt;</span><br><span class=\"line\">&lt;/properties&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">&lt;!--数据库迁移, 同步的插件 --&gt;</span><br><span class=\"line\">&lt;plugin&gt;</span><br><span class=\"line\">    &lt;groupId&gt;org.flywaydb&lt;/groupId&gt;</span><br><span class=\"line\">    &lt;artifactId&gt;flyway-maven-plugin&lt;/artifactId&gt;</span><br><span class=\"line\">    &lt;version&gt;3.0&lt;/version&gt;</span><br><span class=\"line\">    &lt;!-- Note that we&apos;re executing the Flyway plugin in the &quot;generate-sources&quot; phase --&gt;</span><br><span class=\"line\">    &lt;executions&gt;</span><br><span class=\"line\">        &lt;execution&gt;</span><br><span class=\"line\">            &lt;phase&gt;generate-sources&lt;/phase&gt;</span><br><span class=\"line\">            &lt;goals&gt;</span><br><span class=\"line\">                &lt;goal&gt;migrate&lt;/goal&gt;</span><br><span class=\"line\">            &lt;/goals&gt;</span><br><span class=\"line\">        &lt;/execution&gt;</span><br><span class=\"line\">    &lt;/executions&gt;</span><br><span class=\"line\">    &lt;!-- Note that we need to prefix the db/migration path with filesystem:</span><br><span class=\"line\">    to prevent Flyway from looking for our migration scripts only on the classpath --&gt;</span><br><span class=\"line\">    &lt;configuration&gt;</span><br><span class=\"line\">        &lt;url&gt;$&#123;db.url&#125;&lt;/url&gt;</span><br><span class=\"line\">        &lt;user&gt;$&#123;db.username&#125;&lt;/user&gt;</span><br><span class=\"line\">        &lt;password&gt;$&#123;db.password&#125;&lt;/password&gt;</span><br><span class=\"line\">        &lt;encoding&gt;$&#123;project.build.sourceEncoding&#125;&lt;/encoding&gt;</span><br><span class=\"line\">        &lt;schemas&gt;</span><br><span class=\"line\">            &lt;schema&gt;$&#123;db.schema&#125;&lt;/schema&gt;</span><br><span class=\"line\">        &lt;/schemas&gt;</span><br><span class=\"line\">        &lt;locations&gt;</span><br><span class=\"line\">            &lt;location&gt;filesystem:src/main/resources/db/migration&lt;/location&gt;</span><br><span class=\"line\">        &lt;/locations&gt;</span><br><span class=\"line\">    &lt;/configuration&gt;</span><br><span class=\"line\">&lt;/plugin&gt;</span><br></pre></td></tr></table></figure></p>\n<p>在工程：src/main/resources/db/migration目录下，没有目录文件夹时需要先创建文件夹。放入数据库初始化SQL脚本：V1__init_database.sql。注意在maven中配置的db.schema=study，表明需要使用的数据库名称是study，study需要事先不存在。</p>\n<p>执行maven -clean、maven -install成功后，发现数据库有了新的数据库study，并且该数据库有了order、user、schema_version三张表，user、order是我们在脚本中定义需要生成的表，而schema_version是flyway生成的，维护数据库版本升级时的信息。对应的在代码中，生成了三个POJO。</p>\n<p>代码生成示例：<br><img src=\"/img/jooq-flyway.png\" alt=\"IDEA使用JOOQ自动生成代码\"></p>\n<h3 id=\"With-HikariCp\"><a href=\"#With-HikariCp\" class=\"headerlink\" title=\"With HikariCp\"></a>With HikariCp</h3><p>HikariCP号称是现在性能最好的JDBC连接池组件，具体的性能到底如何，我也没有仔细的测试过，不过从它现在的发展来看，其可能确实如它宣传的那样其性能高过目前所有的连接池组件。之前对连接池的记忆一直都是C3P0、DBCP、BoneCP，这三者中BoneCP的性能是最好的，C3P0的性能在现在来说确实是非常差的了，好像C3P0很久都没有更新了，所以我们应该杜绝在项目中使用C3P0，至于是否要使用HikariCP，我觉得可以尝试。HikariCP毕竟是才出来不久，其性能到底如何，也需要实践的检验，若是担心新东西有坑，我推荐使用BoneCP。Spring现在也集成了HikariCP，所以我觉得很有尝试它的必要。前不久我在项目中使用了HikariCP，也没出现什么问题，运行比较稳定。</p>\n<p>HikariCP在github上的地址：<a href=\"https://github.com/brettwooldridge/HikariCP\">https://github.com/brettwooldridge/HikariCP</a></p>\n<p><a href=\"http://blog.csdn.net/clementad/article/details/46928621\">为什么HikariCP被号称为性能最好的Java数据库连接池，如何配置使用?</a></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;!--JDBC连接池 --&gt;</span><br><span class=\"line\">&lt;dependency&gt;</span><br><span class=\"line\">    &lt;groupId&gt;com.zaxxer&lt;/groupId&gt;</span><br><span class=\"line\">    &lt;artifactId&gt;HikariCP&lt;/artifactId&gt;</span><br><span class=\"line\">    &lt;version&gt;2.4.0&lt;/version&gt;</span><br><span class=\"line\">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>\n<h3 id=\"简单的CRUD\"><a href=\"#简单的CRUD\" class=\"headerlink\" title=\"简单的CRUD\"></a>简单的CRUD</h3><p>为保持example的干净与轻便，不使用Spring进行ORM层的管理，我采用<a href=\"http://www.oschina.net/question/12_10706\">ARM</a>的方式来管理SQL链接，在try with resource块结束后自动释放SQL链接。</p>\n<p>有需要与Spring进行整合的，Follow这篇文章吧！<a href=\"http://www.jooq.org/doc/3.7/manual/getting-started/tutorials/jooq-with-spring/\">Using JOOQ with Spring and Apache DBCP</a></p>\n<p>同时我也将JOOQ与Spring 4、Spring-MVC进行了整合，代码地址：<a href=\"https://github.com/amao12580/JOOQ-With-Spring\">https://github.com/amao12580/JOOQ-With-Spring</a>，使用Spring Transaction进行事务管理。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">try(ScopedContext scopedContext=new ScopedContext())&#123;//try with resource</span><br><span class=\"line\">    DSLContext create=scopedContext.getDSLContext();</span><br><span class=\"line\">    int uid =180;</span><br><span class=\"line\"></span><br><span class=\"line\">    //add</span><br><span class=\"line\">    UserRecord userRecord=create.newRecord(USER);</span><br><span class=\"line\">    userRecord.setAge((byte) 18);</span><br><span class=\"line\">    userRecord.setMobile(&quot;15985236985&quot;);</span><br><span class=\"line\">    userRecord.setName(&quot;赵六&quot;);</span><br><span class=\"line\">    userRecord.setUid(uid);</span><br><span class=\"line\">    userRecord.setSex((byte) 1);</span><br><span class=\"line\">    userRecord.setPassword(String.valueOf(System.nanoTime()));</span><br><span class=\"line\">    userRecord.setRegisterTime(new Timestamp(System.currentTimeMillis()));</span><br><span class=\"line\">    int insertRet=userRecord.insert();//执行insert sql</span><br><span class=\"line\">    //userRecord.store();//可能会执行insert，也有可能执行update，文档说明的很清晰</span><br><span class=\"line\">    //userRecord.refresh();//从数据库重新加载该记录</span><br><span class=\"line\">    log.info(&quot;insertRet:&#123;&#125;&quot;, insertRet);</span><br><span class=\"line\"></span><br><span class=\"line\">    //index</span><br><span class=\"line\">    int createIndexRet=create.createIndex(&quot;user_index_mobile_unique&quot;)</span><br><span class=\"line\">            .on(USER, USER.MOBILE)</span><br><span class=\"line\">            .execute();//为手机号码字段创建唯一索引</span><br><span class=\"line\">    int dropIndexRet=create.dropIndex(&quot;user_index_mobile_unique&quot;)</span><br><span class=\"line\">            .on(USER)</span><br><span class=\"line\">            .execute();//删除索引</span><br><span class=\"line\">    log.info(&quot;dropIndexRet:&#123;&#125;,createIndexRet:&#123;&#125;&quot;, dropIndexRet, createIndexRet);</span><br><span class=\"line\"></span><br><span class=\"line\">    //select</span><br><span class=\"line\">    Record record=create.select(USER.NAME,USER.UID)</span><br><span class=\"line\">            .from(USER)</span><br><span class=\"line\">            .where(USER.MOBILE.eq(&quot;15985236985&quot;))</span><br><span class=\"line\">            .limit(1)</span><br><span class=\"line\">            .fetchOne();</span><br><span class=\"line\">    log.info(&quot;姓名:&#123;&#125;，uid:&#123;&#125;&quot;, record.getValue(USER.NAME), record.getValue(USER.UID));</span><br><span class=\"line\"></span><br><span class=\"line\">    Result&lt;UserRecord&gt; userRecords=create.selectFrom(USER)</span><br><span class=\"line\">            .where(USER.SEX.eq((byte) 1).and(USER.MOBILE.like(&quot;159%&quot;)))</span><br><span class=\"line\">            .orderBy(USER.MOBILE.asc()).limit(0, 20).fetch();</span><br><span class=\"line\"></span><br><span class=\"line\">    for (UserRecord ur:userRecords)&#123;</span><br><span class=\"line\">        log.info(&quot;mobile:&#123;&#125;,uid:&#123;&#125;,registerTime:&#123;&#125;&quot;, ur.getMobile(), ur.getUid(), ur.getRegisterTime().getTime());</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    //delete</span><br><span class=\"line\">    int deleteRecordRet=create.deleteFrom(USER).where(USER.UID.eq(uid)).execute();</span><br><span class=\"line\">    log.info(&quot;deleteRecordRet:&#123;&#125;&quot;, deleteRecordRet);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">日志打印信息：</span><br><span class=\"line\">21:01:20.009 INFO  com.zaxxer.hikari.HikariDataSource 72 &lt;init&gt; - Hikari pool HikariPool-0 is starting.</span><br><span class=\"line\">21:01:20.561 INFO  org.jooq.tools.JooqLogger 331 info -</span><br><span class=\"line\"></span><br><span class=\"line\">@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@</span><br><span class=\"line\">@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@</span><br><span class=\"line\">@@@@@@@@@@@@@@@@  @@        @@@@@@@@@@</span><br><span class=\"line\">@@@@@@@@@@@@@@@@@@@@        @@@@@@@@@@</span><br><span class=\"line\">@@@@@@@@@@@@@@@@  @@  @@    @@@@@@@@@@</span><br><span class=\"line\">@@@@@@@@@@  @@@@  @@  @@    @@@@@@@@@@</span><br><span class=\"line\">@@@@@@@@@@        @@        @@@@@@@@@@</span><br><span class=\"line\">@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@</span><br><span class=\"line\">@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@</span><br><span class=\"line\">@@@@@@@@@@        @@        @@@@@@@@@@</span><br><span class=\"line\">@@@@@@@@@@    @@  @@  @@@@  @@@@@@@@@@</span><br><span class=\"line\">@@@@@@@@@@    @@  @@  @@@@  @@@@@@@@@@</span><br><span class=\"line\">@@@@@@@@@@        @@  @  @  @@@@@@@@@@</span><br><span class=\"line\">@@@@@@@@@@        @@        @@@@@@@@@@</span><br><span class=\"line\">@@@@@@@@@@@@@@@@@@@@@@@  @@@@@@@@@@@@@</span><br><span class=\"line\">@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@</span><br><span class=\"line\">@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@  Thank you for using jOOQ 3.8.2</span><br><span class=\"line\"></span><br><span class=\"line\">21:01:20.593 INFO  com.study.jooq.model.Example 42 base - insertRet:1</span><br><span class=\"line\">21:01:21.197 INFO  com.study.jooq.model.Example 51 base - dropIndexRet:0,createIndexRet:0</span><br><span class=\"line\">21:01:21.278 INFO  com.study.jooq.model.Example 59 base - 姓名:赵六，uid:180</span><br><span class=\"line\">21:01:21.282 INFO  com.study.jooq.model.Example 66 base - mobile:15925874536,uid:102,registerTime:1459331629000</span><br><span class=\"line\">21:01:21.282 INFO  com.study.jooq.model.Example 66 base - mobile:15985236985,uid:180,registerTime:1459429281000</span><br><span class=\"line\">21:01:21.285 INFO  com.study.jooq.model.Example 71 base - deleteRecordRet:1</span><br><span class=\"line\">21:01:21.285 INFO  com.zaxxer.hikari.pool.HikariPool 242 shutdown - Hikari pool HikariPool-0 is shutting down.</span><br><span class=\"line\">21:01:21.331 INFO  com.zaxxer.hikari.util.ConcurrentBag 197 add - ConcurrentBag has been closed, ignoring add()</span><br></pre></td></tr></table></figure>\n<h2 id=\"进阶篇\"><a href=\"#进阶篇\" class=\"headerlink\" title=\"进阶篇\"></a>进阶篇</h2><h3 id=\"事务\"><a href=\"#事务\" class=\"headerlink\" title=\"事务\"></a>事务</h3><p>JOOQ目前并不支持类似Spring的声明式事务管理，暂时只支持由自身API提供的编程式事务管理。有关声明式事务管理与编程式事务管理的区别，请Follow：<a href=\"http://blog.csdn.net/u012228718/article/details/42750119#t1\">编程式事务与声明式事务</a>。但JOOQ作者Lukas Eder明确表示在未来的3.9版本中，会提供解决方案。</p>\n<ul>\n<li><p><a href=\"http://www.jooq.org/doc/3.8/manual/sql-execution/transaction-management/\">http://www.jooq.org/doc/3.8/manual/sql-execution/transaction-management/</a></p>\n</li>\n<li><p><a href=\"https://github.com/jOOQ/jOOQ/issues/4836\">https://github.com/jOOQ/jOOQ/issues/4836</a></p>\n</li>\n</ul>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">try(ScopedContext scopedContext=new ScopedContext())&#123;//try with resource</span><br><span class=\"line\">    DSLContext create=scopedContext.getDSLContext();</span><br><span class=\"line\">    final int[] uid = new int[1];</span><br><span class=\"line\"></span><br><span class=\"line\">    //transaction</span><br><span class=\"line\"></span><br><span class=\"line\">    create.transaction(configuration -&gt; &#123;</span><br><span class=\"line\">        //add</span><br><span class=\"line\">        UserRecord userRecord=create.newRecord(USER);</span><br><span class=\"line\">        userRecord.setAge((byte) 18);</span><br><span class=\"line\">        userRecord.setMobile(&quot;18525874539&quot;);</span><br><span class=\"line\">        userRecord.setName(&quot;赵六&quot;);</span><br><span class=\"line\">        userRecord.setSex((byte) 1);</span><br><span class=\"line\">        userRecord.setPassword(String.valueOf(System.nanoTime()));</span><br><span class=\"line\">        userRecord.setRegisterTime(new Timestamp(System.currentTimeMillis()));</span><br><span class=\"line\">        int insertUserRet=userRecord.insert();//执行insert sql</span><br><span class=\"line\">        uid[0] =userRecord.getUid();</span><br><span class=\"line\">        log.info(&quot;insertUserRet:&#123;&#125;&quot;, insertUserRet);</span><br><span class=\"line\">        //add</span><br><span class=\"line\">        OrderRecord orderRecord=create.newRecord(ORDER);</span><br><span class=\"line\">        orderRecord.setUid(userRecord.getUid());</span><br><span class=\"line\">        orderRecord.setAmout(25000l);</span><br><span class=\"line\">        orderRecord.setOrderId(new BigDecimal(System.nanoTime()).intValue());</span><br><span class=\"line\">        orderRecord.setOrderTime(new Timestamp(System.currentTimeMillis()));</span><br><span class=\"line\">        orderRecord.setStatus((byte)0);</span><br><span class=\"line\">        int insertOrderRet=orderRecord.insert();//执行insert sql</span><br><span class=\"line\">        log.info(&quot;insertOrderRet:&#123;&#125;&quot;, insertOrderRet);</span><br><span class=\"line\">    &#125;);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">12:51:14.724 INFO  com.study.jooq.model.Example 90 lambda$advance$0 - insertUserRet:1</span><br><span class=\"line\">12:51:14.743 INFO  com.study.jooq.model.Example 99 lambda$advance$0 - insertOrderRet:1</span><br></pre></td></tr></table></figure>\n<h3 id=\"连接查询\"><a href=\"#连接查询\" class=\"headerlink\" title=\"连接查询\"></a>连接查询</h3><p>在处理复杂SQL时，JOOQ的思路是由Java代码以<a href=\"http://www.jianshu.com/p/540711c1a507\">链式编程</a>的方式来解决可读性的问题。</p>\n<p>下文中的查询语句，等价于：<br>select <code>study</code>.<code>user</code>.<code>mobile</code>, <code>study</code>.<code>user</code>.<code>name</code>, <code>study</code>.<code>user</code>.<code>age</code>, <code>study</code>.<code>order</code>.<code>order_id</code>, <code>study</code>.<code>order</code>.<code>amout</code>, <code>study</code>.<code>order</code>.<code>order_time</code><br>    from <code>study</code>.<code>user</code> left outer join <code>study</code>.<code>order</code><br>    on <code>study</code>.<code>user</code>.<code>uid</code> = <code>study</code>.<code>order</code>.<code>uid</code><br>    where (<code>study</code>.<code>user</code>.<code>uid</code> = ? and <code>study</code>.<code>order</code>.<code>amout</code> &gt;= ?)<br>    limit ?<br>可以发现SQL语句与代码保持了很高的相似性，可读性几乎没有损失。</p>\n<p>其他的特性：group by与having、union、union all也都是在api级别支持的。<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">try(ScopedContext scopedContext=new ScopedContext())&#123;//try with resource</span><br><span class=\"line\">    DSLContext create=scopedContext.getDSLContext();</span><br><span class=\"line\">    int uid=15874523;</span><br><span class=\"line\"></span><br><span class=\"line\">    //join select</span><br><span class=\"line\"></span><br><span class=\"line\">    Result&lt;Record6&lt;String,String,Byte,Integer,Long,Timestamp&gt;&gt; results=create</span><br><span class=\"line\">            .select(USER.MOBILE,USER.NAME,USER.AGE,ORDER.ORDER_ID,ORDER.AMOUT,ORDER.ORDER_TIME)</span><br><span class=\"line\">            .from(USER).leftOuterJoin(ORDER)</span><br><span class=\"line\">            .on(USER.UID.eq(ORDER.UID))</span><br><span class=\"line\">            .where(USER.UID.eq(uid[0]).and(ORDER.AMOUT.ge(100l)))</span><br><span class=\"line\">            .limit(0,10).fetch();</span><br><span class=\"line\">    for (Record6&lt;String,String,Byte,Integer,Long,Timestamp&gt; record:results)&#123;</span><br><span class=\"line\">        log.info(&quot;姓名:&#123;&#125;，手机号码:&#123;&#125;，年龄:&#123;&#125;，订单号:&#123;&#125;，订单金额:&#123;&#125;，订单时间:&#123;&#125;&quot;,</span><br><span class=\"line\">                record.getValue(USER.NAME),record.getValue(USER.MOBILE),record.getValue(USER.AGE),</span><br><span class=\"line\">                record.getValue(ORDER.ORDER_ID),record.getValue(ORDER.AMOUT),</span><br><span class=\"line\">                record.getValue(ORDER.ORDER_TIME));</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">12:51:14.898 INFO  com.study.jooq.model.Example 110 advance - 姓名:赵六，手机号码:18525874539，年龄:18，订单号:-1725080559，订单金额:25000，订单时间:1459486275000</span><br></pre></td></tr></table></figure></p>\n<h3 id=\"批处理\"><a href=\"#批处理\" class=\"headerlink\" title=\"批处理\"></a>批处理</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">//batchInsert</span><br><span class=\"line\">try(ScopedContext scopedContext=new ScopedContext())&#123;//try with resource</span><br><span class=\"line\">    DSLContext create=scopedContext.getDSLContext();</span><br><span class=\"line\">    List&lt;UserRecord&gt; list=new ArrayList&lt;&gt;();</span><br><span class=\"line\"></span><br><span class=\"line\">     //batchInsert</span><br><span class=\"line\">    UserRecord userRecord=create.newRecord(USER);</span><br><span class=\"line\">    userRecord.setAge((byte) 18);</span><br><span class=\"line\">    userRecord.setMobile(&quot;17058963215&quot;);</span><br><span class=\"line\">    userRecord.setName(&quot;赵六&quot;);</span><br><span class=\"line\">    userRecord.setSex((byte) 1);</span><br><span class=\"line\">    userRecord.setPassword(String.valueOf(System.nanoTime()));</span><br><span class=\"line\">    userRecord.setRegisterTime(new Timestamp(System.currentTimeMillis()));</span><br><span class=\"line\">    list.add(userRecord);</span><br><span class=\"line\"></span><br><span class=\"line\">    UserRecord userRecord2=create.newRecord(USER);</span><br><span class=\"line\">    userRecord2.setAge((byte) 29);</span><br><span class=\"line\">    userRecord2.setMobile(&quot;17058963216&quot;);</span><br><span class=\"line\">    userRecord2.setName(&quot;马七&quot;);</span><br><span class=\"line\">    userRecord2.setSex((byte) 1);</span><br><span class=\"line\">    userRecord2.setPassword(String.valueOf(System.nanoTime()));</span><br><span class=\"line\">    userRecord2.setRegisterTime(new Timestamp(System.currentTimeMillis()));</span><br><span class=\"line\">    list.add(userRecord2);</span><br><span class=\"line\">    //使用batchInsert时，无法获取SQL语句</span><br><span class=\"line\">    int insertRetArr[]=create.batchInsert(list).execute();//返回值是一个int数组，长度与输入的集合size有关。</span><br><span class=\"line\"></span><br><span class=\"line\">    log.info(&quot;insertRetArr:&#123;&#125;&quot;, Arrays.toString(insertRetArr));//数组每个元素为1时，执行成功</span><br><span class=\"line\">    //使用batchInsert时，无法获取数据自增长的主键值</span><br><span class=\"line\">    log.info(&quot;userRecord:uid:&#123;&#125;&quot;, userRecord.getUid());</span><br><span class=\"line\">    log.info(&quot;userRecord2:uid:&#123;&#125;&quot;, userRecord2.getUid());</span><br><span class=\"line\"></span><br><span class=\"line\">    userRecord.refresh();</span><br><span class=\"line\">    userRecord2.refresh();</span><br><span class=\"line\">    log.info(&quot;userRecord:uid:&#123;&#125;&quot;, userRecord.getUid());</span><br><span class=\"line\">    log.info(&quot;userRecord2:uid:&#123;&#125;&quot;, userRecord2.getUid());</span><br><span class=\"line\"></span><br><span class=\"line\">    //batchUpdate</span><br><span class=\"line\">    userRecord.setAge((byte) 38);</span><br><span class=\"line\">    userRecord2.setAge((byte) 78);</span><br><span class=\"line\">    list.clear();</span><br><span class=\"line\">    list.add(userRecord);</span><br><span class=\"line\">    list.add(userRecord2);</span><br><span class=\"line\">    //使用batchUpdate时，无法获取SQL语句</span><br><span class=\"line\">    int updateRetArr[]=create.batchUpdate(list).execute();//返回值是一个int数组，长度与输入的集合size有关。</span><br><span class=\"line\">    log.info(&quot;updateRetArr:&#123;&#125;&quot;, Arrays.toString(updateRetArr));//数组每个元素为1时，执行成功</span><br><span class=\"line\"></span><br><span class=\"line\">    //batchDelete</span><br><span class=\"line\">    //使用batchDelete时，无法获取SQL语句</span><br><span class=\"line\">    int deleteRetArr[]=create.batchDelete(list).execute();//返回值是一个int数组，长度与输入的集合size有关。</span><br><span class=\"line\">    log.info(&quot;deleteRetArr:&#123;&#125;&quot;, Arrays.toString(deleteRetArr));//数组每个元素为1时，执行成功</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">15:06:46.281 INFO  com.study.jooq.model.Example 163 batch - insertRetArr:[1, 1]</span><br><span class=\"line\">15:06:46.281 INFO  com.study.jooq.model.Example 165 batch - userRecord:uid:null</span><br><span class=\"line\">15:06:46.281 INFO  com.study.jooq.model.Example 166 batch - userRecord2:uid:null</span><br><span class=\"line\">15:06:46.287 INFO  com.study.jooq.model.Example 176 batch - updateRetArr:[0, 0]</span><br><span class=\"line\">15:06:46.291 INFO  com.study.jooq.model.Example 182 batch - deleteRetArr:[0, 0]</span><br></pre></td></tr></table></figure>\n<h3 id=\"函数\"><a href=\"#函数\" class=\"headerlink\" title=\"函数\"></a>函数</h3><p>JOOQ没有提供API对函数进行显式的支持，这意味着不能通过JOOQ进行函数的create/execute/drop。但是JOOQ支持直接执行拼接好的字符串SQL语句，这为我们进行函数execute提供了可行性。实际使用中，使用ORM层对数据库函数进行create/drop的需求几乎不存在。<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1. 先在Mysql中添加自定义函数，你也可以使用Flyway的方式来做，在migration文件夹下加一个V2 sql文件。重新执行maven -install即可生效，实际上我更推荐使用这种方式来进行数据库历史SQL执行管理。</span><br><span class=\"line\"></span><br><span class=\"line\">USE study;</span><br><span class=\"line\">DROP FUNCTION IF EXISTS formatDate;</span><br><span class=\"line\"></span><br><span class=\"line\">DELIMITER //</span><br><span class=\"line\">CREATE FUNCTION formatDate(fdate datetime)</span><br><span class=\"line\">RETURNS VARCHAR(255)</span><br><span class=\"line\">RETURN date_format(fdate,&apos;%Y年%m月%d日%h时%i分%s秒&apos;);</span><br><span class=\"line\">//</span><br><span class=\"line\">DELIMITER ;</span><br><span class=\"line\"></span><br><span class=\"line\">SELECT formatDate(NOW()) AS &apos;时间&apos;;</span><br><span class=\"line\"></span><br><span class=\"line\">2. 使用JOOQ进行函数execute</span><br><span class=\"line\">try(ScopedContext scopedContext=new ScopedContext())&#123;//try with resource</span><br><span class=\"line\">    DSLContext create=scopedContext.getDSLContext();</span><br><span class=\"line\">    //formatDate是我们在mysql里自定义的函数</span><br><span class=\"line\">    Result&lt;Record&gt; results=create.fetch(&quot;SELECT formatDate(NOW()) AS &apos;时间&apos;;&quot;);</span><br><span class=\"line\">    for (Record record:results)&#123;</span><br><span class=\"line\">        log.info(&quot;执行结果:&#123;&#125;&quot;,record.getValue(0));</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">15:54:28.815 INFO  com.study.jooq.model.Example 199 function - 执行结果:2016年04月01日03时54分28秒</span><br></pre></td></tr></table></figure></p>\n<h3 id=\"存储过程\"><a href=\"#存储过程\" class=\"headerlink\" title=\"存储过程\"></a>存储过程</h3><p>存储过程同函数一样，没有进行显式的create/drop支持。<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1. 先在Mysql中添加存储过程</span><br><span class=\"line\">USE study;</span><br><span class=\"line\">DROP PROCEDURE IF EXISTS getAllUid;</span><br><span class=\"line\"></span><br><span class=\"line\">DELIMITER //</span><br><span class=\"line\">CREATE PROCEDURE getAllUid()</span><br><span class=\"line\">BEGIN</span><br><span class=\"line\">  SELECT uid FROM user;</span><br><span class=\"line\">END//</span><br><span class=\"line\">DELIMITER ;</span><br><span class=\"line\"></span><br><span class=\"line\">CALL getAllUid();</span><br><span class=\"line\"></span><br><span class=\"line\">2. 使用JOOQ进行存储过程execute</span><br><span class=\"line\">try(ScopedContext scopedContext=new ScopedContext())&#123;//try with resource</span><br><span class=\"line\">    DSLContext create=scopedContext.getDSLContext();</span><br><span class=\"line\">    //getAllUid是我们在mysql里定义的存储过程</span><br><span class=\"line\">    Result&lt;Record&gt; results=create.fetch(&quot;CALL getAllUid()&quot;);</span><br><span class=\"line\">    for (Record record:results)&#123;</span><br><span class=\"line\">        log.info(&quot;执行结果:&#123;&#125;&quot;,record.getValue(0));</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">16:08:19.333 INFO  com.study.jooq.model.Example 211 procedure - 执行结果:100</span><br><span class=\"line\">16:08:19.333 INFO  com.study.jooq.model.Example 211 procedure - 执行结果:102</span><br><span class=\"line\">16:08:19.334 INFO  com.study.jooq.model.Example 211 procedure - 执行结果:101</span><br></pre></td></tr></table></figure></p>\n<h3 id=\"视图\"><a href=\"#视图\" class=\"headerlink\" title=\"视图\"></a>视图</h3><p>通过代码构建视图后，JOOQ不能自动生成视图对应的实体类，需要手工做一次maven -install。以下示例中会生成类文件：Userwithorder.java<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">try(ScopedContext scopedContext=new ScopedContext())&#123;//try with resource</span><br><span class=\"line\">    DSLContext create=scopedContext.getDSLContext();</span><br><span class=\"line\">    //创建视图</span><br><span class=\"line\"></span><br><span class=\"line\">    //定义视图名称为：userwithorder</span><br><span class=\"line\">    CreateViewFinalStep step=create.createView(&quot;userwithorder&quot;,USER.UID.getName(),USER.NAME.getName(),ORDER.ORDER_ID.getName(),ORDER.STATUS.getName(),ORDER.AMOUT.getName())</span><br><span class=\"line\">            .as(</span><br><span class=\"line\">                    create.select(USER.UID, USER.NAME, ORDER.ORDER_ID, ORDER.STATUS, ORDER.AMOUT)</span><br><span class=\"line\">                            .from(USER)</span><br><span class=\"line\">                            .leftOuterJoin(ORDER)</span><br><span class=\"line\">                            .on(USER.UID.eq(ORDER.UID))</span><br><span class=\"line\">            );</span><br><span class=\"line\">    log.info(&quot;SQL:&#123;&#125;&quot;,step.getSQL());</span><br><span class=\"line\">    int ret=step.execute();</span><br><span class=\"line\">    log.info(&quot;创建视图,执行结果:&#123;&#125;&quot;,ret);</span><br><span class=\"line\"></span><br><span class=\"line\">    //查询视图</span><br><span class=\"line\">    Result&lt;Record3&lt;Integer,String,Integer&gt;&gt; results=create.select(USERWITHORDER.UID,USERWITHORDER.NAME,USERWITHORDER.ORDER_ID)</span><br><span class=\"line\">            .from(USERWITHORDER).where(USERWITHORDER.AMOUT.ge(200l)).fetch();</span><br><span class=\"line\">    for (Record3&lt;Integer,String,Integer&gt; record:results)&#123;</span><br><span class=\"line\">        log.info(&quot;uid:&#123;&#125;，姓名:&#123;&#125;，订单号:&#123;&#125;&quot;,</span><br><span class=\"line\">                record.getValue(USERWITHORDER.UID),record.getValue(USERWITHORDER.NAME),record.getValue(USERWITHORDER.ORDER_ID));</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    //删除视图</span><br><span class=\"line\">    int dropRet=create.dropView(&quot;userwithorder&quot;).execute();</span><br><span class=\"line\">    log.info(&quot;删除视图,执行结果:&#123;&#125;&quot;,dropRet);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">16:54:10.597 INFO  com.study.jooq.model.Example 231 view - SQL:create view `userwithorder`(`uid`, `name`, `order_id`, `status`, `amout`) as select `study`.`user`.`uid`, `study`.`user`.`name`, `study`.`order`.`order_id`, `study`.`order`.`status`, `study`.`order`.`amout` from `study`.`user` left outer join `study`.`order` on `study`.`user`.`uid` = `study`.`order`.`uid`</span><br><span class=\"line\">16:54:10.712 INFO  com.study.jooq.model.Example 233 view - 创建视图,执行结果:0</span><br><span class=\"line\">16:54:10.760 INFO  com.study.jooq.model.Example 239 view - uid:100，姓名:张三，订单号:200</span><br><span class=\"line\">16:54:10.761 INFO  com.study.jooq.model.Example 239 view - uid:100，姓名:张三，订单号:201</span><br><span class=\"line\">16:54:10.761 INFO  com.study.jooq.model.Example 239 view - uid:101，姓名:李四，订单号:202</span><br><span class=\"line\">16:54:10.765 INFO  com.study.jooq.model.Example 244 view - 删除视图,执行结果:0</span><br></pre></td></tr></table></figure></p>\n<h3 id=\"运算符\"><a href=\"#运算符\" class=\"headerlink\" title=\"运算符\"></a>运算符</h3><p>有时候可能需要在SQL中，对字段(或字段之间)进行加减乘除等运算操作。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">需求示例，在箱子规格表(不重复)中，找出前十条，按照箱子的容积的最大值(int 11)与最小值(int 11)范围，与给定值(528)进行比较排序，找出最接近的十条。</span><br><span class=\"line\">select * from box</span><br><span class=\"line\">    where min_size&lt;=528 and max_size&gt;=528</span><br><span class=\"line\">    order by ((min_size+max_size)/2)-528 asc</span><br><span class=\"line\">    limit 0,10;</span><br><span class=\"line\"></span><br><span class=\"line\">使用JOOQ完全可以满足这样的要求</span><br><span class=\"line\">try(ScopedContext scopedContext=new ScopedContext())&#123;//try with resource</span><br><span class=\"line\">    DSLContext create=scopedContext.getDSLContext();</span><br><span class=\"line\">    int conditionSize=528;</span><br><span class=\"line\">    int pageNo=1;</span><br><span class=\"line\">    int pageSize=10;</span><br><span class=\"line\"></span><br><span class=\"line\">    SortField sortFieldBySize = ((((BOX.MAX_SIZE.add(BOX.MIN_SIZE)).divide(2)).</span><br><span class=\"line\">    minus(conditionSize)).asc();</span><br><span class=\"line\"></span><br><span class=\"line\">    Result result=create.selectFrom(BOX).</span><br><span class=\"line\">    where(BOX.MIN_SIZE.lessOrEqual(conditionSize)).</span><br><span class=\"line\">    and(BOX.MAX_SIZE.greaterOrEqual(conditionSize)).</span><br><span class=\"line\">    orderBy(sortFieldBySize).</span><br><span class=\"line\">    limit((pageNo-1) * pageSize, pageSize).</span><br><span class=\"line\">    fetch();</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"高级篇\"><a href=\"#高级篇\" class=\"headerlink\" title=\"高级篇\"></a>高级篇</h2><p>这部分面向于对JOOQ保持更多热情的读者，谈到JOOQ的高阶特性，这些特性在企业级开发中往往会用的很多，但对于个人开发者可能就没那么重要了。因此个人开发者可以选择性的阅读。</p>\n<p>推荐企业在大面积应用JOOQ之前详细阅读这部分的内容，以更好的在生产环境稳定使用。</p>\n<h3 id=\"重复使用Statement\"><a href=\"#重复使用Statement\" class=\"headerlink\" title=\"重复使用Statement\"></a>重复使用Statement</h3><p>数据库系统对SQL语句的处理一般会经过如下过程。</p>\n<ul>\n<li>1.查询解析器（Query parser）：用于检查查询是否合法</li>\n<li>2.查询重写器（Query rewriter）：用于预优化查询</li>\n<li>3.查询优化器（Query optimizer）：用于优化查询</li>\n<li>4.查询执行器（Query executor）：用于编译和执行查询</li>\n</ul>\n<p>PreparedStatement是java.sql包下面的一个接口，用来执行SQL语句查询，通过调用connection.preparedStatement(sql)方法可以获得PreparedStatment对象。数据库系统会对sql语句进行预编译处理（如果JDBC驱动支持的话），预处理语句将被预先编译好，这条预编译的sql查询语句能在将来的查询中重用，这样一来，它比Statement对象生成的查询速度更快。</p>\n<p>对比以上4条处理过程，复用的PreparedStatement对象，将直接跳过3.5步（最后一步的编译部分也跳过啦），直接被数据库执行，对于复杂并且高频率执行的SQL，这将极大的提高TPS！</p>\n<p>在JDBC中如何做？</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// 获取PreparedStatement对象，此时数据库已经将String类型的SQL预编译过了。</span><br><span class=\"line\">try (PreparedStatement stmt = connection.prepareStatement(&quot;SELECT 1 FROM DUAL&quot;)) &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    // 第一次使用，获取结果集</span><br><span class=\"line\">    try (ResultSet rs1 = stmt.executeQuery()) &#123; ... &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    // 不关闭，再次使用，获取结果集（此时结果集可能发生了变化）</span><br><span class=\"line\">    try (ResultSet rs2 = stmt.executeQuery()) &#123; ... &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>在JOOQ中如何做？</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">//重复使用Statement</span><br><span class=\"line\">try (ScopedContext scopedContext = new ScopedContext()) &#123;//try with resource</span><br><span class=\"line\">    DSLContext create = scopedContext.getDSLContext();</span><br><span class=\"line\"></span><br><span class=\"line\">    // 创建一个被配置保持打开的Statement</span><br><span class=\"line\">    try (ResultQuery&lt;Record1&lt;Integer&gt;&gt; query = create.selectOne().keepStatement(true)) &#123;</span><br><span class=\"line\">        Result&lt;Record1&lt;Integer&gt;&gt; result1 = query.fetch(); // This will lazily create a new PreparedStatement</span><br><span class=\"line\">        log.info(&quot;result1:&quot; + result1.toString());</span><br><span class=\"line\">        Result&lt;Record1&lt;Integer&gt;&gt; result2 = query.fetch(); // This will reuse the previous PreparedStatement</span><br><span class=\"line\">        log.info(&quot;result2:&quot; + result2.toString());</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"draft-With-Ehcache\"><a href=\"#draft-With-Ehcache\" class=\"headerlink\" title=\"[draft] With Ehcache\"></a>[draft] With Ehcache</h3><p>未完成。</p>\n<p>讨论JOOQ与Ehcache等进程级别缓存模块的集成，引申地，会谈到中间件级别的数据库缓存，如：Redis。</p>\n<h3 id=\"draft-钩子函数：DefaultRecordListener-如何使用？\"><a href=\"#draft-钩子函数：DefaultRecordListener-如何使用？\" class=\"headerlink\" title=\"[draft] 钩子函数：DefaultRecordListener 如何使用？\"></a>[draft] 钩子函数：DefaultRecordListener 如何使用？</h3><p>未完成。</p>\n<p>讨论JOOQ重要特性：DefaultRecordListener(简称Listener)。</p>\n<p>Listener的应用场景，数据库操作完成后同步回调。</p>\n<p>示例需求：简书网站，完成MySQL插入或更新文章后，需要在搜索接口(Solr)中半实时的查询到最新文章。</p>\n<p>分析：强一致性需求，在MySQL和搜索引擎同时操作成功，才算一个事务成功。</p>\n<p>使用JOOQ获取MySQL数据库链接时，注册Listener，指向更新Solr的业务逻辑。</p>\n<h3 id=\"draft-更快的分页-seek\"><a href=\"#draft-更快的分页-seek\" class=\"headerlink\" title=\"[draft] 更快的分页(seek)\"></a>[draft] 更快的分页(seek)</h3><p>未完成。</p>\n<p>Seek方法本来就没有跳过OFFSET之前的记录，它跳过的是所有以前获取到的最后一条记录之前的记录。考虑一下谷歌的翻页。从实用角度看的话，你几乎不可能准确地跳过100’000行记录。</p>\n<h2 id=\"小技巧\"><a href=\"#小技巧\" class=\"headerlink\" title=\"小技巧\"></a>小技巧</h2><h3 id=\"获取SQL语句\"><a href=\"#获取SQL语句\" class=\"headerlink\" title=\"获取SQL语句\"></a>获取SQL语句</h3><p>JOOQ允许在执行(fetch*、excute)前的SQL构建阶段，获取任一阶段的文本SQL语句。<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">//2张表完成左外连接构建阶段后的Step</span><br><span class=\"line\">SelectForUpdateStep sfus=create</span><br><span class=\"line\">        .select(USER.MOBILE, USER.NAME, USER.AGE, ORDER.ORDER_ID, ORDER.AMOUT, ORDER.ORDER_TIME)</span><br><span class=\"line\">        .from(USER).leftOuterJoin(ORDER)</span><br><span class=\"line\">        .on(USER.UID.eq(ORDER.UID));</span><br><span class=\"line\"></span><br><span class=\"line\">//2张表查询语句构建结束后的Step</span><br><span class=\"line\">SelectForUpdateStep sfus1=create</span><br><span class=\"line\">        .select(USER.MOBILE,USER.NAME,USER.AGE,ORDER.ORDER_ID,ORDER.AMOUT,ORDER.ORDER_TIME)</span><br><span class=\"line\">        .from(USER).leftOuterJoin(ORDER)</span><br><span class=\"line\">        .on(USER.UID.eq(ORDER.UID))</span><br><span class=\"line\">        .where(USER.UID.eq(uid[0]).and(ORDER.AMOUT.ge(100l)))</span><br><span class=\"line\">        .limit(0, 10);</span><br><span class=\"line\">log.info(&quot;s:&quot; + sfus.getSQL());</span><br><span class=\"line\">log.info(&quot;s1:&quot; + sfus.getSQL());</span><br><span class=\"line\"></span><br><span class=\"line\">14:23:05.305 INFO  com.study.jooq.model.Example 123 advance - s:select `study`.`user`.`mobile`, `study`.`user`.`name`, `study`.`user`.`age`, `study`.`order`.`order_id`, `study`.`order`.`amout`, `study`.`order`.`order_time` from `study`.`user` left outer join `study`.`order` on `study`.`user`.`uid` = `study`.`order`.`uid`</span><br><span class=\"line\"></span><br><span class=\"line\">14:23:05.306 INFO  com.study.jooq.model.Example 124 advance - s1:select `study`.`user`.`mobile`, `study`.`user`.`name`, `study`.`user`.`age`, `study`.`order`.`order_id`, `study`.`order`.`amout`, `study`.`order`.`order_time` from `study`.`user` left outer join `study`.`order` on `study`.`user`.`uid` = `study`.`order`.`uid</span><br></pre></td></tr></table></figure></p>\n<h2 id=\"Some-else\"><a href=\"#Some-else\" class=\"headerlink\" title=\"Some else\"></a>Some else</h2><h3 id=\"JPA与JDBC有什么区别？\"><a href=\"#JPA与JDBC有什么区别？\" class=\"headerlink\" title=\"JPA与JDBC有什么区别？\"></a>JPA与JDBC有什么区别？</h3><ul>\n<li>JDBC：Java Data Base Connectivity，java数据库连接，用于直接调用SQL 命令，也就是用于执行SQL语句的Java API，是面向数据库的。</li>\n<li>JPA：Java Persistence API，Java持久性API，用来操作实体对象，持久性提供了很多实现，编程人员只需要编写实体类，实体类中的主要信息为实体与数据库中表、字段、主键的对应，可以免除编写繁琐的SQL。</li>\n</ul>\n<h3 id=\"JOOQ与JDBC的详细区别\"><a href=\"#JOOQ与JDBC的详细区别\" class=\"headerlink\" title=\"JOOQ与JDBC的详细区别\"></a>JOOQ与JDBC的详细区别</h3><ul>\n<li><a href=\"http://www.jooq.org/doc/3.8/manual/sql-execution/comparison-with-jdbc/\">Comparison between jOOQ and JDBC</a></li>\n</ul>\n<h2 id=\"Reference\"><a href=\"#Reference\" class=\"headerlink\" title=\"Reference\"></a>Reference</h2><ul>\n<li><a href=\"http://blog.jobbole.com/100349/\">如果有人问你数据库的原理，叫他看这篇文章</a></li>\n</ul>\n"},{"title":"Nginx与Docker容器系列 <01:进行编译安装>","date":"2016-04-27T02:47:59.000Z","description":"Docker容器的出现，为应用运行环境一致性带来了很好的解决方案。同时也带来了远比虚拟机更好的体验，提供资源隔离(Linux namespace)和资源分配(Linux control group)的功能、应用可扩展性的功能，但是更加轻量级的运行。为了解决多容器的依赖性和互相调用，提供了docker-compose等工具进行容器编排。","_content":"# 前言\n\nDocker容器的出现，为应用运行环境一致性带来了很好的解决方案。同时也带来了远比虚拟机更好的体验，提供资源隔离(Linux namespace)和资源分配(Linux control group)的功能、应用可扩展性的功能，但是更加轻量级的运行。为了解决多容器的依赖性和互相调用，提供了docker-compose等工具进行容器编排。\n\n我们项目中，对docker的使用非常深入，在线上环境和线下的测试环境、开发环境，都使用了docker作为运行时环境一致性支持。由于linux的发行版本和内核版本的不同组合，在没有docker之前，DevOps很难为不同的运行环境编写统一的软件安装维护的脚本，几乎只能借助虚拟机来达到这一目的，虚拟机的笨重和可调度性差，扩容与缩容也无法做到快速有效，已经被逐渐淘汰。\n\nNginx，性能已经毋庸置疑，但在docker hub上的nginx镜像，并不适合我们，没有对安全进行加固，更多的没有加入重要的功能增加，比如主动式地对后端Tomcat进行健康检查并自动failover，这个动能对HA的非常重要的，因此我们选择了在docker环境下，对官方nginx源码进行编译，并打上补丁，以符合实际生产环境的使用。\n\n本文中的配置文件，已经整理到了GitHub：[https://github.com/amao12580/docker](https://github.com/amao12580/docker)\n\n本文假设读者对Nginx、Docker已经有了比较深入的了解，并掌握了docker-compose工具的使用。\n\n# 安装环境\n## 宿主机的情况\n\n### 操作系统和硬件\n```\n操作系统\nroot@ubuntu-14:~/docker/test# uname -a\nLinux ubuntu-14 4.2.0-35-generic #40~14.04.1-Ubuntu SMP Fri Mar 18 16:37:35 UTC 2016 x86_64 x86_64 x86_64 GNU/Linux\n\nCPU\nroot@ubuntu-14:~/docker/test# lscpu\nArchitecture:          x86_64\nCPU op-mode(s):        32-bit, 64-bit\nByte Order:            Little Endian\nCPU(s):                4\nOn-line CPU(s) list:   0-3\nThread(s) per core:    1\nCore(s) per socket:    4\nSocket(s):             1\nNUMA node(s):          1\nVendor ID:             GenuineIntel\nCPU family:            6\nModel:                 58\nStepping:              9\nCPU MHz:               1600.125\nBogoMIPS:              6385.87\nVirtualization:        VT-x\nL1d cache:             32K\nL1i cache:             32K\nL2 cache:              256K\nL3 cache:              6144K\n\nMemory\nroot@ubuntu-14:~/docker/test# free -m\n             total       used       free     shared    buffers     cached\nMem:          7881       4751       3130          1        419       3810\n-/+ buffers/cache:        520       7360\nSwap:         8087          0       8087\n```\n\n### docker运行时环境\n如果你不知道如何安装docker，请参考我对此的收集：[http://amao12580.github.io/index/](http://amao12580.github.io/index/)\n```\nroot@ubuntu-14:~/docker/test# docker-compose version\ndocker-compose version 1.7.0, build 0d7bf73\ndocker-py version: 1.8.0\nCPython version: 2.7.9\nOpenSSL version: OpenSSL 1.0.1e 11 Feb 2013\n\n\nroot@ubuntu-14:~/docker/test# docker version\nClient:\n Version:      1.9.1\n API version:  1.21\n Go version:   go1.4.3\n Git commit:   a34a1d5\n Built:        Fri Nov 20 17:56:04 UTC 2015\n OS/Arch:      linux/amd64\n\nServer:\n Version:      1.9.1\n API version:  1.21\n Go version:   go1.4.3\n Git commit:   a34a1d5\n Built:        Fri Nov 20 17:56:04 UTC 2015\n OS/Arch:      linux/amd64\n```\n\n# FROM centos:6.7\n我的目录结构看起来是这样：\n```\nroot@ubuntu-14:~# pwd\n/root\nroot@ubuntu-14:~# tree\n.\n└── docker\n    └── test\n        ├── docker-compose.yml\n        └── nginx\n            ├── conf\n            │   └── nginx.conf\n            ├── Dockerfile\n            ├── html\n            │   └── test_xw.html\n            ├── logs\n            │   ├── error.log\n            │   ├── nginx.pid\n            │   └── xws.access.log\n            ├── ssl\n            │   ├── www.xw18.cn.crt(已经移除，涉及到机密)\n            │   └── www.xw18.cn.key(已经移除，涉及到机密)\n            └── static\n                ├── apk\n                ├── css\n                ├── img\n                │   └── photo.jpg\n                └── js\n\n12 directories, 10 files\n```\n想要在shell中打印文件目录结构，请安装“tree”：aptitude install -y tree\n请确保你的当前用户对这些目录具备必要的权限，下面一起看看docker-compose.yml文件吧。\n\n```\nroot@ubuntu-14:~/docker/test# cat docker-compose.yml\nnginx:\n  build: ./nginx\n  mem_limit: 4294967296\n  cpu_shares: 2\n  ports:\n    - \"80:80\"\n    - \"443:443\"\n  volumes:\n    - ./nginx/conf/nginx.conf:/usr/local/nginx/conf/nginx.conf\n    - ./nginx/html:/usr/local/nginx/html\n    - ./nginx/static:/usr/local/nginx/static\n    - ./nginx/ssl:/usr/local/nginx/ssl\n    - ./nginx/logs:/usr/local/nginx/logs:rw\n```\n\n是不是看起来很简单呢？因为我们在docker-compose里定义的是服务的运行环境要求，并没有定义如何构建这个服务。\n\n想看如何构建nginx,那一起来看看Dockerfile文件吧，这个文件就是如何一步步的构建服务的，如果有合适的image，你可以在Dockerfile里定义执行任何可以在宿主机环境下执行的命令哦。是不是很magic呢？\n```\nroot@ubuntu-14:~/docker/test/nginx# cat Dockerfile\n#定义基础镜像\nFROM centos:6.7\n\n#定义nginx版本\nENV NGINX_VERSION 1.9.14\n\n#准备安装环境\nRUN yum install -y wget && \\\nwget -O /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-6.repo  && \\\nyum clean all  && \\\nyum makecache && \\\n\n#安装依赖组件\nrpm --import /etc/pki/rpm-gpg/RPM-GPG-KEY-CentOS-* && \\\nyum install -y epel-release && \\\nrpm --import /etc/pki/rpm-gpg/RPM-GPG-KEY-EPEL-6 && \\\nyum install -y patch pcre-devel openssl-devel zlib-devel gd-devel tar gcc git supervisor && \\\n\n#下载安装包和补丁\nmkdir -p /var/run/nginx/ && \\\nwget -c http://nginx.org/download/nginx-${NGINX_VERSION}.tar.gz && \\\ngit clone https://github.com/cuber/ngx_http_google_filter_module.git && \\\ngit clone https://github.com/yaoweibin/ngx_http_substitutions_filter_module.git && \\\ngit clone https://github.com/aperezdc/ngx-fancyindex.git && \\\ngit clone https://github.com/yaoweibin/nginx_upstream_check_module.git && \\\n\n#进行编译安装，同时打上补丁\ntar xf nginx-${NGINX_VERSION}.tar.gz && \\\ncd nginx-${NGINX_VERSION} && \\\ncd src/ && \\\n#打补丁\npatch -p1 < /nginx_upstream_check_module/check_1.9.2+.patch && \\\ncd .. && \\\n#去除nginx的对外版本号\nsed -i -e 's/${NGINX_VERSION}//g' -e 's/nginx\\//ERROR/g' -e 's/\"NGINX\"/\"ERROR\"/g' src/core/nginx.h  && \\\n./configure --prefix=/usr/local/nginx \\\n--with-pcre \\\n--with-ipv6 \\\n--with-http_ssl_module \\\n--with-http_flv_module \\\n--with-http_v2_module \\\n--with-http_realip_module \\\n--with-http_gzip_static_module \\\n--with-http_stub_status_module \\\n--with-http_mp4_module \\\n--with-http_image_filter_module \\\n--with-http_addition_module \\\n--with-http_sub_module  \\\n--with-http_dav_module  \\\n--http-client-body-temp-path=/usr/local/nginx/client/ \\\n--http-proxy-temp-path=/usr/local/nginx/proxy/ \\\n--http-fastcgi-temp-path=/usr/local/nginx/fcgi/ \\\n--http-uwsgi-temp-path=/usr/local/nginx/uwsgi \\\n--http-scgi-temp-path=/usr/local/nginx/scgi \\\n--add-module=../ngx_http_google_filter_module \\\n--add-module=../ngx_http_substitutions_filter_module \\\n--add-module=../ngx-fancyindex \\\n--add-module=../nginx_upstream_check_module && \\\n#开始编译\nmake -j $(awk '/processor/{i++}END{print i}' /proc/cpuinfo) && make install && \\\n#设置一些工作目录\nmkdir -p /usr/local/nginx/cache/ && \\\nmkdir -p /usr/local/nginx/temp/ && \\\nrm -rf ../{ngx*,nginx*} && \\\nyum clean packages\n\n#启动nginx，保留一个前台进程，以免被docker强制退出\nCMD ./usr/local/nginx/sbin/nginx && tail -f /usr/local/nginx/logs/error.log\n```\n\n是不是感觉内容太多了呢？每一步都有说明的，为了节省磁盘空间，我们将很多命令聚合到了一起。\n事实上确实减少了一部分的磁盘占用，我们来看看现在build出来的镜像有多大吧。\n```\nroot@ubuntu-14:~/docker/test# pwd\n/root/docker/test\nroot@ubuntu-14:~/docker/test# ls\ndocker-compose.yml  nginx\n\n这里开始进行构建、启动并在后台保持运行\nroot@ubuntu-14:~/docker/test# docker-compose up -d nginx\n后面的内容实在是太多了，就不贴出来了。如果你的网络环境很差，这个过程会很漫长。\n\n已经成功运行了，test一下\nroot@ubuntu-14:~/docker/test# curl http://192.168.2.200/test_xw.html\n<html>\n<body>\n<h2>Hello World! xw.</h2>\n<h2>这是测试内容.</h2>\n</body>\n\n容器运行后，nginx会处于listener状态，我们来看看images有多大\nroot@ubuntu-14:~/docker/test# docker images\nREPOSITORY          TAG                 IMAGE ID            CREATED             VIRTUAL SIZE\ntest_nginx          latest              e50ecf326484        2 hours ago         986.3 MB\n```\n\n将近1个GB了，虽然说可以使用docker export -gzip 来压缩，并结合docker import命令直接导入，但是这个体积还是太肥大了，不利于轻量化运行和传播，我们来想想办法来减减肥吧。\n# FROM alpine:3.3\n\nAlpine Linux，一个只有5M的Docker镜像。\n\nAlpine Linux Docker镜像基于Alpine Linux操作系统，后者是一个面向安全的轻型Linux发行版。不同于通常Linux发行版，Alpine Linux采用了musl libc和busybox以减小系统的体积和运行时资源消耗。在保持瘦身的同时，Alpine Linux还提供了自己的包管理工具apk，可以在其网站上查询，或者直接通过apk命令查询和安装。\n\nAlpine Linux Docker镜像也继承了Alpine Linux发行版的这些优势。相比于其他Docker镜像，它的容量非常小，仅仅只有5M，且拥有非常友好的包管理器。\n\n可以直接使用的DockerFile：\n\n```\n#说明：因为我所在的网络环境非常差，所以将很多需要下载的Step单独用RUN定义了，以免每次网络连不上而重复下载。如果你的网络环境OK，可以考虑合并多个RUN,以进一步减少imags的大小\n\n#定义基础镜像\nFROM alpine:latest\n\n#定义nginx版本\nENV NGINX_VERSION 1.9.14\n\n#将安装源切换为国内环境(中国科学技术大学)，大大加快了安装速度，同时稳定性也有了保障\nENV MIRROR_URL http://mirrors.ustc.edu.cn/alpine/\n\nENV MIRROR_URL_BACKUP http://alpine.gliderlabs.com/alpine/\n\nENV MIRROR_URL_SLOWEST http://dl-cdn.alpinelinux.org/alpine/\n\n#准备安装环境\nRUN echo '' > /etc/apk/repositories && \\\n    echo \"${MIRROR_URL}v3.3//main\"     >> /etc/apk/repositories && \\\n    echo \"${MIRROR_URL}v3.3//community\" >> /etc/apk/repositories && \\\n    echo '185.31.17.249 github.com' >> /etc/hosts && \\\n    echo '202.141.160.110 mirrors.ustc.edu.cn' >> /etc/hosts && \\\n    echo '206.251.255.63 nginx.org' >> /etc/hosts\n\n#安装必要的组件(如果发生  ERROR: Service 'nginx' failed to build: The command '/bin/sh -c apk add... returned a non-zero code: 12。  这是网络问题：请删干净未完成container和images，10分钟后再来一遍)\nRUN apk add --no-cache --virtual .build-deps \\\n    gcc \\\n    libc-dev \\\n    make \\\n    openssl-dev \\\n    pcre-dev \\\n    zlib-dev \\\n    linux-headers \\\n    curl \\\n    jemalloc-dev \\\n    gd-dev \\\n    git\n#下载安装包和补丁\nRUN mkdir -p /var/run/nginx/\nRUN wget -c http://nginx.org/download/nginx-${NGINX_VERSION}.tar.gz\nRUN git clone https://github.com/cuber/ngx_http_google_filter_module.git\nRUN git clone https://github.com/yaoweibin/ngx_http_substitutions_filter_module.git\nRUN git clone https://github.com/aperezdc/ngx-fancyindex.git\nRUN git clone https://github.com/yaoweibin/nginx_upstream_check_module.git\n\n#进行编译安装，同时打上补丁\nRUN tar -xzvf nginx-${NGINX_VERSION}.tar.gz && \\\ncd nginx-${NGINX_VERSION} && \\\ncd src/ && \\\n#打补丁\npatch -p1 < /nginx_upstream_check_module/check_1.9.2+.patch && \\\ncd .. && \\\n#去除nginx的对外版本号\nsed -i -e 's/${NGINX_VERSION}//g' -e 's/nginx\\//ERROR/g' -e 's/\"NGINX\"/\"ERROR\"/g' src/core/nginx.h  && \\\n./configure --prefix=/usr/local/nginx \\\n--with-pcre \\\n--with-ipv6 \\\n--with-http_ssl_module \\\n--with-http_flv_module \\\n--with-http_v2_module \\\n--with-http_realip_module \\\n--with-http_gzip_static_module \\\n--with-http_stub_status_module \\\n--with-http_mp4_module \\\n--with-http_image_filter_module \\\n--with-http_addition_module \\\n--with-http_sub_module  \\\n--with-http_dav_module  \\\n--http-client-body-temp-path=/usr/local/nginx/client/ \\\n--http-proxy-temp-path=/usr/local/nginx/proxy/ \\\n--http-fastcgi-temp-path=/usr/local/nginx/fcgi/ \\\n--http-uwsgi-temp-path=/usr/local/nginx/uwsgi \\\n--http-scgi-temp-path=/usr/local/nginx/scgi \\\n--add-module=../ngx_http_google_filter_module \\\n--add-module=../ngx_http_substitutions_filter_module \\\n--add-module=../ngx-fancyindex \\\n--add-module=../nginx_upstream_check_module \\\n--with-ld-opt=\"-ljemalloc\" && \\\n#开始编译\nmake -j $(awk '/processor/{i++}END{print i}' /proc/cpuinfo) && make install && \\\n\n#设置一些工作目录\nmkdir -p /usr/local/nginx/cache/ && \\\nmkdir -p /usr/local/nginx/temp/ && \\\nrm -rf ../{ngx*,nginx*}\n\n#启动nginx，保留一个前台进程，以免被docker强制退出\nCMD ./usr/local/nginx/sbin/nginx && tail -f /usr/local/nginx/logs/error.log\n```\n\n看看我们最后基于alpine的镜像大小是多少？\n```\nroot@ubuntu-14:~/docker/alpine# docker images\nREPOSITORY          TAG                 IMAGE ID            CREATED             VIRTUAL SIZE\nalpine_nginx        latest              81b30220a198        3 minutes ago       167.3 MB\n```\n\n不到200MB，成功瘦身80%。合并一些RUN定义，提及还可以更小的。\n\n我们现在做了2个版本的nginx编译增强镜像，来看看最后的文件目录吧！\n\n```\nroot@ubuntu-14:~# pwd\n/root\nroot@ubuntu-14:~# tree\n.\n└── docker\n    ├── alpine\n    │   ├── docker-compose.yml\n    │   └── nginx\n    │       ├── conf\n    │       │   └── nginx.conf\n    │       ├── Dockerfile\n    │       ├── html\n    │       │   └── test_xw.html\n    │       ├── logs\n    │       │   ├── error.log\n    │       │   ├── nginx.pid\n    │       │   └── xws.access.log\n    │       ├── ssl\n    │       │   ├── www.xw18.cn.crt\n    │       │   └── www.xw18.cn.key\n    │       └── static\n    │           ├── apk\n    │           ├── css\n    │           ├── img\n    │           │   ├── 50.jpg\n    │           │   └── photo.jpg\n    │           └── js\n    └── test\n        ├── docker-compose.yml\n        └── nginx\n            ├── conf\n            │   └── nginx.conf\n            ├── Dockerfile\n            ├── html\n            │   └── test_xw.html\n            ├── logs\n            │   ├── error.log\n            │   ├── nginx.pid\n            │   └── xws.access.log\n            ├── ssl\n            │   ├── www.xw18.cn.crt\n            │   └── www.xw18.cn.key\n            └── static\n                ├── apk\n                ├── css\n                ├── img\n                │   ├── 50.jpg\n                │   └── photo.jpg\n                └── js\n\n23 directories, 22 files\n```\n\n参考资料：[http://dockone.io/article/1243?utm_source=tuicool&utm_medium=referral](http://dockone.io/article/1243?utm_source=tuicool&utm_medium=referral)\n\n# 常用命令总结\n\n* docker进入到正在运行的容器内部\n\ndocker exec -it test_redis_1 /bin/bash\n\n* 运行一个image_id为195eb90b5349的容器，并命名为shell，然后进入到容器内部\n\ndocker run --name shell -i -t 195eb90b5349 /bin/bash\n\n* 运行一个名为alpine的容器，并进入到容器内部\n\ndocker run -it alpine /bin/sh\n\n* docker查看本地image\n\ndocker images\n\n* 重启docker服务\n\nservice docker restart\n\n* 查看所有的容器\n\ndocker ps -a\n\n* 删除多个容器\n\ndocker rm -v id1 id2\n\n* 删除所有容器\n\ndocker rm $(docker ps -a -q)\n\n* 删除多个镜像\n\ndicker rmi id1 id2\n\n* 查询所有未成功build的镜像<none>\n\ndocker images -q -f dangling=true\n\n* 删除所有未成功build的镜像<none>\n\ndocker rmi $(docker images -q -f dangling=true)","source":"_posts/Nginx-with-docker-part-one.md","raw":"---\ntitle: Nginx与Docker容器系列 <01:进行编译安装>\ndate: 2016-04-27 10:47:59\ntags:\n    - Nginx\n    - Alpine\n    - Docker\n    - Centos\n    - Patch\ncategories:\n    - Record\ndescription: Docker容器的出现，为应用运行环境一致性带来了很好的解决方案。同时也带来了远比虚拟机更好的体验，提供资源隔离(Linux namespace)和资源分配(Linux control group)的功能、应用可扩展性的功能，但是更加轻量级的运行。为了解决多容器的依赖性和互相调用，提供了docker-compose等工具进行容器编排。\n---\n# 前言\n\nDocker容器的出现，为应用运行环境一致性带来了很好的解决方案。同时也带来了远比虚拟机更好的体验，提供资源隔离(Linux namespace)和资源分配(Linux control group)的功能、应用可扩展性的功能，但是更加轻量级的运行。为了解决多容器的依赖性和互相调用，提供了docker-compose等工具进行容器编排。\n\n我们项目中，对docker的使用非常深入，在线上环境和线下的测试环境、开发环境，都使用了docker作为运行时环境一致性支持。由于linux的发行版本和内核版本的不同组合，在没有docker之前，DevOps很难为不同的运行环境编写统一的软件安装维护的脚本，几乎只能借助虚拟机来达到这一目的，虚拟机的笨重和可调度性差，扩容与缩容也无法做到快速有效，已经被逐渐淘汰。\n\nNginx，性能已经毋庸置疑，但在docker hub上的nginx镜像，并不适合我们，没有对安全进行加固，更多的没有加入重要的功能增加，比如主动式地对后端Tomcat进行健康检查并自动failover，这个动能对HA的非常重要的，因此我们选择了在docker环境下，对官方nginx源码进行编译，并打上补丁，以符合实际生产环境的使用。\n\n本文中的配置文件，已经整理到了GitHub：[https://github.com/amao12580/docker](https://github.com/amao12580/docker)\n\n本文假设读者对Nginx、Docker已经有了比较深入的了解，并掌握了docker-compose工具的使用。\n\n# 安装环境\n## 宿主机的情况\n\n### 操作系统和硬件\n```\n操作系统\nroot@ubuntu-14:~/docker/test# uname -a\nLinux ubuntu-14 4.2.0-35-generic #40~14.04.1-Ubuntu SMP Fri Mar 18 16:37:35 UTC 2016 x86_64 x86_64 x86_64 GNU/Linux\n\nCPU\nroot@ubuntu-14:~/docker/test# lscpu\nArchitecture:          x86_64\nCPU op-mode(s):        32-bit, 64-bit\nByte Order:            Little Endian\nCPU(s):                4\nOn-line CPU(s) list:   0-3\nThread(s) per core:    1\nCore(s) per socket:    4\nSocket(s):             1\nNUMA node(s):          1\nVendor ID:             GenuineIntel\nCPU family:            6\nModel:                 58\nStepping:              9\nCPU MHz:               1600.125\nBogoMIPS:              6385.87\nVirtualization:        VT-x\nL1d cache:             32K\nL1i cache:             32K\nL2 cache:              256K\nL3 cache:              6144K\n\nMemory\nroot@ubuntu-14:~/docker/test# free -m\n             total       used       free     shared    buffers     cached\nMem:          7881       4751       3130          1        419       3810\n-/+ buffers/cache:        520       7360\nSwap:         8087          0       8087\n```\n\n### docker运行时环境\n如果你不知道如何安装docker，请参考我对此的收集：[http://amao12580.github.io/index/](http://amao12580.github.io/index/)\n```\nroot@ubuntu-14:~/docker/test# docker-compose version\ndocker-compose version 1.7.0, build 0d7bf73\ndocker-py version: 1.8.0\nCPython version: 2.7.9\nOpenSSL version: OpenSSL 1.0.1e 11 Feb 2013\n\n\nroot@ubuntu-14:~/docker/test# docker version\nClient:\n Version:      1.9.1\n API version:  1.21\n Go version:   go1.4.3\n Git commit:   a34a1d5\n Built:        Fri Nov 20 17:56:04 UTC 2015\n OS/Arch:      linux/amd64\n\nServer:\n Version:      1.9.1\n API version:  1.21\n Go version:   go1.4.3\n Git commit:   a34a1d5\n Built:        Fri Nov 20 17:56:04 UTC 2015\n OS/Arch:      linux/amd64\n```\n\n# FROM centos:6.7\n我的目录结构看起来是这样：\n```\nroot@ubuntu-14:~# pwd\n/root\nroot@ubuntu-14:~# tree\n.\n└── docker\n    └── test\n        ├── docker-compose.yml\n        └── nginx\n            ├── conf\n            │   └── nginx.conf\n            ├── Dockerfile\n            ├── html\n            │   └── test_xw.html\n            ├── logs\n            │   ├── error.log\n            │   ├── nginx.pid\n            │   └── xws.access.log\n            ├── ssl\n            │   ├── www.xw18.cn.crt(已经移除，涉及到机密)\n            │   └── www.xw18.cn.key(已经移除，涉及到机密)\n            └── static\n                ├── apk\n                ├── css\n                ├── img\n                │   └── photo.jpg\n                └── js\n\n12 directories, 10 files\n```\n想要在shell中打印文件目录结构，请安装“tree”：aptitude install -y tree\n请确保你的当前用户对这些目录具备必要的权限，下面一起看看docker-compose.yml文件吧。\n\n```\nroot@ubuntu-14:~/docker/test# cat docker-compose.yml\nnginx:\n  build: ./nginx\n  mem_limit: 4294967296\n  cpu_shares: 2\n  ports:\n    - \"80:80\"\n    - \"443:443\"\n  volumes:\n    - ./nginx/conf/nginx.conf:/usr/local/nginx/conf/nginx.conf\n    - ./nginx/html:/usr/local/nginx/html\n    - ./nginx/static:/usr/local/nginx/static\n    - ./nginx/ssl:/usr/local/nginx/ssl\n    - ./nginx/logs:/usr/local/nginx/logs:rw\n```\n\n是不是看起来很简单呢？因为我们在docker-compose里定义的是服务的运行环境要求，并没有定义如何构建这个服务。\n\n想看如何构建nginx,那一起来看看Dockerfile文件吧，这个文件就是如何一步步的构建服务的，如果有合适的image，你可以在Dockerfile里定义执行任何可以在宿主机环境下执行的命令哦。是不是很magic呢？\n```\nroot@ubuntu-14:~/docker/test/nginx# cat Dockerfile\n#定义基础镜像\nFROM centos:6.7\n\n#定义nginx版本\nENV NGINX_VERSION 1.9.14\n\n#准备安装环境\nRUN yum install -y wget && \\\nwget -O /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-6.repo  && \\\nyum clean all  && \\\nyum makecache && \\\n\n#安装依赖组件\nrpm --import /etc/pki/rpm-gpg/RPM-GPG-KEY-CentOS-* && \\\nyum install -y epel-release && \\\nrpm --import /etc/pki/rpm-gpg/RPM-GPG-KEY-EPEL-6 && \\\nyum install -y patch pcre-devel openssl-devel zlib-devel gd-devel tar gcc git supervisor && \\\n\n#下载安装包和补丁\nmkdir -p /var/run/nginx/ && \\\nwget -c http://nginx.org/download/nginx-${NGINX_VERSION}.tar.gz && \\\ngit clone https://github.com/cuber/ngx_http_google_filter_module.git && \\\ngit clone https://github.com/yaoweibin/ngx_http_substitutions_filter_module.git && \\\ngit clone https://github.com/aperezdc/ngx-fancyindex.git && \\\ngit clone https://github.com/yaoweibin/nginx_upstream_check_module.git && \\\n\n#进行编译安装，同时打上补丁\ntar xf nginx-${NGINX_VERSION}.tar.gz && \\\ncd nginx-${NGINX_VERSION} && \\\ncd src/ && \\\n#打补丁\npatch -p1 < /nginx_upstream_check_module/check_1.9.2+.patch && \\\ncd .. && \\\n#去除nginx的对外版本号\nsed -i -e 's/${NGINX_VERSION}//g' -e 's/nginx\\//ERROR/g' -e 's/\"NGINX\"/\"ERROR\"/g' src/core/nginx.h  && \\\n./configure --prefix=/usr/local/nginx \\\n--with-pcre \\\n--with-ipv6 \\\n--with-http_ssl_module \\\n--with-http_flv_module \\\n--with-http_v2_module \\\n--with-http_realip_module \\\n--with-http_gzip_static_module \\\n--with-http_stub_status_module \\\n--with-http_mp4_module \\\n--with-http_image_filter_module \\\n--with-http_addition_module \\\n--with-http_sub_module  \\\n--with-http_dav_module  \\\n--http-client-body-temp-path=/usr/local/nginx/client/ \\\n--http-proxy-temp-path=/usr/local/nginx/proxy/ \\\n--http-fastcgi-temp-path=/usr/local/nginx/fcgi/ \\\n--http-uwsgi-temp-path=/usr/local/nginx/uwsgi \\\n--http-scgi-temp-path=/usr/local/nginx/scgi \\\n--add-module=../ngx_http_google_filter_module \\\n--add-module=../ngx_http_substitutions_filter_module \\\n--add-module=../ngx-fancyindex \\\n--add-module=../nginx_upstream_check_module && \\\n#开始编译\nmake -j $(awk '/processor/{i++}END{print i}' /proc/cpuinfo) && make install && \\\n#设置一些工作目录\nmkdir -p /usr/local/nginx/cache/ && \\\nmkdir -p /usr/local/nginx/temp/ && \\\nrm -rf ../{ngx*,nginx*} && \\\nyum clean packages\n\n#启动nginx，保留一个前台进程，以免被docker强制退出\nCMD ./usr/local/nginx/sbin/nginx && tail -f /usr/local/nginx/logs/error.log\n```\n\n是不是感觉内容太多了呢？每一步都有说明的，为了节省磁盘空间，我们将很多命令聚合到了一起。\n事实上确实减少了一部分的磁盘占用，我们来看看现在build出来的镜像有多大吧。\n```\nroot@ubuntu-14:~/docker/test# pwd\n/root/docker/test\nroot@ubuntu-14:~/docker/test# ls\ndocker-compose.yml  nginx\n\n这里开始进行构建、启动并在后台保持运行\nroot@ubuntu-14:~/docker/test# docker-compose up -d nginx\n后面的内容实在是太多了，就不贴出来了。如果你的网络环境很差，这个过程会很漫长。\n\n已经成功运行了，test一下\nroot@ubuntu-14:~/docker/test# curl http://192.168.2.200/test_xw.html\n<html>\n<body>\n<h2>Hello World! xw.</h2>\n<h2>这是测试内容.</h2>\n</body>\n\n容器运行后，nginx会处于listener状态，我们来看看images有多大\nroot@ubuntu-14:~/docker/test# docker images\nREPOSITORY          TAG                 IMAGE ID            CREATED             VIRTUAL SIZE\ntest_nginx          latest              e50ecf326484        2 hours ago         986.3 MB\n```\n\n将近1个GB了，虽然说可以使用docker export -gzip 来压缩，并结合docker import命令直接导入，但是这个体积还是太肥大了，不利于轻量化运行和传播，我们来想想办法来减减肥吧。\n# FROM alpine:3.3\n\nAlpine Linux，一个只有5M的Docker镜像。\n\nAlpine Linux Docker镜像基于Alpine Linux操作系统，后者是一个面向安全的轻型Linux发行版。不同于通常Linux发行版，Alpine Linux采用了musl libc和busybox以减小系统的体积和运行时资源消耗。在保持瘦身的同时，Alpine Linux还提供了自己的包管理工具apk，可以在其网站上查询，或者直接通过apk命令查询和安装。\n\nAlpine Linux Docker镜像也继承了Alpine Linux发行版的这些优势。相比于其他Docker镜像，它的容量非常小，仅仅只有5M，且拥有非常友好的包管理器。\n\n可以直接使用的DockerFile：\n\n```\n#说明：因为我所在的网络环境非常差，所以将很多需要下载的Step单独用RUN定义了，以免每次网络连不上而重复下载。如果你的网络环境OK，可以考虑合并多个RUN,以进一步减少imags的大小\n\n#定义基础镜像\nFROM alpine:latest\n\n#定义nginx版本\nENV NGINX_VERSION 1.9.14\n\n#将安装源切换为国内环境(中国科学技术大学)，大大加快了安装速度，同时稳定性也有了保障\nENV MIRROR_URL http://mirrors.ustc.edu.cn/alpine/\n\nENV MIRROR_URL_BACKUP http://alpine.gliderlabs.com/alpine/\n\nENV MIRROR_URL_SLOWEST http://dl-cdn.alpinelinux.org/alpine/\n\n#准备安装环境\nRUN echo '' > /etc/apk/repositories && \\\n    echo \"${MIRROR_URL}v3.3//main\"     >> /etc/apk/repositories && \\\n    echo \"${MIRROR_URL}v3.3//community\" >> /etc/apk/repositories && \\\n    echo '185.31.17.249 github.com' >> /etc/hosts && \\\n    echo '202.141.160.110 mirrors.ustc.edu.cn' >> /etc/hosts && \\\n    echo '206.251.255.63 nginx.org' >> /etc/hosts\n\n#安装必要的组件(如果发生  ERROR: Service 'nginx' failed to build: The command '/bin/sh -c apk add... returned a non-zero code: 12。  这是网络问题：请删干净未完成container和images，10分钟后再来一遍)\nRUN apk add --no-cache --virtual .build-deps \\\n    gcc \\\n    libc-dev \\\n    make \\\n    openssl-dev \\\n    pcre-dev \\\n    zlib-dev \\\n    linux-headers \\\n    curl \\\n    jemalloc-dev \\\n    gd-dev \\\n    git\n#下载安装包和补丁\nRUN mkdir -p /var/run/nginx/\nRUN wget -c http://nginx.org/download/nginx-${NGINX_VERSION}.tar.gz\nRUN git clone https://github.com/cuber/ngx_http_google_filter_module.git\nRUN git clone https://github.com/yaoweibin/ngx_http_substitutions_filter_module.git\nRUN git clone https://github.com/aperezdc/ngx-fancyindex.git\nRUN git clone https://github.com/yaoweibin/nginx_upstream_check_module.git\n\n#进行编译安装，同时打上补丁\nRUN tar -xzvf nginx-${NGINX_VERSION}.tar.gz && \\\ncd nginx-${NGINX_VERSION} && \\\ncd src/ && \\\n#打补丁\npatch -p1 < /nginx_upstream_check_module/check_1.9.2+.patch && \\\ncd .. && \\\n#去除nginx的对外版本号\nsed -i -e 's/${NGINX_VERSION}//g' -e 's/nginx\\//ERROR/g' -e 's/\"NGINX\"/\"ERROR\"/g' src/core/nginx.h  && \\\n./configure --prefix=/usr/local/nginx \\\n--with-pcre \\\n--with-ipv6 \\\n--with-http_ssl_module \\\n--with-http_flv_module \\\n--with-http_v2_module \\\n--with-http_realip_module \\\n--with-http_gzip_static_module \\\n--with-http_stub_status_module \\\n--with-http_mp4_module \\\n--with-http_image_filter_module \\\n--with-http_addition_module \\\n--with-http_sub_module  \\\n--with-http_dav_module  \\\n--http-client-body-temp-path=/usr/local/nginx/client/ \\\n--http-proxy-temp-path=/usr/local/nginx/proxy/ \\\n--http-fastcgi-temp-path=/usr/local/nginx/fcgi/ \\\n--http-uwsgi-temp-path=/usr/local/nginx/uwsgi \\\n--http-scgi-temp-path=/usr/local/nginx/scgi \\\n--add-module=../ngx_http_google_filter_module \\\n--add-module=../ngx_http_substitutions_filter_module \\\n--add-module=../ngx-fancyindex \\\n--add-module=../nginx_upstream_check_module \\\n--with-ld-opt=\"-ljemalloc\" && \\\n#开始编译\nmake -j $(awk '/processor/{i++}END{print i}' /proc/cpuinfo) && make install && \\\n\n#设置一些工作目录\nmkdir -p /usr/local/nginx/cache/ && \\\nmkdir -p /usr/local/nginx/temp/ && \\\nrm -rf ../{ngx*,nginx*}\n\n#启动nginx，保留一个前台进程，以免被docker强制退出\nCMD ./usr/local/nginx/sbin/nginx && tail -f /usr/local/nginx/logs/error.log\n```\n\n看看我们最后基于alpine的镜像大小是多少？\n```\nroot@ubuntu-14:~/docker/alpine# docker images\nREPOSITORY          TAG                 IMAGE ID            CREATED             VIRTUAL SIZE\nalpine_nginx        latest              81b30220a198        3 minutes ago       167.3 MB\n```\n\n不到200MB，成功瘦身80%。合并一些RUN定义，提及还可以更小的。\n\n我们现在做了2个版本的nginx编译增强镜像，来看看最后的文件目录吧！\n\n```\nroot@ubuntu-14:~# pwd\n/root\nroot@ubuntu-14:~# tree\n.\n└── docker\n    ├── alpine\n    │   ├── docker-compose.yml\n    │   └── nginx\n    │       ├── conf\n    │       │   └── nginx.conf\n    │       ├── Dockerfile\n    │       ├── html\n    │       │   └── test_xw.html\n    │       ├── logs\n    │       │   ├── error.log\n    │       │   ├── nginx.pid\n    │       │   └── xws.access.log\n    │       ├── ssl\n    │       │   ├── www.xw18.cn.crt\n    │       │   └── www.xw18.cn.key\n    │       └── static\n    │           ├── apk\n    │           ├── css\n    │           ├── img\n    │           │   ├── 50.jpg\n    │           │   └── photo.jpg\n    │           └── js\n    └── test\n        ├── docker-compose.yml\n        └── nginx\n            ├── conf\n            │   └── nginx.conf\n            ├── Dockerfile\n            ├── html\n            │   └── test_xw.html\n            ├── logs\n            │   ├── error.log\n            │   ├── nginx.pid\n            │   └── xws.access.log\n            ├── ssl\n            │   ├── www.xw18.cn.crt\n            │   └── www.xw18.cn.key\n            └── static\n                ├── apk\n                ├── css\n                ├── img\n                │   ├── 50.jpg\n                │   └── photo.jpg\n                └── js\n\n23 directories, 22 files\n```\n\n参考资料：[http://dockone.io/article/1243?utm_source=tuicool&utm_medium=referral](http://dockone.io/article/1243?utm_source=tuicool&utm_medium=referral)\n\n# 常用命令总结\n\n* docker进入到正在运行的容器内部\n\ndocker exec -it test_redis_1 /bin/bash\n\n* 运行一个image_id为195eb90b5349的容器，并命名为shell，然后进入到容器内部\n\ndocker run --name shell -i -t 195eb90b5349 /bin/bash\n\n* 运行一个名为alpine的容器，并进入到容器内部\n\ndocker run -it alpine /bin/sh\n\n* docker查看本地image\n\ndocker images\n\n* 重启docker服务\n\nservice docker restart\n\n* 查看所有的容器\n\ndocker ps -a\n\n* 删除多个容器\n\ndocker rm -v id1 id2\n\n* 删除所有容器\n\ndocker rm $(docker ps -a -q)\n\n* 删除多个镜像\n\ndicker rmi id1 id2\n\n* 查询所有未成功build的镜像<none>\n\ndocker images -q -f dangling=true\n\n* 删除所有未成功build的镜像<none>\n\ndocker rmi $(docker images -q -f dangling=true)","slug":"Nginx-with-docker-part-one","published":1,"updated":"2016-05-03T02:06:30.043Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ciowq3yua00074cnnaq8ub01n","content":"<h1 id=\"前言\"><a href=\"#前言\" class=\"headerlink\" title=\"前言\"></a>前言</h1><p>Docker容器的出现，为应用运行环境一致性带来了很好的解决方案。同时也带来了远比虚拟机更好的体验，提供资源隔离(Linux namespace)和资源分配(Linux control group)的功能、应用可扩展性的功能，但是更加轻量级的运行。为了解决多容器的依赖性和互相调用，提供了docker-compose等工具进行容器编排。</p>\n<p>我们项目中，对docker的使用非常深入，在线上环境和线下的测试环境、开发环境，都使用了docker作为运行时环境一致性支持。由于linux的发行版本和内核版本的不同组合，在没有docker之前，DevOps很难为不同的运行环境编写统一的软件安装维护的脚本，几乎只能借助虚拟机来达到这一目的，虚拟机的笨重和可调度性差，扩容与缩容也无法做到快速有效，已经被逐渐淘汰。</p>\n<p>Nginx，性能已经毋庸置疑，但在docker hub上的nginx镜像，并不适合我们，没有对安全进行加固，更多的没有加入重要的功能增加，比如主动式地对后端Tomcat进行健康检查并自动failover，这个动能对HA的非常重要的，因此我们选择了在docker环境下，对官方nginx源码进行编译，并打上补丁，以符合实际生产环境的使用。</p>\n<p>本文中的配置文件，已经整理到了GitHub：<a href=\"https://github.com/amao12580/docker\" target=\"_blank\" rel=\"external\">https://github.com/amao12580/docker</a></p>\n<p>本文假设读者对Nginx、Docker已经有了比较深入的了解，并掌握了docker-compose工具的使用。</p>\n<h1 id=\"安装环境\"><a href=\"#安装环境\" class=\"headerlink\" title=\"安装环境\"></a>安装环境</h1><h2 id=\"宿主机的情况\"><a href=\"#宿主机的情况\" class=\"headerlink\" title=\"宿主机的情况\"></a>宿主机的情况</h2><h3 id=\"操作系统和硬件\"><a href=\"#操作系统和硬件\" class=\"headerlink\" title=\"操作系统和硬件\"></a>操作系统和硬件</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">操作系统</span><br><span class=\"line\">root@ubuntu-14:~/docker/test# uname -a</span><br><span class=\"line\">Linux ubuntu-14 4.2.0-35-generic #40~14.04.1-Ubuntu SMP Fri Mar 18 16:37:35 UTC 2016 x86_64 x86_64 x86_64 GNU/Linux</span><br><span class=\"line\"></span><br><span class=\"line\">CPU</span><br><span class=\"line\">root@ubuntu-14:~/docker/test# lscpu</span><br><span class=\"line\">Architecture:          x86_64</span><br><span class=\"line\">CPU op-mode(s):        32-bit, 64-bit</span><br><span class=\"line\">Byte Order:            Little Endian</span><br><span class=\"line\">CPU(s):                4</span><br><span class=\"line\">On-line CPU(s) list:   0-3</span><br><span class=\"line\">Thread(s) per core:    1</span><br><span class=\"line\">Core(s) per socket:    4</span><br><span class=\"line\">Socket(s):             1</span><br><span class=\"line\">NUMA node(s):          1</span><br><span class=\"line\">Vendor ID:             GenuineIntel</span><br><span class=\"line\">CPU family:            6</span><br><span class=\"line\">Model:                 58</span><br><span class=\"line\">Stepping:              9</span><br><span class=\"line\">CPU MHz:               1600.125</span><br><span class=\"line\">BogoMIPS:              6385.87</span><br><span class=\"line\">Virtualization:        VT-x</span><br><span class=\"line\">L1d cache:             32K</span><br><span class=\"line\">L1i cache:             32K</span><br><span class=\"line\">L2 cache:              256K</span><br><span class=\"line\">L3 cache:              6144K</span><br><span class=\"line\"></span><br><span class=\"line\">Memory</span><br><span class=\"line\">root@ubuntu-14:~/docker/test# free -m</span><br><span class=\"line\">             total       used       free     shared    buffers     cached</span><br><span class=\"line\">Mem:          7881       4751       3130          1        419       3810</span><br><span class=\"line\">-/+ buffers/cache:        520       7360</span><br><span class=\"line\">Swap:         8087          0       8087</span><br></pre></td></tr></table></figure>\n<h3 id=\"docker运行时环境\"><a href=\"#docker运行时环境\" class=\"headerlink\" title=\"docker运行时环境\"></a>docker运行时环境</h3><p>如果你不知道如何安装docker，请参考我对此的收集：<a href=\"http://amao12580.github.io/index/\">http://amao12580.github.io/index/</a><br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">root@ubuntu-14:~/docker/test# docker-compose version</span><br><span class=\"line\">docker-compose version 1.7.0, build 0d7bf73</span><br><span class=\"line\">docker-py version: 1.8.0</span><br><span class=\"line\">CPython version: 2.7.9</span><br><span class=\"line\">OpenSSL version: OpenSSL 1.0.1e 11 Feb 2013</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">root@ubuntu-14:~/docker/test# docker version</span><br><span class=\"line\">Client:</span><br><span class=\"line\"> Version:      1.9.1</span><br><span class=\"line\"> API version:  1.21</span><br><span class=\"line\"> Go version:   go1.4.3</span><br><span class=\"line\"> Git commit:   a34a1d5</span><br><span class=\"line\"> Built:        Fri Nov 20 17:56:04 UTC 2015</span><br><span class=\"line\"> OS/Arch:      linux/amd64</span><br><span class=\"line\"></span><br><span class=\"line\">Server:</span><br><span class=\"line\"> Version:      1.9.1</span><br><span class=\"line\"> API version:  1.21</span><br><span class=\"line\"> Go version:   go1.4.3</span><br><span class=\"line\"> Git commit:   a34a1d5</span><br><span class=\"line\"> Built:        Fri Nov 20 17:56:04 UTC 2015</span><br><span class=\"line\"> OS/Arch:      linux/amd64</span><br></pre></td></tr></table></figure></p>\n<h1 id=\"FROM-centos-6-7\"><a href=\"#FROM-centos-6-7\" class=\"headerlink\" title=\"FROM centos:6.7\"></a>FROM centos:6.7</h1><p>我的目录结构看起来是这样：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">root@ubuntu-14:~# pwd</span><br><span class=\"line\">/root</span><br><span class=\"line\">root@ubuntu-14:~# tree</span><br><span class=\"line\">.</span><br><span class=\"line\">└── docker</span><br><span class=\"line\">    └── test</span><br><span class=\"line\">        ├── docker-compose.yml</span><br><span class=\"line\">        └── nginx</span><br><span class=\"line\">            ├── conf</span><br><span class=\"line\">            │   └── nginx.conf</span><br><span class=\"line\">            ├── Dockerfile</span><br><span class=\"line\">            ├── html</span><br><span class=\"line\">            │   └── test_xw.html</span><br><span class=\"line\">            ├── logs</span><br><span class=\"line\">            │   ├── error.log</span><br><span class=\"line\">            │   ├── nginx.pid</span><br><span class=\"line\">            │   └── xws.access.log</span><br><span class=\"line\">            ├── ssl</span><br><span class=\"line\">            │   ├── www.xw18.cn.crt(已经移除，涉及到机密)</span><br><span class=\"line\">            │   └── www.xw18.cn.key(已经移除，涉及到机密)</span><br><span class=\"line\">            └── static</span><br><span class=\"line\">                ├── apk</span><br><span class=\"line\">                ├── css</span><br><span class=\"line\">                ├── img</span><br><span class=\"line\">                │   └── photo.jpg</span><br><span class=\"line\">                └── js</span><br><span class=\"line\"></span><br><span class=\"line\">12 directories, 10 files</span><br></pre></td></tr></table></figure></p>\n<p>想要在shell中打印文件目录结构，请安装“tree”：aptitude install -y tree<br>请确保你的当前用户对这些目录具备必要的权限，下面一起看看docker-compose.yml文件吧。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">root@ubuntu-14:~/docker/test# cat docker-compose.yml</span><br><span class=\"line\">nginx:</span><br><span class=\"line\">  build: ./nginx</span><br><span class=\"line\">  mem_limit: 4294967296</span><br><span class=\"line\">  cpu_shares: 2</span><br><span class=\"line\">  ports:</span><br><span class=\"line\">    - &quot;80:80&quot;</span><br><span class=\"line\">    - &quot;443:443&quot;</span><br><span class=\"line\">  volumes:</span><br><span class=\"line\">    - ./nginx/conf/nginx.conf:/usr/local/nginx/conf/nginx.conf</span><br><span class=\"line\">    - ./nginx/html:/usr/local/nginx/html</span><br><span class=\"line\">    - ./nginx/static:/usr/local/nginx/static</span><br><span class=\"line\">    - ./nginx/ssl:/usr/local/nginx/ssl</span><br><span class=\"line\">    - ./nginx/logs:/usr/local/nginx/logs:rw</span><br></pre></td></tr></table></figure>\n<p>是不是看起来很简单呢？因为我们在docker-compose里定义的是服务的运行环境要求，并没有定义如何构建这个服务。</p>\n<p>想看如何构建nginx,那一起来看看Dockerfile文件吧，这个文件就是如何一步步的构建服务的，如果有合适的image，你可以在Dockerfile里定义执行任何可以在宿主机环境下执行的命令哦。是不是很magic呢？<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">root@ubuntu-14:~/docker/test/nginx# cat Dockerfile</span><br><span class=\"line\">#定义基础镜像</span><br><span class=\"line\">FROM centos:6.7</span><br><span class=\"line\"></span><br><span class=\"line\">#定义nginx版本</span><br><span class=\"line\">ENV NGINX_VERSION 1.9.14</span><br><span class=\"line\"></span><br><span class=\"line\">#准备安装环境</span><br><span class=\"line\">RUN yum install -y wget &amp;&amp; \\</span><br><span class=\"line\">wget -O /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-6.repo  &amp;&amp; \\</span><br><span class=\"line\">yum clean all  &amp;&amp; \\</span><br><span class=\"line\">yum makecache &amp;&amp; \\</span><br><span class=\"line\"></span><br><span class=\"line\">#安装依赖组件</span><br><span class=\"line\">rpm --import /etc/pki/rpm-gpg/RPM-GPG-KEY-CentOS-* &amp;&amp; \\</span><br><span class=\"line\">yum install -y epel-release &amp;&amp; \\</span><br><span class=\"line\">rpm --import /etc/pki/rpm-gpg/RPM-GPG-KEY-EPEL-6 &amp;&amp; \\</span><br><span class=\"line\">yum install -y patch pcre-devel openssl-devel zlib-devel gd-devel tar gcc git supervisor &amp;&amp; \\</span><br><span class=\"line\"></span><br><span class=\"line\">#下载安装包和补丁</span><br><span class=\"line\">mkdir -p /var/run/nginx/ &amp;&amp; \\</span><br><span class=\"line\">wget -c http://nginx.org/download/nginx-$&#123;NGINX_VERSION&#125;.tar.gz &amp;&amp; \\</span><br><span class=\"line\">git clone https://github.com/cuber/ngx_http_google_filter_module.git &amp;&amp; \\</span><br><span class=\"line\">git clone https://github.com/yaoweibin/ngx_http_substitutions_filter_module.git &amp;&amp; \\</span><br><span class=\"line\">git clone https://github.com/aperezdc/ngx-fancyindex.git &amp;&amp; \\</span><br><span class=\"line\">git clone https://github.com/yaoweibin/nginx_upstream_check_module.git &amp;&amp; \\</span><br><span class=\"line\"></span><br><span class=\"line\">#进行编译安装，同时打上补丁</span><br><span class=\"line\">tar xf nginx-$&#123;NGINX_VERSION&#125;.tar.gz &amp;&amp; \\</span><br><span class=\"line\">cd nginx-$&#123;NGINX_VERSION&#125; &amp;&amp; \\</span><br><span class=\"line\">cd src/ &amp;&amp; \\</span><br><span class=\"line\">#打补丁</span><br><span class=\"line\">patch -p1 &lt; /nginx_upstream_check_module/check_1.9.2+.patch &amp;&amp; \\</span><br><span class=\"line\">cd .. &amp;&amp; \\</span><br><span class=\"line\">#去除nginx的对外版本号</span><br><span class=\"line\">sed -i -e &apos;s/$&#123;NGINX_VERSION&#125;//g&apos; -e &apos;s/nginx\\//ERROR/g&apos; -e &apos;s/&quot;NGINX&quot;/&quot;ERROR&quot;/g&apos; src/core/nginx.h  &amp;&amp; \\</span><br><span class=\"line\">./configure --prefix=/usr/local/nginx \\</span><br><span class=\"line\">--with-pcre \\</span><br><span class=\"line\">--with-ipv6 \\</span><br><span class=\"line\">--with-http_ssl_module \\</span><br><span class=\"line\">--with-http_flv_module \\</span><br><span class=\"line\">--with-http_v2_module \\</span><br><span class=\"line\">--with-http_realip_module \\</span><br><span class=\"line\">--with-http_gzip_static_module \\</span><br><span class=\"line\">--with-http_stub_status_module \\</span><br><span class=\"line\">--with-http_mp4_module \\</span><br><span class=\"line\">--with-http_image_filter_module \\</span><br><span class=\"line\">--with-http_addition_module \\</span><br><span class=\"line\">--with-http_sub_module  \\</span><br><span class=\"line\">--with-http_dav_module  \\</span><br><span class=\"line\">--http-client-body-temp-path=/usr/local/nginx/client/ \\</span><br><span class=\"line\">--http-proxy-temp-path=/usr/local/nginx/proxy/ \\</span><br><span class=\"line\">--http-fastcgi-temp-path=/usr/local/nginx/fcgi/ \\</span><br><span class=\"line\">--http-uwsgi-temp-path=/usr/local/nginx/uwsgi \\</span><br><span class=\"line\">--http-scgi-temp-path=/usr/local/nginx/scgi \\</span><br><span class=\"line\">--add-module=../ngx_http_google_filter_module \\</span><br><span class=\"line\">--add-module=../ngx_http_substitutions_filter_module \\</span><br><span class=\"line\">--add-module=../ngx-fancyindex \\</span><br><span class=\"line\">--add-module=../nginx_upstream_check_module &amp;&amp; \\</span><br><span class=\"line\">#开始编译</span><br><span class=\"line\">make -j $(awk &apos;/processor/&#123;i++&#125;END&#123;print i&#125;&apos; /proc/cpuinfo) &amp;&amp; make install &amp;&amp; \\</span><br><span class=\"line\">#设置一些工作目录</span><br><span class=\"line\">mkdir -p /usr/local/nginx/cache/ &amp;&amp; \\</span><br><span class=\"line\">mkdir -p /usr/local/nginx/temp/ &amp;&amp; \\</span><br><span class=\"line\">rm -rf ../&#123;ngx*,nginx*&#125; &amp;&amp; \\</span><br><span class=\"line\">yum clean packages</span><br><span class=\"line\"></span><br><span class=\"line\">#启动nginx，保留一个前台进程，以免被docker强制退出</span><br><span class=\"line\">CMD ./usr/local/nginx/sbin/nginx &amp;&amp; tail -f /usr/local/nginx/logs/error.log</span><br></pre></td></tr></table></figure></p>\n<p>是不是感觉内容太多了呢？每一步都有说明的，为了节省磁盘空间，我们将很多命令聚合到了一起。<br>事实上确实减少了一部分的磁盘占用，我们来看看现在build出来的镜像有多大吧。<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">root@ubuntu-14:~/docker/test# pwd</span><br><span class=\"line\">/root/docker/test</span><br><span class=\"line\">root@ubuntu-14:~/docker/test# ls</span><br><span class=\"line\">docker-compose.yml  nginx</span><br><span class=\"line\"></span><br><span class=\"line\">这里开始进行构建、启动并在后台保持运行</span><br><span class=\"line\">root@ubuntu-14:~/docker/test# docker-compose up -d nginx</span><br><span class=\"line\">后面的内容实在是太多了，就不贴出来了。如果你的网络环境很差，这个过程会很漫长。</span><br><span class=\"line\"></span><br><span class=\"line\">已经成功运行了，test一下</span><br><span class=\"line\">root@ubuntu-14:~/docker/test# curl http://192.168.2.200/test_xw.html</span><br><span class=\"line\">&lt;html&gt;</span><br><span class=\"line\">&lt;body&gt;</span><br><span class=\"line\">&lt;h2&gt;Hello World! xw.&lt;/h2&gt;</span><br><span class=\"line\">&lt;h2&gt;这是测试内容.&lt;/h2&gt;</span><br><span class=\"line\">&lt;/body&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">容器运行后，nginx会处于listener状态，我们来看看images有多大</span><br><span class=\"line\">root@ubuntu-14:~/docker/test# docker images</span><br><span class=\"line\">REPOSITORY          TAG                 IMAGE ID            CREATED             VIRTUAL SIZE</span><br><span class=\"line\">test_nginx          latest              e50ecf326484        2 hours ago         986.3 MB</span><br></pre></td></tr></table></figure></p>\n<p>将近1个GB了，虽然说可以使用docker export -gzip 来压缩，并结合docker import命令直接导入，但是这个体积还是太肥大了，不利于轻量化运行和传播，我们来想想办法来减减肥吧。</p>\n<h1 id=\"FROM-alpine-3-3\"><a href=\"#FROM-alpine-3-3\" class=\"headerlink\" title=\"FROM alpine:3.3\"></a>FROM alpine:3.3</h1><p>Alpine Linux，一个只有5M的Docker镜像。</p>\n<p>Alpine Linux Docker镜像基于Alpine Linux操作系统，后者是一个面向安全的轻型Linux发行版。不同于通常Linux发行版，Alpine Linux采用了musl libc和busybox以减小系统的体积和运行时资源消耗。在保持瘦身的同时，Alpine Linux还提供了自己的包管理工具apk，可以在其网站上查询，或者直接通过apk命令查询和安装。</p>\n<p>Alpine Linux Docker镜像也继承了Alpine Linux发行版的这些优势。相比于其他Docker镜像，它的容量非常小，仅仅只有5M，且拥有非常友好的包管理器。</p>\n<p>可以直接使用的DockerFile：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#说明：因为我所在的网络环境非常差，所以将很多需要下载的Step单独用RUN定义了，以免每次网络连不上而重复下载。如果你的网络环境OK，可以考虑合并多个RUN,以进一步减少imags的大小</span><br><span class=\"line\"></span><br><span class=\"line\">#定义基础镜像</span><br><span class=\"line\">FROM alpine:latest</span><br><span class=\"line\"></span><br><span class=\"line\">#定义nginx版本</span><br><span class=\"line\">ENV NGINX_VERSION 1.9.14</span><br><span class=\"line\"></span><br><span class=\"line\">#将安装源切换为国内环境(中国科学技术大学)，大大加快了安装速度，同时稳定性也有了保障</span><br><span class=\"line\">ENV MIRROR_URL http://mirrors.ustc.edu.cn/alpine/</span><br><span class=\"line\"></span><br><span class=\"line\">ENV MIRROR_URL_BACKUP http://alpine.gliderlabs.com/alpine/</span><br><span class=\"line\"></span><br><span class=\"line\">ENV MIRROR_URL_SLOWEST http://dl-cdn.alpinelinux.org/alpine/</span><br><span class=\"line\"></span><br><span class=\"line\">#准备安装环境</span><br><span class=\"line\">RUN echo &apos;&apos; &gt; /etc/apk/repositories &amp;&amp; \\</span><br><span class=\"line\">    echo &quot;$&#123;MIRROR_URL&#125;v3.3//main&quot;     &gt;&gt; /etc/apk/repositories &amp;&amp; \\</span><br><span class=\"line\">    echo &quot;$&#123;MIRROR_URL&#125;v3.3//community&quot; &gt;&gt; /etc/apk/repositories &amp;&amp; \\</span><br><span class=\"line\">    echo &apos;185.31.17.249 github.com&apos; &gt;&gt; /etc/hosts &amp;&amp; \\</span><br><span class=\"line\">    echo &apos;202.141.160.110 mirrors.ustc.edu.cn&apos; &gt;&gt; /etc/hosts &amp;&amp; \\</span><br><span class=\"line\">    echo &apos;206.251.255.63 nginx.org&apos; &gt;&gt; /etc/hosts</span><br><span class=\"line\"></span><br><span class=\"line\">#安装必要的组件(如果发生  ERROR: Service &apos;nginx&apos; failed to build: The command &apos;/bin/sh -c apk add... returned a non-zero code: 12。  这是网络问题：请删干净未完成container和images，10分钟后再来一遍)</span><br><span class=\"line\">RUN apk add --no-cache --virtual .build-deps \\</span><br><span class=\"line\">    gcc \\</span><br><span class=\"line\">    libc-dev \\</span><br><span class=\"line\">    make \\</span><br><span class=\"line\">    openssl-dev \\</span><br><span class=\"line\">    pcre-dev \\</span><br><span class=\"line\">    zlib-dev \\</span><br><span class=\"line\">    linux-headers \\</span><br><span class=\"line\">    curl \\</span><br><span class=\"line\">    jemalloc-dev \\</span><br><span class=\"line\">    gd-dev \\</span><br><span class=\"line\">    git</span><br><span class=\"line\">#下载安装包和补丁</span><br><span class=\"line\">RUN mkdir -p /var/run/nginx/</span><br><span class=\"line\">RUN wget -c http://nginx.org/download/nginx-$&#123;NGINX_VERSION&#125;.tar.gz</span><br><span class=\"line\">RUN git clone https://github.com/cuber/ngx_http_google_filter_module.git</span><br><span class=\"line\">RUN git clone https://github.com/yaoweibin/ngx_http_substitutions_filter_module.git</span><br><span class=\"line\">RUN git clone https://github.com/aperezdc/ngx-fancyindex.git</span><br><span class=\"line\">RUN git clone https://github.com/yaoweibin/nginx_upstream_check_module.git</span><br><span class=\"line\"></span><br><span class=\"line\">#进行编译安装，同时打上补丁</span><br><span class=\"line\">RUN tar -xzvf nginx-$&#123;NGINX_VERSION&#125;.tar.gz &amp;&amp; \\</span><br><span class=\"line\">cd nginx-$&#123;NGINX_VERSION&#125; &amp;&amp; \\</span><br><span class=\"line\">cd src/ &amp;&amp; \\</span><br><span class=\"line\">#打补丁</span><br><span class=\"line\">patch -p1 &lt; /nginx_upstream_check_module/check_1.9.2+.patch &amp;&amp; \\</span><br><span class=\"line\">cd .. &amp;&amp; \\</span><br><span class=\"line\">#去除nginx的对外版本号</span><br><span class=\"line\">sed -i -e &apos;s/$&#123;NGINX_VERSION&#125;//g&apos; -e &apos;s/nginx\\//ERROR/g&apos; -e &apos;s/&quot;NGINX&quot;/&quot;ERROR&quot;/g&apos; src/core/nginx.h  &amp;&amp; \\</span><br><span class=\"line\">./configure --prefix=/usr/local/nginx \\</span><br><span class=\"line\">--with-pcre \\</span><br><span class=\"line\">--with-ipv6 \\</span><br><span class=\"line\">--with-http_ssl_module \\</span><br><span class=\"line\">--with-http_flv_module \\</span><br><span class=\"line\">--with-http_v2_module \\</span><br><span class=\"line\">--with-http_realip_module \\</span><br><span class=\"line\">--with-http_gzip_static_module \\</span><br><span class=\"line\">--with-http_stub_status_module \\</span><br><span class=\"line\">--with-http_mp4_module \\</span><br><span class=\"line\">--with-http_image_filter_module \\</span><br><span class=\"line\">--with-http_addition_module \\</span><br><span class=\"line\">--with-http_sub_module  \\</span><br><span class=\"line\">--with-http_dav_module  \\</span><br><span class=\"line\">--http-client-body-temp-path=/usr/local/nginx/client/ \\</span><br><span class=\"line\">--http-proxy-temp-path=/usr/local/nginx/proxy/ \\</span><br><span class=\"line\">--http-fastcgi-temp-path=/usr/local/nginx/fcgi/ \\</span><br><span class=\"line\">--http-uwsgi-temp-path=/usr/local/nginx/uwsgi \\</span><br><span class=\"line\">--http-scgi-temp-path=/usr/local/nginx/scgi \\</span><br><span class=\"line\">--add-module=../ngx_http_google_filter_module \\</span><br><span class=\"line\">--add-module=../ngx_http_substitutions_filter_module \\</span><br><span class=\"line\">--add-module=../ngx-fancyindex \\</span><br><span class=\"line\">--add-module=../nginx_upstream_check_module \\</span><br><span class=\"line\">--with-ld-opt=&quot;-ljemalloc&quot; &amp;&amp; \\</span><br><span class=\"line\">#开始编译</span><br><span class=\"line\">make -j $(awk &apos;/processor/&#123;i++&#125;END&#123;print i&#125;&apos; /proc/cpuinfo) &amp;&amp; make install &amp;&amp; \\</span><br><span class=\"line\"></span><br><span class=\"line\">#设置一些工作目录</span><br><span class=\"line\">mkdir -p /usr/local/nginx/cache/ &amp;&amp; \\</span><br><span class=\"line\">mkdir -p /usr/local/nginx/temp/ &amp;&amp; \\</span><br><span class=\"line\">rm -rf ../&#123;ngx*,nginx*&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">#启动nginx，保留一个前台进程，以免被docker强制退出</span><br><span class=\"line\">CMD ./usr/local/nginx/sbin/nginx &amp;&amp; tail -f /usr/local/nginx/logs/error.log</span><br></pre></td></tr></table></figure>\n<p>看看我们最后基于alpine的镜像大小是多少？<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">root@ubuntu-14:~/docker/alpine# docker images</span><br><span class=\"line\">REPOSITORY          TAG                 IMAGE ID            CREATED             VIRTUAL SIZE</span><br><span class=\"line\">alpine_nginx        latest              81b30220a198        3 minutes ago       167.3 MB</span><br></pre></td></tr></table></figure></p>\n<p>不到200MB，成功瘦身80%。合并一些RUN定义，提及还可以更小的。</p>\n<p>我们现在做了2个版本的nginx编译增强镜像，来看看最后的文件目录吧！</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">root@ubuntu-14:~# pwd</span><br><span class=\"line\">/root</span><br><span class=\"line\">root@ubuntu-14:~# tree</span><br><span class=\"line\">.</span><br><span class=\"line\">└── docker</span><br><span class=\"line\">    ├── alpine</span><br><span class=\"line\">    │   ├── docker-compose.yml</span><br><span class=\"line\">    │   └── nginx</span><br><span class=\"line\">    │       ├── conf</span><br><span class=\"line\">    │       │   └── nginx.conf</span><br><span class=\"line\">    │       ├── Dockerfile</span><br><span class=\"line\">    │       ├── html</span><br><span class=\"line\">    │       │   └── test_xw.html</span><br><span class=\"line\">    │       ├── logs</span><br><span class=\"line\">    │       │   ├── error.log</span><br><span class=\"line\">    │       │   ├── nginx.pid</span><br><span class=\"line\">    │       │   └── xws.access.log</span><br><span class=\"line\">    │       ├── ssl</span><br><span class=\"line\">    │       │   ├── www.xw18.cn.crt</span><br><span class=\"line\">    │       │   └── www.xw18.cn.key</span><br><span class=\"line\">    │       └── static</span><br><span class=\"line\">    │           ├── apk</span><br><span class=\"line\">    │           ├── css</span><br><span class=\"line\">    │           ├── img</span><br><span class=\"line\">    │           │   ├── 50.jpg</span><br><span class=\"line\">    │           │   └── photo.jpg</span><br><span class=\"line\">    │           └── js</span><br><span class=\"line\">    └── test</span><br><span class=\"line\">        ├── docker-compose.yml</span><br><span class=\"line\">        └── nginx</span><br><span class=\"line\">            ├── conf</span><br><span class=\"line\">            │   └── nginx.conf</span><br><span class=\"line\">            ├── Dockerfile</span><br><span class=\"line\">            ├── html</span><br><span class=\"line\">            │   └── test_xw.html</span><br><span class=\"line\">            ├── logs</span><br><span class=\"line\">            │   ├── error.log</span><br><span class=\"line\">            │   ├── nginx.pid</span><br><span class=\"line\">            │   └── xws.access.log</span><br><span class=\"line\">            ├── ssl</span><br><span class=\"line\">            │   ├── www.xw18.cn.crt</span><br><span class=\"line\">            │   └── www.xw18.cn.key</span><br><span class=\"line\">            └── static</span><br><span class=\"line\">                ├── apk</span><br><span class=\"line\">                ├── css</span><br><span class=\"line\">                ├── img</span><br><span class=\"line\">                │   ├── 50.jpg</span><br><span class=\"line\">                │   └── photo.jpg</span><br><span class=\"line\">                └── js</span><br><span class=\"line\"></span><br><span class=\"line\">23 directories, 22 files</span><br></pre></td></tr></table></figure>\n<p>参考资料：<a href=\"http://dockone.io/article/1243?utm_source=tuicool&amp;utm_medium=referral\" target=\"_blank\" rel=\"external\">http://dockone.io/article/1243?utm_source=tuicool&amp;utm_medium=referral</a></p>\n<h1 id=\"常用命令总结\"><a href=\"#常用命令总结\" class=\"headerlink\" title=\"常用命令总结\"></a>常用命令总结</h1><ul>\n<li>docker进入到正在运行的容器内部</li>\n</ul>\n<p>docker exec -it test_redis_1 /bin/bash</p>\n<ul>\n<li>运行一个image_id为195eb90b5349的容器，并命名为shell，然后进入到容器内部</li>\n</ul>\n<p>docker run –name shell -i -t 195eb90b5349 /bin/bash</p>\n<ul>\n<li>运行一个名为alpine的容器，并进入到容器内部</li>\n</ul>\n<p>docker run -it alpine /bin/sh</p>\n<ul>\n<li>docker查看本地image</li>\n</ul>\n<p>docker images</p>\n<ul>\n<li>重启docker服务</li>\n</ul>\n<p>service docker restart</p>\n<ul>\n<li>查看所有的容器</li>\n</ul>\n<p>docker ps -a</p>\n<ul>\n<li>删除多个容器</li>\n</ul>\n<p>docker rm -v id1 id2</p>\n<ul>\n<li>删除所有容器</li>\n</ul>\n<p>docker rm $(docker ps -a -q)</p>\n<ul>\n<li>删除多个镜像</li>\n</ul>\n<p>dicker rmi id1 id2</p>\n<ul>\n<li>查询所有未成功build的镜像<none></none></li>\n</ul>\n<p>docker images -q -f dangling=true</p>\n<ul>\n<li>删除所有未成功build的镜像<none></none></li>\n</ul>\n<p>docker rmi $(docker images -q -f dangling=true)</p>\n","excerpt":"","more":"<h1 id=\"前言\"><a href=\"#前言\" class=\"headerlink\" title=\"前言\"></a>前言</h1><p>Docker容器的出现，为应用运行环境一致性带来了很好的解决方案。同时也带来了远比虚拟机更好的体验，提供资源隔离(Linux namespace)和资源分配(Linux control group)的功能、应用可扩展性的功能，但是更加轻量级的运行。为了解决多容器的依赖性和互相调用，提供了docker-compose等工具进行容器编排。</p>\n<p>我们项目中，对docker的使用非常深入，在线上环境和线下的测试环境、开发环境，都使用了docker作为运行时环境一致性支持。由于linux的发行版本和内核版本的不同组合，在没有docker之前，DevOps很难为不同的运行环境编写统一的软件安装维护的脚本，几乎只能借助虚拟机来达到这一目的，虚拟机的笨重和可调度性差，扩容与缩容也无法做到快速有效，已经被逐渐淘汰。</p>\n<p>Nginx，性能已经毋庸置疑，但在docker hub上的nginx镜像，并不适合我们，没有对安全进行加固，更多的没有加入重要的功能增加，比如主动式地对后端Tomcat进行健康检查并自动failover，这个动能对HA的非常重要的，因此我们选择了在docker环境下，对官方nginx源码进行编译，并打上补丁，以符合实际生产环境的使用。</p>\n<p>本文中的配置文件，已经整理到了GitHub：<a href=\"https://github.com/amao12580/docker\">https://github.com/amao12580/docker</a></p>\n<p>本文假设读者对Nginx、Docker已经有了比较深入的了解，并掌握了docker-compose工具的使用。</p>\n<h1 id=\"安装环境\"><a href=\"#安装环境\" class=\"headerlink\" title=\"安装环境\"></a>安装环境</h1><h2 id=\"宿主机的情况\"><a href=\"#宿主机的情况\" class=\"headerlink\" title=\"宿主机的情况\"></a>宿主机的情况</h2><h3 id=\"操作系统和硬件\"><a href=\"#操作系统和硬件\" class=\"headerlink\" title=\"操作系统和硬件\"></a>操作系统和硬件</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">操作系统</span><br><span class=\"line\">root@ubuntu-14:~/docker/test# uname -a</span><br><span class=\"line\">Linux ubuntu-14 4.2.0-35-generic #40~14.04.1-Ubuntu SMP Fri Mar 18 16:37:35 UTC 2016 x86_64 x86_64 x86_64 GNU/Linux</span><br><span class=\"line\"></span><br><span class=\"line\">CPU</span><br><span class=\"line\">root@ubuntu-14:~/docker/test# lscpu</span><br><span class=\"line\">Architecture:          x86_64</span><br><span class=\"line\">CPU op-mode(s):        32-bit, 64-bit</span><br><span class=\"line\">Byte Order:            Little Endian</span><br><span class=\"line\">CPU(s):                4</span><br><span class=\"line\">On-line CPU(s) list:   0-3</span><br><span class=\"line\">Thread(s) per core:    1</span><br><span class=\"line\">Core(s) per socket:    4</span><br><span class=\"line\">Socket(s):             1</span><br><span class=\"line\">NUMA node(s):          1</span><br><span class=\"line\">Vendor ID:             GenuineIntel</span><br><span class=\"line\">CPU family:            6</span><br><span class=\"line\">Model:                 58</span><br><span class=\"line\">Stepping:              9</span><br><span class=\"line\">CPU MHz:               1600.125</span><br><span class=\"line\">BogoMIPS:              6385.87</span><br><span class=\"line\">Virtualization:        VT-x</span><br><span class=\"line\">L1d cache:             32K</span><br><span class=\"line\">L1i cache:             32K</span><br><span class=\"line\">L2 cache:              256K</span><br><span class=\"line\">L3 cache:              6144K</span><br><span class=\"line\"></span><br><span class=\"line\">Memory</span><br><span class=\"line\">root@ubuntu-14:~/docker/test# free -m</span><br><span class=\"line\">             total       used       free     shared    buffers     cached</span><br><span class=\"line\">Mem:          7881       4751       3130          1        419       3810</span><br><span class=\"line\">-/+ buffers/cache:        520       7360</span><br><span class=\"line\">Swap:         8087          0       8087</span><br></pre></td></tr></table></figure>\n<h3 id=\"docker运行时环境\"><a href=\"#docker运行时环境\" class=\"headerlink\" title=\"docker运行时环境\"></a>docker运行时环境</h3><p>如果你不知道如何安装docker，请参考我对此的收集：<a href=\"http://amao12580.github.io/index/\">http://amao12580.github.io/index/</a><br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">root@ubuntu-14:~/docker/test# docker-compose version</span><br><span class=\"line\">docker-compose version 1.7.0, build 0d7bf73</span><br><span class=\"line\">docker-py version: 1.8.0</span><br><span class=\"line\">CPython version: 2.7.9</span><br><span class=\"line\">OpenSSL version: OpenSSL 1.0.1e 11 Feb 2013</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">root@ubuntu-14:~/docker/test# docker version</span><br><span class=\"line\">Client:</span><br><span class=\"line\"> Version:      1.9.1</span><br><span class=\"line\"> API version:  1.21</span><br><span class=\"line\"> Go version:   go1.4.3</span><br><span class=\"line\"> Git commit:   a34a1d5</span><br><span class=\"line\"> Built:        Fri Nov 20 17:56:04 UTC 2015</span><br><span class=\"line\"> OS/Arch:      linux/amd64</span><br><span class=\"line\"></span><br><span class=\"line\">Server:</span><br><span class=\"line\"> Version:      1.9.1</span><br><span class=\"line\"> API version:  1.21</span><br><span class=\"line\"> Go version:   go1.4.3</span><br><span class=\"line\"> Git commit:   a34a1d5</span><br><span class=\"line\"> Built:        Fri Nov 20 17:56:04 UTC 2015</span><br><span class=\"line\"> OS/Arch:      linux/amd64</span><br></pre></td></tr></table></figure></p>\n<h1 id=\"FROM-centos-6-7\"><a href=\"#FROM-centos-6-7\" class=\"headerlink\" title=\"FROM centos:6.7\"></a>FROM centos:6.7</h1><p>我的目录结构看起来是这样：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">root@ubuntu-14:~# pwd</span><br><span class=\"line\">/root</span><br><span class=\"line\">root@ubuntu-14:~# tree</span><br><span class=\"line\">.</span><br><span class=\"line\">└── docker</span><br><span class=\"line\">    └── test</span><br><span class=\"line\">        ├── docker-compose.yml</span><br><span class=\"line\">        └── nginx</span><br><span class=\"line\">            ├── conf</span><br><span class=\"line\">            │   └── nginx.conf</span><br><span class=\"line\">            ├── Dockerfile</span><br><span class=\"line\">            ├── html</span><br><span class=\"line\">            │   └── test_xw.html</span><br><span class=\"line\">            ├── logs</span><br><span class=\"line\">            │   ├── error.log</span><br><span class=\"line\">            │   ├── nginx.pid</span><br><span class=\"line\">            │   └── xws.access.log</span><br><span class=\"line\">            ├── ssl</span><br><span class=\"line\">            │   ├── www.xw18.cn.crt(已经移除，涉及到机密)</span><br><span class=\"line\">            │   └── www.xw18.cn.key(已经移除，涉及到机密)</span><br><span class=\"line\">            └── static</span><br><span class=\"line\">                ├── apk</span><br><span class=\"line\">                ├── css</span><br><span class=\"line\">                ├── img</span><br><span class=\"line\">                │   └── photo.jpg</span><br><span class=\"line\">                └── js</span><br><span class=\"line\"></span><br><span class=\"line\">12 directories, 10 files</span><br></pre></td></tr></table></figure></p>\n<p>想要在shell中打印文件目录结构，请安装“tree”：aptitude install -y tree<br>请确保你的当前用户对这些目录具备必要的权限，下面一起看看docker-compose.yml文件吧。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">root@ubuntu-14:~/docker/test# cat docker-compose.yml</span><br><span class=\"line\">nginx:</span><br><span class=\"line\">  build: ./nginx</span><br><span class=\"line\">  mem_limit: 4294967296</span><br><span class=\"line\">  cpu_shares: 2</span><br><span class=\"line\">  ports:</span><br><span class=\"line\">    - &quot;80:80&quot;</span><br><span class=\"line\">    - &quot;443:443&quot;</span><br><span class=\"line\">  volumes:</span><br><span class=\"line\">    - ./nginx/conf/nginx.conf:/usr/local/nginx/conf/nginx.conf</span><br><span class=\"line\">    - ./nginx/html:/usr/local/nginx/html</span><br><span class=\"line\">    - ./nginx/static:/usr/local/nginx/static</span><br><span class=\"line\">    - ./nginx/ssl:/usr/local/nginx/ssl</span><br><span class=\"line\">    - ./nginx/logs:/usr/local/nginx/logs:rw</span><br></pre></td></tr></table></figure>\n<p>是不是看起来很简单呢？因为我们在docker-compose里定义的是服务的运行环境要求，并没有定义如何构建这个服务。</p>\n<p>想看如何构建nginx,那一起来看看Dockerfile文件吧，这个文件就是如何一步步的构建服务的，如果有合适的image，你可以在Dockerfile里定义执行任何可以在宿主机环境下执行的命令哦。是不是很magic呢？<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">root@ubuntu-14:~/docker/test/nginx# cat Dockerfile</span><br><span class=\"line\">#定义基础镜像</span><br><span class=\"line\">FROM centos:6.7</span><br><span class=\"line\"></span><br><span class=\"line\">#定义nginx版本</span><br><span class=\"line\">ENV NGINX_VERSION 1.9.14</span><br><span class=\"line\"></span><br><span class=\"line\">#准备安装环境</span><br><span class=\"line\">RUN yum install -y wget &amp;&amp; \\</span><br><span class=\"line\">wget -O /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-6.repo  &amp;&amp; \\</span><br><span class=\"line\">yum clean all  &amp;&amp; \\</span><br><span class=\"line\">yum makecache &amp;&amp; \\</span><br><span class=\"line\"></span><br><span class=\"line\">#安装依赖组件</span><br><span class=\"line\">rpm --import /etc/pki/rpm-gpg/RPM-GPG-KEY-CentOS-* &amp;&amp; \\</span><br><span class=\"line\">yum install -y epel-release &amp;&amp; \\</span><br><span class=\"line\">rpm --import /etc/pki/rpm-gpg/RPM-GPG-KEY-EPEL-6 &amp;&amp; \\</span><br><span class=\"line\">yum install -y patch pcre-devel openssl-devel zlib-devel gd-devel tar gcc git supervisor &amp;&amp; \\</span><br><span class=\"line\"></span><br><span class=\"line\">#下载安装包和补丁</span><br><span class=\"line\">mkdir -p /var/run/nginx/ &amp;&amp; \\</span><br><span class=\"line\">wget -c http://nginx.org/download/nginx-$&#123;NGINX_VERSION&#125;.tar.gz &amp;&amp; \\</span><br><span class=\"line\">git clone https://github.com/cuber/ngx_http_google_filter_module.git &amp;&amp; \\</span><br><span class=\"line\">git clone https://github.com/yaoweibin/ngx_http_substitutions_filter_module.git &amp;&amp; \\</span><br><span class=\"line\">git clone https://github.com/aperezdc/ngx-fancyindex.git &amp;&amp; \\</span><br><span class=\"line\">git clone https://github.com/yaoweibin/nginx_upstream_check_module.git &amp;&amp; \\</span><br><span class=\"line\"></span><br><span class=\"line\">#进行编译安装，同时打上补丁</span><br><span class=\"line\">tar xf nginx-$&#123;NGINX_VERSION&#125;.tar.gz &amp;&amp; \\</span><br><span class=\"line\">cd nginx-$&#123;NGINX_VERSION&#125; &amp;&amp; \\</span><br><span class=\"line\">cd src/ &amp;&amp; \\</span><br><span class=\"line\">#打补丁</span><br><span class=\"line\">patch -p1 &lt; /nginx_upstream_check_module/check_1.9.2+.patch &amp;&amp; \\</span><br><span class=\"line\">cd .. &amp;&amp; \\</span><br><span class=\"line\">#去除nginx的对外版本号</span><br><span class=\"line\">sed -i -e &apos;s/$&#123;NGINX_VERSION&#125;//g&apos; -e &apos;s/nginx\\//ERROR/g&apos; -e &apos;s/&quot;NGINX&quot;/&quot;ERROR&quot;/g&apos; src/core/nginx.h  &amp;&amp; \\</span><br><span class=\"line\">./configure --prefix=/usr/local/nginx \\</span><br><span class=\"line\">--with-pcre \\</span><br><span class=\"line\">--with-ipv6 \\</span><br><span class=\"line\">--with-http_ssl_module \\</span><br><span class=\"line\">--with-http_flv_module \\</span><br><span class=\"line\">--with-http_v2_module \\</span><br><span class=\"line\">--with-http_realip_module \\</span><br><span class=\"line\">--with-http_gzip_static_module \\</span><br><span class=\"line\">--with-http_stub_status_module \\</span><br><span class=\"line\">--with-http_mp4_module \\</span><br><span class=\"line\">--with-http_image_filter_module \\</span><br><span class=\"line\">--with-http_addition_module \\</span><br><span class=\"line\">--with-http_sub_module  \\</span><br><span class=\"line\">--with-http_dav_module  \\</span><br><span class=\"line\">--http-client-body-temp-path=/usr/local/nginx/client/ \\</span><br><span class=\"line\">--http-proxy-temp-path=/usr/local/nginx/proxy/ \\</span><br><span class=\"line\">--http-fastcgi-temp-path=/usr/local/nginx/fcgi/ \\</span><br><span class=\"line\">--http-uwsgi-temp-path=/usr/local/nginx/uwsgi \\</span><br><span class=\"line\">--http-scgi-temp-path=/usr/local/nginx/scgi \\</span><br><span class=\"line\">--add-module=../ngx_http_google_filter_module \\</span><br><span class=\"line\">--add-module=../ngx_http_substitutions_filter_module \\</span><br><span class=\"line\">--add-module=../ngx-fancyindex \\</span><br><span class=\"line\">--add-module=../nginx_upstream_check_module &amp;&amp; \\</span><br><span class=\"line\">#开始编译</span><br><span class=\"line\">make -j $(awk &apos;/processor/&#123;i++&#125;END&#123;print i&#125;&apos; /proc/cpuinfo) &amp;&amp; make install &amp;&amp; \\</span><br><span class=\"line\">#设置一些工作目录</span><br><span class=\"line\">mkdir -p /usr/local/nginx/cache/ &amp;&amp; \\</span><br><span class=\"line\">mkdir -p /usr/local/nginx/temp/ &amp;&amp; \\</span><br><span class=\"line\">rm -rf ../&#123;ngx*,nginx*&#125; &amp;&amp; \\</span><br><span class=\"line\">yum clean packages</span><br><span class=\"line\"></span><br><span class=\"line\">#启动nginx，保留一个前台进程，以免被docker强制退出</span><br><span class=\"line\">CMD ./usr/local/nginx/sbin/nginx &amp;&amp; tail -f /usr/local/nginx/logs/error.log</span><br></pre></td></tr></table></figure></p>\n<p>是不是感觉内容太多了呢？每一步都有说明的，为了节省磁盘空间，我们将很多命令聚合到了一起。<br>事实上确实减少了一部分的磁盘占用，我们来看看现在build出来的镜像有多大吧。<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">root@ubuntu-14:~/docker/test# pwd</span><br><span class=\"line\">/root/docker/test</span><br><span class=\"line\">root@ubuntu-14:~/docker/test# ls</span><br><span class=\"line\">docker-compose.yml  nginx</span><br><span class=\"line\"></span><br><span class=\"line\">这里开始进行构建、启动并在后台保持运行</span><br><span class=\"line\">root@ubuntu-14:~/docker/test# docker-compose up -d nginx</span><br><span class=\"line\">后面的内容实在是太多了，就不贴出来了。如果你的网络环境很差，这个过程会很漫长。</span><br><span class=\"line\"></span><br><span class=\"line\">已经成功运行了，test一下</span><br><span class=\"line\">root@ubuntu-14:~/docker/test# curl http://192.168.2.200/test_xw.html</span><br><span class=\"line\">&lt;html&gt;</span><br><span class=\"line\">&lt;body&gt;</span><br><span class=\"line\">&lt;h2&gt;Hello World! xw.&lt;/h2&gt;</span><br><span class=\"line\">&lt;h2&gt;这是测试内容.&lt;/h2&gt;</span><br><span class=\"line\">&lt;/body&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">容器运行后，nginx会处于listener状态，我们来看看images有多大</span><br><span class=\"line\">root@ubuntu-14:~/docker/test# docker images</span><br><span class=\"line\">REPOSITORY          TAG                 IMAGE ID            CREATED             VIRTUAL SIZE</span><br><span class=\"line\">test_nginx          latest              e50ecf326484        2 hours ago         986.3 MB</span><br></pre></td></tr></table></figure></p>\n<p>将近1个GB了，虽然说可以使用docker export -gzip 来压缩，并结合docker import命令直接导入，但是这个体积还是太肥大了，不利于轻量化运行和传播，我们来想想办法来减减肥吧。</p>\n<h1 id=\"FROM-alpine-3-3\"><a href=\"#FROM-alpine-3-3\" class=\"headerlink\" title=\"FROM alpine:3.3\"></a>FROM alpine:3.3</h1><p>Alpine Linux，一个只有5M的Docker镜像。</p>\n<p>Alpine Linux Docker镜像基于Alpine Linux操作系统，后者是一个面向安全的轻型Linux发行版。不同于通常Linux发行版，Alpine Linux采用了musl libc和busybox以减小系统的体积和运行时资源消耗。在保持瘦身的同时，Alpine Linux还提供了自己的包管理工具apk，可以在其网站上查询，或者直接通过apk命令查询和安装。</p>\n<p>Alpine Linux Docker镜像也继承了Alpine Linux发行版的这些优势。相比于其他Docker镜像，它的容量非常小，仅仅只有5M，且拥有非常友好的包管理器。</p>\n<p>可以直接使用的DockerFile：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#说明：因为我所在的网络环境非常差，所以将很多需要下载的Step单独用RUN定义了，以免每次网络连不上而重复下载。如果你的网络环境OK，可以考虑合并多个RUN,以进一步减少imags的大小</span><br><span class=\"line\"></span><br><span class=\"line\">#定义基础镜像</span><br><span class=\"line\">FROM alpine:latest</span><br><span class=\"line\"></span><br><span class=\"line\">#定义nginx版本</span><br><span class=\"line\">ENV NGINX_VERSION 1.9.14</span><br><span class=\"line\"></span><br><span class=\"line\">#将安装源切换为国内环境(中国科学技术大学)，大大加快了安装速度，同时稳定性也有了保障</span><br><span class=\"line\">ENV MIRROR_URL http://mirrors.ustc.edu.cn/alpine/</span><br><span class=\"line\"></span><br><span class=\"line\">ENV MIRROR_URL_BACKUP http://alpine.gliderlabs.com/alpine/</span><br><span class=\"line\"></span><br><span class=\"line\">ENV MIRROR_URL_SLOWEST http://dl-cdn.alpinelinux.org/alpine/</span><br><span class=\"line\"></span><br><span class=\"line\">#准备安装环境</span><br><span class=\"line\">RUN echo &apos;&apos; &gt; /etc/apk/repositories &amp;&amp; \\</span><br><span class=\"line\">    echo &quot;$&#123;MIRROR_URL&#125;v3.3//main&quot;     &gt;&gt; /etc/apk/repositories &amp;&amp; \\</span><br><span class=\"line\">    echo &quot;$&#123;MIRROR_URL&#125;v3.3//community&quot; &gt;&gt; /etc/apk/repositories &amp;&amp; \\</span><br><span class=\"line\">    echo &apos;185.31.17.249 github.com&apos; &gt;&gt; /etc/hosts &amp;&amp; \\</span><br><span class=\"line\">    echo &apos;202.141.160.110 mirrors.ustc.edu.cn&apos; &gt;&gt; /etc/hosts &amp;&amp; \\</span><br><span class=\"line\">    echo &apos;206.251.255.63 nginx.org&apos; &gt;&gt; /etc/hosts</span><br><span class=\"line\"></span><br><span class=\"line\">#安装必要的组件(如果发生  ERROR: Service &apos;nginx&apos; failed to build: The command &apos;/bin/sh -c apk add... returned a non-zero code: 12。  这是网络问题：请删干净未完成container和images，10分钟后再来一遍)</span><br><span class=\"line\">RUN apk add --no-cache --virtual .build-deps \\</span><br><span class=\"line\">    gcc \\</span><br><span class=\"line\">    libc-dev \\</span><br><span class=\"line\">    make \\</span><br><span class=\"line\">    openssl-dev \\</span><br><span class=\"line\">    pcre-dev \\</span><br><span class=\"line\">    zlib-dev \\</span><br><span class=\"line\">    linux-headers \\</span><br><span class=\"line\">    curl \\</span><br><span class=\"line\">    jemalloc-dev \\</span><br><span class=\"line\">    gd-dev \\</span><br><span class=\"line\">    git</span><br><span class=\"line\">#下载安装包和补丁</span><br><span class=\"line\">RUN mkdir -p /var/run/nginx/</span><br><span class=\"line\">RUN wget -c http://nginx.org/download/nginx-$&#123;NGINX_VERSION&#125;.tar.gz</span><br><span class=\"line\">RUN git clone https://github.com/cuber/ngx_http_google_filter_module.git</span><br><span class=\"line\">RUN git clone https://github.com/yaoweibin/ngx_http_substitutions_filter_module.git</span><br><span class=\"line\">RUN git clone https://github.com/aperezdc/ngx-fancyindex.git</span><br><span class=\"line\">RUN git clone https://github.com/yaoweibin/nginx_upstream_check_module.git</span><br><span class=\"line\"></span><br><span class=\"line\">#进行编译安装，同时打上补丁</span><br><span class=\"line\">RUN tar -xzvf nginx-$&#123;NGINX_VERSION&#125;.tar.gz &amp;&amp; \\</span><br><span class=\"line\">cd nginx-$&#123;NGINX_VERSION&#125; &amp;&amp; \\</span><br><span class=\"line\">cd src/ &amp;&amp; \\</span><br><span class=\"line\">#打补丁</span><br><span class=\"line\">patch -p1 &lt; /nginx_upstream_check_module/check_1.9.2+.patch &amp;&amp; \\</span><br><span class=\"line\">cd .. &amp;&amp; \\</span><br><span class=\"line\">#去除nginx的对外版本号</span><br><span class=\"line\">sed -i -e &apos;s/$&#123;NGINX_VERSION&#125;//g&apos; -e &apos;s/nginx\\//ERROR/g&apos; -e &apos;s/&quot;NGINX&quot;/&quot;ERROR&quot;/g&apos; src/core/nginx.h  &amp;&amp; \\</span><br><span class=\"line\">./configure --prefix=/usr/local/nginx \\</span><br><span class=\"line\">--with-pcre \\</span><br><span class=\"line\">--with-ipv6 \\</span><br><span class=\"line\">--with-http_ssl_module \\</span><br><span class=\"line\">--with-http_flv_module \\</span><br><span class=\"line\">--with-http_v2_module \\</span><br><span class=\"line\">--with-http_realip_module \\</span><br><span class=\"line\">--with-http_gzip_static_module \\</span><br><span class=\"line\">--with-http_stub_status_module \\</span><br><span class=\"line\">--with-http_mp4_module \\</span><br><span class=\"line\">--with-http_image_filter_module \\</span><br><span class=\"line\">--with-http_addition_module \\</span><br><span class=\"line\">--with-http_sub_module  \\</span><br><span class=\"line\">--with-http_dav_module  \\</span><br><span class=\"line\">--http-client-body-temp-path=/usr/local/nginx/client/ \\</span><br><span class=\"line\">--http-proxy-temp-path=/usr/local/nginx/proxy/ \\</span><br><span class=\"line\">--http-fastcgi-temp-path=/usr/local/nginx/fcgi/ \\</span><br><span class=\"line\">--http-uwsgi-temp-path=/usr/local/nginx/uwsgi \\</span><br><span class=\"line\">--http-scgi-temp-path=/usr/local/nginx/scgi \\</span><br><span class=\"line\">--add-module=../ngx_http_google_filter_module \\</span><br><span class=\"line\">--add-module=../ngx_http_substitutions_filter_module \\</span><br><span class=\"line\">--add-module=../ngx-fancyindex \\</span><br><span class=\"line\">--add-module=../nginx_upstream_check_module \\</span><br><span class=\"line\">--with-ld-opt=&quot;-ljemalloc&quot; &amp;&amp; \\</span><br><span class=\"line\">#开始编译</span><br><span class=\"line\">make -j $(awk &apos;/processor/&#123;i++&#125;END&#123;print i&#125;&apos; /proc/cpuinfo) &amp;&amp; make install &amp;&amp; \\</span><br><span class=\"line\"></span><br><span class=\"line\">#设置一些工作目录</span><br><span class=\"line\">mkdir -p /usr/local/nginx/cache/ &amp;&amp; \\</span><br><span class=\"line\">mkdir -p /usr/local/nginx/temp/ &amp;&amp; \\</span><br><span class=\"line\">rm -rf ../&#123;ngx*,nginx*&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">#启动nginx，保留一个前台进程，以免被docker强制退出</span><br><span class=\"line\">CMD ./usr/local/nginx/sbin/nginx &amp;&amp; tail -f /usr/local/nginx/logs/error.log</span><br></pre></td></tr></table></figure>\n<p>看看我们最后基于alpine的镜像大小是多少？<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">root@ubuntu-14:~/docker/alpine# docker images</span><br><span class=\"line\">REPOSITORY          TAG                 IMAGE ID            CREATED             VIRTUAL SIZE</span><br><span class=\"line\">alpine_nginx        latest              81b30220a198        3 minutes ago       167.3 MB</span><br></pre></td></tr></table></figure></p>\n<p>不到200MB，成功瘦身80%。合并一些RUN定义，提及还可以更小的。</p>\n<p>我们现在做了2个版本的nginx编译增强镜像，来看看最后的文件目录吧！</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">root@ubuntu-14:~# pwd</span><br><span class=\"line\">/root</span><br><span class=\"line\">root@ubuntu-14:~# tree</span><br><span class=\"line\">.</span><br><span class=\"line\">└── docker</span><br><span class=\"line\">    ├── alpine</span><br><span class=\"line\">    │   ├── docker-compose.yml</span><br><span class=\"line\">    │   └── nginx</span><br><span class=\"line\">    │       ├── conf</span><br><span class=\"line\">    │       │   └── nginx.conf</span><br><span class=\"line\">    │       ├── Dockerfile</span><br><span class=\"line\">    │       ├── html</span><br><span class=\"line\">    │       │   └── test_xw.html</span><br><span class=\"line\">    │       ├── logs</span><br><span class=\"line\">    │       │   ├── error.log</span><br><span class=\"line\">    │       │   ├── nginx.pid</span><br><span class=\"line\">    │       │   └── xws.access.log</span><br><span class=\"line\">    │       ├── ssl</span><br><span class=\"line\">    │       │   ├── www.xw18.cn.crt</span><br><span class=\"line\">    │       │   └── www.xw18.cn.key</span><br><span class=\"line\">    │       └── static</span><br><span class=\"line\">    │           ├── apk</span><br><span class=\"line\">    │           ├── css</span><br><span class=\"line\">    │           ├── img</span><br><span class=\"line\">    │           │   ├── 50.jpg</span><br><span class=\"line\">    │           │   └── photo.jpg</span><br><span class=\"line\">    │           └── js</span><br><span class=\"line\">    └── test</span><br><span class=\"line\">        ├── docker-compose.yml</span><br><span class=\"line\">        └── nginx</span><br><span class=\"line\">            ├── conf</span><br><span class=\"line\">            │   └── nginx.conf</span><br><span class=\"line\">            ├── Dockerfile</span><br><span class=\"line\">            ├── html</span><br><span class=\"line\">            │   └── test_xw.html</span><br><span class=\"line\">            ├── logs</span><br><span class=\"line\">            │   ├── error.log</span><br><span class=\"line\">            │   ├── nginx.pid</span><br><span class=\"line\">            │   └── xws.access.log</span><br><span class=\"line\">            ├── ssl</span><br><span class=\"line\">            │   ├── www.xw18.cn.crt</span><br><span class=\"line\">            │   └── www.xw18.cn.key</span><br><span class=\"line\">            └── static</span><br><span class=\"line\">                ├── apk</span><br><span class=\"line\">                ├── css</span><br><span class=\"line\">                ├── img</span><br><span class=\"line\">                │   ├── 50.jpg</span><br><span class=\"line\">                │   └── photo.jpg</span><br><span class=\"line\">                └── js</span><br><span class=\"line\"></span><br><span class=\"line\">23 directories, 22 files</span><br></pre></td></tr></table></figure>\n<p>参考资料：<a href=\"http://dockone.io/article/1243?utm_source=tuicool&amp;utm_medium=referral\">http://dockone.io/article/1243?utm_source=tuicool&amp;utm_medium=referral</a></p>\n<h1 id=\"常用命令总结\"><a href=\"#常用命令总结\" class=\"headerlink\" title=\"常用命令总结\"></a>常用命令总结</h1><ul>\n<li>docker进入到正在运行的容器内部</li>\n</ul>\n<p>docker exec -it test_redis_1 /bin/bash</p>\n<ul>\n<li>运行一个image_id为195eb90b5349的容器，并命名为shell，然后进入到容器内部</li>\n</ul>\n<p>docker run –name shell -i -t 195eb90b5349 /bin/bash</p>\n<ul>\n<li>运行一个名为alpine的容器，并进入到容器内部</li>\n</ul>\n<p>docker run -it alpine /bin/sh</p>\n<ul>\n<li>docker查看本地image</li>\n</ul>\n<p>docker images</p>\n<ul>\n<li>重启docker服务</li>\n</ul>\n<p>service docker restart</p>\n<ul>\n<li>查看所有的容器</li>\n</ul>\n<p>docker ps -a</p>\n<ul>\n<li>删除多个容器</li>\n</ul>\n<p>docker rm -v id1 id2</p>\n<ul>\n<li>删除所有容器</li>\n</ul>\n<p>docker rm $(docker ps -a -q)</p>\n<ul>\n<li>删除多个镜像</li>\n</ul>\n<p>dicker rmi id1 id2</p>\n<ul>\n<li>查询所有未成功build的镜像<none></li>\n</ul>\n<p>docker images -q -f dangling=true</p>\n<ul>\n<li>删除所有未成功build的镜像<none></li>\n</ul>\n<p>docker rmi $(docker images -q -f dangling=true)</p>\n"},{"title":"Nginx与Docker容器系列 <02:在生产环境的实践>","date":"2016-04-28T04:45:59.000Z","description":"介绍Nginx自身的设计思想，解决如何进行动静分离、负载均衡，还有软件热升级方案的应用。以及解答如何更好的在Docker容器中使用Nginx，对Nginx  Active-Standby应用模式的思考.","_content":"\n# 前言\n本文中的配置文件，已经整理到了GitHub：[https://github.com/amao12580/docker](https://github.com/amao12580/docker)\n\n本文假设读者对Nginx、Docker已经有了比较深入的了解，并掌握了docker-compose工具的使用。\n\n## 高性能\nNginx是一款面向性能设计的HTTP服务器，相较于Apache、lighttpd具有占有内存少，稳定性高等优势。与旧版本（<=2.2）的Apache不同，nginx不采用每客户机一线程的设计模型，而是充分使用异步逻辑，削减了上下文调度开销，所以并发服务能力更强。整体采用模块化设计，有丰富的模块库和第三方模块库，配置灵活。 在Linux操作系统下，nginx使用epoll事件模型，得益于此，nginx在Linux操作系统下效率相当高。同时Nginx在OpenBSD或FreeBSD操作系统上采用类似于epoll的高效事件模型kqueue。nginx同时是一个高性能的 HTTP 和 反向代理 服务器，也是一个 IMAP/POP3/SMTP 代理服务器。Nginx 已经因为它的稳定性、丰富的功能集、示例配置文件和低系统资源的消耗而闻名了。\n\n## 可扩展\nNginx属于典型的微内核设计，其内核非常简洁和优雅，同时具有非常高的可扩展性。\n\nNginx是纯C语言的实现，其可扩展性在于其模块化的设计。目前，Nginx已经有很多的第三方模块，大大扩展了自身的功能。nginx_lua_module可以将Lua语言嵌入到Nginx配置中，从而利用Lua极大增强了Nginx本身的编程能力，甚至可以不用配合其它脚本语言（如PHP或Python等），只靠Nginx本身就可以实现复杂业务的处理。\n\n* --with-http_realip_module        #获取真实IP模块\n* --with-http_sub_module           #修改原始请求URI模块\n* --with-http_flv_module           #对flv流媒体播放提供支持\n* --with-http_dav_module           #启用对[WebDav协议](https://idoseek.com/1800)的支持\n* --with-http_gzip_static_module   #开启GZIP压缩，可以直接压缩html等静态资源。*.gz\n* --with-http_stub_status_module   #提供对nginx自身状态的监控功能\n* --with-http_addition_module      #过滤器模块， 在response数据的前/后添加文本\n* --with-pcre=                     #正则表达式解析支持，支持Rewrite重写规则\n* --with-openssl=                  #(part 1) HTTPS访问支持，需同时配合公钥和CA证书\n* --with-http_ssl_module           #(part 2) HTTPS访问支持，需同时配合公钥和CA证书\n* --with-zlib=                     #gzip模块需要 zlib 库\n* --add-module=/patch/nginx_upstream_check_module   #对后端服务器提供主动健康检查，自动failover\n\n这些模块，都是基于nginx源码编译安装并显式配置，才会生效，这要求我们的docker FROM镜像，需要支持C编译器环境。\n\n### 相关内容\nOpenResty 的目标是让你的Web服务直接跑在 Nginx 服务内部，充分利用 Nginx 的非阻塞 I/O 模型，不仅仅对 HTTP 客户端请求,甚至于对远程后端诸如 MySQL、PostgreSQL、Memcached 以及 Redis 等都进行一致的高性能响应。\n\nExample:利用OpenResty的可编程特性，结合Redis，实现实时统计网站的PV、UV的功能，非常的简单。\n\n不局限于Redis等,甚至于Kafka也可以，只要SDK提供对Lua语言的支持即可，简直是运维的春天\n\n## 动静分离\n动静分离，是指响应内容的动与静，分为动态计算的响应内容与静态不变的响应内容。如订单总数量计算是一个动态的，而网页logo图片是一个静态的。前者一般需要访问应用服务器，由程序来计算，而后者一般只需要nginx自身来处理。\n\n利用nginx提供的静态资源压缩传输、静态资源内存级缓存，我们可以将html文件、css文件、js文件等资源直接放在nginx所在的主机硬盘中，由nginx代理这些文件的get操作。\n\n受nginx代理的静态资源文件，应该具备如下特征：1.文件内容几乎不变化，如注册用户使用协议html，2.文件体积小，减轻压缩时对cpu的波动，以及缓存在内存的资源占用，3.文件属于热访问文件，比如Angular框架下的js文件。\n\n多个nginx节点，可以共享这些静态文件，利用网络磁盘共享技术，甚至可以在部署在多个物理机的nginx节点下进行共享。\n\n我们将可以直接将所有静态资源，按类型，放到文件夹：nginx/html/或nginx/static/下，这是立即生效的，不需要重启nginx。\n\n## 后端版本热升级\n\n### 兼容式热升级\n\n对于nginx后端部署的应用程序，需要进行版本升级时，我们可以这样做。\n* 1.前提假定\n\n* 1.1假设应用程序的新版本接口，是100%兼容旧版本的，即任何旧版本客户端在调用旧版本应用程序与新版本应用程序是无区别的，包括请求内容和响应内容。\n\n* 1.2假设nginx.conf中，upstream段，定义了3个tomcat服务器（A\\B\\C）。此时2个tomcat服务器运行着同一版本（即旧版本）的应用程序。\n\n\n* 2.升级步骤\n\n* 2.1选择在系统平峰期进行，避免流量冲击。\n\n* 2.2正常关闭A tomcat，在合理配置nginx的前提下，nginx监测到A机crash，此时会将流量转移到B\\C。若使用平均流量权重，此时若B\\C 2个机器的流量会各升高50%。\n\n* 2.3执行A tomcat的升级。\n\n* 2.4启动A tomcat，nginx监测到A机up，会将流量重新分配，此时各节点的流量恢复正常态。\n\n* 2.5依照以上步骤，再升级B\\C节点。\n\n\n整个过程不需要重启nginx，这意味着对外服务不需要中断。新版本可能存在不稳定，需要回退到旧版本，也是类似与以上步骤执行。\n\n### 非兼容式热升级\n\n非兼容式升级，是指新版本应用程序，对客户端的版本的要求比旧版本应用程序要高。例如客户端版本为1.0，旧版本应用程序为1.5，新版本应用程序为1.6。假定1.6版本对1.0版本的客户端不再提供支持，而1.5版本是可以支持1.0版本的客户端的。\n而1.5与1.6版本的客户端访问入口，都在同一个nginx的同一个端口。\n\n* 1.避免同时支持多个版本的客户端，需要有客户端强制升级的方案。\n\n* 2.客户端与应用程序通讯，需要定义一个客户端当前版本号，且该数据需要支持被nginx解析到。\n\n* 3.修改nginx配置，定义2个server节点，每个节点按照不同客户端版本路由到对应的后端应用程序中，即有一个客户端版本与后端应用程序版本的对照表。\n\n* 4.nginx做一下热加载nginx.conf，在下文中有提及。\n\n\n这种方案对于后端应用程序开发最为友好，只需要有不同分支版本进行并行维护即可，比如tag/V1.5/code、tag/V1.6/code，2个版本公有的bug修复时，需要做一个互相merge.\n\n## 自身热升级\n\nNginx自身的热升级，是指对Nginx进行模块维护或版本维护。\n\nNginx主进程在启动完成后会进入等待状态，负责响应各类系统消息，如SIGCHLD、SIGHUP、SIGUSR2等。\n\n* TERM, INT: 立刻退出\n* QUIT: 等待工作进程结束后再退出\n* KILL: 强制终止进程\n* HUP: 重新加载配置文件，使用新的配置启动工作进程，并逐步关闭旧进程。\n* USR1: 重新打开日志文件\n* USR2: 启动新的主进程，实现热升级\n* WINCH: 逐步关闭工作进程\n\n在docker容器内热升级nginx的步骤：\n* 1.向主进程发送USR2信号，Nginx会启动一个新版本的master进程和工作进程，和旧版一起处理请求\n\ndocker kill --signal=\"USR2\" <nginx container name or id>\n\n* 2.向原Nginx主进程发送WINCH信号，它会逐步关闭旗下的工作进程（主进程不退出），这时所有请求都会由新版Nginx处理\n\ndocker kill --signal=\"WINCH\" <nginx container name or id>\n\n* 3.如果这时需要回退，可向原Nginx主进程发送HUP信号，它会重新启动工作进程， 仍使用旧版配置文件 。尔后可以将新版Nginx进程杀死（使用QUIT、TERM、或者KILL）\n\ndocker kill --signal=\"TERM\" <nginx container name or id>\n\n## 热加载nginx.conf\n\n我们知道在upstream定义的tomcat节点，是属于文件性配置，如果需要上线新加节点，需要修改nginx.conf，然后需要重启Nginx读取新配置。如何热加载nginx.conf 而不需重启nginx？\n\ndocker exec -i -t <nginx container name or id> ./usr/local/nginx/sbin/nginx -s reload\n\n## 高可用方案\n\n使用Keepalived在多个nginx节点之间做互为主备配置，配置略过。\n\n## 负载均衡\n\n对后端tomcat的负载均衡，使用upstream，配置权重和max_fails等参数即可\n\n   # 设定负载均衡方式：RR模式\n    upstream  xws  {\n        server 192.168.1.188:6080 weight=1 max_fails=5 fail_timeout=10s ;\n        server 192.168.1.188:7080 weight=1 max_fails=5 fail_timeout=10s ;\n        check interval=3000 rise=2 fall=5 timeout=1000 type=http;\n    }\n\n## 对后端的健康管理\n\n使用nginx_upstream_check_module功能增强补丁\n\n配置location,开放后端tomcat的健康状况访问。\n\nhttp://your maintenance IP and Port/xw_TomcatStatus/\n\n## 自身的运行监控\n\n监控Nginx：http://your maintenance IP and Port/xw_NginxStatus/\n\n## Reference\n\n* 软件架构模式：http://colobu.com/2015/04/08/software-architecture-patterns/\n\n* Nginx简介：http://www.rowkey.me/blog/2014/08/27/nginx-loabbalance/\n\n* OpenResty + Redis 实时计算统计Web服务的UV & PV ：http://www.wtoutiao.com/p/109IT70.html\n","source":"_posts/Nginx-with-docker-part-two.md","raw":"---\ntitle: Nginx与Docker容器系列 <02:在生产环境的实践>\ndate: 2016-04-28 12:45:59\ntags:\n    - Nginx\n    - Keepalived\n    - Docker\n    - MicroKernel\n    - Patch\n    - Failover\ncategories:\n    - Record\ndescription: 介绍Nginx自身的设计思想，解决如何进行动静分离、负载均衡，还有软件热升级方案的应用。以及解答如何更好的在Docker容器中使用Nginx，对Nginx  Active-Standby应用模式的思考.\n---\n\n# 前言\n本文中的配置文件，已经整理到了GitHub：[https://github.com/amao12580/docker](https://github.com/amao12580/docker)\n\n本文假设读者对Nginx、Docker已经有了比较深入的了解，并掌握了docker-compose工具的使用。\n\n## 高性能\nNginx是一款面向性能设计的HTTP服务器，相较于Apache、lighttpd具有占有内存少，稳定性高等优势。与旧版本（<=2.2）的Apache不同，nginx不采用每客户机一线程的设计模型，而是充分使用异步逻辑，削减了上下文调度开销，所以并发服务能力更强。整体采用模块化设计，有丰富的模块库和第三方模块库，配置灵活。 在Linux操作系统下，nginx使用epoll事件模型，得益于此，nginx在Linux操作系统下效率相当高。同时Nginx在OpenBSD或FreeBSD操作系统上采用类似于epoll的高效事件模型kqueue。nginx同时是一个高性能的 HTTP 和 反向代理 服务器，也是一个 IMAP/POP3/SMTP 代理服务器。Nginx 已经因为它的稳定性、丰富的功能集、示例配置文件和低系统资源的消耗而闻名了。\n\n## 可扩展\nNginx属于典型的微内核设计，其内核非常简洁和优雅，同时具有非常高的可扩展性。\n\nNginx是纯C语言的实现，其可扩展性在于其模块化的设计。目前，Nginx已经有很多的第三方模块，大大扩展了自身的功能。nginx_lua_module可以将Lua语言嵌入到Nginx配置中，从而利用Lua极大增强了Nginx本身的编程能力，甚至可以不用配合其它脚本语言（如PHP或Python等），只靠Nginx本身就可以实现复杂业务的处理。\n\n* --with-http_realip_module        #获取真实IP模块\n* --with-http_sub_module           #修改原始请求URI模块\n* --with-http_flv_module           #对flv流媒体播放提供支持\n* --with-http_dav_module           #启用对[WebDav协议](https://idoseek.com/1800)的支持\n* --with-http_gzip_static_module   #开启GZIP压缩，可以直接压缩html等静态资源。*.gz\n* --with-http_stub_status_module   #提供对nginx自身状态的监控功能\n* --with-http_addition_module      #过滤器模块， 在response数据的前/后添加文本\n* --with-pcre=                     #正则表达式解析支持，支持Rewrite重写规则\n* --with-openssl=                  #(part 1) HTTPS访问支持，需同时配合公钥和CA证书\n* --with-http_ssl_module           #(part 2) HTTPS访问支持，需同时配合公钥和CA证书\n* --with-zlib=                     #gzip模块需要 zlib 库\n* --add-module=/patch/nginx_upstream_check_module   #对后端服务器提供主动健康检查，自动failover\n\n这些模块，都是基于nginx源码编译安装并显式配置，才会生效，这要求我们的docker FROM镜像，需要支持C编译器环境。\n\n### 相关内容\nOpenResty 的目标是让你的Web服务直接跑在 Nginx 服务内部，充分利用 Nginx 的非阻塞 I/O 模型，不仅仅对 HTTP 客户端请求,甚至于对远程后端诸如 MySQL、PostgreSQL、Memcached 以及 Redis 等都进行一致的高性能响应。\n\nExample:利用OpenResty的可编程特性，结合Redis，实现实时统计网站的PV、UV的功能，非常的简单。\n\n不局限于Redis等,甚至于Kafka也可以，只要SDK提供对Lua语言的支持即可，简直是运维的春天\n\n## 动静分离\n动静分离，是指响应内容的动与静，分为动态计算的响应内容与静态不变的响应内容。如订单总数量计算是一个动态的，而网页logo图片是一个静态的。前者一般需要访问应用服务器，由程序来计算，而后者一般只需要nginx自身来处理。\n\n利用nginx提供的静态资源压缩传输、静态资源内存级缓存，我们可以将html文件、css文件、js文件等资源直接放在nginx所在的主机硬盘中，由nginx代理这些文件的get操作。\n\n受nginx代理的静态资源文件，应该具备如下特征：1.文件内容几乎不变化，如注册用户使用协议html，2.文件体积小，减轻压缩时对cpu的波动，以及缓存在内存的资源占用，3.文件属于热访问文件，比如Angular框架下的js文件。\n\n多个nginx节点，可以共享这些静态文件，利用网络磁盘共享技术，甚至可以在部署在多个物理机的nginx节点下进行共享。\n\n我们将可以直接将所有静态资源，按类型，放到文件夹：nginx/html/或nginx/static/下，这是立即生效的，不需要重启nginx。\n\n## 后端版本热升级\n\n### 兼容式热升级\n\n对于nginx后端部署的应用程序，需要进行版本升级时，我们可以这样做。\n* 1.前提假定\n\n* 1.1假设应用程序的新版本接口，是100%兼容旧版本的，即任何旧版本客户端在调用旧版本应用程序与新版本应用程序是无区别的，包括请求内容和响应内容。\n\n* 1.2假设nginx.conf中，upstream段，定义了3个tomcat服务器（A\\B\\C）。此时2个tomcat服务器运行着同一版本（即旧版本）的应用程序。\n\n\n* 2.升级步骤\n\n* 2.1选择在系统平峰期进行，避免流量冲击。\n\n* 2.2正常关闭A tomcat，在合理配置nginx的前提下，nginx监测到A机crash，此时会将流量转移到B\\C。若使用平均流量权重，此时若B\\C 2个机器的流量会各升高50%。\n\n* 2.3执行A tomcat的升级。\n\n* 2.4启动A tomcat，nginx监测到A机up，会将流量重新分配，此时各节点的流量恢复正常态。\n\n* 2.5依照以上步骤，再升级B\\C节点。\n\n\n整个过程不需要重启nginx，这意味着对外服务不需要中断。新版本可能存在不稳定，需要回退到旧版本，也是类似与以上步骤执行。\n\n### 非兼容式热升级\n\n非兼容式升级，是指新版本应用程序，对客户端的版本的要求比旧版本应用程序要高。例如客户端版本为1.0，旧版本应用程序为1.5，新版本应用程序为1.6。假定1.6版本对1.0版本的客户端不再提供支持，而1.5版本是可以支持1.0版本的客户端的。\n而1.5与1.6版本的客户端访问入口，都在同一个nginx的同一个端口。\n\n* 1.避免同时支持多个版本的客户端，需要有客户端强制升级的方案。\n\n* 2.客户端与应用程序通讯，需要定义一个客户端当前版本号，且该数据需要支持被nginx解析到。\n\n* 3.修改nginx配置，定义2个server节点，每个节点按照不同客户端版本路由到对应的后端应用程序中，即有一个客户端版本与后端应用程序版本的对照表。\n\n* 4.nginx做一下热加载nginx.conf，在下文中有提及。\n\n\n这种方案对于后端应用程序开发最为友好，只需要有不同分支版本进行并行维护即可，比如tag/V1.5/code、tag/V1.6/code，2个版本公有的bug修复时，需要做一个互相merge.\n\n## 自身热升级\n\nNginx自身的热升级，是指对Nginx进行模块维护或版本维护。\n\nNginx主进程在启动完成后会进入等待状态，负责响应各类系统消息，如SIGCHLD、SIGHUP、SIGUSR2等。\n\n* TERM, INT: 立刻退出\n* QUIT: 等待工作进程结束后再退出\n* KILL: 强制终止进程\n* HUP: 重新加载配置文件，使用新的配置启动工作进程，并逐步关闭旧进程。\n* USR1: 重新打开日志文件\n* USR2: 启动新的主进程，实现热升级\n* WINCH: 逐步关闭工作进程\n\n在docker容器内热升级nginx的步骤：\n* 1.向主进程发送USR2信号，Nginx会启动一个新版本的master进程和工作进程，和旧版一起处理请求\n\ndocker kill --signal=\"USR2\" <nginx container name or id>\n\n* 2.向原Nginx主进程发送WINCH信号，它会逐步关闭旗下的工作进程（主进程不退出），这时所有请求都会由新版Nginx处理\n\ndocker kill --signal=\"WINCH\" <nginx container name or id>\n\n* 3.如果这时需要回退，可向原Nginx主进程发送HUP信号，它会重新启动工作进程， 仍使用旧版配置文件 。尔后可以将新版Nginx进程杀死（使用QUIT、TERM、或者KILL）\n\ndocker kill --signal=\"TERM\" <nginx container name or id>\n\n## 热加载nginx.conf\n\n我们知道在upstream定义的tomcat节点，是属于文件性配置，如果需要上线新加节点，需要修改nginx.conf，然后需要重启Nginx读取新配置。如何热加载nginx.conf 而不需重启nginx？\n\ndocker exec -i -t <nginx container name or id> ./usr/local/nginx/sbin/nginx -s reload\n\n## 高可用方案\n\n使用Keepalived在多个nginx节点之间做互为主备配置，配置略过。\n\n## 负载均衡\n\n对后端tomcat的负载均衡，使用upstream，配置权重和max_fails等参数即可\n\n   # 设定负载均衡方式：RR模式\n    upstream  xws  {\n        server 192.168.1.188:6080 weight=1 max_fails=5 fail_timeout=10s ;\n        server 192.168.1.188:7080 weight=1 max_fails=5 fail_timeout=10s ;\n        check interval=3000 rise=2 fall=5 timeout=1000 type=http;\n    }\n\n## 对后端的健康管理\n\n使用nginx_upstream_check_module功能增强补丁\n\n配置location,开放后端tomcat的健康状况访问。\n\nhttp://your maintenance IP and Port/xw_TomcatStatus/\n\n## 自身的运行监控\n\n监控Nginx：http://your maintenance IP and Port/xw_NginxStatus/\n\n## Reference\n\n* 软件架构模式：http://colobu.com/2015/04/08/software-architecture-patterns/\n\n* Nginx简介：http://www.rowkey.me/blog/2014/08/27/nginx-loabbalance/\n\n* OpenResty + Redis 实时计算统计Web服务的UV & PV ：http://www.wtoutiao.com/p/109IT70.html\n","slug":"Nginx-with-docker-part-two","published":1,"updated":"2016-05-17T08:46:45.118Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ciowq3yuc00094cnnt7dgkkl6","content":"<h1 id=\"前言\"><a href=\"#前言\" class=\"headerlink\" title=\"前言\"></a>前言</h1><p>本文中的配置文件，已经整理到了GitHub：<a href=\"https://github.com/amao12580/docker\" target=\"_blank\" rel=\"external\">https://github.com/amao12580/docker</a></p>\n<p>本文假设读者对Nginx、Docker已经有了比较深入的了解，并掌握了docker-compose工具的使用。</p>\n<h2 id=\"高性能\"><a href=\"#高性能\" class=\"headerlink\" title=\"高性能\"></a>高性能</h2><p>Nginx是一款面向性能设计的HTTP服务器，相较于Apache、lighttpd具有占有内存少，稳定性高等优势。与旧版本（&lt;=2.2）的Apache不同，nginx不采用每客户机一线程的设计模型，而是充分使用异步逻辑，削减了上下文调度开销，所以并发服务能力更强。整体采用模块化设计，有丰富的模块库和第三方模块库，配置灵活。 在Linux操作系统下，nginx使用epoll事件模型，得益于此，nginx在Linux操作系统下效率相当高。同时Nginx在OpenBSD或FreeBSD操作系统上采用类似于epoll的高效事件模型kqueue。nginx同时是一个高性能的 HTTP 和 反向代理 服务器，也是一个 IMAP/POP3/SMTP 代理服务器。Nginx 已经因为它的稳定性、丰富的功能集、示例配置文件和低系统资源的消耗而闻名了。</p>\n<h2 id=\"可扩展\"><a href=\"#可扩展\" class=\"headerlink\" title=\"可扩展\"></a>可扩展</h2><p>Nginx属于典型的微内核设计，其内核非常简洁和优雅，同时具有非常高的可扩展性。</p>\n<p>Nginx是纯C语言的实现，其可扩展性在于其模块化的设计。目前，Nginx已经有很多的第三方模块，大大扩展了自身的功能。nginx_lua_module可以将Lua语言嵌入到Nginx配置中，从而利用Lua极大增强了Nginx本身的编程能力，甚至可以不用配合其它脚本语言（如PHP或Python等），只靠Nginx本身就可以实现复杂业务的处理。</p>\n<ul>\n<li>–with-http_realip_module        #获取真实IP模块</li>\n<li>–with-http_sub_module           #修改原始请求URI模块</li>\n<li>–with-http_flv_module           #对flv流媒体播放提供支持</li>\n<li>–with-http_dav_module           #启用对<a href=\"https://idoseek.com/1800\" target=\"_blank\" rel=\"external\">WebDav协议</a>的支持</li>\n<li>–with-http_gzip_static_module   #开启GZIP压缩，可以直接压缩html等静态资源。*.gz</li>\n<li>–with-http_stub_status_module   #提供对nginx自身状态的监控功能</li>\n<li>–with-http_addition_module      #过滤器模块， 在response数据的前/后添加文本</li>\n<li>–with-pcre=                     #正则表达式解析支持，支持Rewrite重写规则</li>\n<li>–with-openssl=                  #(part 1) HTTPS访问支持，需同时配合公钥和CA证书</li>\n<li>–with-http_ssl_module           #(part 2) HTTPS访问支持，需同时配合公钥和CA证书</li>\n<li>–with-zlib=                     #gzip模块需要 zlib 库</li>\n<li>–add-module=/patch/nginx_upstream_check_module   #对后端服务器提供主动健康检查，自动failover</li>\n</ul>\n<p>这些模块，都是基于nginx源码编译安装并显式配置，才会生效，这要求我们的docker FROM镜像，需要支持C编译器环境。</p>\n<h3 id=\"相关内容\"><a href=\"#相关内容\" class=\"headerlink\" title=\"相关内容\"></a>相关内容</h3><p>OpenResty 的目标是让你的Web服务直接跑在 Nginx 服务内部，充分利用 Nginx 的非阻塞 I/O 模型，不仅仅对 HTTP 客户端请求,甚至于对远程后端诸如 MySQL、PostgreSQL、Memcached 以及 Redis 等都进行一致的高性能响应。</p>\n<p>Example:利用OpenResty的可编程特性，结合Redis，实现实时统计网站的PV、UV的功能，非常的简单。</p>\n<p>不局限于Redis等,甚至于Kafka也可以，只要SDK提供对Lua语言的支持即可，简直是运维的春天</p>\n<h2 id=\"动静分离\"><a href=\"#动静分离\" class=\"headerlink\" title=\"动静分离\"></a>动静分离</h2><p>动静分离，是指响应内容的动与静，分为动态计算的响应内容与静态不变的响应内容。如订单总数量计算是一个动态的，而网页logo图片是一个静态的。前者一般需要访问应用服务器，由程序来计算，而后者一般只需要nginx自身来处理。</p>\n<p>利用nginx提供的静态资源压缩传输、静态资源内存级缓存，我们可以将html文件、css文件、js文件等资源直接放在nginx所在的主机硬盘中，由nginx代理这些文件的get操作。</p>\n<p>受nginx代理的静态资源文件，应该具备如下特征：1.文件内容几乎不变化，如注册用户使用协议html，2.文件体积小，减轻压缩时对cpu的波动，以及缓存在内存的资源占用，3.文件属于热访问文件，比如Angular框架下的js文件。</p>\n<p>多个nginx节点，可以共享这些静态文件，利用网络磁盘共享技术，甚至可以在部署在多个物理机的nginx节点下进行共享。</p>\n<p>我们将可以直接将所有静态资源，按类型，放到文件夹：nginx/html/或nginx/static/下，这是立即生效的，不需要重启nginx。</p>\n<h2 id=\"后端版本热升级\"><a href=\"#后端版本热升级\" class=\"headerlink\" title=\"后端版本热升级\"></a>后端版本热升级</h2><h3 id=\"兼容式热升级\"><a href=\"#兼容式热升级\" class=\"headerlink\" title=\"兼容式热升级\"></a>兼容式热升级</h3><p>对于nginx后端部署的应用程序，需要进行版本升级时，我们可以这样做。</p>\n<ul>\n<li><p>1.前提假定</p>\n</li>\n<li><p>1.1假设应用程序的新版本接口，是100%兼容旧版本的，即任何旧版本客户端在调用旧版本应用程序与新版本应用程序是无区别的，包括请求内容和响应内容。</p>\n</li>\n<li><p>1.2假设nginx.conf中，upstream段，定义了3个tomcat服务器（A\\B\\C）。此时2个tomcat服务器运行着同一版本（即旧版本）的应用程序。</p>\n</li>\n</ul>\n<ul>\n<li><p>2.升级步骤</p>\n</li>\n<li><p>2.1选择在系统平峰期进行，避免流量冲击。</p>\n</li>\n<li><p>2.2正常关闭A tomcat，在合理配置nginx的前提下，nginx监测到A机crash，此时会将流量转移到B\\C。若使用平均流量权重，此时若B\\C 2个机器的流量会各升高50%。</p>\n</li>\n<li><p>2.3执行A tomcat的升级。</p>\n</li>\n<li><p>2.4启动A tomcat，nginx监测到A机up，会将流量重新分配，此时各节点的流量恢复正常态。</p>\n</li>\n<li><p>2.5依照以上步骤，再升级B\\C节点。</p>\n</li>\n</ul>\n<p>整个过程不需要重启nginx，这意味着对外服务不需要中断。新版本可能存在不稳定，需要回退到旧版本，也是类似与以上步骤执行。</p>\n<h3 id=\"非兼容式热升级\"><a href=\"#非兼容式热升级\" class=\"headerlink\" title=\"非兼容式热升级\"></a>非兼容式热升级</h3><p>非兼容式升级，是指新版本应用程序，对客户端的版本的要求比旧版本应用程序要高。例如客户端版本为1.0，旧版本应用程序为1.5，新版本应用程序为1.6。假定1.6版本对1.0版本的客户端不再提供支持，而1.5版本是可以支持1.0版本的客户端的。<br>而1.5与1.6版本的客户端访问入口，都在同一个nginx的同一个端口。</p>\n<ul>\n<li><p>1.避免同时支持多个版本的客户端，需要有客户端强制升级的方案。</p>\n</li>\n<li><p>2.客户端与应用程序通讯，需要定义一个客户端当前版本号，且该数据需要支持被nginx解析到。</p>\n</li>\n<li><p>3.修改nginx配置，定义2个server节点，每个节点按照不同客户端版本路由到对应的后端应用程序中，即有一个客户端版本与后端应用程序版本的对照表。</p>\n</li>\n<li><p>4.nginx做一下热加载nginx.conf，在下文中有提及。</p>\n</li>\n</ul>\n<p>这种方案对于后端应用程序开发最为友好，只需要有不同分支版本进行并行维护即可，比如tag/V1.5/code、tag/V1.6/code，2个版本公有的bug修复时，需要做一个互相merge.</p>\n<h2 id=\"自身热升级\"><a href=\"#自身热升级\" class=\"headerlink\" title=\"自身热升级\"></a>自身热升级</h2><p>Nginx自身的热升级，是指对Nginx进行模块维护或版本维护。</p>\n<p>Nginx主进程在启动完成后会进入等待状态，负责响应各类系统消息，如SIGCHLD、SIGHUP、SIGUSR2等。</p>\n<ul>\n<li>TERM, INT: 立刻退出</li>\n<li>QUIT: 等待工作进程结束后再退出</li>\n<li>KILL: 强制终止进程</li>\n<li>HUP: 重新加载配置文件，使用新的配置启动工作进程，并逐步关闭旧进程。</li>\n<li>USR1: 重新打开日志文件</li>\n<li>USR2: 启动新的主进程，实现热升级</li>\n<li>WINCH: 逐步关闭工作进程</li>\n</ul>\n<p>在docker容器内热升级nginx的步骤：</p>\n<ul>\n<li>1.向主进程发送USR2信号，Nginx会启动一个新版本的master进程和工作进程，和旧版一起处理请求</li>\n</ul>\n<p>docker kill –signal=”USR2” <nginx container=\"\" name=\"\" or=\"\" id=\"\"></nginx></p>\n<ul>\n<li>2.向原Nginx主进程发送WINCH信号，它会逐步关闭旗下的工作进程（主进程不退出），这时所有请求都会由新版Nginx处理</li>\n</ul>\n<p>docker kill –signal=”WINCH” <nginx container=\"\" name=\"\" or=\"\" id=\"\"></nginx></p>\n<ul>\n<li>3.如果这时需要回退，可向原Nginx主进程发送HUP信号，它会重新启动工作进程， 仍使用旧版配置文件 。尔后可以将新版Nginx进程杀死（使用QUIT、TERM、或者KILL）</li>\n</ul>\n<p>docker kill –signal=”TERM” <nginx container=\"\" name=\"\" or=\"\" id=\"\"></nginx></p>\n<h2 id=\"热加载nginx-conf\"><a href=\"#热加载nginx-conf\" class=\"headerlink\" title=\"热加载nginx.conf\"></a>热加载nginx.conf</h2><p>我们知道在upstream定义的tomcat节点，是属于文件性配置，如果需要上线新加节点，需要修改nginx.conf，然后需要重启Nginx读取新配置。如何热加载nginx.conf 而不需重启nginx？</p>\n<p>docker exec -i -t <nginx container=\"\" name=\"\" or=\"\" id=\"\"> ./usr/local/nginx/sbin/nginx -s reload</nginx></p>\n<h2 id=\"高可用方案\"><a href=\"#高可用方案\" class=\"headerlink\" title=\"高可用方案\"></a>高可用方案</h2><p>使用Keepalived在多个nginx节点之间做互为主备配置，配置略过。</p>\n<h2 id=\"负载均衡\"><a href=\"#负载均衡\" class=\"headerlink\" title=\"负载均衡\"></a>负载均衡</h2><p>对后端tomcat的负载均衡，使用upstream，配置权重和max_fails等参数即可</p>\n<h1 id=\"设定负载均衡方式：RR模式\"><a href=\"#设定负载均衡方式：RR模式\" class=\"headerlink\" title=\"设定负载均衡方式：RR模式\"></a>设定负载均衡方式：RR模式</h1><pre><code>upstream  xws  {\n    server 192.168.1.188:6080 weight=1 max_fails=5 fail_timeout=10s ;\n    server 192.168.1.188:7080 weight=1 max_fails=5 fail_timeout=10s ;\n    check interval=3000 rise=2 fall=5 timeout=1000 type=http;\n}\n</code></pre><h2 id=\"对后端的健康管理\"><a href=\"#对后端的健康管理\" class=\"headerlink\" title=\"对后端的健康管理\"></a>对后端的健康管理</h2><p>使用nginx_upstream_check_module功能增强补丁</p>\n<p>配置location,开放后端tomcat的健康状况访问。</p>\n<p><a href=\"http://your\" target=\"_blank\" rel=\"external\">http://your</a> maintenance IP and Port/xw_TomcatStatus/</p>\n<h2 id=\"自身的运行监控\"><a href=\"#自身的运行监控\" class=\"headerlink\" title=\"自身的运行监控\"></a>自身的运行监控</h2><p>监控Nginx：<a href=\"http://your\" target=\"_blank\" rel=\"external\">http://your</a> maintenance IP and Port/xw_NginxStatus/</p>\n<h2 id=\"Reference\"><a href=\"#Reference\" class=\"headerlink\" title=\"Reference\"></a>Reference</h2><ul>\n<li><p>软件架构模式：<a href=\"http://colobu.com/2015/04/08/software-architecture-patterns/\" target=\"_blank\" rel=\"external\">http://colobu.com/2015/04/08/software-architecture-patterns/</a></p>\n</li>\n<li><p>Nginx简介：<a href=\"http://www.rowkey.me/blog/2014/08/27/nginx-loabbalance/\" target=\"_blank\" rel=\"external\">http://www.rowkey.me/blog/2014/08/27/nginx-loabbalance/</a></p>\n</li>\n<li><p>OpenResty + Redis 实时计算统计Web服务的UV &amp; PV ：<a href=\"http://www.wtoutiao.com/p/109IT70.html\" target=\"_blank\" rel=\"external\">http://www.wtoutiao.com/p/109IT70.html</a></p>\n</li>\n</ul>\n","excerpt":"","more":"<h1 id=\"前言\"><a href=\"#前言\" class=\"headerlink\" title=\"前言\"></a>前言</h1><p>本文中的配置文件，已经整理到了GitHub：<a href=\"https://github.com/amao12580/docker\">https://github.com/amao12580/docker</a></p>\n<p>本文假设读者对Nginx、Docker已经有了比较深入的了解，并掌握了docker-compose工具的使用。</p>\n<h2 id=\"高性能\"><a href=\"#高性能\" class=\"headerlink\" title=\"高性能\"></a>高性能</h2><p>Nginx是一款面向性能设计的HTTP服务器，相较于Apache、lighttpd具有占有内存少，稳定性高等优势。与旧版本（&lt;=2.2）的Apache不同，nginx不采用每客户机一线程的设计模型，而是充分使用异步逻辑，削减了上下文调度开销，所以并发服务能力更强。整体采用模块化设计，有丰富的模块库和第三方模块库，配置灵活。 在Linux操作系统下，nginx使用epoll事件模型，得益于此，nginx在Linux操作系统下效率相当高。同时Nginx在OpenBSD或FreeBSD操作系统上采用类似于epoll的高效事件模型kqueue。nginx同时是一个高性能的 HTTP 和 反向代理 服务器，也是一个 IMAP/POP3/SMTP 代理服务器。Nginx 已经因为它的稳定性、丰富的功能集、示例配置文件和低系统资源的消耗而闻名了。</p>\n<h2 id=\"可扩展\"><a href=\"#可扩展\" class=\"headerlink\" title=\"可扩展\"></a>可扩展</h2><p>Nginx属于典型的微内核设计，其内核非常简洁和优雅，同时具有非常高的可扩展性。</p>\n<p>Nginx是纯C语言的实现，其可扩展性在于其模块化的设计。目前，Nginx已经有很多的第三方模块，大大扩展了自身的功能。nginx_lua_module可以将Lua语言嵌入到Nginx配置中，从而利用Lua极大增强了Nginx本身的编程能力，甚至可以不用配合其它脚本语言（如PHP或Python等），只靠Nginx本身就可以实现复杂业务的处理。</p>\n<ul>\n<li>–with-http_realip_module        #获取真实IP模块</li>\n<li>–with-http_sub_module           #修改原始请求URI模块</li>\n<li>–with-http_flv_module           #对flv流媒体播放提供支持</li>\n<li>–with-http_dav_module           #启用对<a href=\"https://idoseek.com/1800\">WebDav协议</a>的支持</li>\n<li>–with-http_gzip_static_module   #开启GZIP压缩，可以直接压缩html等静态资源。*.gz</li>\n<li>–with-http_stub_status_module   #提供对nginx自身状态的监控功能</li>\n<li>–with-http_addition_module      #过滤器模块， 在response数据的前/后添加文本</li>\n<li>–with-pcre=                     #正则表达式解析支持，支持Rewrite重写规则</li>\n<li>–with-openssl=                  #(part 1) HTTPS访问支持，需同时配合公钥和CA证书</li>\n<li>–with-http_ssl_module           #(part 2) HTTPS访问支持，需同时配合公钥和CA证书</li>\n<li>–with-zlib=                     #gzip模块需要 zlib 库</li>\n<li>–add-module=/patch/nginx_upstream_check_module   #对后端服务器提供主动健康检查，自动failover</li>\n</ul>\n<p>这些模块，都是基于nginx源码编译安装并显式配置，才会生效，这要求我们的docker FROM镜像，需要支持C编译器环境。</p>\n<h3 id=\"相关内容\"><a href=\"#相关内容\" class=\"headerlink\" title=\"相关内容\"></a>相关内容</h3><p>OpenResty 的目标是让你的Web服务直接跑在 Nginx 服务内部，充分利用 Nginx 的非阻塞 I/O 模型，不仅仅对 HTTP 客户端请求,甚至于对远程后端诸如 MySQL、PostgreSQL、Memcached 以及 Redis 等都进行一致的高性能响应。</p>\n<p>Example:利用OpenResty的可编程特性，结合Redis，实现实时统计网站的PV、UV的功能，非常的简单。</p>\n<p>不局限于Redis等,甚至于Kafka也可以，只要SDK提供对Lua语言的支持即可，简直是运维的春天</p>\n<h2 id=\"动静分离\"><a href=\"#动静分离\" class=\"headerlink\" title=\"动静分离\"></a>动静分离</h2><p>动静分离，是指响应内容的动与静，分为动态计算的响应内容与静态不变的响应内容。如订单总数量计算是一个动态的，而网页logo图片是一个静态的。前者一般需要访问应用服务器，由程序来计算，而后者一般只需要nginx自身来处理。</p>\n<p>利用nginx提供的静态资源压缩传输、静态资源内存级缓存，我们可以将html文件、css文件、js文件等资源直接放在nginx所在的主机硬盘中，由nginx代理这些文件的get操作。</p>\n<p>受nginx代理的静态资源文件，应该具备如下特征：1.文件内容几乎不变化，如注册用户使用协议html，2.文件体积小，减轻压缩时对cpu的波动，以及缓存在内存的资源占用，3.文件属于热访问文件，比如Angular框架下的js文件。</p>\n<p>多个nginx节点，可以共享这些静态文件，利用网络磁盘共享技术，甚至可以在部署在多个物理机的nginx节点下进行共享。</p>\n<p>我们将可以直接将所有静态资源，按类型，放到文件夹：nginx/html/或nginx/static/下，这是立即生效的，不需要重启nginx。</p>\n<h2 id=\"后端版本热升级\"><a href=\"#后端版本热升级\" class=\"headerlink\" title=\"后端版本热升级\"></a>后端版本热升级</h2><h3 id=\"兼容式热升级\"><a href=\"#兼容式热升级\" class=\"headerlink\" title=\"兼容式热升级\"></a>兼容式热升级</h3><p>对于nginx后端部署的应用程序，需要进行版本升级时，我们可以这样做。</p>\n<ul>\n<li><p>1.前提假定</p>\n</li>\n<li><p>1.1假设应用程序的新版本接口，是100%兼容旧版本的，即任何旧版本客户端在调用旧版本应用程序与新版本应用程序是无区别的，包括请求内容和响应内容。</p>\n</li>\n<li><p>1.2假设nginx.conf中，upstream段，定义了3个tomcat服务器（A\\B\\C）。此时2个tomcat服务器运行着同一版本（即旧版本）的应用程序。</p>\n</li>\n</ul>\n<ul>\n<li><p>2.升级步骤</p>\n</li>\n<li><p>2.1选择在系统平峰期进行，避免流量冲击。</p>\n</li>\n<li><p>2.2正常关闭A tomcat，在合理配置nginx的前提下，nginx监测到A机crash，此时会将流量转移到B\\C。若使用平均流量权重，此时若B\\C 2个机器的流量会各升高50%。</p>\n</li>\n<li><p>2.3执行A tomcat的升级。</p>\n</li>\n<li><p>2.4启动A tomcat，nginx监测到A机up，会将流量重新分配，此时各节点的流量恢复正常态。</p>\n</li>\n<li><p>2.5依照以上步骤，再升级B\\C节点。</p>\n</li>\n</ul>\n<p>整个过程不需要重启nginx，这意味着对外服务不需要中断。新版本可能存在不稳定，需要回退到旧版本，也是类似与以上步骤执行。</p>\n<h3 id=\"非兼容式热升级\"><a href=\"#非兼容式热升级\" class=\"headerlink\" title=\"非兼容式热升级\"></a>非兼容式热升级</h3><p>非兼容式升级，是指新版本应用程序，对客户端的版本的要求比旧版本应用程序要高。例如客户端版本为1.0，旧版本应用程序为1.5，新版本应用程序为1.6。假定1.6版本对1.0版本的客户端不再提供支持，而1.5版本是可以支持1.0版本的客户端的。<br>而1.5与1.6版本的客户端访问入口，都在同一个nginx的同一个端口。</p>\n<ul>\n<li><p>1.避免同时支持多个版本的客户端，需要有客户端强制升级的方案。</p>\n</li>\n<li><p>2.客户端与应用程序通讯，需要定义一个客户端当前版本号，且该数据需要支持被nginx解析到。</p>\n</li>\n<li><p>3.修改nginx配置，定义2个server节点，每个节点按照不同客户端版本路由到对应的后端应用程序中，即有一个客户端版本与后端应用程序版本的对照表。</p>\n</li>\n<li><p>4.nginx做一下热加载nginx.conf，在下文中有提及。</p>\n</li>\n</ul>\n<p>这种方案对于后端应用程序开发最为友好，只需要有不同分支版本进行并行维护即可，比如tag/V1.5/code、tag/V1.6/code，2个版本公有的bug修复时，需要做一个互相merge.</p>\n<h2 id=\"自身热升级\"><a href=\"#自身热升级\" class=\"headerlink\" title=\"自身热升级\"></a>自身热升级</h2><p>Nginx自身的热升级，是指对Nginx进行模块维护或版本维护。</p>\n<p>Nginx主进程在启动完成后会进入等待状态，负责响应各类系统消息，如SIGCHLD、SIGHUP、SIGUSR2等。</p>\n<ul>\n<li>TERM, INT: 立刻退出</li>\n<li>QUIT: 等待工作进程结束后再退出</li>\n<li>KILL: 强制终止进程</li>\n<li>HUP: 重新加载配置文件，使用新的配置启动工作进程，并逐步关闭旧进程。</li>\n<li>USR1: 重新打开日志文件</li>\n<li>USR2: 启动新的主进程，实现热升级</li>\n<li>WINCH: 逐步关闭工作进程</li>\n</ul>\n<p>在docker容器内热升级nginx的步骤：</p>\n<ul>\n<li>1.向主进程发送USR2信号，Nginx会启动一个新版本的master进程和工作进程，和旧版一起处理请求</li>\n</ul>\n<p>docker kill –signal=”USR2” <nginx container name or id></p>\n<ul>\n<li>2.向原Nginx主进程发送WINCH信号，它会逐步关闭旗下的工作进程（主进程不退出），这时所有请求都会由新版Nginx处理</li>\n</ul>\n<p>docker kill –signal=”WINCH” <nginx container name or id></p>\n<ul>\n<li>3.如果这时需要回退，可向原Nginx主进程发送HUP信号，它会重新启动工作进程， 仍使用旧版配置文件 。尔后可以将新版Nginx进程杀死（使用QUIT、TERM、或者KILL）</li>\n</ul>\n<p>docker kill –signal=”TERM” <nginx container name or id></p>\n<h2 id=\"热加载nginx-conf\"><a href=\"#热加载nginx-conf\" class=\"headerlink\" title=\"热加载nginx.conf\"></a>热加载nginx.conf</h2><p>我们知道在upstream定义的tomcat节点，是属于文件性配置，如果需要上线新加节点，需要修改nginx.conf，然后需要重启Nginx读取新配置。如何热加载nginx.conf 而不需重启nginx？</p>\n<p>docker exec -i -t <nginx container name or id> ./usr/local/nginx/sbin/nginx -s reload</p>\n<h2 id=\"高可用方案\"><a href=\"#高可用方案\" class=\"headerlink\" title=\"高可用方案\"></a>高可用方案</h2><p>使用Keepalived在多个nginx节点之间做互为主备配置，配置略过。</p>\n<h2 id=\"负载均衡\"><a href=\"#负载均衡\" class=\"headerlink\" title=\"负载均衡\"></a>负载均衡</h2><p>对后端tomcat的负载均衡，使用upstream，配置权重和max_fails等参数即可</p>\n<h1 id=\"设定负载均衡方式：RR模式\"><a href=\"#设定负载均衡方式：RR模式\" class=\"headerlink\" title=\"设定负载均衡方式：RR模式\"></a>设定负载均衡方式：RR模式</h1><pre><code>upstream  xws  {\n    server 192.168.1.188:6080 weight=1 max_fails=5 fail_timeout=10s ;\n    server 192.168.1.188:7080 weight=1 max_fails=5 fail_timeout=10s ;\n    check interval=3000 rise=2 fall=5 timeout=1000 type=http;\n}\n</code></pre><h2 id=\"对后端的健康管理\"><a href=\"#对后端的健康管理\" class=\"headerlink\" title=\"对后端的健康管理\"></a>对后端的健康管理</h2><p>使用nginx_upstream_check_module功能增强补丁</p>\n<p>配置location,开放后端tomcat的健康状况访问。</p>\n<p><a href=\"http://your\">http://your</a> maintenance IP and Port/xw_TomcatStatus/</p>\n<h2 id=\"自身的运行监控\"><a href=\"#自身的运行监控\" class=\"headerlink\" title=\"自身的运行监控\"></a>自身的运行监控</h2><p>监控Nginx：<a href=\"http://your\">http://your</a> maintenance IP and Port/xw_NginxStatus/</p>\n<h2 id=\"Reference\"><a href=\"#Reference\" class=\"headerlink\" title=\"Reference\"></a>Reference</h2><ul>\n<li><p>软件架构模式：<a href=\"http://colobu.com/2015/04/08/software-architecture-patterns/\">http://colobu.com/2015/04/08/software-architecture-patterns/</a></p>\n</li>\n<li><p>Nginx简介：<a href=\"http://www.rowkey.me/blog/2014/08/27/nginx-loabbalance/\">http://www.rowkey.me/blog/2014/08/27/nginx-loabbalance/</a></p>\n</li>\n<li><p>OpenResty + Redis 实时计算统计Web服务的UV &amp; PV ：<a href=\"http://www.wtoutiao.com/p/109IT70.html\">http://www.wtoutiao.com/p/109IT70.html</a></p>\n</li>\n</ul>\n"},{"title":"Nginx与Tomcat 8在Docker环境的反向代理配置过程","date":"2016-04-08T06:49:32.000Z","description":"在Nginx配置时，针对不同的使用环境，配置的参数有很多不同。迫在眉睫的，我们需要先对线上的API服务系统进行反向代理与负载均衡配置。API服务系统是面向手机APP的接口系统，使用HTTP Restful+json进行数据通讯。","_content":"# 需要做什么？\n最近接到的任务是:在Docker环境下，Nginx与Tomcat的反向代理与负载均衡配置。先拿出可行性方案，以便在业务量突发时，在线上环境实施。典型的技术预研，打有准备仗。同时还提出了安全需求，在配置上，需要有安全加固。\n\n在Nginx配置时，针对不同的使用环境，配置的参数有很多不同。迫在眉睫的，我们需要先对线上的API服务系统进行反向代理与负载均衡配置。API服务系统是面向手机APP的接口系统，使用HTTP Restful+json进行数据通讯。\n\n我们在局域网环境下，有2台机器在软硬件配置方面，与线上的API服务系统类似。这2台机器的局域网IP分别是：192.168.1.158(简称为：158机器)、192.168.1.188(简称为：188机器)。由于188机器正在做压力测试，而且近期需要持续的对所有接口进行压力测试，没有办法空闲出来做实验。所以在实验之初我使用了158机器的普通账号进行，很快就因为权限不足，遭遇了很多莫名其妙的问题，而且158的使用量比较多，主要作为功能测试的机器。\n\n随后与PM沟通，延后了188机器的压力测试计划，拿到了权限比较高的账号，但还不是root账户。下面会说到如何在普通账户下，使用root账户执行shell命令。\n\n# Docker with Tomcat\n为了模拟线上真实环境，我们在188机器上搭建了docker环境。docker是借助Linux container(简称LXC)技术的轻量级可移植运行时环境，这意味着在docker中完成的软件运行时环境搭建后，可以移植到任意一台支持docker运行的机器上，功能上不会有任何的丢失。这有点像Java开发中的JVM，都是解决在不同环境下软件运行的问题。docker更多的提供了资源共享和资源隔离的机制，容器之间本身是隔离互不干扰的，但提供配置允许不同容器之间交换数据，开放对外端口；同时可以限制某个容器对宿主机的资源占用，如cpu、内存、io等等。\n\n为了方便，低成本，我们使用docker hub上的tomcat镜像：tomcat:8-jre8。在后续的实验中，我们需要2个tomcat作为后端应用服务器来处理实际的HTTP请求。\n```\nFROM tomcat:8-jre8\n\nRUN mkdir /root/downloadAppBase\n```\n# Nginx VS Tengine\n在技术选项时，我们遇到Nginx以及衍生产品Tengine。Nginx是俄罗斯人编写的一款轻量级的Web 服务器/反向代理服务器，它还具备邮件服务器的功能。我们在[Nginx官网](http://nginx.org/en/download.html)上查询发布日志，发现更新的比较频繁。仅在2016年前4月，就出现了2个比较大的版本：1.8.*、1.9.14。Tengine是由淘宝在官方nginx基础之上进行改进的版本，做了很多功能增强，最后一次的版本发布是：2015-12-31：Tengine-2.1.2,此版本仅兼容官方Nginx的1.6.2版本，该版本发布于：2014年9月16日。这也太久了，可能会错过很多官方更新。\n\n# 安装与配置\n```\n准备工作\ncd /home/www/\nmkdir nginx\ncd nginx/\nmkdir nginx\nmkdir zlib\nmkdir openssl\nmkdir pcre\n\nsudo apt-get update\n\n如果没有安装gcc/gcc-c++，请执行：sudo apt-get install build-essential\n如果没有安装make，请执行：sudo apt-get install make\n\nStep 1：编译安装Pcre包 (rewrite模块需要 pcre 库)\n1.软件位于/software/pcre-8.38.tar.gz\n2.拷贝软件到目标机器\"/home/www/nginx/pcre/\"目录\n3.顺序执行以下脚本\n\ncd /home/www/nginx/pcre/\ntar -xzvf pcre-8.38.tar.gz\ncd pcre-8.38/\n./configure\nsudo make\n#有可能需要输入密码\nsudo make install\n\n\n\nStep 2：编译安装Zlib (gzip模块需要 zlib 库)\n1.软件位于/software/zlib-1.2.8.tar.gz\n2.拷贝软件到目标机器\"/home/www/nginx/zlib/\"目录\n3.顺序执行以下脚本\n\ncd /home/www/nginx/zlib/\ntar -xzvf zlib-1.2.8.tar.gz\ncd zlib-1.2.8/\n./configure\nsudo make\n#有可能需要输入密码\nsudo make install\n\nStep 2：编译安装OpenSSL (ssl 功能需要openssl库)\n1.软件位于/software/openssl-1.1.0-pre4.tar.gz\n2.拷贝软件到目标机器\"/home/www/nginx/openssl/\"目录\n3.顺序执行以下脚本\n\ncd /home/www/nginx/openssl/\ntar -xzvf openssl-1.1.0-pre4.tar.gz\ncd openssl-1.1.0-pre4/\n./config\nsudo make\n#命令执行时间超过5分钟，耐心等待\nsudo make install\n#命令执行时间超过5分钟，耐心等待\n\nStep 3：编译安装Nginx\n1.软件位于/software/nginx-1.9.14.tar.gz\n2.拷贝软件到目标机器\"/home/www/nginx/nginx/\"目录\n3.顺序执行以下脚本\n\ncd /home/www/nginx/nginx/\ntar -xzvf nginx-1.9.14.tar.gz\ncd nginx-1.9.14/\n\nsed -i -e 's/1.9.14//g' -e 's/nginx\\//ERROR/g' -e 's/\"NGINX\"/\"ERROR\"/g' src/core/nginx.h\n\n./configure --prefix=/home/www/nginx/nginx --with-http_realip_module --with-http_sub_module --with-http_flv_module --with-http_dav_module --with-http_gzip_static_module --with-http_stub_status_module --with-http_addition_module --with-pcre=/home/www/nginx/pcre/pcre-8.38 --with-openssl=/home/www/nginx/openssl/openssl-1.1.0-pre4 --with-http_ssl_module --with-zlib=/home/www/nginx/zlib/zlib-1.2.8\n\nsudo make\n#命令执行时间超过5分钟，耐心等待\nsudo make install\n\nStep 4：安装补丁(对应用服务器进行监控)\ncd /home/www/nginx/nginx/\nmkdir patch\n补丁文件位于/software/patch目录，拷贝目录下的所有文件到：/home/www/nginx/nginx/patch/\ncd /home/www/nginx/nginx/nginx-1.9.14/src/\npatch -p1 < /home/www/nginx/nginx/patch/nginx_upstream_check_module-master/check_1.9.2+.patch\ncd ..\n./configure --prefix=/home/www/nginx/nginx --with-http_realip_module --with-http_sub_module --with-http_flv_module --with-http_dav_module --with-http_gzip_static_module --with-http_stub_status_module --with-http_addition_module --with-pcre=/home/www/nginx/pcre/pcre-8.38 --with-openssl=/home/www/nginx/openssl/openssl-1.1.0-pre4 --with-http_ssl_module --with-zlib=/home/www/nginx/zlib/zlib-1.2.8 --add-module=/home/www/nginx/nginx/patch/nginx_upstream_check_module-master/\nsudo make\n#命令执行时间超过5分钟，耐心等待\nsudo make install\ncd /home/www/nginx/nginx/sbin/\nsudo rm -f nginx.old\n\nStep 5：配置\n配置文件位于：conf/nginx.conf\n将该文件拷贝到：/home/www/nginx/nginx/conf/目录下，遇到文件已存在时，直接覆盖。\n\n确保可以访问到后端tomcat开放的端口，telnet\n修改配置文件nginx.conf,“upstream  xws”改为实际的tomcat运行环境\n\ncd /home/www/nginx/nginx/\nmkdir ssl\ncd ssl\nSSL证书文件位于：ssl/www.abcde.com.crt，ssl/www.abcde.com.key\n将这2个文件拷贝到/home/www/nginx/nginx/ssl/目录下\n\nStep 6：运行\n确保系统的80、443端口处于空闲状态。netstat\n确保/home/www/nginx/nginx/logs/目录具备读写权限。\n确保/home/www/nginx/nginx/ssl/www.abcde.com.crt具备读权限。\n确保/home/www/nginx/nginx/ssl/www.abcde.com.key具备读权限。\n确保/home/www/nginx/nginx/sbin/nginx文件具备可执行权限。\n\ncd /home/www/nginx/nginx/sbin/\nsudo ./nginx\n\nStep 7：验证\n1.pcre包安装的正确性\n\ncd /home/www/nginx/pcre/\n./pcre-config --version\n有版本号输出则安装成功。\n\n2.openssl包安装的正确性\ncd /home/www/nginx/openssl/openssl-1.1.0-pre4/\nopenssl version –a\n有版本号输出则安装成功。\n\n3.nginx包安装的正确性\ncd /home/www/nginx/nginx/nginx-1.9.14/objs\n./nginx -V\n##也可以使用：./nginx -t\n有配置详情输出则安装成功。\n\n卸载\n1.停止nginx的运行\ncd /home/www/nginx/nginx/sbin/\nsudo ./nginx -s stop\n\n2.删除文件\ncd /home/www/\nrm -rf nginx\n\n\n监控\n进入到与nginx部署机器的局域网络\n浏览器访问：http://nginx主机的局域网ip/nginxStatus/\n```\n\n贴出nginx.cof\n\n```\n#你所看到的这个文件，是nginx的工作配置文件，不要轻易改动。\n\nworker_processes  4;\nerror_log  logs/error.log;\npid        logs/nginx.pid;\nworker_rlimit_nofile 65535;\n\nevents {\n    use epoll;\n    worker_connections  65535;\n}\n\nhttp {\n    include       mime.types;\n    default_type  application/octet-stream;\n    server_tokens off;\n    tcp_nopush on;\n    tcp_nodelay on;\n    client_body_timeout   10;\n    client_header_timeout  30;\n    keepalive_timeout     30  30;\n\n    log_format  main  '$remote_addr - $remote_user [$time_local] \"$request\" '\n                      '$status $body_bytes_sent \"$http_referer\" '\n                      '\"$http_user_agent\" \"$http_x_forwarded_for\"';\n\n    sendfile on;\n    send_timeout 10;\n    client_body_buffer_size  64K;\n    client_header_buffer_size  128k;\n    client_max_body_size  10m;\n    large_client_header_buffers  4  128k;\n\n  # gzip压缩功能设置\n    gzip on;\n    gzip_min_length 1k;\n    gzip_buffers    4 16k;\n    gzip_http_version 1.0;\n    gzip_comp_level 6;\n    gzip_types text/plain text/css text/javascript application/json application/javascript application/x-javascript application/xml;\n    gzip_vary on;\n\n    #设置单个IP在每秒请求数不能超过20次\n    limit_req_zone $binary_remote_addr zone=one:20m rate=20r/s;\n\n    #设置单个IP同时连接数\n    limit_conn_zone $binary_remote_addr zone=addr:20m;\n\n    ssl_session_cache shared:SSL:10m;\n    ssl_session_timeout 10m;\n\n  # 设定负载均衡方式：RR模式\n    upstream  xws  {\n        server 127.0.0.1:6080 weight=1 max_fails=5 fail_timeout=10s ;\n        server 127.0.0.1:7080 weight=1 max_fails=5 fail_timeout=10s ;\n        check interval=3000 rise=2 fall=5 timeout=1000 type=http;\n    }\n\n  # 虚拟主机配置\n    server {\n        listen 80 default_server;\n        #root   /apps/oaapp;\n\n        listen 443 ssl default_server;\n        server_name www.abcde.com;\n        ssl_certificate  /home/www/nginx/nginx/ssl/yourCAcrt.crt;\n        ssl_certificate_key  /home/www/nginx/nginx/ssl/yourCAkey.key;\n        ssl_session_timeout  10m;\n        ssl_protocols TLSv1 TLSv1.1 TLSv1.2;\n        ssl_ciphers \"ECDHE-RSA-AES256-GCM-SHA384:ECDHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-SHA384:ECDHE-RSA-AES128-SHA256:ECDHE-RSA-AES256-SHA:ECDHE-RSA-AES128-SHA:DHE-RSA-AES256-SHA256:DHE-RSA-AES128-SHA256:DHE-RSA-AES256-SHA:DHE-RSA-AES128-SHA:ECDHE-RSA-DES-CBC3-SHA:EDH-RSA-DES-CBC3-SHA:AES256-GCM-SHA384:AES128-GCM-SHA256:AES256-SHA256:AES128-SHA256:AES256-SHA:AES128-SHA:DES-CBC3-SHA:HIGH:!aNULL:!eNULL:!EXPORT:!DES:!MD5:!PSK:!RC4\";\n        ssl_prefer_server_ciphers on;\n\n        charset utf-8;\n        access_log  logs/xws.access.log  main;\n\n        if ($request_method !~ ^(GET|HEAD|POST)$) {\n            return 404;\n        }\n\n        #对所有URL做负载均衡+反向代理\n        location / {\n            #root   /apps/oaapp;\n            #index  index.jsp index.html index.htm;\n            proxy_pass http://xws;\n            proxy_redirect off;\n            # 后端的Web服务器可以通过X-Forwarded-For获取用户真实IP\n            proxy_set_header  Host  $host;\n            proxy_set_header  X-Real-IP  $remote_addr;\n            proxy_set_header  X-Forwarded-For  $proxy_add_x_forwarded_for;\n            proxy_next_upstream error timeout invalid_header http_500 http_502 http_503 http_504;\n\n            limit_conn addr 2;\n            limit_req zone=one burst=5 nodelay;\n        }\n\n        #静态文件，nginx自己处理，不去backend请求tomcat\n        #location  ~* /download/ {\n        #    root /apps/oa/fs;\n\n        #}\n\n        #location ~ .*\\.(gif|jpg|jpeg|bmp|png|ico|txt|js|css)$\n        #{\n        #    root /apps/oaapp;\n        #    expires      7d;\n        #}\n\n        # 为内网IP开放nginx状态监控\n        location /nginxStatus {\n            stub_status on;\n            access_log off;\n            allow 192.168.1.0/24;\n            deny all;\n        }\n\n        location ~ ^/(WEB-INF)/ {\n            deny all;\n        }\n        #error_page 404              /404.html;\n        error_page 500 502 503 504  /50x.html;\n        location = /50x.html {\n            root   html;\n        }\n    }\n\n}\n```\n\n# 踩到的一些坑\n\n## 400 \\x16\\x03\n同一个server节点，配置：\n```\nlisten 80 default_server;\nlisten 443 ssl default_server;\n```\n## 调试Https\n如果CA证书签发的域名是：www.abcde.com，为了在线下调试，假设将nginx部署在局域网IP：192.168.1.188，我们可以将本机的hosts文件修改一下，文件位于：C:\\Windows\\System32\\drivers\\etc\\hosts。加上一行记录：“192.168.1.188 www.abcde.com”，保存后退出。再到本机的cmd命令行输入：ipconfig flushdns，退出cmd。等待几分钟后，在浏览器输入：https://www.abcde.com，即可在局域网调试啦！\n## ssl_protocols\n如果nginx.conf在定义ssl_protocols时，用了一些比较过时的协议，比如：SSLV3，则会被chrome提示连接不安全。可以参考我的nginx.conf配置，事实上这些过时的协议都有一些可以被利用的漏洞，建议不要使用了。","source":"_posts/Remember-a-reverse-proxy-configuration-process-for-nginx-and-Tomcat-in-the-docker-environment.md","raw":"---\ntitle: Nginx与Tomcat 8在Docker环境的反向代理配置过程\ndate: 2016-04-08 14:49:32\ntags:\n    - Nginx\n    - Tomcat\n    - Docker\n    - SSL\n    - Load balance\ncategories:\n    - Record\ndescription: 在Nginx配置时，针对不同的使用环境，配置的参数有很多不同。迫在眉睫的，我们需要先对线上的API服务系统进行反向代理与负载均衡配置。API服务系统是面向手机APP的接口系统，使用HTTP Restful+json进行数据通讯。\n---\n# 需要做什么？\n最近接到的任务是:在Docker环境下，Nginx与Tomcat的反向代理与负载均衡配置。先拿出可行性方案，以便在业务量突发时，在线上环境实施。典型的技术预研，打有准备仗。同时还提出了安全需求，在配置上，需要有安全加固。\n\n在Nginx配置时，针对不同的使用环境，配置的参数有很多不同。迫在眉睫的，我们需要先对线上的API服务系统进行反向代理与负载均衡配置。API服务系统是面向手机APP的接口系统，使用HTTP Restful+json进行数据通讯。\n\n我们在局域网环境下，有2台机器在软硬件配置方面，与线上的API服务系统类似。这2台机器的局域网IP分别是：192.168.1.158(简称为：158机器)、192.168.1.188(简称为：188机器)。由于188机器正在做压力测试，而且近期需要持续的对所有接口进行压力测试，没有办法空闲出来做实验。所以在实验之初我使用了158机器的普通账号进行，很快就因为权限不足，遭遇了很多莫名其妙的问题，而且158的使用量比较多，主要作为功能测试的机器。\n\n随后与PM沟通，延后了188机器的压力测试计划，拿到了权限比较高的账号，但还不是root账户。下面会说到如何在普通账户下，使用root账户执行shell命令。\n\n# Docker with Tomcat\n为了模拟线上真实环境，我们在188机器上搭建了docker环境。docker是借助Linux container(简称LXC)技术的轻量级可移植运行时环境，这意味着在docker中完成的软件运行时环境搭建后，可以移植到任意一台支持docker运行的机器上，功能上不会有任何的丢失。这有点像Java开发中的JVM，都是解决在不同环境下软件运行的问题。docker更多的提供了资源共享和资源隔离的机制，容器之间本身是隔离互不干扰的，但提供配置允许不同容器之间交换数据，开放对外端口；同时可以限制某个容器对宿主机的资源占用，如cpu、内存、io等等。\n\n为了方便，低成本，我们使用docker hub上的tomcat镜像：tomcat:8-jre8。在后续的实验中，我们需要2个tomcat作为后端应用服务器来处理实际的HTTP请求。\n```\nFROM tomcat:8-jre8\n\nRUN mkdir /root/downloadAppBase\n```\n# Nginx VS Tengine\n在技术选项时，我们遇到Nginx以及衍生产品Tengine。Nginx是俄罗斯人编写的一款轻量级的Web 服务器/反向代理服务器，它还具备邮件服务器的功能。我们在[Nginx官网](http://nginx.org/en/download.html)上查询发布日志，发现更新的比较频繁。仅在2016年前4月，就出现了2个比较大的版本：1.8.*、1.9.14。Tengine是由淘宝在官方nginx基础之上进行改进的版本，做了很多功能增强，最后一次的版本发布是：2015-12-31：Tengine-2.1.2,此版本仅兼容官方Nginx的1.6.2版本，该版本发布于：2014年9月16日。这也太久了，可能会错过很多官方更新。\n\n# 安装与配置\n```\n准备工作\ncd /home/www/\nmkdir nginx\ncd nginx/\nmkdir nginx\nmkdir zlib\nmkdir openssl\nmkdir pcre\n\nsudo apt-get update\n\n如果没有安装gcc/gcc-c++，请执行：sudo apt-get install build-essential\n如果没有安装make，请执行：sudo apt-get install make\n\nStep 1：编译安装Pcre包 (rewrite模块需要 pcre 库)\n1.软件位于/software/pcre-8.38.tar.gz\n2.拷贝软件到目标机器\"/home/www/nginx/pcre/\"目录\n3.顺序执行以下脚本\n\ncd /home/www/nginx/pcre/\ntar -xzvf pcre-8.38.tar.gz\ncd pcre-8.38/\n./configure\nsudo make\n#有可能需要输入密码\nsudo make install\n\n\n\nStep 2：编译安装Zlib (gzip模块需要 zlib 库)\n1.软件位于/software/zlib-1.2.8.tar.gz\n2.拷贝软件到目标机器\"/home/www/nginx/zlib/\"目录\n3.顺序执行以下脚本\n\ncd /home/www/nginx/zlib/\ntar -xzvf zlib-1.2.8.tar.gz\ncd zlib-1.2.8/\n./configure\nsudo make\n#有可能需要输入密码\nsudo make install\n\nStep 2：编译安装OpenSSL (ssl 功能需要openssl库)\n1.软件位于/software/openssl-1.1.0-pre4.tar.gz\n2.拷贝软件到目标机器\"/home/www/nginx/openssl/\"目录\n3.顺序执行以下脚本\n\ncd /home/www/nginx/openssl/\ntar -xzvf openssl-1.1.0-pre4.tar.gz\ncd openssl-1.1.0-pre4/\n./config\nsudo make\n#命令执行时间超过5分钟，耐心等待\nsudo make install\n#命令执行时间超过5分钟，耐心等待\n\nStep 3：编译安装Nginx\n1.软件位于/software/nginx-1.9.14.tar.gz\n2.拷贝软件到目标机器\"/home/www/nginx/nginx/\"目录\n3.顺序执行以下脚本\n\ncd /home/www/nginx/nginx/\ntar -xzvf nginx-1.9.14.tar.gz\ncd nginx-1.9.14/\n\nsed -i -e 's/1.9.14//g' -e 's/nginx\\//ERROR/g' -e 's/\"NGINX\"/\"ERROR\"/g' src/core/nginx.h\n\n./configure --prefix=/home/www/nginx/nginx --with-http_realip_module --with-http_sub_module --with-http_flv_module --with-http_dav_module --with-http_gzip_static_module --with-http_stub_status_module --with-http_addition_module --with-pcre=/home/www/nginx/pcre/pcre-8.38 --with-openssl=/home/www/nginx/openssl/openssl-1.1.0-pre4 --with-http_ssl_module --with-zlib=/home/www/nginx/zlib/zlib-1.2.8\n\nsudo make\n#命令执行时间超过5分钟，耐心等待\nsudo make install\n\nStep 4：安装补丁(对应用服务器进行监控)\ncd /home/www/nginx/nginx/\nmkdir patch\n补丁文件位于/software/patch目录，拷贝目录下的所有文件到：/home/www/nginx/nginx/patch/\ncd /home/www/nginx/nginx/nginx-1.9.14/src/\npatch -p1 < /home/www/nginx/nginx/patch/nginx_upstream_check_module-master/check_1.9.2+.patch\ncd ..\n./configure --prefix=/home/www/nginx/nginx --with-http_realip_module --with-http_sub_module --with-http_flv_module --with-http_dav_module --with-http_gzip_static_module --with-http_stub_status_module --with-http_addition_module --with-pcre=/home/www/nginx/pcre/pcre-8.38 --with-openssl=/home/www/nginx/openssl/openssl-1.1.0-pre4 --with-http_ssl_module --with-zlib=/home/www/nginx/zlib/zlib-1.2.8 --add-module=/home/www/nginx/nginx/patch/nginx_upstream_check_module-master/\nsudo make\n#命令执行时间超过5分钟，耐心等待\nsudo make install\ncd /home/www/nginx/nginx/sbin/\nsudo rm -f nginx.old\n\nStep 5：配置\n配置文件位于：conf/nginx.conf\n将该文件拷贝到：/home/www/nginx/nginx/conf/目录下，遇到文件已存在时，直接覆盖。\n\n确保可以访问到后端tomcat开放的端口，telnet\n修改配置文件nginx.conf,“upstream  xws”改为实际的tomcat运行环境\n\ncd /home/www/nginx/nginx/\nmkdir ssl\ncd ssl\nSSL证书文件位于：ssl/www.abcde.com.crt，ssl/www.abcde.com.key\n将这2个文件拷贝到/home/www/nginx/nginx/ssl/目录下\n\nStep 6：运行\n确保系统的80、443端口处于空闲状态。netstat\n确保/home/www/nginx/nginx/logs/目录具备读写权限。\n确保/home/www/nginx/nginx/ssl/www.abcde.com.crt具备读权限。\n确保/home/www/nginx/nginx/ssl/www.abcde.com.key具备读权限。\n确保/home/www/nginx/nginx/sbin/nginx文件具备可执行权限。\n\ncd /home/www/nginx/nginx/sbin/\nsudo ./nginx\n\nStep 7：验证\n1.pcre包安装的正确性\n\ncd /home/www/nginx/pcre/\n./pcre-config --version\n有版本号输出则安装成功。\n\n2.openssl包安装的正确性\ncd /home/www/nginx/openssl/openssl-1.1.0-pre4/\nopenssl version –a\n有版本号输出则安装成功。\n\n3.nginx包安装的正确性\ncd /home/www/nginx/nginx/nginx-1.9.14/objs\n./nginx -V\n##也可以使用：./nginx -t\n有配置详情输出则安装成功。\n\n卸载\n1.停止nginx的运行\ncd /home/www/nginx/nginx/sbin/\nsudo ./nginx -s stop\n\n2.删除文件\ncd /home/www/\nrm -rf nginx\n\n\n监控\n进入到与nginx部署机器的局域网络\n浏览器访问：http://nginx主机的局域网ip/nginxStatus/\n```\n\n贴出nginx.cof\n\n```\n#你所看到的这个文件，是nginx的工作配置文件，不要轻易改动。\n\nworker_processes  4;\nerror_log  logs/error.log;\npid        logs/nginx.pid;\nworker_rlimit_nofile 65535;\n\nevents {\n    use epoll;\n    worker_connections  65535;\n}\n\nhttp {\n    include       mime.types;\n    default_type  application/octet-stream;\n    server_tokens off;\n    tcp_nopush on;\n    tcp_nodelay on;\n    client_body_timeout   10;\n    client_header_timeout  30;\n    keepalive_timeout     30  30;\n\n    log_format  main  '$remote_addr - $remote_user [$time_local] \"$request\" '\n                      '$status $body_bytes_sent \"$http_referer\" '\n                      '\"$http_user_agent\" \"$http_x_forwarded_for\"';\n\n    sendfile on;\n    send_timeout 10;\n    client_body_buffer_size  64K;\n    client_header_buffer_size  128k;\n    client_max_body_size  10m;\n    large_client_header_buffers  4  128k;\n\n  # gzip压缩功能设置\n    gzip on;\n    gzip_min_length 1k;\n    gzip_buffers    4 16k;\n    gzip_http_version 1.0;\n    gzip_comp_level 6;\n    gzip_types text/plain text/css text/javascript application/json application/javascript application/x-javascript application/xml;\n    gzip_vary on;\n\n    #设置单个IP在每秒请求数不能超过20次\n    limit_req_zone $binary_remote_addr zone=one:20m rate=20r/s;\n\n    #设置单个IP同时连接数\n    limit_conn_zone $binary_remote_addr zone=addr:20m;\n\n    ssl_session_cache shared:SSL:10m;\n    ssl_session_timeout 10m;\n\n  # 设定负载均衡方式：RR模式\n    upstream  xws  {\n        server 127.0.0.1:6080 weight=1 max_fails=5 fail_timeout=10s ;\n        server 127.0.0.1:7080 weight=1 max_fails=5 fail_timeout=10s ;\n        check interval=3000 rise=2 fall=5 timeout=1000 type=http;\n    }\n\n  # 虚拟主机配置\n    server {\n        listen 80 default_server;\n        #root   /apps/oaapp;\n\n        listen 443 ssl default_server;\n        server_name www.abcde.com;\n        ssl_certificate  /home/www/nginx/nginx/ssl/yourCAcrt.crt;\n        ssl_certificate_key  /home/www/nginx/nginx/ssl/yourCAkey.key;\n        ssl_session_timeout  10m;\n        ssl_protocols TLSv1 TLSv1.1 TLSv1.2;\n        ssl_ciphers \"ECDHE-RSA-AES256-GCM-SHA384:ECDHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-SHA384:ECDHE-RSA-AES128-SHA256:ECDHE-RSA-AES256-SHA:ECDHE-RSA-AES128-SHA:DHE-RSA-AES256-SHA256:DHE-RSA-AES128-SHA256:DHE-RSA-AES256-SHA:DHE-RSA-AES128-SHA:ECDHE-RSA-DES-CBC3-SHA:EDH-RSA-DES-CBC3-SHA:AES256-GCM-SHA384:AES128-GCM-SHA256:AES256-SHA256:AES128-SHA256:AES256-SHA:AES128-SHA:DES-CBC3-SHA:HIGH:!aNULL:!eNULL:!EXPORT:!DES:!MD5:!PSK:!RC4\";\n        ssl_prefer_server_ciphers on;\n\n        charset utf-8;\n        access_log  logs/xws.access.log  main;\n\n        if ($request_method !~ ^(GET|HEAD|POST)$) {\n            return 404;\n        }\n\n        #对所有URL做负载均衡+反向代理\n        location / {\n            #root   /apps/oaapp;\n            #index  index.jsp index.html index.htm;\n            proxy_pass http://xws;\n            proxy_redirect off;\n            # 后端的Web服务器可以通过X-Forwarded-For获取用户真实IP\n            proxy_set_header  Host  $host;\n            proxy_set_header  X-Real-IP  $remote_addr;\n            proxy_set_header  X-Forwarded-For  $proxy_add_x_forwarded_for;\n            proxy_next_upstream error timeout invalid_header http_500 http_502 http_503 http_504;\n\n            limit_conn addr 2;\n            limit_req zone=one burst=5 nodelay;\n        }\n\n        #静态文件，nginx自己处理，不去backend请求tomcat\n        #location  ~* /download/ {\n        #    root /apps/oa/fs;\n\n        #}\n\n        #location ~ .*\\.(gif|jpg|jpeg|bmp|png|ico|txt|js|css)$\n        #{\n        #    root /apps/oaapp;\n        #    expires      7d;\n        #}\n\n        # 为内网IP开放nginx状态监控\n        location /nginxStatus {\n            stub_status on;\n            access_log off;\n            allow 192.168.1.0/24;\n            deny all;\n        }\n\n        location ~ ^/(WEB-INF)/ {\n            deny all;\n        }\n        #error_page 404              /404.html;\n        error_page 500 502 503 504  /50x.html;\n        location = /50x.html {\n            root   html;\n        }\n    }\n\n}\n```\n\n# 踩到的一些坑\n\n## 400 \\x16\\x03\n同一个server节点，配置：\n```\nlisten 80 default_server;\nlisten 443 ssl default_server;\n```\n## 调试Https\n如果CA证书签发的域名是：www.abcde.com，为了在线下调试，假设将nginx部署在局域网IP：192.168.1.188，我们可以将本机的hosts文件修改一下，文件位于：C:\\Windows\\System32\\drivers\\etc\\hosts。加上一行记录：“192.168.1.188 www.abcde.com”，保存后退出。再到本机的cmd命令行输入：ipconfig flushdns，退出cmd。等待几分钟后，在浏览器输入：https://www.abcde.com，即可在局域网调试啦！\n## ssl_protocols\n如果nginx.conf在定义ssl_protocols时，用了一些比较过时的协议，比如：SSLV3，则会被chrome提示连接不安全。可以参考我的nginx.conf配置，事实上这些过时的协议都有一些可以被利用的漏洞，建议不要使用了。","slug":"Remember-a-reverse-proxy-configuration-process-for-nginx-and-Tomcat-in-the-docker-environment","published":1,"updated":"2016-05-17T08:27:49.745Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ciowq3yuf000b4cnntiwze46w","content":"<h1 id=\"需要做什么？\"><a href=\"#需要做什么？\" class=\"headerlink\" title=\"需要做什么？\"></a>需要做什么？</h1><p>最近接到的任务是:在Docker环境下，Nginx与Tomcat的反向代理与负载均衡配置。先拿出可行性方案，以便在业务量突发时，在线上环境实施。典型的技术预研，打有准备仗。同时还提出了安全需求，在配置上，需要有安全加固。</p>\n<p>在Nginx配置时，针对不同的使用环境，配置的参数有很多不同。迫在眉睫的，我们需要先对线上的API服务系统进行反向代理与负载均衡配置。API服务系统是面向手机APP的接口系统，使用HTTP Restful+json进行数据通讯。</p>\n<p>我们在局域网环境下，有2台机器在软硬件配置方面，与线上的API服务系统类似。这2台机器的局域网IP分别是：192.168.1.158(简称为：158机器)、192.168.1.188(简称为：188机器)。由于188机器正在做压力测试，而且近期需要持续的对所有接口进行压力测试，没有办法空闲出来做实验。所以在实验之初我使用了158机器的普通账号进行，很快就因为权限不足，遭遇了很多莫名其妙的问题，而且158的使用量比较多，主要作为功能测试的机器。</p>\n<p>随后与PM沟通，延后了188机器的压力测试计划，拿到了权限比较高的账号，但还不是root账户。下面会说到如何在普通账户下，使用root账户执行shell命令。</p>\n<h1 id=\"Docker-with-Tomcat\"><a href=\"#Docker-with-Tomcat\" class=\"headerlink\" title=\"Docker with Tomcat\"></a>Docker with Tomcat</h1><p>为了模拟线上真实环境，我们在188机器上搭建了docker环境。docker是借助Linux container(简称LXC)技术的轻量级可移植运行时环境，这意味着在docker中完成的软件运行时环境搭建后，可以移植到任意一台支持docker运行的机器上，功能上不会有任何的丢失。这有点像Java开发中的JVM，都是解决在不同环境下软件运行的问题。docker更多的提供了资源共享和资源隔离的机制，容器之间本身是隔离互不干扰的，但提供配置允许不同容器之间交换数据，开放对外端口；同时可以限制某个容器对宿主机的资源占用，如cpu、内存、io等等。</p>\n<p>为了方便，低成本，我们使用docker hub上的tomcat镜像：tomcat:8-jre8。在后续的实验中，我们需要2个tomcat作为后端应用服务器来处理实际的HTTP请求。<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">FROM tomcat:8-jre8</span><br><span class=\"line\"></span><br><span class=\"line\">RUN mkdir /root/downloadAppBase</span><br></pre></td></tr></table></figure></p>\n<h1 id=\"Nginx-VS-Tengine\"><a href=\"#Nginx-VS-Tengine\" class=\"headerlink\" title=\"Nginx VS Tengine\"></a>Nginx VS Tengine</h1><p>在技术选项时，我们遇到Nginx以及衍生产品Tengine。Nginx是俄罗斯人编写的一款轻量级的Web 服务器/反向代理服务器，它还具备邮件服务器的功能。我们在<a href=\"http://nginx.org/en/download.html\" target=\"_blank\" rel=\"external\">Nginx官网</a>上查询发布日志，发现更新的比较频繁。仅在2016年前4月，就出现了2个比较大的版本：1.8.*、1.9.14。Tengine是由淘宝在官方nginx基础之上进行改进的版本，做了很多功能增强，最后一次的版本发布是：2015-12-31：Tengine-2.1.2,此版本仅兼容官方Nginx的1.6.2版本，该版本发布于：2014年9月16日。这也太久了，可能会错过很多官方更新。</p>\n<h1 id=\"安装与配置\"><a href=\"#安装与配置\" class=\"headerlink\" title=\"安装与配置\"></a>安装与配置</h1><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">准备工作</span><br><span class=\"line\">cd /home/www/</span><br><span class=\"line\">mkdir nginx</span><br><span class=\"line\">cd nginx/</span><br><span class=\"line\">mkdir nginx</span><br><span class=\"line\">mkdir zlib</span><br><span class=\"line\">mkdir openssl</span><br><span class=\"line\">mkdir pcre</span><br><span class=\"line\"></span><br><span class=\"line\">sudo apt-get update</span><br><span class=\"line\"></span><br><span class=\"line\">如果没有安装gcc/gcc-c++，请执行：sudo apt-get install build-essential</span><br><span class=\"line\">如果没有安装make，请执行：sudo apt-get install make</span><br><span class=\"line\"></span><br><span class=\"line\">Step 1：编译安装Pcre包 (rewrite模块需要 pcre 库)</span><br><span class=\"line\">1.软件位于/software/pcre-8.38.tar.gz</span><br><span class=\"line\">2.拷贝软件到目标机器&quot;/home/www/nginx/pcre/&quot;目录</span><br><span class=\"line\">3.顺序执行以下脚本</span><br><span class=\"line\"></span><br><span class=\"line\">cd /home/www/nginx/pcre/</span><br><span class=\"line\">tar -xzvf pcre-8.38.tar.gz</span><br><span class=\"line\">cd pcre-8.38/</span><br><span class=\"line\">./configure</span><br><span class=\"line\">sudo make</span><br><span class=\"line\">#有可能需要输入密码</span><br><span class=\"line\">sudo make install</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">Step 2：编译安装Zlib (gzip模块需要 zlib 库)</span><br><span class=\"line\">1.软件位于/software/zlib-1.2.8.tar.gz</span><br><span class=\"line\">2.拷贝软件到目标机器&quot;/home/www/nginx/zlib/&quot;目录</span><br><span class=\"line\">3.顺序执行以下脚本</span><br><span class=\"line\"></span><br><span class=\"line\">cd /home/www/nginx/zlib/</span><br><span class=\"line\">tar -xzvf zlib-1.2.8.tar.gz</span><br><span class=\"line\">cd zlib-1.2.8/</span><br><span class=\"line\">./configure</span><br><span class=\"line\">sudo make</span><br><span class=\"line\">#有可能需要输入密码</span><br><span class=\"line\">sudo make install</span><br><span class=\"line\"></span><br><span class=\"line\">Step 2：编译安装OpenSSL (ssl 功能需要openssl库)</span><br><span class=\"line\">1.软件位于/software/openssl-1.1.0-pre4.tar.gz</span><br><span class=\"line\">2.拷贝软件到目标机器&quot;/home/www/nginx/openssl/&quot;目录</span><br><span class=\"line\">3.顺序执行以下脚本</span><br><span class=\"line\"></span><br><span class=\"line\">cd /home/www/nginx/openssl/</span><br><span class=\"line\">tar -xzvf openssl-1.1.0-pre4.tar.gz</span><br><span class=\"line\">cd openssl-1.1.0-pre4/</span><br><span class=\"line\">./config</span><br><span class=\"line\">sudo make</span><br><span class=\"line\">#命令执行时间超过5分钟，耐心等待</span><br><span class=\"line\">sudo make install</span><br><span class=\"line\">#命令执行时间超过5分钟，耐心等待</span><br><span class=\"line\"></span><br><span class=\"line\">Step 3：编译安装Nginx</span><br><span class=\"line\">1.软件位于/software/nginx-1.9.14.tar.gz</span><br><span class=\"line\">2.拷贝软件到目标机器&quot;/home/www/nginx/nginx/&quot;目录</span><br><span class=\"line\">3.顺序执行以下脚本</span><br><span class=\"line\"></span><br><span class=\"line\">cd /home/www/nginx/nginx/</span><br><span class=\"line\">tar -xzvf nginx-1.9.14.tar.gz</span><br><span class=\"line\">cd nginx-1.9.14/</span><br><span class=\"line\"></span><br><span class=\"line\">sed -i -e &apos;s/1.9.14//g&apos; -e &apos;s/nginx\\//ERROR/g&apos; -e &apos;s/&quot;NGINX&quot;/&quot;ERROR&quot;/g&apos; src/core/nginx.h</span><br><span class=\"line\"></span><br><span class=\"line\">./configure --prefix=/home/www/nginx/nginx --with-http_realip_module --with-http_sub_module --with-http_flv_module --with-http_dav_module --with-http_gzip_static_module --with-http_stub_status_module --with-http_addition_module --with-pcre=/home/www/nginx/pcre/pcre-8.38 --with-openssl=/home/www/nginx/openssl/openssl-1.1.0-pre4 --with-http_ssl_module --with-zlib=/home/www/nginx/zlib/zlib-1.2.8</span><br><span class=\"line\"></span><br><span class=\"line\">sudo make</span><br><span class=\"line\">#命令执行时间超过5分钟，耐心等待</span><br><span class=\"line\">sudo make install</span><br><span class=\"line\"></span><br><span class=\"line\">Step 4：安装补丁(对应用服务器进行监控)</span><br><span class=\"line\">cd /home/www/nginx/nginx/</span><br><span class=\"line\">mkdir patch</span><br><span class=\"line\">补丁文件位于/software/patch目录，拷贝目录下的所有文件到：/home/www/nginx/nginx/patch/</span><br><span class=\"line\">cd /home/www/nginx/nginx/nginx-1.9.14/src/</span><br><span class=\"line\">patch -p1 &lt; /home/www/nginx/nginx/patch/nginx_upstream_check_module-master/check_1.9.2+.patch</span><br><span class=\"line\">cd ..</span><br><span class=\"line\">./configure --prefix=/home/www/nginx/nginx --with-http_realip_module --with-http_sub_module --with-http_flv_module --with-http_dav_module --with-http_gzip_static_module --with-http_stub_status_module --with-http_addition_module --with-pcre=/home/www/nginx/pcre/pcre-8.38 --with-openssl=/home/www/nginx/openssl/openssl-1.1.0-pre4 --with-http_ssl_module --with-zlib=/home/www/nginx/zlib/zlib-1.2.8 --add-module=/home/www/nginx/nginx/patch/nginx_upstream_check_module-master/</span><br><span class=\"line\">sudo make</span><br><span class=\"line\">#命令执行时间超过5分钟，耐心等待</span><br><span class=\"line\">sudo make install</span><br><span class=\"line\">cd /home/www/nginx/nginx/sbin/</span><br><span class=\"line\">sudo rm -f nginx.old</span><br><span class=\"line\"></span><br><span class=\"line\">Step 5：配置</span><br><span class=\"line\">配置文件位于：conf/nginx.conf</span><br><span class=\"line\">将该文件拷贝到：/home/www/nginx/nginx/conf/目录下，遇到文件已存在时，直接覆盖。</span><br><span class=\"line\"></span><br><span class=\"line\">确保可以访问到后端tomcat开放的端口，telnet</span><br><span class=\"line\">修改配置文件nginx.conf,“upstream  xws”改为实际的tomcat运行环境</span><br><span class=\"line\"></span><br><span class=\"line\">cd /home/www/nginx/nginx/</span><br><span class=\"line\">mkdir ssl</span><br><span class=\"line\">cd ssl</span><br><span class=\"line\">SSL证书文件位于：ssl/www.abcde.com.crt，ssl/www.abcde.com.key</span><br><span class=\"line\">将这2个文件拷贝到/home/www/nginx/nginx/ssl/目录下</span><br><span class=\"line\"></span><br><span class=\"line\">Step 6：运行</span><br><span class=\"line\">确保系统的80、443端口处于空闲状态。netstat</span><br><span class=\"line\">确保/home/www/nginx/nginx/logs/目录具备读写权限。</span><br><span class=\"line\">确保/home/www/nginx/nginx/ssl/www.abcde.com.crt具备读权限。</span><br><span class=\"line\">确保/home/www/nginx/nginx/ssl/www.abcde.com.key具备读权限。</span><br><span class=\"line\">确保/home/www/nginx/nginx/sbin/nginx文件具备可执行权限。</span><br><span class=\"line\"></span><br><span class=\"line\">cd /home/www/nginx/nginx/sbin/</span><br><span class=\"line\">sudo ./nginx</span><br><span class=\"line\"></span><br><span class=\"line\">Step 7：验证</span><br><span class=\"line\">1.pcre包安装的正确性</span><br><span class=\"line\"></span><br><span class=\"line\">cd /home/www/nginx/pcre/</span><br><span class=\"line\">./pcre-config --version</span><br><span class=\"line\">有版本号输出则安装成功。</span><br><span class=\"line\"></span><br><span class=\"line\">2.openssl包安装的正确性</span><br><span class=\"line\">cd /home/www/nginx/openssl/openssl-1.1.0-pre4/</span><br><span class=\"line\">openssl version –a</span><br><span class=\"line\">有版本号输出则安装成功。</span><br><span class=\"line\"></span><br><span class=\"line\">3.nginx包安装的正确性</span><br><span class=\"line\">cd /home/www/nginx/nginx/nginx-1.9.14/objs</span><br><span class=\"line\">./nginx -V</span><br><span class=\"line\">##也可以使用：./nginx -t</span><br><span class=\"line\">有配置详情输出则安装成功。</span><br><span class=\"line\"></span><br><span class=\"line\">卸载</span><br><span class=\"line\">1.停止nginx的运行</span><br><span class=\"line\">cd /home/www/nginx/nginx/sbin/</span><br><span class=\"line\">sudo ./nginx -s stop</span><br><span class=\"line\"></span><br><span class=\"line\">2.删除文件</span><br><span class=\"line\">cd /home/www/</span><br><span class=\"line\">rm -rf nginx</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">监控</span><br><span class=\"line\">进入到与nginx部署机器的局域网络</span><br><span class=\"line\">浏览器访问：http://nginx主机的局域网ip/nginxStatus/</span><br></pre></td></tr></table></figure>\n<p>贴出nginx.cof</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#你所看到的这个文件，是nginx的工作配置文件，不要轻易改动。</span><br><span class=\"line\"></span><br><span class=\"line\">worker_processes  4;</span><br><span class=\"line\">error_log  logs/error.log;</span><br><span class=\"line\">pid        logs/nginx.pid;</span><br><span class=\"line\">worker_rlimit_nofile 65535;</span><br><span class=\"line\"></span><br><span class=\"line\">events &#123;</span><br><span class=\"line\">    use epoll;</span><br><span class=\"line\">    worker_connections  65535;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">http &#123;</span><br><span class=\"line\">    include       mime.types;</span><br><span class=\"line\">    default_type  application/octet-stream;</span><br><span class=\"line\">    server_tokens off;</span><br><span class=\"line\">    tcp_nopush on;</span><br><span class=\"line\">    tcp_nodelay on;</span><br><span class=\"line\">    client_body_timeout   10;</span><br><span class=\"line\">    client_header_timeout  30;</span><br><span class=\"line\">    keepalive_timeout     30  30;</span><br><span class=\"line\"></span><br><span class=\"line\">    log_format  main  &apos;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &apos;</span><br><span class=\"line\">                      &apos;$status $body_bytes_sent &quot;$http_referer&quot; &apos;</span><br><span class=\"line\">                      &apos;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&apos;;</span><br><span class=\"line\"></span><br><span class=\"line\">    sendfile on;</span><br><span class=\"line\">    send_timeout 10;</span><br><span class=\"line\">    client_body_buffer_size  64K;</span><br><span class=\"line\">    client_header_buffer_size  128k;</span><br><span class=\"line\">    client_max_body_size  10m;</span><br><span class=\"line\">    large_client_header_buffers  4  128k;</span><br><span class=\"line\"></span><br><span class=\"line\">  # gzip压缩功能设置</span><br><span class=\"line\">    gzip on;</span><br><span class=\"line\">    gzip_min_length 1k;</span><br><span class=\"line\">    gzip_buffers    4 16k;</span><br><span class=\"line\">    gzip_http_version 1.0;</span><br><span class=\"line\">    gzip_comp_level 6;</span><br><span class=\"line\">    gzip_types text/plain text/css text/javascript application/json application/javascript application/x-javascript application/xml;</span><br><span class=\"line\">    gzip_vary on;</span><br><span class=\"line\"></span><br><span class=\"line\">    #设置单个IP在每秒请求数不能超过20次</span><br><span class=\"line\">    limit_req_zone $binary_remote_addr zone=one:20m rate=20r/s;</span><br><span class=\"line\"></span><br><span class=\"line\">    #设置单个IP同时连接数</span><br><span class=\"line\">    limit_conn_zone $binary_remote_addr zone=addr:20m;</span><br><span class=\"line\"></span><br><span class=\"line\">    ssl_session_cache shared:SSL:10m;</span><br><span class=\"line\">    ssl_session_timeout 10m;</span><br><span class=\"line\"></span><br><span class=\"line\">  # 设定负载均衡方式：RR模式</span><br><span class=\"line\">    upstream  xws  &#123;</span><br><span class=\"line\">        server 127.0.0.1:6080 weight=1 max_fails=5 fail_timeout=10s ;</span><br><span class=\"line\">        server 127.0.0.1:7080 weight=1 max_fails=5 fail_timeout=10s ;</span><br><span class=\"line\">        check interval=3000 rise=2 fall=5 timeout=1000 type=http;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  # 虚拟主机配置</span><br><span class=\"line\">    server &#123;</span><br><span class=\"line\">        listen 80 default_server;</span><br><span class=\"line\">        #root   /apps/oaapp;</span><br><span class=\"line\"></span><br><span class=\"line\">        listen 443 ssl default_server;</span><br><span class=\"line\">        server_name www.abcde.com;</span><br><span class=\"line\">        ssl_certificate  /home/www/nginx/nginx/ssl/yourCAcrt.crt;</span><br><span class=\"line\">        ssl_certificate_key  /home/www/nginx/nginx/ssl/yourCAkey.key;</span><br><span class=\"line\">        ssl_session_timeout  10m;</span><br><span class=\"line\">        ssl_protocols TLSv1 TLSv1.1 TLSv1.2;</span><br><span class=\"line\">        ssl_ciphers &quot;ECDHE-RSA-AES256-GCM-SHA384:ECDHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-SHA384:ECDHE-RSA-AES128-SHA256:ECDHE-RSA-AES256-SHA:ECDHE-RSA-AES128-SHA:DHE-RSA-AES256-SHA256:DHE-RSA-AES128-SHA256:DHE-RSA-AES256-SHA:DHE-RSA-AES128-SHA:ECDHE-RSA-DES-CBC3-SHA:EDH-RSA-DES-CBC3-SHA:AES256-GCM-SHA384:AES128-GCM-SHA256:AES256-SHA256:AES128-SHA256:AES256-SHA:AES128-SHA:DES-CBC3-SHA:HIGH:!aNULL:!eNULL:!EXPORT:!DES:!MD5:!PSK:!RC4&quot;;</span><br><span class=\"line\">        ssl_prefer_server_ciphers on;</span><br><span class=\"line\"></span><br><span class=\"line\">        charset utf-8;</span><br><span class=\"line\">        access_log  logs/xws.access.log  main;</span><br><span class=\"line\"></span><br><span class=\"line\">        if ($request_method !~ ^(GET|HEAD|POST)$) &#123;</span><br><span class=\"line\">            return 404;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        #对所有URL做负载均衡+反向代理</span><br><span class=\"line\">        location / &#123;</span><br><span class=\"line\">            #root   /apps/oaapp;</span><br><span class=\"line\">            #index  index.jsp index.html index.htm;</span><br><span class=\"line\">            proxy_pass http://xws;</span><br><span class=\"line\">            proxy_redirect off;</span><br><span class=\"line\">            # 后端的Web服务器可以通过X-Forwarded-For获取用户真实IP</span><br><span class=\"line\">            proxy_set_header  Host  $host;</span><br><span class=\"line\">            proxy_set_header  X-Real-IP  $remote_addr;</span><br><span class=\"line\">            proxy_set_header  X-Forwarded-For  $proxy_add_x_forwarded_for;</span><br><span class=\"line\">            proxy_next_upstream error timeout invalid_header http_500 http_502 http_503 http_504;</span><br><span class=\"line\"></span><br><span class=\"line\">            limit_conn addr 2;</span><br><span class=\"line\">            limit_req zone=one burst=5 nodelay;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        #静态文件，nginx自己处理，不去backend请求tomcat</span><br><span class=\"line\">        #location  ~* /download/ &#123;</span><br><span class=\"line\">        #    root /apps/oa/fs;</span><br><span class=\"line\"></span><br><span class=\"line\">        #&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        #location ~ .*\\.(gif|jpg|jpeg|bmp|png|ico|txt|js|css)$</span><br><span class=\"line\">        #&#123;</span><br><span class=\"line\">        #    root /apps/oaapp;</span><br><span class=\"line\">        #    expires      7d;</span><br><span class=\"line\">        #&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        # 为内网IP开放nginx状态监控</span><br><span class=\"line\">        location /nginxStatus &#123;</span><br><span class=\"line\">            stub_status on;</span><br><span class=\"line\">            access_log off;</span><br><span class=\"line\">            allow 192.168.1.0/24;</span><br><span class=\"line\">            deny all;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        location ~ ^/(WEB-INF)/ &#123;</span><br><span class=\"line\">            deny all;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        #error_page 404              /404.html;</span><br><span class=\"line\">        error_page 500 502 503 504  /50x.html;</span><br><span class=\"line\">        location = /50x.html &#123;</span><br><span class=\"line\">            root   html;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h1 id=\"踩到的一些坑\"><a href=\"#踩到的一些坑\" class=\"headerlink\" title=\"踩到的一些坑\"></a>踩到的一些坑</h1><h2 id=\"400-x16-x03\"><a href=\"#400-x16-x03\" class=\"headerlink\" title=\"400 \\x16\\x03\"></a>400 \\x16\\x03</h2><p>同一个server节点，配置：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">listen 80 default_server;</span><br><span class=\"line\">listen 443 ssl default_server;</span><br></pre></td></tr></table></figure></p>\n<h2 id=\"调试Https\"><a href=\"#调试Https\" class=\"headerlink\" title=\"调试Https\"></a>调试Https</h2><p>如果CA证书签发的域名是：www.abcde.com，为了在线下调试，假设将nginx部署在局域网IP：192.168.1.188，我们可以将本机的hosts文件修改一下，文件位于：C:\\Windows\\System32\\drivers\\etc\\hosts。加上一行记录：“192.168.1.188 www.abcde.com”，保存后退出。再到本机的cmd命令行输入：ipconfig flushdns，退出cmd。等待几分钟后，在浏览器输入：<a href=\"https://www.abcde.com，即可在局域网调试啦！\" target=\"_blank\" rel=\"external\">https://www.abcde.com，即可在局域网调试啦！</a></p>\n<h2 id=\"ssl-protocols\"><a href=\"#ssl-protocols\" class=\"headerlink\" title=\"ssl_protocols\"></a>ssl_protocols</h2><p>如果nginx.conf在定义ssl_protocols时，用了一些比较过时的协议，比如：SSLV3，则会被chrome提示连接不安全。可以参考我的nginx.conf配置，事实上这些过时的协议都有一些可以被利用的漏洞，建议不要使用了。</p>\n","excerpt":"","more":"<h1 id=\"需要做什么？\"><a href=\"#需要做什么？\" class=\"headerlink\" title=\"需要做什么？\"></a>需要做什么？</h1><p>最近接到的任务是:在Docker环境下，Nginx与Tomcat的反向代理与负载均衡配置。先拿出可行性方案，以便在业务量突发时，在线上环境实施。典型的技术预研，打有准备仗。同时还提出了安全需求，在配置上，需要有安全加固。</p>\n<p>在Nginx配置时，针对不同的使用环境，配置的参数有很多不同。迫在眉睫的，我们需要先对线上的API服务系统进行反向代理与负载均衡配置。API服务系统是面向手机APP的接口系统，使用HTTP Restful+json进行数据通讯。</p>\n<p>我们在局域网环境下，有2台机器在软硬件配置方面，与线上的API服务系统类似。这2台机器的局域网IP分别是：192.168.1.158(简称为：158机器)、192.168.1.188(简称为：188机器)。由于188机器正在做压力测试，而且近期需要持续的对所有接口进行压力测试，没有办法空闲出来做实验。所以在实验之初我使用了158机器的普通账号进行，很快就因为权限不足，遭遇了很多莫名其妙的问题，而且158的使用量比较多，主要作为功能测试的机器。</p>\n<p>随后与PM沟通，延后了188机器的压力测试计划，拿到了权限比较高的账号，但还不是root账户。下面会说到如何在普通账户下，使用root账户执行shell命令。</p>\n<h1 id=\"Docker-with-Tomcat\"><a href=\"#Docker-with-Tomcat\" class=\"headerlink\" title=\"Docker with Tomcat\"></a>Docker with Tomcat</h1><p>为了模拟线上真实环境，我们在188机器上搭建了docker环境。docker是借助Linux container(简称LXC)技术的轻量级可移植运行时环境，这意味着在docker中完成的软件运行时环境搭建后，可以移植到任意一台支持docker运行的机器上，功能上不会有任何的丢失。这有点像Java开发中的JVM，都是解决在不同环境下软件运行的问题。docker更多的提供了资源共享和资源隔离的机制，容器之间本身是隔离互不干扰的，但提供配置允许不同容器之间交换数据，开放对外端口；同时可以限制某个容器对宿主机的资源占用，如cpu、内存、io等等。</p>\n<p>为了方便，低成本，我们使用docker hub上的tomcat镜像：tomcat:8-jre8。在后续的实验中，我们需要2个tomcat作为后端应用服务器来处理实际的HTTP请求。<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">FROM tomcat:8-jre8</span><br><span class=\"line\"></span><br><span class=\"line\">RUN mkdir /root/downloadAppBase</span><br></pre></td></tr></table></figure></p>\n<h1 id=\"Nginx-VS-Tengine\"><a href=\"#Nginx-VS-Tengine\" class=\"headerlink\" title=\"Nginx VS Tengine\"></a>Nginx VS Tengine</h1><p>在技术选项时，我们遇到Nginx以及衍生产品Tengine。Nginx是俄罗斯人编写的一款轻量级的Web 服务器/反向代理服务器，它还具备邮件服务器的功能。我们在<a href=\"http://nginx.org/en/download.html\">Nginx官网</a>上查询发布日志，发现更新的比较频繁。仅在2016年前4月，就出现了2个比较大的版本：1.8.*、1.9.14。Tengine是由淘宝在官方nginx基础之上进行改进的版本，做了很多功能增强，最后一次的版本发布是：2015-12-31：Tengine-2.1.2,此版本仅兼容官方Nginx的1.6.2版本，该版本发布于：2014年9月16日。这也太久了，可能会错过很多官方更新。</p>\n<h1 id=\"安装与配置\"><a href=\"#安装与配置\" class=\"headerlink\" title=\"安装与配置\"></a>安装与配置</h1><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">准备工作</span><br><span class=\"line\">cd /home/www/</span><br><span class=\"line\">mkdir nginx</span><br><span class=\"line\">cd nginx/</span><br><span class=\"line\">mkdir nginx</span><br><span class=\"line\">mkdir zlib</span><br><span class=\"line\">mkdir openssl</span><br><span class=\"line\">mkdir pcre</span><br><span class=\"line\"></span><br><span class=\"line\">sudo apt-get update</span><br><span class=\"line\"></span><br><span class=\"line\">如果没有安装gcc/gcc-c++，请执行：sudo apt-get install build-essential</span><br><span class=\"line\">如果没有安装make，请执行：sudo apt-get install make</span><br><span class=\"line\"></span><br><span class=\"line\">Step 1：编译安装Pcre包 (rewrite模块需要 pcre 库)</span><br><span class=\"line\">1.软件位于/software/pcre-8.38.tar.gz</span><br><span class=\"line\">2.拷贝软件到目标机器&quot;/home/www/nginx/pcre/&quot;目录</span><br><span class=\"line\">3.顺序执行以下脚本</span><br><span class=\"line\"></span><br><span class=\"line\">cd /home/www/nginx/pcre/</span><br><span class=\"line\">tar -xzvf pcre-8.38.tar.gz</span><br><span class=\"line\">cd pcre-8.38/</span><br><span class=\"line\">./configure</span><br><span class=\"line\">sudo make</span><br><span class=\"line\">#有可能需要输入密码</span><br><span class=\"line\">sudo make install</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">Step 2：编译安装Zlib (gzip模块需要 zlib 库)</span><br><span class=\"line\">1.软件位于/software/zlib-1.2.8.tar.gz</span><br><span class=\"line\">2.拷贝软件到目标机器&quot;/home/www/nginx/zlib/&quot;目录</span><br><span class=\"line\">3.顺序执行以下脚本</span><br><span class=\"line\"></span><br><span class=\"line\">cd /home/www/nginx/zlib/</span><br><span class=\"line\">tar -xzvf zlib-1.2.8.tar.gz</span><br><span class=\"line\">cd zlib-1.2.8/</span><br><span class=\"line\">./configure</span><br><span class=\"line\">sudo make</span><br><span class=\"line\">#有可能需要输入密码</span><br><span class=\"line\">sudo make install</span><br><span class=\"line\"></span><br><span class=\"line\">Step 2：编译安装OpenSSL (ssl 功能需要openssl库)</span><br><span class=\"line\">1.软件位于/software/openssl-1.1.0-pre4.tar.gz</span><br><span class=\"line\">2.拷贝软件到目标机器&quot;/home/www/nginx/openssl/&quot;目录</span><br><span class=\"line\">3.顺序执行以下脚本</span><br><span class=\"line\"></span><br><span class=\"line\">cd /home/www/nginx/openssl/</span><br><span class=\"line\">tar -xzvf openssl-1.1.0-pre4.tar.gz</span><br><span class=\"line\">cd openssl-1.1.0-pre4/</span><br><span class=\"line\">./config</span><br><span class=\"line\">sudo make</span><br><span class=\"line\">#命令执行时间超过5分钟，耐心等待</span><br><span class=\"line\">sudo make install</span><br><span class=\"line\">#命令执行时间超过5分钟，耐心等待</span><br><span class=\"line\"></span><br><span class=\"line\">Step 3：编译安装Nginx</span><br><span class=\"line\">1.软件位于/software/nginx-1.9.14.tar.gz</span><br><span class=\"line\">2.拷贝软件到目标机器&quot;/home/www/nginx/nginx/&quot;目录</span><br><span class=\"line\">3.顺序执行以下脚本</span><br><span class=\"line\"></span><br><span class=\"line\">cd /home/www/nginx/nginx/</span><br><span class=\"line\">tar -xzvf nginx-1.9.14.tar.gz</span><br><span class=\"line\">cd nginx-1.9.14/</span><br><span class=\"line\"></span><br><span class=\"line\">sed -i -e &apos;s/1.9.14//g&apos; -e &apos;s/nginx\\//ERROR/g&apos; -e &apos;s/&quot;NGINX&quot;/&quot;ERROR&quot;/g&apos; src/core/nginx.h</span><br><span class=\"line\"></span><br><span class=\"line\">./configure --prefix=/home/www/nginx/nginx --with-http_realip_module --with-http_sub_module --with-http_flv_module --with-http_dav_module --with-http_gzip_static_module --with-http_stub_status_module --with-http_addition_module --with-pcre=/home/www/nginx/pcre/pcre-8.38 --with-openssl=/home/www/nginx/openssl/openssl-1.1.0-pre4 --with-http_ssl_module --with-zlib=/home/www/nginx/zlib/zlib-1.2.8</span><br><span class=\"line\"></span><br><span class=\"line\">sudo make</span><br><span class=\"line\">#命令执行时间超过5分钟，耐心等待</span><br><span class=\"line\">sudo make install</span><br><span class=\"line\"></span><br><span class=\"line\">Step 4：安装补丁(对应用服务器进行监控)</span><br><span class=\"line\">cd /home/www/nginx/nginx/</span><br><span class=\"line\">mkdir patch</span><br><span class=\"line\">补丁文件位于/software/patch目录，拷贝目录下的所有文件到：/home/www/nginx/nginx/patch/</span><br><span class=\"line\">cd /home/www/nginx/nginx/nginx-1.9.14/src/</span><br><span class=\"line\">patch -p1 &lt; /home/www/nginx/nginx/patch/nginx_upstream_check_module-master/check_1.9.2+.patch</span><br><span class=\"line\">cd ..</span><br><span class=\"line\">./configure --prefix=/home/www/nginx/nginx --with-http_realip_module --with-http_sub_module --with-http_flv_module --with-http_dav_module --with-http_gzip_static_module --with-http_stub_status_module --with-http_addition_module --with-pcre=/home/www/nginx/pcre/pcre-8.38 --with-openssl=/home/www/nginx/openssl/openssl-1.1.0-pre4 --with-http_ssl_module --with-zlib=/home/www/nginx/zlib/zlib-1.2.8 --add-module=/home/www/nginx/nginx/patch/nginx_upstream_check_module-master/</span><br><span class=\"line\">sudo make</span><br><span class=\"line\">#命令执行时间超过5分钟，耐心等待</span><br><span class=\"line\">sudo make install</span><br><span class=\"line\">cd /home/www/nginx/nginx/sbin/</span><br><span class=\"line\">sudo rm -f nginx.old</span><br><span class=\"line\"></span><br><span class=\"line\">Step 5：配置</span><br><span class=\"line\">配置文件位于：conf/nginx.conf</span><br><span class=\"line\">将该文件拷贝到：/home/www/nginx/nginx/conf/目录下，遇到文件已存在时，直接覆盖。</span><br><span class=\"line\"></span><br><span class=\"line\">确保可以访问到后端tomcat开放的端口，telnet</span><br><span class=\"line\">修改配置文件nginx.conf,“upstream  xws”改为实际的tomcat运行环境</span><br><span class=\"line\"></span><br><span class=\"line\">cd /home/www/nginx/nginx/</span><br><span class=\"line\">mkdir ssl</span><br><span class=\"line\">cd ssl</span><br><span class=\"line\">SSL证书文件位于：ssl/www.abcde.com.crt，ssl/www.abcde.com.key</span><br><span class=\"line\">将这2个文件拷贝到/home/www/nginx/nginx/ssl/目录下</span><br><span class=\"line\"></span><br><span class=\"line\">Step 6：运行</span><br><span class=\"line\">确保系统的80、443端口处于空闲状态。netstat</span><br><span class=\"line\">确保/home/www/nginx/nginx/logs/目录具备读写权限。</span><br><span class=\"line\">确保/home/www/nginx/nginx/ssl/www.abcde.com.crt具备读权限。</span><br><span class=\"line\">确保/home/www/nginx/nginx/ssl/www.abcde.com.key具备读权限。</span><br><span class=\"line\">确保/home/www/nginx/nginx/sbin/nginx文件具备可执行权限。</span><br><span class=\"line\"></span><br><span class=\"line\">cd /home/www/nginx/nginx/sbin/</span><br><span class=\"line\">sudo ./nginx</span><br><span class=\"line\"></span><br><span class=\"line\">Step 7：验证</span><br><span class=\"line\">1.pcre包安装的正确性</span><br><span class=\"line\"></span><br><span class=\"line\">cd /home/www/nginx/pcre/</span><br><span class=\"line\">./pcre-config --version</span><br><span class=\"line\">有版本号输出则安装成功。</span><br><span class=\"line\"></span><br><span class=\"line\">2.openssl包安装的正确性</span><br><span class=\"line\">cd /home/www/nginx/openssl/openssl-1.1.0-pre4/</span><br><span class=\"line\">openssl version –a</span><br><span class=\"line\">有版本号输出则安装成功。</span><br><span class=\"line\"></span><br><span class=\"line\">3.nginx包安装的正确性</span><br><span class=\"line\">cd /home/www/nginx/nginx/nginx-1.9.14/objs</span><br><span class=\"line\">./nginx -V</span><br><span class=\"line\">##也可以使用：./nginx -t</span><br><span class=\"line\">有配置详情输出则安装成功。</span><br><span class=\"line\"></span><br><span class=\"line\">卸载</span><br><span class=\"line\">1.停止nginx的运行</span><br><span class=\"line\">cd /home/www/nginx/nginx/sbin/</span><br><span class=\"line\">sudo ./nginx -s stop</span><br><span class=\"line\"></span><br><span class=\"line\">2.删除文件</span><br><span class=\"line\">cd /home/www/</span><br><span class=\"line\">rm -rf nginx</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">监控</span><br><span class=\"line\">进入到与nginx部署机器的局域网络</span><br><span class=\"line\">浏览器访问：http://nginx主机的局域网ip/nginxStatus/</span><br></pre></td></tr></table></figure>\n<p>贴出nginx.cof</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#你所看到的这个文件，是nginx的工作配置文件，不要轻易改动。</span><br><span class=\"line\"></span><br><span class=\"line\">worker_processes  4;</span><br><span class=\"line\">error_log  logs/error.log;</span><br><span class=\"line\">pid        logs/nginx.pid;</span><br><span class=\"line\">worker_rlimit_nofile 65535;</span><br><span class=\"line\"></span><br><span class=\"line\">events &#123;</span><br><span class=\"line\">    use epoll;</span><br><span class=\"line\">    worker_connections  65535;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">http &#123;</span><br><span class=\"line\">    include       mime.types;</span><br><span class=\"line\">    default_type  application/octet-stream;</span><br><span class=\"line\">    server_tokens off;</span><br><span class=\"line\">    tcp_nopush on;</span><br><span class=\"line\">    tcp_nodelay on;</span><br><span class=\"line\">    client_body_timeout   10;</span><br><span class=\"line\">    client_header_timeout  30;</span><br><span class=\"line\">    keepalive_timeout     30  30;</span><br><span class=\"line\"></span><br><span class=\"line\">    log_format  main  &apos;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &apos;</span><br><span class=\"line\">                      &apos;$status $body_bytes_sent &quot;$http_referer&quot; &apos;</span><br><span class=\"line\">                      &apos;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&apos;;</span><br><span class=\"line\"></span><br><span class=\"line\">    sendfile on;</span><br><span class=\"line\">    send_timeout 10;</span><br><span class=\"line\">    client_body_buffer_size  64K;</span><br><span class=\"line\">    client_header_buffer_size  128k;</span><br><span class=\"line\">    client_max_body_size  10m;</span><br><span class=\"line\">    large_client_header_buffers  4  128k;</span><br><span class=\"line\"></span><br><span class=\"line\">  # gzip压缩功能设置</span><br><span class=\"line\">    gzip on;</span><br><span class=\"line\">    gzip_min_length 1k;</span><br><span class=\"line\">    gzip_buffers    4 16k;</span><br><span class=\"line\">    gzip_http_version 1.0;</span><br><span class=\"line\">    gzip_comp_level 6;</span><br><span class=\"line\">    gzip_types text/plain text/css text/javascript application/json application/javascript application/x-javascript application/xml;</span><br><span class=\"line\">    gzip_vary on;</span><br><span class=\"line\"></span><br><span class=\"line\">    #设置单个IP在每秒请求数不能超过20次</span><br><span class=\"line\">    limit_req_zone $binary_remote_addr zone=one:20m rate=20r/s;</span><br><span class=\"line\"></span><br><span class=\"line\">    #设置单个IP同时连接数</span><br><span class=\"line\">    limit_conn_zone $binary_remote_addr zone=addr:20m;</span><br><span class=\"line\"></span><br><span class=\"line\">    ssl_session_cache shared:SSL:10m;</span><br><span class=\"line\">    ssl_session_timeout 10m;</span><br><span class=\"line\"></span><br><span class=\"line\">  # 设定负载均衡方式：RR模式</span><br><span class=\"line\">    upstream  xws  &#123;</span><br><span class=\"line\">        server 127.0.0.1:6080 weight=1 max_fails=5 fail_timeout=10s ;</span><br><span class=\"line\">        server 127.0.0.1:7080 weight=1 max_fails=5 fail_timeout=10s ;</span><br><span class=\"line\">        check interval=3000 rise=2 fall=5 timeout=1000 type=http;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  # 虚拟主机配置</span><br><span class=\"line\">    server &#123;</span><br><span class=\"line\">        listen 80 default_server;</span><br><span class=\"line\">        #root   /apps/oaapp;</span><br><span class=\"line\"></span><br><span class=\"line\">        listen 443 ssl default_server;</span><br><span class=\"line\">        server_name www.abcde.com;</span><br><span class=\"line\">        ssl_certificate  /home/www/nginx/nginx/ssl/yourCAcrt.crt;</span><br><span class=\"line\">        ssl_certificate_key  /home/www/nginx/nginx/ssl/yourCAkey.key;</span><br><span class=\"line\">        ssl_session_timeout  10m;</span><br><span class=\"line\">        ssl_protocols TLSv1 TLSv1.1 TLSv1.2;</span><br><span class=\"line\">        ssl_ciphers &quot;ECDHE-RSA-AES256-GCM-SHA384:ECDHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-SHA384:ECDHE-RSA-AES128-SHA256:ECDHE-RSA-AES256-SHA:ECDHE-RSA-AES128-SHA:DHE-RSA-AES256-SHA256:DHE-RSA-AES128-SHA256:DHE-RSA-AES256-SHA:DHE-RSA-AES128-SHA:ECDHE-RSA-DES-CBC3-SHA:EDH-RSA-DES-CBC3-SHA:AES256-GCM-SHA384:AES128-GCM-SHA256:AES256-SHA256:AES128-SHA256:AES256-SHA:AES128-SHA:DES-CBC3-SHA:HIGH:!aNULL:!eNULL:!EXPORT:!DES:!MD5:!PSK:!RC4&quot;;</span><br><span class=\"line\">        ssl_prefer_server_ciphers on;</span><br><span class=\"line\"></span><br><span class=\"line\">        charset utf-8;</span><br><span class=\"line\">        access_log  logs/xws.access.log  main;</span><br><span class=\"line\"></span><br><span class=\"line\">        if ($request_method !~ ^(GET|HEAD|POST)$) &#123;</span><br><span class=\"line\">            return 404;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        #对所有URL做负载均衡+反向代理</span><br><span class=\"line\">        location / &#123;</span><br><span class=\"line\">            #root   /apps/oaapp;</span><br><span class=\"line\">            #index  index.jsp index.html index.htm;</span><br><span class=\"line\">            proxy_pass http://xws;</span><br><span class=\"line\">            proxy_redirect off;</span><br><span class=\"line\">            # 后端的Web服务器可以通过X-Forwarded-For获取用户真实IP</span><br><span class=\"line\">            proxy_set_header  Host  $host;</span><br><span class=\"line\">            proxy_set_header  X-Real-IP  $remote_addr;</span><br><span class=\"line\">            proxy_set_header  X-Forwarded-For  $proxy_add_x_forwarded_for;</span><br><span class=\"line\">            proxy_next_upstream error timeout invalid_header http_500 http_502 http_503 http_504;</span><br><span class=\"line\"></span><br><span class=\"line\">            limit_conn addr 2;</span><br><span class=\"line\">            limit_req zone=one burst=5 nodelay;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        #静态文件，nginx自己处理，不去backend请求tomcat</span><br><span class=\"line\">        #location  ~* /download/ &#123;</span><br><span class=\"line\">        #    root /apps/oa/fs;</span><br><span class=\"line\"></span><br><span class=\"line\">        #&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        #location ~ .*\\.(gif|jpg|jpeg|bmp|png|ico|txt|js|css)$</span><br><span class=\"line\">        #&#123;</span><br><span class=\"line\">        #    root /apps/oaapp;</span><br><span class=\"line\">        #    expires      7d;</span><br><span class=\"line\">        #&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        # 为内网IP开放nginx状态监控</span><br><span class=\"line\">        location /nginxStatus &#123;</span><br><span class=\"line\">            stub_status on;</span><br><span class=\"line\">            access_log off;</span><br><span class=\"line\">            allow 192.168.1.0/24;</span><br><span class=\"line\">            deny all;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        location ~ ^/(WEB-INF)/ &#123;</span><br><span class=\"line\">            deny all;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        #error_page 404              /404.html;</span><br><span class=\"line\">        error_page 500 502 503 504  /50x.html;</span><br><span class=\"line\">        location = /50x.html &#123;</span><br><span class=\"line\">            root   html;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h1 id=\"踩到的一些坑\"><a href=\"#踩到的一些坑\" class=\"headerlink\" title=\"踩到的一些坑\"></a>踩到的一些坑</h1><h2 id=\"400-x16-x03\"><a href=\"#400-x16-x03\" class=\"headerlink\" title=\"400 \\x16\\x03\"></a>400 \\x16\\x03</h2><p>同一个server节点，配置：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">listen 80 default_server;</span><br><span class=\"line\">listen 443 ssl default_server;</span><br></pre></td></tr></table></figure></p>\n<h2 id=\"调试Https\"><a href=\"#调试Https\" class=\"headerlink\" title=\"调试Https\"></a>调试Https</h2><p>如果CA证书签发的域名是：www.abcde.com，为了在线下调试，假设将nginx部署在局域网IP：192.168.1.188，我们可以将本机的hosts文件修改一下，文件位于：C:\\Windows\\System32\\drivers\\etc\\hosts。加上一行记录：“192.168.1.188 www.abcde.com”，保存后退出。再到本机的cmd命令行输入：ipconfig flushdns，退出cmd。等待几分钟后，在浏览器输入：<a href=\"https://www.abcde.com，即可在局域网调试啦！\">https://www.abcde.com，即可在局域网调试啦！</a></p>\n<h2 id=\"ssl-protocols\"><a href=\"#ssl-protocols\" class=\"headerlink\" title=\"ssl_protocols\"></a>ssl_protocols</h2><p>如果nginx.conf在定义ssl_protocols时，用了一些比较过时的协议，比如：SSLV3，则会被chrome提示连接不安全。可以参考我的nginx.conf配置，事实上这些过时的协议都有一些可以被利用的漏洞，建议不要使用了。</p>\n"},{"title":"消息系统的架构演进之路","date":"2016-06-01T05:18:41.875Z","description":"消息系统在分阶段的架构演进","_content":"\n暂时未完成","source":"_posts/Message-system-architecture-evolution.md","raw":"---\ntitle: 消息系统的架构演进之路\ndate: 2016年6月1日13:19:22\ntags:\n    - MessageSystem\n    - architecture\ncategories:\n    - Summary\ndescription: 消息系统在分阶段的架构演进\n---\n\n暂时未完成","slug":"Message-system-architecture-evolution","published":1,"updated":"2016-06-01T05:23:18.873Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ciowq3yuj000d4cnnhlahdfsw","content":"<p>暂时未完成</p>\n","excerpt":"","more":"<p>暂时未完成</p>\n"},{"title":"软件重构经验总结","date":"2016-05-17T07:24:39.000Z","description":"重构更多的是对软件的可维护性和可扩展性进行提高，无法完成重构的软件，往往都逃不过被淘汰的命运。何时适宜进行重构，需要考量的因素有三个：成本、收益、风险。其中风险是最为重要的，如果系统不进行重构，在未来可能带来巨大的问题，如不能适应分布式部署。此时就有必要进行重构了，重构的同时还需要考虑完成重构需要的成本，包括时间成本、人力成本，团队往往时刻肩负着新功能的开发和旧功能的维护工作，如何在不多的时间和人力中挤出资源呢？","_content":"\n# 先了解\n## 了解中发现问题症结\n## 了解中思考解决方案\n## 选取合适的解决方案\n## 保留可扩展性\n## 保留可维护性\n\n# 再动手\n## 重构方案的评审\n## 理清方案的优势与不足\n## 资源预先到位\n包括重构的时间争取，参与人员配比，对其他软硬件资源、中间件的预研。\n## 重构前后的效果量化\n## 充分的测试\n基础方面的重构，需要充分的测试\n\n# 方案上线","source":"_posts/Software-refactoring-experience-summary.md","raw":"---\ntitle: 软件重构经验总结\ndate: 2016-5-17 15:24:39\ntags:\n    - Experience\n    - Refactor\ncategories:\n    - Summary\ndescription: 重构更多的是对软件的可维护性和可扩展性进行提高，无法完成重构的软件，往往都逃不过被淘汰的命运。何时适宜进行重构，需要考量的因素有三个：成本、收益、风险。其中风险是最为重要的，如果系统不进行重构，在未来可能带来巨大的问题，如不能适应分布式部署。此时就有必要进行重构了，重构的同时还需要考虑完成重构需要的成本，包括时间成本、人力成本，团队往往时刻肩负着新功能的开发和旧功能的维护工作，如何在不多的时间和人力中挤出资源呢？\n\n---\n\n# 先了解\n## 了解中发现问题症结\n## 了解中思考解决方案\n## 选取合适的解决方案\n## 保留可扩展性\n## 保留可维护性\n\n# 再动手\n## 重构方案的评审\n## 理清方案的优势与不足\n## 资源预先到位\n包括重构的时间争取，参与人员配比，对其他软硬件资源、中间件的预研。\n## 重构前后的效果量化\n## 充分的测试\n基础方面的重构，需要充分的测试\n\n# 方案上线","slug":"Software-refactoring-experience-summary","published":1,"updated":"2016-06-01T09:18:38.301Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ciowq3yuo000g4cnnk3n9ez6r","content":"<h1 id=\"先了解\"><a href=\"#先了解\" class=\"headerlink\" title=\"先了解\"></a>先了解</h1><h2 id=\"了解中发现问题症结\"><a href=\"#了解中发现问题症结\" class=\"headerlink\" title=\"了解中发现问题症结\"></a>了解中发现问题症结</h2><h2 id=\"了解中思考解决方案\"><a href=\"#了解中思考解决方案\" class=\"headerlink\" title=\"了解中思考解决方案\"></a>了解中思考解决方案</h2><h2 id=\"选取合适的解决方案\"><a href=\"#选取合适的解决方案\" class=\"headerlink\" title=\"选取合适的解决方案\"></a>选取合适的解决方案</h2><h2 id=\"保留可扩展性\"><a href=\"#保留可扩展性\" class=\"headerlink\" title=\"保留可扩展性\"></a>保留可扩展性</h2><h2 id=\"保留可维护性\"><a href=\"#保留可维护性\" class=\"headerlink\" title=\"保留可维护性\"></a>保留可维护性</h2><h1 id=\"再动手\"><a href=\"#再动手\" class=\"headerlink\" title=\"再动手\"></a>再动手</h1><h2 id=\"重构方案的评审\"><a href=\"#重构方案的评审\" class=\"headerlink\" title=\"重构方案的评审\"></a>重构方案的评审</h2><h2 id=\"理清方案的优势与不足\"><a href=\"#理清方案的优势与不足\" class=\"headerlink\" title=\"理清方案的优势与不足\"></a>理清方案的优势与不足</h2><h2 id=\"资源预先到位\"><a href=\"#资源预先到位\" class=\"headerlink\" title=\"资源预先到位\"></a>资源预先到位</h2><p>包括重构的时间争取，参与人员配比，对其他软硬件资源、中间件的预研。</p>\n<h2 id=\"重构前后的效果量化\"><a href=\"#重构前后的效果量化\" class=\"headerlink\" title=\"重构前后的效果量化\"></a>重构前后的效果量化</h2><h2 id=\"充分的测试\"><a href=\"#充分的测试\" class=\"headerlink\" title=\"充分的测试\"></a>充分的测试</h2><p>基础方面的重构，需要充分的测试</p>\n<h1 id=\"方案上线\"><a href=\"#方案上线\" class=\"headerlink\" title=\"方案上线\"></a>方案上线</h1>","excerpt":"","more":"<h1 id=\"先了解\"><a href=\"#先了解\" class=\"headerlink\" title=\"先了解\"></a>先了解</h1><h2 id=\"了解中发现问题症结\"><a href=\"#了解中发现问题症结\" class=\"headerlink\" title=\"了解中发现问题症结\"></a>了解中发现问题症结</h2><h2 id=\"了解中思考解决方案\"><a href=\"#了解中思考解决方案\" class=\"headerlink\" title=\"了解中思考解决方案\"></a>了解中思考解决方案</h2><h2 id=\"选取合适的解决方案\"><a href=\"#选取合适的解决方案\" class=\"headerlink\" title=\"选取合适的解决方案\"></a>选取合适的解决方案</h2><h2 id=\"保留可扩展性\"><a href=\"#保留可扩展性\" class=\"headerlink\" title=\"保留可扩展性\"></a>保留可扩展性</h2><h2 id=\"保留可维护性\"><a href=\"#保留可维护性\" class=\"headerlink\" title=\"保留可维护性\"></a>保留可维护性</h2><h1 id=\"再动手\"><a href=\"#再动手\" class=\"headerlink\" title=\"再动手\"></a>再动手</h1><h2 id=\"重构方案的评审\"><a href=\"#重构方案的评审\" class=\"headerlink\" title=\"重构方案的评审\"></a>重构方案的评审</h2><h2 id=\"理清方案的优势与不足\"><a href=\"#理清方案的优势与不足\" class=\"headerlink\" title=\"理清方案的优势与不足\"></a>理清方案的优势与不足</h2><h2 id=\"资源预先到位\"><a href=\"#资源预先到位\" class=\"headerlink\" title=\"资源预先到位\"></a>资源预先到位</h2><p>包括重构的时间争取，参与人员配比，对其他软硬件资源、中间件的预研。</p>\n<h2 id=\"重构前后的效果量化\"><a href=\"#重构前后的效果量化\" class=\"headerlink\" title=\"重构前后的效果量化\"></a>重构前后的效果量化</h2><h2 id=\"充分的测试\"><a href=\"#充分的测试\" class=\"headerlink\" title=\"充分的测试\"></a>充分的测试</h2><p>基础方面的重构，需要充分的测试</p>\n<h1 id=\"方案上线\"><a href=\"#方案上线\" class=\"headerlink\" title=\"方案上线\"></a>方案上线</h1>"},{"title":"SQL查询提高篇：捋清连接查询的那些事儿","date":"2016-03-21T04:25:10.000Z","description":"按照数据库设计原则，为了消除冗余，一般会将共通的属性值进行表拆分，零散的表可通过主外键将彼此联系起来，有时为了得到完整的结果，我们需要从多个表中获取结果后再拼合起来，就需要执行连接查询。","_content":"数据库中的表可通过外键将彼此联系起来。主键（Primary Key）是一个列，在这个列中的每一行的值都是唯一的。在表中，每个主键的值都是唯一的。这样做的目的是在不重复每个表中的所有数据的情况下，把表间的数据交叉捆绑在一起。\n\n而在两个表之间建立关联关系，是不要求任何一个表的关联列(column)是主键的，这个关联列可以是任何类型的列，但是要求，两个表的关联列可以做关联关系的条件计算，为避免转换影响效率，两个关联列最好保持类型、长度一致。\n\n为方便说明，定义以下2张表：\n```\n用户信息表\nCREATE TABLE `user` (\n  `uid` int(11) NOT NULL COMMENT '用户id',\n  `name` varchar(10) DEFAULT NULL COMMENT '姓名',\n  `sex` tinyint(1) DEFAULT NULL COMMENT '性别',\n  `age` tinyint(2) DEFAULT NULL COMMENT '年龄',\n  `mobile` varchar(11) DEFAULT NULL COMMENT '手机号码',\n  `password` varchar(64) NOT NULL COMMENT '密码',\n  `register_time` datetime NOT NULL COMMENT '注册时间',\n  PRIMARY KEY (`uid`),\n  UNIQUE KEY `index_mobile` (`mobile`) USING BTREE\n) ENGINE=InnoDB DEFAULT CHARSET=utf8;\n\nINSERT INTO `user` VALUES ('100', '张三', '1', '28', '13547521456', 'ASDAWQ@!#SDF@#$%XCF', '2016-03-30 17:47:51');\nINSERT INTO `user` VALUES ('101', '李四', '2', '35', '17025856329', '234ASD@#$@#$AFSDFRT', '2016-03-30 17:48:34');\nINSERT INTO `user` VALUES ('102', '王五', '1', '48', '15925874536', '#$%SDFSDR@#$%@#$#@', '2016-03-30 17:53:49');\n\n订单信息表\nCREATE TABLE `order` (\n  `order_id` int(11) NOT NULL COMMENT '订单编号',\n  `uid` int(11) DEFAULT NULL COMMENT '用户Id',\n  `amout` mediumtext NOT NULL COMMENT '订单金额(单位为分)',\n  `status` tinyint(2) DEFAULT NULL COMMENT '订单状态',\n  `order_time` datetime DEFAULT NULL COMMENT '订单时间',\n  PRIMARY KEY (`order_id`)\n) ENGINE=InnoDB DEFAULT CHARSET=utf8;\n\nINSERT INTO `order` VALUES ('200', '100', '5899', '0', '2016-03-30 17:54:20');\nINSERT INTO `order` VALUES ('201', '100', '6799', '0', '2016-03-30 17:54:38');\nINSERT INTO `order` VALUES ('202', '101', '12699', '0', '2016-03-30 17:55:01');\n```\n数据库现在2张表的数据看起来是这样：\nuser表\n\n| uid        | name           | sex  | age | mobile | password | register_time |\n| ------------- |:-------------:| -----:|-----:|-----:|-----:|-----:|\n|100| 张三|  1  | 28|  13547521456| password | 2016-03-30 17:47:51 |\n|101 |李四 | 2 |  35 | 17025856329 | password | 2016-03-30 17:48:34 |\n|102| 王五  |1|   48  |15925874536 | password  | 2016-03-30 17:53:49 |\n\norder表\n\n| order_id        | uid           | amout  | status | order_time |\n| ------------- |:-------------:| -----:|-----:|-----:|-----:|\n|200| 100 | 5899|    0 |  2016-03-30 17:54:20|\n|201 | 100 | 6799 |   0  | 2016-03-30 17:54:38|\n|202 | 101 | 12699 |  0   | 2016-03-30 17:55:01|\n\n## 练习题\n\n查询所有用户的订单信息，订单信息不能为空，要求返回的字段有：用户姓名、手机号码、订单号、订单状态、订单金额。\n\n### left join VS right join\n规律：\n\n* A表 left join B表；则返回A表的所有符合条件(on条件、where条件)的记录。A表的字段不会为null，而B表没有对应记录时,字段值返回null。\n* B表 left join A表；则返回B表的所有符合条件(on条件、where条件)的记录。B表的字段不会为null，而A表没有对应记录时,字段值返回null。\n\n* A表 left join B表 等价于 B表 right join A表.\n* A表 right join B表 等价于 B表 left join A表.\n\n正确的SQL语句：\n```\nSELECT `user`.`name`,`user`.mobile,`order`.order_id,`order`.`status`,`order`.amout\n FROM `user` RIGHT JOIN `order` ON `user`.uid=`order`.uid\n\n等价于\n\nSELECT `user`.`name`,`user`.mobile,`order`.order_id,`order`.`status`,`order`.amout\n FROM `order` LEFT JOIN `user` ON `user`.uid=`order`.uid\n```\n结果集是：\n\n| name        | mobile           | order_id  |status|amout|\n| ------------- |:-------------:| -----:|-----:|-----:|\n|张三|  13547521456| 200| 0   |5899|\n|张三 | 13547521456 |201 |0  | 6799|\n|李四  |17025856329 |202 |0 |  12699|\n\n错误的SQL语句：\n```\nSELECT `user`.`name`,`user`.mobile,`order`.order_id,`order`.`status`,`order`.amout\n FROM `user` LEFT JOIN `order` ON `user`.uid=`order`.uid\n\n等价于\n\nSELECT `user`.`name`,`user`.mobile,`order`.order_id,`order`.`status`,`order`.amout\n FROM `order` RIGHT JOIN `user` ON `user`.uid=`order`.uid\n```\n结果集是：\n\n| name        | mobile           | order_id  |status|amout|\n| ------------- |:-------------:| -----:|-----:|-----:|\n|张三 | 13547521456| 200| 0   |5899|\n|张三  |13547521456 |201 |0   |6799|\n|李四  |17025856329 |202 |0   |12699|\n|王五  |15925874536 |null |null| null|\n\n可以看出错误的SQL语句中，查出了没有订单的用户“王五”\n\n### inner join\n规律：\n\n* A表 inner join B表；则返回A表和B表同时符合条件(on条件、where条件)的记录。\n\n```\n两种写法，后者使用的居多\n\nSELECT `user`.`name`,`user`.mobile,`order`.order_id,`order`.`status`,`order`.amout\n FROM `order` INNER JOIN `user` ON `user`.uid=`order`.uid;\n\n等价于\n\nSELECT `user`.`name`,`user`.mobile,`order`.order_id,`order`.`status`,`order`.amout\n FROM `order`,`user` WHERE `user`.uid=`order`.uid;\n```\n\n### left outter join VS right outter join\n\nleft join 是left outer join的简写，left join默认是outer属性的。\n\n在某些数据库(如Oracle)中， left join 称为 left outer join；相应的right join 称为 right outter join\n\n### full join\n* 在某些数据库中， FULL JOIN 称为 FULL OUTER JOIN。\n* 只要其中某个表存在匹配，FULL JOIN 关键字就会返回行，意思是只需要有一个以上的表满足条件即可。\n* Oracle 、DB2、SQL Server、PostgreSQL 支持 Full JOIN，但是 MySQL 是不支持的。\n```\nMySQL使用FULL JOIN报错\n[Err] 1054 - Unknown column 'order.uid' in 'on clause'\n```\n* MySQL可以通过 LEFT JOIN + UNION + RIGHT JOIN 的方式 来实现Full JOIN。\n```\nselect `user`.`name`,`user`.mobile,`order`.order_id,`order`.`status`,`order`.amout\n from `order` left join `user` on `user`.uid=`order`.uid\n union\nselect `user`.`name`,`user`.mobile,`order`.order_id,`order`.`status`,`order`.amout\n from `order` right join `user` on `user`.uid=`order`.uid;\n```\n### cross join\n除了在FROM子句中使用逗号间隔连接的表外，SQL还支持另一种被称为交叉连接的操作，它们都返回被连接的两个表所有数据行的笛卡尔积，返回到的数据行数等于第一个表中符合查询条件的数据行数乘以第二个表中符合查询条件的数据行数。惟一的不同在于，交叉连接分开列名时，使用CROSS JOIN关键字而不是逗号。\n\n实际上，下面两个表达式是完全等价的。\n```\nSELECT  *  FROM  table1, table2 WHERE table1.name=table2.name;\nSELECT  *  FROM  table1  CROSS JOIN  table2 WHERE table1.name=table2.name;\n```\n在使用CROSS JOIN关键字交叉连接表时，因为生成的是两个表的笛卡尔积，因而不能使用ON关键字，只能在WHERE子句中定义搜索条件。\n\n事实上，直接使用CROSS JOIN很少得到想要的结果，但是，正如实例所示，作为查询的第一步，DBMS通常在FROM子句中，对连接的表进行CROSS JOIN，然后过滤得到的中间表。\n### union,union all\n在数据库中，union和union all关键字都是将两个结果集合并为一个，但这两者从使用和效率上来说都有所不同。\n\nunion在进行表链接后会筛选掉重复的记录，所以在表链接后会对所产生的结果集进行排序运算，删除重复的记录再返回结果。\n\n如：\n select * from test_union1\n   union\n select * from test_union2\n\n这个SQL在运行时先取出两个表的结果，再用排序空间进行排序删除重复的记录，最后返回结果集，如果表数据量大的话可能会导致用磁盘进行排序。而union all只是简单的将两个结果合并后就返回。这样，如果返回的两个结果集中有重复的数据，那么返回的结果集就会包含重复的数据了。从效率上说，union all要比union快很多，所以，如果可以确认合并的两个结果集中不包含重复的数据的话，那么就使用union all，\n\n如下：\nselect * from test_union1\nunion all\nselect * from test_union2\n\n使用 union 组合查询的结果集有两个最基本的规则：\n1。所有查询中的列数和列的顺序必须相同。\n2。数据类型必须兼容\n### Apache Hive连接查询\nHive支持连接查询，但有一些条件必须遵守，比如只支持相等查询，其它查询如不等式查询则不支持，还支持外连接，左半连接查询。另外Hive支持多于两个表以上的连接查询。\n* [Hive学习之连接查询](http://blog.csdn.net/skywalker_only/article/details/39205973)\n* [Hive JOIN使用详解](http://shiyanjun.cn/archives/588.html)\n### 结合explain进行执行分析\n* [MySQL EXPLAIN 命令详解学习](http://blog.csdn.net/mchdba/article/details/9190771)\n\n### 数据库设计准则\n\n* 一范式就是属性不可分割。属性是什么？就是表中的字段。不可分割的意思就按字面理解就是最小单位，不能再分成更小单位了。这个字段只能是一个值，不能被拆分成多个字段，否则的话，它就是可分割的，就不符合一范式。不过能不能分割并没有绝对的答案，看需求，也就是看你的设计目标而定。\n\n* 二范式就是要有主键，要求其他字段都依赖于主键。为什么要有主键？没有主键就没有唯一性，没有唯一性在集合中就定位不到这行记录，所以要主键。其他字段为什么要依赖于主键？因为不依赖于主键，就找不到他们。更重要的是，其他字段组成的这行记录和主键表示的是同一个东西，而主键是唯一的，它们只需要依赖于主键，也就成了唯一的。\n\n* 三范式就是要消除传递依赖，方便理解，可以看做是“消除冗余”。消除冗余应该比较好理解一些，就是各种信息只在一个地方存储，不出现在多张表中。","source":"_posts/SQL-improve-elegant-use-join-query.md","raw":"---\ntitle: 'SQL查询提高篇：捋清连接查询的那些事儿'\ndate: 2016-03-21 12:25:10\ntags:\n    - Tech\n    - SQL\n    - Elegant\ncategories: Learning\ndescription: 按照数据库设计原则，为了消除冗余，一般会将共通的属性值进行表拆分，零散的表可通过主外键将彼此联系起来，有时为了得到完整的结果，我们需要从多个表中获取结果后再拼合起来，就需要执行连接查询。\n---\n数据库中的表可通过外键将彼此联系起来。主键（Primary Key）是一个列，在这个列中的每一行的值都是唯一的。在表中，每个主键的值都是唯一的。这样做的目的是在不重复每个表中的所有数据的情况下，把表间的数据交叉捆绑在一起。\n\n而在两个表之间建立关联关系，是不要求任何一个表的关联列(column)是主键的，这个关联列可以是任何类型的列，但是要求，两个表的关联列可以做关联关系的条件计算，为避免转换影响效率，两个关联列最好保持类型、长度一致。\n\n为方便说明，定义以下2张表：\n```\n用户信息表\nCREATE TABLE `user` (\n  `uid` int(11) NOT NULL COMMENT '用户id',\n  `name` varchar(10) DEFAULT NULL COMMENT '姓名',\n  `sex` tinyint(1) DEFAULT NULL COMMENT '性别',\n  `age` tinyint(2) DEFAULT NULL COMMENT '年龄',\n  `mobile` varchar(11) DEFAULT NULL COMMENT '手机号码',\n  `password` varchar(64) NOT NULL COMMENT '密码',\n  `register_time` datetime NOT NULL COMMENT '注册时间',\n  PRIMARY KEY (`uid`),\n  UNIQUE KEY `index_mobile` (`mobile`) USING BTREE\n) ENGINE=InnoDB DEFAULT CHARSET=utf8;\n\nINSERT INTO `user` VALUES ('100', '张三', '1', '28', '13547521456', 'ASDAWQ@!#SDF@#$%XCF', '2016-03-30 17:47:51');\nINSERT INTO `user` VALUES ('101', '李四', '2', '35', '17025856329', '234ASD@#$@#$AFSDFRT', '2016-03-30 17:48:34');\nINSERT INTO `user` VALUES ('102', '王五', '1', '48', '15925874536', '#$%SDFSDR@#$%@#$#@', '2016-03-30 17:53:49');\n\n订单信息表\nCREATE TABLE `order` (\n  `order_id` int(11) NOT NULL COMMENT '订单编号',\n  `uid` int(11) DEFAULT NULL COMMENT '用户Id',\n  `amout` mediumtext NOT NULL COMMENT '订单金额(单位为分)',\n  `status` tinyint(2) DEFAULT NULL COMMENT '订单状态',\n  `order_time` datetime DEFAULT NULL COMMENT '订单时间',\n  PRIMARY KEY (`order_id`)\n) ENGINE=InnoDB DEFAULT CHARSET=utf8;\n\nINSERT INTO `order` VALUES ('200', '100', '5899', '0', '2016-03-30 17:54:20');\nINSERT INTO `order` VALUES ('201', '100', '6799', '0', '2016-03-30 17:54:38');\nINSERT INTO `order` VALUES ('202', '101', '12699', '0', '2016-03-30 17:55:01');\n```\n数据库现在2张表的数据看起来是这样：\nuser表\n\n| uid        | name           | sex  | age | mobile | password | register_time |\n| ------------- |:-------------:| -----:|-----:|-----:|-----:|-----:|\n|100| 张三|  1  | 28|  13547521456| password | 2016-03-30 17:47:51 |\n|101 |李四 | 2 |  35 | 17025856329 | password | 2016-03-30 17:48:34 |\n|102| 王五  |1|   48  |15925874536 | password  | 2016-03-30 17:53:49 |\n\norder表\n\n| order_id        | uid           | amout  | status | order_time |\n| ------------- |:-------------:| -----:|-----:|-----:|-----:|\n|200| 100 | 5899|    0 |  2016-03-30 17:54:20|\n|201 | 100 | 6799 |   0  | 2016-03-30 17:54:38|\n|202 | 101 | 12699 |  0   | 2016-03-30 17:55:01|\n\n## 练习题\n\n查询所有用户的订单信息，订单信息不能为空，要求返回的字段有：用户姓名、手机号码、订单号、订单状态、订单金额。\n\n### left join VS right join\n规律：\n\n* A表 left join B表；则返回A表的所有符合条件(on条件、where条件)的记录。A表的字段不会为null，而B表没有对应记录时,字段值返回null。\n* B表 left join A表；则返回B表的所有符合条件(on条件、where条件)的记录。B表的字段不会为null，而A表没有对应记录时,字段值返回null。\n\n* A表 left join B表 等价于 B表 right join A表.\n* A表 right join B表 等价于 B表 left join A表.\n\n正确的SQL语句：\n```\nSELECT `user`.`name`,`user`.mobile,`order`.order_id,`order`.`status`,`order`.amout\n FROM `user` RIGHT JOIN `order` ON `user`.uid=`order`.uid\n\n等价于\n\nSELECT `user`.`name`,`user`.mobile,`order`.order_id,`order`.`status`,`order`.amout\n FROM `order` LEFT JOIN `user` ON `user`.uid=`order`.uid\n```\n结果集是：\n\n| name        | mobile           | order_id  |status|amout|\n| ------------- |:-------------:| -----:|-----:|-----:|\n|张三|  13547521456| 200| 0   |5899|\n|张三 | 13547521456 |201 |0  | 6799|\n|李四  |17025856329 |202 |0 |  12699|\n\n错误的SQL语句：\n```\nSELECT `user`.`name`,`user`.mobile,`order`.order_id,`order`.`status`,`order`.amout\n FROM `user` LEFT JOIN `order` ON `user`.uid=`order`.uid\n\n等价于\n\nSELECT `user`.`name`,`user`.mobile,`order`.order_id,`order`.`status`,`order`.amout\n FROM `order` RIGHT JOIN `user` ON `user`.uid=`order`.uid\n```\n结果集是：\n\n| name        | mobile           | order_id  |status|amout|\n| ------------- |:-------------:| -----:|-----:|-----:|\n|张三 | 13547521456| 200| 0   |5899|\n|张三  |13547521456 |201 |0   |6799|\n|李四  |17025856329 |202 |0   |12699|\n|王五  |15925874536 |null |null| null|\n\n可以看出错误的SQL语句中，查出了没有订单的用户“王五”\n\n### inner join\n规律：\n\n* A表 inner join B表；则返回A表和B表同时符合条件(on条件、where条件)的记录。\n\n```\n两种写法，后者使用的居多\n\nSELECT `user`.`name`,`user`.mobile,`order`.order_id,`order`.`status`,`order`.amout\n FROM `order` INNER JOIN `user` ON `user`.uid=`order`.uid;\n\n等价于\n\nSELECT `user`.`name`,`user`.mobile,`order`.order_id,`order`.`status`,`order`.amout\n FROM `order`,`user` WHERE `user`.uid=`order`.uid;\n```\n\n### left outter join VS right outter join\n\nleft join 是left outer join的简写，left join默认是outer属性的。\n\n在某些数据库(如Oracle)中， left join 称为 left outer join；相应的right join 称为 right outter join\n\n### full join\n* 在某些数据库中， FULL JOIN 称为 FULL OUTER JOIN。\n* 只要其中某个表存在匹配，FULL JOIN 关键字就会返回行，意思是只需要有一个以上的表满足条件即可。\n* Oracle 、DB2、SQL Server、PostgreSQL 支持 Full JOIN，但是 MySQL 是不支持的。\n```\nMySQL使用FULL JOIN报错\n[Err] 1054 - Unknown column 'order.uid' in 'on clause'\n```\n* MySQL可以通过 LEFT JOIN + UNION + RIGHT JOIN 的方式 来实现Full JOIN。\n```\nselect `user`.`name`,`user`.mobile,`order`.order_id,`order`.`status`,`order`.amout\n from `order` left join `user` on `user`.uid=`order`.uid\n union\nselect `user`.`name`,`user`.mobile,`order`.order_id,`order`.`status`,`order`.amout\n from `order` right join `user` on `user`.uid=`order`.uid;\n```\n### cross join\n除了在FROM子句中使用逗号间隔连接的表外，SQL还支持另一种被称为交叉连接的操作，它们都返回被连接的两个表所有数据行的笛卡尔积，返回到的数据行数等于第一个表中符合查询条件的数据行数乘以第二个表中符合查询条件的数据行数。惟一的不同在于，交叉连接分开列名时，使用CROSS JOIN关键字而不是逗号。\n\n实际上，下面两个表达式是完全等价的。\n```\nSELECT  *  FROM  table1, table2 WHERE table1.name=table2.name;\nSELECT  *  FROM  table1  CROSS JOIN  table2 WHERE table1.name=table2.name;\n```\n在使用CROSS JOIN关键字交叉连接表时，因为生成的是两个表的笛卡尔积，因而不能使用ON关键字，只能在WHERE子句中定义搜索条件。\n\n事实上，直接使用CROSS JOIN很少得到想要的结果，但是，正如实例所示，作为查询的第一步，DBMS通常在FROM子句中，对连接的表进行CROSS JOIN，然后过滤得到的中间表。\n### union,union all\n在数据库中，union和union all关键字都是将两个结果集合并为一个，但这两者从使用和效率上来说都有所不同。\n\nunion在进行表链接后会筛选掉重复的记录，所以在表链接后会对所产生的结果集进行排序运算，删除重复的记录再返回结果。\n\n如：\n select * from test_union1\n   union\n select * from test_union2\n\n这个SQL在运行时先取出两个表的结果，再用排序空间进行排序删除重复的记录，最后返回结果集，如果表数据量大的话可能会导致用磁盘进行排序。而union all只是简单的将两个结果合并后就返回。这样，如果返回的两个结果集中有重复的数据，那么返回的结果集就会包含重复的数据了。从效率上说，union all要比union快很多，所以，如果可以确认合并的两个结果集中不包含重复的数据的话，那么就使用union all，\n\n如下：\nselect * from test_union1\nunion all\nselect * from test_union2\n\n使用 union 组合查询的结果集有两个最基本的规则：\n1。所有查询中的列数和列的顺序必须相同。\n2。数据类型必须兼容\n### Apache Hive连接查询\nHive支持连接查询，但有一些条件必须遵守，比如只支持相等查询，其它查询如不等式查询则不支持，还支持外连接，左半连接查询。另外Hive支持多于两个表以上的连接查询。\n* [Hive学习之连接查询](http://blog.csdn.net/skywalker_only/article/details/39205973)\n* [Hive JOIN使用详解](http://shiyanjun.cn/archives/588.html)\n### 结合explain进行执行分析\n* [MySQL EXPLAIN 命令详解学习](http://blog.csdn.net/mchdba/article/details/9190771)\n\n### 数据库设计准则\n\n* 一范式就是属性不可分割。属性是什么？就是表中的字段。不可分割的意思就按字面理解就是最小单位，不能再分成更小单位了。这个字段只能是一个值，不能被拆分成多个字段，否则的话，它就是可分割的，就不符合一范式。不过能不能分割并没有绝对的答案，看需求，也就是看你的设计目标而定。\n\n* 二范式就是要有主键，要求其他字段都依赖于主键。为什么要有主键？没有主键就没有唯一性，没有唯一性在集合中就定位不到这行记录，所以要主键。其他字段为什么要依赖于主键？因为不依赖于主键，就找不到他们。更重要的是，其他字段组成的这行记录和主键表示的是同一个东西，而主键是唯一的，它们只需要依赖于主键，也就成了唯一的。\n\n* 三范式就是要消除传递依赖，方便理解，可以看做是“消除冗余”。消除冗余应该比较好理解一些，就是各种信息只在一个地方存储，不出现在多张表中。","slug":"SQL-improve-elegant-use-join-query","published":1,"updated":"2016-05-17T08:39:33.401Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ciowq3yuq000i4cnn8jm5nq6g","content":"<p>数据库中的表可通过外键将彼此联系起来。主键（Primary Key）是一个列，在这个列中的每一行的值都是唯一的。在表中，每个主键的值都是唯一的。这样做的目的是在不重复每个表中的所有数据的情况下，把表间的数据交叉捆绑在一起。</p>\n<p>而在两个表之间建立关联关系，是不要求任何一个表的关联列(column)是主键的，这个关联列可以是任何类型的列，但是要求，两个表的关联列可以做关联关系的条件计算，为避免转换影响效率，两个关联列最好保持类型、长度一致。</p>\n<p>为方便说明，定义以下2张表：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">用户信息表</span><br><span class=\"line\">CREATE TABLE `user` (</span><br><span class=\"line\">  `uid` int(11) NOT NULL COMMENT &apos;用户id&apos;,</span><br><span class=\"line\">  `name` varchar(10) DEFAULT NULL COMMENT &apos;姓名&apos;,</span><br><span class=\"line\">  `sex` tinyint(1) DEFAULT NULL COMMENT &apos;性别&apos;,</span><br><span class=\"line\">  `age` tinyint(2) DEFAULT NULL COMMENT &apos;年龄&apos;,</span><br><span class=\"line\">  `mobile` varchar(11) DEFAULT NULL COMMENT &apos;手机号码&apos;,</span><br><span class=\"line\">  `password` varchar(64) NOT NULL COMMENT &apos;密码&apos;,</span><br><span class=\"line\">  `register_time` datetime NOT NULL COMMENT &apos;注册时间&apos;,</span><br><span class=\"line\">  PRIMARY KEY (`uid`),</span><br><span class=\"line\">  UNIQUE KEY `index_mobile` (`mobile`) USING BTREE</span><br><span class=\"line\">) ENGINE=InnoDB DEFAULT CHARSET=utf8;</span><br><span class=\"line\"></span><br><span class=\"line\">INSERT INTO `user` VALUES (&apos;100&apos;, &apos;张三&apos;, &apos;1&apos;, &apos;28&apos;, &apos;13547521456&apos;, &apos;ASDAWQ@!#SDF@#$%XCF&apos;, &apos;2016-03-30 17:47:51&apos;);</span><br><span class=\"line\">INSERT INTO `user` VALUES (&apos;101&apos;, &apos;李四&apos;, &apos;2&apos;, &apos;35&apos;, &apos;17025856329&apos;, &apos;234ASD@#$@#$AFSDFRT&apos;, &apos;2016-03-30 17:48:34&apos;);</span><br><span class=\"line\">INSERT INTO `user` VALUES (&apos;102&apos;, &apos;王五&apos;, &apos;1&apos;, &apos;48&apos;, &apos;15925874536&apos;, &apos;#$%SDFSDR@#$%@#$#@&apos;, &apos;2016-03-30 17:53:49&apos;);</span><br><span class=\"line\"></span><br><span class=\"line\">订单信息表</span><br><span class=\"line\">CREATE TABLE `order` (</span><br><span class=\"line\">  `order_id` int(11) NOT NULL COMMENT &apos;订单编号&apos;,</span><br><span class=\"line\">  `uid` int(11) DEFAULT NULL COMMENT &apos;用户Id&apos;,</span><br><span class=\"line\">  `amout` mediumtext NOT NULL COMMENT &apos;订单金额(单位为分)&apos;,</span><br><span class=\"line\">  `status` tinyint(2) DEFAULT NULL COMMENT &apos;订单状态&apos;,</span><br><span class=\"line\">  `order_time` datetime DEFAULT NULL COMMENT &apos;订单时间&apos;,</span><br><span class=\"line\">  PRIMARY KEY (`order_id`)</span><br><span class=\"line\">) ENGINE=InnoDB DEFAULT CHARSET=utf8;</span><br><span class=\"line\"></span><br><span class=\"line\">INSERT INTO `order` VALUES (&apos;200&apos;, &apos;100&apos;, &apos;5899&apos;, &apos;0&apos;, &apos;2016-03-30 17:54:20&apos;);</span><br><span class=\"line\">INSERT INTO `order` VALUES (&apos;201&apos;, &apos;100&apos;, &apos;6799&apos;, &apos;0&apos;, &apos;2016-03-30 17:54:38&apos;);</span><br><span class=\"line\">INSERT INTO `order` VALUES (&apos;202&apos;, &apos;101&apos;, &apos;12699&apos;, &apos;0&apos;, &apos;2016-03-30 17:55:01&apos;);</span><br></pre></td></tr></table></figure></p>\n<p>数据库现在2张表的数据看起来是这样：<br>user表</p>\n<table>\n<thead>\n<tr>\n<th>uid</th>\n<th style=\"text-align:center\">name</th>\n<th style=\"text-align:right\">sex</th>\n<th style=\"text-align:right\">age</th>\n<th style=\"text-align:right\">mobile</th>\n<th style=\"text-align:right\">password</th>\n<th style=\"text-align:right\">register_time</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>100</td>\n<td style=\"text-align:center\">张三</td>\n<td style=\"text-align:right\">1</td>\n<td style=\"text-align:right\">28</td>\n<td style=\"text-align:right\">13547521456</td>\n<td style=\"text-align:right\">password</td>\n<td style=\"text-align:right\">2016-03-30 17:47:51</td>\n</tr>\n<tr>\n<td>101</td>\n<td style=\"text-align:center\">李四</td>\n<td style=\"text-align:right\">2</td>\n<td style=\"text-align:right\">35</td>\n<td style=\"text-align:right\">17025856329</td>\n<td style=\"text-align:right\">password</td>\n<td style=\"text-align:right\">2016-03-30 17:48:34</td>\n</tr>\n<tr>\n<td>102</td>\n<td style=\"text-align:center\">王五</td>\n<td style=\"text-align:right\">1</td>\n<td style=\"text-align:right\">48</td>\n<td style=\"text-align:right\">15925874536</td>\n<td style=\"text-align:right\">password</td>\n<td style=\"text-align:right\">2016-03-30 17:53:49</td>\n</tr>\n</tbody>\n</table>\n<p>order表</p>\n<table>\n<thead>\n<tr>\n<th>order_id</th>\n<th style=\"text-align:center\">uid</th>\n<th style=\"text-align:right\">amout</th>\n<th style=\"text-align:right\">status</th>\n<th style=\"text-align:right\">order_time</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>200</td>\n<td style=\"text-align:center\">100</td>\n<td style=\"text-align:right\">5899</td>\n<td style=\"text-align:right\">0</td>\n<td style=\"text-align:right\">2016-03-30 17:54:20</td>\n</tr>\n<tr>\n<td>201</td>\n<td style=\"text-align:center\">100</td>\n<td style=\"text-align:right\">6799</td>\n<td style=\"text-align:right\">0</td>\n<td style=\"text-align:right\">2016-03-30 17:54:38</td>\n</tr>\n<tr>\n<td>202</td>\n<td style=\"text-align:center\">101</td>\n<td style=\"text-align:right\">12699</td>\n<td style=\"text-align:right\">0</td>\n<td style=\"text-align:right\">2016-03-30 17:55:01</td>\n</tr>\n</tbody>\n</table>\n<h2 id=\"练习题\"><a href=\"#练习题\" class=\"headerlink\" title=\"练习题\"></a>练习题</h2><p>查询所有用户的订单信息，订单信息不能为空，要求返回的字段有：用户姓名、手机号码、订单号、订单状态、订单金额。</p>\n<h3 id=\"left-join-VS-right-join\"><a href=\"#left-join-VS-right-join\" class=\"headerlink\" title=\"left join VS right join\"></a>left join VS right join</h3><p>规律：</p>\n<ul>\n<li>A表 left join B表；则返回A表的所有符合条件(on条件、where条件)的记录。A表的字段不会为null，而B表没有对应记录时,字段值返回null。</li>\n<li><p>B表 left join A表；则返回B表的所有符合条件(on条件、where条件)的记录。B表的字段不会为null，而A表没有对应记录时,字段值返回null。</p>\n</li>\n<li><p>A表 left join B表 等价于 B表 right join A表.</p>\n</li>\n<li>A表 right join B表 等价于 B表 left join A表.</li>\n</ul>\n<p>正确的SQL语句：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">SELECT `user`.`name`,`user`.mobile,`order`.order_id,`order`.`status`,`order`.amout</span><br><span class=\"line\"> FROM `user` RIGHT JOIN `order` ON `user`.uid=`order`.uid</span><br><span class=\"line\"></span><br><span class=\"line\">等价于</span><br><span class=\"line\"></span><br><span class=\"line\">SELECT `user`.`name`,`user`.mobile,`order`.order_id,`order`.`status`,`order`.amout</span><br><span class=\"line\"> FROM `order` LEFT JOIN `user` ON `user`.uid=`order`.uid</span><br></pre></td></tr></table></figure></p>\n<p>结果集是：</p>\n<table>\n<thead>\n<tr>\n<th>name</th>\n<th style=\"text-align:center\">mobile</th>\n<th style=\"text-align:right\">order_id</th>\n<th style=\"text-align:right\">status</th>\n<th style=\"text-align:right\">amout</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>张三</td>\n<td style=\"text-align:center\">13547521456</td>\n<td style=\"text-align:right\">200</td>\n<td style=\"text-align:right\">0</td>\n<td style=\"text-align:right\">5899</td>\n</tr>\n<tr>\n<td>张三</td>\n<td style=\"text-align:center\">13547521456</td>\n<td style=\"text-align:right\">201</td>\n<td style=\"text-align:right\">0</td>\n<td style=\"text-align:right\">6799</td>\n</tr>\n<tr>\n<td>李四</td>\n<td style=\"text-align:center\">17025856329</td>\n<td style=\"text-align:right\">202</td>\n<td style=\"text-align:right\">0</td>\n<td style=\"text-align:right\">12699</td>\n</tr>\n</tbody>\n</table>\n<p>错误的SQL语句：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">SELECT `user`.`name`,`user`.mobile,`order`.order_id,`order`.`status`,`order`.amout</span><br><span class=\"line\"> FROM `user` LEFT JOIN `order` ON `user`.uid=`order`.uid</span><br><span class=\"line\"></span><br><span class=\"line\">等价于</span><br><span class=\"line\"></span><br><span class=\"line\">SELECT `user`.`name`,`user`.mobile,`order`.order_id,`order`.`status`,`order`.amout</span><br><span class=\"line\"> FROM `order` RIGHT JOIN `user` ON `user`.uid=`order`.uid</span><br></pre></td></tr></table></figure></p>\n<p>结果集是：</p>\n<table>\n<thead>\n<tr>\n<th>name</th>\n<th style=\"text-align:center\">mobile</th>\n<th style=\"text-align:right\">order_id</th>\n<th style=\"text-align:right\">status</th>\n<th style=\"text-align:right\">amout</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>张三</td>\n<td style=\"text-align:center\">13547521456</td>\n<td style=\"text-align:right\">200</td>\n<td style=\"text-align:right\">0</td>\n<td style=\"text-align:right\">5899</td>\n</tr>\n<tr>\n<td>张三</td>\n<td style=\"text-align:center\">13547521456</td>\n<td style=\"text-align:right\">201</td>\n<td style=\"text-align:right\">0</td>\n<td style=\"text-align:right\">6799</td>\n</tr>\n<tr>\n<td>李四</td>\n<td style=\"text-align:center\">17025856329</td>\n<td style=\"text-align:right\">202</td>\n<td style=\"text-align:right\">0</td>\n<td style=\"text-align:right\">12699</td>\n</tr>\n<tr>\n<td>王五</td>\n<td style=\"text-align:center\">15925874536</td>\n<td style=\"text-align:right\">null</td>\n<td style=\"text-align:right\">null</td>\n<td style=\"text-align:right\">null</td>\n</tr>\n</tbody>\n</table>\n<p>可以看出错误的SQL语句中，查出了没有订单的用户“王五”</p>\n<h3 id=\"inner-join\"><a href=\"#inner-join\" class=\"headerlink\" title=\"inner join\"></a>inner join</h3><p>规律：</p>\n<ul>\n<li>A表 inner join B表；则返回A表和B表同时符合条件(on条件、where条件)的记录。</li>\n</ul>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">两种写法，后者使用的居多</span><br><span class=\"line\"></span><br><span class=\"line\">SELECT `user`.`name`,`user`.mobile,`order`.order_id,`order`.`status`,`order`.amout</span><br><span class=\"line\"> FROM `order` INNER JOIN `user` ON `user`.uid=`order`.uid;</span><br><span class=\"line\"></span><br><span class=\"line\">等价于</span><br><span class=\"line\"></span><br><span class=\"line\">SELECT `user`.`name`,`user`.mobile,`order`.order_id,`order`.`status`,`order`.amout</span><br><span class=\"line\"> FROM `order`,`user` WHERE `user`.uid=`order`.uid;</span><br></pre></td></tr></table></figure>\n<h3 id=\"left-outter-join-VS-right-outter-join\"><a href=\"#left-outter-join-VS-right-outter-join\" class=\"headerlink\" title=\"left outter join VS right outter join\"></a>left outter join VS right outter join</h3><p>left join 是left outer join的简写，left join默认是outer属性的。</p>\n<p>在某些数据库(如Oracle)中， left join 称为 left outer join；相应的right join 称为 right outter join</p>\n<h3 id=\"full-join\"><a href=\"#full-join\" class=\"headerlink\" title=\"full join\"></a>full join</h3><ul>\n<li>在某些数据库中， FULL JOIN 称为 FULL OUTER JOIN。</li>\n<li>只要其中某个表存在匹配，FULL JOIN 关键字就会返回行，意思是只需要有一个以上的表满足条件即可。</li>\n<li><p>Oracle 、DB2、SQL Server、PostgreSQL 支持 Full JOIN，但是 MySQL 是不支持的。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">MySQL使用FULL JOIN报错</span><br><span class=\"line\">[Err] 1054 - Unknown column &apos;order.uid&apos; in &apos;on clause&apos;</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>MySQL可以通过 LEFT JOIN + UNION + RIGHT JOIN 的方式 来实现Full JOIN。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">select `user`.`name`,`user`.mobile,`order`.order_id,`order`.`status`,`order`.amout</span><br><span class=\"line\"> from `order` left join `user` on `user`.uid=`order`.uid</span><br><span class=\"line\"> union</span><br><span class=\"line\">select `user`.`name`,`user`.mobile,`order`.order_id,`order`.`status`,`order`.amout</span><br><span class=\"line\"> from `order` right join `user` on `user`.uid=`order`.uid;</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<h3 id=\"cross-join\"><a href=\"#cross-join\" class=\"headerlink\" title=\"cross join\"></a>cross join</h3><p>除了在FROM子句中使用逗号间隔连接的表外，SQL还支持另一种被称为交叉连接的操作，它们都返回被连接的两个表所有数据行的笛卡尔积，返回到的数据行数等于第一个表中符合查询条件的数据行数乘以第二个表中符合查询条件的数据行数。惟一的不同在于，交叉连接分开列名时，使用CROSS JOIN关键字而不是逗号。</p>\n<p>实际上，下面两个表达式是完全等价的。<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">SELECT  *  FROM  table1, table2 WHERE table1.name=table2.name;</span><br><span class=\"line\">SELECT  *  FROM  table1  CROSS JOIN  table2 WHERE table1.name=table2.name;</span><br></pre></td></tr></table></figure></p>\n<p>在使用CROSS JOIN关键字交叉连接表时，因为生成的是两个表的笛卡尔积，因而不能使用ON关键字，只能在WHERE子句中定义搜索条件。</p>\n<p>事实上，直接使用CROSS JOIN很少得到想要的结果，但是，正如实例所示，作为查询的第一步，DBMS通常在FROM子句中，对连接的表进行CROSS JOIN，然后过滤得到的中间表。</p>\n<h3 id=\"union-union-all\"><a href=\"#union-union-all\" class=\"headerlink\" title=\"union,union all\"></a>union,union all</h3><p>在数据库中，union和union all关键字都是将两个结果集合并为一个，但这两者从使用和效率上来说都有所不同。</p>\n<p>union在进行表链接后会筛选掉重复的记录，所以在表链接后会对所产生的结果集进行排序运算，删除重复的记录再返回结果。</p>\n<p>如：<br> select <em> from test_union1<br>   union<br> select </em> from test_union2</p>\n<p>这个SQL在运行时先取出两个表的结果，再用排序空间进行排序删除重复的记录，最后返回结果集，如果表数据量大的话可能会导致用磁盘进行排序。而union all只是简单的将两个结果合并后就返回。这样，如果返回的两个结果集中有重复的数据，那么返回的结果集就会包含重复的数据了。从效率上说，union all要比union快很多，所以，如果可以确认合并的两个结果集中不包含重复的数据的话，那么就使用union all，</p>\n<p>如下：<br>select <em> from test_union1<br>union all<br>select </em> from test_union2</p>\n<p>使用 union 组合查询的结果集有两个最基本的规则：<br>1。所有查询中的列数和列的顺序必须相同。<br>2。数据类型必须兼容</p>\n<h3 id=\"Apache-Hive连接查询\"><a href=\"#Apache-Hive连接查询\" class=\"headerlink\" title=\"Apache Hive连接查询\"></a>Apache Hive连接查询</h3><p>Hive支持连接查询，但有一些条件必须遵守，比如只支持相等查询，其它查询如不等式查询则不支持，还支持外连接，左半连接查询。另外Hive支持多于两个表以上的连接查询。</p>\n<ul>\n<li><a href=\"http://blog.csdn.net/skywalker_only/article/details/39205973\" target=\"_blank\" rel=\"external\">Hive学习之连接查询</a></li>\n<li><a href=\"http://shiyanjun.cn/archives/588.html\" target=\"_blank\" rel=\"external\">Hive JOIN使用详解</a><h3 id=\"结合explain进行执行分析\"><a href=\"#结合explain进行执行分析\" class=\"headerlink\" title=\"结合explain进行执行分析\"></a>结合explain进行执行分析</h3></li>\n<li><a href=\"http://blog.csdn.net/mchdba/article/details/9190771\" target=\"_blank\" rel=\"external\">MySQL EXPLAIN 命令详解学习</a></li>\n</ul>\n<h3 id=\"数据库设计准则\"><a href=\"#数据库设计准则\" class=\"headerlink\" title=\"数据库设计准则\"></a>数据库设计准则</h3><ul>\n<li><p>一范式就是属性不可分割。属性是什么？就是表中的字段。不可分割的意思就按字面理解就是最小单位，不能再分成更小单位了。这个字段只能是一个值，不能被拆分成多个字段，否则的话，它就是可分割的，就不符合一范式。不过能不能分割并没有绝对的答案，看需求，也就是看你的设计目标而定。</p>\n</li>\n<li><p>二范式就是要有主键，要求其他字段都依赖于主键。为什么要有主键？没有主键就没有唯一性，没有唯一性在集合中就定位不到这行记录，所以要主键。其他字段为什么要依赖于主键？因为不依赖于主键，就找不到他们。更重要的是，其他字段组成的这行记录和主键表示的是同一个东西，而主键是唯一的，它们只需要依赖于主键，也就成了唯一的。</p>\n</li>\n<li><p>三范式就是要消除传递依赖，方便理解，可以看做是“消除冗余”。消除冗余应该比较好理解一些，就是各种信息只在一个地方存储，不出现在多张表中。</p>\n</li>\n</ul>\n","excerpt":"","more":"<p>数据库中的表可通过外键将彼此联系起来。主键（Primary Key）是一个列，在这个列中的每一行的值都是唯一的。在表中，每个主键的值都是唯一的。这样做的目的是在不重复每个表中的所有数据的情况下，把表间的数据交叉捆绑在一起。</p>\n<p>而在两个表之间建立关联关系，是不要求任何一个表的关联列(column)是主键的，这个关联列可以是任何类型的列，但是要求，两个表的关联列可以做关联关系的条件计算，为避免转换影响效率，两个关联列最好保持类型、长度一致。</p>\n<p>为方便说明，定义以下2张表：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">用户信息表</span><br><span class=\"line\">CREATE TABLE `user` (</span><br><span class=\"line\">  `uid` int(11) NOT NULL COMMENT &apos;用户id&apos;,</span><br><span class=\"line\">  `name` varchar(10) DEFAULT NULL COMMENT &apos;姓名&apos;,</span><br><span class=\"line\">  `sex` tinyint(1) DEFAULT NULL COMMENT &apos;性别&apos;,</span><br><span class=\"line\">  `age` tinyint(2) DEFAULT NULL COMMENT &apos;年龄&apos;,</span><br><span class=\"line\">  `mobile` varchar(11) DEFAULT NULL COMMENT &apos;手机号码&apos;,</span><br><span class=\"line\">  `password` varchar(64) NOT NULL COMMENT &apos;密码&apos;,</span><br><span class=\"line\">  `register_time` datetime NOT NULL COMMENT &apos;注册时间&apos;,</span><br><span class=\"line\">  PRIMARY KEY (`uid`),</span><br><span class=\"line\">  UNIQUE KEY `index_mobile` (`mobile`) USING BTREE</span><br><span class=\"line\">) ENGINE=InnoDB DEFAULT CHARSET=utf8;</span><br><span class=\"line\"></span><br><span class=\"line\">INSERT INTO `user` VALUES (&apos;100&apos;, &apos;张三&apos;, &apos;1&apos;, &apos;28&apos;, &apos;13547521456&apos;, &apos;ASDAWQ@!#SDF@#$%XCF&apos;, &apos;2016-03-30 17:47:51&apos;);</span><br><span class=\"line\">INSERT INTO `user` VALUES (&apos;101&apos;, &apos;李四&apos;, &apos;2&apos;, &apos;35&apos;, &apos;17025856329&apos;, &apos;234ASD@#$@#$AFSDFRT&apos;, &apos;2016-03-30 17:48:34&apos;);</span><br><span class=\"line\">INSERT INTO `user` VALUES (&apos;102&apos;, &apos;王五&apos;, &apos;1&apos;, &apos;48&apos;, &apos;15925874536&apos;, &apos;#$%SDFSDR@#$%@#$#@&apos;, &apos;2016-03-30 17:53:49&apos;);</span><br><span class=\"line\"></span><br><span class=\"line\">订单信息表</span><br><span class=\"line\">CREATE TABLE `order` (</span><br><span class=\"line\">  `order_id` int(11) NOT NULL COMMENT &apos;订单编号&apos;,</span><br><span class=\"line\">  `uid` int(11) DEFAULT NULL COMMENT &apos;用户Id&apos;,</span><br><span class=\"line\">  `amout` mediumtext NOT NULL COMMENT &apos;订单金额(单位为分)&apos;,</span><br><span class=\"line\">  `status` tinyint(2) DEFAULT NULL COMMENT &apos;订单状态&apos;,</span><br><span class=\"line\">  `order_time` datetime DEFAULT NULL COMMENT &apos;订单时间&apos;,</span><br><span class=\"line\">  PRIMARY KEY (`order_id`)</span><br><span class=\"line\">) ENGINE=InnoDB DEFAULT CHARSET=utf8;</span><br><span class=\"line\"></span><br><span class=\"line\">INSERT INTO `order` VALUES (&apos;200&apos;, &apos;100&apos;, &apos;5899&apos;, &apos;0&apos;, &apos;2016-03-30 17:54:20&apos;);</span><br><span class=\"line\">INSERT INTO `order` VALUES (&apos;201&apos;, &apos;100&apos;, &apos;6799&apos;, &apos;0&apos;, &apos;2016-03-30 17:54:38&apos;);</span><br><span class=\"line\">INSERT INTO `order` VALUES (&apos;202&apos;, &apos;101&apos;, &apos;12699&apos;, &apos;0&apos;, &apos;2016-03-30 17:55:01&apos;);</span><br></pre></td></tr></table></figure></p>\n<p>数据库现在2张表的数据看起来是这样：<br>user表</p>\n<table>\n<thead>\n<tr>\n<th>uid</th>\n<th style=\"text-align:center\">name</th>\n<th style=\"text-align:right\">sex</th>\n<th style=\"text-align:right\">age</th>\n<th style=\"text-align:right\">mobile</th>\n<th style=\"text-align:right\">password</th>\n<th style=\"text-align:right\">register_time</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>100</td>\n<td style=\"text-align:center\">张三</td>\n<td style=\"text-align:right\">1</td>\n<td style=\"text-align:right\">28</td>\n<td style=\"text-align:right\">13547521456</td>\n<td style=\"text-align:right\">password</td>\n<td style=\"text-align:right\">2016-03-30 17:47:51</td>\n</tr>\n<tr>\n<td>101</td>\n<td style=\"text-align:center\">李四</td>\n<td style=\"text-align:right\">2</td>\n<td style=\"text-align:right\">35</td>\n<td style=\"text-align:right\">17025856329</td>\n<td style=\"text-align:right\">password</td>\n<td style=\"text-align:right\">2016-03-30 17:48:34</td>\n</tr>\n<tr>\n<td>102</td>\n<td style=\"text-align:center\">王五</td>\n<td style=\"text-align:right\">1</td>\n<td style=\"text-align:right\">48</td>\n<td style=\"text-align:right\">15925874536</td>\n<td style=\"text-align:right\">password</td>\n<td style=\"text-align:right\">2016-03-30 17:53:49</td>\n</tr>\n</tbody>\n</table>\n<p>order表</p>\n<table>\n<thead>\n<tr>\n<th>order_id</th>\n<th style=\"text-align:center\">uid</th>\n<th style=\"text-align:right\">amout</th>\n<th style=\"text-align:right\">status</th>\n<th style=\"text-align:right\">order_time</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>200</td>\n<td style=\"text-align:center\">100</td>\n<td style=\"text-align:right\">5899</td>\n<td style=\"text-align:right\">0</td>\n<td style=\"text-align:right\">2016-03-30 17:54:20</td>\n</tr>\n<tr>\n<td>201</td>\n<td style=\"text-align:center\">100</td>\n<td style=\"text-align:right\">6799</td>\n<td style=\"text-align:right\">0</td>\n<td style=\"text-align:right\">2016-03-30 17:54:38</td>\n</tr>\n<tr>\n<td>202</td>\n<td style=\"text-align:center\">101</td>\n<td style=\"text-align:right\">12699</td>\n<td style=\"text-align:right\">0</td>\n<td style=\"text-align:right\">2016-03-30 17:55:01</td>\n</tr>\n</tbody>\n</table>\n<h2 id=\"练习题\"><a href=\"#练习题\" class=\"headerlink\" title=\"练习题\"></a>练习题</h2><p>查询所有用户的订单信息，订单信息不能为空，要求返回的字段有：用户姓名、手机号码、订单号、订单状态、订单金额。</p>\n<h3 id=\"left-join-VS-right-join\"><a href=\"#left-join-VS-right-join\" class=\"headerlink\" title=\"left join VS right join\"></a>left join VS right join</h3><p>规律：</p>\n<ul>\n<li>A表 left join B表；则返回A表的所有符合条件(on条件、where条件)的记录。A表的字段不会为null，而B表没有对应记录时,字段值返回null。</li>\n<li><p>B表 left join A表；则返回B表的所有符合条件(on条件、where条件)的记录。B表的字段不会为null，而A表没有对应记录时,字段值返回null。</p>\n</li>\n<li><p>A表 left join B表 等价于 B表 right join A表.</p>\n</li>\n<li>A表 right join B表 等价于 B表 left join A表.</li>\n</ul>\n<p>正确的SQL语句：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">SELECT `user`.`name`,`user`.mobile,`order`.order_id,`order`.`status`,`order`.amout</span><br><span class=\"line\"> FROM `user` RIGHT JOIN `order` ON `user`.uid=`order`.uid</span><br><span class=\"line\"></span><br><span class=\"line\">等价于</span><br><span class=\"line\"></span><br><span class=\"line\">SELECT `user`.`name`,`user`.mobile,`order`.order_id,`order`.`status`,`order`.amout</span><br><span class=\"line\"> FROM `order` LEFT JOIN `user` ON `user`.uid=`order`.uid</span><br></pre></td></tr></table></figure></p>\n<p>结果集是：</p>\n<table>\n<thead>\n<tr>\n<th>name</th>\n<th style=\"text-align:center\">mobile</th>\n<th style=\"text-align:right\">order_id</th>\n<th style=\"text-align:right\">status</th>\n<th style=\"text-align:right\">amout</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>张三</td>\n<td style=\"text-align:center\">13547521456</td>\n<td style=\"text-align:right\">200</td>\n<td style=\"text-align:right\">0</td>\n<td style=\"text-align:right\">5899</td>\n</tr>\n<tr>\n<td>张三</td>\n<td style=\"text-align:center\">13547521456</td>\n<td style=\"text-align:right\">201</td>\n<td style=\"text-align:right\">0</td>\n<td style=\"text-align:right\">6799</td>\n</tr>\n<tr>\n<td>李四</td>\n<td style=\"text-align:center\">17025856329</td>\n<td style=\"text-align:right\">202</td>\n<td style=\"text-align:right\">0</td>\n<td style=\"text-align:right\">12699</td>\n</tr>\n</tbody>\n</table>\n<p>错误的SQL语句：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">SELECT `user`.`name`,`user`.mobile,`order`.order_id,`order`.`status`,`order`.amout</span><br><span class=\"line\"> FROM `user` LEFT JOIN `order` ON `user`.uid=`order`.uid</span><br><span class=\"line\"></span><br><span class=\"line\">等价于</span><br><span class=\"line\"></span><br><span class=\"line\">SELECT `user`.`name`,`user`.mobile,`order`.order_id,`order`.`status`,`order`.amout</span><br><span class=\"line\"> FROM `order` RIGHT JOIN `user` ON `user`.uid=`order`.uid</span><br></pre></td></tr></table></figure></p>\n<p>结果集是：</p>\n<table>\n<thead>\n<tr>\n<th>name</th>\n<th style=\"text-align:center\">mobile</th>\n<th style=\"text-align:right\">order_id</th>\n<th style=\"text-align:right\">status</th>\n<th style=\"text-align:right\">amout</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>张三</td>\n<td style=\"text-align:center\">13547521456</td>\n<td style=\"text-align:right\">200</td>\n<td style=\"text-align:right\">0</td>\n<td style=\"text-align:right\">5899</td>\n</tr>\n<tr>\n<td>张三</td>\n<td style=\"text-align:center\">13547521456</td>\n<td style=\"text-align:right\">201</td>\n<td style=\"text-align:right\">0</td>\n<td style=\"text-align:right\">6799</td>\n</tr>\n<tr>\n<td>李四</td>\n<td style=\"text-align:center\">17025856329</td>\n<td style=\"text-align:right\">202</td>\n<td style=\"text-align:right\">0</td>\n<td style=\"text-align:right\">12699</td>\n</tr>\n<tr>\n<td>王五</td>\n<td style=\"text-align:center\">15925874536</td>\n<td style=\"text-align:right\">null</td>\n<td style=\"text-align:right\">null</td>\n<td style=\"text-align:right\">null</td>\n</tr>\n</tbody>\n</table>\n<p>可以看出错误的SQL语句中，查出了没有订单的用户“王五”</p>\n<h3 id=\"inner-join\"><a href=\"#inner-join\" class=\"headerlink\" title=\"inner join\"></a>inner join</h3><p>规律：</p>\n<ul>\n<li>A表 inner join B表；则返回A表和B表同时符合条件(on条件、where条件)的记录。</li>\n</ul>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">两种写法，后者使用的居多</span><br><span class=\"line\"></span><br><span class=\"line\">SELECT `user`.`name`,`user`.mobile,`order`.order_id,`order`.`status`,`order`.amout</span><br><span class=\"line\"> FROM `order` INNER JOIN `user` ON `user`.uid=`order`.uid;</span><br><span class=\"line\"></span><br><span class=\"line\">等价于</span><br><span class=\"line\"></span><br><span class=\"line\">SELECT `user`.`name`,`user`.mobile,`order`.order_id,`order`.`status`,`order`.amout</span><br><span class=\"line\"> FROM `order`,`user` WHERE `user`.uid=`order`.uid;</span><br></pre></td></tr></table></figure>\n<h3 id=\"left-outter-join-VS-right-outter-join\"><a href=\"#left-outter-join-VS-right-outter-join\" class=\"headerlink\" title=\"left outter join VS right outter join\"></a>left outter join VS right outter join</h3><p>left join 是left outer join的简写，left join默认是outer属性的。</p>\n<p>在某些数据库(如Oracle)中， left join 称为 left outer join；相应的right join 称为 right outter join</p>\n<h3 id=\"full-join\"><a href=\"#full-join\" class=\"headerlink\" title=\"full join\"></a>full join</h3><ul>\n<li>在某些数据库中， FULL JOIN 称为 FULL OUTER JOIN。</li>\n<li>只要其中某个表存在匹配，FULL JOIN 关键字就会返回行，意思是只需要有一个以上的表满足条件即可。</li>\n<li><p>Oracle 、DB2、SQL Server、PostgreSQL 支持 Full JOIN，但是 MySQL 是不支持的。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">MySQL使用FULL JOIN报错</span><br><span class=\"line\">[Err] 1054 - Unknown column &apos;order.uid&apos; in &apos;on clause&apos;</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>MySQL可以通过 LEFT JOIN + UNION + RIGHT JOIN 的方式 来实现Full JOIN。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">select `user`.`name`,`user`.mobile,`order`.order_id,`order`.`status`,`order`.amout</span><br><span class=\"line\"> from `order` left join `user` on `user`.uid=`order`.uid</span><br><span class=\"line\"> union</span><br><span class=\"line\">select `user`.`name`,`user`.mobile,`order`.order_id,`order`.`status`,`order`.amout</span><br><span class=\"line\"> from `order` right join `user` on `user`.uid=`order`.uid;</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<h3 id=\"cross-join\"><a href=\"#cross-join\" class=\"headerlink\" title=\"cross join\"></a>cross join</h3><p>除了在FROM子句中使用逗号间隔连接的表外，SQL还支持另一种被称为交叉连接的操作，它们都返回被连接的两个表所有数据行的笛卡尔积，返回到的数据行数等于第一个表中符合查询条件的数据行数乘以第二个表中符合查询条件的数据行数。惟一的不同在于，交叉连接分开列名时，使用CROSS JOIN关键字而不是逗号。</p>\n<p>实际上，下面两个表达式是完全等价的。<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">SELECT  *  FROM  table1, table2 WHERE table1.name=table2.name;</span><br><span class=\"line\">SELECT  *  FROM  table1  CROSS JOIN  table2 WHERE table1.name=table2.name;</span><br></pre></td></tr></table></figure></p>\n<p>在使用CROSS JOIN关键字交叉连接表时，因为生成的是两个表的笛卡尔积，因而不能使用ON关键字，只能在WHERE子句中定义搜索条件。</p>\n<p>事实上，直接使用CROSS JOIN很少得到想要的结果，但是，正如实例所示，作为查询的第一步，DBMS通常在FROM子句中，对连接的表进行CROSS JOIN，然后过滤得到的中间表。</p>\n<h3 id=\"union-union-all\"><a href=\"#union-union-all\" class=\"headerlink\" title=\"union,union all\"></a>union,union all</h3><p>在数据库中，union和union all关键字都是将两个结果集合并为一个，但这两者从使用和效率上来说都有所不同。</p>\n<p>union在进行表链接后会筛选掉重复的记录，所以在表链接后会对所产生的结果集进行排序运算，删除重复的记录再返回结果。</p>\n<p>如：<br> select <em> from test_union1<br>   union<br> select </em> from test_union2</p>\n<p>这个SQL在运行时先取出两个表的结果，再用排序空间进行排序删除重复的记录，最后返回结果集，如果表数据量大的话可能会导致用磁盘进行排序。而union all只是简单的将两个结果合并后就返回。这样，如果返回的两个结果集中有重复的数据，那么返回的结果集就会包含重复的数据了。从效率上说，union all要比union快很多，所以，如果可以确认合并的两个结果集中不包含重复的数据的话，那么就使用union all，</p>\n<p>如下：<br>select <em> from test_union1<br>union all<br>select </em> from test_union2</p>\n<p>使用 union 组合查询的结果集有两个最基本的规则：<br>1。所有查询中的列数和列的顺序必须相同。<br>2。数据类型必须兼容</p>\n<h3 id=\"Apache-Hive连接查询\"><a href=\"#Apache-Hive连接查询\" class=\"headerlink\" title=\"Apache Hive连接查询\"></a>Apache Hive连接查询</h3><p>Hive支持连接查询，但有一些条件必须遵守，比如只支持相等查询，其它查询如不等式查询则不支持，还支持外连接，左半连接查询。另外Hive支持多于两个表以上的连接查询。</p>\n<ul>\n<li><a href=\"http://blog.csdn.net/skywalker_only/article/details/39205973\">Hive学习之连接查询</a></li>\n<li><a href=\"http://shiyanjun.cn/archives/588.html\">Hive JOIN使用详解</a><h3 id=\"结合explain进行执行分析\"><a href=\"#结合explain进行执行分析\" class=\"headerlink\" title=\"结合explain进行执行分析\"></a>结合explain进行执行分析</h3></li>\n<li><a href=\"http://blog.csdn.net/mchdba/article/details/9190771\">MySQL EXPLAIN 命令详解学习</a></li>\n</ul>\n<h3 id=\"数据库设计准则\"><a href=\"#数据库设计准则\" class=\"headerlink\" title=\"数据库设计准则\"></a>数据库设计准则</h3><ul>\n<li><p>一范式就是属性不可分割。属性是什么？就是表中的字段。不可分割的意思就按字面理解就是最小单位，不能再分成更小单位了。这个字段只能是一个值，不能被拆分成多个字段，否则的话，它就是可分割的，就不符合一范式。不过能不能分割并没有绝对的答案，看需求，也就是看你的设计目标而定。</p>\n</li>\n<li><p>二范式就是要有主键，要求其他字段都依赖于主键。为什么要有主键？没有主键就没有唯一性，没有唯一性在集合中就定位不到这行记录，所以要主键。其他字段为什么要依赖于主键？因为不依赖于主键，就找不到他们。更重要的是，其他字段组成的这行记录和主键表示的是同一个东西，而主键是唯一的，它们只需要依赖于主键，也就成了唯一的。</p>\n</li>\n<li><p>三范式就是要消除传递依赖，方便理解，可以看做是“消除冗余”。消除冗余应该比较好理解一些，就是各种信息只在一个地方存储，不出现在多张表中。</p>\n</li>\n</ul>\n"},{"title":"分布式软件理论总结","date":"2016-05-23T03:34:28.000Z","description":"集中式的软件系统在濒危阶段，开发团队往往面临两难，团队任何人都知道急需重构，但因为没有决策权，最高决策领导也顾虑着市场利益，而不可能给出重构所需的资源(时间、人力、软硬件)。在愈发杂乱的系统上进行维护和新功能叠加，这让团队内的每个人都需要指数级的投入成本，往往还达不到市场需要的质量。","_content":"\n![](/img/thinking.jpg)\n\n# 软件系统的本质\n\n软件是现实的抽象，讨论抽象的本质是困难的，让我们一起在现实中思考。小到一支笔，大到一部汽车，这些产品的出现，使我们在现实生活中得到了方便。这里说的方便，是指因为使用了这些产品，降低了成本，提高了效率。在没有笔的时代，想要记录信息需要结绳、岩画或篆刻，这是高成本的，效率也很低。同样的，没有汽车的时代，想要到达另一个城市，会因为恶劣天气而被迫中途搁置，相应的通行时间也会比现在长得多。进一步的思考，笔与汽车的共同点又在哪里呢？\n\n笔与汽车，这些产品是为了满足人们的各类生活需求而发明的。即，人们因为现实需要，而发明或改进了产品，产品是为了帮助人们更好的生活而存在。同样的，软件系统也是如此，人们出于远距离沟通交流需要，发明电话拨号系统；因为更随时随地的信息多样化交流，发明了各种互联网IM产品。\n\n软件系统是依托于人们现实需求而存在，用以辅助人们更好的生活，它是现实世界在虚拟世界的抽象。同样的软件系统也存在着兴衰淘汰，一款软件刚问世时，受欢迎程度总是处于低谷，存在现实世界对其接受适应的时间窗。突破时间窗，进而逐渐闻名天下，此时依托此软件又会催生出许多子软件链（如chromium的众多壳浏览器、SVN的众多客户端）。随着技术革新，软件产业也会更新换代，跟不上时代的软件系统会逐渐退出市场（如vista操作系统的短命）。但市场总是存在需要的，类似的软件在倒下后总会有后继者，如浏览器，这几乎在国内，每家互联网公司都想做或者已经在做。\n\n# 不良设计的局限性\n\n在软件系统的发展初期，适用面狭窄，功能单一、用户少、价值不够高，造成对软件系统研发的不重视，成本投入低。相应的，软件所带来的经济收益也是有限的。此时的软件系统往往谈不上架构，往往是一个软件系统承载了所有功能，单个功能模块没有边界，逻辑分散，而各个功能模块之间的耦合关系是散乱的。\n\n![](/img/chaos.jpg)\n\n在软件系统有机会成长起来后，带来了一定的经济收益。我们会思考软件系统的功能增多，更适应于用户（市场需要），或者考虑增强原有用户黏性，此时会对软件系统提出更多要求。而初期功能模块散乱的堆叠，对迫切需要的可扩展性带来了的麻烦，紧耦合的架构造成牵一发而动全身的问题，新功能的增加，往往意味着巨大地改造成本。勉强加上一些功能后，整个软件系统简直是乱作一团，就像是一堆红豆绿豆，这样的软件系统，我们称之为集中式软件系统。\n\n集中式的软件系统还对重构带来挑战，随着功能需求越来越频繁的提出，往往意味着需要更短的版本迭代周期。现有系统无法灵活扩展，意味着需要对整个软件系统进行重构，而等到软件散乱性膨胀到一定程度，重构几乎变成不可完成的任务，就算是系统初始负责人，也无法评估重构带来的风险与收益究竟谁更多？\n\n## 停不下来的运动员\n\n集中式的软件系统在濒危阶段，开发团队往往面临两难，团队任何人都知道急需重构，但因为没有决策权，最高决策领导也顾虑着市场利益，而不可能给出重构所需的资源(时间、人力、软硬件)。在愈发杂乱的系统上进行维护和新功能叠加，这让团队内的每个人都需要指数级的投入成本，往往还达不到市场需要的质量。\n\n就像田径400米接力比赛中，只能跑第一棒的运动员，本应在交棒后停下来休息，自我调整。而由于接手下一棒的运动员迟迟不能到位，运动员只能咬牙坚持跑第二棒，但迈出的每一步都越来越累，没法再像刚开始保持加速度。更令人担忧的是，此时裁判还吹响了冲刺哨，要求运动员进行冲锋。这样，运动员只有倒下了。相应的，软件系统到此时，开发团队成员会加速流失，新招进来的人也很难理解整套系统的协作，经常顾此失彼，从而导致最终的系统失败。\n\n这也就是为什么CTO必需对技术团队保持深入理解，同时还应有对产品、开发的最高决策权，以支持技术团队在适时进行系统级别的重构，让失去体力的软件系统下线休息，换上更适合的新软件系统上线，从而更好地满足公司的战略需求，这是非常有必要的。\n\n# 向敏捷开发过渡\n\n\n![](/img/building-blocks.jpg)\n\n\n在软件系统有机会从集中式软件模式，过渡到积木型的软件模式后。系统原有是100%的功能堆叠到一个系统，现在变成了多个积木，也就是软件子系统，每个积木只负责其中的部分功能，积木间的协作，从而拼装出完整的软件系统。\n\n## 快速交付\n\n集中式的软件往往灵活性低下，这体现在很多方面。\n\n1.设计的灵活性，想要以好的设计替换掉不再适应设计方案，会遭遇无法评估改造成本。\n\n2.构建的灵活性，软件功能过于集中，导致一个小的编译问题，都会影响整个软件的构建，就像走钢丝一样，必需每一步都完美无缺才能安全走到终点。\n\n3.测试的灵活性，测试任务因为功能互相紧耦合而变得繁重，无法评估已经做好的功能是否会受到影响。\n\n4.部署的灵活性，运维无法根据系统的流量特性来优化软硬件配置，如JVM调优，Load Balance等。\n\n5.修复的灵活性，这一点往往在集中式软件中是一个优势，在线上出现问题，只需要简单的分析少量的运行日志即可定位问题，这在积木性系统中是一个软肋。\n\n敏捷开发的主要优势就在于，合理的利用分治思想，将复杂的功能的系统模块化处理，拆分成由只有简单功能的子系统而拼凑出来的完整系统，每一个子系统可以交付到小团队来维护，甚至与有单独的运维人员来进行保障。\n\n![](/img/MircoService.png)\n\n## 可维护性\n\n这是一个巨大的转变，首当其冲的就是可维护性，只需要定义一套灵活的通信协议，子系统之间通过这套协议进行通讯，我们在对子系统内部的功能进行维护时，不必担忧其他子系统受到干扰。这也存在一个前提，能够封装在一个子系统的功能模块集合，必须是内聚型的，它们几乎很少对外层子系统产生耦合，或者通过统一的出口进行耦合关联。\n\n## 可扩展性\n\n其次是软件的可扩展性，新功能的开发，只需要新加一个子系统，扩展通讯协议，就可以满足要求，这对团队内的任何一个人都是令人振奋的。\n\n## 隔离性\n\n积木型的软件构建，还给了我们保持专注的可能。现在我们可以为软件进行动静分离设计，以适应不同的最佳部署方式。可以按照系统流量特性，应用CQRS架构，提供更好的局部性能。进一步的还可以为强共用性的功能进行独立剥离出来，譬如单独的文件系统负责所有的文件服务，以在避免各个积木内部的重复造轮子，独立的服务还为以后的：可维护性、伸缩性带来了诸多方便。\n\n## 质量可控\n\n同时，软件的质量可以得到保证，测试部门可以明确的针对某个软件子系统进行测试，而不需要每次系统上线都进行整体测试，工作量的降低，在相等的时间内，有了更多的时间进行问题修复，这往往意味着质量的提高。\n\n\n积木型的软件，是对积木之间通讯协议的高要求，实际上，我们需要引入一整套消息通讯中间件来解决这个问题，在SOA和EDA架构中，最为关键的就是MQ协议的设计了。\n\n松耦合的模式还带来局部失败和最终一致性的问题，可能会给用户造成短时间迷惑，但不影响最终的数据状态统一，这在传统软件领域往往是不可接受的，但进入到互联网后，在系统层面往往需要进行权衡，是市场机遇重要？还是少部分的用户利益重要？这个问题需要每一个互联网人的思考，产品是不是要满足每一个人的要求呢？\n\n\n# 分布式系统的利与弊\n\n## 软件的构成\n\n概括的讲，软件普遍是由三部分组成：接入、逻辑、存储。其中接入是可能没有的，比如定时任务型软件，由操作系统时间来触发，不需要外界的主动调度。而逻辑和存储，很难有软件是不需要的。而比如典型的在线社交服务，常规的构成可以分为：聊天服务、长连接服务、推送服务、好友信息服务、文件服务、推荐服务、广告服务。这些按业务功能相关性而划分的服务，没有哪一个可以脱离接入、逻辑和存储的。这些服务从本质上来说大部分都是OLTP([Online Transaction Processing](http://blog.csdn.net/tianlesoftware/article/details/5794844))，就是将现实生活中的沟通交流需求转移到了互联网进行。\n\n## SOA VS EDA\n\n### 什么是SOA？\n#### SOA VS Mirco Service\n\n### 什么是EDA？\n\n### 分场景使用\n\n\n\n## Design for failure\n\n### Fast fail VS Retry\n\n\n\n## 无状态\n\n## 应用中心和任务中心\n\n单点服务向多点服务的转变\n\n原因：\n性能要求，多节点同时参与服务(按流量权重分发，负载均衡；按读写流量分发，读写分离)。\n允许少部分节点失败，更可靠的运行。\n\n数据存储跨机分片，同时每片在多机存在复制集。计算资源无状态，本身就可以动态管理。便捷的扩容缩容(伸缩性)。\n\n因业务分拆，降低耦合粒度，降低系统扩展成本(可扩展性)，更高的可维护性。\n\n\n\n带来的问题。\n系统内部改造，支持多节点转变。\n\n分布式事务，事务补偿。\n\n分布式存储\n\n分布式访问\n\n容忍最终一致性。\n\n\n\n# Reference\n\n* [互联网系统可靠性基础：正确的异常处理](https://blog.eood.cn/exception)\n\n* [微服务设计：熔断器模式](http://www.sczyh30.com/posts/Microservice/circuit-breaker-pattern/)\n\n* [采用断路器设计模式来保护软件](http://ju.outofmemory.cn/entry/195996)","source":"_posts/Summary-of-distributed-theory.md","raw":"---\ntitle: 分布式软件理论总结\ndate: 2016-5-23 11:34:28\ntags:\n    - Distributed\ncategories:\n    - Summary\ndescription: 集中式的软件系统在濒危阶段，开发团队往往面临两难，团队任何人都知道急需重构，但因为没有决策权，最高决策领导也顾虑着市场利益，而不可能给出重构所需的资源(时间、人力、软硬件)。在愈发杂乱的系统上进行维护和新功能叠加，这让团队内的每个人都需要指数级的投入成本，往往还达不到市场需要的质量。\n---\n\n![](/img/thinking.jpg)\n\n# 软件系统的本质\n\n软件是现实的抽象，讨论抽象的本质是困难的，让我们一起在现实中思考。小到一支笔，大到一部汽车，这些产品的出现，使我们在现实生活中得到了方便。这里说的方便，是指因为使用了这些产品，降低了成本，提高了效率。在没有笔的时代，想要记录信息需要结绳、岩画或篆刻，这是高成本的，效率也很低。同样的，没有汽车的时代，想要到达另一个城市，会因为恶劣天气而被迫中途搁置，相应的通行时间也会比现在长得多。进一步的思考，笔与汽车的共同点又在哪里呢？\n\n笔与汽车，这些产品是为了满足人们的各类生活需求而发明的。即，人们因为现实需要，而发明或改进了产品，产品是为了帮助人们更好的生活而存在。同样的，软件系统也是如此，人们出于远距离沟通交流需要，发明电话拨号系统；因为更随时随地的信息多样化交流，发明了各种互联网IM产品。\n\n软件系统是依托于人们现实需求而存在，用以辅助人们更好的生活，它是现实世界在虚拟世界的抽象。同样的软件系统也存在着兴衰淘汰，一款软件刚问世时，受欢迎程度总是处于低谷，存在现实世界对其接受适应的时间窗。突破时间窗，进而逐渐闻名天下，此时依托此软件又会催生出许多子软件链（如chromium的众多壳浏览器、SVN的众多客户端）。随着技术革新，软件产业也会更新换代，跟不上时代的软件系统会逐渐退出市场（如vista操作系统的短命）。但市场总是存在需要的，类似的软件在倒下后总会有后继者，如浏览器，这几乎在国内，每家互联网公司都想做或者已经在做。\n\n# 不良设计的局限性\n\n在软件系统的发展初期，适用面狭窄，功能单一、用户少、价值不够高，造成对软件系统研发的不重视，成本投入低。相应的，软件所带来的经济收益也是有限的。此时的软件系统往往谈不上架构，往往是一个软件系统承载了所有功能，单个功能模块没有边界，逻辑分散，而各个功能模块之间的耦合关系是散乱的。\n\n![](/img/chaos.jpg)\n\n在软件系统有机会成长起来后，带来了一定的经济收益。我们会思考软件系统的功能增多，更适应于用户（市场需要），或者考虑增强原有用户黏性，此时会对软件系统提出更多要求。而初期功能模块散乱的堆叠，对迫切需要的可扩展性带来了的麻烦，紧耦合的架构造成牵一发而动全身的问题，新功能的增加，往往意味着巨大地改造成本。勉强加上一些功能后，整个软件系统简直是乱作一团，就像是一堆红豆绿豆，这样的软件系统，我们称之为集中式软件系统。\n\n集中式的软件系统还对重构带来挑战，随着功能需求越来越频繁的提出，往往意味着需要更短的版本迭代周期。现有系统无法灵活扩展，意味着需要对整个软件系统进行重构，而等到软件散乱性膨胀到一定程度，重构几乎变成不可完成的任务，就算是系统初始负责人，也无法评估重构带来的风险与收益究竟谁更多？\n\n## 停不下来的运动员\n\n集中式的软件系统在濒危阶段，开发团队往往面临两难，团队任何人都知道急需重构，但因为没有决策权，最高决策领导也顾虑着市场利益，而不可能给出重构所需的资源(时间、人力、软硬件)。在愈发杂乱的系统上进行维护和新功能叠加，这让团队内的每个人都需要指数级的投入成本，往往还达不到市场需要的质量。\n\n就像田径400米接力比赛中，只能跑第一棒的运动员，本应在交棒后停下来休息，自我调整。而由于接手下一棒的运动员迟迟不能到位，运动员只能咬牙坚持跑第二棒，但迈出的每一步都越来越累，没法再像刚开始保持加速度。更令人担忧的是，此时裁判还吹响了冲刺哨，要求运动员进行冲锋。这样，运动员只有倒下了。相应的，软件系统到此时，开发团队成员会加速流失，新招进来的人也很难理解整套系统的协作，经常顾此失彼，从而导致最终的系统失败。\n\n这也就是为什么CTO必需对技术团队保持深入理解，同时还应有对产品、开发的最高决策权，以支持技术团队在适时进行系统级别的重构，让失去体力的软件系统下线休息，换上更适合的新软件系统上线，从而更好地满足公司的战略需求，这是非常有必要的。\n\n# 向敏捷开发过渡\n\n\n![](/img/building-blocks.jpg)\n\n\n在软件系统有机会从集中式软件模式，过渡到积木型的软件模式后。系统原有是100%的功能堆叠到一个系统，现在变成了多个积木，也就是软件子系统，每个积木只负责其中的部分功能，积木间的协作，从而拼装出完整的软件系统。\n\n## 快速交付\n\n集中式的软件往往灵活性低下，这体现在很多方面。\n\n1.设计的灵活性，想要以好的设计替换掉不再适应设计方案，会遭遇无法评估改造成本。\n\n2.构建的灵活性，软件功能过于集中，导致一个小的编译问题，都会影响整个软件的构建，就像走钢丝一样，必需每一步都完美无缺才能安全走到终点。\n\n3.测试的灵活性，测试任务因为功能互相紧耦合而变得繁重，无法评估已经做好的功能是否会受到影响。\n\n4.部署的灵活性，运维无法根据系统的流量特性来优化软硬件配置，如JVM调优，Load Balance等。\n\n5.修复的灵活性，这一点往往在集中式软件中是一个优势，在线上出现问题，只需要简单的分析少量的运行日志即可定位问题，这在积木性系统中是一个软肋。\n\n敏捷开发的主要优势就在于，合理的利用分治思想，将复杂的功能的系统模块化处理，拆分成由只有简单功能的子系统而拼凑出来的完整系统，每一个子系统可以交付到小团队来维护，甚至与有单独的运维人员来进行保障。\n\n![](/img/MircoService.png)\n\n## 可维护性\n\n这是一个巨大的转变，首当其冲的就是可维护性，只需要定义一套灵活的通信协议，子系统之间通过这套协议进行通讯，我们在对子系统内部的功能进行维护时，不必担忧其他子系统受到干扰。这也存在一个前提，能够封装在一个子系统的功能模块集合，必须是内聚型的，它们几乎很少对外层子系统产生耦合，或者通过统一的出口进行耦合关联。\n\n## 可扩展性\n\n其次是软件的可扩展性，新功能的开发，只需要新加一个子系统，扩展通讯协议，就可以满足要求，这对团队内的任何一个人都是令人振奋的。\n\n## 隔离性\n\n积木型的软件构建，还给了我们保持专注的可能。现在我们可以为软件进行动静分离设计，以适应不同的最佳部署方式。可以按照系统流量特性，应用CQRS架构，提供更好的局部性能。进一步的还可以为强共用性的功能进行独立剥离出来，譬如单独的文件系统负责所有的文件服务，以在避免各个积木内部的重复造轮子，独立的服务还为以后的：可维护性、伸缩性带来了诸多方便。\n\n## 质量可控\n\n同时，软件的质量可以得到保证，测试部门可以明确的针对某个软件子系统进行测试，而不需要每次系统上线都进行整体测试，工作量的降低，在相等的时间内，有了更多的时间进行问题修复，这往往意味着质量的提高。\n\n\n积木型的软件，是对积木之间通讯协议的高要求，实际上，我们需要引入一整套消息通讯中间件来解决这个问题，在SOA和EDA架构中，最为关键的就是MQ协议的设计了。\n\n松耦合的模式还带来局部失败和最终一致性的问题，可能会给用户造成短时间迷惑，但不影响最终的数据状态统一，这在传统软件领域往往是不可接受的，但进入到互联网后，在系统层面往往需要进行权衡，是市场机遇重要？还是少部分的用户利益重要？这个问题需要每一个互联网人的思考，产品是不是要满足每一个人的要求呢？\n\n\n# 分布式系统的利与弊\n\n## 软件的构成\n\n概括的讲，软件普遍是由三部分组成：接入、逻辑、存储。其中接入是可能没有的，比如定时任务型软件，由操作系统时间来触发，不需要外界的主动调度。而逻辑和存储，很难有软件是不需要的。而比如典型的在线社交服务，常规的构成可以分为：聊天服务、长连接服务、推送服务、好友信息服务、文件服务、推荐服务、广告服务。这些按业务功能相关性而划分的服务，没有哪一个可以脱离接入、逻辑和存储的。这些服务从本质上来说大部分都是OLTP([Online Transaction Processing](http://blog.csdn.net/tianlesoftware/article/details/5794844))，就是将现实生活中的沟通交流需求转移到了互联网进行。\n\n## SOA VS EDA\n\n### 什么是SOA？\n#### SOA VS Mirco Service\n\n### 什么是EDA？\n\n### 分场景使用\n\n\n\n## Design for failure\n\n### Fast fail VS Retry\n\n\n\n## 无状态\n\n## 应用中心和任务中心\n\n单点服务向多点服务的转变\n\n原因：\n性能要求，多节点同时参与服务(按流量权重分发，负载均衡；按读写流量分发，读写分离)。\n允许少部分节点失败，更可靠的运行。\n\n数据存储跨机分片，同时每片在多机存在复制集。计算资源无状态，本身就可以动态管理。便捷的扩容缩容(伸缩性)。\n\n因业务分拆，降低耦合粒度，降低系统扩展成本(可扩展性)，更高的可维护性。\n\n\n\n带来的问题。\n系统内部改造，支持多节点转变。\n\n分布式事务，事务补偿。\n\n分布式存储\n\n分布式访问\n\n容忍最终一致性。\n\n\n\n# Reference\n\n* [互联网系统可靠性基础：正确的异常处理](https://blog.eood.cn/exception)\n\n* [微服务设计：熔断器模式](http://www.sczyh30.com/posts/Microservice/circuit-breaker-pattern/)\n\n* [采用断路器设计模式来保护软件](http://ju.outofmemory.cn/entry/195996)","slug":"Summary-of-distributed-theory","published":1,"updated":"2016-06-01T09:49:55.968Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ciowq3yut000m4cnnh3k2nqa0","content":"<p><img src=\"/img/thinking.jpg\" alt=\"\"></p>\n<h1 id=\"软件系统的本质\"><a href=\"#软件系统的本质\" class=\"headerlink\" title=\"软件系统的本质\"></a>软件系统的本质</h1><p>软件是现实的抽象，讨论抽象的本质是困难的，让我们一起在现实中思考。小到一支笔，大到一部汽车，这些产品的出现，使我们在现实生活中得到了方便。这里说的方便，是指因为使用了这些产品，降低了成本，提高了效率。在没有笔的时代，想要记录信息需要结绳、岩画或篆刻，这是高成本的，效率也很低。同样的，没有汽车的时代，想要到达另一个城市，会因为恶劣天气而被迫中途搁置，相应的通行时间也会比现在长得多。进一步的思考，笔与汽车的共同点又在哪里呢？</p>\n<p>笔与汽车，这些产品是为了满足人们的各类生活需求而发明的。即，人们因为现实需要，而发明或改进了产品，产品是为了帮助人们更好的生活而存在。同样的，软件系统也是如此，人们出于远距离沟通交流需要，发明电话拨号系统；因为更随时随地的信息多样化交流，发明了各种互联网IM产品。</p>\n<p>软件系统是依托于人们现实需求而存在，用以辅助人们更好的生活，它是现实世界在虚拟世界的抽象。同样的软件系统也存在着兴衰淘汰，一款软件刚问世时，受欢迎程度总是处于低谷，存在现实世界对其接受适应的时间窗。突破时间窗，进而逐渐闻名天下，此时依托此软件又会催生出许多子软件链（如chromium的众多壳浏览器、SVN的众多客户端）。随着技术革新，软件产业也会更新换代，跟不上时代的软件系统会逐渐退出市场（如vista操作系统的短命）。但市场总是存在需要的，类似的软件在倒下后总会有后继者，如浏览器，这几乎在国内，每家互联网公司都想做或者已经在做。</p>\n<h1 id=\"不良设计的局限性\"><a href=\"#不良设计的局限性\" class=\"headerlink\" title=\"不良设计的局限性\"></a>不良设计的局限性</h1><p>在软件系统的发展初期，适用面狭窄，功能单一、用户少、价值不够高，造成对软件系统研发的不重视，成本投入低。相应的，软件所带来的经济收益也是有限的。此时的软件系统往往谈不上架构，往往是一个软件系统承载了所有功能，单个功能模块没有边界，逻辑分散，而各个功能模块之间的耦合关系是散乱的。</p>\n<p><img src=\"/img/chaos.jpg\" alt=\"\"></p>\n<p>在软件系统有机会成长起来后，带来了一定的经济收益。我们会思考软件系统的功能增多，更适应于用户（市场需要），或者考虑增强原有用户黏性，此时会对软件系统提出更多要求。而初期功能模块散乱的堆叠，对迫切需要的可扩展性带来了的麻烦，紧耦合的架构造成牵一发而动全身的问题，新功能的增加，往往意味着巨大地改造成本。勉强加上一些功能后，整个软件系统简直是乱作一团，就像是一堆红豆绿豆，这样的软件系统，我们称之为集中式软件系统。</p>\n<p>集中式的软件系统还对重构带来挑战，随着功能需求越来越频繁的提出，往往意味着需要更短的版本迭代周期。现有系统无法灵活扩展，意味着需要对整个软件系统进行重构，而等到软件散乱性膨胀到一定程度，重构几乎变成不可完成的任务，就算是系统初始负责人，也无法评估重构带来的风险与收益究竟谁更多？</p>\n<h2 id=\"停不下来的运动员\"><a href=\"#停不下来的运动员\" class=\"headerlink\" title=\"停不下来的运动员\"></a>停不下来的运动员</h2><p>集中式的软件系统在濒危阶段，开发团队往往面临两难，团队任何人都知道急需重构，但因为没有决策权，最高决策领导也顾虑着市场利益，而不可能给出重构所需的资源(时间、人力、软硬件)。在愈发杂乱的系统上进行维护和新功能叠加，这让团队内的每个人都需要指数级的投入成本，往往还达不到市场需要的质量。</p>\n<p>就像田径400米接力比赛中，只能跑第一棒的运动员，本应在交棒后停下来休息，自我调整。而由于接手下一棒的运动员迟迟不能到位，运动员只能咬牙坚持跑第二棒，但迈出的每一步都越来越累，没法再像刚开始保持加速度。更令人担忧的是，此时裁判还吹响了冲刺哨，要求运动员进行冲锋。这样，运动员只有倒下了。相应的，软件系统到此时，开发团队成员会加速流失，新招进来的人也很难理解整套系统的协作，经常顾此失彼，从而导致最终的系统失败。</p>\n<p>这也就是为什么CTO必需对技术团队保持深入理解，同时还应有对产品、开发的最高决策权，以支持技术团队在适时进行系统级别的重构，让失去体力的软件系统下线休息，换上更适合的新软件系统上线，从而更好地满足公司的战略需求，这是非常有必要的。</p>\n<h1 id=\"向敏捷开发过渡\"><a href=\"#向敏捷开发过渡\" class=\"headerlink\" title=\"向敏捷开发过渡\"></a>向敏捷开发过渡</h1><p><img src=\"/img/building-blocks.jpg\" alt=\"\"></p>\n<p>在软件系统有机会从集中式软件模式，过渡到积木型的软件模式后。系统原有是100%的功能堆叠到一个系统，现在变成了多个积木，也就是软件子系统，每个积木只负责其中的部分功能，积木间的协作，从而拼装出完整的软件系统。</p>\n<h2 id=\"快速交付\"><a href=\"#快速交付\" class=\"headerlink\" title=\"快速交付\"></a>快速交付</h2><p>集中式的软件往往灵活性低下，这体现在很多方面。</p>\n<p>1.设计的灵活性，想要以好的设计替换掉不再适应设计方案，会遭遇无法评估改造成本。</p>\n<p>2.构建的灵活性，软件功能过于集中，导致一个小的编译问题，都会影响整个软件的构建，就像走钢丝一样，必需每一步都完美无缺才能安全走到终点。</p>\n<p>3.测试的灵活性，测试任务因为功能互相紧耦合而变得繁重，无法评估已经做好的功能是否会受到影响。</p>\n<p>4.部署的灵活性，运维无法根据系统的流量特性来优化软硬件配置，如JVM调优，Load Balance等。</p>\n<p>5.修复的灵活性，这一点往往在集中式软件中是一个优势，在线上出现问题，只需要简单的分析少量的运行日志即可定位问题，这在积木性系统中是一个软肋。</p>\n<p>敏捷开发的主要优势就在于，合理的利用分治思想，将复杂的功能的系统模块化处理，拆分成由只有简单功能的子系统而拼凑出来的完整系统，每一个子系统可以交付到小团队来维护，甚至与有单独的运维人员来进行保障。</p>\n<p><img src=\"/img/MircoService.png\" alt=\"\"></p>\n<h2 id=\"可维护性\"><a href=\"#可维护性\" class=\"headerlink\" title=\"可维护性\"></a>可维护性</h2><p>这是一个巨大的转变，首当其冲的就是可维护性，只需要定义一套灵活的通信协议，子系统之间通过这套协议进行通讯，我们在对子系统内部的功能进行维护时，不必担忧其他子系统受到干扰。这也存在一个前提，能够封装在一个子系统的功能模块集合，必须是内聚型的，它们几乎很少对外层子系统产生耦合，或者通过统一的出口进行耦合关联。</p>\n<h2 id=\"可扩展性\"><a href=\"#可扩展性\" class=\"headerlink\" title=\"可扩展性\"></a>可扩展性</h2><p>其次是软件的可扩展性，新功能的开发，只需要新加一个子系统，扩展通讯协议，就可以满足要求，这对团队内的任何一个人都是令人振奋的。</p>\n<h2 id=\"隔离性\"><a href=\"#隔离性\" class=\"headerlink\" title=\"隔离性\"></a>隔离性</h2><p>积木型的软件构建，还给了我们保持专注的可能。现在我们可以为软件进行动静分离设计，以适应不同的最佳部署方式。可以按照系统流量特性，应用CQRS架构，提供更好的局部性能。进一步的还可以为强共用性的功能进行独立剥离出来，譬如单独的文件系统负责所有的文件服务，以在避免各个积木内部的重复造轮子，独立的服务还为以后的：可维护性、伸缩性带来了诸多方便。</p>\n<h2 id=\"质量可控\"><a href=\"#质量可控\" class=\"headerlink\" title=\"质量可控\"></a>质量可控</h2><p>同时，软件的质量可以得到保证，测试部门可以明确的针对某个软件子系统进行测试，而不需要每次系统上线都进行整体测试，工作量的降低，在相等的时间内，有了更多的时间进行问题修复，这往往意味着质量的提高。</p>\n<p>积木型的软件，是对积木之间通讯协议的高要求，实际上，我们需要引入一整套消息通讯中间件来解决这个问题，在SOA和EDA架构中，最为关键的就是MQ协议的设计了。</p>\n<p>松耦合的模式还带来局部失败和最终一致性的问题，可能会给用户造成短时间迷惑，但不影响最终的数据状态统一，这在传统软件领域往往是不可接受的，但进入到互联网后，在系统层面往往需要进行权衡，是市场机遇重要？还是少部分的用户利益重要？这个问题需要每一个互联网人的思考，产品是不是要满足每一个人的要求呢？</p>\n<h1 id=\"分布式系统的利与弊\"><a href=\"#分布式系统的利与弊\" class=\"headerlink\" title=\"分布式系统的利与弊\"></a>分布式系统的利与弊</h1><h2 id=\"软件的构成\"><a href=\"#软件的构成\" class=\"headerlink\" title=\"软件的构成\"></a>软件的构成</h2><p>概括的讲，软件普遍是由三部分组成：接入、逻辑、存储。其中接入是可能没有的，比如定时任务型软件，由操作系统时间来触发，不需要外界的主动调度。而逻辑和存储，很难有软件是不需要的。而比如典型的在线社交服务，常规的构成可以分为：聊天服务、长连接服务、推送服务、好友信息服务、文件服务、推荐服务、广告服务。这些按业务功能相关性而划分的服务，没有哪一个可以脱离接入、逻辑和存储的。这些服务从本质上来说大部分都是OLTP(<a href=\"http://blog.csdn.net/tianlesoftware/article/details/5794844\" target=\"_blank\" rel=\"external\">Online Transaction Processing</a>)，就是将现实生活中的沟通交流需求转移到了互联网进行。</p>\n<h2 id=\"SOA-VS-EDA\"><a href=\"#SOA-VS-EDA\" class=\"headerlink\" title=\"SOA VS EDA\"></a>SOA VS EDA</h2><h3 id=\"什么是SOA？\"><a href=\"#什么是SOA？\" class=\"headerlink\" title=\"什么是SOA？\"></a>什么是SOA？</h3><h4 id=\"SOA-VS-Mirco-Service\"><a href=\"#SOA-VS-Mirco-Service\" class=\"headerlink\" title=\"SOA VS Mirco Service\"></a>SOA VS Mirco Service</h4><h3 id=\"什么是EDA？\"><a href=\"#什么是EDA？\" class=\"headerlink\" title=\"什么是EDA？\"></a>什么是EDA？</h3><h3 id=\"分场景使用\"><a href=\"#分场景使用\" class=\"headerlink\" title=\"分场景使用\"></a>分场景使用</h3><h2 id=\"Design-for-failure\"><a href=\"#Design-for-failure\" class=\"headerlink\" title=\"Design for failure\"></a>Design for failure</h2><h3 id=\"Fast-fail-VS-Retry\"><a href=\"#Fast-fail-VS-Retry\" class=\"headerlink\" title=\"Fast fail VS Retry\"></a>Fast fail VS Retry</h3><h2 id=\"无状态\"><a href=\"#无状态\" class=\"headerlink\" title=\"无状态\"></a>无状态</h2><h2 id=\"应用中心和任务中心\"><a href=\"#应用中心和任务中心\" class=\"headerlink\" title=\"应用中心和任务中心\"></a>应用中心和任务中心</h2><p>单点服务向多点服务的转变</p>\n<p>原因：<br>性能要求，多节点同时参与服务(按流量权重分发，负载均衡；按读写流量分发，读写分离)。<br>允许少部分节点失败，更可靠的运行。</p>\n<p>数据存储跨机分片，同时每片在多机存在复制集。计算资源无状态，本身就可以动态管理。便捷的扩容缩容(伸缩性)。</p>\n<p>因业务分拆，降低耦合粒度，降低系统扩展成本(可扩展性)，更高的可维护性。</p>\n<p>带来的问题。<br>系统内部改造，支持多节点转变。</p>\n<p>分布式事务，事务补偿。</p>\n<p>分布式存储</p>\n<p>分布式访问</p>\n<p>容忍最终一致性。</p>\n<h1 id=\"Reference\"><a href=\"#Reference\" class=\"headerlink\" title=\"Reference\"></a>Reference</h1><ul>\n<li><p><a href=\"https://blog.eood.cn/exception\" target=\"_blank\" rel=\"external\">互联网系统可靠性基础：正确的异常处理</a></p>\n</li>\n<li><p><a href=\"http://www.sczyh30.com/posts/Microservice/circuit-breaker-pattern/\" target=\"_blank\" rel=\"external\">微服务设计：熔断器模式</a></p>\n</li>\n<li><p><a href=\"http://ju.outofmemory.cn/entry/195996\" target=\"_blank\" rel=\"external\">采用断路器设计模式来保护软件</a></p>\n</li>\n</ul>\n","excerpt":"","more":"<p><img src=\"/img/thinking.jpg\" alt=\"\"></p>\n<h1 id=\"软件系统的本质\"><a href=\"#软件系统的本质\" class=\"headerlink\" title=\"软件系统的本质\"></a>软件系统的本质</h1><p>软件是现实的抽象，讨论抽象的本质是困难的，让我们一起在现实中思考。小到一支笔，大到一部汽车，这些产品的出现，使我们在现实生活中得到了方便。这里说的方便，是指因为使用了这些产品，降低了成本，提高了效率。在没有笔的时代，想要记录信息需要结绳、岩画或篆刻，这是高成本的，效率也很低。同样的，没有汽车的时代，想要到达另一个城市，会因为恶劣天气而被迫中途搁置，相应的通行时间也会比现在长得多。进一步的思考，笔与汽车的共同点又在哪里呢？</p>\n<p>笔与汽车，这些产品是为了满足人们的各类生活需求而发明的。即，人们因为现实需要，而发明或改进了产品，产品是为了帮助人们更好的生活而存在。同样的，软件系统也是如此，人们出于远距离沟通交流需要，发明电话拨号系统；因为更随时随地的信息多样化交流，发明了各种互联网IM产品。</p>\n<p>软件系统是依托于人们现实需求而存在，用以辅助人们更好的生活，它是现实世界在虚拟世界的抽象。同样的软件系统也存在着兴衰淘汰，一款软件刚问世时，受欢迎程度总是处于低谷，存在现实世界对其接受适应的时间窗。突破时间窗，进而逐渐闻名天下，此时依托此软件又会催生出许多子软件链（如chromium的众多壳浏览器、SVN的众多客户端）。随着技术革新，软件产业也会更新换代，跟不上时代的软件系统会逐渐退出市场（如vista操作系统的短命）。但市场总是存在需要的，类似的软件在倒下后总会有后继者，如浏览器，这几乎在国内，每家互联网公司都想做或者已经在做。</p>\n<h1 id=\"不良设计的局限性\"><a href=\"#不良设计的局限性\" class=\"headerlink\" title=\"不良设计的局限性\"></a>不良设计的局限性</h1><p>在软件系统的发展初期，适用面狭窄，功能单一、用户少、价值不够高，造成对软件系统研发的不重视，成本投入低。相应的，软件所带来的经济收益也是有限的。此时的软件系统往往谈不上架构，往往是一个软件系统承载了所有功能，单个功能模块没有边界，逻辑分散，而各个功能模块之间的耦合关系是散乱的。</p>\n<p><img src=\"/img/chaos.jpg\" alt=\"\"></p>\n<p>在软件系统有机会成长起来后，带来了一定的经济收益。我们会思考软件系统的功能增多，更适应于用户（市场需要），或者考虑增强原有用户黏性，此时会对软件系统提出更多要求。而初期功能模块散乱的堆叠，对迫切需要的可扩展性带来了的麻烦，紧耦合的架构造成牵一发而动全身的问题，新功能的增加，往往意味着巨大地改造成本。勉强加上一些功能后，整个软件系统简直是乱作一团，就像是一堆红豆绿豆，这样的软件系统，我们称之为集中式软件系统。</p>\n<p>集中式的软件系统还对重构带来挑战，随着功能需求越来越频繁的提出，往往意味着需要更短的版本迭代周期。现有系统无法灵活扩展，意味着需要对整个软件系统进行重构，而等到软件散乱性膨胀到一定程度，重构几乎变成不可完成的任务，就算是系统初始负责人，也无法评估重构带来的风险与收益究竟谁更多？</p>\n<h2 id=\"停不下来的运动员\"><a href=\"#停不下来的运动员\" class=\"headerlink\" title=\"停不下来的运动员\"></a>停不下来的运动员</h2><p>集中式的软件系统在濒危阶段，开发团队往往面临两难，团队任何人都知道急需重构，但因为没有决策权，最高决策领导也顾虑着市场利益，而不可能给出重构所需的资源(时间、人力、软硬件)。在愈发杂乱的系统上进行维护和新功能叠加，这让团队内的每个人都需要指数级的投入成本，往往还达不到市场需要的质量。</p>\n<p>就像田径400米接力比赛中，只能跑第一棒的运动员，本应在交棒后停下来休息，自我调整。而由于接手下一棒的运动员迟迟不能到位，运动员只能咬牙坚持跑第二棒，但迈出的每一步都越来越累，没法再像刚开始保持加速度。更令人担忧的是，此时裁判还吹响了冲刺哨，要求运动员进行冲锋。这样，运动员只有倒下了。相应的，软件系统到此时，开发团队成员会加速流失，新招进来的人也很难理解整套系统的协作，经常顾此失彼，从而导致最终的系统失败。</p>\n<p>这也就是为什么CTO必需对技术团队保持深入理解，同时还应有对产品、开发的最高决策权，以支持技术团队在适时进行系统级别的重构，让失去体力的软件系统下线休息，换上更适合的新软件系统上线，从而更好地满足公司的战略需求，这是非常有必要的。</p>\n<h1 id=\"向敏捷开发过渡\"><a href=\"#向敏捷开发过渡\" class=\"headerlink\" title=\"向敏捷开发过渡\"></a>向敏捷开发过渡</h1><p><img src=\"/img/building-blocks.jpg\" alt=\"\"></p>\n<p>在软件系统有机会从集中式软件模式，过渡到积木型的软件模式后。系统原有是100%的功能堆叠到一个系统，现在变成了多个积木，也就是软件子系统，每个积木只负责其中的部分功能，积木间的协作，从而拼装出完整的软件系统。</p>\n<h2 id=\"快速交付\"><a href=\"#快速交付\" class=\"headerlink\" title=\"快速交付\"></a>快速交付</h2><p>集中式的软件往往灵活性低下，这体现在很多方面。</p>\n<p>1.设计的灵活性，想要以好的设计替换掉不再适应设计方案，会遭遇无法评估改造成本。</p>\n<p>2.构建的灵活性，软件功能过于集中，导致一个小的编译问题，都会影响整个软件的构建，就像走钢丝一样，必需每一步都完美无缺才能安全走到终点。</p>\n<p>3.测试的灵活性，测试任务因为功能互相紧耦合而变得繁重，无法评估已经做好的功能是否会受到影响。</p>\n<p>4.部署的灵活性，运维无法根据系统的流量特性来优化软硬件配置，如JVM调优，Load Balance等。</p>\n<p>5.修复的灵活性，这一点往往在集中式软件中是一个优势，在线上出现问题，只需要简单的分析少量的运行日志即可定位问题，这在积木性系统中是一个软肋。</p>\n<p>敏捷开发的主要优势就在于，合理的利用分治思想，将复杂的功能的系统模块化处理，拆分成由只有简单功能的子系统而拼凑出来的完整系统，每一个子系统可以交付到小团队来维护，甚至与有单独的运维人员来进行保障。</p>\n<p><img src=\"/img/MircoService.png\" alt=\"\"></p>\n<h2 id=\"可维护性\"><a href=\"#可维护性\" class=\"headerlink\" title=\"可维护性\"></a>可维护性</h2><p>这是一个巨大的转变，首当其冲的就是可维护性，只需要定义一套灵活的通信协议，子系统之间通过这套协议进行通讯，我们在对子系统内部的功能进行维护时，不必担忧其他子系统受到干扰。这也存在一个前提，能够封装在一个子系统的功能模块集合，必须是内聚型的，它们几乎很少对外层子系统产生耦合，或者通过统一的出口进行耦合关联。</p>\n<h2 id=\"可扩展性\"><a href=\"#可扩展性\" class=\"headerlink\" title=\"可扩展性\"></a>可扩展性</h2><p>其次是软件的可扩展性，新功能的开发，只需要新加一个子系统，扩展通讯协议，就可以满足要求，这对团队内的任何一个人都是令人振奋的。</p>\n<h2 id=\"隔离性\"><a href=\"#隔离性\" class=\"headerlink\" title=\"隔离性\"></a>隔离性</h2><p>积木型的软件构建，还给了我们保持专注的可能。现在我们可以为软件进行动静分离设计，以适应不同的最佳部署方式。可以按照系统流量特性，应用CQRS架构，提供更好的局部性能。进一步的还可以为强共用性的功能进行独立剥离出来，譬如单独的文件系统负责所有的文件服务，以在避免各个积木内部的重复造轮子，独立的服务还为以后的：可维护性、伸缩性带来了诸多方便。</p>\n<h2 id=\"质量可控\"><a href=\"#质量可控\" class=\"headerlink\" title=\"质量可控\"></a>质量可控</h2><p>同时，软件的质量可以得到保证，测试部门可以明确的针对某个软件子系统进行测试，而不需要每次系统上线都进行整体测试，工作量的降低，在相等的时间内，有了更多的时间进行问题修复，这往往意味着质量的提高。</p>\n<p>积木型的软件，是对积木之间通讯协议的高要求，实际上，我们需要引入一整套消息通讯中间件来解决这个问题，在SOA和EDA架构中，最为关键的就是MQ协议的设计了。</p>\n<p>松耦合的模式还带来局部失败和最终一致性的问题，可能会给用户造成短时间迷惑，但不影响最终的数据状态统一，这在传统软件领域往往是不可接受的，但进入到互联网后，在系统层面往往需要进行权衡，是市场机遇重要？还是少部分的用户利益重要？这个问题需要每一个互联网人的思考，产品是不是要满足每一个人的要求呢？</p>\n<h1 id=\"分布式系统的利与弊\"><a href=\"#分布式系统的利与弊\" class=\"headerlink\" title=\"分布式系统的利与弊\"></a>分布式系统的利与弊</h1><h2 id=\"软件的构成\"><a href=\"#软件的构成\" class=\"headerlink\" title=\"软件的构成\"></a>软件的构成</h2><p>概括的讲，软件普遍是由三部分组成：接入、逻辑、存储。其中接入是可能没有的，比如定时任务型软件，由操作系统时间来触发，不需要外界的主动调度。而逻辑和存储，很难有软件是不需要的。而比如典型的在线社交服务，常规的构成可以分为：聊天服务、长连接服务、推送服务、好友信息服务、文件服务、推荐服务、广告服务。这些按业务功能相关性而划分的服务，没有哪一个可以脱离接入、逻辑和存储的。这些服务从本质上来说大部分都是OLTP(<a href=\"http://blog.csdn.net/tianlesoftware/article/details/5794844\">Online Transaction Processing</a>)，就是将现实生活中的沟通交流需求转移到了互联网进行。</p>\n<h2 id=\"SOA-VS-EDA\"><a href=\"#SOA-VS-EDA\" class=\"headerlink\" title=\"SOA VS EDA\"></a>SOA VS EDA</h2><h3 id=\"什么是SOA？\"><a href=\"#什么是SOA？\" class=\"headerlink\" title=\"什么是SOA？\"></a>什么是SOA？</h3><h4 id=\"SOA-VS-Mirco-Service\"><a href=\"#SOA-VS-Mirco-Service\" class=\"headerlink\" title=\"SOA VS Mirco Service\"></a>SOA VS Mirco Service</h4><h3 id=\"什么是EDA？\"><a href=\"#什么是EDA？\" class=\"headerlink\" title=\"什么是EDA？\"></a>什么是EDA？</h3><h3 id=\"分场景使用\"><a href=\"#分场景使用\" class=\"headerlink\" title=\"分场景使用\"></a>分场景使用</h3><h2 id=\"Design-for-failure\"><a href=\"#Design-for-failure\" class=\"headerlink\" title=\"Design for failure\"></a>Design for failure</h2><h3 id=\"Fast-fail-VS-Retry\"><a href=\"#Fast-fail-VS-Retry\" class=\"headerlink\" title=\"Fast fail VS Retry\"></a>Fast fail VS Retry</h3><h2 id=\"无状态\"><a href=\"#无状态\" class=\"headerlink\" title=\"无状态\"></a>无状态</h2><h2 id=\"应用中心和任务中心\"><a href=\"#应用中心和任务中心\" class=\"headerlink\" title=\"应用中心和任务中心\"></a>应用中心和任务中心</h2><p>单点服务向多点服务的转变</p>\n<p>原因：<br>性能要求，多节点同时参与服务(按流量权重分发，负载均衡；按读写流量分发，读写分离)。<br>允许少部分节点失败，更可靠的运行。</p>\n<p>数据存储跨机分片，同时每片在多机存在复制集。计算资源无状态，本身就可以动态管理。便捷的扩容缩容(伸缩性)。</p>\n<p>因业务分拆，降低耦合粒度，降低系统扩展成本(可扩展性)，更高的可维护性。</p>\n<p>带来的问题。<br>系统内部改造，支持多节点转变。</p>\n<p>分布式事务，事务补偿。</p>\n<p>分布式存储</p>\n<p>分布式访问</p>\n<p>容忍最终一致性。</p>\n<h1 id=\"Reference\"><a href=\"#Reference\" class=\"headerlink\" title=\"Reference\"></a>Reference</h1><ul>\n<li><p><a href=\"https://blog.eood.cn/exception\">互联网系统可靠性基础：正确的异常处理</a></p>\n</li>\n<li><p><a href=\"http://www.sczyh30.com/posts/Microservice/circuit-breaker-pattern/\">微服务设计：熔断器模式</a></p>\n</li>\n<li><p><a href=\"http://ju.outofmemory.cn/entry/195996\">采用断路器设计模式来保护软件</a></p>\n</li>\n</ul>\n"},{"title":"技术架构规范总结","date":"2016-05-11T10:38:31.000Z","description":"总结技术架构方面的普适性经验，还有一些团队管理的准则。","_content":"\n# 原则\n\n## 命名规范\n### 重要性\n### 如何做？\n### 约定优于配置\n\n## 合理的设计\n### 适时分层\n### 避免过度设计\n### 模块化设计\n模块化设计在重构时，可以将影响降到最低。达到低风险、低成本。\n模块化设计对系统快速构建是一个阻碍，它要求将可预见的同类型代码复用，内聚到一个模块中。\n\n## 前轻后重\n系统之间的调用链，前置系统轻逻辑。\n### 上轻下重，核心逻辑内敛\n模块之间的调用链，上层模块轻逻辑\n\n\n## 基础优先\n在构建软件时，保持基础组件优先稳定下来，定义好对外接口，并保留可扩展性。\n例如安全性设计，在后期加比在前期加的成本高很多。\n\n## 最小冗余\n### 代码保持最少行数\n1.少一行代码，就少了一个潜在的bug\n2.行数少了，往往意味着重用性高了\n\n\n## 保持简单\n### 简单意味着快速\n### 简单意味着灵活\n### 简单意味着易扩展\n### 简单意味着易重构\n\n## Fast fail\n\n## 代码即文档\n### 合理的注释\n\n## 关键业务设计宣讲\n### 保持一致的看法\n\n## 小步快走\n### 意味着版本迭代快速\n### 意味着版本迭代稳定\n### 意味着部署回滚成本低\n\n# 重构与优化\n## 紧急优先\n优先对紧急需要改进的部分进行重构\n## 计划性的重构\n在敏捷开发时，往往时间不够，有些模块只能以非优雅的方式构建。但是需要在这些模块加上TODO以免重构时遗忘。\n## 时机\n团队一致认为模块维护成本高昂时，果断重构。\n## 基于成本的优化\n## 数据支撑\n给出重构前后的成本与收益报告\n## 持续性\n在时间不够或时机不成熟时，分阶段的进行\n\n# 技术选型\n## 开源优先\n## 稳定优先\n## 掌控度高优先\n## 保留备选项\n## 只有合适的技术，没有最好的技术。\n## 避免一招鲜吃遍天\n手里有锤子，看到什么都觉得像钉子\n## 技术升级\n系统容量与性能指标的要求，在业务发展的各个阶段是不固定的，技术需要保留一定前瞻性，不做被动跟随。\n\n# 团队管理\n## keep watch\n工作与心理的交流分享\n## 保持信任\n## 保持怀疑\n## 持续考评\n## 分享中提高\n\n\n有一个著名的理论，叫木桶理论。意思是木桶能装多少水，是由木桶最短的那个板来决定的。团队也是如此。团队的力量有多大，很多时候也是由能力最差的那个成员来决定的。为了提高团队整体的实力，我们必须提高每个人的能力。我们的改善必须得是可度量的，所以我们也要数字化能力的标准。\n\n\n## 提高工作效率\n\n其实很多团队都在进行着这个工作。最常见的就是会做一些小工具，来节省我们的时间。比如代码自动生成工具，自动打包工具，自动的比较工具等等。我们应该制作尽可能多的自动化工具，来解放我们的时间。\n\n为了让大家投入更多的热情来制作各种工具，团队可以制定一定的奖励规则，对制作工具的人给予奖励。\n\n## 互相备份\n## 互相支撑\n## 向上管理\n## 向下管理\n### 了解队员的擅长与不足\n### 合理的任务分配\n### 适度挑战性的任务\n### 给出完成任务需要的资源\n### 激励中成长\n眼前利益与发展前景\n### 给出职业发展的机会\n### 公开与公平中考评\n### 保持团队稳定\n团队成员的诉求：团队，产品，薪资，发展。\n\n团队提供集体成长的氛围环境。\n\n令人兴奋的产品，提供持续打磨的动力。\n\n合适的薪资，使个人不过多为生活所扰。\n\n良好的发展前景，对个人的职业生涯带来腾飞。\n\n## 适时剔除不合格\n## 技术梯队\n不同层次的人员配比，完成不同类型的任务。注意人员的上升下降渠道。\n\n# 接口\n## 版本控制\n## 访问控制\n访问权限的验证\n## 流量控制\n拒绝恶意访问\n## 审查与监控\n## 灰度发布\n## 无状态\n## 原子化\n## CQRS\n命令查询职责分离模式，读不强依赖写。\n\n\n# APP(Client)\n## 远程控制权\n## 展示为主\n## 少的逻辑\n## 适度安全\n\n# 部署\n## 监控\n## 降低升级时间窗\n## 没有人需要等待\n正式发布后，对于任何用户都是公平使用的。不需要牺牲部分用户利益。\n常见于缓存autowarm时需要阻塞第一批到达的用户。\n## 提前消除隐患","source":"_posts/Technical-architecture-specification-summary.md","raw":"---\ntitle: 技术架构规范总结\ndate: 2016-5-11 18:38:31\ntags:\n    - Architecture\n    - Specification\ncategories:\n    - Summary\ndescription: 总结技术架构方面的普适性经验，还有一些团队管理的准则。\n---\n\n# 原则\n\n## 命名规范\n### 重要性\n### 如何做？\n### 约定优于配置\n\n## 合理的设计\n### 适时分层\n### 避免过度设计\n### 模块化设计\n模块化设计在重构时，可以将影响降到最低。达到低风险、低成本。\n模块化设计对系统快速构建是一个阻碍，它要求将可预见的同类型代码复用，内聚到一个模块中。\n\n## 前轻后重\n系统之间的调用链，前置系统轻逻辑。\n### 上轻下重，核心逻辑内敛\n模块之间的调用链，上层模块轻逻辑\n\n\n## 基础优先\n在构建软件时，保持基础组件优先稳定下来，定义好对外接口，并保留可扩展性。\n例如安全性设计，在后期加比在前期加的成本高很多。\n\n## 最小冗余\n### 代码保持最少行数\n1.少一行代码，就少了一个潜在的bug\n2.行数少了，往往意味着重用性高了\n\n\n## 保持简单\n### 简单意味着快速\n### 简单意味着灵活\n### 简单意味着易扩展\n### 简单意味着易重构\n\n## Fast fail\n\n## 代码即文档\n### 合理的注释\n\n## 关键业务设计宣讲\n### 保持一致的看法\n\n## 小步快走\n### 意味着版本迭代快速\n### 意味着版本迭代稳定\n### 意味着部署回滚成本低\n\n# 重构与优化\n## 紧急优先\n优先对紧急需要改进的部分进行重构\n## 计划性的重构\n在敏捷开发时，往往时间不够，有些模块只能以非优雅的方式构建。但是需要在这些模块加上TODO以免重构时遗忘。\n## 时机\n团队一致认为模块维护成本高昂时，果断重构。\n## 基于成本的优化\n## 数据支撑\n给出重构前后的成本与收益报告\n## 持续性\n在时间不够或时机不成熟时，分阶段的进行\n\n# 技术选型\n## 开源优先\n## 稳定优先\n## 掌控度高优先\n## 保留备选项\n## 只有合适的技术，没有最好的技术。\n## 避免一招鲜吃遍天\n手里有锤子，看到什么都觉得像钉子\n## 技术升级\n系统容量与性能指标的要求，在业务发展的各个阶段是不固定的，技术需要保留一定前瞻性，不做被动跟随。\n\n# 团队管理\n## keep watch\n工作与心理的交流分享\n## 保持信任\n## 保持怀疑\n## 持续考评\n## 分享中提高\n\n\n有一个著名的理论，叫木桶理论。意思是木桶能装多少水，是由木桶最短的那个板来决定的。团队也是如此。团队的力量有多大，很多时候也是由能力最差的那个成员来决定的。为了提高团队整体的实力，我们必须提高每个人的能力。我们的改善必须得是可度量的，所以我们也要数字化能力的标准。\n\n\n## 提高工作效率\n\n其实很多团队都在进行着这个工作。最常见的就是会做一些小工具，来节省我们的时间。比如代码自动生成工具，自动打包工具，自动的比较工具等等。我们应该制作尽可能多的自动化工具，来解放我们的时间。\n\n为了让大家投入更多的热情来制作各种工具，团队可以制定一定的奖励规则，对制作工具的人给予奖励。\n\n## 互相备份\n## 互相支撑\n## 向上管理\n## 向下管理\n### 了解队员的擅长与不足\n### 合理的任务分配\n### 适度挑战性的任务\n### 给出完成任务需要的资源\n### 激励中成长\n眼前利益与发展前景\n### 给出职业发展的机会\n### 公开与公平中考评\n### 保持团队稳定\n团队成员的诉求：团队，产品，薪资，发展。\n\n团队提供集体成长的氛围环境。\n\n令人兴奋的产品，提供持续打磨的动力。\n\n合适的薪资，使个人不过多为生活所扰。\n\n良好的发展前景，对个人的职业生涯带来腾飞。\n\n## 适时剔除不合格\n## 技术梯队\n不同层次的人员配比，完成不同类型的任务。注意人员的上升下降渠道。\n\n# 接口\n## 版本控制\n## 访问控制\n访问权限的验证\n## 流量控制\n拒绝恶意访问\n## 审查与监控\n## 灰度发布\n## 无状态\n## 原子化\n## CQRS\n命令查询职责分离模式，读不强依赖写。\n\n\n# APP(Client)\n## 远程控制权\n## 展示为主\n## 少的逻辑\n## 适度安全\n\n# 部署\n## 监控\n## 降低升级时间窗\n## 没有人需要等待\n正式发布后，对于任何用户都是公平使用的。不需要牺牲部分用户利益。\n常见于缓存autowarm时需要阻塞第一批到达的用户。\n## 提前消除隐患","slug":"Technical-architecture-specification-summary","published":1,"updated":"2016-05-27T06:07:44.928Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ciowq3yuv000n4cnnv5gbqdl2","content":"<h1 id=\"原则\"><a href=\"#原则\" class=\"headerlink\" title=\"原则\"></a>原则</h1><h2 id=\"命名规范\"><a href=\"#命名规范\" class=\"headerlink\" title=\"命名规范\"></a>命名规范</h2><h3 id=\"重要性\"><a href=\"#重要性\" class=\"headerlink\" title=\"重要性\"></a>重要性</h3><h3 id=\"如何做？\"><a href=\"#如何做？\" class=\"headerlink\" title=\"如何做？\"></a>如何做？</h3><h3 id=\"约定优于配置\"><a href=\"#约定优于配置\" class=\"headerlink\" title=\"约定优于配置\"></a>约定优于配置</h3><h2 id=\"合理的设计\"><a href=\"#合理的设计\" class=\"headerlink\" title=\"合理的设计\"></a>合理的设计</h2><h3 id=\"适时分层\"><a href=\"#适时分层\" class=\"headerlink\" title=\"适时分层\"></a>适时分层</h3><h3 id=\"避免过度设计\"><a href=\"#避免过度设计\" class=\"headerlink\" title=\"避免过度设计\"></a>避免过度设计</h3><h3 id=\"模块化设计\"><a href=\"#模块化设计\" class=\"headerlink\" title=\"模块化设计\"></a>模块化设计</h3><p>模块化设计在重构时，可以将影响降到最低。达到低风险、低成本。<br>模块化设计对系统快速构建是一个阻碍，它要求将可预见的同类型代码复用，内聚到一个模块中。</p>\n<h2 id=\"前轻后重\"><a href=\"#前轻后重\" class=\"headerlink\" title=\"前轻后重\"></a>前轻后重</h2><p>系统之间的调用链，前置系统轻逻辑。</p>\n<h3 id=\"上轻下重，核心逻辑内敛\"><a href=\"#上轻下重，核心逻辑内敛\" class=\"headerlink\" title=\"上轻下重，核心逻辑内敛\"></a>上轻下重，核心逻辑内敛</h3><p>模块之间的调用链，上层模块轻逻辑</p>\n<h2 id=\"基础优先\"><a href=\"#基础优先\" class=\"headerlink\" title=\"基础优先\"></a>基础优先</h2><p>在构建软件时，保持基础组件优先稳定下来，定义好对外接口，并保留可扩展性。<br>例如安全性设计，在后期加比在前期加的成本高很多。</p>\n<h2 id=\"最小冗余\"><a href=\"#最小冗余\" class=\"headerlink\" title=\"最小冗余\"></a>最小冗余</h2><h3 id=\"代码保持最少行数\"><a href=\"#代码保持最少行数\" class=\"headerlink\" title=\"代码保持最少行数\"></a>代码保持最少行数</h3><p>1.少一行代码，就少了一个潜在的bug<br>2.行数少了，往往意味着重用性高了</p>\n<h2 id=\"保持简单\"><a href=\"#保持简单\" class=\"headerlink\" title=\"保持简单\"></a>保持简单</h2><h3 id=\"简单意味着快速\"><a href=\"#简单意味着快速\" class=\"headerlink\" title=\"简单意味着快速\"></a>简单意味着快速</h3><h3 id=\"简单意味着灵活\"><a href=\"#简单意味着灵活\" class=\"headerlink\" title=\"简单意味着灵活\"></a>简单意味着灵活</h3><h3 id=\"简单意味着易扩展\"><a href=\"#简单意味着易扩展\" class=\"headerlink\" title=\"简单意味着易扩展\"></a>简单意味着易扩展</h3><h3 id=\"简单意味着易重构\"><a href=\"#简单意味着易重构\" class=\"headerlink\" title=\"简单意味着易重构\"></a>简单意味着易重构</h3><h2 id=\"Fast-fail\"><a href=\"#Fast-fail\" class=\"headerlink\" title=\"Fast fail\"></a>Fast fail</h2><h2 id=\"代码即文档\"><a href=\"#代码即文档\" class=\"headerlink\" title=\"代码即文档\"></a>代码即文档</h2><h3 id=\"合理的注释\"><a href=\"#合理的注释\" class=\"headerlink\" title=\"合理的注释\"></a>合理的注释</h3><h2 id=\"关键业务设计宣讲\"><a href=\"#关键业务设计宣讲\" class=\"headerlink\" title=\"关键业务设计宣讲\"></a>关键业务设计宣讲</h2><h3 id=\"保持一致的看法\"><a href=\"#保持一致的看法\" class=\"headerlink\" title=\"保持一致的看法\"></a>保持一致的看法</h3><h2 id=\"小步快走\"><a href=\"#小步快走\" class=\"headerlink\" title=\"小步快走\"></a>小步快走</h2><h3 id=\"意味着版本迭代快速\"><a href=\"#意味着版本迭代快速\" class=\"headerlink\" title=\"意味着版本迭代快速\"></a>意味着版本迭代快速</h3><h3 id=\"意味着版本迭代稳定\"><a href=\"#意味着版本迭代稳定\" class=\"headerlink\" title=\"意味着版本迭代稳定\"></a>意味着版本迭代稳定</h3><h3 id=\"意味着部署回滚成本低\"><a href=\"#意味着部署回滚成本低\" class=\"headerlink\" title=\"意味着部署回滚成本低\"></a>意味着部署回滚成本低</h3><h1 id=\"重构与优化\"><a href=\"#重构与优化\" class=\"headerlink\" title=\"重构与优化\"></a>重构与优化</h1><h2 id=\"紧急优先\"><a href=\"#紧急优先\" class=\"headerlink\" title=\"紧急优先\"></a>紧急优先</h2><p>优先对紧急需要改进的部分进行重构</p>\n<h2 id=\"计划性的重构\"><a href=\"#计划性的重构\" class=\"headerlink\" title=\"计划性的重构\"></a>计划性的重构</h2><p>在敏捷开发时，往往时间不够，有些模块只能以非优雅的方式构建。但是需要在这些模块加上TODO以免重构时遗忘。</p>\n<h2 id=\"时机\"><a href=\"#时机\" class=\"headerlink\" title=\"时机\"></a>时机</h2><p>团队一致认为模块维护成本高昂时，果断重构。</p>\n<h2 id=\"基于成本的优化\"><a href=\"#基于成本的优化\" class=\"headerlink\" title=\"基于成本的优化\"></a>基于成本的优化</h2><h2 id=\"数据支撑\"><a href=\"#数据支撑\" class=\"headerlink\" title=\"数据支撑\"></a>数据支撑</h2><p>给出重构前后的成本与收益报告</p>\n<h2 id=\"持续性\"><a href=\"#持续性\" class=\"headerlink\" title=\"持续性\"></a>持续性</h2><p>在时间不够或时机不成熟时，分阶段的进行</p>\n<h1 id=\"技术选型\"><a href=\"#技术选型\" class=\"headerlink\" title=\"技术选型\"></a>技术选型</h1><h2 id=\"开源优先\"><a href=\"#开源优先\" class=\"headerlink\" title=\"开源优先\"></a>开源优先</h2><h2 id=\"稳定优先\"><a href=\"#稳定优先\" class=\"headerlink\" title=\"稳定优先\"></a>稳定优先</h2><h2 id=\"掌控度高优先\"><a href=\"#掌控度高优先\" class=\"headerlink\" title=\"掌控度高优先\"></a>掌控度高优先</h2><h2 id=\"保留备选项\"><a href=\"#保留备选项\" class=\"headerlink\" title=\"保留备选项\"></a>保留备选项</h2><h2 id=\"只有合适的技术，没有最好的技术。\"><a href=\"#只有合适的技术，没有最好的技术。\" class=\"headerlink\" title=\"只有合适的技术，没有最好的技术。\"></a>只有合适的技术，没有最好的技术。</h2><h2 id=\"避免一招鲜吃遍天\"><a href=\"#避免一招鲜吃遍天\" class=\"headerlink\" title=\"避免一招鲜吃遍天\"></a>避免一招鲜吃遍天</h2><p>手里有锤子，看到什么都觉得像钉子</p>\n<h2 id=\"技术升级\"><a href=\"#技术升级\" class=\"headerlink\" title=\"技术升级\"></a>技术升级</h2><p>系统容量与性能指标的要求，在业务发展的各个阶段是不固定的，技术需要保留一定前瞻性，不做被动跟随。</p>\n<h1 id=\"团队管理\"><a href=\"#团队管理\" class=\"headerlink\" title=\"团队管理\"></a>团队管理</h1><h2 id=\"keep-watch\"><a href=\"#keep-watch\" class=\"headerlink\" title=\"keep watch\"></a>keep watch</h2><p>工作与心理的交流分享</p>\n<h2 id=\"保持信任\"><a href=\"#保持信任\" class=\"headerlink\" title=\"保持信任\"></a>保持信任</h2><h2 id=\"保持怀疑\"><a href=\"#保持怀疑\" class=\"headerlink\" title=\"保持怀疑\"></a>保持怀疑</h2><h2 id=\"持续考评\"><a href=\"#持续考评\" class=\"headerlink\" title=\"持续考评\"></a>持续考评</h2><h2 id=\"分享中提高\"><a href=\"#分享中提高\" class=\"headerlink\" title=\"分享中提高\"></a>分享中提高</h2><p>有一个著名的理论，叫木桶理论。意思是木桶能装多少水，是由木桶最短的那个板来决定的。团队也是如此。团队的力量有多大，很多时候也是由能力最差的那个成员来决定的。为了提高团队整体的实力，我们必须提高每个人的能力。我们的改善必须得是可度量的，所以我们也要数字化能力的标准。</p>\n<h2 id=\"提高工作效率\"><a href=\"#提高工作效率\" class=\"headerlink\" title=\"提高工作效率\"></a>提高工作效率</h2><p>其实很多团队都在进行着这个工作。最常见的就是会做一些小工具，来节省我们的时间。比如代码自动生成工具，自动打包工具，自动的比较工具等等。我们应该制作尽可能多的自动化工具，来解放我们的时间。</p>\n<p>为了让大家投入更多的热情来制作各种工具，团队可以制定一定的奖励规则，对制作工具的人给予奖励。</p>\n<h2 id=\"互相备份\"><a href=\"#互相备份\" class=\"headerlink\" title=\"互相备份\"></a>互相备份</h2><h2 id=\"互相支撑\"><a href=\"#互相支撑\" class=\"headerlink\" title=\"互相支撑\"></a>互相支撑</h2><h2 id=\"向上管理\"><a href=\"#向上管理\" class=\"headerlink\" title=\"向上管理\"></a>向上管理</h2><h2 id=\"向下管理\"><a href=\"#向下管理\" class=\"headerlink\" title=\"向下管理\"></a>向下管理</h2><h3 id=\"了解队员的擅长与不足\"><a href=\"#了解队员的擅长与不足\" class=\"headerlink\" title=\"了解队员的擅长与不足\"></a>了解队员的擅长与不足</h3><h3 id=\"合理的任务分配\"><a href=\"#合理的任务分配\" class=\"headerlink\" title=\"合理的任务分配\"></a>合理的任务分配</h3><h3 id=\"适度挑战性的任务\"><a href=\"#适度挑战性的任务\" class=\"headerlink\" title=\"适度挑战性的任务\"></a>适度挑战性的任务</h3><h3 id=\"给出完成任务需要的资源\"><a href=\"#给出完成任务需要的资源\" class=\"headerlink\" title=\"给出完成任务需要的资源\"></a>给出完成任务需要的资源</h3><h3 id=\"激励中成长\"><a href=\"#激励中成长\" class=\"headerlink\" title=\"激励中成长\"></a>激励中成长</h3><p>眼前利益与发展前景</p>\n<h3 id=\"给出职业发展的机会\"><a href=\"#给出职业发展的机会\" class=\"headerlink\" title=\"给出职业发展的机会\"></a>给出职业发展的机会</h3><h3 id=\"公开与公平中考评\"><a href=\"#公开与公平中考评\" class=\"headerlink\" title=\"公开与公平中考评\"></a>公开与公平中考评</h3><h3 id=\"保持团队稳定\"><a href=\"#保持团队稳定\" class=\"headerlink\" title=\"保持团队稳定\"></a>保持团队稳定</h3><p>团队成员的诉求：团队，产品，薪资，发展。</p>\n<p>团队提供集体成长的氛围环境。</p>\n<p>令人兴奋的产品，提供持续打磨的动力。</p>\n<p>合适的薪资，使个人不过多为生活所扰。</p>\n<p>良好的发展前景，对个人的职业生涯带来腾飞。</p>\n<h2 id=\"适时剔除不合格\"><a href=\"#适时剔除不合格\" class=\"headerlink\" title=\"适时剔除不合格\"></a>适时剔除不合格</h2><h2 id=\"技术梯队\"><a href=\"#技术梯队\" class=\"headerlink\" title=\"技术梯队\"></a>技术梯队</h2><p>不同层次的人员配比，完成不同类型的任务。注意人员的上升下降渠道。</p>\n<h1 id=\"接口\"><a href=\"#接口\" class=\"headerlink\" title=\"接口\"></a>接口</h1><h2 id=\"版本控制\"><a href=\"#版本控制\" class=\"headerlink\" title=\"版本控制\"></a>版本控制</h2><h2 id=\"访问控制\"><a href=\"#访问控制\" class=\"headerlink\" title=\"访问控制\"></a>访问控制</h2><p>访问权限的验证</p>\n<h2 id=\"流量控制\"><a href=\"#流量控制\" class=\"headerlink\" title=\"流量控制\"></a>流量控制</h2><p>拒绝恶意访问</p>\n<h2 id=\"审查与监控\"><a href=\"#审查与监控\" class=\"headerlink\" title=\"审查与监控\"></a>审查与监控</h2><h2 id=\"灰度发布\"><a href=\"#灰度发布\" class=\"headerlink\" title=\"灰度发布\"></a>灰度发布</h2><h2 id=\"无状态\"><a href=\"#无状态\" class=\"headerlink\" title=\"无状态\"></a>无状态</h2><h2 id=\"原子化\"><a href=\"#原子化\" class=\"headerlink\" title=\"原子化\"></a>原子化</h2><h2 id=\"CQRS\"><a href=\"#CQRS\" class=\"headerlink\" title=\"CQRS\"></a>CQRS</h2><p>命令查询职责分离模式，读不强依赖写。</p>\n<h1 id=\"APP-Client\"><a href=\"#APP-Client\" class=\"headerlink\" title=\"APP(Client)\"></a>APP(Client)</h1><h2 id=\"远程控制权\"><a href=\"#远程控制权\" class=\"headerlink\" title=\"远程控制权\"></a>远程控制权</h2><h2 id=\"展示为主\"><a href=\"#展示为主\" class=\"headerlink\" title=\"展示为主\"></a>展示为主</h2><h2 id=\"少的逻辑\"><a href=\"#少的逻辑\" class=\"headerlink\" title=\"少的逻辑\"></a>少的逻辑</h2><h2 id=\"适度安全\"><a href=\"#适度安全\" class=\"headerlink\" title=\"适度安全\"></a>适度安全</h2><h1 id=\"部署\"><a href=\"#部署\" class=\"headerlink\" title=\"部署\"></a>部署</h1><h2 id=\"监控\"><a href=\"#监控\" class=\"headerlink\" title=\"监控\"></a>监控</h2><h2 id=\"降低升级时间窗\"><a href=\"#降低升级时间窗\" class=\"headerlink\" title=\"降低升级时间窗\"></a>降低升级时间窗</h2><h2 id=\"没有人需要等待\"><a href=\"#没有人需要等待\" class=\"headerlink\" title=\"没有人需要等待\"></a>没有人需要等待</h2><p>正式发布后，对于任何用户都是公平使用的。不需要牺牲部分用户利益。<br>常见于缓存autowarm时需要阻塞第一批到达的用户。</p>\n<h2 id=\"提前消除隐患\"><a href=\"#提前消除隐患\" class=\"headerlink\" title=\"提前消除隐患\"></a>提前消除隐患</h2>","excerpt":"","more":"<h1 id=\"原则\"><a href=\"#原则\" class=\"headerlink\" title=\"原则\"></a>原则</h1><h2 id=\"命名规范\"><a href=\"#命名规范\" class=\"headerlink\" title=\"命名规范\"></a>命名规范</h2><h3 id=\"重要性\"><a href=\"#重要性\" class=\"headerlink\" title=\"重要性\"></a>重要性</h3><h3 id=\"如何做？\"><a href=\"#如何做？\" class=\"headerlink\" title=\"如何做？\"></a>如何做？</h3><h3 id=\"约定优于配置\"><a href=\"#约定优于配置\" class=\"headerlink\" title=\"约定优于配置\"></a>约定优于配置</h3><h2 id=\"合理的设计\"><a href=\"#合理的设计\" class=\"headerlink\" title=\"合理的设计\"></a>合理的设计</h2><h3 id=\"适时分层\"><a href=\"#适时分层\" class=\"headerlink\" title=\"适时分层\"></a>适时分层</h3><h3 id=\"避免过度设计\"><a href=\"#避免过度设计\" class=\"headerlink\" title=\"避免过度设计\"></a>避免过度设计</h3><h3 id=\"模块化设计\"><a href=\"#模块化设计\" class=\"headerlink\" title=\"模块化设计\"></a>模块化设计</h3><p>模块化设计在重构时，可以将影响降到最低。达到低风险、低成本。<br>模块化设计对系统快速构建是一个阻碍，它要求将可预见的同类型代码复用，内聚到一个模块中。</p>\n<h2 id=\"前轻后重\"><a href=\"#前轻后重\" class=\"headerlink\" title=\"前轻后重\"></a>前轻后重</h2><p>系统之间的调用链，前置系统轻逻辑。</p>\n<h3 id=\"上轻下重，核心逻辑内敛\"><a href=\"#上轻下重，核心逻辑内敛\" class=\"headerlink\" title=\"上轻下重，核心逻辑内敛\"></a>上轻下重，核心逻辑内敛</h3><p>模块之间的调用链，上层模块轻逻辑</p>\n<h2 id=\"基础优先\"><a href=\"#基础优先\" class=\"headerlink\" title=\"基础优先\"></a>基础优先</h2><p>在构建软件时，保持基础组件优先稳定下来，定义好对外接口，并保留可扩展性。<br>例如安全性设计，在后期加比在前期加的成本高很多。</p>\n<h2 id=\"最小冗余\"><a href=\"#最小冗余\" class=\"headerlink\" title=\"最小冗余\"></a>最小冗余</h2><h3 id=\"代码保持最少行数\"><a href=\"#代码保持最少行数\" class=\"headerlink\" title=\"代码保持最少行数\"></a>代码保持最少行数</h3><p>1.少一行代码，就少了一个潜在的bug<br>2.行数少了，往往意味着重用性高了</p>\n<h2 id=\"保持简单\"><a href=\"#保持简单\" class=\"headerlink\" title=\"保持简单\"></a>保持简单</h2><h3 id=\"简单意味着快速\"><a href=\"#简单意味着快速\" class=\"headerlink\" title=\"简单意味着快速\"></a>简单意味着快速</h3><h3 id=\"简单意味着灵活\"><a href=\"#简单意味着灵活\" class=\"headerlink\" title=\"简单意味着灵活\"></a>简单意味着灵活</h3><h3 id=\"简单意味着易扩展\"><a href=\"#简单意味着易扩展\" class=\"headerlink\" title=\"简单意味着易扩展\"></a>简单意味着易扩展</h3><h3 id=\"简单意味着易重构\"><a href=\"#简单意味着易重构\" class=\"headerlink\" title=\"简单意味着易重构\"></a>简单意味着易重构</h3><h2 id=\"Fast-fail\"><a href=\"#Fast-fail\" class=\"headerlink\" title=\"Fast fail\"></a>Fast fail</h2><h2 id=\"代码即文档\"><a href=\"#代码即文档\" class=\"headerlink\" title=\"代码即文档\"></a>代码即文档</h2><h3 id=\"合理的注释\"><a href=\"#合理的注释\" class=\"headerlink\" title=\"合理的注释\"></a>合理的注释</h3><h2 id=\"关键业务设计宣讲\"><a href=\"#关键业务设计宣讲\" class=\"headerlink\" title=\"关键业务设计宣讲\"></a>关键业务设计宣讲</h2><h3 id=\"保持一致的看法\"><a href=\"#保持一致的看法\" class=\"headerlink\" title=\"保持一致的看法\"></a>保持一致的看法</h3><h2 id=\"小步快走\"><a href=\"#小步快走\" class=\"headerlink\" title=\"小步快走\"></a>小步快走</h2><h3 id=\"意味着版本迭代快速\"><a href=\"#意味着版本迭代快速\" class=\"headerlink\" title=\"意味着版本迭代快速\"></a>意味着版本迭代快速</h3><h3 id=\"意味着版本迭代稳定\"><a href=\"#意味着版本迭代稳定\" class=\"headerlink\" title=\"意味着版本迭代稳定\"></a>意味着版本迭代稳定</h3><h3 id=\"意味着部署回滚成本低\"><a href=\"#意味着部署回滚成本低\" class=\"headerlink\" title=\"意味着部署回滚成本低\"></a>意味着部署回滚成本低</h3><h1 id=\"重构与优化\"><a href=\"#重构与优化\" class=\"headerlink\" title=\"重构与优化\"></a>重构与优化</h1><h2 id=\"紧急优先\"><a href=\"#紧急优先\" class=\"headerlink\" title=\"紧急优先\"></a>紧急优先</h2><p>优先对紧急需要改进的部分进行重构</p>\n<h2 id=\"计划性的重构\"><a href=\"#计划性的重构\" class=\"headerlink\" title=\"计划性的重构\"></a>计划性的重构</h2><p>在敏捷开发时，往往时间不够，有些模块只能以非优雅的方式构建。但是需要在这些模块加上TODO以免重构时遗忘。</p>\n<h2 id=\"时机\"><a href=\"#时机\" class=\"headerlink\" title=\"时机\"></a>时机</h2><p>团队一致认为模块维护成本高昂时，果断重构。</p>\n<h2 id=\"基于成本的优化\"><a href=\"#基于成本的优化\" class=\"headerlink\" title=\"基于成本的优化\"></a>基于成本的优化</h2><h2 id=\"数据支撑\"><a href=\"#数据支撑\" class=\"headerlink\" title=\"数据支撑\"></a>数据支撑</h2><p>给出重构前后的成本与收益报告</p>\n<h2 id=\"持续性\"><a href=\"#持续性\" class=\"headerlink\" title=\"持续性\"></a>持续性</h2><p>在时间不够或时机不成熟时，分阶段的进行</p>\n<h1 id=\"技术选型\"><a href=\"#技术选型\" class=\"headerlink\" title=\"技术选型\"></a>技术选型</h1><h2 id=\"开源优先\"><a href=\"#开源优先\" class=\"headerlink\" title=\"开源优先\"></a>开源优先</h2><h2 id=\"稳定优先\"><a href=\"#稳定优先\" class=\"headerlink\" title=\"稳定优先\"></a>稳定优先</h2><h2 id=\"掌控度高优先\"><a href=\"#掌控度高优先\" class=\"headerlink\" title=\"掌控度高优先\"></a>掌控度高优先</h2><h2 id=\"保留备选项\"><a href=\"#保留备选项\" class=\"headerlink\" title=\"保留备选项\"></a>保留备选项</h2><h2 id=\"只有合适的技术，没有最好的技术。\"><a href=\"#只有合适的技术，没有最好的技术。\" class=\"headerlink\" title=\"只有合适的技术，没有最好的技术。\"></a>只有合适的技术，没有最好的技术。</h2><h2 id=\"避免一招鲜吃遍天\"><a href=\"#避免一招鲜吃遍天\" class=\"headerlink\" title=\"避免一招鲜吃遍天\"></a>避免一招鲜吃遍天</h2><p>手里有锤子，看到什么都觉得像钉子</p>\n<h2 id=\"技术升级\"><a href=\"#技术升级\" class=\"headerlink\" title=\"技术升级\"></a>技术升级</h2><p>系统容量与性能指标的要求，在业务发展的各个阶段是不固定的，技术需要保留一定前瞻性，不做被动跟随。</p>\n<h1 id=\"团队管理\"><a href=\"#团队管理\" class=\"headerlink\" title=\"团队管理\"></a>团队管理</h1><h2 id=\"keep-watch\"><a href=\"#keep-watch\" class=\"headerlink\" title=\"keep watch\"></a>keep watch</h2><p>工作与心理的交流分享</p>\n<h2 id=\"保持信任\"><a href=\"#保持信任\" class=\"headerlink\" title=\"保持信任\"></a>保持信任</h2><h2 id=\"保持怀疑\"><a href=\"#保持怀疑\" class=\"headerlink\" title=\"保持怀疑\"></a>保持怀疑</h2><h2 id=\"持续考评\"><a href=\"#持续考评\" class=\"headerlink\" title=\"持续考评\"></a>持续考评</h2><h2 id=\"分享中提高\"><a href=\"#分享中提高\" class=\"headerlink\" title=\"分享中提高\"></a>分享中提高</h2><p>有一个著名的理论，叫木桶理论。意思是木桶能装多少水，是由木桶最短的那个板来决定的。团队也是如此。团队的力量有多大，很多时候也是由能力最差的那个成员来决定的。为了提高团队整体的实力，我们必须提高每个人的能力。我们的改善必须得是可度量的，所以我们也要数字化能力的标准。</p>\n<h2 id=\"提高工作效率\"><a href=\"#提高工作效率\" class=\"headerlink\" title=\"提高工作效率\"></a>提高工作效率</h2><p>其实很多团队都在进行着这个工作。最常见的就是会做一些小工具，来节省我们的时间。比如代码自动生成工具，自动打包工具，自动的比较工具等等。我们应该制作尽可能多的自动化工具，来解放我们的时间。</p>\n<p>为了让大家投入更多的热情来制作各种工具，团队可以制定一定的奖励规则，对制作工具的人给予奖励。</p>\n<h2 id=\"互相备份\"><a href=\"#互相备份\" class=\"headerlink\" title=\"互相备份\"></a>互相备份</h2><h2 id=\"互相支撑\"><a href=\"#互相支撑\" class=\"headerlink\" title=\"互相支撑\"></a>互相支撑</h2><h2 id=\"向上管理\"><a href=\"#向上管理\" class=\"headerlink\" title=\"向上管理\"></a>向上管理</h2><h2 id=\"向下管理\"><a href=\"#向下管理\" class=\"headerlink\" title=\"向下管理\"></a>向下管理</h2><h3 id=\"了解队员的擅长与不足\"><a href=\"#了解队员的擅长与不足\" class=\"headerlink\" title=\"了解队员的擅长与不足\"></a>了解队员的擅长与不足</h3><h3 id=\"合理的任务分配\"><a href=\"#合理的任务分配\" class=\"headerlink\" title=\"合理的任务分配\"></a>合理的任务分配</h3><h3 id=\"适度挑战性的任务\"><a href=\"#适度挑战性的任务\" class=\"headerlink\" title=\"适度挑战性的任务\"></a>适度挑战性的任务</h3><h3 id=\"给出完成任务需要的资源\"><a href=\"#给出完成任务需要的资源\" class=\"headerlink\" title=\"给出完成任务需要的资源\"></a>给出完成任务需要的资源</h3><h3 id=\"激励中成长\"><a href=\"#激励中成长\" class=\"headerlink\" title=\"激励中成长\"></a>激励中成长</h3><p>眼前利益与发展前景</p>\n<h3 id=\"给出职业发展的机会\"><a href=\"#给出职业发展的机会\" class=\"headerlink\" title=\"给出职业发展的机会\"></a>给出职业发展的机会</h3><h3 id=\"公开与公平中考评\"><a href=\"#公开与公平中考评\" class=\"headerlink\" title=\"公开与公平中考评\"></a>公开与公平中考评</h3><h3 id=\"保持团队稳定\"><a href=\"#保持团队稳定\" class=\"headerlink\" title=\"保持团队稳定\"></a>保持团队稳定</h3><p>团队成员的诉求：团队，产品，薪资，发展。</p>\n<p>团队提供集体成长的氛围环境。</p>\n<p>令人兴奋的产品，提供持续打磨的动力。</p>\n<p>合适的薪资，使个人不过多为生活所扰。</p>\n<p>良好的发展前景，对个人的职业生涯带来腾飞。</p>\n<h2 id=\"适时剔除不合格\"><a href=\"#适时剔除不合格\" class=\"headerlink\" title=\"适时剔除不合格\"></a>适时剔除不合格</h2><h2 id=\"技术梯队\"><a href=\"#技术梯队\" class=\"headerlink\" title=\"技术梯队\"></a>技术梯队</h2><p>不同层次的人员配比，完成不同类型的任务。注意人员的上升下降渠道。</p>\n<h1 id=\"接口\"><a href=\"#接口\" class=\"headerlink\" title=\"接口\"></a>接口</h1><h2 id=\"版本控制\"><a href=\"#版本控制\" class=\"headerlink\" title=\"版本控制\"></a>版本控制</h2><h2 id=\"访问控制\"><a href=\"#访问控制\" class=\"headerlink\" title=\"访问控制\"></a>访问控制</h2><p>访问权限的验证</p>\n<h2 id=\"流量控制\"><a href=\"#流量控制\" class=\"headerlink\" title=\"流量控制\"></a>流量控制</h2><p>拒绝恶意访问</p>\n<h2 id=\"审查与监控\"><a href=\"#审查与监控\" class=\"headerlink\" title=\"审查与监控\"></a>审查与监控</h2><h2 id=\"灰度发布\"><a href=\"#灰度发布\" class=\"headerlink\" title=\"灰度发布\"></a>灰度发布</h2><h2 id=\"无状态\"><a href=\"#无状态\" class=\"headerlink\" title=\"无状态\"></a>无状态</h2><h2 id=\"原子化\"><a href=\"#原子化\" class=\"headerlink\" title=\"原子化\"></a>原子化</h2><h2 id=\"CQRS\"><a href=\"#CQRS\" class=\"headerlink\" title=\"CQRS\"></a>CQRS</h2><p>命令查询职责分离模式，读不强依赖写。</p>\n<h1 id=\"APP-Client\"><a href=\"#APP-Client\" class=\"headerlink\" title=\"APP(Client)\"></a>APP(Client)</h1><h2 id=\"远程控制权\"><a href=\"#远程控制权\" class=\"headerlink\" title=\"远程控制权\"></a>远程控制权</h2><h2 id=\"展示为主\"><a href=\"#展示为主\" class=\"headerlink\" title=\"展示为主\"></a>展示为主</h2><h2 id=\"少的逻辑\"><a href=\"#少的逻辑\" class=\"headerlink\" title=\"少的逻辑\"></a>少的逻辑</h2><h2 id=\"适度安全\"><a href=\"#适度安全\" class=\"headerlink\" title=\"适度安全\"></a>适度安全</h2><h1 id=\"部署\"><a href=\"#部署\" class=\"headerlink\" title=\"部署\"></a>部署</h1><h2 id=\"监控\"><a href=\"#监控\" class=\"headerlink\" title=\"监控\"></a>监控</h2><h2 id=\"降低升级时间窗\"><a href=\"#降低升级时间窗\" class=\"headerlink\" title=\"降低升级时间窗\"></a>降低升级时间窗</h2><h2 id=\"没有人需要等待\"><a href=\"#没有人需要等待\" class=\"headerlink\" title=\"没有人需要等待\"></a>没有人需要等待</h2><p>正式发布后，对于任何用户都是公平使用的。不需要牺牲部分用户利益。<br>常见于缓存autowarm时需要阻塞第一批到达的用户。</p>\n<h2 id=\"提前消除隐患\"><a href=\"#提前消除隐患\" class=\"headerlink\" title=\"提前消除隐患\"></a>提前消除隐患</h2>"},{"title":"当我们谈事务时，我们在谈什么","date":"2016-06-01T05:01:50.068Z","description":"数据库事务（简称：事务）是数据库管理系统执行过程中的一个逻辑单位，由一个有限的数据库操作序列构成。","_content":"\n暂时未完成\n\n## 写在前面\n\n讨论传统关系型数据库内的事务，以及如何与NoSQL领域结合进行事务化。\n\n## 什么是事务？\n\n数据库事务（简称：事务）是数据库管理系统执行过程中的一个逻辑单位，由一个有限的数据库操作序列构成。这是使用Google Search以“事务”为关键字查找时，第一条是wikipedia给出的描述。\n\n## 单系统事务\n\n### ACID\n\n### 逻辑事务 VS 物理事务\n\n### 编程式事务 VS 声明式事务\n\n\n### 事务隔离级别\n\n#### 默认隔离级别\n\n##### 不同ORM框架的默认隔离级别\n\n##### 不同RDBMS的默认隔离级别\n\n### 事务传播行为\n\n#### 默认传播行为\n\n### RDBMS如何权衡事务隔离与高并发读写？\n\n#### MVCC与Free Lock\n\n##### 共享锁\n\n##### 排它锁\n\n##### 间隙锁\n\n### 在主从架构下RDBMS如何保证事务？\n\n### 在双主结构下RDBMS如何保证事务？\n\n### 双活数据中心的事务管理\n\n## 分布式事务\n\n### 事务解耦\n\n### 事务补偿\n\n### 事务回滚\n\n### 最终资源一致性\n\n### 与nosql\n\n### 阿里DTS\n\n## Reference\n\n- [数据库事务-维基百科](https://zh.wikipedia.org/wiki/%E6%95%B0%E6%8D%AE%E5%BA%93%E4%BA%8B%E5%8A%A1)","source":"_posts/What-is-a-transaction.md","raw":"---\ntitle: 当我们谈事务时，我们在谈什么\ndate: 2016年6月1日13:03:33\ntags:\n    - Transaction\n    - Spring\n    - MVCC\n    - WAL\n    - RedoLog\n    - RelayLog\ncategories:\n    - Summary\ndescription: 数据库事务（简称：事务）是数据库管理系统执行过程中的一个逻辑单位，由一个有限的数据库操作序列构成。\n---\n\n暂时未完成\n\n## 写在前面\n\n讨论传统关系型数据库内的事务，以及如何与NoSQL领域结合进行事务化。\n\n## 什么是事务？\n\n数据库事务（简称：事务）是数据库管理系统执行过程中的一个逻辑单位，由一个有限的数据库操作序列构成。这是使用Google Search以“事务”为关键字查找时，第一条是wikipedia给出的描述。\n\n## 单系统事务\n\n### ACID\n\n### 逻辑事务 VS 物理事务\n\n### 编程式事务 VS 声明式事务\n\n\n### 事务隔离级别\n\n#### 默认隔离级别\n\n##### 不同ORM框架的默认隔离级别\n\n##### 不同RDBMS的默认隔离级别\n\n### 事务传播行为\n\n#### 默认传播行为\n\n### RDBMS如何权衡事务隔离与高并发读写？\n\n#### MVCC与Free Lock\n\n##### 共享锁\n\n##### 排它锁\n\n##### 间隙锁\n\n### 在主从架构下RDBMS如何保证事务？\n\n### 在双主结构下RDBMS如何保证事务？\n\n### 双活数据中心的事务管理\n\n## 分布式事务\n\n### 事务解耦\n\n### 事务补偿\n\n### 事务回滚\n\n### 最终资源一致性\n\n### 与nosql\n\n### 阿里DTS\n\n## Reference\n\n- [数据库事务-维基百科](https://zh.wikipedia.org/wiki/%E6%95%B0%E6%8D%AE%E5%BA%93%E4%BA%8B%E5%8A%A1)","slug":"What-is-a-transaction","published":1,"updated":"2016-06-01T05:23:24.593Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ciowq3yuz000r4cnn75scdoun","content":"<p>暂时未完成</p>\n<h2 id=\"写在前面\"><a href=\"#写在前面\" class=\"headerlink\" title=\"写在前面\"></a>写在前面</h2><p>讨论传统关系型数据库内的事务，以及如何与NoSQL领域结合进行事务化。</p>\n<h2 id=\"什么是事务？\"><a href=\"#什么是事务？\" class=\"headerlink\" title=\"什么是事务？\"></a>什么是事务？</h2><p>数据库事务（简称：事务）是数据库管理系统执行过程中的一个逻辑单位，由一个有限的数据库操作序列构成。这是使用Google Search以“事务”为关键字查找时，第一条是wikipedia给出的描述。</p>\n<h2 id=\"单系统事务\"><a href=\"#单系统事务\" class=\"headerlink\" title=\"单系统事务\"></a>单系统事务</h2><h3 id=\"ACID\"><a href=\"#ACID\" class=\"headerlink\" title=\"ACID\"></a>ACID</h3><h3 id=\"逻辑事务-VS-物理事务\"><a href=\"#逻辑事务-VS-物理事务\" class=\"headerlink\" title=\"逻辑事务 VS 物理事务\"></a>逻辑事务 VS 物理事务</h3><h3 id=\"编程式事务-VS-声明式事务\"><a href=\"#编程式事务-VS-声明式事务\" class=\"headerlink\" title=\"编程式事务 VS 声明式事务\"></a>编程式事务 VS 声明式事务</h3><h3 id=\"事务隔离级别\"><a href=\"#事务隔离级别\" class=\"headerlink\" title=\"事务隔离级别\"></a>事务隔离级别</h3><h4 id=\"默认隔离级别\"><a href=\"#默认隔离级别\" class=\"headerlink\" title=\"默认隔离级别\"></a>默认隔离级别</h4><h5 id=\"不同ORM框架的默认隔离级别\"><a href=\"#不同ORM框架的默认隔离级别\" class=\"headerlink\" title=\"不同ORM框架的默认隔离级别\"></a>不同ORM框架的默认隔离级别</h5><h5 id=\"不同RDBMS的默认隔离级别\"><a href=\"#不同RDBMS的默认隔离级别\" class=\"headerlink\" title=\"不同RDBMS的默认隔离级别\"></a>不同RDBMS的默认隔离级别</h5><h3 id=\"事务传播行为\"><a href=\"#事务传播行为\" class=\"headerlink\" title=\"事务传播行为\"></a>事务传播行为</h3><h4 id=\"默认传播行为\"><a href=\"#默认传播行为\" class=\"headerlink\" title=\"默认传播行为\"></a>默认传播行为</h4><h3 id=\"RDBMS如何权衡事务隔离与高并发读写？\"><a href=\"#RDBMS如何权衡事务隔离与高并发读写？\" class=\"headerlink\" title=\"RDBMS如何权衡事务隔离与高并发读写？\"></a>RDBMS如何权衡事务隔离与高并发读写？</h3><h4 id=\"MVCC与Free-Lock\"><a href=\"#MVCC与Free-Lock\" class=\"headerlink\" title=\"MVCC与Free Lock\"></a>MVCC与Free Lock</h4><h5 id=\"共享锁\"><a href=\"#共享锁\" class=\"headerlink\" title=\"共享锁\"></a>共享锁</h5><h5 id=\"排它锁\"><a href=\"#排它锁\" class=\"headerlink\" title=\"排它锁\"></a>排它锁</h5><h5 id=\"间隙锁\"><a href=\"#间隙锁\" class=\"headerlink\" title=\"间隙锁\"></a>间隙锁</h5><h3 id=\"在主从架构下RDBMS如何保证事务？\"><a href=\"#在主从架构下RDBMS如何保证事务？\" class=\"headerlink\" title=\"在主从架构下RDBMS如何保证事务？\"></a>在主从架构下RDBMS如何保证事务？</h3><h3 id=\"在双主结构下RDBMS如何保证事务？\"><a href=\"#在双主结构下RDBMS如何保证事务？\" class=\"headerlink\" title=\"在双主结构下RDBMS如何保证事务？\"></a>在双主结构下RDBMS如何保证事务？</h3><h3 id=\"双活数据中心的事务管理\"><a href=\"#双活数据中心的事务管理\" class=\"headerlink\" title=\"双活数据中心的事务管理\"></a>双活数据中心的事务管理</h3><h2 id=\"分布式事务\"><a href=\"#分布式事务\" class=\"headerlink\" title=\"分布式事务\"></a>分布式事务</h2><h3 id=\"事务解耦\"><a href=\"#事务解耦\" class=\"headerlink\" title=\"事务解耦\"></a>事务解耦</h3><h3 id=\"事务补偿\"><a href=\"#事务补偿\" class=\"headerlink\" title=\"事务补偿\"></a>事务补偿</h3><h3 id=\"事务回滚\"><a href=\"#事务回滚\" class=\"headerlink\" title=\"事务回滚\"></a>事务回滚</h3><h3 id=\"最终资源一致性\"><a href=\"#最终资源一致性\" class=\"headerlink\" title=\"最终资源一致性\"></a>最终资源一致性</h3><h3 id=\"与nosql\"><a href=\"#与nosql\" class=\"headerlink\" title=\"与nosql\"></a>与nosql</h3><h3 id=\"阿里DTS\"><a href=\"#阿里DTS\" class=\"headerlink\" title=\"阿里DTS\"></a>阿里DTS</h3><h2 id=\"Reference\"><a href=\"#Reference\" class=\"headerlink\" title=\"Reference\"></a>Reference</h2><ul>\n<li><a href=\"https://zh.wikipedia.org/wiki/%E6%95%B0%E6%8D%AE%E5%BA%93%E4%BA%8B%E5%8A%A1\" target=\"_blank\" rel=\"external\">数据库事务-维基百科</a></li>\n</ul>\n","excerpt":"","more":"<p>暂时未完成</p>\n<h2 id=\"写在前面\"><a href=\"#写在前面\" class=\"headerlink\" title=\"写在前面\"></a>写在前面</h2><p>讨论传统关系型数据库内的事务，以及如何与NoSQL领域结合进行事务化。</p>\n<h2 id=\"什么是事务？\"><a href=\"#什么是事务？\" class=\"headerlink\" title=\"什么是事务？\"></a>什么是事务？</h2><p>数据库事务（简称：事务）是数据库管理系统执行过程中的一个逻辑单位，由一个有限的数据库操作序列构成。这是使用Google Search以“事务”为关键字查找时，第一条是wikipedia给出的描述。</p>\n<h2 id=\"单系统事务\"><a href=\"#单系统事务\" class=\"headerlink\" title=\"单系统事务\"></a>单系统事务</h2><h3 id=\"ACID\"><a href=\"#ACID\" class=\"headerlink\" title=\"ACID\"></a>ACID</h3><h3 id=\"逻辑事务-VS-物理事务\"><a href=\"#逻辑事务-VS-物理事务\" class=\"headerlink\" title=\"逻辑事务 VS 物理事务\"></a>逻辑事务 VS 物理事务</h3><h3 id=\"编程式事务-VS-声明式事务\"><a href=\"#编程式事务-VS-声明式事务\" class=\"headerlink\" title=\"编程式事务 VS 声明式事务\"></a>编程式事务 VS 声明式事务</h3><h3 id=\"事务隔离级别\"><a href=\"#事务隔离级别\" class=\"headerlink\" title=\"事务隔离级别\"></a>事务隔离级别</h3><h4 id=\"默认隔离级别\"><a href=\"#默认隔离级别\" class=\"headerlink\" title=\"默认隔离级别\"></a>默认隔离级别</h4><h5 id=\"不同ORM框架的默认隔离级别\"><a href=\"#不同ORM框架的默认隔离级别\" class=\"headerlink\" title=\"不同ORM框架的默认隔离级别\"></a>不同ORM框架的默认隔离级别</h5><h5 id=\"不同RDBMS的默认隔离级别\"><a href=\"#不同RDBMS的默认隔离级别\" class=\"headerlink\" title=\"不同RDBMS的默认隔离级别\"></a>不同RDBMS的默认隔离级别</h5><h3 id=\"事务传播行为\"><a href=\"#事务传播行为\" class=\"headerlink\" title=\"事务传播行为\"></a>事务传播行为</h3><h4 id=\"默认传播行为\"><a href=\"#默认传播行为\" class=\"headerlink\" title=\"默认传播行为\"></a>默认传播行为</h4><h3 id=\"RDBMS如何权衡事务隔离与高并发读写？\"><a href=\"#RDBMS如何权衡事务隔离与高并发读写？\" class=\"headerlink\" title=\"RDBMS如何权衡事务隔离与高并发读写？\"></a>RDBMS如何权衡事务隔离与高并发读写？</h3><h4 id=\"MVCC与Free-Lock\"><a href=\"#MVCC与Free-Lock\" class=\"headerlink\" title=\"MVCC与Free Lock\"></a>MVCC与Free Lock</h4><h5 id=\"共享锁\"><a href=\"#共享锁\" class=\"headerlink\" title=\"共享锁\"></a>共享锁</h5><h5 id=\"排它锁\"><a href=\"#排它锁\" class=\"headerlink\" title=\"排它锁\"></a>排它锁</h5><h5 id=\"间隙锁\"><a href=\"#间隙锁\" class=\"headerlink\" title=\"间隙锁\"></a>间隙锁</h5><h3 id=\"在主从架构下RDBMS如何保证事务？\"><a href=\"#在主从架构下RDBMS如何保证事务？\" class=\"headerlink\" title=\"在主从架构下RDBMS如何保证事务？\"></a>在主从架构下RDBMS如何保证事务？</h3><h3 id=\"在双主结构下RDBMS如何保证事务？\"><a href=\"#在双主结构下RDBMS如何保证事务？\" class=\"headerlink\" title=\"在双主结构下RDBMS如何保证事务？\"></a>在双主结构下RDBMS如何保证事务？</h3><h3 id=\"双活数据中心的事务管理\"><a href=\"#双活数据中心的事务管理\" class=\"headerlink\" title=\"双活数据中心的事务管理\"></a>双活数据中心的事务管理</h3><h2 id=\"分布式事务\"><a href=\"#分布式事务\" class=\"headerlink\" title=\"分布式事务\"></a>分布式事务</h2><h3 id=\"事务解耦\"><a href=\"#事务解耦\" class=\"headerlink\" title=\"事务解耦\"></a>事务解耦</h3><h3 id=\"事务补偿\"><a href=\"#事务补偿\" class=\"headerlink\" title=\"事务补偿\"></a>事务补偿</h3><h3 id=\"事务回滚\"><a href=\"#事务回滚\" class=\"headerlink\" title=\"事务回滚\"></a>事务回滚</h3><h3 id=\"最终资源一致性\"><a href=\"#最终资源一致性\" class=\"headerlink\" title=\"最终资源一致性\"></a>最终资源一致性</h3><h3 id=\"与nosql\"><a href=\"#与nosql\" class=\"headerlink\" title=\"与nosql\"></a>与nosql</h3><h3 id=\"阿里DTS\"><a href=\"#阿里DTS\" class=\"headerlink\" title=\"阿里DTS\"></a>阿里DTS</h3><h2 id=\"Reference\"><a href=\"#Reference\" class=\"headerlink\" title=\"Reference\"></a>Reference</h2><ul>\n<li><a href=\"https://zh.wikipedia.org/wiki/%E6%95%B0%E6%8D%AE%E5%BA%93%E4%BA%8B%E5%8A%A1\">数据库事务-维基百科</a></li>\n</ul>\n"}],"PostAsset":[],"PostCategory":[{"post_id":"ciowq3yts00004cnnj5rqbiku","category_id":"ciowq3yu700054cnnallqp4go","_id":"ciowq3yui000c4cnn5lv77so2"},{"post_id":"ciowq3yuf000b4cnntiwze46w","category_id":"ciowq3yue000a4cnn1h63o2y7","_id":"ciowq3yup000h4cnn6utiu4jk"},{"post_id":"ciowq3yu000024cnn9x4a4xhp","category_id":"ciowq3yue000a4cnn1h63o2y7","_id":"ciowq3yur000l4cnn1hvegad9"},{"post_id":"ciowq3yu800064cnns96c21p9","category_id":"ciowq3yun000f4cnnozm8cr4m","_id":"ciowq3yux000o4cnnr8hkq5bk"},{"post_id":"ciowq3yuq000i4cnn8jm5nq6g","category_id":"ciowq3yun000f4cnnozm8cr4m","_id":"ciowq3yv1000s4cnnhtbv45l3"},{"post_id":"ciowq3yua00074cnnaq8ub01n","category_id":"ciowq3yue000a4cnn1h63o2y7","_id":"ciowq3yv3000u4cnnxkdqz0y8"},{"post_id":"ciowq3yuc00094cnnt7dgkkl6","category_id":"ciowq3yue000a4cnn1h63o2y7","_id":"ciowq3yv4000z4cnn9lnnuly1"},{"post_id":"ciowq3yuj000d4cnnhlahdfsw","category_id":"ciowq3yv3000w4cnnmezx3cqh","_id":"ciowq3yv500134cnncvdmkdpo"},{"post_id":"ciowq3yuo000g4cnnk3n9ez6r","category_id":"ciowq3yv3000w4cnnmezx3cqh","_id":"ciowq3yv600164cnngu3cza7b"},{"post_id":"ciowq3yut000m4cnnh3k2nqa0","category_id":"ciowq3yv3000w4cnnmezx3cqh","_id":"ciowq3yv8001a4cnnfgzatwlr"},{"post_id":"ciowq3yuv000n4cnnv5gbqdl2","category_id":"ciowq3yv3000w4cnnmezx3cqh","_id":"ciowq3yva001f4cnn8t82b7f4"},{"post_id":"ciowq3yuz000r4cnn75scdoun","category_id":"ciowq3yv3000w4cnnmezx3cqh","_id":"ciowq3yvc001i4cnnumsex2z3"}],"PostTag":[{"post_id":"ciowq3yts00004cnnj5rqbiku","tag_id":"ciowq3yu400044cnnuclq7vi2","_id":"ciowq3yv2000t4cnn42uv1jmn"},{"post_id":"ciowq3yts00004cnnj5rqbiku","tag_id":"ciowq3yub00084cnntuzg42bj","_id":"ciowq3yv3000v4cnnh4rhl1gf"},{"post_id":"ciowq3yts00004cnnj5rqbiku","tag_id":"ciowq3yum000e4cnnkklk71ks","_id":"ciowq3yv4000y4cnnwxofcuzt"},{"post_id":"ciowq3yts00004cnnj5rqbiku","tag_id":"ciowq3yur000j4cnnf9zefj7b","_id":"ciowq3yv400104cnncz2mx7z7"},{"post_id":"ciowq3yu000024cnn9x4a4xhp","tag_id":"ciowq3yux000q4cnnp9kcvvsw","_id":"ciowq3yv700194cnniy48ospu"},{"post_id":"ciowq3yu000024cnn9x4a4xhp","tag_id":"ciowq3yv4000x4cnnr5kctzu2","_id":"ciowq3yv8001c4cnnghg25smd"},{"post_id":"ciowq3yu000024cnn9x4a4xhp","tag_id":"ciowq3yv500124cnnhla06dwi","_id":"ciowq3yva001e4cnnkg1bn1d3"},{"post_id":"ciowq3yu000024cnn9x4a4xhp","tag_id":"ciowq3yv600154cnnn1jotkcy","_id":"ciowq3yva001g4cnnfl905guo"},{"post_id":"ciowq3yu800064cnns96c21p9","tag_id":"ciowq3yv700184cnn7mizevz2","_id":"ciowq3yvd001m4cnnpwjbf2qy"},{"post_id":"ciowq3yu800064cnns96c21p9","tag_id":"ciowq3yv9001d4cnnbobpcxbk","_id":"ciowq3yve001n4cnnr7c6olh6"},{"post_id":"ciowq3yu800064cnns96c21p9","tag_id":"ciowq3yvb001h4cnnmg1ga34r","_id":"ciowq3yvg001p4cnndcdc0yg8"},{"post_id":"ciowq3yu800064cnns96c21p9","tag_id":"ciowq3yvc001j4cnn3crrdwbc","_id":"ciowq3yvg001q4cnncqscf7qc"},{"post_id":"ciowq3yu800064cnns96c21p9","tag_id":"ciowq3yvc001k4cnn6n359aoo","_id":"ciowq3yvh001s4cnnybiii2jy"},{"post_id":"ciowq3yua00074cnnaq8ub01n","tag_id":"ciowq3yvd001l4cnn42xn6kr3","_id":"ciowq3yvj001w4cnnwirgw7dr"},{"post_id":"ciowq3yua00074cnnaq8ub01n","tag_id":"ciowq3yve001o4cnnstcko5ro","_id":"ciowq3yvj001x4cnnh04ews70"},{"post_id":"ciowq3yua00074cnnaq8ub01n","tag_id":"ciowq3yvg001r4cnnzforaozg","_id":"ciowq3yvk001z4cnngacf9ylv"},{"post_id":"ciowq3yua00074cnnaq8ub01n","tag_id":"ciowq3yvh001t4cnnr2wbszbt","_id":"ciowq3yvk00204cnn2sboqmas"},{"post_id":"ciowq3yua00074cnnaq8ub01n","tag_id":"ciowq3yvi001u4cnnrwk6k8tf","_id":"ciowq3yvl00224cnnhg9pn5l2"},{"post_id":"ciowq3yuc00094cnnt7dgkkl6","tag_id":"ciowq3yvd001l4cnn42xn6kr3","_id":"ciowq3yvo00274cnnk25ilcr7"},{"post_id":"ciowq3yuc00094cnnt7dgkkl6","tag_id":"ciowq3yvk001y4cnnrxbtbjx5","_id":"ciowq3yvp00284cnn0erlee0t"},{"post_id":"ciowq3yuc00094cnnt7dgkkl6","tag_id":"ciowq3yvg001r4cnnzforaozg","_id":"ciowq3yvp002a4cnne1eydv6h"},{"post_id":"ciowq3yuc00094cnnt7dgkkl6","tag_id":"ciowq3yvm00234cnntksdirb2","_id":"ciowq3yvp002b4cnnl1k0z1e9"},{"post_id":"ciowq3yuc00094cnnt7dgkkl6","tag_id":"ciowq3yvi001u4cnnrwk6k8tf","_id":"ciowq3yvq002d4cnneyeujy9u"},{"post_id":"ciowq3yuc00094cnnt7dgkkl6","tag_id":"ciowq3yvn00254cnnblho7h66","_id":"ciowq3yvq002e4cnnlnbjx7jt"},{"post_id":"ciowq3yuf000b4cnntiwze46w","tag_id":"ciowq3yvd001l4cnn42xn6kr3","_id":"ciowq3yvr002i4cnnbdoxre4l"},{"post_id":"ciowq3yuf000b4cnntiwze46w","tag_id":"ciowq3yvp00294cnnnyzww8qv","_id":"ciowq3yvs002j4cnn0plxhfxy"},{"post_id":"ciowq3yuf000b4cnntiwze46w","tag_id":"ciowq3yvg001r4cnnzforaozg","_id":"ciowq3yvs002l4cnnn553nod0"},{"post_id":"ciowq3yuf000b4cnntiwze46w","tag_id":"ciowq3yvq002f4cnnkqwh3wx8","_id":"ciowq3yvs002m4cnn83xsfxxk"},{"post_id":"ciowq3yuf000b4cnntiwze46w","tag_id":"ciowq3yvr002g4cnnmuvgvp0p","_id":"ciowq3yvt002o4cnn7y5t1mpx"},{"post_id":"ciowq3yuj000d4cnnhlahdfsw","tag_id":"ciowq3yvr002h4cnntd6lo00l","_id":"ciowq3yvt002p4cnnvok2bqau"},{"post_id":"ciowq3yuj000d4cnnhlahdfsw","tag_id":"ciowq3yvs002k4cnnrgia2vp5","_id":"ciowq3yvu002r4cnnuy8ca4gj"},{"post_id":"ciowq3yuo000g4cnnk3n9ez6r","tag_id":"ciowq3yvt002n4cnnh6xbfcew","_id":"ciowq3yvu002t4cnnevytee9x"},{"post_id":"ciowq3yuo000g4cnnk3n9ez6r","tag_id":"ciowq3yvt002q4cnn2gqoj9cx","_id":"ciowq3yvu002u4cnncpj06y5p"},{"post_id":"ciowq3yuq000i4cnn8jm5nq6g","tag_id":"ciowq3yvu002s4cnncjw0r30w","_id":"ciowq3yvw002y4cnnxkhgffpp"},{"post_id":"ciowq3yuq000i4cnn8jm5nq6g","tag_id":"ciowq3yv9001d4cnnbobpcxbk","_id":"ciowq3yvx002z4cnnag93h2rk"},{"post_id":"ciowq3yuq000i4cnn8jm5nq6g","tag_id":"ciowq3yvw002w4cnnj65pcx3c","_id":"ciowq3yvx00314cnno2qk2qak"},{"post_id":"ciowq3yut000m4cnnh3k2nqa0","tag_id":"ciowq3yvw002x4cnnbno4c1q7","_id":"ciowq3yvy00324cnnidf1js4y"},{"post_id":"ciowq3yuv000n4cnnv5gbqdl2","tag_id":"ciowq3yvx00304cnnlygy2dg0","_id":"ciowq3yvz00354cnnuu5gns4b"},{"post_id":"ciowq3yuv000n4cnnv5gbqdl2","tag_id":"ciowq3yvy00334cnncak1yyxh","_id":"ciowq3yvz00364cnnk0poiaf4"},{"post_id":"ciowq3yuz000r4cnn75scdoun","tag_id":"ciowq3yvc001k4cnn6n359aoo","_id":"ciowq3yw1003c4cnneby3txwi"},{"post_id":"ciowq3yuz000r4cnn75scdoun","tag_id":"ciowq3yvz00374cnnv3qhr7to","_id":"ciowq3yw1003d4cnnusri5lto"},{"post_id":"ciowq3yuz000r4cnn75scdoun","tag_id":"ciowq3yvz00384cnnepevc5gf","_id":"ciowq3yw1003e4cnnskseefeo"},{"post_id":"ciowq3yuz000r4cnn75scdoun","tag_id":"ciowq3yw000394cnnyap0yhvs","_id":"ciowq3yw2003f4cnn50h3tgvo"},{"post_id":"ciowq3yuz000r4cnn75scdoun","tag_id":"ciowq3yw0003a4cnn9pimnvk1","_id":"ciowq3yw2003g4cnnwqnooqey"},{"post_id":"ciowq3yuz000r4cnn75scdoun","tag_id":"ciowq3yw1003b4cnnzmmt7cgu","_id":"ciowq3yw2003h4cnnmdqzseng"}],"Tag":[{"name":"GitHub","_id":"ciowq3yu400044cnnuclq7vi2"},{"name":"Hexo","_id":"ciowq3yub00084cnntuzg42bj"},{"name":"Jacman","_id":"ciowq3yum000e4cnnkklk71ks"},{"name":"Markdown","_id":"ciowq3yur000j4cnnf9zefj7b"},{"name":"Redis","_id":"ciowq3yux000q4cnnp9kcvvsw"},{"name":"Hash","_id":"ciowq3yv4000x4cnnr5kctzu2"},{"name":"Sharding","_id":"ciowq3yv500124cnnhla06dwi"},{"name":"Twemproxy","_id":"ciowq3yv600154cnnn1jotkcy"},{"name":"JOOQ","_id":"ciowq3yv700184cnn7mizevz2"},{"name":"SQL","_id":"ciowq3yv9001d4cnnbobpcxbk"},{"name":"ARM","_id":"ciowq3yvb001h4cnnmg1ga34r"},{"name":"ORM","_id":"ciowq3yvc001j4cnn3crrdwbc"},{"name":"Transaction","_id":"ciowq3yvc001k4cnn6n359aoo"},{"name":"Nginx","_id":"ciowq3yvd001l4cnn42xn6kr3"},{"name":"Alpine","_id":"ciowq3yve001o4cnnstcko5ro"},{"name":"Docker","_id":"ciowq3yvg001r4cnnzforaozg"},{"name":"Centos","_id":"ciowq3yvh001t4cnnr2wbszbt"},{"name":"Patch","_id":"ciowq3yvi001u4cnnrwk6k8tf"},{"name":"Keepalived","_id":"ciowq3yvk001y4cnnrxbtbjx5"},{"name":"MicroKernel","_id":"ciowq3yvm00234cnntksdirb2"},{"name":"Failover","_id":"ciowq3yvn00254cnnblho7h66"},{"name":"Tomcat","_id":"ciowq3yvp00294cnnnyzww8qv"},{"name":"SSL","_id":"ciowq3yvq002f4cnnkqwh3wx8"},{"name":"Load balance","_id":"ciowq3yvr002g4cnnmuvgvp0p"},{"name":"MessageSystem","_id":"ciowq3yvr002h4cnntd6lo00l"},{"name":"architecture","_id":"ciowq3yvs002k4cnnrgia2vp5"},{"name":"Experience","_id":"ciowq3yvt002n4cnnh6xbfcew"},{"name":"Refactor","_id":"ciowq3yvt002q4cnn2gqoj9cx"},{"name":"Tech","_id":"ciowq3yvu002s4cnncjw0r30w"},{"name":"Elegant","_id":"ciowq3yvw002w4cnnj65pcx3c"},{"name":"Distributed","_id":"ciowq3yvw002x4cnnbno4c1q7"},{"name":"Architecture","_id":"ciowq3yvx00304cnnlygy2dg0"},{"name":"Specification","_id":"ciowq3yvy00334cnncak1yyxh"},{"name":"Spring","_id":"ciowq3yvz00374cnnv3qhr7to"},{"name":"MVCC","_id":"ciowq3yvz00384cnnepevc5gf"},{"name":"WAL","_id":"ciowq3yw000394cnnyap0yhvs"},{"name":"RedoLog","_id":"ciowq3yw0003a4cnn9pimnvk1"},{"name":"RelayLog","_id":"ciowq3yw1003b4cnnzmmt7cgu"}]}}